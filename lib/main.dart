import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'dart:ui' as ui;
import 'dart:convert';
import 'dart:io';
import 'dart:math';
import 'package:intl/intl.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:path_provider/path_provider.dart';
import 'package:csv/csv.dart';
import 'package:share_plus/share_plus.dart';

void main() {
  runApp(const AkohoTechApp());
}

// Code Admin secret (ce code ne expire jamais)
const String adminCode = "TANTSAHA2024";

// ===== CODES PRÉ-DÉFINIS (fonctionnent sur tous les appareils) =====
const List<String> predefinedCodes = [
  // Codes Tantsaha
  "TAN7X9K2",
  "TAN4M8P5",
  "TAN9R3W7",
  "TAN2L6V8",
  "TAN5N1Q4",
  // Codes Akoho
  "AKO8T4J6",
  "AKO3Y7H9",
  "AKO6U2F5",
  "AKO1Z8D3",
  "AKO9W5B7",
  // Codes Fambolena
  "FAM4K7X2",
  "FAM8P3M6",
  "FAM2R9N1",
  "FAM6V5L8",
  "FAM3Q1W4",
  // Codes Fiompiana
  "FIO7H4T9",
  "FIO5J8Y3",
  "FIO9D2U6",
  "FIO1F6Z5",
  "FIO4B9W2",
  // Codes Holatra
  "HOL6X3K7",
  "HOL2M8P4",
  "HOL8R5N9",
  "HOL4V1L6",
  "HOL7Q9W3",
  // Codes Tantely
  "TEL5T2J8",
  "TEL9Y6H4",
  "TEL3U1F7",
  "TEL7Z5D2",
  "TEL1W8B6",
  // Codes Trondro
  "TRO8K4X5",
  "TRO4P7M9",
  "TRO6N2R3",
  "TRO2L9V7",
  "TRO9W3Q1",
  // Codes Bitro
  "BIT5H8T4",
  "BIT1J3Y6",
  "BIT7D6U9",
  "BIT3F2Z5",
  "BIT6B5W8",
  // Codes Kisoa
  "KIS9X7K2",
  "KIS4M1P8",
  "KIS8R4N5",
  "KIS2V6L3",
  "KIS5Q8W7",
  // Codes Zezika
  "ZEZ7T5J1",
  "ZEZ3Y9H6",
  "ZEZ6U3F4",
  "ZEZ1Z7D9",
  "ZEZ8W2B5",
  // Codes 2024
  "2024XK7M",
  "2024PL4N",
  "2024RW9T",
  "2024VH3J",
  "2024QF6Y",
  // Codes 2025
  "2025MX8K",
  "2025NP5L",
  "2025TR2W",
  "2025JV6H",
  "2025YQ9F",
  // Codes spéciaux
  "MADA7K4X",
  "MADA2P8M",
  "AGRI5N3R",
  "AGRI9L7V",
  "TECH4W1Q",
  "TECH8T6J",
  "VOLY3Y2H",
  "VOLY7U5F",
  "OMBY1Z9D",
  "OMBY6B4W",
];

// Prefixes pour la génération de milliers de codes
const List<String> _codePrefixes = [
  // Malagasy
  'AKOHO', 'BITRO', 'KISOA', 'TANTSAHA', 'FAMBOLENA', 
  'FIOMPIANA', 'HOLATRA', 'TANTELY', 'TRONDRO', 'ZEZIKA',
  'MADA', 'AGRI', 'TECH', 'VOKATRA', 'MAITSO',
  // Allemand (Deutsch)
  'HUHN', 'HASE', 'KANINCHEN', 'SCHWEIN', 'BAUER',
  'AGRAR', 'PFLANZE', 'ZUCHT', 'TIER', 'PILZ',
  'HONIG', 'FISCH', 'DUENGER', 'PRODUKT', 'GRUEN'
];

/* 
===== EXEMPLES DE CODES À COPIER-COLLER =====
Vous pouvez utiliser n'importe quel code ci-dessous (ou changer les 4 chiffres) :

MALAGASY (NOUVEAU):
AKOHO2025, AKOHO1234, BITRO8888, KISOA1000, TANTSAHA2024
FAMBOLENA5555, FIOMPIANA7777, HOLATRA3333, TANTELY9999
TRONDRO4444, ZEZIKA1111, MADA2025, AGRI1234, TECH5678

DEUTSCH (ALLEMAND):
HUHN2025, HUHN1000, HASE1234, KANINCHEN5555, SCHWEIN9999
BAUER2024, AGRAR1111, PFLANZE2222, ZUCHT3333, TIER4444
PILZ5555, HONIG6666, FISCH7777, DUENGER8888, GRUEN9999

ANCIENS CODES (OLD):
TAN7X9K2, TAN4M8P5, TAN9R3W7, TAN2L6V8, TAN5N1Q4
AKO8T4J6, AKO3Y7H9, AKO6U2F5, AKO1Z8D3, AKO9W5B7
FAM4K7X2, FAM8P3M6, FAM2R9N1, FAM6V5L8, FAM3Q1W4
FIO7H4T9, FIO5J8Y3, FIO9D2U6, FIO1F6Z5, FIO4B9W2
HOL6X3K7, HOL2M8P4, HOL8R5N9, HOL4V1L6, HOL7Q9W3
TEL5T2J8, TEL9Y6H4, TEL3U1F7, TEL7Z5D2, TEL1W8B6
TRO8K4X5, TRO4P7M9, TRO6N2R3, TRO2L9V7, TRO9W3Q1
BIT5H8T4, BIT1J3Y6, BIT7D6U9, BIT3F2Z5, BIT6B5W8
KIS9X7K2, KIS4M1P8, KIS8R4N5, KIS2V6L3, KIS5Q8W7
ZEZ7T5J1, ZEZ3Y9H6, ZEZ6U3F4, ZEZ1Z7D9, ZEZ8W2B5
2024XK7M, 2024PL4N, 2025MX8K, 2025NP5L, MADA7K4X
*/

// ===== SYSTÈME DE GESTION DES CODES =====
class CodeManager {
  static const String _usedCodesKey = 'used_codes';
  static const String _validCodesKey = 'valid_codes';

  // Vérifier si c'est un code généré valide (PREFIX + 4 chiffres)
  static bool _isGeneratedCode(String code) {
    for (final prefix in _codePrefixes) {
      if (code.startsWith(prefix)) {
        final suffix = code.substring(prefix.length);
        if (suffix.length == 4 && int.tryParse(suffix) != null) {
          return true;
        }
      }
    }
    return false;
  }
  
  // Générer un nouveau code unique
  static String generateCode() {
    final random = Random();
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    final timestamp = DateTime.now().millisecondsSinceEpoch.toString().substring(8);
    final randomPart = List.generate(4, (index) => chars[random.nextInt(chars.length)]).join();
    return '$randomPart$timestamp'.substring(0, 8).toUpperCase();
  }
  
  // Sauvegarder un code comme valide (avec date d'expiration)
  static Future<void> saveValidCode(String code, {int expirationDays = 30}) async {
    final prefs = await SharedPreferences.getInstance();
    final validCodes = prefs.getStringList(_validCodesKey) ?? [];
    final expirationDate = DateTime.now().add(Duration(days: expirationDays));
    final codeEntry = '$code|${expirationDate.toIso8601String()}';
    
    if (!validCodes.any((c) => c.startsWith('$code|'))) {
      validCodes.add(codeEntry);
      await prefs.setStringList(_validCodesKey, validCodes);
    }
  }
  
  // Vérifier si un code est valide
  static Future<bool> isCodeValid(String code) async {
    final codeUpper = code.toUpperCase().trim();
    
    // Le code admin est toujours valide
    if (codeUpper == adminCode) return true;
    
    // Vérifier les codes pré-définis OU les codes générés (fonctionnent sur tous les appareils)
    if (predefinedCodes.contains(codeUpper) || _isGeneratedCode(codeUpper)) {
      final prefs = await SharedPreferences.getInstance();
      final usedCodes = prefs.getStringList(_usedCodesKey) ?? [];
      // Code pré-défini valide seulement s'il n'a pas été utilisé sur CET appareil
      return !usedCodes.contains(codeUpper);
    }
    
    final prefs = await SharedPreferences.getInstance();
    final validCodes = prefs.getStringList(_validCodesKey) ?? [];
    final usedCodes = prefs.getStringList(_usedCodesKey) ?? [];
    
    // Vérifier si le code a déjà été utilisé
    if (usedCodes.contains(codeUpper)) return false;
    
    // Vérifier si le code est dans la liste des codes valides et non expiré
    for (final entry in validCodes) {
      final parts = entry.split('|');
      if (parts.length == 2 && parts[0] == codeUpper) {
        final expirationDate = DateTime.tryParse(parts[1]);
        if (expirationDate != null && DateTime.now().isBefore(expirationDate)) {
          return true;
        }
      }
    }
    
    return false;
  }
  
  // Marquer un code comme utilisé (après paiement confirmé)
  static Future<void> markCodeAsUsed(String code) async {
    final prefs = await SharedPreferences.getInstance();
    final usedCodes = prefs.getStringList(_usedCodesKey) ?? [];
    
    if (!usedCodes.contains(code.toUpperCase())) {
      usedCodes.add(code.toUpperCase());
      await prefs.setStringList(_usedCodesKey, usedCodes);
    }
  }
  
  // Obtenir tous les codes valides (pour admin)
  static Future<List<Map<String, dynamic>>> getAllValidCodes() async {
    final prefs = await SharedPreferences.getInstance();
    final validCodes = prefs.getStringList(_validCodesKey) ?? [];
    final usedCodes = prefs.getStringList(_usedCodesKey) ?? [];
    
    List<Map<String, dynamic>> codes = [];
    
    // Ajouter les codes pré-définis en premier
    for (final code in predefinedCodes) {
      codes.add({
        'code': code,
        'expiration': null, // Pas d'expiration
        'isUsed': usedCodes.contains(code),
        'isExpired': false,
        'isPredefined': true,
      });
    }
    
    // Ajouter les codes générés dynamiquement
    for (final entry in validCodes) {
      final parts = entry.split('|');
      if (parts.length == 2) {
        final expirationDate = DateTime.tryParse(parts[1]);
        codes.add({
          'code': parts[0],
          'expiration': expirationDate,
          'isUsed': usedCodes.contains(parts[0]),
          'isExpired': expirationDate != null && DateTime.now().isAfter(expirationDate),
          'isPredefined': false,
        });
      }
    }
    return codes;
  }
  
  // Générer plusieurs codes (pour admin)
  static Future<List<String>> generateMultipleCodes(int count, {int expirationDays = 30}) async {
    List<String> newCodes = [];
    for (int i = 0; i < count; i++) {
      final code = generateCode();
      await saveValidCode(code, expirationDays: expirationDays);
      newCodes.add(code);
    }
    return newCodes;
  }
  
  // Supprimer tous les codes expirés
  static Future<void> cleanupExpiredCodes() async {
    final prefs = await SharedPreferences.getInstance();
    final validCodes = prefs.getStringList(_validCodesKey) ?? [];
    
    final cleanedCodes = validCodes.where((entry) {
      final parts = entry.split('|');
      if (parts.length == 2) {
        final expirationDate = DateTime.tryParse(parts[1]);
        return expirationDate != null && DateTime.now().isBefore(expirationDate);
      }
      return false;
    }).toList();
    
    await prefs.setStringList(_validCodesKey, cleanedCodes);
  }
  
  // ===== GESTION DE L'ACCÈS PERSISTANT =====
  static const String _isUnlockedKey = 'app_unlocked';
  static const String _unlockDateKey = 'unlock_date';
  static const String _usedCodeKey = 'used_code_for_unlock';
  
  // Vérifier si l'app est déjà déverrouillée
  static Future<bool> isAppUnlocked() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getBool(_isUnlockedKey) ?? false;
  }
  
  // Déverrouiller l'app après un code valide
  static Future<void> unlockApp(String code) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_isUnlockedKey, true);
    await prefs.setString(_unlockDateKey, DateTime.now().toIso8601String());
    await prefs.setString(_usedCodeKey, code);
  }
  
  // Révoquer l'accès (pour admin - reset)
  static Future<void> revokeAccess() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool(_isUnlockedKey, false);
    await prefs.remove(_unlockDateKey);
    await prefs.remove(_usedCodeKey);
  }
  
  // Obtenir les infos d'accès
  static Future<Map<String, dynamic>> getAccessInfo() async {
    final prefs = await SharedPreferences.getInstance();
    return {
      'isUnlocked': prefs.getBool(_isUnlockedKey) ?? false,
      'unlockDate': prefs.getString(_unlockDateKey),
      'usedCode': prefs.getString(_usedCodeKey),
    };
  }
}

// Glassmorphism Color Palette
class AppColors {
  static const primary = Color(0xFF2E7D32); // Deep Green
  static const primaryLight = Color(0xFF4CAF50);
  static const primaryDark = Color(0xFF1B5E20);
  static const accent = Color(0xFFFF9800); // Orange
  static const accentLight = Color(0xFFFFB74D);
  static const background = Color(0xFFE8F5E9); // Light Green Tint
  static const cardBg = Colors.white;
  static const cardBgLight = Color(0xFFF5F5F5);
  static const textPrimary = Color(0xFF1A1A2E);
  static const textSecondary = Color(0xFF6B7280);
  static const success = Color(0xFF10B981);
  static const error = Color(0xFFEF4444);
  static const warning = Color(0xFFF59E0B);
  static const info = Color(0xFF3B82F6);
  static const glass = Color(0xFFFFFFFF);
  static const gradientStart = Color(0xFF43A047);
  static const gradientEnd = Color(0xFF1B5E20);
}

class AkohoTechApp extends StatelessWidget {
  const AkohoTechApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Tantsaha',
      theme: ThemeData(
        brightness: Brightness.light,
        primaryColor: AppColors.primary,
        scaffoldBackgroundColor: AppColors.background,
        useMaterial3: true,
        colorScheme: ColorScheme.fromSeed(
          seedColor: AppColors.primary,
          brightness: Brightness.light,
        ),
        fontFamily: 'SF Pro Display',
        appBarTheme: const AppBarTheme(
          backgroundColor: Colors.transparent,
          foregroundColor: Colors.white,
          elevation: 0,
          centerTitle: false,
        ),
        cardTheme: CardThemeData(
          elevation: 0,
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
          color: AppColors.cardBg,
        ),
        elevatedButtonTheme: ElevatedButtonThemeData(
          style: ElevatedButton.styleFrom(
            backgroundColor: AppColors.primary,
            foregroundColor: Colors.white,
            padding: const EdgeInsets.symmetric(horizontal: 28, vertical: 16),
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
            elevation: 0,
            textStyle: const TextStyle(fontWeight: FontWeight.w600, fontSize: 15),
          ),
        ),
        outlinedButtonTheme: OutlinedButtonThemeData(
          style: OutlinedButton.styleFrom(
            foregroundColor: AppColors.primary,
            side: const BorderSide(color: AppColors.primary, width: 1.5),
            padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 14),
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
          ),
        ),
        inputDecorationTheme: InputDecorationTheme(
          filled: true,
          fillColor: Colors.white.withValues(alpha: 0.8),
          border: OutlineInputBorder(
            borderRadius: BorderRadius.circular(16),
            borderSide: BorderSide.none,
          ),
          enabledBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(16),
            borderSide: BorderSide(color: Colors.grey.withValues(alpha: 0.2)),
          ),
          focusedBorder: OutlineInputBorder(
            borderRadius: BorderRadius.circular(16),
            borderSide: const BorderSide(color: AppColors.primary, width: 2),
          ),
          contentPadding: const EdgeInsets.symmetric(horizontal: 18, vertical: 16),
          labelStyle: const TextStyle(color: AppColors.textSecondary),
        ),
        navigationBarTheme: NavigationBarThemeData(
          backgroundColor: Colors.white.withValues(alpha: 0.8),
          indicatorColor: AppColors.primary.withValues(alpha: 0.15),
          labelTextStyle: WidgetStateProperty.resolveWith((states) {
            if (states.contains(WidgetState.selected)) {
              return const TextStyle(fontSize: 11, fontWeight: FontWeight.w700, color: AppColors.primary);
            }
            return const TextStyle(fontSize: 11, color: AppColors.textSecondary);
          }),
          iconTheme: WidgetStateProperty.resolveWith((states) {
            if (states.contains(WidgetState.selected)) {
              return const IconThemeData(color: AppColors.primary, size: 26);
            }
            return const IconThemeData(color: AppColors.textSecondary, size: 24);
          }),
        ),
      ),
      home: const LoginScreen(),
      debugShowCheckedModeBanner: false,
    );
  }
}

// ===== ÉCRAN DE CONNEXION AVEC CODE =====
class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> with SingleTickerProviderStateMixin {
  final TextEditingController _codeController = TextEditingController();
  bool _isLoading = false;
  bool _checkingAccess = true;
  String _errorMessage = '';
  late AnimationController _animController;
  late Animation<double> _fadeAnim;

  @override
  void initState() {
    super.initState();
    _animController = AnimationController(
      duration: const Duration(milliseconds: 1500),
      vsync: this,
    );
    _fadeAnim = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _animController, curve: Curves.easeInOut),
    );
    _animController.forward();
    // Vérifier si l'app est déjà déverrouillée
    _checkExistingAccess();
    // Nettoyer les codes expirés
    CodeManager.cleanupExpiredCodes();
  }
  
  Future<void> _checkExistingAccess() async {
    final isUnlocked = await CodeManager.isAppUnlocked();
    if (isUnlocked && mounted) {
      // L'app est déjà déverrouillée, aller directement à l'app
      Navigator.of(context).pushReplacement(
        MaterialPageRoute(builder: (_) => const CategorySelectionScreen()),
      );
    } else {
      setState(() {
        _checkingAccess = false;
      });
    }
  }

  @override
  void dispose() {
    _codeController.dispose();
    _animController.dispose();
    super.dispose();
  }

  Future<void> _verifyCode() async {
    setState(() {
      _isLoading = true;
      _errorMessage = '';
    });

    await Future.delayed(const Duration(milliseconds: 800));

    final enteredCode = _codeController.text.trim().toUpperCase();
    
    // Vérifier si c'est le code admin
    if (enteredCode == adminCode) {
      // Déverrouiller l'app de façon permanente
      await CodeManager.unlockApp(enteredCode);
      if (mounted) {
        Navigator.of(context).pushReplacement(
          MaterialPageRoute(builder: (_) => const CategorySelectionScreen()),
        );
      }
      return;
    }
    
    // Vérifier si le code est valide et non utilisé
    final isValid = await CodeManager.isCodeValid(enteredCode);
    
    if (isValid) {
      // Marquer le code comme utilisé
      await CodeManager.markCodeAsUsed(enteredCode);
      // Déverrouiller l'app de façon permanente
      await CodeManager.unlockApp(enteredCode);
      if (mounted) {
        Navigator.of(context).pushReplacement(
          MaterialPageRoute(builder: (_) => const CategorySelectionScreen()),
        );
      }
    } else {
      setState(() {
        _errorMessage = 'Code invalide, expiré ou déjà utilisé.';
        _isLoading = false;
      });
    }
  }
  
  // Afficher le panneau admin pour générer des codes
  void _showAdminPanel() {
    final adminCodeController = TextEditingController();
    
    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        title: Row(
          children: [
            Icon(Icons.admin_panel_settings, color: AppColors.primary),
            const SizedBox(width: 12),
            const Text('Panneau Admin'),
          ],
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(
              controller: adminCodeController,
              obscureText: true,
              decoration: InputDecoration(
                labelText: 'Code Admin',
                prefixIcon: const Icon(Icons.lock),
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
              ),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx),
            child: const Text('Annuler'),
          ),
          ElevatedButton(
            onPressed: () {
              if (adminCodeController.text.toUpperCase() == adminCode) {
                Navigator.pop(ctx);
                _showCodeGeneratorPanel();
              } else {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text('Code admin incorrect')),
                );
              }
            },
            child: const Text('Valider'),
          ),
        ],
      ),
    );
  }
  
  void _showCodeGeneratorPanel() {
    final countController = TextEditingController(text: '5');
    final daysController = TextEditingController(text: '30');
    List<String> generatedCodes = [];
    
    showDialog(
      context: context,
      builder: (ctx) => StatefulBuilder(
        builder: (context, setDialogState) => AlertDialog(
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
          title: Row(
            children: [
              Icon(Icons.generating_tokens, color: AppColors.primary),
              const SizedBox(width: 12),
              const Expanded(child: Text('Générateur de Codes', style: TextStyle(fontSize: 18))),
            ],
          ),
          content: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Expanded(
                      child: TextField(
                        controller: countController,
                        keyboardType: TextInputType.number,
                        decoration: InputDecoration(
                          labelText: 'Nombre',
                          border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: TextField(
                        controller: daysController,
                        keyboardType: TextInputType.number,
                        decoration: InputDecoration(
                          labelText: 'Jours',
                          border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
                        ),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 16),
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton.icon(
                    onPressed: () async {
                      final count = int.tryParse(countController.text) ?? 5;
                      final days = int.tryParse(daysController.text) ?? 30;
                      final codes = await CodeManager.generateMultipleCodes(count, expirationDays: days);
                      setDialogState(() {
                        generatedCodes = codes;
                      });
                    },
                    icon: const Icon(Icons.add_circle),
                    label: const Text('Générer les codes'),
                  ),
                ),
                if (generatedCodes.isNotEmpty) ...[
                  const SizedBox(height: 16),
                  const Divider(),
                  const SizedBox(height: 8),
                  const Text('Codes générés:', style: TextStyle(fontWeight: FontWeight.bold)),
                  const SizedBox(height: 8),
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: Colors.grey.shade100,
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Column(
                      children: generatedCodes.map((code) => Padding(
                        padding: const EdgeInsets.symmetric(vertical: 4),
                        child: Row(
                          children: [
                            Expanded(
                              child: Text(
                                code,
                                style: const TextStyle(
                                  fontFamily: 'monospace',
                                  fontWeight: FontWeight.bold,
                                  fontSize: 16,
                                ),
                              ),
                            ),
                            IconButton(
                              icon: const Icon(Icons.copy, size: 20),
                              onPressed: () {
                                // Copier dans le presse-papier
                                ScaffoldMessenger.of(context).showSnackBar(
                                  SnackBar(content: Text('Code $code copié!')),
                                );
                              },
                            ),
                          ],
                        ),
                      )).toList(),
                    ),
                  ),
                  const SizedBox(height: 12),
                  SizedBox(
                    width: double.infinity,
                    child: OutlinedButton.icon(
                      onPressed: () {
                        final allCodes = generatedCodes.join('\n');
                        SharePlus.instance.share(ShareParams(text: 'Codes Tantsaha (valides ${daysController.text} jours):\n\n$allCodes'));
                      },
                      icon: const Icon(Icons.share),
                      label: const Text('Partager tous les codes'),
                    ),
                  ),
                ],
                const SizedBox(height: 16),
                const Divider(),
                TextButton.icon(
                  onPressed: () async {
                    final allCodes = await CodeManager.getAllValidCodes();
                    if (!context.mounted) return;
                    Navigator.pop(ctx);
                    _showAllCodesDialog(allCodes);
                  },
                  icon: const Icon(Icons.list),
                  label: const Text('Voir tous les codes'),
                ),
              ],
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(ctx),
              child: const Text('Fermer'),
            ),
          ],
        ),
      ),
    );
  }
  
  void _showAllCodesDialog(List<Map<String, dynamic>> codes) {
    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        title: const Text('Tous les codes'),
        content: SizedBox(
          width: double.maxFinite,
          height: 400,
          child: codes.isEmpty
              ? const Center(child: Text('Aucun code généré'))
              : ListView.builder(
                  itemCount: codes.length,
                  itemBuilder: (context, index) {
                    final code = codes[index];
                    final isUsed = code['isUsed'] as bool;
                    final isExpired = code['isExpired'] as bool;
                    final expiration = code['expiration'] as DateTime?;
                    
                    Color statusColor;
                    String status;
                    if (isUsed) {
                      statusColor = Colors.red;
                      status = 'Utilisé';
                    } else if (isExpired) {
                      statusColor = Colors.orange;
                      status = 'Expiré';
                    } else {
                      statusColor = Colors.green;
                      status = 'Valide';
                    }
                    
                    return ListTile(
                      leading: CircleAvatar(
                        backgroundColor: statusColor.withValues(alpha: 0.2),
                        child: Icon(
                          isUsed ? Icons.check : (isExpired ? Icons.timer_off : Icons.key),
                          color: statusColor,
                          size: 20,
                        ),
                      ),
                      title: Text(
                        code['code'],
                        style: TextStyle(
                          fontFamily: 'monospace',
                          fontWeight: FontWeight.bold,
                          decoration: isUsed ? TextDecoration.lineThrough : null,
                        ),
                      ),
                      subtitle: Text(
                        expiration != null
                            ? 'Expire: ${DateFormat('dd/MM/yyyy').format(expiration)}'
                            : 'Pas de date',
                      ),
                      trailing: Container(
                        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                        decoration: BoxDecoration(
                          color: statusColor.withValues(alpha: 0.2),
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: Text(
                          status,
                          style: TextStyle(color: statusColor, fontSize: 12),
                        ),
                      ),
                    );
                  },
                ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx),
            child: const Text('Fermer'),
          ),
        ],
      ),
    );
  }

  void _showPaymentDialog(String method) {
    final isAirtel = method == 'airtel';
    final color = isAirtel ? const Color(0xFFED1C24) : const Color(0xFFFFCC00);
    final textColor = isAirtel ? Colors.white : Colors.black;
    final name = isAirtel ? 'Airtel Money' : 'MVola';
    final phoneController = TextEditingController();
    
    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        title: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: color,
                borderRadius: BorderRadius.circular(8),
              ),
              child: Icon(
                isAirtel ? Icons.phone_android : Icons.account_balance_wallet,
                color: textColor,
                size: 24,
              ),
            ),
            const SizedBox(width: 12),
            Text('Payer via $name'),
          ],
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.green.shade50,
                borderRadius: BorderRadius.circular(12),
              ),
              child: Row(
                children: [
                  Icon(Icons.info_outline, color: Colors.green.shade700),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          'Prix: 10 000 Ar',
                          style: TextStyle(
                            fontWeight: FontWeight.bold,
                            color: Colors.green.shade700,
                            fontSize: 16,
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          'Accès complet à l\'application',
                          style: TextStyle(
                            color: Colors.green.shade600,
                            fontSize: 12,
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 16),
            TextField(
              controller: phoneController,
              keyboardType: TextInputType.phone,
              decoration: InputDecoration(
                labelText: 'Votre numéro $name',
                hintText: isAirtel ? '033 XX XXX XX' : '034 XX XXX XX',
                prefixIcon: const Icon(Icons.phone),
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
              ),
            ),
            const SizedBox(height: 16),
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.grey.shade100,
                borderRadius: BorderRadius.circular(12),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text(
                    'Instructions:',
                    style: TextStyle(fontWeight: FontWeight.bold),
                  ),
                  const SizedBox(height: 8),
                  Text('1. Envoyez 10 000 Ar au numéro:'),
                  const SizedBox(height: 4),
                  Container(
                    padding: const EdgeInsets.all(8),
                    decoration: BoxDecoration(
                      color: color.withValues(alpha: 0.2),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Text(
                          isAirtel ? '033 83 680 95' : '034 12 181 31',
                          style: const TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                            letterSpacing: 2,
                          ),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 12),
                  // Code USSD
                  Container(
                    padding: const EdgeInsets.all(10),
                    decoration: BoxDecoration(
                      color: color.withValues(alpha: 0.15),
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(color: color.withValues(alpha: 0.5)),
                    ),
                    child: Column(
                      children: [
                        Row(
                          children: [
                            Icon(Icons.dialpad, color: color, size: 20),
                            const SizedBox(width: 8),
                            Text(
                              'Code USSD:',
                              style: TextStyle(
                                fontWeight: FontWeight.bold,
                                color: isAirtel ? Colors.red.shade700 : Colors.amber.shade800,
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 8),
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                          decoration: BoxDecoration(
                            color: Colors.white,
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: SelectableText(
                            isAirtel 
                                ? '*436*2*3#' 
                                : '*111*1*0341218131*10000*PIN#',
                            style: TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.bold,
                              fontFamily: 'monospace',
                              color: isAirtel ? Colors.red.shade700 : Colors.amber.shade800,
                            ),
                          ),
                        ),
                        const SizedBox(height: 6),
                        Text(
                          isAirtel 
                              ? '(Suivez les instructions à l\'écran)'
                              : '(Remplacez PIN par votre code secret)',
                          style: TextStyle(
                            fontSize: 11,
                            color: Colors.grey.shade600,
                            fontStyle: FontStyle.italic,
                          ),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 12),
                  const Text('2. Entrez votre numéro ci-dessus'),
                  const Text('3. Cliquez sur "Confirmer"'),
                  const Text('4. Vous recevrez le code par SMS'),
                ],
              ),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx),
            child: const Text('Annuler'),
          ),
          ElevatedButton(
            onPressed: () {
              if (phoneController.text.isNotEmpty) {
                Navigator.pop(ctx);
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Row(
                      children: [
                        const Icon(Icons.check_circle, color: Colors.white),
                        const SizedBox(width: 12),
                        const Text('Demande envoyée! Vous recevrez le code par SMS.'),
                      ],
                    ),
                    backgroundColor: Colors.green,
                    duration: const Duration(seconds: 4),
                  ),
                );
              }
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: color,
              foregroundColor: textColor,
            ),
            child: const Text('Confirmer'),
          ),
        ],
      ),
    );
  }

  void _showDeveloperInfo() {
    showDialog(
      context: context,
      builder: (context) => Dialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
        child: Container(
          padding: const EdgeInsets.all(24),
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(24),
            gradient: const LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [Colors.white, Color(0xFFF5F5F5)],
            ),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                width: 120,
                height: 120,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  border: Border.all(color: AppColors.primary, width: 4),
                  boxShadow: [
                    BoxShadow(
                      color: AppColors.primary.withValues(alpha: 0.3),
                      blurRadius: 20,
                      spreadRadius: 5,
                    ),
                  ],
                ),
                child: ClipOval(
                  child: Image.asset(
                    'assets/images/arie.JPG',
                    fit: BoxFit.cover,
                    errorBuilder: (context, error, stackTrace) {
                      return Container(
                        color: AppColors.primary.withValues(alpha: 0.1),
                        child: const Icon(
                          Icons.person,
                          size: 60,
                          color: AppColors.primary,
                        ),
                      );
                    },
                  ),
                ),
              ),
              const SizedBox(height: 20),
              const Text(
                'Ari Havana',
                style: TextStyle(
                  fontSize: 24,
                  fontWeight: FontWeight.bold,
                  color: AppColors.textPrimary,
                ),
              ),
              const SizedBox(height: 8),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 6),
                decoration: BoxDecoration(
                  color: AppColors.primary.withValues(alpha: 0.1),
                  borderRadius: BorderRadius.circular(20),
                ),
                child: const Text(
                  'Développeur Web, Apps',
                  style: TextStyle(
                    fontSize: 14,
                    color: AppColors.primary,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
              const SizedBox(height: 16),
              const Divider(),
              const SizedBox(height: 16),
              const Text(
                'Application Tantsaha',
                style: TextStyle(
                  fontSize: 18,
                  fontWeight: FontWeight.w600,
                  color: AppColors.textPrimary,
                ),
              ),
              const SizedBox(height: 8),
              Text(
                'Fitantanana fambolena sy fiompiana\nVersion 1.0.0',
                textAlign: TextAlign.center,
                style: TextStyle(
                  fontSize: 14,
                  color: AppColors.textSecondary,
                  height: 1.5,
                ),
              ),
              const SizedBox(height: 20),
              Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  _buildSocialIcon(Icons.email, 'Email'),
                  const SizedBox(width: 16),
                  _buildSocialIcon(Icons.phone, 'Téléphone'),
                  const SizedBox(width: 16),
                  _buildSocialIcon(Icons.language, 'Web'),
                ],
              ),
              const SizedBox(height: 20),
              TextButton(
                onPressed: () => Navigator.pop(context),
                child: const Text('Fermer'),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildSocialIcon(IconData icon, String tooltip) {
    return Tooltip(
      message: tooltip,
      child: Container(
        width: 44,
        height: 44,
        decoration: BoxDecoration(
          color: AppColors.primary.withValues(alpha: 0.1),
          shape: BoxShape.circle,
        ),
        child: Icon(icon, color: AppColors.primary, size: 22),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    // Afficher un écran de chargement pendant la vérification d'accès
    if (_checkingAccess) {
      return Scaffold(
        body: Container(
          decoration: const BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [Color(0xFF1B5E20), Color(0xFF2E7D32), Color(0xFF43A047)],
            ),
          ),
          child: const Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                CircularProgressIndicator(color: Colors.white),
                SizedBox(height: 20),
                Text(
                  'Chargement...',
                  style: TextStyle(color: Colors.white, fontSize: 16),
                ),
              ],
            ),
          ),
        ),
      );
    }
    
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [Color(0xFF1B5E20), Color(0xFF2E7D32), Color(0xFF43A047)],
          ),
        ),
        child: SafeArea(
          child: FadeTransition(
            opacity: _fadeAnim,
            child: Center(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(24),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    // Logo (appui long pour admin)
                    GestureDetector(
                      onLongPress: _showAdminPanel,
                      child: Container(
                        width: 120,
                        height: 120,
                        decoration: BoxDecoration(
                          color: Colors.white,
                          shape: BoxShape.circle,
                          boxShadow: [
                            BoxShadow(
                              color: Colors.black.withValues(alpha: 0.2),
                              blurRadius: 30,
                              spreadRadius: 5,
                            ),
                          ],
                        ),
                        child: ClipOval(
                          child: Image.asset(
                            'assets/icon.png',
                            fit: BoxFit.cover,
                            errorBuilder: (context, error, stackTrace) {
                              return const Icon(
                                Icons.eco,
                                size: 60,
                                color: AppColors.primary,
                              );
                            },
                          ),
                        ),
                      ),
                    ),
                    const SizedBox(height: 24),
                    const Text(
                      'TANTSAHA',
                      style: TextStyle(
                        fontSize: 36,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                        letterSpacing: 4,
                        shadows: [
                          Shadow(
                            offset: Offset(2, 2),
                            blurRadius: 10,
                            color: Colors.black26,
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'Fitantanana fambolena sy fiompiana',
                      style: TextStyle(
                        fontSize: 16,
                        color: Colors.white.withValues(alpha: 0.9),
                        fontWeight: FontWeight.w300,
                      ),
                    ),
                    const SizedBox(height: 40),

                    // Message d'accueil (code masqué) + Paiement
                    Container(
                      padding: const EdgeInsets.all(20),
                      decoration: BoxDecoration(
                        color: Colors.white.withValues(alpha: 0.15),
                        borderRadius: BorderRadius.circular(20),
                        border: Border.all(
                          color: Colors.white.withValues(alpha: 0.3),
                        ),
                      ),
                      child: Column(
                        children: [
                          const Icon(
                            Icons.lock_outline,
                            color: Colors.white,
                            size: 40,
                          ),
                          const SizedBox(height: 10),
                          Text(
                            'Entrez le code d\'accès / Code eingeben',
                            style: TextStyle(
                              fontSize: 16,
                              color: Colors.white.withValues(alpha: 0.9),
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          const SizedBox(height: 5),
                          Text(
                            'Contactez le développeur / Entwickler kontaktieren',
                            style: TextStyle(
                              fontSize: 12,
                              color: Colors.white.withValues(alpha: 0.6),
                            ),
                          ),
                          const SizedBox(height: 16),
                          const Divider(color: Colors.white24),
                          const SizedBox(height: 12),
                          Text(
                            'Ou achetez l\'application',
                            style: TextStyle(
                              fontSize: 14,
                              color: Colors.white.withValues(alpha: 0.8),
                              fontWeight: FontWeight.w500,
                            ),
                          ),
                          const SizedBox(height: 12),
                          Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              // Airtel Money
                              GestureDetector(
                                onTap: () => _showPaymentDialog('airtel'),
                                child: Container(
                                  padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                                  decoration: BoxDecoration(
                                    color: const Color(0xFFED1C24),
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                  child: Row(
                                    mainAxisSize: MainAxisSize.min,
                                    children: const [
                                      Icon(Icons.phone_android, color: Colors.white, size: 18),
                                      SizedBox(width: 6),
                                      Text(
                                        'Airtel Money',
                                        style: TextStyle(
                                          color: Colors.white,
                                          fontSize: 12,
                                          fontWeight: FontWeight.bold,
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ),
                              const SizedBox(width: 12),
                              // MVola
                              GestureDetector(
                                onTap: () => _showPaymentDialog('mvola'),
                                child: Container(
                                  padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                                  decoration: BoxDecoration(
                                    color: const Color(0xFFFFCC00),
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                  child: Row(
                                    mainAxisSize: MainAxisSize.min,
                                    children: const [
                                      Icon(Icons.account_balance_wallet, color: Colors.black, size: 18),
                                      SizedBox(width: 6),
                                      Text(
                                        'MVola',
                                        style: TextStyle(
                                          color: Colors.black,
                                          fontSize: 12,
                                          fontWeight: FontWeight.bold,
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 10),
                          Text(
                            'À partir de 10 000 Ar',
                            style: TextStyle(
                              fontSize: 13,
                              color: Colors.white.withValues(alpha: 0.7),
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 24),

                    // Champ de saisie
                    Container(
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(16),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withValues(alpha: 0.1),
                            blurRadius: 20,
                            offset: const Offset(0, 10),
                          ),
                        ],
                      ),
                      child: TextField(
                        controller: _codeController,
                        textAlign: TextAlign.center,
                        style: const TextStyle(
                          fontSize: 24,
                          fontWeight: FontWeight.bold,
                          letterSpacing: 8,
                        ),
                        decoration: InputDecoration(
                          hintText: 'Entrez le code',
                          hintStyle: TextStyle(
                            color: Colors.grey.withValues(alpha: 0.5),
                            letterSpacing: 2,
                            fontSize: 16,
                          ),
                          border: InputBorder.none,
                          contentPadding: const EdgeInsets.all(20),
                        ),
                        textCapitalization: TextCapitalization.characters,
                        onSubmitted: (_) => _verifyCode(),
                      ),
                    ),

                    if (_errorMessage.isNotEmpty) ...[
                      const SizedBox(height: 12),
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                        decoration: BoxDecoration(
                          color: Colors.red.withValues(alpha: 0.2),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Text(
                          _errorMessage,
                          style: const TextStyle(color: Colors.white),
                        ),
                      ),
                    ],

                    const SizedBox(height: 24),

                    // Bouton de connexion
                    SizedBox(
                      width: double.infinity,
                      height: 56,
                      child: ElevatedButton(
                        onPressed: _isLoading ? null : _verifyCode,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.white,
                          foregroundColor: AppColors.primary,
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(16),
                          ),
                          elevation: 0,
                        ),
                        child: _isLoading
                            ? const SizedBox(
                                width: 24,
                                height: 24,
                                child: CircularProgressIndicator(
                                  strokeWidth: 2,
                                  color: AppColors.primary,
                                ),
                              )
                            : const Row(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  Icon(Icons.login, size: 24),
                                  SizedBox(width: 12),
                                  Text(
                                    'ACCÉDER',
                                    style: TextStyle(
                                      fontSize: 18,
                                      fontWeight: FontWeight.bold,
                                      letterSpacing: 2,
                                    ),
                                  ),
                                ],
                              ),
                      ),
                    ),

                    const SizedBox(height: 40),

                    // Développeur
                    GestureDetector(
                      onTap: _showDeveloperInfo,
                      child: Column(
                        children: [
                          Container(
                            width: 80,
                            height: 80,
                            decoration: BoxDecoration(
                              shape: BoxShape.circle,
                              border: Border.all(color: Colors.white, width: 3),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.black.withValues(alpha: 0.3),
                                  blurRadius: 15,
                                  spreadRadius: 2,
                                ),
                              ],
                            ),
                            child: ClipOval(
                              child: Image.asset(
                                'assets/images/arie.JPG',
                                fit: BoxFit.cover,
                                errorBuilder: (context, error, stackTrace) {
                                  return Container(
                                    color: Colors.white.withValues(alpha: 0.2),
                                    child: const Icon(
                                      Icons.person,
                                      color: Colors.white,
                                      size: 45,
                                    ),
                                  );
                                },
                              ),
                            ),
                          ),
                          const SizedBox(height: 12),
                          const Text(
                            'Ari Havana',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: 18,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          const SizedBox(height: 4),
                          Text(
                            'Développeur Web, Apps',
                            style: TextStyle(
                              color: Colors.white.withValues(alpha: 0.7),
                              fontSize: 13,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// Écran de sélection de catégorie
class CategorySelectionScreen extends StatelessWidget {
  const CategorySelectionScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [Color(0xFF1B5E20), Color(0xFF43A047), Color(0xFF66BB6A)],
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // === HEADER FIXE ===
              Padding(
                padding: const EdgeInsets.fromLTRB(24, 16, 24, 0),
                child: Column(
                  children: [
                    const Text(
                      'Tongasoa!',
                      style: TextStyle(
                        fontSize: 32,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                      ),
                    ),
                    const SizedBox(height: 12),
                    
                    // === TOHANO ANAY & MON PROFIL EN HAUT ===
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                      children: [
                        // Bouton TOHANO ANAY
                        GestureDetector(
                          onTap: () {
                            showDialog(
                              context: context,
                              builder: (context) => const PaymentDialog(),
                            );
                          },
                          child: Container(
                            padding: const EdgeInsets.symmetric(horizontal: 18, vertical: 12),
                            decoration: BoxDecoration(
                              gradient: LinearGradient(
                                colors: [Colors.pink.shade400, Colors.red.shade400],
                              ),
                              borderRadius: BorderRadius.circular(25),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.red.withValues(alpha: 0.5),
                                  blurRadius: 10,
                                  offset: const Offset(0, 4),
                                ),
                              ],
                            ),
                            child: const Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Icon(Icons.favorite, color: Colors.white, size: 20),
                                SizedBox(width: 8),
                                Text(
                                  'TOHANO ANAY',
                                  style: TextStyle(
                                    color: Colors.white,
                                    fontSize: 14,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ),
                        // Bouton MON PROFIL
                        GestureDetector(
                          onTap: () {
                            showDialog(
                              context: context,
                              builder: (context) => const AboutProfileDialog(),
                            );
                          },
                          child: Container(
                            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                            decoration: BoxDecoration(
                              color: Colors.white.withValues(alpha: 0.25),
                              borderRadius: BorderRadius.circular(25),
                              border: Border.all(color: Colors.white, width: 2),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.black.withValues(alpha: 0.2),
                                  blurRadius: 8,
                                  offset: const Offset(0, 3),
                                ),
                              ],
                            ),
                            child: Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Container(
                                  width: 40,
                                  height: 40,
                                  decoration: BoxDecoration(
                                    shape: BoxShape.circle,
                                    border: Border.all(color: Colors.white, width: 2),
                                  ),
                                  child: ClipOval(
                                    child: Image.asset(
                                      'assets/images/arie.JPG',
                                      fit: BoxFit.cover,
                                      errorBuilder: (context, error, stackTrace) {
                                        return const Icon(Icons.person, color: Colors.white, size: 22);
                                      },
                                    ),
                                  ),
                                ),
                                const SizedBox(width: 10),
                                const Text(
                                  'À propos',
                                  style: TextStyle(
                                    color: Colors.white,
                                    fontSize: 14,
                                    fontWeight: FontWeight.bold,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ),
                      ],
                    ),
                    
                    const SizedBox(height: 12),
                    GestureDetector(
                      onTap: () {
                        showDialog(
                          context: context,
                          builder: (context) => const FikajianaTombonyDialog(),
                        );
                      },
                      child: Container(
                        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            colors: [Colors.blue.shade700, Colors.indigo.shade700],
                          ),
                          borderRadius: BorderRadius.circular(20),
                          boxShadow: [
                            BoxShadow(
                              color: Colors.black.withValues(alpha: 0.3),
                              blurRadius: 4,
                              offset: const Offset(0, 2),
                            ),
                          ],
                        ),
                        child: const Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Icon(Icons.calculate, color: Colors.white, size: 18),
                            SizedBox(width: 6),
                            Text(
                              '📊 FIKAJIANA & TOMBONY',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: 12,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 8),
                    GestureDetector(
                      onTap: () {
                        showDialog(
                          context: context,
                          builder: (context) => const ProjectManagementDialog(),
                        );
                      },
                      child: Container(
                        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                        decoration: BoxDecoration(
                          color: Colors.purple.shade700,
                          borderRadius: BorderRadius.circular(20),
                          boxShadow: [
                            BoxShadow(
                              color: Colors.black.withValues(alpha: 0.3),
                              blurRadius: 4,
                              offset: const Offset(0, 2),
                            ),
                          ],
                        ),
                        child: const Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Icon(Icons.folder_special, color: Colors.white, size: 18),
                            SizedBox(width: 6),
                            Text(
                              'FITANTANANA TETIKASA',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: 12,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 12),
                    const Text(
                      'Safidio ny karazana fiompiana na fambolena',
                      style: TextStyle(
                        fontSize: 16,
                        color: Colors.white70,
                      ),
                    ),
                  ],
                ),
              ),
              
              const SizedBox(height: 16),
              
              // === GRILLE SCROLLABLE ===
              Expanded(
                child: SingleChildScrollView(
                  padding: const EdgeInsets.symmetric(horizontal: 24),
                  child: Column(
                    children: [
                      // FambolenaTech Card
                      _buildCategoryCard(
                        context,
                        emoji: '🌱',
                        title: 'FambolenaTech',
                        subtitle: 'Voly sy Fambolena',
                        description: 'Vary, Katsaka, Legioma, Voankazo, Zava-maniry...',
                        gradientColors: [const Color(0xFF2E7D32), const Color(0xFF1B5E20)],
                        onTap: () => Navigator.push(
                          context,
                          MaterialPageRoute(builder: (context) => const HomeScreen(category: 'fambolena')),
                        ),
                      ),
                      
                      const SizedBox(height: 16),
                      
                      // AkohoTech Card
                      _buildCategoryCard(
                        context,
                        emoji: '🐔',
                        title: 'AkohoTech',
                        subtitle: 'Vorona rehetra',
                        description: 'Akoho, Gana, Gisa, Vorontsiloza, Akanga, Papelika...',
                        gradientColors: [const Color(0xFFFF9800), const Color(0xFFFF5722)],
                        onTap: () => Navigator.push(
                          context,
                          MaterialPageRoute(builder: (context) => const HomeScreen(category: 'akoho')),
                        ),
                      ),
                      
                      const SizedBox(height: 16),
                      
                      // BitroTech Card
                      _buildCategoryCard(
                        context,
                        emoji: '🐇',
                        title: 'BitroTech',
                        subtitle: 'Bitro sy Bitro Voalavo',
                        description: 'Lapin, Cochon d\'Inde - Fiompiana biby kely',
                        gradientColors: [const Color(0xFF9C27B0), const Color(0xFF673AB7)],
                        onTap: () => Navigator.push(
                          context,
                          MaterialPageRoute(builder: (context) => const HomeScreen(category: 'bitro')),
                        ),
                      ),
                      
                      const SizedBox(height: 16),

                      // KisoaTech Card
                      _buildCategoryCard(
                        context,
                        emoji: '🐷',
                        title: 'KisoaTech',
                        subtitle: 'Kisoa sy ny manodidina',
                        description: 'Fiompiana kisoa, sakafo, fahasalamana...',
                        gradientColors: [const Color(0xFFEC407A), const Color(0xFFD81B60)],
                        onTap: () => Navigator.push(
                          context,
                          MaterialPageRoute(builder: (context) => const HomeScreen(category: 'kisoa')),
                        ),
                      ),
                      
                      const SizedBox(height: 16),

                      // TrondroTech Card
                      _buildCategoryCard(
                        context,
                        emoji: '🐟',
                        title: 'TrondroTech',
                        subtitle: 'Pisciculture - Fiompiana trondro',
                        description: 'Tilapia, Carpe - Hors sol, Dobo, Farihy, Rano velona...',
                        gradientColors: [const Color(0xFF00BCD4), const Color(0xFF0097A7)],
                        onTap: () => Navigator.push(
                          context,
                          MaterialPageRoute(builder: (context) => const HomeScreen(category: 'trondro')),
                        ),
                      ),
                      
                      const SizedBox(height: 16),

                      // TantelyTech Card
                      _buildCategoryCard(
                        context,
                        emoji: '🐝',
                        title: 'TantelyTech',
                        subtitle: 'Apiculture - Fiompiana tantely',
                        description: 'Toho-tantely, Famokarana tantely, Fahasalamana, Vokatra...',
                        gradientColors: [const Color(0xFFFFB300), const Color(0xFFFF8F00)],
                        onTap: () => Navigator.push(
                          context,
                          MaterialPageRoute(builder: (context) => const HomeScreen(category: 'tantely')),
                        ),
                      ),
                      
                      const SizedBox(height: 16),

                      // OlitraTech Card
                      _buildCategoryCard(
                        context,
                        emoji: '🪲',
                        title: 'OlitraTech',
                        subtitle: 'Insectes - Fiompiana olitra',
                        description: 'BSF (Black Soldier Fly), Vers de farine, Sakafo biby...',
                        gradientColors: [const Color(0xFF795548), const Color(0xFF5D4037)],
                        onTap: () => Navigator.push(
                          context,
                          MaterialPageRoute(builder: (context) => const HomeScreen(category: 'olitra')),
                        ),
                      ),
                      
                      const SizedBox(height: 16),
                      
                      // ZezikaTech Card
                      _buildCategoryCard(
                        context,
                        emoji: '🌿',
                        title: 'ZezikaTech',
                        subtitle: 'Engrais - Zezika organika',
                        description: 'Composte, Zezimaitso, Ranonjezika, Zezipahitra...',
                        gradientColors: [const Color(0xFF616161), const Color(0xFF424242)],
                        onTap: () => Navigator.push(
                          context,
                          MaterialPageRoute(builder: (context) => const HomeScreen(category: 'zezika')),
                        ),
                      ),
                      
                      const SizedBox(height: 16),

                      // HolatraTech Card
                      _buildCategoryCard(
                        context,
                        emoji: '🍄‍🟫',
                        title: 'HolatraTech',
                        subtitle: 'Champignons comestibles',
                        description: 'Pleurotes, Shiitake, Champignon de Paris...',
                        gradientColors: [const Color(0xFF8D6E63), const Color(0xFF6D4C41)],
                        onTap: () => Navigator.push(
                          context,
                          MaterialPageRoute(builder: (context) => const HomeScreen(category: 'holatra')),
                        ),
                      ),
                      
                      const SizedBox(height: 20),
                    ],
                  ),
                ),
              ),
              
              // === FOOTER FIXE ===
              Container(
                padding: const EdgeInsets.fromLTRB(24, 8, 24, 12),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Container(
                      width: 30,
                      height: 30,
                      decoration: const BoxDecoration(
                        shape: BoxShape.circle,
                      ),
                      child: ClipOval(
                        child: Image.asset(
                          'assets/images/arie.JPG',
                          fit: BoxFit.cover,
                          errorBuilder: (context, error, stackTrace) {
                            return const Icon(Icons.person, color: Colors.white54, size: 16);
                          },
                        ),
                      ),
                    ),
                    const SizedBox(width: 8),
                    const Text(
                      'v2.5 - by Ari Havana',
                      style: TextStyle(color: Colors.white54, fontSize: 11),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildCategoryCard(
    BuildContext context, {
    required String emoji,
    required String title,
    required String subtitle,
    required String description,
    required List<Color> gradientColors,
    required VoidCallback onTap,
  }) {
    return GestureDetector(
      onTap: onTap,
      child: Container(
        width: double.infinity,
        padding: const EdgeInsets.all(24),
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: gradientColors,
          ),
          borderRadius: BorderRadius.circular(24),
          boxShadow: [
            BoxShadow(
              color: gradientColors[0].withValues(alpha: 0.4),
              blurRadius: 20,
              offset: const Offset(0, 10),
            ),
          ],
        ),
        child: Row(
          children: [
            Text(emoji, style: const TextStyle(fontSize: 50)),
            const SizedBox(width: 20),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  FittedBox(
                    fit: BoxFit.scaleDown,
                    alignment: Alignment.centerLeft,
                    child: Text(
                      title,
                      style: const TextStyle(
                        fontSize: 28,
                        fontWeight: FontWeight.bold,
                        color: Colors.white,
                      ),
                    ),
                  ),
                  Text(
                    subtitle,
                    style: const TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.w600,
                      color: Colors.white70,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    description,
                    style: const TextStyle(
                      fontSize: 12,
                      color: Colors.white60,
                    ),
                  ),
                ],
              ),
            ),
            const Icon(Icons.arrow_forward_ios, color: Colors.white70),
          ],
        ),
      ),
    );
  }
}

class HomeScreen extends StatefulWidget {
  final String category;
  const HomeScreen({super.key, this.category = 'akoho'});

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  int _currentIndex = 0;

  List<Widget> get _pages {
    if (widget.category == 'bitro') {
      return [
        const BitroHousingScreen(),
        const BitroFeedScreen(),
        const BitroHealthScreen(),
        const BitroBreedsScreen(),
        const BitroGestationScreen(),
        const FinanceScreen(),
      ];
    } else if (widget.category == 'kisoa') {
      return [
        const KisoaHousingScreen(),
        const KisoaFeedScreen(),
        const KisoaHealthScreen(),
        const KisoaGestationScreen(),
        const FinanceScreen(),
      ];
    } else if (widget.category == 'fambolena') {
      return [
        const FambolenaCropsScreen(),
        const FambolenaCalendarScreen(),
        const FambolenaSoilScreen(),
        const FambolenaPestsScreen(),
        const FinanceScreen(),
      ];
    } else if (widget.category == 'trondro') {
      return [
        const TrondroSystemsScreen(),
        const TrondroFeedScreen(),
        const TrondroHealthScreen(),
        const TrondroWaterScreen(),
        const FinanceScreen(),
      ];
    } else if (widget.category == 'tantely') {
      return [
        const TantelyHivesScreen(),
        const TantelyProductsScreen(),
        const TantelyHealthScreen(),
        const TantelyCalendarScreen(),
        const FinanceScreen(),
      ];
    } else if (widget.category == 'olitra') {
      return [
        const OlitraSpeciesScreen(),
        const OlitraFeedScreen(),
        const OlitraProductionScreen(),
        const OlitraUsesScreen(),
        const FinanceScreen(),
      ];
    } else if (widget.category == 'zezika') {
      return [
        const ZezikaTypesScreen(),
        const ZezikaProductionScreen(),
        const ZezikaUsageScreen(),
        const ZezikaResultsScreen(),
        const FinanceScreen(),
      ];
    } else if (widget.category == 'holatra') {
      return [
        const HolatraSpeciesScreen(),
        const HolatraGrowingScreen(),
        const HolatraHarvestScreen(),
        const HolatraMarketScreen(),
        const FinanceScreen(),
      ];
    }
    return [
      const HousingScreen(),
      const FeedScreen(),
      const HealthScreen(),
      const BreedsScreen(),
      const EggsScreen(),
      const FinanceScreen(),
    ];
  }

  List<String> get _titles {
    if (widget.category == 'bitro') {
      return ['Trano', 'Sakafo', 'Fahasalamana', 'Races', 'Gestation', 'Vola'];
    } else if (widget.category == 'kisoa') {
      return ['Trano', 'Sakafo', 'Fahasalamana', 'Fiterahana', 'Vola'];
    } else if (widget.category == 'fambolena') {
      return ['Voly', 'Tetiandro', 'Tany', 'Bibikely', 'Vola'];
    } else if (widget.category == 'trondro') {
      return ['Système', 'Sakafo', 'Fahasalamana', 'Rano', 'Vola'];
    } else if (widget.category == 'tantely') {
      return ['Toho', 'Vokatra', 'Fahasalamana', 'Tetiandro', 'Vola'];
    } else if (widget.category == 'olitra') {
      return ['Karazana', 'Sakafo', 'Vokatra', 'Fampiasana', 'Vola'];
    } else if (widget.category == 'zezika') {
      return ['Karazana', 'Fanamboarana', 'Fampiasana', 'Vokatra', 'Vola'];
    } else if (widget.category == 'holatra') {
      return ['Karazana', 'Fambolena', 'Fiotazana', 'Tsena', 'Vola'];
    }
    return ['Trano', 'Sakafo', 'Fahasalamana', 'Races', 'Atody', 'Vola'];
  }

  List<Map<String, dynamic>> get _navItems {
    if (widget.category == 'bitro') {
      return [
        {'icon': '🏠', 'label': 'Trano'},
        {'icon': '🥕', 'label': 'Sakafo'},
        {'icon': '💊', 'label': 'Fahasalamana'},
        {'icon': '🧬', 'label': 'Races'},
        {'icon': '🐣', 'label': 'Gestation'},
        {'icon': '💰', 'label': 'Vola'},
      ];
    } else if (widget.category == 'kisoa') {
      return [
        {'icon': '🏠', 'label': 'Trano'},
        {'icon': '🍠', 'label': 'Sakafo'},
        {'icon': '💉', 'label': 'Fahasalamana'},
        {'icon': '🐷', 'label': 'Fiterahana'},
        {'icon': '💰', 'label': 'Vola'},
      ];
    } else if (widget.category == 'fambolena') {
      return [
        {'icon': '🌱', 'label': 'Voly'},
        {'icon': '📅', 'label': 'Tetiandro'},
        {'icon': '🪨', 'label': 'Tany'},
        {'icon': '🐛', 'label': 'Bibikely'},
        {'icon': '💰', 'label': 'Vola'},
      ];
    } else if (widget.category == 'trondro') {
      return [
        {'icon': '🏊', 'label': 'Système'},
        {'icon': '🦐', 'label': 'Sakafo'},
        {'icon': '🩺', 'label': 'Fahasalamana'},
        {'icon': '💧', 'label': 'Rano'},
        {'icon': '💰', 'label': 'Vola'},
      ];
    } else if (widget.category == 'tantely') {
      return [
        {'icon': '🏠', 'label': 'Toho'},
        {'icon': '🍯', 'label': 'Vokatra'},
        {'icon': '🩺', 'label': 'Fahasalamana'},
        {'icon': '📅', 'label': 'Tetiandro'},
        {'icon': '💰', 'label': 'Vola'},
      ];
    } else if (widget.category == 'olitra') {
      return [
        {'icon': '🪲', 'label': 'Karazana'},
        {'icon': '🥬', 'label': 'Sakafo'},
        {'icon': '📦', 'label': 'Vokatra'},
        {'icon': '🎯', 'label': 'Fampiasana'},
        {'icon': '💰', 'label': 'Vola'},
      ];
    } else if (widget.category == 'zezika') {
      return [
        {'icon': '🌿', 'label': 'Karazana'},
        {'icon': '🔧', 'label': 'Fanamboarana'},
        {'icon': '🌱', 'label': 'Fampiasana'},
        {'icon': '📊', 'label': 'Vokatra'},
        {'icon': '💰', 'label': 'Vola'},
      ];
    } else if (widget.category == 'holatra') {
      return [
        {'icon': '🍄‍🟫', 'label': 'Karazana'},
        {'icon': '🌡️', 'label': 'Fambolena'},
        {'icon': '📦', 'label': 'Fiotazana'},
        {'icon': '🛒', 'label': 'Tsena'},
        {'icon': '💰', 'label': 'Vola'},
      ];
    }
    return [
      {'icon': '🏠', 'label': 'Trano'},
      {'icon': '🌾', 'label': 'Sakafo'},
      {'icon': '💊', 'label': 'Aretina'},
      {'icon': '🐔', 'label': 'Races'},
      {'icon': '🥚', 'label': 'Atody'},
      {'icon': '💰', 'label': 'Vola'},
    ];
  }

  String get _appTitle {
    if (widget.category == 'bitro') return 'BitroTech';
    if (widget.category == 'kisoa') return 'KisoaTech';
    if (widget.category == 'fambolena') return 'FambolenaTech';
    if (widget.category == 'trondro') return 'TrondroTech';
    if (widget.category == 'tantely') return 'TantelyTech';
    if (widget.category == 'olitra') return 'OlitraTech';
    if (widget.category == 'zezika') return 'ZezikaTech';
    if (widget.category == 'holatra') return 'HolatraTech';
    return 'AkohoTech';
  }

  String get _appEmoji {
    if (widget.category == 'bitro') return '🐇';
    if (widget.category == 'kisoa') return '🐷';
    if (widget.category == 'fambolena') return '🌱';
    if (widget.category == 'trondro') return '🐟';
    if (widget.category == 'tantely') return '🐝';
    if (widget.category == 'olitra') return '🪲';
    if (widget.category == 'zezika') return '🌿';
    if (widget.category == 'holatra') return '🍄‍🟫';
    return '🐔';
  }

  // Temps d'incubation/gestation par type d'animal
  static const Map<String, Map<String, dynamic>> _incubationData = {
    'Akoho (Poule)': {'days': 21, 'temp': '37.5-37.8°C', 'humidity': '55-60%', 'emoji': '🐔', 'turning': '3-5x/andro'},
    'Gana (Canard)': {'days': 28, 'temp': '37.5°C', 'humidity': '55-70%', 'emoji': '🦆', 'turning': '3-5x/andro'},
    'Dokotra (Canard Barbarie)': {'days': 35, 'temp': '37.5°C', 'humidity': '55-70%', 'emoji': '🦆', 'turning': '3-5x/andro'},
    'Gisa (Oie)': {'days': 30, 'temp': '37.4°C', 'humidity': '55-70%', 'emoji': '🦢', 'turning': '3-5x/andro'},
    'Vorontsiloza (Dinde)': {'days': 28, 'temp': '37.5°C', 'humidity': '55-60%', 'emoji': '🦃', 'turning': '3-5x/andro'},
    'Akanga (Pintade)': {'days': 26, 'temp': '37.5°C', 'humidity': '55-60%', 'emoji': '🐓', 'turning': '3-5x/andro'},
    'Akohonala (Faisan)': {'days': 24, 'temp': '37.5°C', 'humidity': '55-60%', 'emoji': '🦃', 'turning': '3-5x/andro'},
    'Papelika (Caille)': {'days': 17, 'temp': '37.5°C', 'humidity': '55-60%', 'emoji': '🐦', 'turning': '4-6x/andro'},
    'Aotrisy (Autruche)': {'days': 42, 'temp': '36.1°C', 'humidity': '25-35%', 'emoji': '🦚', 'turning': '3x/andro'},
    'Bitro (Lapin)': {'days': 31, 'temp': 'Gestation', 'humidity': '4-12 zaza', 'emoji': '🐇', 'turning': 'Tsy ilaina'},
    'Bitro Voalavo (Cochon d\'Inde)': {'days': 68, 'temp': 'Gestation', 'humidity': '1-6 zaza', 'emoji': '🐹', 'turning': 'Tsy ilaina'},
  };

  void _showAddEggCollectionDialog() async {
    final prefs = await SharedPreferences.getInstance();
    final quantityCtrl = TextEditingController();
    final notesCtrl = TextEditingController();
    DateTime selectedDate = DateTime.now();

    if (!mounted) return;
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (ctx) => StatefulBuilder(
        builder: (context, setModalState) => Container(
          padding: EdgeInsets.only(bottom: MediaQuery.of(ctx).viewInsets.bottom),
          decoration: const BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
          ),
          child: Padding(
            padding: const EdgeInsets.all(24),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(10),
                      decoration: BoxDecoration(
                        color: AppColors.warning.withValues(alpha: 0.1),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: const Text('🥚', style: TextStyle(fontSize: 24)),
                    ),
                    const SizedBox(width: 12),
                    const Text('Atody Voangona', style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
                  ],
                ),
                const SizedBox(height: 20),
                GestureDetector(
                  onTap: () async {
                    final picked = await showDatePicker(
                      context: context,
                      initialDate: selectedDate,
                      firstDate: DateTime(2020),
                      lastDate: DateTime.now(),
                    );
                    if (picked != null) setModalState(() => selectedDate = picked);
                  },
                  child: Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: Colors.grey[100],
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Row(
                      children: [
                        const Icon(Icons.calendar_today, color: AppColors.primary),
                        const SizedBox(width: 12),
                        Text(DateFormat('dd MMMM yyyy').format(selectedDate), style: const TextStyle(fontSize: 16)),
                      ],
                    ),
                  ),
                ),
                const SizedBox(height: 12),
                TextField(
                  controller: quantityCtrl,
                  keyboardType: TextInputType.number,
                  decoration: const InputDecoration(labelText: 'Isan\'ny atody', prefixIcon: Icon(Icons.numbers)),
                ),
                const SizedBox(height: 12),
                TextField(controller: notesCtrl, decoration: const InputDecoration(labelText: 'Fanamarihana', prefixIcon: Icon(Icons.notes))),
                const SizedBox(height: 20),
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton.icon(
                    onPressed: () async {
                      if (quantityCtrl.text.isNotEmpty) {
                        final eggsJson = prefs.getString('eggCollections') ?? '[]';
                        final eggs = List<Map<String, dynamic>>.from(jsonDecode(eggsJson));
                        eggs.add({
                          'id': DateTime.now().millisecondsSinceEpoch.toString(),
                          'date': DateFormat('yyyy-MM-dd').format(selectedDate),
                          'quantity': int.tryParse(quantityCtrl.text) ?? 0,
                          'notes': notesCtrl.text,
                        });
                        await prefs.setString('eggCollections', jsonEncode(eggs));
                        if (!mounted || !ctx.mounted) return;
                        Navigator.pop(ctx);
                        // Refresh the EggsScreen
                        setState(() {
                          _pages[4] = const EggsScreen();
                        });
                      }
                    },
                    icon: const Icon(Icons.add),
                    label: const Text('Hampiditra'),
                    style: ElevatedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 14)),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  void _showAddIncubationDialog() async {
    final prefs = await SharedPreferences.getInstance();
    final quantityCtrl = TextEditingController();
    final notesCtrl = TextEditingController();
    DateTime startDate = DateTime.now();
    bool enableAlarm = true;
    String selectedType = 'Akoho (Poule)';

    if (!mounted) return;
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (ctx) => StatefulBuilder(
        builder: (context, setModalState) {
          final incubData = _incubationData[selectedType]!;
          final int incubDays = incubData['days'];
          final hatchDate = startDate.add(Duration(days: incubDays));
          
          return Container(
            height: MediaQuery.of(ctx).size.height * 0.85,
            padding: EdgeInsets.only(bottom: MediaQuery.of(ctx).viewInsets.bottom),
            decoration: const BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
            ),
            child: Padding(
              padding: const EdgeInsets.all(24),
              child: SingleChildScrollView(
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Container(
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: AppColors.success.withValues(alpha: 0.1),
                            borderRadius: BorderRadius.circular(12),
                          ),
                          child: Text(incubData['emoji'], style: const TextStyle(fontSize: 24)),
                        ),
                        const SizedBox(width: 12),
                        const Expanded(child: Text('Fanaovana Zana-akoho', style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold))),
                      ],
                    ),
                    const SizedBox(height: 20),
                    
                    // Type de volaille
                    DropdownButtonFormField<String>(
                      initialValue: selectedType,
                      isExpanded: true,
                      decoration: const InputDecoration(
                        labelText: 'Karazan\'ny vorona',
                        prefixIcon: Icon(Icons.egg_alt),
                      ),
                      items: _incubationData.keys.map((type) => DropdownMenuItem(
                        value: type,
                        child: Text('${_incubationData[type]!['emoji']} $type (${_incubationData[type]!['days']}j)', overflow: TextOverflow.ellipsis),
                      )).toList(),
                      onChanged: (v) => setModalState(() => selectedType = v!),
                    ),
                    const SizedBox(height: 16),
                    
                    // Informations d'incubation
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(colors: [Colors.blue.shade50, Colors.cyan.shade50]),
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(color: Colors.blue.shade200),
                      ),
                      child: Column(
                        children: [
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceAround,
                            children: [
                              Column(children: [
                                const Text('⏱️', style: TextStyle(fontSize: 20)),
                                Text('$incubDays andro', style: const TextStyle(fontWeight: FontWeight.bold)),
                              ]),
                              Column(children: [
                                const Text('🌡️', style: TextStyle(fontSize: 20)),
                                Text(incubData['temp'], style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                              ]),
                              Column(children: [
                                const Text('💧', style: TextStyle(fontSize: 20)),
                                Text(incubData['humidity'], style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                              ]),
                            ],
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 16),
                    
                    // Date de début
                    GestureDetector(
                      onTap: () async {
                        final picked = await showDatePicker(
                          context: context,
                          initialDate: startDate,
                          firstDate: DateTime(2020),
                          lastDate: DateTime.now().add(const Duration(days: 30)),
                        );
                        if (picked != null) setModalState(() => startDate = picked);
                      },
                      child: Container(
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          color: Colors.grey[100],
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: Row(
                          children: [
                            const Icon(Icons.calendar_today, color: AppColors.primary),
                            const SizedBox(width: 12),
                            Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                const Text('Daty nanombohana', style: TextStyle(color: AppColors.textSecondary, fontSize: 12)),
                                Text(DateFormat('dd MMM yyyy').format(startDate), style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                              ],
                            ),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 12),
                    
                    // Date d'éclosion
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: AppColors.success.withValues(alpha: 0.1),
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(color: AppColors.success.withValues(alpha: 0.3)),
                      ),
                      child: Row(
                        children: [
                          const Text('🐣', style: TextStyle(fontSize: 24)),
                          const SizedBox(width: 12),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                const Text('Éclosion prévue', style: TextStyle(color: AppColors.textSecondary, fontSize: 12)),
                                Text(DateFormat('dd MMM yyyy').format(hatchDate), style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: AppColors.success)),
                              ],
                            ),
                          ),
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                            decoration: BoxDecoration(color: AppColors.success, borderRadius: BorderRadius.circular(20)),
                            child: Text('$incubDays j', style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 12),
                    
                    TextField(
                      controller: quantityCtrl,
                      keyboardType: TextInputType.number,
                      decoration: const InputDecoration(labelText: 'Isan\'ny atody', prefixIcon: Icon(Icons.numbers)),
                    ),
                    const SizedBox(height: 12),
                    
                    // Alarm toggle
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                      decoration: BoxDecoration(color: Colors.grey[100], borderRadius: BorderRadius.circular(12)),
                      child: Row(
                        children: [
                          const Icon(Icons.alarm, color: AppColors.warning),
                          const SizedBox(width: 12),
                          const Expanded(child: Text('Alerte réveil éclosion')),
                          Switch(
                            value: enableAlarm,
                            onChanged: (v) => setModalState(() => enableAlarm = v),
                            activeThumbColor: AppColors.success,
                            activeTrackColor: AppColors.success.withValues(alpha: 0.4),
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 12),
                    TextField(controller: notesCtrl, decoration: const InputDecoration(labelText: 'Fanamarihana', prefixIcon: Icon(Icons.notes))),
                    const SizedBox(height: 20),
                    
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton.icon(
                        onPressed: () async {
                          if (quantityCtrl.text.isNotEmpty) {
                            final incubJson = prefs.getString('incubations') ?? '[]';
                            final incubations = List<Map<String, dynamic>>.from(jsonDecode(incubJson));
                            incubations.add({
                              'id': DateTime.now().millisecondsSinceEpoch.toString(),
                              'type': selectedType,
                              'incubDays': incubDays,
                              'startDate': DateFormat('yyyy-MM-dd').format(startDate),
                              'hatchDate': DateFormat('yyyy-MM-dd').format(hatchDate),
                              'quantity': int.tryParse(quantityCtrl.text) ?? 0,
                              'hatched': 0,
                              'status': 'En cours',
                              'alarmEnabled': enableAlarm,
                              'notes': notesCtrl.text,
                            });
                            await prefs.setString('incubations', jsonEncode(incubations));
                            if (!mounted || !ctx.mounted) return;
                            Navigator.pop(ctx);
                            ScaffoldMessenger.of(context).showSnackBar(
                              SnackBar(
                                content: Text('✅ Incubation ajoutée! Éclosion prévue: ${DateFormat('dd/MM/yyyy').format(hatchDate)}'),
                                backgroundColor: AppColors.success,
                              ),
                            );
                            // Refresh
                            setState(() {});
                          }
                        },
                        icon: const Icon(Icons.add),
                        label: const Text('Hampiditra'),
                        style: ElevatedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 14)),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            colors: [AppColors.gradientStart, AppColors.gradientEnd],
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
          ),
        ),
        child: SafeArea(
          child: Column(
            children: [
              // Glassmorphism Header
              Container(
                margin: const EdgeInsets.all(16),
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.white.withValues(alpha: 0.2),
                  borderRadius: BorderRadius.circular(24),
                  border: Border.all(color: Colors.white.withValues(alpha: 0.3)),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(alpha: 0.1),
                      blurRadius: 20,
                      offset: const Offset(0, 10),
                    ),
                  ],
                ),
                child: Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: Colors.white.withValues(alpha: 0.15),
                        borderRadius: BorderRadius.circular(16),
                      ),
                      child: Text(_appEmoji, style: const TextStyle(fontSize: 28)),
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          FittedBox(
                            fit: BoxFit.scaleDown,
                            alignment: Alignment.centerLeft,
                            child: Text(_appTitle, style: const TextStyle(fontWeight: FontWeight.w800, fontSize: 22, color: Colors.white, letterSpacing: -0.5)),
                          ),
                          const SizedBox(height: 4),
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                            decoration: BoxDecoration(
                              color: Colors.white.withValues(alpha: 0.25),
                              borderRadius: BorderRadius.circular(20),
                            ),
                            child: Text(_titles[_currentIndex], style: const TextStyle(fontSize: 12, color: Colors.white, fontWeight: FontWeight.w600)),
                          ),
                        ],
                      ),
                    ),
                    Container(
                      decoration: BoxDecoration(
                        color: Colors.white.withValues(alpha: 0.2),
                        borderRadius: BorderRadius.circular(14),
                      ),
                      child: IconButton(
                        icon: const Icon(Icons.info_outline, color: Colors.white, size: 22),
                        onPressed: () {
                          showAboutDialog(
                            context: context,
                            applicationName: _appTitle,
                            applicationVersion: '3.0 Glass',
                            applicationIcon: Container(
                              padding: const EdgeInsets.all(16),
                              decoration: BoxDecoration(
                                gradient: const LinearGradient(colors: [AppColors.gradientStart, AppColors.gradientEnd]),
                                borderRadius: BorderRadius.circular(20),
                              ),
                              child: Text(_appEmoji, style: const TextStyle(fontSize: 40)),
                            ),
                            children: [Text(widget.category == 'bitro' 
                                ? 'Fampiharana momba ny fiompiana bitro sy bitro voalavo.'
                                : 'Fampiharana momba ny fiompiana akoho.')],
                          );
                        },
                      ),
                    ),
                  ],
                ),
              ),
              
              // Content Area
              Expanded(
                child: Container(
                  margin: const EdgeInsets.fromLTRB(16, 0, 16, 0),
                  decoration: BoxDecoration(
                    color: Colors.white.withValues(alpha: 0.9),
                    borderRadius: const BorderRadius.vertical(top: Radius.circular(32)),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withValues(alpha: 0.05),
                        blurRadius: 20,
                        offset: const Offset(0, -5),
                      ),
                    ],
                  ),
                  child: ClipRRect(
                    borderRadius: const BorderRadius.vertical(top: Radius.circular(32)),
                    child: AnimatedSwitcher(
                      duration: const Duration(milliseconds: 300),
                      child: Container(
                        key: ValueKey<int>(_currentIndex),
                        child: _pages[_currentIndex],
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
      // Floating Action Button pour Atody - SEULEMENT pour AkohoTech
      floatingActionButton: (widget.category == 'akoho' && _currentIndex == 4) ? FloatingActionButton.extended(
        onPressed: () {
          // Afficher dialog pour choisir: Collection ou Incubation
          showModalBottomSheet(
            context: context,
            backgroundColor: Colors.transparent,
            builder: (ctx) => Container(
              padding: const EdgeInsets.all(24),
              decoration: const BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
              ),
              child: Column(
                mainAxisSize: MainAxisSize.min,
                children: [
                  const Text('Inona no tianao hampidirina?', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                  const SizedBox(height: 20),
                  Row(
                    children: [
                      Expanded(
                        child: InkWell(
                          onTap: () {
                            Navigator.pop(ctx);
                            Future.delayed(const Duration(milliseconds: 300), () {
                              if (mounted) _showAddEggCollectionDialog();
                            });
                          },
                          child: Container(
                            padding: const EdgeInsets.all(20),
                            decoration: BoxDecoration(
                              color: AppColors.warning.withValues(alpha: 0.1),
                              borderRadius: BorderRadius.circular(16),
                              border: Border.all(color: AppColors.warning),
                            ),
                            child: const Column(
                              children: [
                                Text('🥚', style: TextStyle(fontSize: 40)),
                                SizedBox(height: 8),
                                Text('Atody Voangona', style: TextStyle(fontWeight: FontWeight.bold)),
                                Text('Collecte d\'œufs', style: TextStyle(fontSize: 12, color: AppColors.textSecondary)),
                              ],
                            ),
                          ),
                        ),
                      ),
                      const SizedBox(width: 16),
                      Expanded(
                        child: InkWell(
                          onTap: () {
                            Navigator.pop(ctx);
                            Future.delayed(const Duration(milliseconds: 300), () {
                              if (mounted) _showAddIncubationDialog();
                            });
                          },
                          child: Container(
                            padding: const EdgeInsets.all(20),
                            decoration: BoxDecoration(
                              color: AppColors.success.withValues(alpha: 0.1),
                              borderRadius: BorderRadius.circular(16),
                              border: Border.all(color: AppColors.success),
                            ),
                            child: const Column(
                              children: [
                                Text('🐣', style: TextStyle(fontSize: 40)),
                                SizedBox(height: 8),
                                Text('Incubation', style: TextStyle(fontWeight: FontWeight.bold)),
                                Text('Fanaovana zana-akoho', style: TextStyle(fontSize: 12, color: AppColors.textSecondary)),
                              ],
                            ),
                          ),
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 16),
                ],
              ),
            ),
          );
        },
        icon: const Icon(Icons.add),
        label: const Text('Hanampy'),
        backgroundColor: AppColors.primary,
      ) : null,
      bottomNavigationBar: Container(
        decoration: BoxDecoration(
          color: Colors.white,
          boxShadow: [
            BoxShadow(
              color: AppColors.primary.withValues(alpha: 0.1),
              blurRadius: 20,
              offset: const Offset(0, -5),
            ),
          ],
        ),
        child: NavigationBar(
          selectedIndex: _currentIndex,
          onDestinationSelected: (int index) {
            setState(() {
              _currentIndex = index;
            });
          },
          destinations: _navItems.map((item) => NavigationDestination(
            icon: Text(item['icon'] as String, style: const TextStyle(fontSize: 22)),
            selectedIcon: Text(item['icon'] as String, style: const TextStyle(fontSize: 24)),
            label: item['label'] as String,
          )).toList(),
        ),
      ),
    );
  }
}

// --- MODULE 1: TRANO (HOUSING) ---
class HousingScreen extends StatefulWidget {
  const HousingScreen({super.key});

  @override
  State<HousingScreen> createState() => _HousingScreenState();
}

class _HousingScreenState extends State<HousingScreen> {
  String _type = 'Chair'; // Chair, Pondeuse, Gasy
  final TextEditingController _countController = TextEditingController(text: '100');
  String _result = '';
  String _equipment = '';
  double _suggestedLength = 0;
  double _suggestedWidth = 0;
  bool _showFloorPlan = false; // Toggle for 2D floor plan

  void _calculate() {
    int count = int.tryParse(_countController.text) ?? 0;
    double area = 0;
    String equip = '';

    setState(() {
      if (_type == 'Chair') {
        area = count / 10;
        equip = '• Hakitroka: 10 akoho/m² (Standard)\n• Lafika matevina (8-10 sm)\n• Jiro manafana (35°C fanombohana)\n• Tsy mila Perchoir';
      } else if (_type == 'Pondeuse') {
        area = count / 5.5;
        double perch = count * 0.20;
        equip = '• Hakitroka: ~5.5 akoho/m²\n• Perchoir: ${perch.toStringAsFixed(1)} metatra\n• Akany fanatodizana: ${(count / 5).ceil()} isa\n• Lafika (8-10 sm)';
      } else if (_type == 'Ornement') {
        area = count / 4.0;
        equip = '• Hakitroka: 4 akoho/m² (Miaro ny volom-borona)\n• Perchoir ilaina\n• Lafika madio tsara';
      } else if (_type == 'Nain') {
        area = count / 12.0;
        equip = '• Hakitroka: 12 akoho/m²\n• Perchoir ivaiva\n• Lafika (5-8 sm)';
      } else if (_type == 'Gana') {
        // Canard: 4-5/m²
        area = count / 4.5;
        equip = '• 🦆 Gana: 4-5/m²\n• Dobo rano ilaina\n• Lafika maina tsara\n• Tsy mila perchoir';
      } else if (_type == 'Dokotra') {
        // Canard de Barbarie: 3-4/m² (plus grand)
        area = count / 3.5;
        equip = '• 🦆 Dokotra: 3-4/m²\n• Dobo rano ilaina\n• Perchoir iva (20-30 sm)\n• Akany fanatodizana';
      } else if (_type == 'Sarindokotra') {
        // Mulard (croisement Gana x Dokotra): 3-4/m²
        area = count / 3.5;
        equip = '• 🦆 Sarindokotra (Mulard): 3-4/m²\n• Dobo rano ilaina\n• Trano malalaka\n• Gavage: 0.5m² isaky ny iray\n• Tsy miteraka (Stérile)';
      } else if (_type == 'Gisa') {
        // Oie: 2-3/m²
        area = count / 2.5;
        equip = '• 🦢 Gisa: 2-3/m²\n• Dobo lehibe ilaina\n• Fefy malalaka\n• Ahitra ho an\'ny fihinanana';
      } else if (_type == 'Vorontsiloza') {
        // Dinde: 3-4/m²
        area = count / 3.5;
        equip = '• 🦃 Vorontsiloza: 3-4/m²\n• Perchoir matanjaka\n• Trano avo (3m+)\n• Fefy malalaka';
      } else if (_type == 'VorontsilozaChair') {
        // Dinde à chair (engraissement): 2-3/m²
        area = count / 2.5;
        equip = '• 🦃 Vorontsiloza Chair: 2-3/m²\n• Tsy mila perchoir (mavesatra loatra)\n• Lafika matevina (10-15 sm)\n• Trano malalaka\n• Lanja vonjena: 8-15 kg';
      } else if (_type == 'Akanga') {
        // Pintade: 6-8/m²
        area = count / 7.0;
        equip = '• 🐓 Akanga: 6-8/m²\n• Perchoir avo ilaina\n• Fefy voaaro tsara (mahay manidina)\n• Lafika maina';
      } else if (_type == 'Akohonala') {
        // Faisan: 4-5/m²
        area = count / 4.5;
        equip = '• 🦃 Akohonala: 4-5/m²\n• Fefy avo (mahay manidina)\n• Zava-maniry ao anatiny\n• Toerana miafina';
      } else if (_type == 'Papelika') {
        // Caille: 40-50/m²
        area = count / 45.0;
        equip = '• 🐦 Papelika: 40-50/m²\n• Trano iva (30-40 sm)\n• Lafika fasika\n• Jiro 16-18 ora/andro';
      } else if (_type == 'Bitro') {
        // Lapin: 0.5m² par lapin adulte
        area = count * 0.5;
        equip = '• 🐇 Bitro: 0.5 m²/iray\n• Tranom-bitro (Cage) na Clapier\n• Lafika hay na fasika\n• Fitoeran-drano sy sakafo\n• Toerana miafina hiterahan\'ny vavy';
      } else if (_type == 'BitroVolavo') {
        // Cochon d'Inde: 0.2m² par animal
        area = count * 0.2;
        equip = '• 🐹 Bitro Voalavo: 0.2 m²/iray\n• Cage malalaka\n• Lafika hay na fasika\n• Fitoerana miafina\n• Fantsona rano (Biberon)';
      } else {
        // Gasy
        area = count / 8.0;
        equip = '• Hakitroka: 8 akoho/m² (Trano fatoriana)\n• Fefy ahafahana mikarenjy\n• Perchoir ilaina amin\'ny alina';
      }
      
      // Suggest dimensions
      double suggestedWidth = area <= 25 ? 3.0 : 6.0;
      double suggestedLength = area > 0 ? area / suggestedWidth : 0;
      
      _suggestedWidth = suggestedWidth;
      _suggestedLength = suggestedLength;

      _result = 'Surface: ${area.toStringAsFixed(2)} m²\n'
          'Dimensions (Suggérées):\n'
          '• Longueur: ${suggestedLength.toStringAsFixed(2)} m\n'
          '• Largeur: ${suggestedWidth.toStringAsFixed(2)} m\n'
          '• Hauteur: 2.5m - 3.5m';
      _equipment = equip;
    });
  }

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: [
          _buildCard(
            title: 'Kajy ny haben\'ny Trano',
            child: Column(
              children: [
                DropdownButtonFormField<String>(
                  initialValue: _type,
                  decoration: const InputDecoration(labelText: 'Karazana Biby'),
                  items: ['Chair', 'Pondeuse', 'Gasy', 'Ornement', 'Nain', 'Mpiady', 'Gana', 'Dokotra', 'Sarindokotra', 'Gisa', 'Vorontsiloza', 'VorontsilozaChair', 'Akanga', 'Akohonala', 'Papelika', 'Bitro', 'BitroVolavo'].map((String val) {
                    String label = val;
                    if (val == 'Bitro') label = '🐇 Bitro (Lapin)';
                    if (val == 'BitroVolavo') label = '🐹 Bitro Voalavo';
                    if (val == 'Sarindokotra') label = '🦆 Sarindokotra (Mulard)';
                    if (val == 'VorontsilozaChair') label = '🦃 Vorontsiloza Chair';
                    return DropdownMenuItem(value: val, child: Text(label));
                  }).toList(),
                  onChanged: (val) => setState(() => _type = val!),
                ),
                const SizedBox(height: 10),
                TextField(
                  controller: _countController,
                  keyboardType: TextInputType.number,
                  decoration: const InputDecoration(labelText: 'Isan\'ny Biby', border: OutlineInputBorder()),
                ),
                const SizedBox(height: 15),
                ElevatedButton(
                  onPressed: _calculate,
                  style: ElevatedButton.styleFrom(backgroundColor: Colors.green, foregroundColor: Colors.white),
                  child: const Text('MANAO KAJY'),
                ),
              ],
            ),
          ),
          if (_result.isNotEmpty) ...[
            const SizedBox(height: 20),
            _buildCard(
              title: 'Vokatra',
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(_result, style: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: Colors.green)),
                  const Divider(),
                  const Text('Fitaovana ilaina:', style: TextStyle(fontWeight: FontWeight.bold)),
                  Text(_equipment, style: const TextStyle(fontSize: 16)),
                  const SizedBox(height: 20),
                  // Toggle button for 2D floor plan
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Expanded(
                        child: Row(
                          children: [
                            const Icon(Icons.architecture, color: Colors.green, size: 20),
                            const SizedBox(width: 8),
                            Flexible(
                              child: Text('Plan 2D (Vue de dessus)', style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16), overflow: TextOverflow.ellipsis),
                            ),
                          ],
                        ),
                      ),
                      Switch(
                        value: _showFloorPlan,
                        onChanged: (val) => setState(() => _showFloorPlan = val),
                        activeTrackColor: Colors.green.withValues(alpha: 0.5),
                        thumbColor: WidgetStateProperty.resolveWith((states) => states.contains(WidgetState.selected) ? Colors.green : Colors.grey),
                      ),
                    ],
                  ),
                  if (_showFloorPlan) ...[                  
                    const SizedBox(height: 10),
                    Container(
                      height: 300,
                      width: double.infinity,
                      decoration: BoxDecoration(
                        color: Colors.white,
                        border: Border.all(color: Colors.black, width: 2),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: CustomPaint(
                        painter: FloorPlan2DPainter(
                          length: _suggestedLength,
                          width: _suggestedWidth,
                          buildingType: _type,
                          animalCount: int.tryParse(_countController.text) ?? 0,
                        ),
                      ),
                    ),
                    const SizedBox(height: 5),
                    const Center(child: Text('🗺️ Plan architectural - Vue de dessus', style: TextStyle(color: Colors.grey, fontSize: 12))),
                  ],
                  const SizedBox(height: 10),
                  Container(
                    padding: const EdgeInsets.all(8),
                    color: Colors.amber[100],
                    child: const Text('💡 Torohevitra: Ataovy misolampy 40° ny tafo ary 10% ny varavarankely.'),
                  )
                ],
              ),
            ),
          ]
        ],
      ),
    );
  }
}

// 3D Painter with rotation
class Coop3DPainter extends CustomPainter {
  final double length;
  final double width;
  final double height = 3.0;
  final double rotationX;
  final double rotationY;
  final double zoomLevel;

  Coop3DPainter({
    required this.length, 
    required this.width,
    required this.rotationX,
    required this.rotationY,
    this.zoomLevel = 1.0,
  });

  @override
  void paint(Canvas canvas, Size size) {
    if (length == 0 || width == 0) return;

    // Apply rotation transformation
    double cosX = cos(rotationX);
    double sinX = sin(rotationX);
    double cosY = cos(rotationY);
    double sinY = sin(rotationY);

    // 3D to 2D projection function with depth
    Offset project3D(double x, double y, double z) {
      // Rotate around Y axis
      double rx = x * cosY - z * sinY;
      double rz = x * sinY + z * cosY;
      // Rotate around X axis
      double ry = y * cosX - rz * sinX;
      double rz2 = y * sinX + rz * cosX;
      
      // Perspective projection
      double scale = 220 / (220 + rz2);
      double px = rx * scale + size.width / 2;
      double py = ry * scale + size.height / 2 - 20;
      return Offset(px, py);
    }

    // Draw sky gradient background
    final skyGradient = Paint()
      ..shader = ui.Gradient.linear(
        Offset(0, 0),
        Offset(0, size.height * 0.6),
        [const Color(0xFF1a1a2e), const Color(0xFF16213e)],
      );
    canvas.drawRect(Rect.fromLTWH(0, 0, size.width, size.height), skyGradient);

    // Draw ground plane
    _drawGround(canvas, size, project3D);

    // Scale factors with zoom
    double scaleF = 22.0 * zoomLevel;
    double l = length * scaleF / 2;
    double w = width * scaleF / 2;
    double h = height * scaleF / 2;
    double roofH = h * 0.6;
    double foundationH = h * 0.15;

    // Define 3D vertices - Foundation
    Offset f0 = project3D(-l - 3, h + foundationH, -w - 3);
    Offset f1 = project3D(l + 3, h + foundationH, -w - 3);
    Offset f2 = project3D(l + 3, h + foundationH, w + 3);
    Offset f3 = project3D(-l - 3, h + foundationH, w + 3);
    Offset f4 = project3D(-l - 3, h, -w - 3);
    Offset f5 = project3D(l + 3, h, -w - 3);
    Offset f6 = project3D(l + 3, h, w + 3);
    Offset f7 = project3D(-l - 3, h, w + 3);

    // Main building vertices
    Offset p0 = project3D(-l, h, -w);
    Offset p1 = project3D(l, h, -w);
    Offset p2 = project3D(l, h, w);
    Offset p3 = project3D(-l, h, w);
    Offset p4 = project3D(-l, -h, -w);
    Offset p5 = project3D(l, -h, -w);
    Offset p6 = project3D(l, -h, w);
    Offset p7 = project3D(-l, -h, w);

    // Roof peak
    Offset r0 = project3D(0, -h - roofH, -w - 5);
    Offset r1 = project3D(0, -h - roofH, w + 5);

    // Paints for realistic materials
    final foundationPaint = Paint()..color = const Color(0xFF4a4a4a)..style = PaintingStyle.fill;
    final foundationStroke = Paint()..color = const Color(0xFF333333)..style = PaintingStyle.stroke..strokeWidth = 1.0;
    
    // Wall paints with gradient effect
    final wallFrontLight = Paint()..color = const Color(0xFFE8DCC4)..style = PaintingStyle.fill;
    final wallSideLight = Paint()..color = const Color(0xFFD4C4A8)..style = PaintingStyle.fill;
    final wallSideDark = Paint()..color = const Color(0xFFB8A888)..style = PaintingStyle.fill;
    final wallBack = Paint()..color = const Color(0xFFA89878)..style = PaintingStyle.fill;
    
    final wallStroke = Paint()..color = const Color(0xFF8B7355)..style = PaintingStyle.stroke..strokeWidth = 1.2;
    
    // Roof paints - terracotta tiles look
    final roofMain = Paint()..color = const Color(0xFFB84C2C)..style = PaintingStyle.fill;
    final roofShadow = Paint()..color = const Color(0xFF8B3A22)..style = PaintingStyle.fill;
    final roofHighlight = Paint()..color = const Color(0xFFD45C3C)..style = PaintingStyle.fill;
    final roofStroke = Paint()..color = const Color(0xFF6B2A12)..style = PaintingStyle.stroke..strokeWidth = 1.5;

    // Draw foundation
    _drawFace(canvas, [f3, f2, f6, f7], foundationPaint, foundationStroke);
    _drawFace(canvas, [f0, f3, f7, f4], foundationPaint, foundationStroke);
    _drawFace(canvas, [f1, f2, f6, f5], foundationPaint, foundationStroke);
    _drawFace(canvas, [f0, f1, f5, f4], Paint()..color = const Color(0xFF5a5a5a)..style = PaintingStyle.fill, foundationStroke);
    _drawFace(canvas, [f4, f5, f6, f7], Paint()..color = const Color(0xFF3a3a3a)..style = PaintingStyle.fill, foundationStroke);

    // Draw walls with wood plank texture effect
    _drawWallWithTexture(canvas, [p3, p2, p6, p7], wallBack, wallStroke, false);
    _drawWallWithTexture(canvas, [p0, p3, p7, p4], wallSideDark, wallStroke, true);
    _drawWallWithTexture(canvas, [p1, p2, p6, p5], wallSideLight, wallStroke, true);
    _drawWallWithTexture(canvas, [p0, p1, p5, p4], wallFrontLight, wallStroke, true);

    // Draw roof with tile effect
    _drawRoofWithTiles(canvas, [p4, p5, r0], roofHighlight, roofStroke);
    _drawRoofWithTiles(canvas, [p7, p6, r1], roofMain, roofStroke);
    _drawRoofWithTiles(canvas, [p4, p7, r1, r0], roofShadow, roofStroke);
    _drawRoofWithTiles(canvas, [p5, p6, r1, r0], roofMain, roofStroke);

    // Draw roof ridge with cap
    final ridgePaint = Paint()..color = const Color(0xFF6B2A12)..style = PaintingStyle.stroke..strokeWidth = 4.0;
    canvas.drawLine(r0, r1, ridgePaint);
    final ridgeHighlight = Paint()..color = const Color(0xFFD45C3C)..style = PaintingStyle.stroke..strokeWidth = 2.0;
    canvas.drawLine(Offset(r0.dx, r0.dy - 1), Offset(r1.dx, r1.dy - 1), ridgeHighlight);

    // Draw main door with frame
    double doorW = l * 0.25;
    double doorH = h * 0.9;
    _drawDoor(canvas, project3D, l, w, h, doorW, doorH);

    // Draw windows with frames and details
    _drawWindow(canvas, project3D, l * 0.3, h * 0.15, h * 0.35, -w);
    _drawWindow(canvas, project3D, -l * 0.4, h * 0.15, h * 0.35, -w);

    // Draw ventilation openings
    _drawVentilation(canvas, project3D, l, w, h);

    // Draw chickens/animals near the building
    _drawAnimals(canvas, project3D, l, w, h);

    // Draw dimensions with better styling
    _drawDimensionLabels(canvas, size);
  }

  void _drawGround(Canvas canvas, Size size, Offset Function(double, double, double) project3D) {
    // Draw a simple ground plane
    final groundPaint = Paint()..color = const Color(0xFF2d4a2d)..style = PaintingStyle.fill;
    final groundBorder = Paint()..color = const Color(0xFF1a2e1a)..style = PaintingStyle.stroke..strokeWidth = 1.0;
    
    double groundSize = 150;
    Offset g0 = project3D(-groundSize, height * 25 / 2 + 5, -groundSize);
    Offset g1 = project3D(groundSize, height * 25 / 2 + 5, -groundSize);
    Offset g2 = project3D(groundSize, height * 25 / 2 + 5, groundSize);
    Offset g3 = project3D(-groundSize, height * 25 / 2 + 5, groundSize);
    
    _drawFace(canvas, [g0, g1, g2, g3], groundPaint, groundBorder);
    
    // Add some grass texture lines
    final grassPaint = Paint()..color = const Color(0xFF3d5a3d)..style = PaintingStyle.stroke..strokeWidth = 0.5;
    for (double i = -groundSize + 20; i < groundSize; i += 25) {
      Offset start = project3D(i, height * 25 / 2 + 5, -groundSize);
      Offset end = project3D(i, height * 25 / 2 + 5, groundSize);
      canvas.drawLine(start, end, grassPaint);
    }
  }

  void _drawWallWithTexture(Canvas canvas, List<Offset> points, Paint fill, Paint stroke, bool addPlanks) {
    if (points.length < 3) return;
    Path path = Path()..moveTo(points[0].dx, points[0].dy);
    for (int i = 1; i < points.length; i++) {
      path.lineTo(points[i].dx, points[i].dy);
    }
    path.close();
    canvas.drawPath(path, fill);
    
    // Add horizontal plank lines for wood effect
    if (addPlanks && points.length >= 4) {
      final plankPaint = Paint()
        ..color = fill.color.withValues(alpha: 0.3)
        ..style = PaintingStyle.stroke
        ..strokeWidth = 0.5;
      
      int numPlanks = 8;
      for (int i = 1; i < numPlanks; i++) {
        double t = i / numPlanks;
        Offset left = Offset(
          points[0].dx + (points[3].dx - points[0].dx) * t,
          points[0].dy + (points[3].dy - points[0].dy) * t,
        );
        Offset right = Offset(
          points[1].dx + (points[2].dx - points[1].dx) * t,
          points[1].dy + (points[2].dy - points[1].dy) * t,
        );
        canvas.drawLine(left, right, plankPaint);
      }
    }
    
    canvas.drawPath(path, stroke);
  }

  void _drawRoofWithTiles(Canvas canvas, List<Offset> points, Paint fill, Paint stroke) {
    if (points.length < 3) return;
    Path path = Path()..moveTo(points[0].dx, points[0].dy);
    for (int i = 1; i < points.length; i++) {
      path.lineTo(points[i].dx, points[i].dy);
    }
    path.close();
    canvas.drawPath(path, fill);
    
    // Add tile lines
    final tilePaint = Paint()
      ..color = const Color(0xFF5B2010)
      ..style = PaintingStyle.stroke
      ..strokeWidth = 0.5;
    
    if (points.length >= 3) {
      int numTiles = 6;
      for (int i = 1; i < numTiles; i++) {
        double t = i / numTiles;
        if (points.length == 3) {
          // Triangle roof face
          Offset p1 = Offset(
            points[0].dx + (points[2].dx - points[0].dx) * t,
            points[0].dy + (points[2].dy - points[0].dy) * t,
          );
          Offset p2 = Offset(
            points[1].dx + (points[2].dx - points[1].dx) * t,
            points[1].dy + (points[2].dy - points[1].dy) * t,
          );
          canvas.drawLine(p1, p2, tilePaint);
        }
      }
    }
    
    canvas.drawPath(path, stroke);
  }

  void _drawDoor(Canvas canvas, Offset Function(double, double, double) project3D, double l, double w, double h, double doorW, double doorH) {
    // Door frame
    Offset d0 = project3D(-l * 0.5 - doorW/2, h, -w - 0.5);
    Offset d1 = project3D(-l * 0.5 + doorW/2, h, -w - 0.5);
    Offset d2 = project3D(-l * 0.5 + doorW/2, h - doorH, -w - 0.5);
    Offset d3 = project3D(-l * 0.5 - doorW/2, h - doorH, -w - 0.5);
    
    // Door frame (dark brown)
    final framePaint = Paint()..color = const Color(0xFF3D2314)..style = PaintingStyle.fill;
    final frameStroke = Paint()..color = const Color(0xFF2A1A0F)..style = PaintingStyle.stroke..strokeWidth = 2.5;
    _drawFace(canvas, [d0, d1, d2, d3], framePaint, frameStroke);
    
    // Door inner (lighter brown wood)
    double inset = 3;
    Offset di0 = Offset(d0.dx + inset, d0.dy - inset/2);
    Offset di1 = Offset(d1.dx - inset, d1.dy - inset/2);
    Offset di2 = Offset(d2.dx - inset, d2.dy + inset);
    Offset di3 = Offset(d3.dx + inset, d3.dy + inset);
    
    final doorPaint = Paint()..color = const Color(0xFF8B5A2B)..style = PaintingStyle.fill;
    final doorStroke = Paint()..color = const Color(0xFF5D3A1A)..style = PaintingStyle.stroke..strokeWidth = 1.0;
    _drawFace(canvas, [di0, di1, di2, di3], doorPaint, doorStroke);
    
    // Door panels
    double panelW = (di1.dx - di0.dx) * 0.4;
    double panelH = (di0.dy - di2.dy) * 0.35;
    final panelPaint = Paint()..color = const Color(0xFF6B4423)..style = PaintingStyle.fill;
    
    // Top panels
    canvas.drawRect(Rect.fromLTWH(di0.dx + 5, di2.dy + 10, panelW, panelH), panelPaint);
    canvas.drawRect(Rect.fromLTWH(di1.dx - panelW - 5, di2.dy + 10, panelW, panelH), panelPaint);
    
    // Bottom panels
    canvas.drawRect(Rect.fromLTWH(di0.dx + 5, di0.dy - panelH - 10, panelW, panelH), panelPaint);
    canvas.drawRect(Rect.fromLTWH(di1.dx - panelW - 5, di0.dy - panelH - 10, panelW, panelH), panelPaint);
    
    // Door handle
    final handlePaint = Paint()..color = const Color(0xFFD4AF37)..style = PaintingStyle.fill;
    canvas.drawCircle(Offset(di1.dx - 12, (di0.dy + di2.dy) / 2), 4, handlePaint);
  }

  void _drawWindow(Canvas canvas, Offset Function(double, double, double) project3D, double x, double y, double windowSize, double z) {
    // Window frame
    Offset w0 = project3D(x - windowSize/2, y + windowSize/2, z - 0.5);
    Offset w1 = project3D(x + windowSize/2, y + windowSize/2, z - 0.5);
    Offset w2 = project3D(x + windowSize/2, y - windowSize/2, z - 0.5);
    Offset w3 = project3D(x - windowSize/2, y - windowSize/2, z - 0.5);
    
    // Window frame (white)
    final framePaint = Paint()..color = const Color(0xFFFFFFFF)..style = PaintingStyle.fill;
    final frameStroke = Paint()..color = const Color(0xFF8B7355)..style = PaintingStyle.stroke..strokeWidth = 3.0;
    _drawFace(canvas, [w0, w1, w2, w3], framePaint, frameStroke);
    
    // Glass (light blue with transparency effect)
    double inset = 4;
    final glassPaint = Paint()..color = const Color(0xFF87CEEB).withValues(alpha: 0.7)..style = PaintingStyle.fill;
    canvas.drawRect(
      Rect.fromLTRB(w0.dx + inset, w2.dy + inset, w1.dx - inset, w0.dy - inset),
      glassPaint,
    );
    
    // Window cross dividers
    final dividerPaint = Paint()..color = Colors.white..style = PaintingStyle.stroke..strokeWidth = 2.0;
    double centerX = (w0.dx + w1.dx) / 2;
    double centerY = (w0.dy + w2.dy) / 2;
    canvas.drawLine(Offset(centerX, w0.dy - 2), Offset(centerX, w2.dy + 2), dividerPaint);
    canvas.drawLine(Offset(w0.dx + 2, centerY), Offset(w1.dx - 2, centerY), dividerPaint);
    
    // Window reflection highlight
    final reflectionPaint = Paint()
      ..color = Colors.white.withValues(alpha: 0.3)
      ..style = PaintingStyle.fill;
    canvas.drawRect(
      Rect.fromLTRB(w0.dx + inset + 2, w2.dy + inset + 2, centerX - 2, centerY - 2),
      reflectionPaint,
    );
  }

  void _drawVentilation(Canvas canvas, Offset Function(double, double, double) project3D, double l, double w, double h) {
    // Side ventilation openings
    final ventPaint = Paint()..color = const Color(0xFF4A4A4A)..style = PaintingStyle.fill;
    final ventStroke = Paint()..color = const Color(0xFF333333)..style = PaintingStyle.stroke..strokeWidth = 1.0;
    
    // Draw ventilation slats on the side
    double ventY = -h * 0.3;
    double ventW = l * 0.3;
    double ventH = h * 0.15;
    
    for (int i = 0; i < 3; i++) {
      double offsetX = -l * 0.6 + i * ventW * 1.2;
      Offset v0 = project3D(offsetX, ventY, w + 0.5);
      Offset v1 = project3D(offsetX + ventW, ventY, w + 0.5);
      Offset v2 = project3D(offsetX + ventW, ventY - ventH, w + 0.5);
      Offset v3 = project3D(offsetX, ventY - ventH, w + 0.5);
      _drawFace(canvas, [v0, v1, v2, v3], ventPaint, ventStroke);
    }
  }

  void _drawAnimals(Canvas canvas, Offset Function(double, double, double) project3D, double l, double w, double h) {
    // Draw small chicken/animal icons near the building
    final chickenPaint = Paint()..color = const Color(0xFFFFFFFF)..style = PaintingStyle.fill;
    
    // Draw a few chickens
    List<List<double>> positions = [
      [l * 0.8, h + 5, -w * 0.5],
      [l * 1.2, h + 5, -w * 0.8],
      [-l * 1.0, h + 5, w * 0.3],
    ];
    
    for (var pos in positions) {
      Offset chickenPos = project3D(pos[0], pos[1], pos[2]);
      // Simple chicken shape
      canvas.drawCircle(chickenPos, 4, chickenPaint); // Body
      canvas.drawCircle(Offset(chickenPos.dx + 3, chickenPos.dy - 3), 2.5, chickenPaint); // Head
      
      // Beak
      final beakPaint = Paint()..color = const Color(0xFFFF6B00)..style = PaintingStyle.fill;
      canvas.drawCircle(Offset(chickenPos.dx + 5, chickenPos.dy - 3), 1, beakPaint);
      
      // Comb
      final combPaint = Paint()..color = const Color(0xFFFF0000)..style = PaintingStyle.fill;
      canvas.drawCircle(Offset(chickenPos.dx + 3, chickenPos.dy - 5), 1.5, combPaint);
    }
  }

  void _drawDimensionLabels(Canvas canvas, Size size) {
    final textPainter = TextPainter(textDirection: ui.TextDirection.ltr);

    // Main dimension text
    textPainter.text = TextSpan(
      text: '${length.toStringAsFixed(1)}m × ${width.toStringAsFixed(1)}m × ${height.toStringAsFixed(1)}m',
      style: const TextStyle(
        color: Colors.white,
        fontWeight: FontWeight.bold,
        fontSize: 15,
        shadows: [Shadow(color: Colors.black, blurRadius: 4)],
      ),
    );
    textPainter.layout();
    
    // Draw background for text
    final bgRect = RRect.fromRectAndRadius(
      Rect.fromLTWH(
        size.width / 2 - textPainter.width / 2 - 12,
        size.height - 38,
        textPainter.width + 24,
        28,
      ),
      const Radius.circular(14),
    );
    canvas.drawRRect(bgRect, Paint()..color = const Color(0xFF2C3E50).withValues(alpha: 0.9));
    
    textPainter.paint(canvas, Offset(size.width / 2 - textPainter.width / 2, size.height - 34));

    // Surface area
    double area = length * width;
    textPainter.text = TextSpan(
      text: 'Surface: ${area.toStringAsFixed(1)} m²',
      style: const TextStyle(color: Color(0xFF4CAF50), fontWeight: FontWeight.w600, fontSize: 12),
    );
    textPainter.layout();
    textPainter.paint(canvas, Offset(10, size.height - 25));
  }

  void _drawFace(Canvas canvas, List<Offset> points, Paint fill, Paint stroke) {
    if (points.length < 3) return;
    Path path = Path()..moveTo(points[0].dx, points[0].dy);
    for (int i = 1; i < points.length; i++) {
      path.lineTo(points[i].dx, points[i].dy);
    }
    path.close();
    canvas.drawPath(path, fill);
    canvas.drawPath(path, stroke);
  }

  @override
  bool shouldRepaint(covariant Coop3DPainter oldDelegate) {
    return oldDelegate.rotationX != rotationX || oldDelegate.rotationY != rotationY || oldDelegate.zoomLevel != zoomLevel;
  }
}

// 2D Floor Plan Painter - Realistic Architectural top-down view
class FloorPlan2DPainter extends CustomPainter {
  final double length;
  final double width;
  final String buildingType;
  final int animalCount;

  FloorPlan2DPainter({
    required this.length,
    required this.width,
    required this.buildingType,
    required this.animalCount,
  });

  @override
  void paint(Canvas canvas, Size size) {
    if (length == 0 || width == 0) return;

    final double padding = 35.0;
    final double availableWidth = size.width - 2 * padding - 20;
    final double availableHeight = size.height - 2 * padding - 45;
    
    double scaleX = availableWidth / length;
    double scaleY = availableHeight / width;
    double scale = scaleX < scaleY ? scaleX : scaleY;
    
    double drawWidth = length * scale;
    double drawHeight = width * scale;
    double offsetX = (size.width - drawWidth) / 2;
    double offsetY = padding + 5;

    // Draw paper/blueprint background
    _drawPaperBackground(canvas, size);
    
    // Draw shadow for building
    _drawBuildingShadow(canvas, offsetX, offsetY, drawWidth, drawHeight);
    
    // Draw concrete floor texture
    _drawConcreteFloor(canvas, offsetX, offsetY, drawWidth, drawHeight);
    
    // Draw main building walls with thickness
    _drawThickWalls(canvas, offsetX, offsetY, drawWidth, drawHeight);
    
    // Draw interior based on building type
    if (buildingType == 'Bitro' || buildingType == 'BitroVolavo') {
      _drawRabbitHutches(canvas, offsetX, offsetY, drawWidth, drawHeight, scale, Paint(), Paint());
    } else if (buildingType == 'Kisoa') {
      _drawPigPens(canvas, offsetX, offsetY, drawWidth, drawHeight, scale, Paint(), Paint());
    } else {
      _drawRealisticPoultryLayout(canvas, offsetX, offsetY, drawWidth, drawHeight, scale);
    }
    
    // Draw windows
    _drawWindows(canvas, offsetX, offsetY, drawWidth, drawHeight);
    
    // Draw doors with realistic detail
    _drawRealisticDoors(canvas, offsetX, offsetY, drawWidth, drawHeight);
    
    // Draw dimensions
    _drawProfessionalDimensions(canvas, offsetX, offsetY, drawWidth, drawHeight, length, width);
    
    // Draw legend
    _drawProfessionalLegend(canvas, size, buildingType);
    
    // Draw title block
    _drawTitleBlock(canvas, size, buildingType);
    
    // Draw north arrow and scale bar
    _drawNorthArrowAndScale(canvas, size, scale);
  }
  
  void _drawPaperBackground(Canvas canvas, Size size) {
    // Cream/off-white paper texture
    final paperGradient = Paint()
      ..shader = ui.Gradient.linear(
        Offset(0, 0),
        Offset(size.width, size.height),
        [const Color(0xFFFAF8F5), const Color(0xFFF5F0E8), const Color(0xFFFAF8F5)],
        [0.0, 0.5, 1.0],
      );
    canvas.drawRect(Rect.fromLTWH(0, 0, size.width, size.height), paperGradient);
    
    // Subtle grid lines (engineering paper)
    final gridPaint = Paint()
      ..color = const Color(0xFFE8E4DC)
      ..strokeWidth = 0.5;
    for (double x = 0; x < size.width; x += 20) {
      canvas.drawLine(Offset(x, 0), Offset(x, size.height), gridPaint);
    }
    for (double y = 0; y < size.height; y += 20) {
      canvas.drawLine(Offset(0, y), Offset(size.width, y), gridPaint);
    }
  }
  
  void _drawBuildingShadow(Canvas canvas, double x, double y, double w, double h) {
    final shadowPaint = Paint()
      ..color = Colors.black.withValues(alpha: 0.15)
      ..maskFilter = const MaskFilter.blur(BlurStyle.normal, 8);
    canvas.drawRect(Rect.fromLTWH(x + 6, y + 6, w, h), shadowPaint);
  }
  
  void _drawConcreteFloor(Canvas canvas, double x, double y, double w, double h) {
    // Base concrete color
    final concretePaint = Paint()..color = const Color(0xFFD0D0D0);
    canvas.drawRect(Rect.fromLTWH(x, y, w, h), concretePaint);
    
    // Concrete texture pattern
    final texturePaint = Paint()
      ..color = const Color(0xFFC8C8C8)
      ..strokeWidth = 0.5;
    
    // Random texture dots
    for (double tx = x; tx < x + w; tx += 8) {
      for (double ty = y; ty < y + h; ty += 8) {
        if ((tx.toInt() + ty.toInt()) % 3 == 0) {
          canvas.drawCircle(Offset(tx + 2, ty + 2), 0.8, texturePaint);
        }
      }
    }
    
    // Concrete joint lines
    final jointPaint = Paint()
      ..color = const Color(0xFFB0B0B0)
      ..strokeWidth = 1;
    
    double jointSpacing = w / 4;
    for (int i = 1; i < 4; i++) {
      canvas.drawLine(Offset(x + i * jointSpacing, y), Offset(x + i * jointSpacing, y + h), jointPaint);
    }
    jointSpacing = h / 3;
    for (int i = 1; i < 3; i++) {
      canvas.drawLine(Offset(x, y + i * jointSpacing), Offset(x + w, y + i * jointSpacing), jointPaint);
    }
  }
  
  void _drawThickWalls(Canvas canvas, double x, double y, double w, double h) {
    double wallThickness = 8;
    
    // Wall fill (brick/block texture effect)
    final wallFill = Paint()..color = const Color(0xFF8B7355);
    
    // Outer wall
    Path outerWall = Path()
      ..addRect(Rect.fromLTWH(x - wallThickness, y - wallThickness, w + 2 * wallThickness, h + 2 * wallThickness));
    Path innerCutout = Path()
      ..addRect(Rect.fromLTWH(x, y, w, h));
    
    Path wallPath = Path.combine(PathOperation.difference, outerWall, innerCutout);
    canvas.drawPath(wallPath, wallFill);
    
    // Wall outline
    final wallStroke = Paint()
      ..color = const Color(0xFF5C4033)
      ..strokeWidth = 2
      ..style = PaintingStyle.stroke;
    canvas.drawRect(Rect.fromLTWH(x - wallThickness, y - wallThickness, w + 2 * wallThickness, h + 2 * wallThickness), wallStroke);
    canvas.drawRect(Rect.fromLTWH(x, y, w, h), wallStroke);
    
    // Brick pattern on walls
    _drawBrickPattern(canvas, x - wallThickness, y - wallThickness, wallThickness, h + 2 * wallThickness); // Left
    _drawBrickPattern(canvas, x + w, y - wallThickness, wallThickness, h + 2 * wallThickness); // Right
  }
  
  void _drawBrickPattern(Canvas canvas, double x, double y, double w, double h) {
    final brickLine = Paint()
      ..color = const Color(0xFF6B5344)
      ..strokeWidth = 0.5;
    
    double brickHeight = 6;
    for (double by = y; by < y + h; by += brickHeight) {
      canvas.drawLine(Offset(x, by), Offset(x + w, by), brickLine);
    }
  }
  
  void _drawRealisticPoultryLayout(Canvas canvas, double x, double y, double w, double h, double scale) {
    int numRows = (width > 4) ? 4 : 2;
    double rowSpacing = h / (numRows + 1);
    
    for (int i = 1; i <= numRows; i++) {
      double rowY = y + i * rowSpacing;
      
      if (i % 2 == 1) {
        // Feeders (mangeoires) - realistic trough shape
        _drawFeederTrough(canvas, x + w * 0.08, rowY, w * 0.84);
      } else {
        // Water lines with nipples
        _drawWaterLine(canvas, x + w * 0.06, rowY, w * 0.88, scale);
      }
    }
    
    // Draw chickens/birds scattered
    _drawBirds(canvas, x, y, w, h, numRows, rowSpacing);
    
    // Ventilation fans
    _drawVentilationFans(canvas, x, y, w, h);
    
    // Heating/brooder areas for chicks
    if (buildingType == 'Chair') {
      _drawBrooderAreas(canvas, x, y, w, h);
    }
    
    // Perches for pondeuses
    if (buildingType == 'Pondeuse') {
      _drawPerches(canvas, x, y, w, h);
      _drawNestBoxes(canvas, x, y, w, h);
    }
  }
  
  void _drawFeederTrough(Canvas canvas, double x, double y, double length) {
    // 3D effect feeder trough
    final troughTop = Paint()..color = const Color(0xFFD4A574);
    
    // Shadow
    canvas.drawRect(Rect.fromLTWH(x + 2, y + 2, length, 8), Paint()..color = Colors.black.withValues(alpha: 0.2));
    
    // Trough body
    Path trough = Path()
      ..moveTo(x, y - 4)
      ..lineTo(x + length, y - 4)
      ..lineTo(x + length - 2, y + 4)
      ..lineTo(x + 2, y + 4)
      ..close();
    canvas.drawPath(trough, troughTop);
    canvas.drawPath(trough, Paint()..color = const Color(0xFF6B4423)..style = PaintingStyle.stroke..strokeWidth = 1);
    
    // Feed inside (golden grain color)
    Path feed = Path()
      ..moveTo(x + 3, y - 2)
      ..lineTo(x + length - 3, y - 2)
      ..lineTo(x + length - 4, y + 2)
      ..lineTo(x + 4, y + 2)
      ..close();
    canvas.drawPath(feed, Paint()..color = const Color(0xFFDAA520));
    
    // Supports
    final supportPaint = Paint()..color = const Color(0xFF8B7355);
    for (double sx = x + 15; sx < x + length - 10; sx += 30) {
      canvas.drawRect(Rect.fromLTWH(sx, y + 4, 4, 3), supportPaint);
    }
  }
  
  void _drawWaterLine(Canvas canvas, double x, double y, double length, double scale) {
    // PVC pipe water line
    final pipePaint = Paint()..color = const Color(0xFF4A90D9);
    final pipeHighlight = Paint()..color = const Color(0xFF6BA8E5);
    final pipeShadow = Paint()..color = const Color(0xFF3A7AC9);
    
    // Main pipe with 3D effect
    canvas.drawLine(Offset(x, y), Offset(x + length, y), pipeShadow..strokeWidth = 5);
    canvas.drawLine(Offset(x, y - 1), Offset(x + length, y - 1), pipePaint..strokeWidth = 3);
    canvas.drawLine(Offset(x, y - 2), Offset(x + length, y - 2), pipeHighlight..strokeWidth = 1);
    
    // Nipple drinkers
    int numNipples = (length / 15).floor();
    for (int j = 0; j <= numNipples; j++) {
      double nippleX = x + length * j / numNipples;
      // Nipple body
      canvas.drawCircle(Offset(nippleX, y + 3), 4, Paint()..color = const Color(0xFFE0E0E0));
      canvas.drawCircle(Offset(nippleX, y + 3), 4, Paint()..color = Colors.grey..style = PaintingStyle.stroke..strokeWidth = 0.5);
      // Water drop
      canvas.drawCircle(Offset(nippleX, y + 8), 2, Paint()..color = const Color(0xFF87CEEB));
    }
  }
  
  void _drawBirds(Canvas canvas, double x, double y, double w, double h, int numRows, double rowSpacing) {
    // Draw stylized chickens
    final birdBody = Paint()..color = const Color(0xFFFFFFFF);
    final birdOutline = Paint()..color = const Color(0xFF8B4513)..style = PaintingStyle.stroke..strokeWidth = 0.8;
    final birdBeak = Paint()..color = const Color(0xFFFF8C00);
    
    int birdsPerRow = (animalCount / numRows).ceil().clamp(3, 12);
    
    for (int row = 0; row < numRows; row++) {
      double rowY = y + (row + 0.5) * rowSpacing + rowSpacing / 2;
      for (int b = 0; b < birdsPerRow; b++) {
        double birdX = x + w * 0.1 + (w * 0.8) * (b + 0.5) / birdsPerRow;
        double offsetBirdY = rowY + (b % 2 == 0 ? -5 : 5);
        
        // Bird body (oval)
        canvas.drawOval(Rect.fromCenter(center: Offset(birdX, offsetBirdY), width: 8, height: 6), birdBody);
        canvas.drawOval(Rect.fromCenter(center: Offset(birdX, offsetBirdY), width: 8, height: 6), birdOutline);
        // Head
        canvas.drawCircle(Offset(birdX + 3, offsetBirdY - 2), 2.5, birdBody);
        canvas.drawCircle(Offset(birdX + 3, offsetBirdY - 2), 2.5, birdOutline);
        // Beak
        canvas.drawCircle(Offset(birdX + 5, offsetBirdY - 2), 1, birdBeak);
      }
    }
  }
  
  void _drawVentilationFans(Canvas canvas, double x, double y, double w, double h) {
    final fanHousing = Paint()..color = const Color(0xFF607D8B);
    final fanBlade = Paint()..color = const Color(0xFF90A4AE);
    
    // Fans on side walls
    int numFans = (length / 4).floor().clamp(2, 6);
    for (int i = 0; i < numFans; i++) {
      double fanX = x + w * (i + 0.5) / numFans;
      // Top wall fan
      canvas.drawCircle(Offset(fanX, y - 4), 8, fanHousing);
      canvas.drawCircle(Offset(fanX, y - 4), 6, fanBlade);
      // Fan blades
      for (int b = 0; b < 4; b++) {
        double angle = b * 1.5708;
        canvas.drawLine(
          Offset(fanX, y - 4),
          Offset(fanX + 5 * cos(angle), y - 4 + 5 * sin(angle)),
          Paint()..color = const Color(0xFF455A64)..strokeWidth = 2
        );
      }
    }
  }
  
  void _drawBrooderAreas(Canvas canvas, double x, double y, double w, double h) {
    // Heated brooder circles
    final brooderGradient = Paint()
      ..shader = ui.Gradient.radial(
        Offset(x + w * 0.25, y + h * 0.25),
        30,
        [const Color(0xFFFF6B35), const Color(0xFFFF8C5A), Colors.transparent],
        [0.0, 0.5, 1.0],
      );
    canvas.drawCircle(Offset(x + w * 0.25, y + h * 0.25), 25, brooderGradient);
    canvas.drawCircle(Offset(x + w * 0.75, y + h * 0.25), 25, brooderGradient);
    
    // Brooder lamp symbol
    canvas.drawCircle(Offset(x + w * 0.25, y + h * 0.25), 5, Paint()..color = const Color(0xFFFF4500));
    canvas.drawCircle(Offset(x + w * 0.75, y + h * 0.25), 5, Paint()..color = const Color(0xFFFF4500));
  }
  
  void _drawPerches(Canvas canvas, double x, double y, double w, double h) {
    final perchPaint = Paint()..color = const Color(0xFF8B4513)..strokeWidth = 3..strokeCap = StrokeCap.round;
    
    // Horizontal perches
    for (int i = 1; i <= 3; i++) {
      double perchY = y + h * 0.7 + i * 8;
      canvas.drawLine(Offset(x + w * 0.6, perchY), Offset(x + w * 0.95, perchY), perchPaint);
    }
  }
  
  void _drawNestBoxes(Canvas canvas, double x, double y, double w, double h) {
    int numNests = (animalCount / 5).ceil().clamp(2, 8);
    double nestWidth = 15;
    double nestHeight = 12;
    double startX = x + 5;
    
    for (int i = 0; i < numNests; i++) {
      double nestX = startX + i * (nestWidth + 3);
      double nestY = y + 5;
      
      // Nest box (wooden look)
      canvas.drawRect(Rect.fromLTWH(nestX, nestY, nestWidth, nestHeight), Paint()..color = const Color(0xFFDEB887));
      canvas.drawRect(Rect.fromLTWH(nestX, nestY, nestWidth, nestHeight), Paint()..color = const Color(0xFF8B4513)..style = PaintingStyle.stroke..strokeWidth = 1);
      // Hay inside
      canvas.drawOval(Rect.fromLTWH(nestX + 2, nestY + 2, nestWidth - 4, nestHeight - 4), Paint()..color = const Color(0xFFDAA520));
      // Egg
      canvas.drawOval(Rect.fromCenter(center: Offset(nestX + nestWidth/2, nestY + nestHeight/2), width: 5, height: 6), Paint()..color = const Color(0xFFFFFAF0));
    }
  }
  
  void _drawWindows(Canvas canvas, double x, double y, double w, double h) {
    double windowWidth = 12;
    double windowHeight = 8;
    int numWindows = (length / 3).floor().clamp(2, 6);
    
    final windowFrame = Paint()..color = const Color(0xFF5C4033)..strokeWidth = 2..style = PaintingStyle.stroke;
    final windowGlass = Paint()..color = const Color(0xFFADD8E6).withValues(alpha: 0.6);
    final windowReflect = Paint()..color = Colors.white.withValues(alpha: 0.4);
    
    for (int i = 0; i < numWindows; i++) {
      double windowX = x + w * (i + 0.5) / numWindows - windowWidth / 2;
      
      // Window on top wall
      Rect win = Rect.fromLTWH(windowX, y - 12, windowWidth, windowHeight);
      canvas.drawRect(win, windowGlass);
      canvas.drawRect(win, windowFrame);
      // Cross divider
      canvas.drawLine(Offset(win.center.dx, win.top), Offset(win.center.dx, win.bottom), windowFrame..strokeWidth = 1);
      canvas.drawLine(Offset(win.left, win.center.dy), Offset(win.right, win.center.dy), windowFrame..strokeWidth = 1);
      // Reflection
      canvas.drawLine(Offset(win.left + 2, win.top + 2), Offset(win.left + 4, win.top + 4), windowReflect..strokeWidth = 2);
    }
  }
  
  void _drawRealisticDoors(Canvas canvas, double x, double y, double w, double h) {
    double doorWidth = w * 0.12;
    double doorHeight = 12;
    double doorX = x + w / 2 - doorWidth / 2;
    
    // Door shadow
    canvas.drawRect(Rect.fromLTWH(doorX + 2, y + h - 2, doorWidth, doorHeight + 2), Paint()..color = Colors.black.withValues(alpha: 0.3));
    
    // Door frame
    canvas.drawRect(Rect.fromLTWH(doorX - 2, y + h - 2, doorWidth + 4, doorHeight + 4), Paint()..color = const Color(0xFF5C4033));
    
    // Door body
    final doorGradient = Paint()
      ..shader = ui.Gradient.linear(
        Offset(doorX, 0),
        Offset(doorX + doorWidth, 0),
        [const Color(0xFFDEB887), const Color(0xFFD2691E), const Color(0xFFDEB887)],
      );
    canvas.drawRect(Rect.fromLTWH(doorX, y + h, doorWidth, doorHeight), doorGradient);
    canvas.drawRect(Rect.fromLTWH(doorX, y + h, doorWidth, doorHeight), Paint()..color = const Color(0xFF5C4033)..style = PaintingStyle.stroke..strokeWidth = 1.5);
    
    // Door panels
    double panelMargin = 2;
    canvas.drawRect(Rect.fromLTWH(doorX + panelMargin, y + h + panelMargin, doorWidth/2 - panelMargin*1.5, doorHeight/2 - panelMargin), 
      Paint()..color = const Color(0xFFC4A56C)..style = PaintingStyle.stroke..strokeWidth = 1);
    canvas.drawRect(Rect.fromLTWH(doorX + doorWidth/2 + panelMargin/2, y + h + panelMargin, doorWidth/2 - panelMargin*1.5, doorHeight/2 - panelMargin), 
      Paint()..color = const Color(0xFFC4A56C)..style = PaintingStyle.stroke..strokeWidth = 1);
    
    // Door handle
    canvas.drawCircle(Offset(doorX + doorWidth - 4, y + h + doorHeight/2), 2, Paint()..color = const Color(0xFFB8860B));
    
    // Door swing arc
    Path arc = Path()
      ..moveTo(doorX + doorWidth, y + h + doorHeight)
      ..arcToPoint(
        Offset(doorX + doorWidth + doorWidth, y + h + doorHeight - doorWidth),
        radius: Radius.circular(doorWidth),
        clockwise: false,
      );
    canvas.drawPath(arc, Paint()..color = Colors.black54..style = PaintingStyle.stroke..strokeWidth = 1);
  }
  
  void _drawProfessionalDimensions(Canvas canvas, double x, double y, double w, double h, double realL, double realW) {
    final dimPaint = Paint()..color = const Color(0xFF1565C0)..strokeWidth = 1;
    final arrowPaint = Paint()..color = const Color(0xFF1565C0)..style = PaintingStyle.fill;
    
    // Length dimension (bottom)
    double dimY = y + h + 20;
    // Extension lines
    canvas.drawLine(Offset(x, y + h + 2), Offset(x, dimY + 5), dimPaint..strokeWidth = 0.5);
    canvas.drawLine(Offset(x + w, y + h + 2), Offset(x + w, dimY + 5), dimPaint..strokeWidth = 0.5);
    // Dimension line
    canvas.drawLine(Offset(x + 8, dimY), Offset(x + w - 8, dimY), dimPaint..strokeWidth = 1);
    // Arrows
    _drawArrowHead(canvas, Offset(x, dimY), true, arrowPaint);
    _drawArrowHead(canvas, Offset(x + w, dimY), false, arrowPaint);
    
    // Label with box
    String lengthText = '${realL.toStringAsFixed(2)} m';
    final lengthLabel = TextPainter(
      text: TextSpan(text: lengthText, style: TextStyle(color: const Color(0xFF1565C0), fontSize: 10, fontWeight: FontWeight.bold)),
      textDirection: ui.TextDirection.ltr,
    );
    lengthLabel.layout();
    double labelX = x + w / 2 - lengthLabel.width / 2;
    canvas.drawRect(Rect.fromLTWH(labelX - 3, dimY - 6, lengthLabel.width + 6, 12), Paint()..color = Colors.white);
    lengthLabel.paint(canvas, Offset(labelX, dimY - 5));
    
    // Width dimension (right)
    double dimX = x + w + 20;
    canvas.drawLine(Offset(x + w + 2, y), Offset(dimX + 5, y), dimPaint..strokeWidth = 0.5);
    canvas.drawLine(Offset(x + w + 2, y + h), Offset(dimX + 5, y + h), dimPaint..strokeWidth = 0.5);
    canvas.drawLine(Offset(dimX, y + 8), Offset(dimX, y + h - 8), dimPaint..strokeWidth = 1);
    _drawArrowHead(canvas, Offset(dimX, y), true, arrowPaint, vertical: true);
    _drawArrowHead(canvas, Offset(dimX, y + h), false, arrowPaint, vertical: true);
    
    String widthText = '${realW.toStringAsFixed(2)} m';
    final widthLabel = TextPainter(
      text: TextSpan(text: widthText, style: TextStyle(color: const Color(0xFF1565C0), fontSize: 10, fontWeight: FontWeight.bold)),
      textDirection: ui.TextDirection.ltr,
    );
    widthLabel.layout();
    canvas.save();
    canvas.translate(dimX + 5, y + h / 2);
    canvas.rotate(-1.5708);
    canvas.drawRect(Rect.fromLTWH(-widthLabel.width/2 - 3, -6, widthLabel.width + 6, 12), Paint()..color = Colors.white);
    widthLabel.paint(canvas, Offset(-widthLabel.width / 2, -5));
    canvas.restore();
    
    // Surface area
    double area = realL * realW;
    final areaLabel = TextPainter(
      text: TextSpan(text: 'S = ${area.toStringAsFixed(1)} m²', style: TextStyle(color: Colors.green.shade700, fontSize: 11, fontWeight: FontWeight.bold)),
      textDirection: ui.TextDirection.ltr,
    );
    areaLabel.layout();
    canvas.drawRect(Rect.fromLTWH(x + w/2 - areaLabel.width/2 - 4, y + h/2 - 8, areaLabel.width + 8, 16), Paint()..color = Colors.white.withValues(alpha: 0.9));
    canvas.drawRect(Rect.fromLTWH(x + w/2 - areaLabel.width/2 - 4, y + h/2 - 8, areaLabel.width + 8, 16), Paint()..color = Colors.green.shade700..style = PaintingStyle.stroke..strokeWidth = 1);
    areaLabel.paint(canvas, Offset(x + w/2 - areaLabel.width/2, y + h/2 - 6));
  }
  
  void _drawArrowHead(Canvas canvas, Offset point, bool leftOrUp, Paint paint, {bool vertical = false}) {
    Path arrow = Path();
    if (vertical) {
      if (leftOrUp) {
        arrow..moveTo(point.dx, point.dy)..lineTo(point.dx - 4, point.dy + 8)..lineTo(point.dx + 4, point.dy + 8)..close();
      } else {
        arrow..moveTo(point.dx, point.dy)..lineTo(point.dx - 4, point.dy - 8)..lineTo(point.dx + 4, point.dy - 8)..close();
      }
    } else {
      if (leftOrUp) {
        arrow..moveTo(point.dx, point.dy)..lineTo(point.dx + 8, point.dy - 4)..lineTo(point.dx + 8, point.dy + 4)..close();
      } else {
        arrow..moveTo(point.dx, point.dy)..lineTo(point.dx - 8, point.dy - 4)..lineTo(point.dx - 8, point.dy + 4)..close();
      }
    }
    canvas.drawPath(arrow, paint);
  }
  
  void _drawProfessionalLegend(Canvas canvas, Size size, String type) {
    double legendY = size.height - 28;
    double legendX = 10;
    
    // Legend background
    canvas.drawRRect(RRect.fromRectAndRadius(Rect.fromLTWH(legendX - 5, legendY - 5, size.width - 20, 25), Radius.circular(4)), 
      Paint()..color = Colors.white.withValues(alpha: 0.95));
    canvas.drawRRect(RRect.fromRectAndRadius(Rect.fromLTWH(legendX - 5, legendY - 5, size.width - 20, 25), Radius.circular(4)), 
      Paint()..color = Colors.grey.shade400..style = PaintingStyle.stroke..strokeWidth = 0.5);
    
    List<Map<String, dynamic>> items = [];
    if (type == 'Bitro' || type == 'BitroVolavo') {
      items = [
        {'color': Colors.grey.shade100, 'label': 'Cage'},
        {'color': Colors.green.shade600, 'label': 'Sakafo'},
        {'color': Colors.grey.shade200, 'label': 'Lalana'},
      ];
    } else if (type == 'Pondeuse') {
      items = [
        {'color': const Color(0xFFD4A574), 'label': 'Mangeoire'},
        {'color': const Color(0xFF4A90D9), 'label': 'Rano'},
        {'color': const Color(0xFFDEB887), 'label': 'Akany'},
        {'color': const Color(0xFF8B4513), 'label': 'Perchoir'},
      ];
    } else {
      items = [
        {'color': const Color(0xFFD4A574), 'label': 'Mangeoire'},
        {'color': const Color(0xFF4A90D9), 'label': 'Rano'},
        {'color': const Color(0xFFFF6B35), 'label': 'Hafanana'},
        {'color': const Color(0xFF607D8B), 'label': 'Rivotra'},
      ];
    }
    
    double itemWidth = (size.width - 30) / items.length;
    for (int i = 0; i < items.length; i++) {
      // Color box with border
      canvas.drawRect(Rect.fromLTWH(legendX + i * itemWidth, legendY, 12, 12), Paint()..color = items[i]['color']);
      canvas.drawRect(Rect.fromLTWH(legendX + i * itemWidth, legendY, 12, 12), Paint()..color = Colors.black54..strokeWidth = 0.5..style = PaintingStyle.stroke);
      
      // Label
      final label = TextPainter(
        text: TextSpan(text: items[i]['label'], style: TextStyle(color: Colors.black87, fontSize: 9)),
        textDirection: ui.TextDirection.ltr,
      );
      label.layout();
      label.paint(canvas, Offset(legendX + i * itemWidth + 15, legendY));
    }
  }
  
  void _drawTitleBlock(Canvas canvas, Size size, String type) {
    String title = 'PLAN POULAILLER';
    if (type == 'Pondeuse') {
      title = 'PLAN POULAILLER PONDEUSE';
    } else if (type == 'Gasy') {
      title = 'PLAN POULAILLER GASY';
    } else if (type == 'Chair') {
      title = 'PLAN POULAILLER CHAIR';
    } else if (type == 'Bitro') {
      title = 'PLAN CLAPIER';
    }
    
    // Title block background
    canvas.drawRect(Rect.fromLTWH(5, 2, size.width - 10, 18), Paint()..color = const Color(0xFF2E7D32));
    
    final titlePainter = TextPainter(
      text: TextSpan(
        text: title,
        style: TextStyle(color: Colors.white, fontSize: 11, fontWeight: FontWeight.bold, letterSpacing: 1.5),
      ),
      textDirection: ui.TextDirection.ltr,
    );
    titlePainter.layout();
    titlePainter.paint(canvas, Offset(size.width / 2 - titlePainter.width / 2, 5));
  }
  
  void _drawNorthArrowAndScale(Canvas canvas, Size size, double scale) {
    // North arrow
    double arrowX = size.width - 25;
    double arrowY = 35;
    
    // Arrow background circle
    canvas.drawCircle(Offset(arrowX, arrowY), 12, Paint()..color = Colors.white);
    canvas.drawCircle(Offset(arrowX, arrowY), 12, Paint()..color = Colors.black..style = PaintingStyle.stroke..strokeWidth = 1);
    
    Path arrow = Path()
      ..moveTo(arrowX, arrowY - 10)
      ..lineTo(arrowX - 5, arrowY + 5)
      ..lineTo(arrowX, arrowY + 2)
      ..lineTo(arrowX + 5, arrowY + 5)
      ..close();
    canvas.drawPath(arrow, Paint()..color = Colors.black);
    
    final nLabel = TextPainter(
      text: TextSpan(text: 'N', style: TextStyle(color: Colors.black, fontSize: 8, fontWeight: FontWeight.bold)),
      textDirection: ui.TextDirection.ltr,
    );
    nLabel.layout();
    nLabel.paint(canvas, Offset(arrowX - 3, arrowY + 6));
    
    // Scale bar
    double scaleBarX = 15;
    double scaleBarY = 35;
    double scaleLength = 50;
    double realLength = scaleLength / scale;
    
    canvas.drawRect(Rect.fromLTWH(scaleBarX, scaleBarY, scaleLength/2, 4), Paint()..color = Colors.black);
    canvas.drawRect(Rect.fromLTWH(scaleBarX + scaleLength/2, scaleBarY, scaleLength/2, 4), Paint()..color = Colors.white);
    canvas.drawRect(Rect.fromLTWH(scaleBarX, scaleBarY, scaleLength, 4), Paint()..color = Colors.black..style = PaintingStyle.stroke..strokeWidth = 1);
    
    final scaleLabel = TextPainter(
      text: TextSpan(text: '${realLength.toStringAsFixed(1)} m', style: TextStyle(color: Colors.black, fontSize: 8)),
      textDirection: ui.TextDirection.ltr,
    );
    scaleLabel.layout();
    scaleLabel.paint(canvas, Offset(scaleBarX + scaleLength/2 - scaleLabel.width/2, scaleBarY + 6));
  }
  
  void _drawPigPens(Canvas canvas, double x, double y, double w, double h, double scale, Paint linePaint, Paint fillPaint) {
    // Porcherie: enclos séparés par un couloir central
    double corridorWidth = w * 0.15;
    double corridorX = x + (w - corridorWidth) / 2;
    
    // Draw central corridor
    final corridorPaint = Paint()
      ..color = Colors.grey.shade300
      ..style = PaintingStyle.fill;
    canvas.drawRect(Rect.fromLTWH(corridorX, y, corridorWidth, h), corridorPaint);
    canvas.drawRect(Rect.fromLTWH(corridorX, y, corridorWidth, h), linePaint);
    
    // Draw pens on each side
    int numPensPerSide = (width > 6) ? 4 : 3;
    double penHeight = h / numPensPerSide;
    double leftPenWidth = (w - corridorWidth) / 2;
    
    final penFill = Paint()..color = Colors.amber.shade100;
    
    for (int i = 0; i < numPensPerSide; i++) {
      double penY = y + i * penHeight;
      
      // Left pen
      Rect leftPen = Rect.fromLTWH(x, penY, leftPenWidth, penHeight);
      canvas.drawRect(leftPen, penFill);
      canvas.drawRect(leftPen, linePaint);
      
      // Right pen
      Rect rightPen = Rect.fromLTWH(corridorX + corridorWidth, penY, leftPenWidth, penHeight);
      canvas.drawRect(rightPen, penFill);
      canvas.drawRect(rightPen, linePaint);
      
      // Feeder in each pen (at the corridor side)
      final feederPaint = Paint()..color = Colors.brown.shade400..style = PaintingStyle.fill;
      canvas.drawRect(Rect.fromLTWH(corridorX - 8, penY + penHeight * 0.3, 8, penHeight * 0.4), feederPaint);
      canvas.drawRect(Rect.fromLTWH(corridorX + corridorWidth, penY + penHeight * 0.3, 8, penHeight * 0.4), feederPaint);
      
      // Water point
      canvas.drawCircle(Offset(x + leftPenWidth * 0.8, penY + penHeight * 0.2), 4, Paint()..color = Colors.blue);
      canvas.drawCircle(Offset(corridorX + corridorWidth + leftPenWidth * 0.2, penY + penHeight * 0.2), 4, Paint()..color = Colors.blue);
    }
    
    // Corridor markings
    for (int i = 1; i < numPensPerSide; i++) {
      double markY = y + i * penHeight;
      canvas.drawLine(Offset(corridorX + 5, markY), Offset(corridorX + corridorWidth - 5, markY), 
        Paint()..color = Colors.grey.shade500..strokeWidth = 1);
    }
  }
  
  void _drawRabbitHutches(Canvas canvas, double x, double y, double w, double h, double scale, Paint linePaint, Paint fillPaint) {
    // Clapier: rangées de cages/hutches alignées
    int numRows = 3;
    int cagesPerRow = (length / 0.8).floor().clamp(4, 12);
    double rowHeight = h / (numRows + 1);
    double cageWidth = w * 0.85 / cagesPerRow;
    double cageHeight = rowHeight * 0.7;
    double startX = x + w * 0.075;
    
    final cageFill = Paint()..color = Colors.grey.shade100;
    final cageStroke = Paint()
      ..color = Colors.black87
      ..strokeWidth = 1.5
      ..style = PaintingStyle.stroke;
    final meshPaint = Paint()
      ..color = Colors.grey.shade400
      ..strokeWidth = 0.5;
    
    for (int row = 0; row < numRows; row++) {
      double rowY = y + (row + 0.5) * rowHeight;
      
      for (int col = 0; col < cagesPerRow; col++) {
        double cageX = startX + col * cageWidth;
        Rect cage = Rect.fromLTWH(cageX + 2, rowY, cageWidth - 4, cageHeight);
        
        // Draw cage
        canvas.drawRect(cage, cageFill);
        canvas.drawRect(cage, cageStroke);
        
        // Draw mesh pattern
        for (int i = 1; i < 3; i++) {
          canvas.drawLine(
            Offset(cage.left + cage.width * i / 3, cage.top),
            Offset(cage.left + cage.width * i / 3, cage.bottom),
            meshPaint
          );
        }
        for (int i = 1; i < 2; i++) {
          canvas.drawLine(
            Offset(cage.left, cage.top + cage.height * i / 2),
            Offset(cage.right, cage.top + cage.height * i / 2),
            meshPaint
          );
        }
        
        // Feeder/water corner
        canvas.drawCircle(Offset(cage.right - 5, cage.top + 5), 3, Paint()..color = Colors.green.shade600);
      }
      
      // Row label
      final rowLabel = TextPainter(
        text: TextSpan(text: 'R${row + 1}', style: TextStyle(color: Colors.black54, fontSize: 8)),
        textDirection: ui.TextDirection.ltr,
      );
      rowLabel.layout();
      rowLabel.paint(canvas, Offset(x + 5, rowY + cageHeight / 2 - 4));
    }
    
    // Service aisle
    final aislePaint = Paint()..color = Colors.grey.shade200;
    canvas.drawRect(Rect.fromLTWH(x, y + h - rowHeight * 0.4, w, rowHeight * 0.4), aislePaint);
    canvas.drawLine(Offset(x, y + h - rowHeight * 0.4), Offset(x + w, y + h - rowHeight * 0.4), linePaint);
  }

  @override
  bool shouldRepaint(covariant FloorPlan2DPainter oldDelegate) {
    return oldDelegate.length != length || oldDelegate.width != width || oldDelegate.buildingType != buildingType;
  }
}

// Piggery Floor Plan Painter - Realistic architectural style
class PiggeryFloorPlanPainter extends CustomPainter {
  final double area;
  final String pigType;
  final int pigCount;

  PiggeryFloorPlanPainter({
    required this.area,
    required this.pigType,
    required this.pigCount,
  });

  @override
  void paint(Canvas canvas, Size size) {
    if (area == 0 || pigCount == 0) return;

    final double padding = 35.0;
    
    // Calculate building dimensions based on area
    double buildingWidth = 8.0;
    double buildingLength = area / buildingWidth;
    if (buildingLength < 6) buildingLength = 6;
    
    final double availableWidth = size.width - 2 * padding - 20;
    final double availableHeight = size.height - 2 * padding - 45;
    
    double scaleX = availableWidth / buildingLength;
    double scaleY = availableHeight / buildingWidth;
    double scale = scaleX < scaleY ? scaleX : scaleY;
    
    double drawLength = buildingLength * scale;
    double drawWidth = buildingWidth * scale;
    double offsetX = (size.width - drawLength) / 2;
    double offsetY = padding + 5;

    // Draw realistic background
    _drawPaperBackground(canvas, size);
    
    // Draw building shadow
    _drawBuildingShadow(canvas, offsetX, offsetY, drawLength, drawWidth);
    
    // Draw concrete floor
    _drawConcreteFloor(canvas, offsetX, offsetY, drawLength, drawWidth);
    
    // Draw thick walls
    _drawThickWalls(canvas, offsetX, offsetY, drawLength, drawWidth);
    
    // Draw interior based on pig type
    if (pigType.contains('Renin-kisoa') || pigType.contains('Truie')) {
      _drawRealisticFarrowingPens(canvas, offsetX, offsetY, drawLength, drawWidth, scale, pigCount);
    } else if (pigType.contains('Kely') || pigType.contains('Post-sevrage')) {
      _drawRealisticNurseryPens(canvas, offsetX, offsetY, drawLength, drawWidth, scale, pigCount);
    } else if (pigType.contains('Lahy') || pigType.contains('Verrat')) {
      _drawRealisticBoarPens(canvas, offsetX, offsetY, drawLength, drawWidth, scale, pigCount);
    } else {
      _drawRealisticFatteningPens(canvas, offsetX, offsetY, drawLength, drawWidth, scale, pigCount);
    }
    
    // Draw doors
    _drawRealisticDoors(canvas, offsetX, offsetY, drawLength, drawWidth);
    
    // Draw dimensions
    _drawProfessionalDimensions(canvas, offsetX, offsetY, drawLength, drawWidth, buildingLength, buildingWidth);
    
    // Draw legend
    _drawProfessionalLegend(canvas, size, pigType);
    
    // Draw title
    _drawTitleBlock(canvas, size, pigType);
    
    // Draw north arrow and scale
    _drawNorthArrowAndScale(canvas, size, scale);
  }
  
  void _drawPaperBackground(Canvas canvas, Size size) {
    final paperGradient = Paint()
      ..shader = ui.Gradient.linear(
        Offset(0, 0),
        Offset(size.width, size.height),
        [const Color(0xFFFAF8F5), const Color(0xFFF5F0E8), const Color(0xFFFAF8F5)],
        [0.0, 0.5, 1.0],
      );
    canvas.drawRect(Rect.fromLTWH(0, 0, size.width, size.height), paperGradient);
    
    final gridPaint = Paint()..color = const Color(0xFFE8E4DC)..strokeWidth = 0.5;
    for (double x = 0; x < size.width; x += 20) {
      canvas.drawLine(Offset(x, 0), Offset(x, size.height), gridPaint);
    }
    for (double y = 0; y < size.height; y += 20) {
      canvas.drawLine(Offset(0, y), Offset(size.width, y), gridPaint);
    }
  }
  
  void _drawBuildingShadow(Canvas canvas, double x, double y, double w, double h) {
    final shadowPaint = Paint()
      ..color = Colors.black.withValues(alpha: 0.15)
      ..maskFilter = const MaskFilter.blur(BlurStyle.normal, 8);
    canvas.drawRect(Rect.fromLTWH(x + 6, y + 6, w, h), shadowPaint);
  }
  
  void _drawConcreteFloor(Canvas canvas, double x, double y, double w, double h) {
    final concretePaint = Paint()..color = const Color(0xFFB8B8B8);
    canvas.drawRect(Rect.fromLTWH(x, y, w, h), concretePaint);
    
    // Texture
    final texturePaint = Paint()..color = const Color(0xFFA8A8A8)..strokeWidth = 0.3;
    for (double tx = x; tx < x + w; tx += 12) {
      for (double ty = y; ty < y + h; ty += 12) {
        if ((tx.toInt() + ty.toInt()) % 3 == 0) {
          canvas.drawCircle(Offset(tx, ty), 1, texturePaint);
        }
      }
    }
  }
  
  void _drawThickWalls(Canvas canvas, double x, double y, double w, double h) {
    double wallThickness = 8;
    final wallFill = Paint()..color = const Color(0xFF8B4513);
    
    Path outerWall = Path()..addRect(Rect.fromLTWH(x - wallThickness, y - wallThickness, w + 2 * wallThickness, h + 2 * wallThickness));
    Path innerCutout = Path()..addRect(Rect.fromLTWH(x, y, w, h));
    Path wallPath = Path.combine(PathOperation.difference, outerWall, innerCutout);
    canvas.drawPath(wallPath, wallFill);
    
    final wallStroke = Paint()..color = const Color(0xFF5C3317)..strokeWidth = 1.5..style = PaintingStyle.stroke;
    canvas.drawRect(Rect.fromLTWH(x - wallThickness, y - wallThickness, w + 2 * wallThickness, h + 2 * wallThickness), wallStroke);
    canvas.drawRect(Rect.fromLTWH(x, y, w, h), wallStroke);
  }
  
  void _drawRealisticFatteningPens(Canvas canvas, double x, double y, double w, double h, double scale, int count) {
    // Central corridor with realistic concrete
    double corridorWidth = w * 0.12;
    double corridorX = x + (w - corridorWidth) / 2;
    
    final corridorPaint = Paint()..color = const Color(0xFFC0C0C0);
    canvas.drawRect(Rect.fromLTWH(corridorX, y, corridorWidth, h), corridorPaint);
    
    // Corridor texture lines
    final linePaint = Paint()..color = const Color(0xFF909090)..strokeWidth = 0.5;
    for (double ly = y; ly < y + h; ly += 15) {
      canvas.drawLine(Offset(corridorX + 3, ly), Offset(corridorX + corridorWidth - 3, ly), linePaint);
    }
    
    int pensPerSide = (count / 8).ceil().clamp(2, 6);
    double penHeight = h / pensPerSide;
    double penWidth = (w - corridorWidth) / 2;
    
    for (int i = 0; i < pensPerSide; i++) {
      double penY = y + i * penHeight;
      
      // Left pen with straw bedding
      _drawPenWithBedding(canvas, x, penY, penWidth, penHeight, i + 1);
      
      // Right pen
      _drawPenWithBedding(canvas, corridorX + corridorWidth, penY, penWidth, penHeight, i + 1 + pensPerSide);
      
      // Realistic feeders (steel trough)
      _drawSteelFeeder(canvas, corridorX - 10, penY + 15, 10, penHeight - 30);
      _drawSteelFeeder(canvas, corridorX + corridorWidth, penY + 15, 10, penHeight - 30);
      
      // Water nipples with pipe
      _drawWaterSystem(canvas, x + 15, penY + penHeight * 0.3, true);
      _drawWaterSystem(canvas, corridorX + corridorWidth + penWidth - 15, penY + penHeight * 0.3, false);
    }
    
    // Pen dividers
    final dividerPaint = Paint()..color = const Color(0xFF606060)..strokeWidth = 2;
    for (int i = 1; i < pensPerSide; i++) {
      double divY = y + i * penHeight;
      canvas.drawLine(Offset(x, divY), Offset(corridorX, divY), dividerPaint);
      canvas.drawLine(Offset(corridorX + corridorWidth, divY), Offset(x + w, divY), dividerPaint);
    }
  }
  
  void _drawPenWithBedding(Canvas canvas, double x, double y, double w, double h, int penNum) {
    // Straw/bedding floor
    final strawPaint = Paint()..color = const Color(0xFFD4B896);
    canvas.drawRect(Rect.fromLTWH(x + 2, y + 2, w - 4, h - 4), strawPaint);
    
    // Straw texture
    final strawLines = Paint()..color = const Color(0xFFC4A876)..strokeWidth = 0.5;
    for (double sy = y + 5; sy < y + h - 5; sy += 6) {
      for (double sx = x + 5; sx < x + w - 10; sx += 8) {
        canvas.drawLine(Offset(sx, sy), Offset(sx + 5, sy + 2), strawLines);
      }
    }
    
    // Pen border
    canvas.drawRect(Rect.fromLTWH(x, y, w, h), Paint()..color = const Color(0xFF707070)..strokeWidth = 1.5..style = PaintingStyle.stroke);
    
    // Pen number
    final numPainter = TextPainter(
      text: TextSpan(text: '$penNum', style: TextStyle(color: Colors.black54, fontSize: 12, fontWeight: FontWeight.bold)),
      textDirection: ui.TextDirection.ltr,
    );
    numPainter.layout();
    numPainter.paint(canvas, Offset(x + w / 2 - numPainter.width / 2, y + h / 2 - numPainter.height / 2));
  }
  
  void _drawSteelFeeder(Canvas canvas, double x, double y, double w, double h) {
    // Steel trough with 3D effect
    final steelTop = Paint()..color = const Color(0xFFAAAAAA);
    final steelSide = Paint()..color = const Color(0xFF888888);
    
    // Side
    canvas.drawRect(Rect.fromLTWH(x, y, w, h), steelSide);
    // Top highlight
    canvas.drawRect(Rect.fromLTWH(x, y, w, 3), steelTop);
    // Border
    canvas.drawRect(Rect.fromLTWH(x, y, w, h), Paint()..color = const Color(0xFF505050)..strokeWidth = 1..style = PaintingStyle.stroke);
    
    // Feed inside
    canvas.drawRect(Rect.fromLTWH(x + 2, y + 4, w - 4, h - 8), Paint()..color = const Color(0xFFD4A574));
  }
  
  void _drawWaterSystem(Canvas canvas, double x, double y, bool isLeft) {
    // Pipe
    final pipePaint = Paint()..color = const Color(0xFF4A90D9)..strokeWidth = 3;
    canvas.drawLine(Offset(x, y - 15), Offset(x, y + 25), pipePaint);
    
    // Nipple drinker
    canvas.drawCircle(Offset(x, y), 5, Paint()..color = const Color(0xFF3A7AC9));
    canvas.drawCircle(Offset(x, y), 5, Paint()..color = Colors.white..strokeWidth = 1..style = PaintingStyle.stroke);
    
    // Water drop
    Path drop = Path()
      ..moveTo(x, y + 8)
      ..quadraticBezierTo(x - 3, y + 12, x, y + 15)
      ..quadraticBezierTo(x + 3, y + 12, x, y + 8);
    canvas.drawPath(drop, Paint()..color = const Color(0xFF87CEEB));
  }
  
  void _drawRealisticFarrowingPens(Canvas canvas, double x, double y, double w, double h, double scale, int count) {
    double corridorWidth = w * 0.15;
    double corridorX = x + (w - corridorWidth) / 2;
    
    // Corridor
    canvas.drawRect(Rect.fromLTWH(corridorX, y, corridorWidth, h), Paint()..color = const Color(0xFFC0C0C0));
    
    int boxesPerSide = count.clamp(1, 5);
    double boxHeight = h / boxesPerSide;
    double boxWidth = (w - corridorWidth) / 2;
    
    for (int i = 0; i < boxesPerSide; i++) {
      double boxY = y + i * boxHeight;
      
      // Left farrowing crate
      _drawFarrowingCrate(canvas, x, boxY, boxWidth, boxHeight, i + 1);
      
      // Right farrowing crate
      _drawFarrowingCrate(canvas, corridorX + corridorWidth, boxY, boxWidth, boxHeight, i + 1 + boxesPerSide);
    }
  }
  
  void _drawFarrowingCrate(Canvas canvas, double x, double y, double w, double h, int num) {
    // Floor - rubber mat
    canvas.drawRect(Rect.fromLTWH(x + 2, y + 2, w - 4, h - 4), Paint()..color = const Color(0xFF404040));
    
    // Sow crate (central restraint)
    double crateWidth = w * 0.35;
    double crateX = x + (w - crateWidth) / 2;
    
    // Crate floor (slatted)
    canvas.drawRect(Rect.fromLTWH(crateX, y + 5, crateWidth, h - 10), Paint()..color = const Color(0xFF606060));
    
    // Slat lines
    final slatPaint = Paint()..color = const Color(0xFF505050)..strokeWidth = 1;
    for (double sy = y + 10; sy < y + h - 10; sy += 8) {
      canvas.drawLine(Offset(crateX + 2, sy), Offset(crateX + crateWidth - 2, sy), slatPaint);
    }
    
    // Crate bars
    final barPaint = Paint()..color = const Color(0xFFB0B0B0)..strokeWidth = 3;
    canvas.drawLine(Offset(crateX, y + 8), Offset(crateX, y + h - 8), barPaint);
    canvas.drawLine(Offset(crateX + crateWidth, y + 8), Offset(crateX + crateWidth, y + h - 8), barPaint);
    
    // Anti-crush bars (red)
    canvas.drawLine(Offset(crateX - 3, y + 12), Offset(crateX - 3, y + h - 12), Paint()..color = Colors.red.shade700..strokeWidth = 2);
    canvas.drawLine(Offset(crateX + crateWidth + 3, y + 12), Offset(crateX + crateWidth + 3, y + h - 12), Paint()..color = Colors.red.shade700..strokeWidth = 2);
    
    // Piglet creep areas with heat lamps
    _drawHeatedZone(canvas, x + 12, y + h * 0.25, 12);
    _drawHeatedZone(canvas, x + w - 24, y + h * 0.25, 12);
    
    // Pen border
    canvas.drawRect(Rect.fromLTWH(x, y, w, h), Paint()..color = const Color(0xFF505050)..strokeWidth = 1.5..style = PaintingStyle.stroke);
  }
  
  void _drawHeatedZone(Canvas canvas, double x, double y, double radius) {
    // Heat lamp glow
    final glowPaint = Paint()
      ..shader = ui.Gradient.radial(
        Offset(x, y),
        radius,
        [Colors.orange.withValues(alpha: 0.6), Colors.orange.withValues(alpha: 0.2), Colors.transparent],
        [0.0, 0.6, 1.0],
      );
    canvas.drawCircle(Offset(x, y), radius, glowPaint);
    
    // Lamp symbol
    canvas.drawCircle(Offset(x, y), 4, Paint()..color = Colors.orange.shade800);
  }
  
  void _drawRealisticNurseryPens(Canvas canvas, double x, double y, double w, double h, double scale, int count) {
    double corridorWidth = w * 0.10;
    double corridorX = x + (w - corridorWidth) / 2;
    
    canvas.drawRect(Rect.fromLTWH(corridorX, y, corridorWidth, h), Paint()..color = const Color(0xFFC0C0C0));
    
    int pensPerSide = (count / 15).ceil().clamp(3, 8);
    double penHeight = h / pensPerSide;
    double penWidth = (w - corridorWidth) / 2;
    
    for (int i = 0; i < pensPerSide; i++) {
      double penY = y + i * penHeight;
      
      // Plastic slatted floor
      _drawSlattedFloor(canvas, x + 2, penY + 2, penWidth - 4, penHeight - 4);
      _drawSlattedFloor(canvas, corridorX + corridorWidth + 2, penY + 2, penWidth - 4, penHeight - 4);
      
      // Heat lamp
      _drawHeatedZone(canvas, x + penWidth * 0.5, penY + penHeight * 0.4, 10);
      _drawHeatedZone(canvas, corridorX + corridorWidth + penWidth * 0.5, penY + penHeight * 0.4, 10);
      
      // Feeder
      _drawSteelFeeder(canvas, corridorX - 6, penY + 8, 6, penHeight - 16);
      _drawSteelFeeder(canvas, corridorX + corridorWidth, penY + 8, 6, penHeight - 16);
      
      // Pen borders
      canvas.drawRect(Rect.fromLTWH(x, penY, penWidth, penHeight), Paint()..color = const Color(0xFF606060)..strokeWidth = 1.5..style = PaintingStyle.stroke);
      canvas.drawRect(Rect.fromLTWH(corridorX + corridorWidth, penY, penWidth, penHeight), Paint()..color = const Color(0xFF606060)..strokeWidth = 1.5..style = PaintingStyle.stroke);
    }
  }
  
  void _drawSlattedFloor(Canvas canvas, double x, double y, double w, double h) {
    // Plastic slat base
    canvas.drawRect(Rect.fromLTWH(x, y, w, h), Paint()..color = const Color(0xFF909090));
    
    // Slat pattern
    final slatPaint = Paint()..color = const Color(0xFF707070)..strokeWidth = 1;
    for (double sy = y + 4; sy < y + h; sy += 6) {
      canvas.drawLine(Offset(x + 2, sy), Offset(x + w - 2, sy), slatPaint);
    }
  }
  
  void _drawRealisticBoarPens(Canvas canvas, double x, double y, double w, double h, double scale, int count) {
    int numPens = count.clamp(1, 4);
    double penWidth = w / numPens;
    
    for (int i = 0; i < numPens; i++) {
      double penX = x + i * penWidth;
      
      // Shelter area (indoor)
      canvas.drawRect(Rect.fromLTWH(penX + 5, y + 5, penWidth - 10, h * 0.4), Paint()..color = const Color(0xFFD4B896));
      
      // Exercise yard (outdoor - green)
      final yardGradient = Paint()
        ..shader = ui.Gradient.linear(
          Offset(penX, y + h * 0.5),
          Offset(penX, y + h),
          [const Color(0xFF7CB342), const Color(0xFF558B2F)],
        );
      canvas.drawRect(Rect.fromLTWH(penX + 5, y + h * 0.5, penWidth - 10, h * 0.45), yardGradient);
      
      // Mud wallow
      canvas.drawOval(Rect.fromLTWH(penX + penWidth * 0.3, y + h * 0.7, penWidth * 0.4, h * 0.15), Paint()..color = const Color(0xFF8B7355));
      
      // Feeder
      _drawSteelFeeder(canvas, penX + 15, y + h * 0.2, 20, 12);
      
      // Water
      _drawWaterSystem(canvas, penX + penWidth - 25, y + h * 0.25, false);
      
      // Pen border
      canvas.drawRect(Rect.fromLTWH(penX, y, penWidth, h), Paint()..color = const Color(0xFF505050)..strokeWidth = 2..style = PaintingStyle.stroke);
      
      // Labels
      _drawText(canvas, 'ABRI', Offset(penX + penWidth * 0.35, y + h * 0.2), const Color(0xFF5C4033), 9);
      _drawText(canvas, 'COUR', Offset(penX + penWidth * 0.35, y + h * 0.6), Colors.white, 9);
      _drawText(canvas, 'V${i + 1}', Offset(penX + penWidth * 0.45, y + h * 0.4), const Color(0xFF404040), 14);
    }
  }
  
  void _drawRealisticDoors(Canvas canvas, double x, double y, double w, double h) {
    double doorWidth = w * 0.10;
    double doorX = x + w / 2 - doorWidth / 2;
    
    // Door frame
    canvas.drawRect(Rect.fromLTWH(doorX - 2, y + h - 2, doorWidth + 4, 12), Paint()..color = const Color(0xFF5C4033));
    
    // Door
    canvas.drawRect(Rect.fromLTWH(doorX, y + h, doorWidth, 8), Paint()..color = const Color(0xFF8B7355));
    
    // Door swing arc
    final arcPaint = Paint()..color = const Color(0xFF404040)..strokeWidth = 1..style = PaintingStyle.stroke;
    canvas.drawArc(Rect.fromCircle(center: Offset(doorX + doorWidth, y + h + 4), radius: doorWidth * 0.8), 3.14159, 1.5708, false, arcPaint);
    
    // Handle
    canvas.drawCircle(Offset(doorX + doorWidth - 5, y + h + 4), 2, Paint()..color = const Color(0xFFD4AF37));
  }
  
  void _drawProfessionalDimensions(Canvas canvas, double x, double y, double w, double h, double realL, double realW) {
    final dimPaint = Paint()..color = const Color(0xFFD32F2F)..strokeWidth = 1;
    
    // Length
    double dimY = y + h + 18;
    canvas.drawLine(Offset(x, dimY), Offset(x + w, dimY), dimPaint);
    _drawArrowHead(canvas, Offset(x, dimY), true, dimPaint);
    _drawArrowHead(canvas, Offset(x + w, dimY), false, dimPaint);
    
    final lengthLabel = TextPainter(
      text: TextSpan(text: '${realL.toStringAsFixed(1)} m', style: TextStyle(color: const Color(0xFFD32F2F), fontSize: 10, fontWeight: FontWeight.bold)),
      textDirection: ui.TextDirection.ltr,
    );
    lengthLabel.layout();
    canvas.drawRect(Rect.fromLTWH(x + w/2 - lengthLabel.width/2 - 3, dimY - 7, lengthLabel.width + 6, 14), Paint()..color = Colors.white);
    lengthLabel.paint(canvas, Offset(x + w / 2 - lengthLabel.width / 2, dimY - 5));
    
    // Width
    double dimX = x + w + 18;
    canvas.drawLine(Offset(dimX, y), Offset(dimX, y + h), dimPaint);
    _drawArrowHead(canvas, Offset(dimX, y), true, dimPaint, vertical: true);
    _drawArrowHead(canvas, Offset(dimX, y + h), false, dimPaint, vertical: true);
    
    final widthLabel = TextPainter(
      text: TextSpan(text: '${realW.toStringAsFixed(1)} m', style: TextStyle(color: const Color(0xFFD32F2F), fontSize: 10, fontWeight: FontWeight.bold)),
      textDirection: ui.TextDirection.ltr,
    );
    widthLabel.layout();
    canvas.save();
    canvas.translate(dimX + 5, y + h / 2);
    canvas.rotate(-1.5708);
    canvas.drawRect(Rect.fromLTWH(-widthLabel.width/2 - 3, -7, widthLabel.width + 6, 14), Paint()..color = Colors.white);
    widthLabel.paint(canvas, Offset(-widthLabel.width / 2, -5));
    canvas.restore();
  }
  
  void _drawArrowHead(Canvas canvas, Offset point, bool leftOrUp, Paint paint, {bool vertical = false}) {
    Path arrow = Path();
    if (vertical) {
      if (leftOrUp) {
        arrow..moveTo(point.dx, point.dy)..lineTo(point.dx - 4, point.dy + 8)..lineTo(point.dx + 4, point.dy + 8)..close();
      } else {
        arrow..moveTo(point.dx, point.dy)..lineTo(point.dx - 4, point.dy - 8)..lineTo(point.dx + 4, point.dy - 8)..close();
      }
    } else {
      if (leftOrUp) {
        arrow..moveTo(point.dx, point.dy)..lineTo(point.dx + 8, point.dy - 4)..lineTo(point.dx + 8, point.dy + 4)..close();
      } else {
        arrow..moveTo(point.dx, point.dy)..lineTo(point.dx - 8, point.dy - 4)..lineTo(point.dx - 8, point.dy + 4)..close();
      }
    }
    canvas.drawPath(arrow, paint..style = PaintingStyle.fill);
  }
  
  void _drawProfessionalLegend(Canvas canvas, Size size, String type) {
    double legendY = size.height - 28;
    double legendX = 10;
    
    canvas.drawRRect(RRect.fromRectAndRadius(Rect.fromLTWH(legendX - 5, legendY - 5, size.width - 20, 25), Radius.circular(4)), 
      Paint()..color = Colors.white.withValues(alpha: 0.95));
    canvas.drawRRect(RRect.fromRectAndRadius(Rect.fromLTWH(legendX - 5, legendY - 5, size.width - 20, 25), Radius.circular(4)), 
      Paint()..color = Colors.grey.shade400..style = PaintingStyle.stroke..strokeWidth = 0.5);
    
    List<Map<String, dynamic>> items = [
      {'color': const Color(0xFFD4B896), 'label': 'Litière'},
      {'color': const Color(0xFF4A90D9), 'label': 'Rano'},
      {'color': const Color(0xFFAAAAAA), 'label': 'Auge'},
    ];
    
    if (type.contains('Truie') || type.contains('Renin')) {
      items.add({'color': Colors.orange, 'label': 'Hafanana'});
      items.add({'color': Colors.red.shade700, 'label': 'Anti-écras.'});
    }
    
    double itemWidth = (size.width - 30) / items.length;
    for (int i = 0; i < items.length; i++) {
      canvas.drawRect(Rect.fromLTWH(legendX + i * itemWidth, legendY, 12, 12), Paint()..color = items[i]['color']);
      canvas.drawRect(Rect.fromLTWH(legendX + i * itemWidth, legendY, 12, 12), Paint()..color = Colors.black54..strokeWidth = 0.5..style = PaintingStyle.stroke);
      
      final label = TextPainter(
        text: TextSpan(text: items[i]['label'], style: TextStyle(color: Colors.black87, fontSize: 9)),
        textDirection: ui.TextDirection.ltr,
      );
      label.layout();
      label.paint(canvas, Offset(legendX + i * itemWidth + 15, legendY));
    }
  }
  
  void _drawTitleBlock(Canvas canvas, Size size, String type) {
    String title = 'PLAN PORCHERIE';
    if (type.contains('Truie') || type.contains('Renin')) {
      title = 'PLAN MATERNITÉ';
    } else if (type.contains('Kely')) {
      title = 'PLAN POST-SEVRAGE';
    } else if (type.contains('Lahy') || type.contains('Verrat')) {
      title = 'PLAN VERRATERIE';
    }
    
    canvas.drawRect(Rect.fromLTWH(5, 2, size.width - 10, 18), Paint()..color = const Color(0xFFE65100));
    
    final titlePainter = TextPainter(
      text: TextSpan(text: title, style: TextStyle(color: Colors.white, fontSize: 11, fontWeight: FontWeight.bold, letterSpacing: 1.5)),
      textDirection: ui.TextDirection.ltr,
    );
    titlePainter.layout();
    titlePainter.paint(canvas, Offset(size.width / 2 - titlePainter.width / 2, 5));
  }
  
  void _drawNorthArrowAndScale(Canvas canvas, Size size, double scale) {
    double arrowX = size.width - 25;
    double arrowY = 35;
    
    canvas.drawCircle(Offset(arrowX, arrowY), 12, Paint()..color = Colors.white);
    canvas.drawCircle(Offset(arrowX, arrowY), 12, Paint()..color = Colors.black..style = PaintingStyle.stroke..strokeWidth = 1);
    
    Path arrow = Path()
      ..moveTo(arrowX, arrowY - 10)
      ..lineTo(arrowX - 5, arrowY + 5)
      ..lineTo(arrowX, arrowY + 2)
      ..lineTo(arrowX + 5, arrowY + 5)
      ..close();
    canvas.drawPath(arrow, Paint()..color = Colors.black);
    
    final nLabel = TextPainter(
      text: TextSpan(text: 'N', style: TextStyle(color: Colors.black, fontSize: 8, fontWeight: FontWeight.bold)),
      textDirection: ui.TextDirection.ltr,
    );
    nLabel.layout();
    nLabel.paint(canvas, Offset(arrowX - 3, arrowY + 6));
    
    // Scale bar
    double scaleBarX = 15;
    double scaleBarY = 35;
    double scaleLength = 50;
    double realLength = scaleLength / scale;
    
    canvas.drawRect(Rect.fromLTWH(scaleBarX, scaleBarY, scaleLength/2, 4), Paint()..color = Colors.black);
    canvas.drawRect(Rect.fromLTWH(scaleBarX + scaleLength/2, scaleBarY, scaleLength/2, 4), Paint()..color = Colors.white);
    canvas.drawRect(Rect.fromLTWH(scaleBarX, scaleBarY, scaleLength, 4), Paint()..color = Colors.black..style = PaintingStyle.stroke..strokeWidth = 1);
    
    final scaleLabel = TextPainter(
      text: TextSpan(text: '${realLength.toStringAsFixed(1)} m', style: TextStyle(color: Colors.black, fontSize: 8)),
      textDirection: ui.TextDirection.ltr,
    );
    scaleLabel.layout();
    scaleLabel.paint(canvas, Offset(scaleBarX + scaleLength/2 - scaleLabel.width/2, scaleBarY + 6));
  }
  
  void _drawText(Canvas canvas, String text, Offset position, Color color, double fontSize) {
    final textPainter = TextPainter(
      text: TextSpan(text: text, style: TextStyle(color: color, fontSize: fontSize, fontWeight: FontWeight.bold)),
      textDirection: ui.TextDirection.ltr,
    );
    textPainter.layout();
    textPainter.paint(canvas, position);
  }

  @override
  bool shouldRepaint(covariant PiggeryFloorPlanPainter oldDelegate) {
    return oldDelegate.area != area || oldDelegate.pigType != pigType || oldDelegate.pigCount != pigCount;
  }
}

// Rabbitry Floor Plan Painter - Realistic architectural style
class RabbitryFloorPlanPainter extends CustomPainter {
  final double area;
  final int rabbitCount;
  final String category;

  RabbitryFloorPlanPainter({
    required this.area,
    required this.rabbitCount,
    required this.category,
  });

  @override
  void paint(Canvas canvas, Size size) {
    if (area == 0 || rabbitCount == 0) return;

    final double padding = 35.0;
    
    // Calculate clapier dimensions
    int cagesPerRow = (rabbitCount > 6) ? 6 : rabbitCount;
    int numRows = (rabbitCount / cagesPerRow).ceil();
    if (numRows > 4) numRows = 4;
    
    double cageWidth = 0.8;
    double cageHeight = 0.6;
    if (category == 'Géant') {
      cageWidth = 1.2;
      cageHeight = 0.8;
    } else if (category == 'Reproduction') {
      cageWidth = 1.0;
      cageHeight = 0.7;
    }
    
    double buildingWidth = cagesPerRow * cageWidth + 1.2;
    double buildingLength = numRows * cageHeight + 1.0;
    
    final double availableWidth = size.width - 2 * padding - 20;
    final double availableHeight = size.height - 2 * padding - 45;
    
    double scaleX = availableWidth / buildingWidth;
    double scaleY = availableHeight / buildingLength;
    double scale = scaleX < scaleY ? scaleX : scaleY;
    
    double drawWidth = buildingWidth * scale;
    double drawHeight = buildingLength * scale;
    double offsetX = (size.width - drawWidth) / 2;
    double offsetY = padding + 5;

    // Draw realistic background
    _drawPaperBackground(canvas, size);
    
    // Draw building shadow
    _drawBuildingShadow(canvas, offsetX, offsetY, drawWidth, drawHeight);
    
    // Draw wooden floor
    _drawWoodenFloor(canvas, offsetX, offsetY, drawWidth, drawHeight);
    
    // Draw wooden frame walls
    _drawWoodenWalls(canvas, offsetX, offsetY, drawWidth, drawHeight);
    
    // Draw realistic cages
    _drawRealisticCages(canvas, offsetX, offsetY, drawWidth, drawHeight, scale, cagesPerRow, numRows, cageWidth, cageHeight);
    
    // Draw central aisle
    _drawRealisticAisle(canvas, offsetX, offsetY, drawWidth, drawHeight, scale);
    
    // Draw dimensions
    _drawProfessionalDimensions(canvas, offsetX, offsetY, drawWidth, drawHeight, buildingWidth, buildingLength);
    
    // Draw legend
    _drawProfessionalLegend(canvas, size);
    
    // Draw title block
    _drawTitleBlock(canvas, size);
    
    // Draw north arrow and scale
    _drawNorthArrowAndScale(canvas, size, scale);
  }
  
  void _drawPaperBackground(Canvas canvas, Size size) {
    final paperGradient = Paint()
      ..shader = ui.Gradient.linear(
        Offset(0, 0),
        Offset(size.width, size.height),
        [const Color(0xFFFAF8F5), const Color(0xFFF5F0E8), const Color(0xFFFAF8F5)],
        [0.0, 0.5, 1.0],
      );
    canvas.drawRect(Rect.fromLTWH(0, 0, size.width, size.height), paperGradient);
    
    final gridPaint = Paint()..color = const Color(0xFFE8E4DC)..strokeWidth = 0.5;
    for (double x = 0; x < size.width; x += 20) {
      canvas.drawLine(Offset(x, 0), Offset(x, size.height), gridPaint);
    }
    for (double y = 0; y < size.height; y += 20) {
      canvas.drawLine(Offset(0, y), Offset(size.width, y), gridPaint);
    }
  }
  
  void _drawBuildingShadow(Canvas canvas, double x, double y, double w, double h) {
    final shadowPaint = Paint()
      ..color = Colors.black.withValues(alpha: 0.15)
      ..maskFilter = const MaskFilter.blur(BlurStyle.normal, 8);
    canvas.drawRect(Rect.fromLTWH(x + 6, y + 6, w, h), shadowPaint);
  }
  
  void _drawWoodenFloor(Canvas canvas, double x, double y, double w, double h) {
    // Wooden planks floor
    final woodPaint = Paint()..color = const Color(0xFFDEB887);
    canvas.drawRect(Rect.fromLTWH(x, y, w, h), woodPaint);
    
    // Wood grain pattern
    final grainPaint = Paint()..color = const Color(0xFFCDAA7D)..strokeWidth = 0.5;
    double plankWidth = 15;
    for (double px = x; px < x + w; px += plankWidth) {
      canvas.drawLine(Offset(px, y), Offset(px, y + h), grainPaint);
      // Wood grain lines
      for (double gy = y + 5; gy < y + h; gy += 12) {
        canvas.drawLine(Offset(px + 2, gy), Offset(px + plankWidth - 2, gy + 3), Paint()..color = const Color(0xFFC49A6C)..strokeWidth = 0.3);
      }
    }
  }
  
  void _drawWoodenWalls(Canvas canvas, double x, double y, double w, double h) {
    double wallThickness = 6;
    final woodFrame = Paint()..color = const Color(0xFF8B4513);
    
    Path outerWall = Path()..addRect(Rect.fromLTWH(x - wallThickness, y - wallThickness, w + 2 * wallThickness, h + 2 * wallThickness));
    Path innerCutout = Path()..addRect(Rect.fromLTWH(x, y, w, h));
    Path wallPath = Path.combine(PathOperation.difference, outerWall, innerCutout);
    canvas.drawPath(wallPath, woodFrame);
    
    // Wood grain on frame
    final grainPaint = Paint()..color = const Color(0xFF6B3A0F)..strokeWidth = 0.5;
    for (double fx = x - wallThickness; fx < x + w + wallThickness; fx += 20) {
      canvas.drawLine(Offset(fx, y - wallThickness), Offset(fx, y), grainPaint);
      canvas.drawLine(Offset(fx, y + h), Offset(fx, y + h + wallThickness), grainPaint);
    }
    
    final wallStroke = Paint()..color = const Color(0xFF5C3317)..strokeWidth = 1.5..style = PaintingStyle.stroke;
    canvas.drawRect(Rect.fromLTWH(x - wallThickness, y - wallThickness, w + 2 * wallThickness, h + 2 * wallThickness), wallStroke);
    canvas.drawRect(Rect.fromLTWH(x, y, w, h), wallStroke);
  }
  
  void _drawRealisticCages(Canvas canvas, double x, double y, double w, double h, double scale, int cagesPerRow, int numRows, double cageW, double cageH) {
    double scaledCageW = cageW * scale;
    double scaledCageH = cageH * scale;
    double aisleWidth = 0.6 * scale;
    double startX = x + 12;
    double startY = y + 12;
    
    int cageNum = 1;
    
    for (int row = 0; row < numRows; row++) {
      double rowY = startY + row * (scaledCageH + 10);
      
      for (int col = 0; col < cagesPerRow && cageNum <= rabbitCount; col++) {
        double cageX = startX + col * (scaledCageW + 6);
        if (col >= cagesPerRow / 2) {
          cageX += aisleWidth;
        }
        
        _drawSingleCage(canvas, cageX, rowY, scaledCageW, scaledCageH, cageNum);
        cageNum++;
      }
      
      // Row label with background
      final rowBg = Paint()..color = Colors.white.withValues(alpha: 0.8);
      canvas.drawRRect(RRect.fromRectAndRadius(Rect.fromLTWH(x + 1, rowY + scaledCageH / 2 - 8, 18, 16), Radius.circular(3)), rowBg);
      _drawText(canvas, 'R${row + 1}', Offset(x + 3, rowY + scaledCageH / 2 - 5), const Color(0xFF5C3317), 9);
    }
  }
  
  void _drawSingleCage(Canvas canvas, double x, double y, double w, double h, int num) {
    // Cage base (galvanized metal)
    final cageGradient = Paint()
      ..shader = ui.Gradient.linear(
        Offset(x, y),
        Offset(x, y + h),
        [const Color(0xFFE8E8E8), const Color(0xFFD0D0D0), const Color(0xFFC0C0C0)],
        [0.0, 0.5, 1.0],
      );
    canvas.drawRect(Rect.fromLTWH(x, y, w, h), cageGradient);
    
    // Wire mesh pattern (realistic)
    final meshPaint = Paint()..color = const Color(0xFF808080)..strokeWidth = 0.8;
    final meshLight = Paint()..color = const Color(0xFFA0A0A0)..strokeWidth = 0.4;
    
    // Vertical wires
    double wireSpacing = w / 6;
    for (double wx = x + wireSpacing; wx < x + w; wx += wireSpacing) {
      canvas.drawLine(Offset(wx, y), Offset(wx, y + h), meshPaint);
      canvas.drawLine(Offset(wx + 0.5, y), Offset(wx + 0.5, y + h), meshLight);
    }
    
    // Horizontal wires
    double hSpacing = h / 4;
    for (double wy = y + hSpacing; wy < y + h; wy += hSpacing) {
      canvas.drawLine(Offset(x, wy), Offset(x + w, wy), meshPaint);
    }
    
    // Cage frame (thicker border)
    canvas.drawRect(Rect.fromLTWH(x, y, w, h), Paint()..color = const Color(0xFF606060)..strokeWidth = 2..style = PaintingStyle.stroke);
    
    // Hay/bedding on floor
    final hayPaint = Paint()..color = const Color(0xFFE8D4A8).withValues(alpha: 0.6);
    canvas.drawRect(Rect.fromLTWH(x + 3, y + h - 12, w - 6, 9), hayPaint);
    // Hay texture
    for (double hx = x + 5; hx < x + w - 5; hx += 4) {
      canvas.drawLine(Offset(hx, y + h - 10), Offset(hx + 2, y + h - 5), Paint()..color = const Color(0xFFD4C088)..strokeWidth = 0.5);
    }
    
    // Feeder (ceramic bowl style)
    _drawCeramicFeeder(canvas, x + 5, y + 5, w * 0.25, h * 0.3);
    
    // Water bottle with nipple
    _drawWaterBottle(canvas, x + w - 12, y + 3, 10, h * 0.5);
    
    // Nest box for reproduction
    if (category == 'Reproduction') {
      _drawNestBox(canvas, x + w - w * 0.4, y + h - h * 0.45, w * 0.35, h * 0.4);
    }
    
    // Cage number badge
    final numBg = Paint()..color = const Color(0xFF4CAF50);
    canvas.drawCircle(Offset(x + w / 2, y + h / 2), 10, numBg);
    canvas.drawCircle(Offset(x + w / 2, y + h / 2), 10, Paint()..color = Colors.white..strokeWidth = 1..style = PaintingStyle.stroke);
    _drawText(canvas, '$num', Offset(x + w / 2 - 4, y + h / 2 - 5), Colors.white, 9);
  }
  
  void _drawCeramicFeeder(Canvas canvas, double x, double y, double w, double h) {
    // Bowl shape
    final bowlGradient = Paint()
      ..shader = ui.Gradient.linear(
        Offset(x, y),
        Offset(x + w, y + h),
        [const Color(0xFFD4A574), const Color(0xFFB8956A), const Color(0xFFA08060)],
        [0.0, 0.5, 1.0],
      );
    
    canvas.drawOval(Rect.fromLTWH(x, y, w, h * 0.7), bowlGradient);
    canvas.drawOval(Rect.fromLTWH(x, y, w, h * 0.7), Paint()..color = const Color(0xFF6B4423)..strokeWidth = 1..style = PaintingStyle.stroke);
    
    // Pellets inside
    final pelletPaint = Paint()..color = const Color(0xFF8B7355);
    for (double px = x + 3; px < x + w - 3; px += 4) {
      canvas.drawCircle(Offset(px, y + h * 0.3), 1.5, pelletPaint);
    }
  }
  
  void _drawWaterBottle(Canvas canvas, double x, double y, double w, double h) {
    // Bottle body
    final bottleGradient = Paint()
      ..shader = ui.Gradient.linear(
        Offset(x, y),
        Offset(x + w, y),
        [const Color(0xFF87CEEB), const Color(0xFF4A90D9), const Color(0xFF87CEEB)],
        [0.0, 0.5, 1.0],
      );
    
    canvas.drawRRect(RRect.fromRectAndRadius(Rect.fromLTWH(x, y, w, h * 0.8), Radius.circular(3)), bottleGradient);
    canvas.drawRRect(RRect.fromRectAndRadius(Rect.fromLTWH(x, y, w, h * 0.8), Radius.circular(3)), 
      Paint()..color = const Color(0xFF1565C0)..strokeWidth = 1..style = PaintingStyle.stroke);
    
    // Nipple
    canvas.drawRect(Rect.fromLTWH(x + w * 0.3, y + h * 0.8, w * 0.4, h * 0.2), Paint()..color = const Color(0xFFB0B0B0));
    
    // Water level
    canvas.drawRect(Rect.fromLTWH(x + 2, y + h * 0.15, w - 4, h * 0.6), Paint()..color = const Color(0xFF64B5F6).withValues(alpha: 0.5));
  }
  
  void _drawNestBox(Canvas canvas, double x, double y, double w, double h) {
    // Wooden nest box
    final woodGradient = Paint()
      ..shader = ui.Gradient.linear(
        Offset(x, y),
        Offset(x + w, y + h),
        [const Color(0xFFD4A574), const Color(0xFFB8956A)],
        [0.0, 1.0],
      );
    
    canvas.drawRRect(RRect.fromRectAndRadius(Rect.fromLTWH(x, y, w, h), Radius.circular(2)), woodGradient);
    canvas.drawRRect(RRect.fromRectAndRadius(Rect.fromLTWH(x, y, w, h), Radius.circular(2)), 
      Paint()..color = const Color(0xFF6B4423)..strokeWidth = 1..style = PaintingStyle.stroke);
    
    // Opening
    canvas.drawArc(Rect.fromLTWH(x + 2, y + h * 0.3, w - 4, h * 0.6), 0, 3.14159, false, Paint()..color = const Color(0xFF3E2723));
    
    // Straw inside
    for (double sx = x + 4; sx < x + w - 4; sx += 3) {
      canvas.drawLine(Offset(sx, y + h * 0.7), Offset(sx + 1, y + h * 0.5), Paint()..color = const Color(0xFFE8D4A8)..strokeWidth = 0.5);
    }
    
    // Label
    _drawText(canvas, 'NID', Offset(x + w * 0.25, y + 2), Colors.white, 7);
  }
  
  void _drawRealisticAisle(Canvas canvas, double x, double y, double w, double h, double scale) {
    double aisleWidth = 0.6 * scale;
    double aisleX = x + w / 2 - aisleWidth / 2;
    
    // Concrete aisle
    final aislePaint = Paint()..color = const Color(0xFFC0C0C0);
    canvas.drawRect(Rect.fromLTWH(aisleX, y, aisleWidth, h), aislePaint);
    
    // Texture
    for (double ty = y + 5; ty < y + h; ty += 10) {
      canvas.drawLine(Offset(aisleX + 3, ty), Offset(aisleX + aisleWidth - 3, ty), 
        Paint()..color = const Color(0xFFB0B0B0)..strokeWidth = 0.5);
    }
    
    // Border
    canvas.drawRect(Rect.fromLTWH(aisleX, y, aisleWidth, h), Paint()..color = const Color(0xFF808080)..strokeWidth = 1..style = PaintingStyle.stroke);
  }
  
  void _drawProfessionalDimensions(Canvas canvas, double x, double y, double w, double h, double realW, double realH) {
    final dimPaint = Paint()..color = const Color(0xFFD32F2F)..strokeWidth = 1;
    
    // Width
    double dimY = y + h + 18;
    canvas.drawLine(Offset(x, dimY), Offset(x + w, dimY), dimPaint);
    _drawArrowHead(canvas, Offset(x, dimY), true, dimPaint);
    _drawArrowHead(canvas, Offset(x + w, dimY), false, dimPaint);
    
    final widthLabel = TextPainter(
      text: TextSpan(text: '${realW.toStringAsFixed(1)} m', style: TextStyle(color: const Color(0xFFD32F2F), fontSize: 10, fontWeight: FontWeight.bold)),
      textDirection: ui.TextDirection.ltr,
    );
    widthLabel.layout();
    canvas.drawRect(Rect.fromLTWH(x + w/2 - widthLabel.width/2 - 3, dimY - 7, widthLabel.width + 6, 14), Paint()..color = Colors.white);
    widthLabel.paint(canvas, Offset(x + w / 2 - widthLabel.width / 2, dimY - 5));
    
    // Height
    double dimX = x + w + 18;
    canvas.drawLine(Offset(dimX, y), Offset(dimX, y + h), dimPaint);
    _drawArrowHead(canvas, Offset(dimX, y), true, dimPaint, vertical: true);
    _drawArrowHead(canvas, Offset(dimX, y + h), false, dimPaint, vertical: true);
    
    final heightLabel = TextPainter(
      text: TextSpan(text: '${realH.toStringAsFixed(1)} m', style: TextStyle(color: const Color(0xFFD32F2F), fontSize: 10, fontWeight: FontWeight.bold)),
      textDirection: ui.TextDirection.ltr,
    );
    heightLabel.layout();
    canvas.save();
    canvas.translate(dimX + 5, y + h / 2);
    canvas.rotate(-1.5708);
    canvas.drawRect(Rect.fromLTWH(-heightLabel.width/2 - 3, -7, heightLabel.width + 6, 14), Paint()..color = Colors.white);
    heightLabel.paint(canvas, Offset(-heightLabel.width / 2, -5));
    canvas.restore();
  }
  
  void _drawArrowHead(Canvas canvas, Offset point, bool leftOrUp, Paint paint, {bool vertical = false}) {
    Path arrow = Path();
    if (vertical) {
      if (leftOrUp) {
        arrow..moveTo(point.dx, point.dy)..lineTo(point.dx - 4, point.dy + 8)..lineTo(point.dx + 4, point.dy + 8)..close();
      } else {
        arrow..moveTo(point.dx, point.dy)..lineTo(point.dx - 4, point.dy - 8)..lineTo(point.dx + 4, point.dy - 8)..close();
      }
    } else {
      if (leftOrUp) {
        arrow..moveTo(point.dx, point.dy)..lineTo(point.dx + 8, point.dy - 4)..lineTo(point.dx + 8, point.dy + 4)..close();
      } else {
        arrow..moveTo(point.dx, point.dy)..lineTo(point.dx - 8, point.dy - 4)..lineTo(point.dx - 8, point.dy + 4)..close();
      }
    }
    canvas.drawPath(arrow, paint..style = PaintingStyle.fill);
  }
  
  void _drawProfessionalLegend(Canvas canvas, Size size) {
    double legendY = size.height - 28;
    double legendX = 10;
    
    canvas.drawRRect(RRect.fromRectAndRadius(Rect.fromLTWH(legendX - 5, legendY - 5, size.width - 20, 25), Radius.circular(4)), 
      Paint()..color = Colors.white.withValues(alpha: 0.95));
    canvas.drawRRect(RRect.fromRectAndRadius(Rect.fromLTWH(legendX - 5, legendY - 5, size.width - 20, 25), Radius.circular(4)), 
      Paint()..color = Colors.grey.shade400..style = PaintingStyle.stroke..strokeWidth = 0.5);
    
    List<Map<String, dynamic>> items = [
      {'color': const Color(0xFFD0D0D0), 'label': 'Cage'},
      {'color': const Color(0xFFD4A574), 'label': 'Sakafo'},
      {'color': const Color(0xFF4A90D9), 'label': 'Rano'},
      {'color': const Color(0xFFE8D4A8), 'label': 'Vilona'},
    ];
    
    if (category == 'Reproduction') {
      items.add({'color': const Color(0xFFB8956A), 'label': 'Akany'});
    }
    
    double itemWidth = (size.width - 30) / items.length;
    for (int i = 0; i < items.length; i++) {
      canvas.drawRect(Rect.fromLTWH(legendX + i * itemWidth, legendY, 12, 12), Paint()..color = items[i]['color']);
      canvas.drawRect(Rect.fromLTWH(legendX + i * itemWidth, legendY, 12, 12), Paint()..color = Colors.black54..strokeWidth = 0.5..style = PaintingStyle.stroke);
      
      final label = TextPainter(
        text: TextSpan(text: items[i]['label'], style: TextStyle(color: Colors.black87, fontSize: 9)),
        textDirection: ui.TextDirection.ltr,
      );
      label.layout();
      label.paint(canvas, Offset(legendX + i * itemWidth + 15, legendY));
    }
  }
  
  void _drawTitleBlock(Canvas canvas, Size size) {
    canvas.drawRect(Rect.fromLTWH(5, 2, size.width - 10, 18), Paint()..color = const Color(0xFF795548));
    
    final titlePainter = TextPainter(
      text: TextSpan(text: 'PLAN CLAPIER - TRANOM-BITRO', style: TextStyle(color: Colors.white, fontSize: 11, fontWeight: FontWeight.bold, letterSpacing: 1.5)),
      textDirection: ui.TextDirection.ltr,
    );
    titlePainter.layout();
    titlePainter.paint(canvas, Offset(size.width / 2 - titlePainter.width / 2, 5));
  }
  
  void _drawNorthArrowAndScale(Canvas canvas, Size size, double scale) {
    double arrowX = size.width - 25;
    double arrowY = 35;
    
    canvas.drawCircle(Offset(arrowX, arrowY), 12, Paint()..color = Colors.white);
    canvas.drawCircle(Offset(arrowX, arrowY), 12, Paint()..color = Colors.black..style = PaintingStyle.stroke..strokeWidth = 1);
    
    Path arrow = Path()
      ..moveTo(arrowX, arrowY - 10)
      ..lineTo(arrowX - 5, arrowY + 5)
      ..lineTo(arrowX, arrowY + 2)
      ..lineTo(arrowX + 5, arrowY + 5)
      ..close();
    canvas.drawPath(arrow, Paint()..color = Colors.black);
    
    final nLabel = TextPainter(
      text: TextSpan(text: 'N', style: TextStyle(color: Colors.black, fontSize: 8, fontWeight: FontWeight.bold)),
      textDirection: ui.TextDirection.ltr,
    );
    nLabel.layout();
    nLabel.paint(canvas, Offset(arrowX - 3, arrowY + 6));
    
    // Scale bar
    double scaleBarX = 15;
    double scaleBarY = 35;
    double scaleLength = 50;
    double realLength = scaleLength / scale;
    
    canvas.drawRect(Rect.fromLTWH(scaleBarX, scaleBarY, scaleLength/2, 4), Paint()..color = Colors.black);
    canvas.drawRect(Rect.fromLTWH(scaleBarX + scaleLength/2, scaleBarY, scaleLength/2, 4), Paint()..color = Colors.white);
    canvas.drawRect(Rect.fromLTWH(scaleBarX, scaleBarY, scaleLength, 4), Paint()..color = Colors.black..style = PaintingStyle.stroke..strokeWidth = 1);
    
    final scaleLabel = TextPainter(
      text: TextSpan(text: '${realLength.toStringAsFixed(1)} m', style: TextStyle(color: Colors.black, fontSize: 8)),
      textDirection: ui.TextDirection.ltr,
    );
    scaleLabel.layout();
    scaleLabel.paint(canvas, Offset(scaleBarX + scaleLength/2 - scaleLabel.width/2, scaleBarY + 6));
  }
  
  void _drawText(Canvas canvas, String text, Offset position, Color color, double fontSize) {
    final textPainter = TextPainter(
      text: TextSpan(text: text, style: TextStyle(color: color, fontSize: fontSize, fontWeight: FontWeight.bold)),
      textDirection: ui.TextDirection.ltr,
    );
    textPainter.layout();
    textPainter.paint(canvas, position);
  }

  @override
  bool shouldRepaint(covariant RabbitryFloorPlanPainter oldDelegate) {
    return oldDelegate.area != area || oldDelegate.rabbitCount != rabbitCount || oldDelegate.category != category;
  }
}

double sin(double x) => x - (x * x * x) / 6 + (x * x * x * x * x) / 120;
double cos(double x) => 1 - (x * x) / 2 + (x * x * x * x) / 24;

// --- MODULE 2: SAKAFO (FEED) ---
class FeedScreen extends StatefulWidget {
  const FeedScreen({super.key});

  @override
  State<FeedScreen> createState() => _FeedScreenState();
}

class _FeedScreenState extends State<FeedScreen> {
  String _type = 'Chair';
  String _selectedStage = 'Démarrage';
  final List<_FeedSegment> _segments = [
    _FeedSegment(stage: 'Démarrage', week: '1', count: '100'),
  ];
  String _feedResult = '';
  String _formula = '';

  List<String> _getStages() {
    if (_type == 'Chair') return ['Démarrage', 'Croissance', 'Finition'];
    if (_type == 'Pondeuse') return ['Démarrage', 'Croissance', 'Ponte'];
    if (_type == 'Mpiady') return ['Démarrage', 'Croissance', 'Ady'];
    if (_type == 'Bitro') return ['Zaza', 'Mitombo', 'Lehibe'];
    if (_type == 'BitroVolavo') return ['Zaza', 'Mitombo', 'Lehibe'];
    return ['Démarrage', 'Croissance', 'Adulte'];
  }

  void _calculateFeed() {
    final results = <String>[];
    final formulas = <String>[];
    double totalFeedKg = 0;
    double totalWaterL = 0;

    for (final seg in _segments) {
      final week = int.tryParse(seg.week) ?? 1;
      final count = int.tryParse(seg.count) ?? 0;
      if (count <= 0) continue;
      final res = _computeFeedFor(_type, week);
      final feedKg = (res.gPerBird * count) / 1000;
      final waterL = (res.waterMl * count) / 1000;
      totalFeedKg += feedKg;
      totalWaterL += waterL;
      results.add('• ${seg.stage} (${res.stageLabel}) — Provandy: ${feedKg.toStringAsFixed(2)} kg | Rano: ${waterL.toStringAsFixed(1)} L');
      formulas.add('[$count isa - ${seg.stage}]\n${res.formula}\n');
    }

    if (totalFeedKg > 0 && totalWaterL > 0) {
      results.insert(0, 'Total — Provandy: ${totalFeedKg.toStringAsFixed(2)} kg | Rano: ${totalWaterL.toStringAsFixed(1)} L');
    }

    setState(() {
      _feedResult = results.isEmpty
          ? 'Ampidiro ny isan\'ny biby isaky ny dingana.'
          : results.join('\n');
      _formula = formulas.join('\n');
    });
  }

  FeedCalcResult _computeFeedFor(String type, int week) {
    double gPerBird = 0;
    double waterMl = 0;
    String stageLabel = '';
    String currentFormula = '';

    if (type == 'Chair') {
      if (week == 1) { gPerBird = 23; waterMl = 46; }
      else if (week == 2) { gPerBird = 47; waterMl = 94; }
      else if (week == 3) { gPerBird = 74; waterMl = 148; }
      else if (week == 4) { gPerBird = 106; waterMl = 212; }
      else if (week == 5) { gPerBird = 140; waterMl = 280; }
      else if (week == 6) { gPerBird = 166; waterMl = 332; }
      else { gPerBird = 187; waterMl = 374; }

      if (week <= 3) {
        stageLabel = 'Démarrage (0-3 herinandro)';
        currentFormula = '• Katsaka: 52%\n• Faikan-tsoja (Tourteau Soja): 30%\n• Apombo-bary (Son de Blé): 10%\n• Vovo-trondro (Farine de Poisson): 4%\n• CMV Chair: 4%';
      } else if (week <= 5) {
        stageLabel = 'Croissance (4-5 herinandro)';
        currentFormula = '• Katsaka: 58%\n• Faikan-tsoja (Tourteau Soja): 25%\n• Apombo-bary (Son de Blé): 10%\n• Vovo-trondro (Farine de Poisson): 3%\n• CMV Chair: 4%';
      } else {
        stageLabel = 'Finition (6+ herinandro)';
        currentFormula = '• Katsaka: 62%\n• Faikan-tsoja (Tourteau Soja): 20%\n• Apombo-bary (Son de Blé): 12%\n• Vovo-trondro (Farine de Poisson): 2%\n• CMV Chair: 4%';
      }
    } else if (type == 'Pondeuse') {
      if (week <= 8) {
        gPerBird = 40;
      } else if (week <= 18) {
        gPerBird = 80;
      } else {
        gPerBird = 125;
      }
      waterMl = 250;

      if (week <= 8) {
        stageLabel = 'Démarrage (0-8 herinandro)';
        currentFormula = '• Katsaka: 50%\n• Faikan-tsoja (Tourteau Soja): 20%\n• Apombo-bary (Son de Blé): 25%\n• CMV Pondeuse: 5%';
      } else if (week <= 18) {
        stageLabel = 'Croissance (9-18 herinandro)';
        currentFormula = '• Katsaka: 45%\n• Faikan-tsoja (Tourteau Soja): 15%\n• Apombo-bary (Son de Blé): 35%\n• CMV Pondeuse: 5%';
      } else {
        stageLabel = 'Ponte (19+ herinandro)';
        currentFormula = '• Katsaka: 50%\n• Faikan-tsoja (Tourteau Soja): 20%\n• Apombo-bary (Son de Blé): 20%\n• Lao-akorantsely (Coquille): 8%\n• CMV Pondeuse: 2%';
      }
    } else if (type == 'Mpiady') {
      if (week <= 8) {
        gPerBird = 35;
      } else if (week <= 20) {
        gPerBird = 80;
      } else {
        gPerBird = 120;
      }
      waterMl = 280;

      if (week <= 8) {
        stageLabel = 'Démarrage (0-8 herinandro)';
        currentFormula = '• Katsaka: 48%\n• Faikan-tsoja (Tourteau Soja): 28%\n• Apombo-bary (Son de Blé): 15%\n• Vovo-trondro (Farine de Poisson): 5%\n• CMV: 4%';
      } else if (week <= 20) {
        stageLabel = 'Croissance (9-20 herinandro)';
        currentFormula = '• Katsaka: 52%\n• Faikan-tsoja (Tourteau Soja): 25%\n• Apombo-bary (Son de Blé): 12%\n• Vovo-trondro (Farine de Poisson): 6%\n• CMV: 5%';
      } else {
        stageLabel = 'Ady (21+ herinandro)';
        currentFormula = '• Katsaka: 55%\n• Faikan-tsoja (Tourteau Soja): 22%\n• Apombo-bary (Son de Blé): 10%\n• Vovo-trondro (Farine de Poisson): 8%\n• CMV: 5%\n\n💪 Vitamines E & B12 recommandées';
      }
    } else if (type == 'Ornement') {
      if (week <= 8) {
        gPerBird = 30;
      } else if (week <= 18) {
        gPerBird = 60;
      } else {
        gPerBird = 100;
      }
      waterMl = 200;

      if (week <= 8) {
        stageLabel = 'Démarrage (0-8 herinandro)';
        currentFormula = '• Katsaka: 48%\n• Faikan-tsoja (Tourteau Soja): 22%\n• Apombo-bary (Son de Blé): 22%\n• Vovo-trondro (Farine de Poisson): 3%\n• CMV: 5%';
      } else if (week <= 18) {
        stageLabel = 'Croissance (9-18 herinandro)';
        currentFormula = '• Katsaka: 50%\n• Faikan-tsoja (Tourteau Soja): 18%\n• Apombo-bary (Son de Blé): 25%\n• Vovo-trondro (Farine de Poisson): 2%\n• CMV: 5%';
      } else {
        stageLabel = 'Adulte (19+ herinandro)';
        currentFormula = '• Katsaka: 52%\n• Faikan-tsoja (Tourteau Soja): 15%\n• Apombo-bary (Son de Blé): 28%\n• CMV: 5%\n\n🪶 Ajouter huile végétale pour plumage brillant';
      }
    } else if (type == 'Nain') {
      if (week <= 8) {
        gPerBird = 20;
      } else if (week <= 18) {
        gPerBird = 40;
      } else {
        gPerBird = 60;
      }
      waterMl = 120;

      stageLabel = week <= 18 ? 'Croissance' : 'Adulte';
      currentFormula = '• Katsaka: 55%\n• Faikan-tsoja (Tourteau Soja): 15%\n• Apombo-bary (Son de Blé): 25%\n• CMV: 5%';
    } else if (type == 'Gana') {
      if (week <= 3) {
        gPerBird = 50;
      } else if (week <= 7) {
        gPerBird = 120;
      } else {
        gPerBird = 180;
      }
      waterMl = 400;

      stageLabel = week <= 3 ? 'Démarrage' : (week <= 7 ? 'Croissance' : 'Finition');
      currentFormula = '• 🦆 Katsaka: 50%\n• Faikan-tsoja (Tourteau Soja): 20%\n• Apombo-bary (Son de Blé): 20%\n• Vovo-trondro (Farine de Poisson): 5%\n• CMV Gana: 5%';
    } else if (type == 'Dokotra') {
      if (week <= 4) {
        gPerBird = 60;
      } else if (week <= 10) {
        gPerBird = 150;
      } else {
        gPerBird = 220;
      }
      waterMl = 450;

      stageLabel = week <= 4 ? 'Démarrage' : (week <= 10 ? 'Croissance' : 'Finition');
      currentFormula = '• 🦆 Katsaka: 52%\n• Faikan-tsoja (Tourteau Soja): 22%\n• Apombo-bary (Son de Blé): 15%\n• Vovo-trondro (Farine de Poisson): 6%\n• CMV: 5%';
    } else if (type == 'Sarindokotra') {
      // Mulard (Gavage/Foie gras) - Croissance rapide
      if (week <= 4) {
        gPerBird = 80;
      } else if (week <= 10) {
        gPerBird = 200;
      } else if (week <= 12) {
        // Phase de gavage
        gPerBird = 400;
      } else {
        gPerBird = 450;
      }
      waterMl = 500;

      stageLabel = week <= 4 ? 'Démarrage' : (week <= 10 ? 'Croissance' : 'Gavage');
      currentFormula = '• 🦆 SARINDOKOTRA (Mulard):\n\n📍 Démarrage (0-4 sem):\n  Katsaka: 50%, Soja: 25%, Blé: 20%\n\n📍 Croissance (5-10 sem):\n  Katsaka: 55%, Soja: 20%, Blé: 20%\n\n📍 Gavage (11+ sem):\n  Katsaka 100% (omboke masaka)\n  Gavage in-2 isan\'andro\n\n⚠️ Lanja vonjena: 4-6 kg (14 sem)';
    } else if (type == 'Gisa') {
      if (week <= 3) {
        gPerBird = 70;
      } else if (week <= 8) {
        gPerBird = 200;
      } else {
        gPerBird = 350;
      }
      waterMl = 600;

      stageLabel = week <= 3 ? 'Démarrage' : (week <= 8 ? 'Croissance' : 'Finition');
      currentFormula = '• 🦢 Katsaka: 45%\n• Faikan-tsoja (Tourteau Soja): 15%\n• Apombo-bary (Son de Blé): 25%\n• Ahitra/Anana: 10%\n• CMV: 5%\n\n🌿 Ahitra ilaina be';
    } else if (type == 'Vorontsiloza') {
      if (week <= 4) {
        gPerBird = 60;
      } else if (week <= 12) {
        gPerBird = 180;
      } else {
        gPerBird = 350;
      }
      waterMl = 500;

      stageLabel = week <= 4 ? 'Démarrage' : (week <= 12 ? 'Croissance' : 'Finition');
      currentFormula = '• 🦃 Katsaka: 48%\n• Faikan-tsoja (Tourteau Soja): 28%\n• Apombo-bary (Son de Blé): 12%\n• Vovo-trondro (Farine de Poisson): 7%\n• CMV: 5%\n\n⚠️ Mila protéine be';
    } else if (type == 'VorontsilozaChair') {
      // Dinde à chair - Engraissement intensif
      if (week <= 4) {
        gPerBird = 80;
      } else if (week <= 8) {
        gPerBird = 200;
      } else if (week <= 14) {
        gPerBird = 400;
      } else {
        gPerBird = 500;
      }
      waterMl = 700;

      stageLabel = week <= 4 ? 'Démarrage' : (week <= 8 ? 'Croissance' : 'Finition');
      currentFormula = '• 🦃 VORONTSILOZA CHAIR:\n\n📍 Démarrage (0-4 sem):\n  Protéine: 28%\n  Katsaka: 45%, Soja: 30%\n\n📍 Croissance (5-8 sem):\n  Protéine: 24%\n  Katsaka: 50%, Soja: 25%\n\n📍 Finition (9-16 sem):\n  Protéine: 18%\n  Katsaka: 60%, Soja: 15%\n\n🎯 Lanja vonjena:\n  • Lahy: 12-18 kg (16-20 sem)\n  • Vavy: 8-10 kg (14-16 sem)';
    } else if (type == 'Akanga') {
      if (week <= 6) {
        gPerBird = 35;
      } else if (week <= 14) {
        gPerBird = 80;
      } else {
        gPerBird = 120;
      }
      waterMl = 250;

      stageLabel = week <= 6 ? 'Démarrage' : (week <= 14 ? 'Croissance' : 'Adulte');
      currentFormula = '• 🐓 Katsaka: 50%\n• Faikan-tsoja (Tourteau Soja): 22%\n• Apombo-bary (Son de Blé): 18%\n• Vovo-trondro (Farine de Poisson): 5%\n• CMV: 5%';
    } else if (type == 'Akohonala') {
      if (week <= 6) {
        gPerBird = 30;
      } else if (week <= 16) {
        gPerBird = 60;
      } else {
        gPerBird = 90;
      }
      waterMl = 200;

      stageLabel = week <= 6 ? 'Démarrage' : (week <= 16 ? 'Croissance' : 'Adulte');
      currentFormula = '• 🦚 Katsaka: 45%\n• Faikan-tsoja (Tourteau Soja): 25%\n• Apombo-bary (Son de Blé): 20%\n• Vovo-trondro (Farine de Poisson): 5%\n• CMV: 5%\n\n🪶 Ilaina vitamines ho an\'ny volom-borona';
    } else if (type == 'Papelika') {
      if (week <= 3) {
        gPerBird = 8;
      } else if (week <= 6) {
        gPerBird = 18;
      } else {
        gPerBird = 25;
      }
      waterMl = 50;

      stageLabel = week <= 3 ? 'Démarrage' : (week <= 6 ? 'Croissance' : 'Ponte/Adulte');
      currentFormula = '• 🐦 Katsaka: 48%\n• Faikan-tsoja (Tourteau Soja): 30%\n• Apombo-bary (Son de Blé): 12%\n• Vovo-trondro (Farine de Poisson): 5%\n• CMV: 5%\n\n🥚 Protéine avo ho an\'ny atody';
    } else if (type == 'Bitro') {
      if (week <= 4) {
        gPerBird = 50;
      } else if (week <= 12) {
        gPerBird = 120;
      } else {
        gPerBird = 150;
      }
      waterMl = 300;

      stageLabel = week <= 4 ? 'Zaza (0-4 herinandro)' : (week <= 12 ? 'Mitombo (5-12 herinandro)' : 'Lehibe');
      currentFormula = '• 🐇 BITRO - Sakafo isan\'andro:\n\n🥬 Hay (Foin): 70% - Ilaina mandrakariva\n🥕 Anana sy Legioma: 20%\n   - Karaoty, Salady, Petsay\n   - Ravina voasary, Anamalaho\n🌾 Granulés Lapin: 10%\n\n⚠️ Aza omena: Saonjo, Ovy, Voatabia, Vary';
    } else if (type == 'BitroVolavo') {
      if (week <= 4) {
        gPerBird = 30;
      } else if (week <= 8) {
        gPerBird = 60;
      } else {
        gPerBird = 80;
      }
      waterMl = 150;

      stageLabel = week <= 4 ? 'Zaza' : (week <= 8 ? 'Mitombo' : 'Lehibe');
      currentFormula = '• 🐹 BITRO VOALAVO - Sakafo isan\'andro:\n\n🥬 Hay (Foin): 60% - Ilaina mandrakariva\n🥬 Anana maitso: 30%\n   - Petsay, Salady, Anamalaho\n   - Karaoty, Voatavo\n🍊 Vitamina C: Voasary, Tongolo mena\n🌾 Granulés: 10%\n\n⚠️ Mila Vitamina C isan\'andro!';
    }

    return FeedCalcResult(
      stageLabel: stageLabel,
      formula: 'Dingana: $stageLabel\n\nFangaro (100kg):\n$currentFormula',
      gPerBird: gPerBird,
      waterMl: waterMl,
    );
  }

  List<Widget> _buildSegmentInputs() {
    final stages = _getStages();
    return _segments.asMap().entries.map((entry) {
      final idx = entry.key;
      final seg = entry.value;
      return Container(
        margin: const EdgeInsets.only(bottom: 16),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(20),
          border: Border.all(color: AppColors.primary.withValues(alpha: 0.2)),
          boxShadow: [
            BoxShadow(
              color: Colors.black.withValues(alpha: 0.05),
              blurRadius: 10,
              offset: const Offset(0, 4),
            ),
          ],
        ),
        child: Column(
          children: [
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
              decoration: BoxDecoration(
                color: AppColors.primary.withValues(alpha: 0.1),
                borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
              ),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Flexible(
                    child: Row(
                      children: [
                        Container(
                          padding: const EdgeInsets.all(6),
                          decoration: const BoxDecoration(
                            color: Colors.white,
                            shape: BoxShape.circle,
                          ),
                          child: Text('${idx + 1}', style: const TextStyle(fontWeight: FontWeight.bold, color: AppColors.primary)),
                        ),
                        const SizedBox(width: 10),
                        Flexible(
                          child: Text(
                            'Dingana ${idx + 1}',
                            style: const TextStyle(
                              fontWeight: FontWeight.bold,
                              color: AppColors.primary,
                              fontSize: 16,
                            ),
                            overflow: TextOverflow.ellipsis,
                          ),
                        ),
                      ],
                    ),
                  ),
                  if (_segments.length > 1)
                    IconButton(
                      icon: const Icon(Icons.delete_outline, color: Colors.red),
                      onPressed: () => setState(() {
                        final removed = _segments.removeAt(idx);
                        removed.weekController.dispose();
                        removed.countController.dispose();
                      }),
                      tooltip: 'Fafana',
                    ),
                ],
              ),
            ),
            Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                children: [
                  DropdownButtonFormField<String>(
                    key: ValueKey(seg.stage),
                    initialValue: seg.stage,
                    isExpanded: true,
                    items: stages.map((s) => DropdownMenuItem(value: s, child: Text(s))).toList(),
                    onChanged: (v) => setState(() {
                      if (v != null) {
                        seg.stage = v;
                        seg.week = _autoWeekForStage(v);
                        seg.weekController.text = seg.week;
                        if (idx == 0) _selectedStage = v;
                      }
                    }),
                    decoration: InputDecoration(
                      labelText: 'Dingana (Stade)',
                      prefixIcon: const Icon(Icons.timeline, color: AppColors.primary),
                      border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
                    ),
                  ),
                  const SizedBox(height: 12),
                  Row(
                    children: [
                      Expanded(
                        child: TextField(
                          controller: seg.weekController,
                          keyboardType: TextInputType.number,
                          decoration: InputDecoration(
                            labelText: 'Herinandro',
                            prefixIcon: const Icon(Icons.calendar_today, size: 18, color: AppColors.primary),
                            border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
                          ),
                          onChanged: (v) => seg.week = v,
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: TextField(
                          controller: seg.countController,
                          keyboardType: TextInputType.number,
                          decoration: InputDecoration(
                            labelText: 'Isany (Tête)',
                            prefixIcon: const Icon(Icons.numbers, size: 18, color: AppColors.primary),
                            border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
                          ),
                          onChanged: (v) => seg.count = v,
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
          ],
        ),
      );
    }).toList();
  }

  String _autoWeekForStage(String stage) {
    if (_type == 'Chair') {
      if (stage == 'Démarrage') return '1';
      if (stage == 'Croissance') return '4';
      if (stage == 'Finition') return '6';
    } else if (_type == 'Pondeuse') {
      if (stage == 'Démarrage') return '1';
      if (stage == 'Croissance') return '9';
      if (stage == 'Ponte') return '19';
    } else if (_type == 'Mpiady') {
      if (stage == 'Démarrage') return '1';
      if (stage == 'Croissance') return '9';
      if (stage == 'Ady') return '24';
    } else {
      if (stage == 'Démarrage') return '1';
      if (stage == 'Croissance') return '9';
      if (stage == 'Adulte' || stage == 'Ponte') return '20';
    }
    return '1';
  }

  Widget _buildCollationItem(String emoji, String title, String description) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 10),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(emoji, style: const TextStyle(fontSize: 24)),
          const SizedBox(width: 10),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                Text(description, style: TextStyle(fontSize: 12, color: Colors.grey.shade700)),
              ],
            ),
          ),
        ],
      ),
    );
  }

  @override
  void dispose() {
    for (final segment in _segments) {
      segment.weekController.dispose();
      segment.countController.dispose();
    }
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: const BoxDecoration(
        gradient: LinearGradient(
          colors: [Color(0xFFE8F5E9), Color(0xFFF9FFF6)],
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
        ),
      ),
      child: SafeArea(
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(16),
          child: Column(
            children: [
              _buildFeedHeader(),
              const SizedBox(height: 16),
              _buildCard(
                title: 'Kajy Fatra Sakafo',
                child: Column(
                  children: [
                    DropdownButtonFormField(
                      initialValue: _type,
                      items: ['Chair', 'Pondeuse', 'Ornement', 'Nain', 'Mpiady', 'Gana', 'Dokotra', 'Sarindokotra', 'Gisa', 'Vorontsiloza', 'VorontsilozaChair', 'Akanga', 'Akohonala', 'Papelika', 'Bitro', 'BitroVolavo'].map((v) {
                        String label = v;
                        if (v == 'Bitro') label = '🐇 Bitro (Lapin)';
                        if (v == 'BitroVolavo') label = '🐹 Bitro Voalavo';
                        if (v == 'Sarindokotra') label = '🦆 Sarindokotra (Mulard)';
                        if (v == 'VorontsilozaChair') label = '🦃 Vorontsiloza Chair';
                        return DropdownMenuItem(value: v, child: Text(label));
                      }).toList(),
                      onChanged: (v) => setState(() {
                        _type = v!;
                        _selectedStage = 'Démarrage';
                        for (final seg in _segments) {
                          seg.stage = 'Démarrage';
                          seg.week = _autoWeekForStage('Démarrage');
                          seg.weekController.text = seg.week;
                        }
                      }),
                      decoration: const InputDecoration(labelText: 'Karazana'),
                    ),
                    const SizedBox(height: 12),
                    ..._buildSegmentInputs(),
                    const SizedBox(height: 8),
                    InkWell(
                      onTap: () {
                        setState(() {
                          _segments.add(_FeedSegment(stage: _getStages().first, week: _autoWeekForStage(_getStages().first), count: '0'));
                        });
                      },
                      borderRadius: BorderRadius.circular(12),
                      child: Container(
                        width: double.infinity,
                        padding: const EdgeInsets.symmetric(vertical: 12),
                        decoration: BoxDecoration(
                          border: Border.all(color: AppColors.primary.withValues(alpha: 0.5), style: BorderStyle.solid),
                          borderRadius: BorderRadius.circular(12),
                          color: AppColors.primary.withValues(alpha: 0.05),
                        ),
                        child: const Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(Icons.add_circle_outline, color: AppColors.primary),
                            SizedBox(width: 8),
                            Text('Hanampy dingana hafa', style: TextStyle(color: AppColors.primary, fontWeight: FontWeight.w600)),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 8),
                    ElevatedButton(
                      onPressed: _calculateFeed,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: AppColors.primary,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                        elevation: 4,
                        shadowColor: AppColors.primary.withValues(alpha: 0.4),
                      ),
                      child: const Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(Icons.calculate, size: 28),
                          SizedBox(width: 10),
                          Text('KAJY SAKAFO', style: TextStyle(fontSize: 18, letterSpacing: 1, fontWeight: FontWeight.w800)),
                        ],
                      ),
                    ),
                    const SizedBox(height: 12),
                    TextButton.icon(
                      onPressed: _showIngredientsInfo,
                      icon: const Icon(Icons.menu_book, color: AppColors.primary),
                      label: const Text('LISITRA FENO NY AKORA (Ingrédients)', style: TextStyle(fontWeight: FontWeight.bold)),
                    ),
                  ],
                ),
              ),
              if (_feedResult.isNotEmpty) ...[
                const SizedBox(height: 20),
                _buildCard(
                  title: 'Tombana isan\'andro',
                  child: Container(
                    width: double.infinity,
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: Colors.green.shade50,
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: Colors.green.shade100),
                    ),
                    child: Text(_feedResult, style: const TextStyle(fontSize: 15, height: 1.6, color: Colors.black87)),
                  ),
                ),
                const SizedBox(height: 20),
                _buildCard(
                  title: 'Formule Provandy',
                  child: Container(
                    width: double.infinity,
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: Colors.orange.shade50,
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: Colors.orange.shade100),
                    ),
                    child: Text(_formula, style: const TextStyle(fontSize: 15, height: 1.6, color: Colors.black87)),
                  ),
                ),
                const SizedBox(height: 20),
                _buildCard(
                  title: '🌿 Fanampitsakafo Hafa (Collations)',
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('Ireto ny sakafo hafa azo omena ankoatra ny provandy:', style: TextStyle(fontWeight: FontWeight.bold)),
                      const SizedBox(height: 12),
                      _buildCollationItem('🪱', 'Larve BSF (Black Soldier Fly)', 'Protéine avo (40-45%). Omena 5-10% ny lanjan\'ny sakafo. Sasao tsara alohan\'ny fanomezana.'),
                      _buildCollationItem('🐛', 'Kankana lafarinina (Ver de farine)', 'Protéine 50%+. Tsara ho an\'ny zana-borona sy mpiady. Sasao sy avelao hihantra aloha.'),
                      _buildCollationItem('🥬', 'Anana (Ravina)', 'Vitamines A, C, K. Ohatra: Anamalaho, Anamamy, Petsay, Salady. Tetehina madinika.'),
                      _buildCollationItem('🎃', 'Voatavo sy voa', 'Vitamines sy mineraly. Voa papay = vermifuge voajanahary.'),
                      _buildCollationItem('🍺', 'Dresy (Drêche de bière)', 'Protéine 25-30%, fibre be. Sisa avy amin\'ny labiera. Hatsaraina amin\'ny masoandro aloha.'),
                      _buildCollationItem('🍚', 'Vary masaka', 'Energie be. Omena mangatsiaka na mafana kely. Tsara ho an\'ny fotoana hatsiaka.'),
                      _buildCollationItem('🌾', 'Tsaramaso, Voanjo', 'Carbohydrates sy protéine. Masaho aloha ho an\'ny tsaramaso.'),
                      _buildCollationItem('🦴', 'Taolana sy akorandriaka', 'Calcium ho an\'ny mpanatody. Torotorory madinika.'),
                      _buildCollationItem('🐚', 'Akoram-biby ranomasina', 'Calcium avo. Ilaina indrindra amin\'ny fotoana fanatodizana.'),
                      _buildCollationItem('🍎', 'Voankazo', 'Vitamines sy rano. Ohatra: Paiso, Papay, Mangahazo masaka.'),
                      const Divider(height: 24),
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.orange.shade50,
                          borderRadius: BorderRadius.circular(8),
                          border: Border.all(color: Colors.orange.shade200),
                        ),
                        child: const Row(
                          children: [
                            Text('⚠️', style: TextStyle(fontSize: 20)),
                            SizedBox(width: 8),
                            Expanded(child: Text('Sasao tsara ny kankana sy larve alohan\'ny fanomezana. Aza omena sakafo lo na simba.', style: TextStyle(fontSize: 13, color: Colors.orange))),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              ]
            ],
          ),
        ),
      ),
    );
  }

  void _showIngredientsInfo() {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => Container(
        height: MediaQuery.of(context).size.height * 0.85,
        decoration: const BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
        ),
        child: Column(
          children: [
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.grey[100],
                borderRadius: const BorderRadius.vertical(top: Radius.circular(24)),
              ),
              child: Row(
                children: [
                  const Icon(Icons.menu_book, color: AppColors.primary),
                  const SizedBox(width: 12),
                  const Expanded(child: Text('LISITRA FENO NY AKORA', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold))),
                  IconButton(icon: const Icon(Icons.close), onPressed: () => Navigator.pop(context)),
                ],
              ),
            ),
            Expanded(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _buildIngredientSection('1. IREO FAHANA MITONDRA ANGOVO (Sources d\'Énergie)', 
                      'Ireo no manome hery ny biby, ary matetika mandrafitra ny ampahany lehibe indrindra (50-70%) amin\'ny fangaro.',
                      [
                        {'name': 'Katsaka (Maïs)', 'desc': 'Ny akora fototra tsara indrindra. Izy no manome angovo betsaka indrindra.'},
                        {'name': 'Vovo-mangahazo (Farine de Manioc)', 'desc': 'Mangahazo maina (cossettes) nototoina. Solon\'ny katsaka tsara indrindra rehefa lafo ny katsaka, saingy tadidio fa kely dia kely ny Protéine ao anatiny (mila ampiana Soja na Trondro ny fatra rehefa mampiasa an\'ity).'},
                        {'name': 'Tavim-bary (Son de Riz)', 'desc': 'Ilay hoditry ny vary manify (misy vitamina B).\n\n⚠️ Fanamarihana: Ialao ny Akofa (Balle de riz) fa tsy levon\'ny biby io ary mety handratra tsinay.'},
                        {'name': 'Apombo-bary (Son de Blé)', 'desc': 'Avy amin\'ny orinasa fikosoham-bary (Minoterie). Tsara ho an\'ny fandevonan-kanina.'},
                      ]
                    ),
                    _buildIngredientSection('2. IREO FAHANA MITONDRA PROTÉINE (Sources de Protéines)', 
                      'Ireo no mampitombo ny nofon\'ny biby sy ny fitomboany.',
                      [
                        {'name': 'Faika-labiera (Drêche de Bière)', 'desc': 'Inona izy: Faikany sisa tavela tamin\'ny fanamboarana labiera (Vary orza sy katsaka efa masaka).\n\nTombony: Tena tsara ho an\'ny biby mampinono (kisoa vavy, omby) ary loharano protéine tsara. Azo ampiasaina lena na maina.'},
                        {'name': 'Faika-lentille na Kary (Sous-produits de Lentilles)', 'desc': 'Inona izy: Ireo faikan\'ny lentille (vaky, madinika, hodiny) avy any amin\'ny faritra Menabe.\n\nTombony: Sady mitondra Protéine no mitondra Angovo. Tena tsara ho an\'ny kisoa sy akoho.'},
                        {'name': 'Faikan-tsoja (Tourteau de Soja)', 'desc': 'Ny "mpanjaka" amin\'ny protéine zavamaniry. Matetika hafarana (importé) fa misy ihany koa ny vokatra eto an-toerana.'},
                        {'name': 'Faikam-boanjo (Tourteau d\'Arachide)', 'desc': 'Ny sisa tavela rehefa nalaivon-diloilo ny voanjo.'},
                        {'name': 'Vovo-trondro (Farine de Poisson)', 'desc': 'Kapalo (crevettes séchées) na trondro madinika nototoina. Tena ilaina ho an\'ny kisoa kely sy akoho kely.'},
                      ]
                    ),
                    _buildIngredientSection('3. IREO FAHANA MITONDRA MINERALY (Sources de Minéraux)', 
                      'Ireo no manamafy ny taolana sy ny akoran\'atody.',
                      [
                        {'name': 'Lao-akorantsely (Farine de Coquille d\'Huître)', 'desc': 'Akorandriaka nototoina ho vovoka. Loharano Calcium fototra.'},
                        {'name': 'Lao-taolana (Farine d\'Os)', 'desc': 'Taolam-biby nodorana sy nototoina. Loharano Phosphore sy Calcium.'},
                      ]
                    ),
                    _buildIngredientSection('4. IREO FANAMPINY (Additifs)', 
                      'Tsy maintsy atao raha te hahazo vokatra tsara sy haingana.',
                      [
                        {'name': 'CMV (Concentré Minéral Vitaminé)', 'desc': 'Vovoka kely (Prémix) misy ny otrikaina rehetra tsy ampy ao amin\'ny katsaka sy ny soja. Misy karazany io (Pondeuse, Chair, Porc).'},
                        {'name': 'Sira (Sel)', 'desc': 'Sira an-dakozia, hanokafana ny fahazotoan-komana.'},
                        {'name': 'Acides Aminés (Lysine / Méthionine)', 'desc': 'Vovoka manokana manampy ny fitomboana (matetika ho an\'ny fiompiana matihanina).'},
                      ]
                    ),
                    const Divider(height: 30, thickness: 2),
                    const Text('FAMINTINANA NY TENY TEKNIKA', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: AppColors.primary)),
                    const SizedBox(height: 10),
                    _buildDefinition('Vovony (Farine)', 'Entina ilazana zavatra maina nototoina ho vovoka (Ex: Lao-mangahazo, Lao-trondro).'),
                    _buildDefinition('Faikany (Tourteau)', 'Entina ilazana ny sisa tavela rehefa nalaina ny menaka (Ex: faikana soja, faikam-boanjo).'),
                    _buildDefinition('FAIKANY (Résidu / Drêche)', 'Entina ilazana ny sisa tavela rehefa nalaina ny ranony na ny votoatiny hafa (Ex: Faika-labiera, Faika-lentille).'),
                    _buildDefinition('Apombo (Son)', 'Entina ilazana ny hodiny (Ex: apombom bary).'),
                    const SizedBox(height: 30),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildIngredientSection(String title, String subtitle, List<Map<String, String>> items) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const SizedBox(height: 20),
        Text(title, style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: AppColors.accent)),
        const SizedBox(height: 4),
        Text(subtitle, style: const TextStyle(fontSize: 13, fontStyle: FontStyle.italic, color: Colors.grey)),
        const SizedBox(height: 12),
        ...items.map((item) => Container(
          margin: const EdgeInsets.only(bottom: 12),
          padding: const EdgeInsets.all(12),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: Colors.grey.shade200),
            boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.03), blurRadius: 5, offset: const Offset(0, 2))],
          ),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(item['name']!, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 15)),
              const SizedBox(height: 6),
              Text(item['desc']!, style: const TextStyle(fontSize: 13, height: 1.4)),
            ],
          ),
        )),
      ],
    );
  }

  Widget _buildDefinition(String term, String def) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: RichText(
        text: TextSpan(
          style: const TextStyle(color: Colors.black87, fontSize: 13),
          children: [
            TextSpan(text: '• $term: ', style: const TextStyle(fontWeight: FontWeight.bold)),
            TextSpan(text: def),
          ],
        ),
      ),
    );
  }

  Widget _buildFeedHeader() {
    final typeLabel = {
      'Chair': 'Akoho fatra haingana',
      'Pondeuse': 'Akoho mpanatody',
      'Ornement': 'Ornement/Haingo',
      'Nain': 'Karazana kely',
      'Mpiady': 'Akoho mpiady',
      'Gana': 'Gana',
      'Dokotra': 'Dokotra',
      'Gisa': 'Gisa',
      'Vorontsiloza': 'Vorontsiloza',
      'Akanga': 'Akanga',
      'Akohonala': 'Akohonala',
      'Papelika': 'Papelika',
      'Bitro': 'Bitro',
      'BitroVolavo': 'Bitro Voalavo',
    }[_type] ?? _type;

    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: const LinearGradient(
          colors: [Color(0xFF1B5E20), Color(0xFF43A047)],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(24),
        boxShadow: [
          BoxShadow(
            color: Colors.green.withValues(alpha: 0.3),
            blurRadius: 20,
            offset: const Offset(0, 10),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                padding: const EdgeInsets.all(14),
                decoration: BoxDecoration(
                  color: Colors.white.withValues(alpha: 0.2),
                  borderRadius: BorderRadius.circular(16),
                ),
                child: const Text('🥕', style: TextStyle(fontSize: 32)),
              ),
              const SizedBox(width: 16),
              const Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Sakafo & Kajy',
                      style: TextStyle(color: Colors.white, fontSize: 22, fontWeight: FontWeight.bold),
                    ),
                    Text(
                      'Kajy haingana sy marina',
                      style: TextStyle(color: Colors.white70, fontSize: 14),
                    ),
                  ],
                ),
              ),
            ],
          ),
          const SizedBox(height: 20),
          Wrap(
            spacing: 8,
            runSpacing: 8,
            children: [
              _buildHeaderChip(typeLabel, Icons.pets),
              _buildHeaderChip('Dingana: $_selectedStage', Icons.timeline),
              _buildHeaderChip('${_segments.length} dingana', Icons.layers),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildHeaderChip(String label, IconData icon) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
      decoration: BoxDecoration(
        color: Colors.white.withValues(alpha: 0.15),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.white.withValues(alpha: 0.2)),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, color: Colors.white, size: 14),
          const SizedBox(width: 6),
          Text(label, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600, fontSize: 13)),
        ],
      ),
    );
  }
}// --- MODULE 3: FAHASALAMANA (HEALTH) ---
class Disease {
  final String name;
  final String description;
  final String symptoms;
  final String treatment;
  final String naturalRemedy;
  final String actions;
  final String prophylaxis;

  Disease({
    required this.name,
    required this.description,
    required this.symptoms,
    required this.treatment,
    required this.naturalRemedy,
    required this.actions,
    required this.prophylaxis,
  });
}

class _FeedSegment {
  String stage;
  String week;
  String count;
  late final TextEditingController weekController;
  late final TextEditingController countController;

  _FeedSegment({required this.stage, required this.week, required this.count}) {
    weekController = TextEditingController(text: week);
    countController = TextEditingController(text: count);
  }
}

class FeedCalcResult {
  final String stageLabel;
  final String formula;
  final double gPerBird;
  final double waterMl;

  FeedCalcResult({required this.stageLabel, required this.formula, required this.gPerBird, required this.waterMl});
}

// =============================================================
// VIDINY MATIÈRES PREMIÈRES PROVENDE - JANVIER 2025
// =============================================================
// Azo ampiasaina hamokarana provende manokana
const Map<String, Map<String, dynamic>> prixMatieresPremieresProvende = {
  'katsaka': {
    'nom': 'Katsaka (Maïs grain)',
    'prix_kg': 2200, // 2,100-2,300 Ar/kg
    'unite': 'Ar/kg',
    'note': 'Ingrédient principal (50-60%)',
  },
  'tourteau_soja': {
    'nom': 'Tourteau de Soja',
    'prix_kg': 3500, // ~3,500 Ar/kg
    'unite': 'Ar/kg',
    'note': 'Protéine végétale (15-30%)',
  },
  'tourteau_arachide': {
    'nom': 'Tourteau d\'Arachide',
    'prix_kg': 2000, // ~2,000 Ar/kg
    'unite': 'Ar/kg',
    'note': 'Alternative soja, moins cher',
  },
  'son_ble_melange': {
    'nom': 'Son de Blé mélange (Apombo)',
    'prix_kg': 900, // ~900 Ar/kg
    'unite': 'Ar/kg',
    'note': 'Fibre et énergie (10-25%)',
  },
  'son_ble_2eme': {
    'nom': 'Son de Blé 2ème qualité',
    'prix_kg': 1100, // ~1,100 Ar/kg
    'unite': 'Ar/kg',
    'note': 'Qualité supérieure',
  },
  'son_riz': {
    'nom': 'Son de Riz (Apombo vary)',
    'prix_kg': 800, // Estimé ~800 Ar/kg
    'unite': 'Ar/kg',
    'note': 'Sous-produit riz, économique',
  },
  'farine_poisson': {
    'nom': 'Farine de Poisson',
    'prix_kg': 6000, // ~6,000 Ar/kg
    'unite': 'Ar/kg',
    'note': 'Protéine animale (2-8%)',
  },
  'coquille_huitre': {
    'nom': 'Coquille d\'huître broyée',
    'prix_kg': 1500, // ~1,500 Ar/kg
    'unite': 'Ar/kg',
    'note': 'Calcium pondeuse (5-8%)',
  },
  'cmv': {
    'nom': 'CMV (Complément Minéral Vitaminé)',
    'prix_kg': 12000, // ~12,000 Ar/kg
    'unite': 'Ar/kg',
    'note': 'Vitamines et minéraux (2-5%)',
  },
  'sel': {
    'nom': 'Sel iodé',
    'prix_kg': 2500, // ~2,500 Ar/kg
    'unite': 'Ar/kg',
    'note': 'Oligo-éléments (0.3-0.5%)',
  },
  'huile_vegetale': {
    'nom': 'Huile végétale',
    'prix_l': 10000, // ~10,000 Ar/L
    'unite': 'Ar/L',
    'note': 'Énergie, plumage (1-3%)',
  },
};

// Fonction helper pour calculer le coût d'une formule provende
double calculerCoutProvende100kg(Map<String, double> pourcentages) {
  double coutTotal = 0;
  pourcentages.forEach((ingredient, pourcentage) {
    if (prixMatieresPremieresProvende.containsKey(ingredient)) {
      final prixKg = prixMatieresPremieresProvende[ingredient]!['prix_kg'] as int? ?? 
                     prixMatieresPremieresProvende[ingredient]!['prix_l'] as int? ?? 0;
      coutTotal += (pourcentage / 100) * 100 * prixKg; // Pour 100kg
    }
  });
  return coutTotal;
}

class HealthScreen extends StatefulWidget {
  const HealthScreen({super.key});

  @override
  State<HealthScreen> createState() => _HealthScreenState();
}

class _HealthScreenState extends State<HealthScreen> with SingleTickerProviderStateMixin {
  late TabController _tabController;
  DateTime? _startDate;
  List<Map<String, String>> _schedule = [];
  String _type = 'Chair';

  final List<Disease> _diseases = [
    Disease(
      name: 'Pesta (Newcastle)',
      description: 'Aretina vokatry ny virus, mpahazo ny taovam-pisefoana sy ny rafi-pitatitra. Tena mahery vaika ary moram-pifindra.',
      symptoms: '• Tsy homan-kanina, mivontso ny loha\n• Mivalana maitso\n• Manolana ny tendany (Torticolis)\n• Maty tampoka ny akoho maro',
      treatment: 'Tsy misy fanafody manasitrana satria virus. \n• Omena Vitamine (C, E) hanamafisana ny hery fiarovana.\n• Antibiotique (Oxytetracycline) hiadiana amin\'ny aretina hafa manararaotra.',
      naturalRemedy: '• Tongolo gasy + Voasary makirana (fiarovana)\n• Ravina kininina (fampitoniana)',
      actions: '• Atokana avy hatrany ny marary\n• Dorana ny maty\n• Tsy azo amidy na hanina ny hena',
      prophylaxis: '• Vaksiny (HB1 amin\'ny J-6, Lasota amin\'ny J-21)\n• Fahadiovana tanteraka',
    ),
    Disease(
      name: 'Gumboro',
      description: 'Aretina virus mamely ny hery fiarovana (Bourse de Fabricius). Matetika mpahazo ny akoho tanora (3-6 herinandro).',
      symptoms: '• Mivalana fotsy dity\n• Mangovitra, mitangorona\n• Mianjera ny elatra (Prostration)\n• Maro ny maty (hatramin\'ny 30%)',
      treatment: 'Tsy misy fanafody manokana.\n• Hepatoprotector (fiarovana aty)\n• Vitamine K3 (miady amin\'ny rà mandeha)\n• Paracetamol (fanaviana)',
      naturalRemedy: '• Rano misy siramamy sy sira (Sérum)\n• Dite mainty mahery',
      actions: '• Hafanaina tsara ny trano\n• Omena rano madio matetika',
      prophylaxis: '• Vaksiny Gumboro (J-12, J-18)\n• Fanadiovana ifotony ny trano (Désinfection)',
    ),
    Disease(
      name: 'Kokisidiosy (Coccidiose)',
      description: 'Aretina vokatry ny katsentsitra (parasite) ao amin\'ny tsinay. Mpahazo ny akoho amin\'ny fotoana rehetra, indrindra raha mando ny trano.',
      symptoms: '• Mivalana rà na mivalana mena\n• Malain-komana, mitokantokana\n• Volom-borona mikorontana',
      treatment: '• Anticoccidien (Sulfamides, Amprolium)\n• Vitamine K (hampijanona ny rà)',
      naturalRemedy: '• Ravina Papay (tetehina na ampangotrahina)\n• Aloès (Vahona) amin\'ny rano\n• Sakamalaho',
      actions: '• Soloina ny lafika mando\n• Tsy atao mifanizina loatra ny akoho',
      prophylaxis: '• Lafika maina hatrany\n• Anticoccidien préventif amin\'ny sakafo',
    ),
    Disease(
      name: 'Sery (Coryza)',
      description: 'Aretina bakteria mpahazo ny taovam-pisefoana ambony. Matetika vokatry ny hatsiaka na rivotra maloto.',
      symptoms: '• Mivonto ny tarehy sy ny maso\n• Misy ranon-delo maimbo\n• Mievina sy mikohaka\n• Tsy mahita tsara ny akoho',
      treatment: '• Antibiotique (Erythromycine, Tylosine, Oxytetracycline)\n• Fanadiovana ny maso amin\'ny rano matimaty',
      naturalRemedy: '• Sakamalaho + Tongolo gasy + Tantely\n• Fampifohana etona kininina (Inhalation)',
      actions: '• Hatsaraina ny rivotra (Ventilation)\n• Sorohina ny tso-drivotra mivantana',
      prophylaxis: '• Trano mafana tsara\n• Tsy atao be vovoka ny lafika',
    ),
    Disease(
      name: 'Kolera (Choléra Aviaire)',
      description: 'Aretina bakteria mahery vaika (Pasteurella). Mety hamono akoho maro ao anatin\'ny fotoana fohy.',
      symptoms: '• Maty tampoka tsy hita soritr\'aretina\n• Mivonto sy manga ny sanga (Crête)\n• Mivalana maitso na mavo\n• Kivy be ny akoho',
      treatment: '• Sulfamides\n• Antibiotique (Tétracyclines, Fluoroquinolones)',
      naturalRemedy: '• Tsy dia misy mandaitra maika, fa ny tongolo gasy dia manampy amin\'ny fisorohana',
      actions: '• Dorana ny faty\n• Fanadiovana tanteraka ny fitaovana',
      prophylaxis: '• Vaksiny (raha misy atahorana)\n• Fiarovana ny trano tsy hidiran\'ny biby hafa',
    ),
    Disease(
      name: 'Bikitra (Variole Aviaire)',
      description: 'Aretina virus mampisy fery na "Bikitra" amin\'ny vatana. Miparitaka amin\'ny alalan\'ny moka.',
      symptoms: '• Misy fery (boutons) amin\'ny sanga, maso, ary tongotra\n• Mety hisy fery any am-bava (Diphterie) manakana ny fihinanana',
      treatment: '• Hosorana Betadine na Iodine ny fery\n• Omena Vitamine A hanampy ny hoditra',
      naturalRemedy: '• Menaka sy Tamotamo (Curcuma) ahosotra amin\'ny fery\n• Ravina Voandelaka (Neem)',
      actions: '• Ady amin\'ny moka\n• Atokana ny marary',
      prophylaxis: '• Vaksiny Variole (tsindrona elatra)\n• Fandrarahana fanafody moka',
    ),
    Disease(
      name: 'Kankana (Vers)',
      description: 'Katsentsitra anaty (Ascaris, Tenia) izay mihinana ny otrikaina tokony ho an\'ny akoho.',
      symptoms: '• Mahia ny akoho nefa homana ihany\n• Mivalana, indraindray misy kankana\n• Hatsatra ny sanga\n• Mihena ny atody',
      treatment: '• Vermifuge (Levamisole, Piperazine, Albendazole)',
      naturalRemedy: '• Voa-na Papay (maina sy totoina)\n• Tongolo gasy\n• Voatavo (voany)',
      actions: '• Fanadiovana ny trano isan\'andro\n• Tsy avela hihinana maloto',
      prophylaxis: '• Fanaovana Vermifuge isaky ny 2-3 volana',
    ),
    Disease(
      name: 'Salmonella (Typhose)',
      description: 'Bakteria mety hamindra amin\'ny olona koa. Mampidi-doza ho an\'ny zanak\'akoho (Pullorum).',
      symptoms: '• Mivalana fotsy (Zanak\'akoho)\n• Maty maro am-piandohana\n• Mivonto ny tonon-taolana (Arthrite)',
      treatment: '• Antibiotique (Enrofloxacine, Amoxicilline)',
      naturalRemedy: '• Vinaigre de cidre amin\'ny rano (manatsara ny pH)\n• Tongolo gasy',
      actions: '• Fitandremana fatratra ny fahadiovana\n• Tsy mikitika atody amin\'ny tanana maloto',
      prophylaxis: '• Fividianana zanak\'akoho salama\n• Fahadiovana (Hygiène)',
    ),
    Disease(
      name: 'CRD (Areti-mifoka)',
      description: 'Aretina mitaiza (Chronique) vokatry ny Mycoplasma. Matetika miaraka amin\'ny Coli.',
      symptoms: '• Mikorina (Râles) rehefa miaina\n• Mikohaka, indrindra amin\'ny alina\n• Mihena ny fitomboana',
      treatment: '• Tylosine, Spiramycine, Doxycycline',
      naturalRemedy: '• Ravina Kininina sy Sakamalaho (manampy ny fisefoana)\n• Tantely',
      actions: '• Ahena ny vovoka\n• Hatsaraina ny rivotra',
      prophylaxis: '• Fisorohana ny stress\n• Fiarovana biosecurity',
    ),
    Disease(
      name: 'Colibacillose (Coli)',
      description: 'Aretina vokatry ny E. Coli, matetika manararaotra rehefa maloto ny rano na ny tontolo.',
      symptoms: '• Mivonto ny foitra (Omphalite) amin\'ny kely\n• Misy fonony fotsy amin\'ny aty sy fo (Péricardite)\n• Mivalana',
      treatment: '• Antibiotique (Colistine, Enrofloxacine)',
      naturalRemedy: '• Probiotique (yaourt voajanahary)\n• Vinaigre amin\'ny rano',
      actions: '• Fanadiovana rano (Chloration)\n• Fanoloana lafika',
      prophylaxis: '• Rano madio hatrany\n• Fahadiovana ankapobeny',
    ),
    Disease(
      name: 'Mareka (Marek)',
      description: 'Virus mampisy fivontosana (tumeurs) sy paralysisa. Tsy misy fanafody.',
      symptoms: '• Malemy ny tongotra iray na elatra (Grand écart)\n• Mihena ny lanja\n• Mivonto ny maso (Marek oculaire)',
      treatment: 'TSY MISY FANAFODY.',
      naturalRemedy: 'Tsy misy.',
      actions: '• Vonoy avy hatrany ny marary mba tsy hamindra',
      prophylaxis: '• Vaksiny any amin\'ny foy (Couvoir) ihany no vahaolana tokana',
    ),
    Disease(
      name: 'Empona (Bronchite Infectieuse)',
      description: 'Virus mpahazo ny fisefoana sy ny taovam-pananahana (atody).',
      symptoms: '• Mievina, mikohaka\n• Atody miketrona na tsy misy akorany\n• Atody fotsy rano',
      treatment: 'Tsy misy fanafody manokana.\n• Antibiotique hisorohana ny aretina hafa\n• Vitamine',
      naturalRemedy: '• Inhalation (Kininina, Ravintsara)',
      actions: '• Hafanana tsara\n• Rivotra madio',
      prophylaxis: '• Vaksiny (H120, H52)',
    ),
    Disease(
      name: 'Aspergillose (Holatra)',
      description: 'Aretina vokatry ny holatra (Champignons) avy amin\'ny lafika mando na sakafo bobongolo.',
      symptoms: '• Sempotra, miaina mafy (Gasps)\n• Maso mivonto\n• Mety hisy fotsifotsy ao am-bava',
      treatment: '• Antifongique (Sulfate de Cuivre amin\'ny rano)\n• Tsy misy fanafody tena mahomby raha efa mafy',
      naturalRemedy: '• Tongolo gasy (Antifongique voajanahary)',
      actions: '• Soloina avy hatrany ny lafika\n• Ario ny sakafo bobongolo',
      prophylaxis: '• Lafika maina hatrany\n• Sakafo tsy misy hamandoana',
    ),
    Disease(
      name: 'Katsentsitra Ivelany (Poux/Acariens)',
      description: 'Bibikely kely (Ody, Koka) mitsentsitra rà sy manelingelina ny akoho.',
      symptoms: '• Mangidihidy, mikorontana ny volom-borona\n• Mihena ny atody\n• Mety ho faty raha be loatra (Anémie)',
      treatment: '• Poudre insecticide (Carbaryl, Perméthrine)\n• Ivermectine (Mitete amin\'ny hoditra)',
      naturalRemedy: '• Lavenona (Cendre) afangaro fasika hanaovana fandroana\n• Ravina Voandelaka (Neem)',
      actions: '• Diovina ny trano manontolo\n• Dorana ny lafika taloha',
      prophylaxis: '• Fandroana lavenona tsy tapaka\n• Fanadiovana matetika',
    ),
    Disease(
      name: 'Avitaminose (Tsy fahampian-tsakafo)',
      description: 'Aretina vokatry ny tsy fahampian\'ny Vitamine na Sira mineraly (Calcium, Phosphore).',
      symptoms: '• Malemy tongotra (Rachitisme)\n• Mipolilatra ny rantsan-tongotra (Paralysie)\n• Atody malemy akorany',
      treatment: '• Omena Complexe Vitaminé (AD3E, B-Complex)\n• Calcium sy Phosphore',
      naturalRemedy: '• Anana maitso (Vitamine)\n• Akorandriaka na Taolana nodorana (Calcium)',
      actions: '• Ahitsy ny fatran-tsakafo\n• Omena sakafo voalanjalanja',
      prophylaxis: '• Sakafo tsara kalitao mifanaraka amin\'ny taona',
    ),
  ];

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 2, vsync: this);
    _generateSchedule();
  }

  void _generateSchedule() {
    if (_startDate == null) return;
    List<Map<String, String>> list = [];
    
    // Logic based on animal type
    if (_type == 'Chair') {
      list.add({'day': 'J-0', 'act': 'Anti-stress + Hafanana 35°C'});
      list.add({'day': 'J-6', 'act': 'Vaksiny Pesta (HB1) - Rano 8L'});
      list.add({'day': 'J-12', 'act': 'Vaksiny Gumboro - Rano 12L'});
      list.add({'day': 'J-21', 'act': 'Vaksiny Pesta (Lasota) - Rano 20L'});
    } else if (_type == 'Sarindokotra') {
      // Mulard - Calendrier sanitaire
      list.add({'day': 'J-0', 'act': '🦆 Fahatongavana - Hafanana 30°C'});
      list.add({'day': 'J-3', 'act': 'Anti-stress + Vitamina'});
      list.add({'day': 'J-7', 'act': 'Vaksiny Hepatite virale'});
      list.add({'day': 'J-14', 'act': 'Vermifuge voalohany'});
      list.add({'day': 'J-21', 'act': 'Vaksiny Pasteurellose'});
      list.add({'day': 'J-60', 'act': 'Vermifuge faharoa'});
      list.add({'day': 'J-70', 'act': '🍽️ Fanombohana Gavage (Raha foie gras)'});
      list.add({'day': 'J-84', 'act': '🥩 Vonjena (12-14 herinandro)'});
    } else if (_type == 'VorontsilozaChair') {
      // Dinde à chair - Calendrier sanitaire
      list.add({'day': 'J-0', 'act': '🦃 Fahatongavana - Hafanana 35°C'});
      list.add({'day': 'J-1', 'act': 'Vaksiny TRT (Rhinotrachéite)'});
      list.add({'day': 'J-7', 'act': 'Vaksiny Newcastle + Anti-stress'});
      list.add({'day': 'J-14', 'act': 'Vermifuge voalohany'});
      list.add({'day': 'J-21', 'act': 'Vaksiny Newcastle (Rappel)'});
      list.add({'day': 'J-35', 'act': 'Vaksiny Variole Dindon'});
      list.add({'day': 'J-60', 'act': 'Vermifuge faharoa'});
      list.add({'day': 'J-90', 'act': 'Vermifuge + Fitsirihana lanja'});
      list.add({'day': 'J-112', 'act': '🥩 Vonjena vavy (16 herinandro, 8-10kg)'});
      list.add({'day': 'J-140', 'act': '🥩 Vonjena lahy (20 herinandro, 12-18kg)'});
    } else if (_type == 'Bitro') {
      // Lapin - Calendrier sanitaire
      list.add({'day': 'J-0', 'act': '🐇 Fahatongavana - Ampitomboina sakafo hay'});
      list.add({'day': 'J-7', 'act': 'Vermifuge voalohany (Ivermectine)'});
      list.add({'day': 'J-30', 'act': 'Vaksiny VHD (Viral Hemorrhagic Disease)'});
      list.add({'day': 'J-35', 'act': 'Vaksiny Myxomatose'});
      list.add({'day': 'J-90', 'act': 'Vermifuge faharoa'});
      list.add({'day': 'J-180', 'act': 'Rappel VHD + Myxomatose'});
      list.add({'day': 'Isak\'3 volana', 'act': 'Vermifuge ara-potoana'});
    } else if (_type == 'BitroVolavo') {
      // Cochon d'Inde - Calendrier sanitaire
      list.add({'day': 'J-0', 'act': '🐹 Fahatongavana - Vitamina C isan\'andro!'});
      list.add({'day': 'J-14', 'act': 'Vermifuge voalohany'});
      list.add({'day': 'Isak\'andro', 'act': 'Vitamina C (50-100mg) - Tena ilaina!'});
      list.add({'day': 'Isak\'herinandro', 'act': 'Fanadiovana cage + Fitsapana lanja'});
      list.add({'day': 'Isak\'3 volana', 'act': 'Vermifuge ara-potoana'});
      list.add({'day': 'Isak\'6 volana', 'act': 'Fitsirihana nify (mety mitombo loatra)'});
    } else {
      list.add({'day': 'J-1', 'act': 'Vaksiny Empona (Bronchite)'});
      list.add({'day': 'J-8', 'act': 'Vaksiny Pesta (Lasota)'});
      list.add({'day': 'J-12', 'act': 'Vaksiny Gumboro'});
      list.add({'day': 'J-15', 'act': 'Fanapahana Laingom-bava (Débecquage)'});
      list.add({'day': 'J-42', 'act': 'Vaksiny Pesta (Tsindrona)'});
    }

    setState(() {
      _schedule = list;
    });
  }

  Future<void> _selectDate(BuildContext context) async {
    final DateTime? picked = await showDatePicker(context: context, initialDate: DateTime.now(), firstDate: DateTime(2020), lastDate: DateTime(2030));
    if (picked != null) {
      setState(() {
        _startDate = picked;
      });
      _generateSchedule();
    }
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        TabBar(
          controller: _tabController,
          labelColor: Colors.green,
          unselectedLabelColor: Colors.grey,
          tabs: const [
            Tab(text: 'Tetiandro (Vaccins)'),
            Tab(text: 'Torolalana Aretina'),
          ],
        ),
        Expanded(
          child: TabBarView(
            controller: _tabController,
            children: [
              _buildVaccineTab(),
              _buildDiseaseTab(),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildVaccineTab() {
    return Column(
      children: [
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: _buildCard(
            title: 'Tetiandro Fanaovam-baksiny',
            child: Column(
              children: [
                DropdownButtonFormField(
                  initialValue: _type,
                  items: ['Chair', 'Pondeuse', 'Gana', 'Dokotra', 'Sarindokotra', 'Gisa', 'Vorontsiloza', 'VorontsilozaChair', 'Akanga', 'Akohonala', 'Papelika', 'Bitro', 'BitroVolavo'].map((v) {
                    String label = v;
                    if (v == 'Bitro') label = '🐇 Bitro (Lapin)';
                    if (v == 'BitroVolavo') label = '🐹 Bitro Voalavo';
                    if (v == 'Sarindokotra') label = '🦆 Sarindokotra (Mulard)';
                    if (v == 'VorontsilozaChair') label = '🦃 Vorontsiloza Chair';
                    return DropdownMenuItem(value: v, child: Text(label));
                  }).toList(),
                  onChanged: (v) => setState(() { _type = v!; _generateSchedule(); }),
                ),
                const SizedBox(height: 10),
                OutlinedButton.icon(
                  onPressed: () => _selectDate(context),
                  icon: const Icon(Icons.calendar_today),
                  label: Text(_startDate == null ? 'Safidio ny daty nahatongavana' : 'Daty: ${_startDate!.day}/${_startDate!.month}/${_startDate!.year}'),
                ),
              ],
            ),
          ),
        ),
        Expanded(
          child: ListView.builder(
            itemCount: _schedule.length,
            itemBuilder: (context, index) {
              final item = _schedule[index];
              // Calculate actual date
              int daysToAdd = int.parse(item['day']!.replaceAll(RegExp(r'[^0-9]'), ''));
              DateTime actDate = _startDate?.add(Duration(days: daysToAdd)) ?? DateTime.now();
              
              return Card(
                margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
                child: ListTile(
                  leading: CircleAvatar(backgroundColor: Colors.green, child: Text(item['day']!, style: const TextStyle(color: Colors.white, fontSize: 12))),
                  title: Text(item['act']!, style: const TextStyle(fontWeight: FontWeight.bold)),
                  subtitle: Text('Daty: ${actDate.day}/${actDate.month}/${actDate.year}'),
                ),
              );
            },
          ),
        ),
      ],
    );
  }

  Widget _buildDiseaseTab() {
    return ListView.builder(
      padding: const EdgeInsets.all(16),
      itemCount: _diseases.length,
      itemBuilder: (context, index) {
        final d = _diseases[index];
        return Card(
          margin: const EdgeInsets.only(bottom: 10),
          child: ExpansionTile(
            leading: const Icon(Icons.medical_services, color: Colors.red),
            title: Text(d.name, style: const TextStyle(fontWeight: FontWeight.bold)),
            children: [
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _buildDetailRow('📖 Filazana:', d.description),
                    _buildDetailRow('🤒 Soritr\'aretina:', d.symptoms),
                    _buildDetailRow('💊 Fanafody (Veto):', d.treatment),
                    _buildDetailRow('🌿 Tambavy (Gasy):', d.naturalRemedy),
                    _buildDetailRow('⚡ Hetsika atao:', d.actions),
                    _buildDetailRow('🛡️ Fisorohana:', d.prophylaxis),
                  ],
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildDetailRow(String label, String content) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(label, style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.green)),
          const SizedBox(height: 4),
          Text(content),
        ],
      ),
    );
  }
}

// --- MODULE 4: KAONTY (FINANCE) ---
class Transaction {
  String id;
  DateTime date;
  String type; // 'expense' or 'revenue'
  String category;
  String description;
  double amount;

  Transaction({required this.id, required this.date, required this.type, required this.category, required this.description, required this.amount});

  Map<String, dynamic> toJson() => {
    'id': id,
    'date': date.toIso8601String(),
    'type': type,
    'category': category,
    'description': description,
    'amount': amount,
  };

  factory Transaction.fromJson(Map<String, dynamic> json) => Transaction(
    id: json['id'],
    date: DateTime.parse(json['date']),
    type: json['type'],
    category: json['category'],
    description: json['description'],
    amount: json['amount'],
  );
}

class FinanceScreen extends StatefulWidget {
  const FinanceScreen({super.key});

  @override
  State<FinanceScreen> createState() => _FinanceScreenState();
}

class _FinanceScreenState extends State<FinanceScreen> with SingleTickerProviderStateMixin {
  late TabController _tabController;
  List<Transaction> _transactions = [];
  
  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 4, vsync: this);
    _loadData();
  }

  Future<void> _loadData() async {
    final prefs = await SharedPreferences.getInstance();
    final String? data = prefs.getString('transactions');
    if (data != null) {
      final List<dynamic> jsonList = jsonDecode(data);
      setState(() {
        _transactions = jsonList.map((e) => Transaction.fromJson(e)).toList();
      });
    }
  }

  Future<void> _saveData() async {
    final prefs = await SharedPreferences.getInstance();
    final String data = jsonEncode(_transactions.map((e) => e.toJson()).toList());
    await prefs.setString('transactions', data);
  }

  void _addTransaction(String type) {
    showDialog(
      context: context,
      builder: (ctx) => TransactionDialog(type: type, onSave: (t) {
        setState(() {
          _transactions.add(t);
          _transactions.sort((a, b) => b.date.compareTo(a.date));
        });
        _saveData();
      }),
    );
  }

  void _deleteTransaction(String id) {
    setState(() {
      _transactions.removeWhere((t) => t.id == id);
    });
    _saveData();
  }

  Future<void> _exportToCsv() async {
    List<List<dynamic>> rows = [];
    rows.add(["Daty", "Karazana", "Sokajy", "Fanazavana", "Vola (Ar)"]);
    for (var t in _transactions) {
      rows.add([
        DateFormat('dd/MM/yyyy').format(t.date),
        t.type == 'expense' ? 'Vola Lany' : 'Vola Niditra',
        t.category,
        t.description,
        t.amount
      ]);
    }

    String csvData = const ListToCsvConverter().convert(rows);
    final directory = await getApplicationDocumentsDirectory();
    final path = "${directory.path}/akoho_tech_kaonty.csv";
    final file = File(path);
    await file.writeAsString(csvData);
    
    final params = ShareParams(
      files: [XFile(path)],
      text: 'Tatitra Kaonty AkohoTech',
    );
    await SharePlus.instance.share(params);
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        TabBar(
          controller: _tabController,
          labelColor: Colors.green,
          unselectedLabelColor: Colors.grey,
          isScrollable: true,
          tabs: const [
            Tab(text: 'Vola Lany'),
            Tab(text: 'Vola Niditra'),
            Tab(text: 'Tatitra'),
            Tab(text: '📊 Fikajiana & Tombony'),
          ],
        ),
        Expanded(
          child: TabBarView(
            controller: _tabController,
            children: [
              _buildTransactionList('expense'),
              _buildTransactionList('revenue'),
              _buildReport(),
              const CalculatorsAndProfitScreen(),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildTransactionList(String type) {
    final list = _transactions.where((t) => t.type == type).toList();
    return Scaffold(
      floatingActionButton: FloatingActionButton(
        onPressed: () => _addTransaction(type),
        backgroundColor: type == 'expense' ? Colors.red : Colors.green,
        child: const Icon(Icons.add, color: Colors.white),
      ),
      body: list.isEmpty 
        ? const Center(child: Text('Mbola tsy misy angona')) 
        : ListView.builder(
            itemCount: list.length,
            itemBuilder: (ctx, i) {
              final t = list[i];
              return Card(
                margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
                child: ListTile(
                  leading: CircleAvatar(
                    backgroundColor: type == 'expense' ? Colors.red[100] : Colors.green[100],
                    child: Icon(type == 'expense' ? Icons.remove : Icons.add, color: type == 'expense' ? Colors.red : Colors.green),
                  ),
                  title: Text(t.category, style: const TextStyle(fontWeight: FontWeight.bold)),
                  subtitle: Text('${DateFormat('dd/MM/yyyy').format(t.date)} - ${t.description}'),
                  trailing: Row(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Text('${NumberFormat("#,##0", "fr_FR").format(t.amount)} Ar', style: const TextStyle(fontWeight: FontWeight.bold)),
                      IconButton(icon: const Icon(Icons.delete, color: Colors.grey), onPressed: () => _deleteTransaction(t.id)),
                    ],
                  ),
                ),
              );
            },
          ),
    );
  }

  Widget _buildReport() {
    double totalExp = _transactions.where((t) => t.type == 'expense').fold(0, (sum, t) => sum + t.amount);
    double totalRev = _transactions.where((t) => t.type == 'revenue').fold(0, (sum, t) => sum + t.amount);
    double profit = totalRev - totalExp;

    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          _buildSummaryCard('Vola Lany (Dépenses)', totalExp, Colors.red),
          const SizedBox(height: 10),
          _buildSummaryCard('Vola Niditra (Recettes)', totalRev, Colors.green),
          const SizedBox(height: 10),
          _buildSummaryCard('Tombony (Résultat)', profit, profit >= 0 ? Colors.blue : Colors.orange),
          const SizedBox(height: 30),
          ElevatedButton.icon(
            onPressed: _exportToCsv,
            icon: const Icon(Icons.file_download),
            label: const Text('Hamoaka Excel (CSV)'),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.green[700],
              foregroundColor: Colors.white,
              padding: const EdgeInsets.symmetric(horizontal: 30, vertical: 15),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSummaryCard(String title, double amount, Color color) {
    return Card(
      elevation: 4,
      child: Padding(
        padding: const EdgeInsets.all(20),
        child: Row(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Expanded(
              child: Text(
                title,
                style: const TextStyle(fontSize: 16),
                overflow: TextOverflow.ellipsis,
              ),
            ),
            const SizedBox(width: 12),
            Text(
              '${NumberFormat("#,##0", "fr_FR").format(amount)} Ar',
              style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: color),
              textAlign: TextAlign.right,
            ),
          ],
        ),
      ),
    );
  }
}

// ==================== FIKAJIANA & TOMBONY COMBINED SCREEN ====================
class CalculatorsAndProfitScreen extends StatelessWidget {
  const CalculatorsAndProfitScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [Colors.indigo.shade700, Colors.indigo.shade500],
              ),
              borderRadius: BorderRadius.circular(16),
            ),
            child: const Row(
              children: [
                Text('📊', style: TextStyle(fontSize: 40)),
                SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'FIKAJIANA & TOMBONY',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      Text(
                        'Calculateurs sy analyse ny tombony',
                        style: TextStyle(color: Colors.white70, fontSize: 12),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // TOMBONY Section
          const Row(
            children: [
              Text('💰', style: TextStyle(fontSize: 24)),
              SizedBox(width: 8),
              Text('TOMBONY ANALYZER', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
            ],
          ),
          const SizedBox(height: 12),
          
          // Budget input card
          Card(
            elevation: 3,
            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
            child: InkWell(
              onTap: () => showDialog(
                context: context,
                builder: (context) => const ProfitabilityAnalyzerDialog(),
              ),
              borderRadius: BorderRadius.circular(12),
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: Colors.green.shade100,
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: const Text('💵', style: TextStyle(fontSize: 28)),
                    ),
                    const SizedBox(width: 12),
                    const Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            'Analyse ny Tombony',
                            style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14),
                          ),
                          SizedBox(height: 4),
                          Text(
                            'Ampidiro ny budget-nao dia hahita hoe inona no fiompiana tsara indrindra',
                            style: TextStyle(fontSize: 11, color: Colors.grey),
                          ),
                        ],
                      ),
                    ),
                    const Icon(Icons.arrow_forward_ios, size: 16, color: Colors.grey),
                  ],
                ),
              ),
            ),
          ),
          
          const SizedBox(height: 24),
          
          // FIKAJIANA Section
          const Row(
            children: [
              Text('🧮', style: TextStyle(fontSize: 24)),
              SizedBox(width: 8),
              Text('FIKAJIANA (Calculateurs)', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
            ],
          ),
          const SizedBox(height: 12),
          
          // Calculator cards
          _buildCalculatorCard(
            context,
            emoji: '🐔',
            title: 'Fikajiana Akoho',
            subtitle: 'Kajy ny vola lany sy tombony amin\'ny fiompiana akoho',
            color: Colors.orange,
            onTap: () => _showAkohoCalculator(context),
          ),
          
          _buildCalculatorCard(
            context,
            emoji: '🐇',
            title: 'Fikajiana Bitro',
            subtitle: 'Kajy ny vola lany sy tombony amin\'ny fiompiana bitro',
            color: Colors.brown,
            onTap: () => _showBitroCalculator(context),
          ),
          
          _buildCalculatorCard(
            context,
            emoji: '🐷',
            title: 'Fikajiana Kisoa',
            subtitle: 'Kajy ny vola lany sy tombony amin\'ny fiompiana kisoa',
            color: Colors.pink,
            onTap: () => _showKisoaCalculator(context),
          ),
          
          _buildCalculatorCard(
            context,
            emoji: '🐟',
            title: 'Fikajiana Trondro',
            subtitle: 'Kajy ny vola lany sy tombony amin\'ny fiompiana trondro',
            color: Colors.blue,
            onTap: () => _showTrondroCalculator(context),
          ),
          
          _buildCalculatorCard(
            context,
            emoji: '🐝',
            title: 'Fikajiana Tantely',
            subtitle: 'Kajy ny vola lany sy tombony amin\'ny fiompiana tantely',
            color: Colors.amber,
            onTap: () => _showTantelyCalculator(context),
          ),
          
          _buildCalculatorCard(
            context,
            emoji: '🥚',
            title: 'Fikajiana Atody',
            subtitle: 'Kajy ny isan\'ny atody sy tombony',
            color: Colors.yellow.shade700,
            onTap: () => _showAtodyCalculator(context),
          ),
          
          _buildCalculatorCard(
            context,
            emoji: '🌾',
            title: 'Fikajiana Sakafo',
            subtitle: 'Kajy ny fatra sakafo ilaina',
            color: Colors.green,
            onTap: () => _showSakafoCalculator(context),
          ),
          
          _buildCalculatorCard(
            context,
            emoji: '🦆',
            title: 'Fikajiana Olitra',
            subtitle: 'Kajy ny vola lany sy tombony amin\'ny fiompiana ganagana/vorona',
            color: Colors.teal,
            onTap: () => _showOlitraCalculator(context),
          ),
          
          _buildCalculatorCard(
            context,
            emoji: '🧪',
            title: 'Fikajiana Zezika',
            subtitle: 'Kajy ny fatra zezika ilaina amin\'ny fambolena',
            color: Colors.grey,
            onTap: () => _showZezikaCalculator(context),
          ),
          
          _buildCalculatorCard(
            context,
            emoji: '🌱',
            title: 'Fikajiana Fambolena',
            subtitle: 'Kajy ny tombony amin\'ny fambolena (vary, katsaka, sns)',
            color: Colors.lightGreen,
            onTap: () => _showFambolenaCalculator(context),
          ),
          
          _buildCalculatorCard(
            context,
            emoji: '🍄‍🟫',
            title: 'Fikajiana Holatra',
            subtitle: 'Kajy ny tombony amin\'ny fambolena holatra (champignons)',
            color: Colors.brown,
            onTap: () => _showHolatraCalculator(context),
          ),
          
          const SizedBox(height: 20),
          
          // Quick tips
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.blue.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.blue.shade200),
            ),
            child: const Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text('💡', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('TOROHEVITRA', style: TextStyle(fontWeight: FontWeight.bold)),
                  ],
                ),
                SizedBox(height: 8),
                Text(
                  '• Ampiasao ny TOMBONY ANALYZER raha te-hahita hoe inona no fiompiana tsara indrindra araka ny budget-nao\n'
                  '• Ampiasao ny FIKAJIANA tsirairay raha te-hikajy ny antsipiriany momba ny fiompiana iray manokana\n'
                  '• Tadidio fa ny tombony dia miankina amin\'ny vidiny eo an-toerana',
                  style: TextStyle(fontSize: 11, height: 1.5),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCalculatorCard(
    BuildContext context, {
    required String emoji,
    required String title,
    required String subtitle,
    required Color color,
    required VoidCallback onTap,
  }) {
    return Card(
      margin: const EdgeInsets.only(bottom: 8),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(10),
        child: Padding(
          padding: const EdgeInsets.all(12),
          child: Row(
            children: [
              Container(
                padding: const EdgeInsets.all(10),
                decoration: BoxDecoration(
                  color: color.withValues(alpha: 0.15),
                  borderRadius: BorderRadius.circular(10),
                ),
                child: Text(emoji, style: const TextStyle(fontSize: 24)),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(title, style: TextStyle(fontWeight: FontWeight.bold, color: color, fontSize: 13)),
                    Text(subtitle, style: const TextStyle(fontSize: 10, color: Colors.grey)),
                  ],
                ),
              ),
              Icon(Icons.calculate, color: color, size: 20),
            ],
          ),
        ),
      ),
    );
  }

  // Calculator dialogs
  void _showAkohoCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Akoho',
        emoji: '🐔',
        color: Colors.orange,
        fields: const [
          {'label': 'Isan\'ny akoho', 'key': 'count', 'hint': '100'},
          {'label': 'Vidin\'ny zanakaoho (Ar)', 'key': 'chick_price', 'hint': '2500'},
          {'label': 'Vidin\'ny sakafo/kg (Ar)', 'key': 'feed_price', 'hint': '2000'},
          {'label': 'Sakafo/akoho/andro (g)', 'key': 'feed_per_day', 'hint': '120'},
          {'label': 'Faharetan\'ny fiompiana (andro)', 'key': 'duration', 'hint': '45'},
          {'label': 'Vidin\'ny akoho iray amidin (Ar)', 'key': 'sell_price', 'hint': '25000'},
        ],
        calculateResult: (values) {
          final count = values['count'] ?? 0;
          final chickPrice = values['chick_price'] ?? 0;
          final feedPrice = values['feed_price'] ?? 0;
          final feedPerDay = values['feed_per_day'] ?? 0;
          final duration = values['duration'] ?? 0;
          final sellPrice = values['sell_price'] ?? 0;
          
          final totalChicks = count * chickPrice;
          final totalFeed = (count * feedPerDay * duration / 1000) * feedPrice;
          final otherCosts = count * 500; // Fanafody, etc.
          final totalCost = totalChicks + totalFeed + otherCosts;
          
          final survivors = (count * 0.92).floor(); // 8% mortality
          final revenue = survivors * sellPrice;
          final profit = revenue - totalCost;
          final profitPerChicken = survivors > 0 ? profit / survivors : 0;
          final roi = totalCost > 0 ? (profit / totalCost * 100) : 0;
          
          return {
            'Zanakaoho': '${NumberFormat("#,##0").format(totalChicks)} Ar',
            'Sakafo': '${NumberFormat("#,##0").format(totalFeed)} Ar',
            'Hafa (fanafody...)': '${NumberFormat("#,##0").format(otherCosts)} Ar',
            'VOLA LANY REHETRA': '${NumberFormat("#,##0").format(totalCost)} Ar',
            '---': '---',
            'Akoho velona (92%)': '$survivors',
            'VOLA NIDITRA': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY': '${NumberFormat("#,##0").format(profit)} Ar',
            'Tombony/akoho': '${NumberFormat("#,##0").format(profitPerChicken)} Ar',
            'ROI': '${roi.toStringAsFixed(1)}%',
          };
        },
      ),
    );
  }

  void _showBitroCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Bitro',
        emoji: '🐇',
        color: Colors.brown,
        fields: const [
          {'label': 'Isan\'ny reniny', 'key': 'mothers', 'hint': '10'},
          {'label': 'Vidin\'ny reniny (Ar)', 'key': 'mother_price', 'hint': '25000'},
          {'label': 'Zanaka isaky ny fiterahana', 'key': 'babies_per_litter', 'hint': '6'},
          {'label': 'Fiterahana isan-taona', 'key': 'litters_per_year', 'hint': '6'},
          {'label': 'Vidin\'ny sakafo/volana/reniny (Ar)', 'key': 'feed_cost', 'hint': '15000'},
          {'label': 'Vidin\'ny bitro iray amidin (Ar)', 'key': 'sell_price', 'hint': '15000'},
        ],
        calculateResult: (values) {
          final mothers = values['mothers'] ?? 0;
          final motherPrice = values['mother_price'] ?? 0;
          final babiesPerLitter = values['babies_per_litter'] ?? 0;
          final littersPerYear = values['litters_per_year'] ?? 0;
          final feedCost = values['feed_cost'] ?? 0;
          final sellPrice = values['sell_price'] ?? 0;
          
          final initialCost = mothers * motherPrice;
          final annualFeed = mothers * feedCost * 12;
          final totalCost = initialCost + annualFeed;
          
          final totalBabies = (mothers * babiesPerLitter * littersPerYear * 0.85).floor();
          final revenue = totalBabies * sellPrice;
          final profit = revenue - totalCost;
          final roi = totalCost > 0 ? (profit / totalCost * 100) : 0;
          
          return {
            'Vidin\'ny reniny': '${NumberFormat("#,##0").format(initialCost)} Ar',
            'Sakafo isan-taona': '${NumberFormat("#,##0").format(annualFeed)} Ar',
            'VOLA LANY REHETRA': '${NumberFormat("#,##0").format(totalCost)} Ar',
            '---': '---',
            'Zanaka isan-taona (85%)': '$totalBabies',
            'VOLA NIDITRA': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY': '${NumberFormat("#,##0").format(profit)} Ar',
            'ROI': '${roi.toStringAsFixed(1)}%',
          };
        },
      ),
    );
  }

  void _showKisoaCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Kisoa',
        emoji: '🐷',
        color: Colors.pink,
        fields: const [
          {'label': 'Isan\'ny kisoa', 'key': 'count', 'hint': '10'},
          {'label': 'Vidin\'ny zana-kisoa (Ar)', 'key': 'piglet_price', 'hint': '80000'},
          {'label': 'Vidin\'ny sakafo/kg (Ar)', 'key': 'feed_price', 'hint': '1500'},
          {'label': 'Sakafo/kisoa/andro (kg)', 'key': 'feed_per_day', 'hint': '2.5'},
          {'label': 'Faharetan\'ny fiompiana (volana)', 'key': 'duration', 'hint': '6'},
          {'label': 'Lanja rehefa amidin (kg)', 'key': 'final_weight', 'hint': '100'},
          {'label': 'Vidin\'ny hena/kg (Ar)', 'key': 'meat_price', 'hint': '12000'},
        ],
        calculateResult: (values) {
          final count = values['count'] ?? 0;
          final pigletPrice = values['piglet_price'] ?? 0;
          final feedPrice = values['feed_price'] ?? 0;
          final feedPerDay = values['feed_per_day'] ?? 0;
          final duration = values['duration'] ?? 0;
          final finalWeight = values['final_weight'] ?? 0;
          final meatPrice = values['meat_price'] ?? 0;
          
          final totalPiglets = count * pigletPrice;
          final totalFeed = (count * feedPerDay * duration * 30) * feedPrice;
          final otherCosts = count * 20000;
          final totalCost = totalPiglets + totalFeed + otherCosts;
          
          final survivors = (count * 0.95).floor();
          final revenue = survivors * finalWeight * meatPrice;
          final profit = revenue - totalCost;
          final profitPerPig = survivors > 0 ? profit / survivors : 0;
          final roi = totalCost > 0 ? (profit / totalCost * 100) : 0;
          
          return {
            'Zana-kisoa': '${NumberFormat("#,##0").format(totalPiglets)} Ar',
            'Sakafo': '${NumberFormat("#,##0").format(totalFeed)} Ar',
            'Hafa': '${NumberFormat("#,##0").format(otherCosts)} Ar',
            'VOLA LANY REHETRA': '${NumberFormat("#,##0").format(totalCost)} Ar',
            '---': '---',
            'Kisoa velona (95%)': '$survivors',
            'VOLA NIDITRA': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY': '${NumberFormat("#,##0").format(profit)} Ar',
            'Tombony/kisoa': '${NumberFormat("#,##0").format(profitPerPig)} Ar',
            'ROI': '${roi.toStringAsFixed(1)}%',
          };
        },
      ),
    );
  }

  void _showTrondroCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Trondro',
        emoji: '🐟',
        color: Colors.blue,
        fields: const [
          {'label': 'Isan\'ny zana-trondro', 'key': 'count', 'hint': '500'},
          {'label': 'Vidin\'ny zana-trondro (Ar)', 'key': 'fry_price', 'hint': '300'},
          {'label': 'Vidin\'ny sakafo/kg (Ar)', 'key': 'feed_price', 'hint': '3000'},
          {'label': 'FCR (kg sakafo/kg trondro)', 'key': 'fcr', 'hint': '1.5'},
          {'label': 'Lanja farany (g)', 'key': 'final_weight', 'hint': '500'},
          {'label': 'Vidin\'ny trondro/kg (Ar)', 'key': 'sell_price', 'hint': '10000'},
        ],
        calculateResult: (values) {
          final count = values['count'] ?? 0;
          final fryPrice = values['fry_price'] ?? 0;
          final feedPrice = values['feed_price'] ?? 0;
          final fcr = values['fcr'] ?? 1;
          final finalWeight = values['final_weight'] ?? 0;
          final sellPrice = values['sell_price'] ?? 0;
          
          final totalFry = count * fryPrice;
          final totalWeight = count * 0.85 * finalWeight / 1000; // 85% survival
          final totalFeed = totalWeight * fcr * feedPrice;
          final otherCosts = count * 50;
          final totalCost = totalFry + totalFeed + otherCosts;
          
          final revenue = totalWeight * sellPrice;
          final profit = revenue - totalCost;
          final roi = totalCost > 0 ? (profit / totalCost * 100) : 0;
          
          return {
            'Zana-trondro': '${NumberFormat("#,##0").format(totalFry)} Ar',
            'Sakafo': '${NumberFormat("#,##0").format(totalFeed)} Ar',
            'Hafa': '${NumberFormat("#,##0").format(otherCosts)} Ar',
            'VOLA LANY REHETRA': '${NumberFormat("#,##0").format(totalCost)} Ar',
            '---': '---',
            'Lanja azo (85%)': '${totalWeight.toStringAsFixed(1)} kg',
            'VOLA NIDITRA': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY': '${NumberFormat("#,##0").format(profit)} Ar',
            'ROI': '${roi.toStringAsFixed(1)}%',
          };
        },
      ),
    );
  }

  void _showTantelyCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Tantely',
        emoji: '🐝',
        color: Colors.amber,
        fields: const [
          {'label': 'Isan\'ny toho', 'key': 'hives', 'hint': '10'},
          {'label': 'Vidin\'ny toho iray (Ar)', 'key': 'hive_price', 'hint': '150000'},
          {'label': 'Vidin\'ny essaim (Ar)', 'key': 'swarm_price', 'hint': '50000'},
          {'label': 'Tantely/toho/taona (kg)', 'key': 'honey_per_hive', 'hint': '20'},
          {'label': 'Vidin\'ny tantely/kg (Ar)', 'key': 'honey_price', 'hint': '25000'},
        ],
        calculateResult: (values) {
          final hives = values['hives'] ?? 0;
          final hivePrice = values['hive_price'] ?? 0;
          final swarmPrice = values['swarm_price'] ?? 0;
          final honeyPerHive = values['honey_per_hive'] ?? 0;
          final honeyPrice = values['honey_price'] ?? 0;
          
          final initialCost = hives * (hivePrice + swarmPrice);
          final annualCost = hives * 20000; // maintenance
          final totalCost = initialCost + annualCost;
          
          final totalHoney = hives * honeyPerHive;
          final revenue = totalHoney * honeyPrice;
          final profit = revenue - annualCost; // Year 2+
          final roi = annualCost > 0 ? (profit / annualCost * 100) : 0;
          
          return {
            'Toho + Essaim': '${NumberFormat("#,##0").format(initialCost)} Ar',
            'Fikojakojana/taona': '${NumberFormat("#,##0").format(annualCost)} Ar',
            'FAMPIASAM-BOLA': '${NumberFormat("#,##0").format(totalCost)} Ar',
            '---': '---',
            'Tantely/taona': '${totalHoney.toStringAsFixed(0)} kg',
            'VOLA NIDITRA/taona': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY/taona (Y2+)': '${NumberFormat("#,##0").format(profit)} Ar',
            'ROI (Y2+)': '${roi.toStringAsFixed(1)}%',
          };
        },
      ),
    );
  }

  void _showAtodyCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Atody',
        emoji: '🥚',
        color: Colors.yellow.shade700,
        fields: const [
          {'label': 'Isan\'ny akoho mpitatsy', 'key': 'layers', 'hint': '50'},
          {'label': 'Tahan\'ny fiterahana (%)', 'key': 'laying_rate', 'hint': '80'},
          {'label': 'Vidin\'ny atody iray (Ar)', 'key': 'egg_price', 'hint': '600'},
          {'label': 'Vidin\'ny sakafo/akoho/andro (Ar)', 'key': 'feed_cost', 'hint': '250'},
        ],
        calculateResult: (values) {
          final layers = values['layers'] ?? 0;
          final layingRate = (values['laying_rate'] ?? 0) / 100;
          final eggPrice = values['egg_price'] ?? 0;
          final feedCost = values['feed_cost'] ?? 0;
          
          final eggsPerDay = layers * layingRate;
          final eggsPerMonth = eggsPerDay * 30;
          final eggsPerYear = eggsPerDay * 365;
          
          final dailyRevenue = eggsPerDay * eggPrice;
          final monthlyRevenue = eggsPerMonth * eggPrice;
          
          final dailyCost = layers * feedCost;
          final monthlyCost = dailyCost * 30;
          
          final dailyProfit = dailyRevenue - dailyCost;
          final monthlyProfit = monthlyRevenue - monthlyCost;
          
          return {
            'Atody/andro': eggsPerDay.toStringAsFixed(0),
            'Atody/volana': eggsPerMonth.toStringAsFixed(0),
            'Atody/taona': eggsPerYear.toStringAsFixed(0),
            '---': '---',
            'Vola niditra/andro': '${NumberFormat("#,##0").format(dailyRevenue)} Ar',
            'Vola lany/andro': '${NumberFormat("#,##0").format(dailyCost)} Ar',
            'TOMBONY/andro': '${NumberFormat("#,##0").format(dailyProfit)} Ar',
            'TOMBONY/volana': '${NumberFormat("#,##0").format(monthlyProfit)} Ar',
          };
        },
      ),
    );
  }

  void _showSakafoCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Sakafo',
        emoji: '🌾',
        color: Colors.green,
        fields: const [
          {'label': 'Isan\'ny biby', 'key': 'count', 'hint': '100'},
          {'label': 'Sakafo/biby/andro (g)', 'key': 'feed_per_day', 'hint': '120'},
          {'label': 'Faharetan\'ny fiompiana (andro)', 'key': 'duration', 'hint': '45'},
          {'label': 'Vidin\'ny sakafo/kg (Ar)', 'key': 'feed_price', 'hint': '2000'},
        ],
        calculateResult: (values) {
          final count = values['count'] ?? 0;
          final feedPerDay = values['feed_per_day'] ?? 0;
          final duration = values['duration'] ?? 0;
          final feedPrice = values['feed_price'] ?? 0;
          
          final dailyFeed = count * feedPerDay / 1000; // kg
          final totalFeed = dailyFeed * duration;
          final totalCost = totalFeed * feedPrice;
          
          final bags25 = (totalFeed / 25).ceil();
          final bags50 = (totalFeed / 50).ceil();
          
          return {
            'Sakafo/andro': '${dailyFeed.toStringAsFixed(1)} kg',
            'Sakafo rehetra': '${totalFeed.toStringAsFixed(1)} kg',
            '---': '---',
            'Kitapo 25kg ilaina': '$bags25',
            'Kitapo 50kg ilaina': '$bags50',
            'VOLA ILAINA': '${NumberFormat("#,##0").format(totalCost)} Ar',
          };
        },
      ),
    );
  }

  void _showOlitraCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Olitra',
        emoji: '🦆',
        color: Colors.teal,
        fields: const [
          {'label': 'Isan\'ny ganagana/vorona', 'key': 'count', 'hint': '50'},
          {'label': 'Vidin\'ny zanak\'olitra (Ar)', 'key': 'chick_price', 'hint': '8000'},
          {'label': 'Sakafo/olitra/andro (g)', 'key': 'feed_per_day', 'hint': '150'},
          {'label': 'Faharetan\'ny fiompiana (andro)', 'key': 'duration', 'hint': '60'},
          {'label': 'Vidin\'ny sakafo/kg (Ar)', 'key': 'feed_price', 'hint': '2200'},
          {'label': 'Vidin\'ny olitra iray rehefa lehibe (Ar)', 'key': 'sell_price', 'hint': '35000'},
        ],
        calculateResult: (values) {
          final count = values['count'] ?? 0;
          final chickPrice = values['chick_price'] ?? 0;
          final feedPerDay = values['feed_per_day'] ?? 0;
          final duration = values['duration'] ?? 0;
          final feedPrice = values['feed_price'] ?? 0;
          final sellPrice = values['sell_price'] ?? 0;
          
          final chickCost = count * chickPrice;
          final totalFeedKg = count * feedPerDay * duration / 1000;
          final feedCost = totalFeedKg * feedPrice;
          final otherCost = (chickCost + feedCost) * 0.1; // 10% autres frais
          final totalCost = chickCost + feedCost + otherCost;
          
          final revenue = count * sellPrice * 0.90; // 90% taux survie
          final profit = revenue - totalCost;
          final roi = totalCost > 0 ? (profit / totalCost * 100) : 0;
          
          return {
            'Vidin\'ny zanak\'olitra': '${NumberFormat("#,##0").format(chickCost)} Ar',
            'Vidin\'ny sakafo': '${NumberFormat("#,##0").format(feedCost)} Ar',
            'Hafa (10%)': '${NumberFormat("#,##0").format(otherCost)} Ar',
            '---': '---',
            'VOLA LANY REHETRA': '${NumberFormat("#,##0").format(totalCost)} Ar',
            'VOLA MIDITRA': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY': '${NumberFormat("#,##0").format(profit)} Ar',
            'ROI': '${roi.toStringAsFixed(1)}%',
          };
        },
      ),
    );
  }

  void _showZezikaCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Zezika',
        emoji: '🧪',
        color: Colors.grey,
        fields: const [
          {'label': 'Haben\'ny tany (m²)', 'key': 'area', 'hint': '1000'},
          {'label': 'Karazan\'ny voly (1=Vary, 2=Katsaka, 3=Legioma)', 'key': 'crop_type', 'hint': '1'},
          {'label': 'Zezika organika/m² (g)', 'key': 'organic', 'hint': '200'},
          {'label': 'NPK/m² (g)', 'key': 'npk', 'hint': '30'},
          {'label': 'Vidin\'ny zezika organika/kg (Ar)', 'key': 'organic_price', 'hint': '500'},
          {'label': 'Vidin\'ny NPK/kg (Ar)', 'key': 'npk_price', 'hint': '3000'},
        ],
        calculateResult: (values) {
          final area = values['area'] ?? 0;
          final cropType = (values['crop_type'] ?? 1).toInt();
          var organic = values['organic'] ?? 0;
          var npk = values['npk'] ?? 0;
          final organicPrice = values['organic_price'] ?? 0;
          final npkPrice = values['npk_price'] ?? 0;
          
          // Ajuster selon type de culture
          String cropName = 'Vary';
          if (cropType == 2) { cropName = 'Katsaka'; organic *= 0.8; npk *= 1.2; }
          if (cropType == 3) { cropName = 'Legioma'; organic *= 1.5; npk *= 0.8; }
          
          final totalOrganicKg = area * organic / 1000;
          final totalNpkKg = area * npk / 1000;
          final organicCost = totalOrganicKg * organicPrice;
          final npkCost = totalNpkKg * npkPrice;
          final totalCost = organicCost + npkCost;
          
          return {
            'Voly': cropName,
            'Haben\'ny tany': '${NumberFormat("#,##0").format(area)} m²',
            '---': '---',
            'Zezika organika ilaina': '${totalOrganicKg.toStringAsFixed(1)} kg',
            'NPK ilaina': '${totalNpkKg.toStringAsFixed(1)} kg',
            '---2': '---',
            'Vidin\'ny zezika organika': '${NumberFormat("#,##0").format(organicCost)} Ar',
            'Vidin\'ny NPK': '${NumberFormat("#,##0").format(npkCost)} Ar',
            'VOLA ILAINA REHETRA': '${NumberFormat("#,##0").format(totalCost)} Ar',
          };
        },
      ),
    );
  }

  void _showFambolenaCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Fambolena',
        emoji: '🌱',
        color: Colors.lightGreen,
        fields: const [
          {'label': 'Haben\'ny tany (m²)', 'key': 'area', 'hint': '2000'},
          {'label': 'Vidin\'ny masomboly (Ar)', 'key': 'seed_cost', 'hint': '50000'},
          {'label': 'Vidin\'ny zezika (Ar)', 'key': 'fertilizer_cost', 'hint': '80000'},
          {'label': 'Karama asa (Ar)', 'key': 'labor_cost', 'hint': '100000'},
          {'label': 'Voka-bary/m² (kg)', 'key': 'yield_per_m2', 'hint': '0.5'},
          {'label': 'Vidin\'ny vokatra/kg (Ar)', 'key': 'sell_price', 'hint': '2000'},
        ],
        calculateResult: (values) {
          final area = values['area'] ?? 0;
          final seedCost = values['seed_cost'] ?? 0;
          final fertilizerCost = values['fertilizer_cost'] ?? 0;
          final laborCost = values['labor_cost'] ?? 0;
          final yieldPerM2 = values['yield_per_m2'] ?? 0;
          final sellPrice = values['sell_price'] ?? 0;
          
          final totalCost = seedCost + fertilizerCost + laborCost;
          final totalYield = area * yieldPerM2;
          final revenue = totalYield * sellPrice;
          final profit = revenue - totalCost;
          final roi = totalCost > 0 ? (profit / totalCost * 100) : 0;
          final costPerKg = totalYield > 0 ? (totalCost / totalYield) : 0;
          
          return {
            'Haben\'ny tany': '${NumberFormat("#,##0").format(area)} m²',
            'Vola lany masomboly': '${NumberFormat("#,##0").format(seedCost)} Ar',
            'Vola lany zezika': '${NumberFormat("#,##0").format(fertilizerCost)} Ar',
            'Karama asa': '${NumberFormat("#,##0").format(laborCost)} Ar',
            '---': '---',
            'VOLA LANY REHETRA': '${NumberFormat("#,##0").format(totalCost)} Ar',
            'Vokatra andrasana': '${totalYield.toStringAsFixed(1)} kg',
            'Vidiny/kg': '${NumberFormat("#,##0").format(costPerKg)} Ar',
            '---2': '---',
            'VOLA MIDITRA': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY': '${NumberFormat("#,##0").format(profit)} Ar',
            'ROI': '${roi.toStringAsFixed(1)}%',
          };
        },
      ),
    );
  }

  void _showHolatraCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Holatra',
        emoji: '🍄‍🟫',
        color: Colors.brown,
        fields: const [
          {'label': 'Isan\'ny kitapo', 'key': 'bags', 'hint': '100'},
          {'label': 'Vidin\'ny substrat/kitapo (Ar)', 'key': 'substrate_cost', 'hint': '500'},
          {'label': 'Vidin\'ny spawn/kitapo (Ar)', 'key': 'spawn_cost', 'hint': '1000'},
          {'label': 'Kitapo plastika/pièce (Ar)', 'key': 'bag_cost', 'hint': '200'},
          {'label': 'Fandaniana hafa/volana (Ar)', 'key': 'other_cost', 'hint': '50000'},
          {'label': 'Vokatra/kitapo (g)', 'key': 'yield_per_bag', 'hint': '300'},
          {'label': 'Vidin\'ny holatra/kg (Ar)', 'key': 'sell_price', 'hint': '20000'},
        ],
        calculateResult: (values) {
          final bags = values['bags'] ?? 0;
          final substrateCost = values['substrate_cost'] ?? 0;
          final spawnCost = values['spawn_cost'] ?? 0;
          final bagCost = values['bag_cost'] ?? 0;
          final otherCost = values['other_cost'] ?? 0;
          final yieldPerBag = values['yield_per_bag'] ?? 0;
          final sellPrice = values['sell_price'] ?? 0;
          
          final totalSubstrate = bags * substrateCost;
          final totalSpawn = bags * spawnCost;
          final totalBags = bags * bagCost;
          final totalCost = totalSubstrate + totalSpawn + totalBags + otherCost;
          
          final totalYieldG = bags * yieldPerBag;
          final totalYieldKg = totalYieldG / 1000;
          final revenue = totalYieldKg * sellPrice;
          final profit = revenue - totalCost;
          final roi = totalCost > 0 ? (profit / totalCost * 100) : 0;
          final costPerKg = totalYieldKg > 0 ? (totalCost / totalYieldKg) : 0;
          
          return {
            'Isan\'ny kitapo': '${NumberFormat("#,##0").format(bags)} kitapo',
            'Vola substrat': '${NumberFormat("#,##0").format(totalSubstrate)} Ar',
            'Vola spawn': '${NumberFormat("#,##0").format(totalSpawn)} Ar',
            'Vola kitapo': '${NumberFormat("#,##0").format(totalBags)} Ar',
            'Fandaniana hafa': '${NumberFormat("#,##0").format(otherCost)} Ar',
            '---': '---',
            'VOLA LANY REHETRA': '${NumberFormat("#,##0").format(totalCost)} Ar',
            'Vokatra andrasana': '${totalYieldKg.toStringAsFixed(1)} kg',
            'Vidiny/kg': '${NumberFormat("#,##0").format(costPerKg)} Ar',
            '---2': '---',
            'VOLA MIDITRA': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY': '${NumberFormat("#,##0").format(profit)} Ar',
            'ROI': '${roi.toStringAsFixed(1)}%',
          };
        },
      ),
    );
  }
}

// Calculator Sheet Widget
class _CalculatorSheet extends StatefulWidget {
  final String title;
  final String emoji;
  final Color color;
  final List<Map<String, String>> fields;
  final Map<String, dynamic> Function(Map<String, double>) calculateResult;

  const _CalculatorSheet({
    required this.title,
    required this.emoji,
    required this.color,
    required this.fields,
    required this.calculateResult,
  });

  @override
  State<_CalculatorSheet> createState() => _CalculatorSheetState();
}

class _CalculatorSheetState extends State<_CalculatorSheet> {
  final Map<String, TextEditingController> _controllers = {};
  Map<String, dynamic>? _results;

  @override
  void initState() {
    super.initState();
    for (var field in widget.fields) {
      _controllers[field['key']!] = TextEditingController(text: field['hint']);
    }
  }

  @override
  void dispose() {
    for (var controller in _controllers.values) {
      controller.dispose();
    }
    super.dispose();
  }

  void _calculate() {
    final values = <String, double>{};
    for (var entry in _controllers.entries) {
      values[entry.key] = double.tryParse(entry.value.text) ?? 0;
    }
    setState(() {
      _results = widget.calculateResult(values);
    });
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      height: MediaQuery.of(context).size.height * 0.85,
      decoration: const BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      child: Column(
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: widget.color,
              borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
            ),
            child: Row(
              children: [
                Text(widget.emoji, style: const TextStyle(fontSize: 32)),
                const SizedBox(width: 12),
                Expanded(
                  child: Text(
                    widget.title,
                    style: const TextStyle(
                      color: Colors.white,
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
                IconButton(
                  icon: const Icon(Icons.close, color: Colors.white),
                  onPressed: () => Navigator.pop(context),
                ),
              ],
            ),
          ),
          
          // Form
          Expanded(
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(16),
              child: Column(
                children: [
                  // Input fields
                  ...widget.fields.map((field) => Padding(
                    padding: const EdgeInsets.only(bottom: 12),
                    child: TextField(
                      controller: _controllers[field['key']],
                      keyboardType: const TextInputType.numberWithOptions(decimal: true),
                      decoration: InputDecoration(
                        labelText: field['label'],
                        border: OutlineInputBorder(
                          borderRadius: BorderRadius.circular(10),
                        ),
                        filled: true,
                        fillColor: Colors.grey.shade50,
                      ),
                    ),
                  )),
                  
                  const SizedBox(height: 16),
                  
                  // Calculate button
                  SizedBox(
                    width: double.infinity,
                    child: ElevatedButton.icon(
                      onPressed: _calculate,
                      icon: const Icon(Icons.calculate),
                      label: const Text('KAJY', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: widget.color,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(10),
                        ),
                      ),
                    ),
                  ),
                  
                  // Results
                  if (_results != null) ...[
                    const SizedBox(height: 20),
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: widget.color.withValues(alpha: 0.1),
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(color: widget.color.withValues(alpha: 0.3)),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              Icon(Icons.analytics, color: widget.color),
                              const SizedBox(width: 8),
                              Text(
                                'VOKATRA',
                                style: TextStyle(
                                  fontWeight: FontWeight.bold,
                                  color: widget.color,
                                  fontSize: 14,
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 12),
                          ..._results!.entries.map((entry) {
                            if (entry.key == '---') {
                              return const Divider(height: 16);
                            }
                            final isBold = entry.key.contains('TOMBONY') || 
                                          entry.key.contains('VOLA') || 
                                          entry.key.contains('ROI');
                            return Padding(
                              padding: const EdgeInsets.only(bottom: 8),
                              child: Row(
                                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                children: [
                                  Expanded(
                                    child: Text(
                                      entry.key,
                                      style: TextStyle(
                                        fontSize: 12,
                                        fontWeight: isBold ? FontWeight.bold : FontWeight.normal,
                                      ),
                                    ),
                                  ),
                                  Text(
                                    entry.value.toString(),
                                    style: TextStyle(
                                      fontSize: 12,
                                      fontWeight: isBold ? FontWeight.bold : FontWeight.normal,
                                      color: entry.key.contains('TOMBONY') 
                                          ? (entry.value.toString().contains('-') ? Colors.red : Colors.green)
                                          : null,
                                    ),
                                  ),
                                ],
                              ),
                            );
                          }),
                        ],
                      ),
                    ),
                  ],
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}

class TransactionDialog extends StatefulWidget {
  final String type;
  final Function(Transaction) onSave;

  const TransactionDialog({super.key, required this.type, required this.onSave});

  @override
  State<TransactionDialog> createState() => _TransactionDialogState();
}

class _TransactionDialogState extends State<TransactionDialog> {
  final _formKey = GlobalKey<FormState>();
  final _descCtrl = TextEditingController();
  final _amountCtrl = TextEditingController();
  String _category = 'Sakafo';
  DateTime _date = DateTime.now();

  final List<String> _expenseCats = ['Sakafo', 'Fanafody', 'Zanak\'akoho', 'Fitaovana', 'Karama', 'Hafa'];
  final List<String> _revenueCats = ['Fivarotana Akoho', 'Fivarotana Atody', 'Feziko', 'Hafa'];

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      title: Text(widget.type == 'expense' ? 'Ampiditra Vola Lany' : 'Ampiditra Vola Niditra'),
      content: Form(
        key: _formKey,
        child: SingleChildScrollView(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              DropdownButtonFormField(
                initialValue: _category,
                items: (widget.type == 'expense' ? _expenseCats : _revenueCats).map((c) => DropdownMenuItem(value: c, child: Text(c))).toList(),
                onChanged: (v) => setState(() => _category = v!),
                decoration: const InputDecoration(labelText: 'Sokajy'),
              ),
              TextFormField(
                controller: _descCtrl,
                decoration: const InputDecoration(labelText: 'Fanazavana (ohatra: Provandy 50kg)'),
                validator: (v) => v!.isEmpty ? 'Fenoy ity' : null,
              ),
              TextFormField(
                controller: _amountCtrl,
                keyboardType: TextInputType.number,
                decoration: const InputDecoration(labelText: 'Vola (Ar)'),
                validator: (v) => v!.isEmpty ? 'Fenoy ity' : null,
              ),
              const SizedBox(height: 10),
              Row(
                children: [
                  Text('Daty: ${DateFormat('dd/MM/yyyy').format(_date)}'),
                  const Spacer(),
                  TextButton(
                    onPressed: () async {
                      final d = await showDatePicker(context: context, initialDate: _date, firstDate: DateTime(2020), lastDate: DateTime(2030));
                      if (d != null) setState(() => _date = d);
                    },
                    child: const Text('Hanova'),
                  )
                ],
              )
            ],
          ),
        ),
      ),
      actions: [
        TextButton(onPressed: () => Navigator.pop(context), child: const Text('Foanana')),
        ElevatedButton(
          onPressed: () {
            if (_formKey.currentState!.validate()) {
              final t = Transaction(
                id: DateTime.now().millisecondsSinceEpoch.toString(),
                date: _date,
                type: widget.type,
                category: _category,
                description: _descCtrl.text,
                amount: double.parse(_amountCtrl.text),
              );
              widget.onSave(t);
              Navigator.pop(context);
            }
          },
          child: const Text('Tehirizina'),
        ),
      ],
    );
  }
}

// --- WIDGET HELPER GLASSMORPHISM STYLE ---
Widget _buildCard({required String title, required Widget child, IconData? icon}) {
  return Container(
    margin: const EdgeInsets.only(bottom: 20),
    decoration: BoxDecoration(
      color: Colors.white,
      borderRadius: BorderRadius.circular(24),
      boxShadow: [
        BoxShadow(
          color: AppColors.primary.withValues(alpha: 0.1),
          blurRadius: 20,
          offset: const Offset(0, 8),
        ),
      ],
    ),
    child: Padding(
      padding: const EdgeInsets.all(20.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              if (icon != null) ...[
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    gradient: const LinearGradient(
                      colors: [AppColors.gradientStart, AppColors.gradientEnd],
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                    ),
                    borderRadius: BorderRadius.circular(14),
                    boxShadow: [
                      BoxShadow(
                        color: AppColors.primary.withValues(alpha: 0.15),
                        blurRadius: 8,
                        offset: const Offset(0, 4),
                      ),
                    ],
                  ),
                  child: Icon(icon, color: Colors.white, size: 22),
                ),
                const SizedBox(width: 14),
              ],
              Expanded(
                child: Text(
                  title, 
                  style: const TextStyle(
                    fontSize: 18, 
                    fontWeight: FontWeight.w700, 
                    color: AppColors.textPrimary,
                    letterSpacing: -0.3,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 18),
          child,
        ],
      ),
    ),
  );
}

// --- MODULE 5: RACES (BREEDS & CROSSBREEDING) ---
class BreedsScreen extends StatefulWidget {
  const BreedsScreen({super.key});

  @override
  State<BreedsScreen> createState() => _BreedsScreenState();
}

class _BreedsScreenState extends State<BreedsScreen> with SingleTickerProviderStateMixin {
  List<Map<String, dynamic>> _breeds = [];
  List<Map<String, dynamic>> _chickens = []; // Individual chickens with pedigree
  late TabController _tabController;
  String _searchQuery = '';
  String _filterType = 'Rehetra';

  // Base de données de 100+ races mondiales prédéfinies
  static final List<Map<String, dynamic>> _predefinedBreeds = [
    // RACES PONDEUSES
    {'name': 'Leghorn Blanche', 'origin': 'Italie', 'type': 'Pondeuse', 'eggsPerYear': 320, 'weight': 2.5, 'color': 'Blanc', 'comb': 'Simple'},
    {'name': 'Rhode Island Red', 'origin': 'États-Unis', 'type': 'Pondeuse', 'eggsPerYear': 280, 'weight': 3.5, 'color': 'Rouge acajou', 'comb': 'Simple'},
    {'name': 'Sussex', 'origin': 'Angleterre', 'type': 'Mixte', 'eggsPerYear': 260, 'weight': 4.0, 'color': 'Blanc herminé', 'comb': 'Simple'},
    {'name': 'Plymouth Rock', 'origin': 'États-Unis', 'type': 'Mixte', 'eggsPerYear': 250, 'weight': 3.8, 'color': 'Barrée', 'comb': 'Simple'},
    {'name': 'Wyandotte', 'origin': 'États-Unis', 'type': 'Mixte', 'eggsPerYear': 240, 'weight': 3.6, 'color': 'Argentée liserée', 'comb': 'Rose'},
    {'name': 'Marans', 'origin': 'France', 'type': 'Pondeuse', 'eggsPerYear': 200, 'weight': 3.5, 'color': 'Noir cuivré', 'comb': 'Simple'},
    {'name': 'Australorp', 'origin': 'Australie', 'type': 'Pondeuse', 'eggsPerYear': 300, 'weight': 3.5, 'color': 'Noir', 'comb': 'Simple'},
    {'name': 'Orpington', 'origin': 'Angleterre', 'type': 'Mixte', 'eggsPerYear': 200, 'weight': 4.5, 'color': 'Fauve', 'comb': 'Simple'},
    {'name': 'New Hampshire', 'origin': 'États-Unis', 'type': 'Mixte', 'eggsPerYear': 240, 'weight': 3.5, 'color': 'Rouge doré', 'comb': 'Simple'},
    {'name': 'Amberlink', 'origin': 'Hybride', 'type': 'Pondeuse', 'eggsPerYear': 330, 'weight': 2.8, 'color': 'Roux', 'comb': 'Simple'},
    {'name': 'ISA Brown', 'origin': 'France', 'type': 'Pondeuse', 'eggsPerYear': 340, 'weight': 2.5, 'color': 'Roux', 'comb': 'Simple'},
    {'name': 'Lohmann Brown', 'origin': 'Allemagne', 'type': 'Pondeuse', 'eggsPerYear': 320, 'weight': 2.6, 'color': 'Brun', 'comb': 'Simple'},
    {'name': 'Hy-Line Brown', 'origin': 'États-Unis', 'type': 'Pondeuse', 'eggsPerYear': 330, 'weight': 2.5, 'color': 'Brun', 'comb': 'Simple'},
    {'name': 'Bovans Brown', 'origin': 'Pays-Bas', 'type': 'Pondeuse', 'eggsPerYear': 315, 'weight': 2.4, 'color': 'Brun', 'comb': 'Simple'},
    {'name': 'Araucana', 'origin': 'Chili', 'type': 'Pondeuse', 'eggsPerYear': 180, 'weight': 2.8, 'color': 'Variable', 'comb': 'Pois'},
    {'name': 'Ameraucana', 'origin': 'États-Unis', 'type': 'Pondeuse', 'eggsPerYear': 200, 'weight': 2.9, 'color': 'Variable', 'comb': 'Pois'},
    {'name': 'Cream Legbar', 'origin': 'Angleterre', 'type': 'Pondeuse', 'eggsPerYear': 220, 'weight': 2.7, 'color': 'Crème barrée', 'comb': 'Simple'},
    {'name': 'Welsummer', 'origin': 'Pays-Bas', 'type': 'Pondeuse', 'eggsPerYear': 200, 'weight': 3.0, 'color': 'Perdrix doré', 'comb': 'Simple'},
    {'name': 'Barnevelder', 'origin': 'Pays-Bas', 'type': 'Pondeuse', 'eggsPerYear': 200, 'weight': 3.2, 'color': 'Double liseré', 'comb': 'Simple'},
    {'name': 'Hamburg', 'origin': 'Allemagne', 'type': 'Pondeuse', 'eggsPerYear': 200, 'weight': 2.2, 'color': 'Pailletée argent', 'comb': 'Rose'},
    
    // RACES CHAIR
    {'name': 'Cornish', 'origin': 'Angleterre', 'type': 'Chair', 'eggsPerYear': 80, 'weight': 5.0, 'color': 'Blanc', 'comb': 'Pois'},
    {'name': 'Cobb 500', 'origin': 'États-Unis', 'type': 'Chair', 'eggsPerYear': 60, 'weight': 4.5, 'color': 'Blanc', 'comb': 'Simple'},
    {'name': 'Ross 308', 'origin': 'Écosse', 'type': 'Chair', 'eggsPerYear': 65, 'weight': 4.8, 'color': 'Blanc', 'comb': 'Simple'},
    {'name': 'Hubbard', 'origin': 'France', 'type': 'Chair', 'eggsPerYear': 70, 'weight': 4.6, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'Arbor Acres', 'origin': 'États-Unis', 'type': 'Chair', 'eggsPerYear': 60, 'weight': 4.7, 'color': 'Blanc', 'comb': 'Simple'},
    {'name': 'Jersey Giant', 'origin': 'États-Unis', 'type': 'Chair', 'eggsPerYear': 160, 'weight': 6.0, 'color': 'Noir/Blanc', 'comb': 'Simple'},
    {'name': 'Brahma', 'origin': 'États-Unis', 'type': 'Chair', 'eggsPerYear': 150, 'weight': 5.5, 'color': 'Herminée', 'comb': 'Pois'},
    {'name': 'Cochin', 'origin': 'Chine', 'type': 'Chair', 'eggsPerYear': 120, 'weight': 5.0, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'Langshan', 'origin': 'Chine', 'type': 'Chair', 'eggsPerYear': 180, 'weight': 4.5, 'color': 'Noir', 'comb': 'Simple'},
    {'name': 'Faverolles', 'origin': 'France', 'type': 'Chair', 'eggsPerYear': 180, 'weight': 4.5, 'color': 'Saumoné', 'comb': 'Simple'},
    {'name': 'Dorking', 'origin': 'Angleterre', 'type': 'Chair', 'eggsPerYear': 170, 'weight': 4.5, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'La Flèche', 'origin': 'France', 'type': 'Chair', 'eggsPerYear': 200, 'weight': 4.0, 'color': 'Noir', 'comb': 'Cornes'},
    {'name': 'Bresse', 'origin': 'France', 'type': 'Chair', 'eggsPerYear': 200, 'weight': 3.5, 'color': 'Blanc', 'comb': 'Simple'},
    {'name': 'Poulet de Houdan', 'origin': 'France', 'type': 'Chair', 'eggsPerYear': 180, 'weight': 3.5, 'color': 'Cailloutée', 'comb': 'Feuille'},
    
    // RACES ORNEMENT
    {'name': 'Sebright', 'origin': 'Angleterre', 'type': 'Ornement', 'eggsPerYear': 80, 'weight': 0.6, 'color': 'Doré/Argenté liseré', 'comb': 'Rose'},
    {'name': 'Silkie (Soie)', 'origin': 'Chine', 'type': 'Ornement', 'eggsPerYear': 100, 'weight': 1.5, 'color': 'Blanc/Noir/Fauve', 'comb': 'Noix'},
    {'name': 'Polish (Padoue)', 'origin': 'Pays-Bas', 'type': 'Ornement', 'eggsPerYear': 150, 'weight': 2.5, 'color': 'Variable', 'comb': 'Huppe'},
    {'name': 'Frizzle (Frisée)', 'origin': 'Asie', 'type': 'Ornement', 'eggsPerYear': 120, 'weight': 2.5, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'Serama', 'origin': 'Malaisie', 'type': 'Ornement', 'eggsPerYear': 60, 'weight': 0.5, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'Bantam Japonais', 'origin': 'Japon', 'type': 'Ornement', 'eggsPerYear': 80, 'weight': 0.6, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'Sultan', 'origin': 'Turquie', 'type': 'Ornement', 'eggsPerYear': 60, 'weight': 2.0, 'color': 'Blanc', 'comb': 'Cornes'},
    {'name': 'Phoenix', 'origin': 'Japon', 'type': 'Ornement', 'eggsPerYear': 100, 'weight': 2.5, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'Onagadori', 'origin': 'Japon', 'type': 'Ornement', 'eggsPerYear': 50, 'weight': 2.0, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'Yokohama', 'origin': 'Allemagne', 'type': 'Ornement', 'eggsPerYear': 90, 'weight': 2.5, 'color': 'Blanc/Rouge selle', 'comb': 'Noix'},
    {'name': 'Booted Bantam', 'origin': 'Pays-Bas', 'type': 'Ornement', 'eggsPerYear': 90, 'weight': 0.8, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'Belgian d\'Uccle', 'origin': 'Belgique', 'type': 'Ornement', 'eggsPerYear': 100, 'weight': 0.7, 'color': 'Millefleur', 'comb': 'Simple'},
    {'name': 'Appenzeller', 'origin': 'Suisse', 'type': 'Ornement', 'eggsPerYear': 150, 'weight': 1.8, 'color': 'Pailletée', 'comb': 'Cornes'},
    {'name': 'Houdan', 'origin': 'France', 'type': 'Ornement', 'eggsPerYear': 160, 'weight': 3.0, 'color': 'Cailloutée', 'comb': 'Feuille'},
    {'name': 'Crèvecoeur', 'origin': 'France', 'type': 'Ornement', 'eggsPerYear': 140, 'weight': 3.5, 'color': 'Noir', 'comb': 'Cornes'},
    
    // RACES DE COMBAT (MPIADY)
    {'name': 'Shamo', 'origin': 'Japon', 'type': 'Mpiady', 'eggsPerYear': 60, 'weight': 5.0, 'color': 'Variable', 'comb': 'Pois'},
    {'name': 'Asil (Aseel)', 'origin': 'Inde', 'type': 'Mpiady', 'eggsPerYear': 40, 'weight': 4.5, 'color': 'Variable', 'comb': 'Pois'},
    {'name': 'Ko Shamo', 'origin': 'Japon', 'type': 'Mpiady', 'eggsPerYear': 50, 'weight': 1.2, 'color': 'Variable', 'comb': 'Pois'},
    {'name': 'Malay', 'origin': 'Malaisie', 'type': 'Mpiady', 'eggsPerYear': 70, 'weight': 5.5, 'color': 'Variable', 'comb': 'Noix'},
    {'name': 'Old English Game', 'origin': 'Angleterre', 'type': 'Mpiady', 'eggsPerYear': 80, 'weight': 2.5, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'Modern Game', 'origin': 'Angleterre', 'type': 'Mpiady', 'eggsPerYear': 70, 'weight': 3.0, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'American Game', 'origin': 'États-Unis', 'type': 'Mpiady', 'eggsPerYear': 60, 'weight': 2.8, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'Thai Game', 'origin': 'Thaïlande', 'type': 'Mpiady', 'eggsPerYear': 50, 'weight': 4.0, 'color': 'Variable', 'comb': 'Pois'},
    {'name': 'Sumatra', 'origin': 'Indonésie', 'type': 'Mpiady', 'eggsPerYear': 100, 'weight': 2.5, 'color': 'Noir', 'comb': 'Pois'},
    {'name': 'Cornish Game', 'origin': 'Angleterre', 'type': 'Mpiady', 'eggsPerYear': 80, 'weight': 4.5, 'color': 'Variable', 'comb': 'Pois'},
    
    // RACES AFRICAINES ET MALGACHES
    {'name': 'Akoho Gasy', 'origin': 'Madagascar', 'type': 'Mixte', 'eggsPerYear': 120, 'weight': 2.0, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'Akoho Mena', 'origin': 'Madagascar', 'type': 'Mixte', 'eggsPerYear': 130, 'weight': 2.2, 'color': 'Rouge', 'comb': 'Simple'},
    {'name': 'Akoho Mainty', 'origin': 'Madagascar', 'type': 'Mixte', 'eggsPerYear': 110, 'weight': 2.0, 'color': 'Noir', 'comb': 'Simple'},
    {'name': 'Akoho Fotsy', 'origin': 'Madagascar', 'type': 'Pondeuse', 'eggsPerYear': 140, 'weight': 2.3, 'color': 'Blanc', 'comb': 'Simple'},
    {'name': 'Akoho Volon-tany', 'origin': 'Madagascar', 'type': 'Mixte', 'eggsPerYear': 115, 'weight': 2.1, 'color': 'Brun terre', 'comb': 'Simple'},
    {'name': 'Kuchi', 'origin': 'Afrique de l\'Est', 'type': 'Mixte', 'eggsPerYear': 100, 'weight': 2.5, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'Kuroiler', 'origin': 'Inde/Afrique', 'type': 'Mixte', 'eggsPerYear': 180, 'weight': 3.5, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'Sasso', 'origin': 'France/Afrique', 'type': 'Mixte', 'eggsPerYear': 200, 'weight': 3.2, 'color': 'Roux', 'comb': 'Simple'},
    {'name': 'Kenbro', 'origin': 'Kenya', 'type': 'Mixte', 'eggsPerYear': 220, 'weight': 3.0, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'Boschveld', 'origin': 'Afrique du Sud', 'type': 'Mixte', 'eggsPerYear': 200, 'weight': 2.8, 'color': 'Brun', 'comb': 'Simple'},
    
    // RACES ASIATIQUES
    {'name': 'Kadaknath', 'origin': 'Inde', 'type': 'Chair', 'eggsPerYear': 120, 'weight': 2.0, 'color': 'Noir (viande noire)', 'comb': 'Simple'},
    {'name': 'Ayam Cemani', 'origin': 'Indonésie', 'type': 'Ornement', 'eggsPerYear': 80, 'weight': 2.5, 'color': 'Noir total', 'comb': 'Simple'},
    {'name': 'Dong Tao', 'origin': 'Vietnam', 'type': 'Chair', 'eggsPerYear': 60, 'weight': 6.0, 'color': 'Variable', 'comb': 'Noix'},
    {'name': 'Ga Noi', 'origin': 'Vietnam', 'type': 'Mpiady', 'eggsPerYear': 50, 'weight': 4.5, 'color': 'Variable', 'comb': 'Pois'},
    {'name': 'Beijing You', 'origin': 'Chine', 'type': 'Chair', 'eggsPerYear': 100, 'weight': 3.8, 'color': 'Jaune', 'comb': 'Simple'},
    
    // RACES EUROPÉENNES SUPPLÉMENTAIRES
    {'name': 'Gauloise Dorée', 'origin': 'France', 'type': 'Pondeuse', 'eggsPerYear': 200, 'weight': 2.8, 'color': 'Doré saumoné', 'comb': 'Simple'},
    {'name': 'Géline de Touraine', 'origin': 'France', 'type': 'Mixte', 'eggsPerYear': 180, 'weight': 3.0, 'color': 'Noir', 'comb': 'Simple'},
    {'name': 'Gasconne', 'origin': 'France', 'type': 'Mixte', 'eggsPerYear': 180, 'weight': 3.2, 'color': 'Noir', 'comb': 'Simple'},
    {'name': 'Cou Nu', 'origin': 'Transylvanie', 'type': 'Mixte', 'eggsPerYear': 180, 'weight': 3.0, 'color': 'Variable', 'comb': 'Simple'},
    {'name': 'Andalouse', 'origin': 'Espagne', 'type': 'Pondeuse', 'eggsPerYear': 200, 'weight': 2.8, 'color': 'Bleu andalou', 'comb': 'Simple'},
    {'name': 'Minorque', 'origin': 'Espagne', 'type': 'Pondeuse', 'eggsPerYear': 220, 'weight': 3.0, 'color': 'Noir', 'comb': 'Simple'},
    {'name': 'Penedesenca', 'origin': 'Espagne', 'type': 'Pondeuse', 'eggsPerYear': 180, 'weight': 2.5, 'color': 'Noir', 'comb': 'Clou'},
    {'name': 'Empordanesa', 'origin': 'Espagne', 'type': 'Pondeuse', 'eggsPerYear': 170, 'weight': 2.8, 'color': 'Fauve', 'comb': 'Clou'},
    {'name': 'Livorno', 'origin': 'Italie', 'type': 'Pondeuse', 'eggsPerYear': 280, 'weight': 2.5, 'color': 'Blanc', 'comb': 'Simple'},
    {'name': 'Ancona', 'origin': 'Italie', 'type': 'Pondeuse', 'eggsPerYear': 220, 'weight': 2.5, 'color': 'Noir moucheté', 'comb': 'Simple'},
    {'name': 'Sicilienne', 'origin': 'Italie', 'type': 'Pondeuse', 'eggsPerYear': 200, 'weight': 2.3, 'color': 'Renoncule', 'comb': 'Coupe'},
  ];

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 3, vsync: this);
    _loadData();
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  Future<void> _loadData() async {
    final prefs = await SharedPreferences.getInstance();
    final breedsJson = prefs.getString('breeds_v2') ?? '[]';
    final chickensJson = prefs.getString('chickens_pedigree') ?? '[]';
    setState(() {
      _breeds = List<Map<String, dynamic>>.from(jsonDecode(breedsJson));
      _chickens = List<Map<String, dynamic>>.from(jsonDecode(chickensJson));
      // Initialiser avec les races prédéfinies si vide
      if (_breeds.isEmpty) {
        _breeds = _predefinedBreeds.map((b) => {...b, 'id': 'breed_${b['name'].hashCode}'}).toList();
        _saveData();
      }
    });
  }

  Future<void> _saveData() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('breeds_v2', jsonEncode(_breeds));
    await prefs.setString('chickens_pedigree', jsonEncode(_chickens));
  }

  // Calculer les caractéristiques prédites d'un croisement
  Map<String, dynamic> _predictCrossbreeding(Map<String, dynamic> father, Map<String, dynamic> mother) {
    final avgEggs = ((father['eggsPerYear'] ?? 0) + (mother['eggsPerYear'] ?? 0)) ~/ 2;
    final avgWeight = ((father['weight'] ?? 0.0) + (mother['weight'] ?? 0.0)) / 2;
    
    // Héritage du type dominant
    String predictedType = 'Mixte';
    if (father['type'] == mother['type']) {
      predictedType = father['type'];
    }
    
    return {
      'predictedEggs': avgEggs,
      'predictedWeight': avgWeight.toStringAsFixed(1),
      'predictedType': predictedType,
      'heterosis': '5-15%', // Vigueur hybride
    };
  }

  // Générer le nom d'un croisement
  String _generateCrossName(String father, String mother) {
    final f = father.split(' ').first.substring(0, (father.length > 3 ? 3 : father.length));
    final m = mother.split(' ').first.substring(0, (mother.length > 3 ? 3 : mother.length));
    return '$f-$m F1';
  }

  // Ajouter un poulet individuel avec pedigree
  void _addChicken() {
    final idCtrl = TextEditingController();
    final nameCtrl = TextEditingController();
    String? selectedBreed;
    String? fatherId;
    String? motherId;
    String sex = 'Vavy';
    final birthDate = TextEditingController(text: DateFormat('yyyy-MM-dd').format(DateTime.now()));
    final notesCtrl = TextEditingController();

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (ctx) => StatefulBuilder(
        builder: (context, setModalState) => Container(
          height: MediaQuery.of(ctx).size.height * 0.85,
          padding: EdgeInsets.only(bottom: MediaQuery.of(ctx).viewInsets.bottom),
          decoration: const BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
          ),
          child: Padding(
            padding: const EdgeInsets.all(24),
            child: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Container(
                        padding: const EdgeInsets.all(10),
                        decoration: BoxDecoration(
                          gradient: const LinearGradient(colors: [AppColors.gradientStart, AppColors.gradientEnd]),
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: const Text('🐓', style: TextStyle(fontSize: 24)),
                      ),
                      const SizedBox(width: 12),
                      const Expanded(child: Text('Hanampy Akoho + Pedigree', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold))),
                    ],
                  ),
                  const SizedBox(height: 20),
                  
                  // ID & Nom
                  Row(
                    children: [
                      Expanded(child: TextField(controller: idCtrl, decoration: const InputDecoration(labelText: 'ID / Bague', prefixIcon: Icon(Icons.tag)))),
                      const SizedBox(width: 12),
                      Expanded(child: TextField(controller: nameCtrl, decoration: const InputDecoration(labelText: 'Anarana', prefixIcon: Icon(Icons.pets)))),
                    ],
                  ),
                  const SizedBox(height: 12),
                  
                  // Race & Sexe
                  Row(
                    children: [
                      Expanded(
                        flex: 2,
                        child: DropdownButtonFormField<String>(
                          initialValue: selectedBreed,
                          decoration: const InputDecoration(labelText: 'Races', prefixIcon: Icon(Icons.category)),
                          items: _breeds.map((b) => DropdownMenuItem<String>(
                            value: b['id'] as String,
                            child: Text(b['name'] as String, overflow: TextOverflow.ellipsis),
                          )).toList(),
                          onChanged: (v) => setModalState(() => selectedBreed = v),
                          isExpanded: true,
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: DropdownButtonFormField<String>(
                          initialValue: sex,
                          decoration: const InputDecoration(labelText: 'Lahy/Vavy'),
                          items: ['Lahy', 'Vavy'].map((s) => DropdownMenuItem(value: s, child: Text(s))).toList(),
                          onChanged: (v) => setModalState(() => sex = v!),
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 16),
                  
                  // Section Pedigree
                  Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: AppColors.info.withValues(alpha: 0.08),
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(color: AppColors.info.withValues(alpha: 0.3)),
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Row(
                          children: [
                            Icon(Icons.account_tree, color: AppColors.info),
                            SizedBox(width: 8),
                            Text('PEDIGREE (Ray aman-dreny)', style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.info)),
                          ],
                        ),
                        const SizedBox(height: 12),
                        DropdownButtonFormField<String?>(
                          initialValue: fatherId,
                          decoration: const InputDecoration(
                            labelText: 'Ray (Lahy)',
                            prefixIcon: Icon(Icons.male, color: Colors.blue),
                            filled: true,
                            fillColor: Colors.white,
                          ),
                          items: [
                            const DropdownMenuItem<String?>(value: null, child: Text('Tsy fantatra')),
                            ..._chickens.where((c) => c['sex'] == 'Lahy').map((c) => DropdownMenuItem<String>(
                              value: c['id'] as String,
                              child: Text('${c['name']} (${c['bandId']})'),
                            )),
                          ],
                          onChanged: (v) => setModalState(() => fatherId = v),
                          isExpanded: true,
                        ),
                        const SizedBox(height: 10),
                        DropdownButtonFormField<String?>(
                          initialValue: motherId,
                          decoration: const InputDecoration(
                            labelText: 'Reny (Vavy)',
                            prefixIcon: Icon(Icons.female, color: Colors.pink),
                            filled: true,
                            fillColor: Colors.white,
                          ),
                          items: [
                            const DropdownMenuItem<String?>(value: null, child: Text('Tsy fantatra')),
                            ..._chickens.where((c) => c['sex'] == 'Vavy').map((c) => DropdownMenuItem<String>(
                              value: c['id'] as String,
                              child: Text('${c['name']} (${c['bandId']})'),
                            )),
                          ],
                          onChanged: (v) => setModalState(() => motherId = v),
                          isExpanded: true,
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 12),
                  
                  TextField(
                    controller: birthDate,
                    decoration: const InputDecoration(labelText: 'Daty nahaterahana', prefixIcon: Icon(Icons.calendar_today)),
                    readOnly: true,
                    onTap: () async {
                      final date = await showDatePicker(
                        context: context,
                        initialDate: DateTime.now(),
                        firstDate: DateTime(2020),
                        lastDate: DateTime.now(),
                      );
                      if (date != null) {
                        setModalState(() => birthDate.text = DateFormat('yyyy-MM-dd').format(date));
                      }
                    },
                  ),
                  const SizedBox(height: 12),
                  TextField(controller: notesCtrl, maxLines: 2, decoration: const InputDecoration(labelText: 'Fanamarihana', prefixIcon: Icon(Icons.notes))),
                  const SizedBox(height: 20),
                  
                  SizedBox(
                    width: double.infinity,
                    child: ElevatedButton.icon(
                      onPressed: () {
                        if (idCtrl.text.isNotEmpty && selectedBreed != null) {
                          final breed = _breeds.firstWhere((b) => b['id'] == selectedBreed);
                          setState(() {
                            _chickens.add({
                              'id': DateTime.now().millisecondsSinceEpoch.toString(),
                              'bandId': idCtrl.text,
                              'name': nameCtrl.text.isNotEmpty ? nameCtrl.text : 'Akoho ${idCtrl.text}',
                              'breedId': selectedBreed,
                              'breedName': breed['name'],
                              'sex': sex,
                              'fatherId': fatherId,
                              'motherId': motherId,
                              'birthDate': birthDate.text,
                              'notes': notesCtrl.text,
                              'generation': _calculateGeneration(fatherId, motherId),
                            });
                            _saveData();
                          });
                          Navigator.pop(ctx);
                        }
                      },
                      icon: const Icon(Icons.add),
                      label: const Text('Hampiditra'),
                      style: ElevatedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 14)),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }

  int _calculateGeneration(String? fatherId, String? motherId) {
    if (fatherId == null && motherId == null) return 0;
    int fatherGen = 0, motherGen = 0;
    if (fatherId != null) {
      final father = _chickens.firstWhere((c) => c['id'] == fatherId, orElse: () => {'generation': 0});
      fatherGen = father['generation'] ?? 0;
    }
    if (motherId != null) {
      final mother = _chickens.firstWhere((c) => c['id'] == motherId, orElse: () => {'generation': 0});
      motherGen = mother['generation'] ?? 0;
    }
    return (fatherGen > motherGen ? fatherGen : motherGen) + 1;
  }

  // Afficher l'arbre généalogique
  void _showPedigreeTree(Map<String, dynamic> chicken) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (ctx) => Container(
        height: MediaQuery.of(ctx).size.height * 0.7,
        decoration: const BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
        ),
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(10),
                    decoration: BoxDecoration(
                      gradient: const LinearGradient(colors: [AppColors.gradientStart, AppColors.gradientEnd]),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: const Icon(Icons.account_tree, color: Colors.white),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text('Pedigree: ${chicken['name']}', style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                        Text('Taranaka F${chicken['generation']}', style: TextStyle(color: AppColors.textSecondary)),
                      ],
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 24),
              
              // Arbre généalogique visuel
              Expanded(
                child: SingleChildScrollView(
                  child: _buildPedigreeNode(chicken, 0),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildPedigreeNode(Map<String, dynamic> chicken, int level) {
    final father = chicken['fatherId'] != null 
        ? _chickens.firstWhere((c) => c['id'] == chicken['fatherId'], orElse: () => {'name': 'Tsy fantatra', 'breedName': '-'})
        : null;
    final mother = chicken['motherId'] != null 
        ? _chickens.firstWhere((c) => c['id'] == chicken['motherId'], orElse: () => {'name': 'Tsy fantatra', 'breedName': '-'})
        : null;

    return Column(
      children: [
        // Current chicken
        Container(
          padding: const EdgeInsets.all(12),
          margin: EdgeInsets.only(left: level * 20.0),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: chicken['sex'] == 'Lahy' 
                  ? [Colors.blue.shade50, Colors.blue.shade100]
                  : [Colors.pink.shade50, Colors.pink.shade100],
            ),
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: chicken['sex'] == 'Lahy' ? Colors.blue : Colors.pink),
          ),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              Text(chicken['sex'] == 'Lahy' ? '🐓' : '🐔', style: const TextStyle(fontSize: 24)),
              const SizedBox(width: 8),
              Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(chicken['name'] ?? 'Inconnu', style: const TextStyle(fontWeight: FontWeight.bold)),
                  Text(chicken['breedName'] ?? '-', style: const TextStyle(fontSize: 12, color: AppColors.textSecondary)),
                  if (chicken['bandId'] != null) Text('ID: ${chicken['bandId']}', style: const TextStyle(fontSize: 11)),
                ],
              ),
            ],
          ),
        ),
        
        if (father != null || mother != null) ...[
          const SizedBox(height: 8),
          Row(
            children: [
              SizedBox(width: (level + 1) * 20.0),
              const Icon(Icons.subdirectory_arrow_right, color: AppColors.textSecondary),
              const Text(' Parents:', style: TextStyle(color: AppColors.textSecondary, fontSize: 12)),
            ],
          ),
          const SizedBox(height: 8),
          if (father != null && father['name'] != null)
            _buildParentCard(father, 'Lahy', level + 1),
          if (mother != null && mother['name'] != null)
            _buildParentCard(mother, 'Vavy', level + 1),
        ],
      ],
    );
  }

  Widget _buildParentCard(Map<String, dynamic> parent, String sex, int level) {
    return GestureDetector(
      onTap: () {
        if (parent['id'] != null) _showPedigreeTree(parent);
      },
      child: Container(
        padding: const EdgeInsets.all(10),
        margin: EdgeInsets.only(left: level * 20.0, bottom: 8),
        decoration: BoxDecoration(
          color: sex == 'Lahy' ? Colors.blue.shade50 : Colors.pink.shade50,
          borderRadius: BorderRadius.circular(10),
          border: Border.all(color: (sex == 'Lahy' ? Colors.blue : Colors.pink).withValues(alpha: 0.3)),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(sex == 'Lahy' ? Icons.male : Icons.female, 
                color: sex == 'Lahy' ? Colors.blue : Colors.pink, size: 20),
            const SizedBox(width: 6),
            Text(parent['name'] ?? 'Tsy fantatra', style: const TextStyle(fontWeight: FontWeight.w500)),
            if (parent['breedName'] != null) Text(' (${parent['breedName']})', style: const TextStyle(fontSize: 11)),
            if (parent['id'] != null) const Icon(Icons.chevron_right, size: 16),
          ],
        ),
      ),
    );
  }

  // Simuler un croisement
  void _simulateCrossbreeding() {
    String? fatherId, motherId;

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (ctx) => StatefulBuilder(
        builder: (context, setModalState) {
          Map<String, dynamic>? prediction;
          if (fatherId != null && motherId != null) {
            final father = _breeds.firstWhere((b) => b['id'] == fatherId, orElse: () => {});
            final mother = _breeds.firstWhere((b) => b['id'] == motherId, orElse: () => {});
            if (father.isNotEmpty && mother.isNotEmpty) {
              prediction = _predictCrossbreeding(father, mother);
            }
          }

          return Container(
            height: MediaQuery.of(ctx).size.height * 0.75,
            decoration: const BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
            ),
            child: Padding(
              padding: const EdgeInsets.all(24),
              child: SingleChildScrollView(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Container(
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            gradient: const LinearGradient(colors: [Colors.purple, Colors.deepPurple]),
                            borderRadius: BorderRadius.circular(12),
                          ),
                          child: const Icon(Icons.science, color: Colors.white),
                        ),
                        const SizedBox(width: 12),
                        const Expanded(child: Text('Simulation Fampifandraisana', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold))),
                      ],
                    ),
                    const SizedBox(height: 20),
                    
                    const Text('Safidio races roa hampifandraisina:', style: TextStyle(color: AppColors.textSecondary)),
                    const SizedBox(height: 12),
                    
                    // Père
                    DropdownButtonFormField<String>(
                      initialValue: fatherId,
                      decoration: InputDecoration(
                        labelText: 'Race Ray (Lahy)',
                        prefixIcon: const Icon(Icons.male, color: Colors.blue),
                        filled: true,
                        fillColor: Colors.blue.shade50,
                      ),
                      items: _breeds.map((b) => DropdownMenuItem<String>(
                        value: b['id'] as String,
                        child: Text('${b['name']} (${b['origin']})'),
                      )).toList(),
                      onChanged: (v) => setModalState(() => fatherId = v),
                      isExpanded: true,
                    ),
                    const SizedBox(height: 12),
                    
                    // Mère
                    DropdownButtonFormField<String>(
                      initialValue: motherId,
                      decoration: InputDecoration(
                        labelText: 'Race Reny (Vavy)',
                        prefixIcon: const Icon(Icons.female, color: Colors.pink),
                        filled: true,
                        fillColor: Colors.pink.shade50,
                      ),
                      items: _breeds.map((b) => DropdownMenuItem<String>(
                        value: b['id'] as String,
                        child: Text('${b['name']} (${b['origin']})'),
                      )).toList(),
                      onChanged: (v) => setModalState(() => motherId = v),
                      isExpanded: true,
                    ),
                    
                    if (prediction != null) ...[
                      const SizedBox(height: 24),
                      Container(
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          gradient: LinearGradient(
                            colors: [Colors.green.shade50, Colors.teal.shade50],
                          ),
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(color: Colors.green.shade200),
                        ),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                const Icon(Icons.auto_awesome, color: Colors.green),
                                const SizedBox(width: 8),
                                Text(
                                  'Taranaka F1: ${_generateCrossName(_breeds.firstWhere((b) => b['id'] == fatherId)['name'], _breeds.firstWhere((b) => b['id'] == motherId)['name'])}',
                                  style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16),
                                ),
                              ],
                            ),
                            const Divider(height: 20),
                            _buildPredictionRow('Karazany vinavinaina', prediction['predictedType']),
                            _buildPredictionRow('Atody/taona vinavinaina', '~${prediction['predictedEggs']}'),
                            _buildPredictionRow('Lanja vinavinaina', '~${prediction['predictedWeight']} kg'),
                            _buildPredictionRow('Hétérosis (Vigueur hybride)', prediction['heterosis']),
                            const SizedBox(height: 12),
                            Container(
                              padding: const EdgeInsets.all(10),
                              decoration: BoxDecoration(
                                color: Colors.amber.shade50,
                                borderRadius: BorderRadius.circular(8),
                              ),
                              child: const Row(
                                children: [
                                  Icon(Icons.lightbulb, color: Colors.amber, size: 18),
                                  SizedBox(width: 8),
                                  Expanded(
                                    child: Text(
                                      'Ny taranaka F1 dia matetika mahery noho ny ray aman-dreny (hétérosis)',
                                      style: TextStyle(fontSize: 12),
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _buildPredictionRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Expanded(
            child: Text(
              label,
              style: const TextStyle(color: AppColors.textSecondary),
              overflow: TextOverflow.ellipsis,
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              value,
              style: const TextStyle(fontWeight: FontWeight.bold),
              textAlign: TextAlign.right,
              overflow: TextOverflow.ellipsis,
              maxLines: 2,
            ),
          ),
        ],
      ),
    );
  }

  List<Map<String, dynamic>> get _filteredBreeds {
    var breeds = _breeds;
    if (_filterType != 'Rehetra') {
      breeds = breeds.where((b) => b['type'] == _filterType).toList();
    }
    if (_searchQuery.isNotEmpty) {
      breeds = breeds.where((b) => 
        (b['name'] as String).toLowerCase().contains(_searchQuery.toLowerCase()) ||
        (b['origin'] as String).toLowerCase().contains(_searchQuery.toLowerCase())
      ).toList();
    }
    return breeds;
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // Stats Row
        Padding(
          padding: const EdgeInsets.all(16),
          child: Row(
            children: [
              Expanded(
                child: _buildStatCard(
                  label: 'Races',
                  value: '${_breeds.length}',
                  icon: Icons.category,
                  color: AppColors.primary,
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: _buildStatCard(
                  label: 'Akoho',
                  value: '${_chickens.length}',
                  icon: Icons.pets,
                  color: AppColors.accent,
                ),
              ),
            ],
          ),
        ),
        
        // Tab Bar
        Container(
          margin: const EdgeInsets.symmetric(horizontal: 16),
          decoration: BoxDecoration(
            color: AppColors.background,
            borderRadius: BorderRadius.circular(12),
          ),
          child: TabBar(
            controller: _tabController,
            labelColor: Colors.white,
            unselectedLabelColor: AppColors.textSecondary,
            indicator: BoxDecoration(
              gradient: const LinearGradient(colors: [AppColors.gradientStart, AppColors.gradientEnd]),
              borderRadius: BorderRadius.circular(10),
            ),
            indicatorSize: TabBarIndicatorSize.tab,
            tabs: const [
              Tab(text: '🐔 Races (100+)'),
              Tab(text: '🐓 Akoho'),
              Tab(text: '🧬 Pedigree'),
            ],
          ),
        ),
        
        // Tab Content
        Expanded(
          child: TabBarView(
            controller: _tabController,
            children: [
              // TAB 1: Races Database
              _buildRacesTab(),
              
              // TAB 2: Individual Chickens
              _buildChickensTab(),
              
              // TAB 3: Pedigree & Crossbreeding
              _buildPedigreeTab(),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildRacesTab() {
    return Column(
      children: [
        // Search & Filter
        Padding(
          padding: const EdgeInsets.all(16),
          child: Row(
            children: [
              Expanded(
                child: TextField(
                  decoration: InputDecoration(
                    hintText: 'Hikaroka races...',
                    prefixIcon: const Icon(Icons.search),
                    filled: true,
                    fillColor: Colors.white,
                    border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
                  ),
                  onChanged: (v) => setState(() => _searchQuery = v),
                ),
              ),
              const SizedBox(width: 12),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 12),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                ),
                child: DropdownButton<String>(
                  value: _filterType,
                  underline: const SizedBox(),
                  items: ['Rehetra', 'Pondeuse', 'Chair', 'Mixte', 'Ornement', 'Mpiady']
                      .map((t) => DropdownMenuItem(value: t, child: Text(t)))
                      .toList(),
                  onChanged: (v) => setState(() => _filterType = v!),
                ),
              ),
            ],
          ),
        ),
        
        // Breeds List
        Expanded(
          child: ListView.builder(
            padding: const EdgeInsets.symmetric(horizontal: 16),
            itemCount: _filteredBreeds.length,
            itemBuilder: (ctx, i) {
              final breed = _filteredBreeds[i];
              final typeColor = breed['type'] == 'Pondeuse' ? Colors.orange
                  : breed['type'] == 'Chair' ? Colors.red
                  : breed['type'] == 'Ornement' ? Colors.purple
                  : breed['type'] == 'Mpiady' ? Colors.deepOrange
                  : AppColors.primary;
              
              return Container(
                margin: const EdgeInsets.only(bottom: 10),
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(14),
                  boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.08), blurRadius: 10)],
                ),
                child: Row(
                  children: [
                    Container(
                      width: 50,
                      height: 50,
                      decoration: BoxDecoration(
                        color: typeColor.withValues(alpha: 0.15),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Center(child: Text(_getBreedEmoji(breed['type']), style: const TextStyle(fontSize: 24))),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(breed['name'], style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 15)),
                          Row(
                            children: [
                              Container(
                                padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                                decoration: BoxDecoration(
                                  color: typeColor.withValues(alpha: 0.15),
                                  borderRadius: BorderRadius.circular(4),
                                ),
                                child: Text(breed['type'], style: TextStyle(color: typeColor, fontSize: 10, fontWeight: FontWeight.bold)),
                              ),
                              const SizedBox(width: 6),
                              Text('📍 ${breed['origin']}', style: const TextStyle(fontSize: 11, color: AppColors.textSecondary)),
                            ],
                          ),
                          const SizedBox(height: 4),
                          Text(
                            '🥚 ${breed['eggsPerYear']}/taona  •  ⚖️ ${breed['weight']}kg  •  🎨 ${breed['color'] ?? '-'}',
                            style: const TextStyle(fontSize: 11),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              );
            },
          ),
        ),
      ],
    );
  }

  String _getBreedEmoji(String type) {
    switch (type) {
      case 'Pondeuse': return '🥚';
      case 'Chair': return '🍗';
      case 'Ornement': return '🦚';
      case 'Mpiady': return '🐓';
      default: return '🐔';
    }
  }

  Widget _buildChickensTab() {
    return Column(
      children: [
        Expanded(
          child: _chickens.isEmpty
              ? Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Text('🐣', style: TextStyle(fontSize: 60)),
                      const SizedBox(height: 12),
                      const Text('Tsy misy akoho voasoratra', style: TextStyle(color: AppColors.textSecondary)),
                      const SizedBox(height: 16),
                      ElevatedButton.icon(
                        onPressed: _addChicken,
                        icon: const Icon(Icons.add),
                        label: const Text('Hanampy akoho voalohany'),
                      ),
                    ],
                  ),
                )
              : ListView.builder(
                  padding: const EdgeInsets.all(16),
                  itemCount: _chickens.length,
                  itemBuilder: (ctx, i) {
                    final chicken = _chickens[i];
                    return Container(
                      margin: const EdgeInsets.only(bottom: 10),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(14),
                        boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.08), blurRadius: 10)],
                      ),
                      child: ListTile(
                        leading: Container(
                          width: 45,
                          height: 45,
                          decoration: BoxDecoration(
                            color: chicken['sex'] == 'Lahy' ? Colors.blue.shade50 : Colors.pink.shade50,
                            borderRadius: BorderRadius.circular(10),
                          ),
                          child: Center(
                            child: Text(chicken['sex'] == 'Lahy' ? '🐓' : '🐔', style: const TextStyle(fontSize: 22)),
                          ),
                        ),
                        title: Text(chicken['name'], style: const TextStyle(fontWeight: FontWeight.bold)),
                        subtitle: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text('${chicken['breedName']} • ID: ${chicken['bandId']}'),
                            Text('Taranaka F${chicken['generation']} • ${chicken['birthDate']}', 
                                style: const TextStyle(fontSize: 11, color: AppColors.textSecondary)),
                          ],
                        ),
                        trailing: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            IconButton(
                              icon: const Icon(Icons.account_tree, color: AppColors.info),
                              onPressed: () => _showPedigreeTree(chicken),
                              tooltip: 'Pedigree',
                            ),
                            IconButton(
                              icon: const Icon(Icons.delete_outline, color: AppColors.error),
                              onPressed: () {
                                setState(() {
                                  _chickens.removeAt(i);
                                  _saveData();
                                });
                              },
                            ),
                          ],
                        ),
                      ),
                    );
                  },
                ),
        ),
        Padding(
          padding: const EdgeInsets.all(16),
          child: SizedBox(
            width: double.infinity,
            child: ElevatedButton.icon(
              onPressed: _addChicken,
              icon: const Icon(Icons.add),
              label: const Text('Hanampy Akoho + Pedigree'),
              style: ElevatedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 14)),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildPedigreeTab() {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          // Simulation Card
          Container(
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [Colors.purple.shade400, Colors.deepPurple.shade600],
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
              ),
              borderRadius: BorderRadius.circular(20),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Icon(Icons.science, color: Colors.white, size: 28),
                    SizedBox(width: 10),
                    Expanded(child: Text('Simulation Fampifandraisana', style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold))),
                  ],
                ),
                const SizedBox(height: 10),
                const Text(
                  'Jereo ny vokatra azo avy amin\'ny fampifandraisana races roa',
                  style: TextStyle(color: Colors.white70),
                ),
                const SizedBox(height: 16),
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    onPressed: _simulateCrossbreeding,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.white,
                      foregroundColor: Colors.deepPurple,
                      padding: const EdgeInsets.symmetric(vertical: 12),
                    ),
                    child: const Text('Hanomboka Simulation'),
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 20),
          
          // Stats
          Row(
            children: [
              Expanded(
                child: Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(14),
                    boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.08), blurRadius: 10)],
                  ),
                  child: Column(
                    children: [
                      const Text('🧬', style: TextStyle(fontSize: 30)),
                      const SizedBox(height: 8),
                      Text('${_breeds.length * (_breeds.length - 1)}', style: const TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),
                      const Text('Fampifandraisana azo atao', style: TextStyle(fontSize: 11, color: AppColors.textSecondary)),
                    ],
                  ),
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(14),
                    boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.08), blurRadius: 10)],
                  ),
                  child: Column(
                    children: [
                      const Text('📊', style: TextStyle(fontSize: 30)),
                      const SizedBox(height: 8),
                      Text('${_chickens.where((c) => c['generation'] > 0).length}', style: const TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),
                      const Text('Akoho miaraka pedigree', style: TextStyle(fontSize: 11, color: AppColors.textSecondary)),
                    ],
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 20),
          
          // Info Card
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.amber.shade50,
              borderRadius: BorderRadius.circular(14),
              border: Border.all(color: Colors.amber.shade200),
            ),
            child: const Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Icon(Icons.lightbulb, color: Colors.amber),
                    SizedBox(width: 8),
                    Text('Momba ny Pedigree', style: TextStyle(fontWeight: FontWeight.bold)),
                  ],
                ),
                SizedBox(height: 10),
                Text('• F0: Razambe tsy fantatra ny ray aman-dreny'),
                Text('• F1: Taranaka voalohany (ray aman-dreny F0)'),
                Text('• F2+: Taranaka manaraka (ray aman-dreny F1+)'),
                SizedBox(height: 8),
                Text('Ny pedigree dia manampy amin\'ny:'),
                Text('  - Fisafidianana ny tsara indrindra'),
                Text('  - Fisorohana ny inbreeding'),
                Text('  - Fanaraha-maso ny toetra taloha'),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

// --- MODULE 6: ATODY (EGGS & CHICKS MANAGEMENT) ---
class EggsScreen extends StatefulWidget {
  const EggsScreen({super.key});

  @override
  State<EggsScreen> createState() => _EggsScreenState();
}

class _EggsScreenState extends State<EggsScreen> with SingleTickerProviderStateMixin {
  List<Map<String, dynamic>> _eggCollections = [];
  List<Map<String, dynamic>> _incubations = [];
  late TabController _tabController;

  // Temps d'incubation/gestation par type d'animal
  static const Map<String, Map<String, dynamic>> _incubationData = {
    'Akoho (Poule)': {'days': 21, 'temp': '37.5-37.8°C', 'humidity': '55-60%', 'emoji': '🐔', 'turning': '3-5x/andro'},
    'Gana (Canard)': {'days': 28, 'temp': '37.5°C', 'humidity': '55-70%', 'emoji': '🦆', 'turning': '3-5x/andro'},
    'Dokotra (Canard Barbarie)': {'days': 35, 'temp': '37.5°C', 'humidity': '55-70%', 'emoji': '🦆', 'turning': '3-5x/andro'},
    'Gisa (Oie)': {'days': 30, 'temp': '37.4°C', 'humidity': '55-70%', 'emoji': '🦢', 'turning': '3-5x/andro'},
    'Vorontsiloza (Dinde)': {'days': 28, 'temp': '37.5°C', 'humidity': '55-60%', 'emoji': '🦃', 'turning': '3-5x/andro'},
    'Akanga (Pintade)': {'days': 26, 'temp': '37.5°C', 'humidity': '55-60%', 'emoji': '🐓', 'turning': '3-5x/andro'},
    'Akohonala (Faisan)': {'days': 24, 'temp': '37.5°C', 'humidity': '55-60%', 'emoji': '🦃', 'turning': '3-5x/andro'},
    'Papelika (Caille)': {'days': 17, 'temp': '37.5°C', 'humidity': '55-60%', 'emoji': '🐦', 'turning': '4-6x/andro'},
    'Aotrisy (Autruche)': {'days': 42, 'temp': '36.1°C', 'humidity': '25-35%', 'emoji': '🦚', 'turning': '3x/andro'},
    'Bitro (Lapin)': {'days': 31, 'temp': 'Gestation', 'humidity': '4-12 zaza', 'emoji': '🐇', 'turning': 'Tsy ilaina'},
    'Bitro Voalavo (Cochon d\'Inde)': {'days': 68, 'temp': 'Gestation', 'humidity': '1-6 zaza', 'emoji': '🐹', 'turning': 'Tsy ilaina'},
  };

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 2, vsync: this);
    _loadData();
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  Future<void> _loadData() async {
    final prefs = await SharedPreferences.getInstance();
    final eggsJson = prefs.getString('eggCollections') ?? '[]';
    final incubJson = prefs.getString('incubations') ?? '[]';
    setState(() {
      _eggCollections = List<Map<String, dynamic>>.from(jsonDecode(eggsJson));
      _incubations = List<Map<String, dynamic>>.from(jsonDecode(incubJson));
    });
  }

  Future<void> _saveData() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('eggCollections', jsonEncode(_eggCollections));
    await prefs.setString('incubations', jsonEncode(_incubations));
  }

  int get _totalEggsToday {
    final today = DateFormat('yyyy-MM-dd').format(DateTime.now());
    return _eggCollections
        .where((e) => e['date'] == today)
        .fold(0, (sum, e) => sum + (e['quantity'] as int));
  }

  int get _totalEggsWeek {
    final now = DateTime.now();
    final weekAgo = now.subtract(const Duration(days: 7));
    return _eggCollections.where((e) {
      final date = DateTime.tryParse(e['date'] ?? '');
      return date != null && date.isAfter(weekAgo);
    }).fold(0, (sum, e) => sum + (e['quantity'] as int));
  }

  void _addEggCollection() {
    final quantityCtrl = TextEditingController();
    final notesCtrl = TextEditingController();
    DateTime selectedDate = DateTime.now();

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (ctx) => StatefulBuilder(
        builder: (context, setModalState) => Container(
          padding: EdgeInsets.only(bottom: MediaQuery.of(ctx).viewInsets.bottom),
          decoration: const BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
          ),
          child: Padding(
            padding: const EdgeInsets.all(24),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(10),
                      decoration: BoxDecoration(
                        color: AppColors.warning.withValues(alpha: 0.1),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: const Text('🥚', style: TextStyle(fontSize: 24)),
                    ),
                    const SizedBox(width: 12),
                    const Text('Atody Voangona', style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
                  ],
                ),
                const SizedBox(height: 20),
                GestureDetector(
                  onTap: () async {
                    final picked = await showDatePicker(
                      context: context,
                      initialDate: selectedDate,
                      firstDate: DateTime(2020),
                      lastDate: DateTime.now(),
                    );
                    if (picked != null) setModalState(() => selectedDate = picked);
                  },
                  child: Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: Colors.grey[100],
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Row(
                      children: [
                        const Icon(Icons.calendar_today, color: AppColors.primary),
                        const SizedBox(width: 12),
                        Text(DateFormat('dd MMMM yyyy').format(selectedDate), style: const TextStyle(fontSize: 16)),
                      ],
                    ),
                  ),
                ),
                const SizedBox(height: 12),
                TextField(
                  controller: quantityCtrl,
                  keyboardType: TextInputType.number,
                  decoration: const InputDecoration(labelText: 'Isan\'ny atody', prefixIcon: Icon(Icons.numbers)),
                ),
                const SizedBox(height: 12),
                TextField(controller: notesCtrl, decoration: const InputDecoration(labelText: 'Fanamarihana', prefixIcon: Icon(Icons.notes))),
                const SizedBox(height: 20),
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton.icon(
                    onPressed: () {
                      if (quantityCtrl.text.isNotEmpty) {
                        setState(() {
                          _eggCollections.add({
                            'id': DateTime.now().millisecondsSinceEpoch.toString(),
                            'date': DateFormat('yyyy-MM-dd').format(selectedDate),
                            'quantity': int.tryParse(quantityCtrl.text) ?? 0,
                            'notes': notesCtrl.text,
                          });
                          _saveData();
                        });
                        Navigator.pop(ctx);
                      }
                    },
                    icon: const Icon(Icons.add),
                    label: const Text('Hampiditra'),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  void _addIncubation() {
    final quantityCtrl = TextEditingController();
    final notesCtrl = TextEditingController();
    DateTime startDate = DateTime.now();
    bool enableAlarm = true;
    String selectedType = 'Akoho (Poule)';

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (ctx) => StatefulBuilder(
        builder: (context, setModalState) {
          final incubData = _incubationData[selectedType]!;
          final int incubDays = incubData['days'];
          final hatchDate = startDate.add(Duration(days: incubDays));
          
          return Container(
            height: MediaQuery.of(ctx).size.height * 0.85,
            padding: EdgeInsets.only(bottom: MediaQuery.of(ctx).viewInsets.bottom),
            decoration: const BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
            ),
            child: Padding(
              padding: const EdgeInsets.all(24),
              child: SingleChildScrollView(
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        Container(
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: AppColors.success.withValues(alpha: 0.1),
                            borderRadius: BorderRadius.circular(12),
                          ),
                          child: Text(incubData['emoji'], style: const TextStyle(fontSize: 24)),
                        ),
                        const SizedBox(width: 12),
                        const Expanded(child: Text('Fanaovana Zana-akoho', style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold))),
                      ],
                    ),
                    const SizedBox(height: 20),
                    
                    // Type de volaille
                    DropdownButtonFormField<String>(
                      initialValue: selectedType,
                      decoration: const InputDecoration(
                        labelText: 'Karazan\'ny vorona',
                        prefixIcon: Icon(Icons.egg_alt),
                      ),
                      items: _incubationData.keys.map((type) => DropdownMenuItem(
                        value: type,
                        child: Row(
                          children: [
                            Text(_incubationData[type]!['emoji'], style: const TextStyle(fontSize: 18)),
                            const SizedBox(width: 8),
                            Expanded(child: Text(type, overflow: TextOverflow.ellipsis)),
                            Text(' (${_incubationData[type]!['days']} andro)', style: const TextStyle(color: AppColors.textSecondary, fontSize: 12)),
                          ],
                        ),
                      )).toList(),
                      onChanged: (v) => setModalState(() => selectedType = v!),
                    ),
                    const SizedBox(height: 16),
                    
                    // Informations d'incubation
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          colors: [Colors.blue.shade50, Colors.cyan.shade50],
                        ),
                        borderRadius: BorderRadius.circular(16),
                        border: Border.all(color: Colors.blue.shade200),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              const Icon(Icons.info_outline, color: Colors.blue),
                              const SizedBox(width: 8),
                              Text('Fampahalalana momba ny $selectedType', style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.blue)),
                            ],
                          ),
                          const Divider(),
                          _buildInfoRow('⏱️ Fotoana fanaovana', '$incubDays andro'),
                          _buildInfoRow('🌡️ Hafanana', incubData['temp']),
                          _buildInfoRow('💧 Hamandoana', incubData['humidity']),
                          _buildInfoRow('🔄 Famadihana', incubData['turning']),
                        ],
                      ),
                    ),
                    const SizedBox(height: 16),
                    
                    // Date de début
                    GestureDetector(
                      onTap: () async {
                        final picked = await showDatePicker(
                          context: context,
                          initialDate: startDate,
                          firstDate: DateTime(2020),
                          lastDate: DateTime.now().add(const Duration(days: 30)),
                        );
                        if (picked != null) setModalState(() => startDate = picked);
                      },
                      child: Container(
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          color: Colors.grey[100],
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: Row(
                          children: [
                            const Icon(Icons.calendar_today, color: AppColors.primary),
                            const SizedBox(width: 12),
                            Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                const Text('Daty nanombohana', style: TextStyle(color: AppColors.textSecondary, fontSize: 12)),
                                Text(DateFormat('dd MMMM yyyy').format(startDate), style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                              ],
                            ),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 12),
                    
                    // Date d'éclosion calculée
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: AppColors.success.withValues(alpha: 0.08),
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(color: AppColors.success.withValues(alpha: 0.3)),
                      ),
                      child: Row(
                        children: [
                          const Icon(Icons.event_available, color: AppColors.success),
                          const SizedBox(width: 12),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                const Text('Daty hiterahan\'ny zana-akoho', style: TextStyle(color: AppColors.textSecondary, fontSize: 12)),
                                Text(
                                  DateFormat('dd MMMM yyyy').format(hatchDate),
                                  style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: AppColors.success),
                                ),
                              ],
                            ),
                          ),
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                            decoration: BoxDecoration(
                              color: AppColors.success,
                              borderRadius: BorderRadius.circular(20),
                            ),
                            child: Text('$incubDays andro', style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 12),
                    
                    // Étapes d'incubation
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: Colors.amber.shade50,
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Row(
                            children: [
                              Icon(Icons.timeline, color: Colors.amber),
                              SizedBox(width: 8),
                              Text('Dingana amin\'ny fanaovana', style: TextStyle(fontWeight: FontWeight.bold)),
                            ],
                          ),
                          const SizedBox(height: 10),
                          _buildStageRow('1-7', 'Fiforonana taolana', '🔄 Mamadika matetika'),
                          _buildStageRow('8-14', 'Fitomboana', '💧 Tandremo hamandoana'),
                          _buildStageRow('15-18', 'Fiomanana', '🔍 Mirage atody'),
                          _buildStageRow('19-21', 'Éclosion', '⏳ Aza manetsika!'),
                        ],
                      ),
                    ),
                    const SizedBox(height: 12),
                    
                    TextField(
                      controller: quantityCtrl,
                      keyboardType: TextInputType.number,
                      decoration: const InputDecoration(labelText: 'Isan\'ny atody', prefixIcon: Icon(Icons.numbers)),
                    ),
                    const SizedBox(height: 12),
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                      decoration: BoxDecoration(
                        color: Colors.grey[100],
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Row(
                        children: [
                          const Icon(Icons.alarm, color: AppColors.warning),
                          const SizedBox(width: 12),
                          const Expanded(child: Text('Alerte réveil éclosion')),
                          Switch(
                            value: enableAlarm,
                            onChanged: (v) => setModalState(() => enableAlarm = v),
                            activeThumbColor: AppColors.success,
                            activeTrackColor: AppColors.success.withValues(alpha: 0.4),
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 12),
                    TextField(controller: notesCtrl, decoration: const InputDecoration(labelText: 'Fanamarihana', prefixIcon: Icon(Icons.notes))),
                    const SizedBox(height: 20),
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton.icon(
                        onPressed: () {
                          if (quantityCtrl.text.isNotEmpty) {
                            setState(() {
                              _incubations.add({
                                'id': DateTime.now().millisecondsSinceEpoch.toString(),
                                'type': selectedType,
                                'incubDays': incubDays,
                                'startDate': DateFormat('yyyy-MM-dd').format(startDate),
                                'hatchDate': DateFormat('yyyy-MM-dd').format(hatchDate),
                                'quantity': int.tryParse(quantityCtrl.text) ?? 0,
                                'hatched': 0,
                                'status': 'En cours',
                                'alarmEnabled': enableAlarm,
                                'notes': notesCtrl.text,
                              });
                              _saveData();
                            });
                            Navigator.pop(ctx);
                            if (enableAlarm) {
                              ScaffoldMessenger.of(context).showSnackBar(
                                SnackBar(
                                  content: Text('⏰ Réveil programmé pour le ${DateFormat('dd/MM/yyyy').format(hatchDate)}'),
                                  backgroundColor: AppColors.success,
                                ),
                              );
                            }
                          }
                        },
                        icon: const Icon(Icons.add),
                        label: const Text('Hampiditra'),
                        style: ElevatedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 14)),
                      ),
                    ),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _buildInfoRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Expanded(
            child: Text(
              label,
              overflow: TextOverflow.ellipsis,
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              value,
              style: const TextStyle(fontWeight: FontWeight.bold),
              textAlign: TextAlign.right,
              overflow: TextOverflow.ellipsis,
              maxLines: 2,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStageRow(String days, String title, String note) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 3),
      child: Row(
        children: [
          Container(
            width: 50,
            padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
            decoration: BoxDecoration(
              color: Colors.amber.shade200,
              borderRadius: BorderRadius.circular(4),
            ),
            child: Text('J$days', style: const TextStyle(fontSize: 11, fontWeight: FontWeight.bold), textAlign: TextAlign.center),
          ),
          const SizedBox(width: 8),
          Expanded(child: Text(title, style: const TextStyle(fontWeight: FontWeight.w500), overflow: TextOverflow.ellipsis)),
          const SizedBox(width: 8),
          Text(note, style: const TextStyle(fontSize: 11, color: AppColors.textSecondary)),
        ],
      ),
    );
  }

  int _daysRemaining(String hatchDateStr) {
    final hatchDate = DateTime.tryParse(hatchDateStr);
    if (hatchDate == null) return 0;
    return hatchDate.difference(DateTime.now()).inDays;
  }

  void _updateHatchedCount(Map<String, dynamic> incubation) {
    final hatchedCtrl = TextEditingController(text: incubation['hatched'].toString());
    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        title: const Text('Zana-akoho teraka'),
        content: TextField(
          controller: hatchedCtrl,
          keyboardType: TextInputType.number,
          decoration: const InputDecoration(labelText: 'Isa teraka'),
        ),
        actions: [
          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Ajanona')),
          ElevatedButton(
            onPressed: () {
              setState(() {
                incubation['hatched'] = int.tryParse(hatchedCtrl.text) ?? 0;
                if (incubation['hatched'] >= incubation['quantity']) {
                  incubation['status'] = 'Vita';
                }
                _saveData();
              });
              Navigator.pop(ctx);
            },
            child: const Text('Raikitra'),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // Stats Header
        Container(
          margin: const EdgeInsets.all(16),
          child: Row(
            children: [
              Expanded(
                child: _buildStatCard(
                  label: 'Anio',
                  value: '$_totalEggsToday 🥚',
                  icon: Icons.today,
                  color: AppColors.warning,
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: _buildStatCard(
                  label: 'Herinandro',
                  value: '$_totalEggsWeek 🥚',
                  icon: Icons.date_range,
                  color: AppColors.accent,
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: _buildStatCard(
                  label: 'Miandry',
                  value: '${_incubations.where((i) => i['status'] == 'En cours').length} 🐣',
                  icon: Icons.egg_alt,
                  color: AppColors.success,
                ),
              ),
            ],
          ),
        ),
        
        // Tab Bar
        Container(
          margin: const EdgeInsets.symmetric(horizontal: 16),
          decoration: BoxDecoration(
            color: Colors.grey[200],
            borderRadius: BorderRadius.circular(12),
          ),
          child: TabBar(
            controller: _tabController,
            indicator: BoxDecoration(
              color: AppColors.primary,
              borderRadius: BorderRadius.circular(12),
            ),
            labelColor: Colors.white,
            unselectedLabelColor: AppColors.textSecondary,
            indicatorSize: TabBarIndicatorSize.tab,
            dividerColor: Colors.transparent,
            tabs: const [
              Tab(text: '🥚 Atody Voangona'),
              Tab(text: '🐣 Zana-akoho'),
            ],
          ),
        ),
        
        // Tab Views
        Expanded(
          child: TabBarView(
            controller: _tabController,
            children: [
              // Egg Collections Tab
              SingleChildScrollView(
                padding: const EdgeInsets.all(16),
                child: Column(
                  children: [
                    ..._eggCollections.reversed.take(20).map((egg) => Container(
                      margin: const EdgeInsets.only(bottom: 10),
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(16),
                        boxShadow: [
                          BoxShadow(color: Colors.black.withValues(alpha: 0.06), blurRadius: 10, offset: const Offset(0, 4)),
                        ],
                      ),
                      child: Row(
                        children: [
                          Container(
                            width: 50,
                            height: 50,
                            decoration: BoxDecoration(
                              color: AppColors.warning.withValues(alpha: 0.12),
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: const Center(child: Text('🥚', style: TextStyle(fontSize: 24))),
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text('${egg['quantity']} atody', style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 18)),
                                Text('📅 ${egg['date']}', style: const TextStyle(color: AppColors.textSecondary)),
                                if (egg['notes'].isNotEmpty) Text('📝 ${egg['notes']}', style: const TextStyle(fontSize: 12)),
                              ],
                            ),
                          ),
                          IconButton(
                            icon: const Icon(Icons.delete_outline, color: AppColors.error),
                            onPressed: () {
                              setState(() {
                                _eggCollections.removeWhere((e) => e['id'] == egg['id']);
                                _saveData();
                              });
                            },
                          ),
                        ],
                      ),
                    )),
                    const SizedBox(height: 70),
                  ],
                ),
              ),
              
              // Incubations Tab
              SingleChildScrollView(
                padding: const EdgeInsets.all(16),
                child: Column(
                  children: [
                    ..._incubations.reversed.map((incub) {
                      final daysLeft = _daysRemaining(incub['hatchDate']);
                      final isReady = daysLeft <= 0;
                      final incubDays = incub['incubDays'] ?? 21;
                      final progress = incub['status'] == 'Vita' ? 1.0 : (incubDays - daysLeft.clamp(0, incubDays)) / incubDays;
                      final incubType = incub['type'] ?? 'Akoho (Poule)';
                      final incubData = _incubationData[incubType] ?? _incubationData['Akoho (Poule)']!;
                      
                      return Container(
                        margin: const EdgeInsets.only(bottom: 12),
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          color: Colors.white,
                          borderRadius: BorderRadius.circular(16),
                          border: isReady && incub['status'] != 'Vita'
                              ? Border.all(color: AppColors.success, width: 2)
                              : null,
                          boxShadow: [
                            BoxShadow(color: Colors.black.withValues(alpha: 0.06), blurRadius: 10, offset: const Offset(0, 4)),
                          ],
                        ),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Container(
                                  width: 50,
                                  height: 50,
                                  decoration: BoxDecoration(
                                    color: incub['status'] == 'Vita' 
                                      ? AppColors.success.withValues(alpha: 0.12)
                                      : isReady ? AppColors.warning.withValues(alpha: 0.12) : AppColors.info.withValues(alpha: 0.12),
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                  child: Center(child: Text(incub['status'] == 'Vita' ? '🐤' : isReady ? '🐣' : incubData['emoji'], style: const TextStyle(fontSize: 24))),
                                ),
                                const SizedBox(width: 12),
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      Row(
                                        children: [
                                          Flexible(child: Text('${incub['quantity']} atody', style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 18), overflow: TextOverflow.ellipsis)),
                                          const SizedBox(width: 8),
                                          Container(
                                            padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                                            decoration: BoxDecoration(
                                              color: AppColors.primary.withValues(alpha: 0.12),
                                              borderRadius: BorderRadius.circular(6),
                                            ),
                                            child: Text(incubType.split(' ').first, style: const TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: AppColors.primary)),
                                          ),
                                        ],
                                      ),
                                      Text('Nanomboka: ${incub['startDate']} • $incubDays andro', style: const TextStyle(color: AppColors.textSecondary, fontSize: 12), overflow: TextOverflow.ellipsis, maxLines: 1),
                                    ],
                                  ),
                                ),
                                if (incub['alarmEnabled'] == true)
                                  const Icon(Icons.alarm, color: AppColors.warning, size: 20),
                                Container(
                                  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                                  decoration: BoxDecoration(
                                    color: incub['status'] == 'Vita' 
                                        ? AppColors.success 
                                        : isReady ? AppColors.warning : AppColors.info,
                                    borderRadius: BorderRadius.circular(20),
                                  ),
                                  child: Text(
                                    incub['status'] == 'Vita' ? 'Vita' : isReady ? 'Vonona!' : '$daysLeft andro',
                                    style: const TextStyle(color: Colors.white, fontSize: 12, fontWeight: FontWeight.bold),
                                  ),
                                ),
                                IconButton(
                                  icon: const Icon(Icons.delete_outline, color: AppColors.error, size: 20),
                                  onPressed: () {
                                    showDialog(
                                      context: context,
                                      builder: (ctx) => AlertDialog(
                                        title: const Text('Hamafa?'),
                                        content: const Text('Tena hamafana ve ity incubation ity?'),
                                        actions: [
                                          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Tsia')),
                                          TextButton(
                                            onPressed: () {
                                              setState(() {
                                                _incubations.removeWhere((i) => i['id'] == incub['id']);
                                                _saveData();
                                              });
                                              Navigator.pop(ctx);
                                            },
                                            child: const Text('Eny, fafao', style: TextStyle(color: Colors.red)),
                                          ),
                                        ],
                                      ),
                                    );
                                  },
                                ),
                              ],
                            ),
                            const SizedBox(height: 12),
                            ClipRRect(
                              borderRadius: BorderRadius.circular(8),
                              child: LinearProgressIndicator(
                                value: progress,
                                minHeight: 8,
                                backgroundColor: Colors.grey[200],
                                valueColor: AlwaysStoppedAnimation(
                                  incub['status'] == 'Vita' ? AppColors.success : AppColors.primary,
                                ),
                              ),
                            ),
                            const SizedBox(height: 12),
                            Row(
                              mainAxisAlignment: MainAxisAlignment.spaceBetween,
                              children: [
                                Flexible(child: Text('🎯 Éclosion: ${incub['hatchDate']}', style: const TextStyle(fontSize: 13), overflow: TextOverflow.ellipsis)),
                                Flexible(child: Text('🐤 Teraka: ${incub['hatched']}/${incub['quantity']}', style: const TextStyle(fontWeight: FontWeight.bold), overflow: TextOverflow.ellipsis)),
                              ],
                            ),
                            if (isReady || incub['status'] != 'Vita') ...
                              [const SizedBox(height: 12),
                              SizedBox(
                                width: double.infinity,
                                child: OutlinedButton.icon(
                                  onPressed: () => _updateHatchedCount(incub),
                                  icon: const Icon(Icons.edit),
                                  label: const Text('Hanova isan\'ny teraka'),
                                  style: OutlinedButton.styleFrom(
                                    foregroundColor: AppColors.success,
                                    side: const BorderSide(color: AppColors.success),
                                  ),
                                ),
                              )],
                          ],
                        ),
                      );
                    }),
                    const SizedBox(height: 70),
                  ],
                ),
              ),
            ],
          ),
        ),
      ],
    );
  }

  // FAB in parent
  Widget buildFab() {
    return FloatingActionButton.extended(
      onPressed: _tabController.index == 0 ? _addEggCollection : _addIncubation,
      icon: const Icon(Icons.add),
      label: Text(_tabController.index == 0 ? 'Atody' : 'Incubation'),
      backgroundColor: AppColors.primary,
    );
  }
}

// AWE Style Stat Card Widget
Widget _buildStatCard({
  required String label, 
  required String value, 
  required IconData icon, 
  Color? color,
}) {
  final cardColor = color ?? AppColors.primary;
  return Container(
    padding: const EdgeInsets.all(18),
    decoration: BoxDecoration(
      color: Colors.white,
      borderRadius: BorderRadius.circular(20),
      boxShadow: [
        BoxShadow(
          color: cardColor.withValues(alpha: 0.12),
          blurRadius: 20,
          offset: const Offset(0, 8),
        ),
      ],
    ),
    child: Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Container(
          padding: const EdgeInsets.all(10),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              colors: [cardColor.withValues(alpha: 0.2), cardColor.withValues(alpha: 0.35)],
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
            ),
            borderRadius: BorderRadius.circular(12),
          ),
          child: Icon(icon, color: cardColor, size: 24),
        ),
        const SizedBox(height: 14),
        FittedBox(
          fit: BoxFit.scaleDown,
          child: Text(
            value,
            style: TextStyle(
              color: cardColor,
              fontSize: 26,
              fontWeight: FontWeight.w800,
              letterSpacing: -0.5,
            ),
          ),
        ),
        const SizedBox(height: 4),
        Text(
          label,
          style: TextStyle(
            color: AppColors.textSecondary,
            fontSize: 12,
            fontWeight: FontWeight.w500,
          ),
        ),
      ],
    ),
  );
}

// ==================== BITROTECH SCREENS ====================

// Bitro Housing Screen - Trano Bitro
class BitroHousingScreen extends StatefulWidget {
  const BitroHousingScreen({super.key});

  @override
  State<BitroHousingScreen> createState() => _BitroHousingScreenState();
}

class _BitroHousingScreenState extends State<BitroHousingScreen> {
  String _selectedType = 'Bitro';
  String _selectedCategory = 'Normal';
  final _countController = TextEditingController(text: '10');
  bool _showFloorPlan = false;
  
  // Catégories de lapins avec leurs besoins spécifiques
  final Map<String, Map<String, dynamic>> _rabbitCategories = {
    'Normal': {
      'name': 'Bitro Normal',
      'emoji': '🐇',
      'weight': '2-4 kg',
      'cageSize': '80x60x50 cm',
      'spacePerUnit': 0.5,
      'description': 'Bitro mahazatra ho an\'ny tokantrano',
    },
    'Géant': {
      'name': 'Bitro Goavana',
      'emoji': '🐰',
      'weight': '5-10 kg',
      'cageSize': '120x80x60 cm',
      'spacePerUnit': 0.8,
      'description': 'Géant des Flandres, Continental Giant - mila trano lehibe kokoa',
    },
    'Viande': {
      'name': 'Bitro ho Hena',
      'emoji': '🍖',
      'weight': '3-5 kg',
      'cageSize': '80x60x50 cm',
      'spacePerUnit': 0.5,
      'description': 'Californien, Néo-Zélandais - mitombo haingana',
    },
    'Reproduction': {
      'name': 'Bitro Mpiteraka',
      'emoji': '👶',
      'weight': '3-5 kg',
      'cageSize': '100x70x60 cm',
      'spacePerUnit': 0.7,
      'description': 'Mila trano lehibe kokoa miaraka amin\'ny nid ho an\'ny zaza',
    },
  };
  
  final Map<String, Map<String, dynamic>> _housingData = {
    'Bitro': {
      'emoji': '🐇',
      'spacePerUnit': 0.5,
      'cageSize': '80x60x50 cm',
      'groupSize': '⚠️ 1 BITRO = 1 CAGE (Tsy mety miaraka)',
      'temperature': '15-21°C',
      'humidity': '60-70%',
      'description': '⚠️ ZAVA-DEHIBE: Tokony hisy cage manokana ny bitro tsirairay! Ny bitro lahy tsy tokony hiaraka.',
      'features': ['1 bitro = 1 cage', 'Tany maina (litière)', 'Nid ho an\'ny vavy mpiteraka', 'Toerana fihinanana', 'Rano madio'],
      'housingTypes': [
        {'name': 'Cage tokana', 'desc': '⚠️ 1 bitro iray = 1 cage iray (Obligatoire)', 'emoji': '🏠'},
        {'name': 'Clapier (Armoire)', 'desc': 'Boaty maro sosona, cage tsirairay ho an\'ny bitro tsirairay', 'emoji': '🗄️'},
        {'name': 'Enclos extérieur', 'desc': 'Fefy lehibe ho an\'ny bitro vavy miaraka (tsy lahy)', 'emoji': '🌳'},
      ],
    },
    'Bitro Voalavo': {
      'emoji': '🐹',
      'spacePerUnit': 0.2,
      'cageSize': '60x40x40 cm',
      'groupSize': '2-4 miaraka (afaka miaraka)',
      'temperature': '18-24°C',
      'humidity': '40-60%',
      'description': 'Mila trano malefaka sy mafana. Afaka miaraka ny bitro voalavo.',
      'features': ['Vilany fihinanana', 'Rano vitamine C', 'Toerana miafina', 'Vilany filaharana'],
      'housingTypes': [
        {'name': 'Cage plastika', 'desc': 'Cage plastika misy fantsona rano, 60x40 cm', 'emoji': '🏠'},
        {'name': 'Terrarium', 'desc': 'Terrarium fitaratra, tsara ho an\'ny fiarovana', 'emoji': '🪟'},
      ],
    },
  };

  @override
  void dispose() {
    _countController.dispose();
    super.dispose();
  }

  double _calculateSpace() {
    final count = int.tryParse(_countController.text) ?? 0;
    if (_selectedType == 'Bitro') {
      final catData = _rabbitCategories[_selectedCategory]!;
      return count * (catData['spacePerUnit'] as double);
    }
    final spacePerUnit = _housingData[_selectedType]!['spacePerUnit'] as double;
    return count * spacePerUnit;
  }
  
  int _calculateCages() {
    final count = int.tryParse(_countController.text) ?? 0;
    return count; // 1 lapin = 1 cage
  }

  @override
  Widget build(BuildContext context) {
    final data = _housingData[_selectedType]!;
    final totalSpace = _calculateSpace();
    
    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            AppColors.primary.withValues(alpha: 0.1),
            AppColors.primaryLight.withValues(alpha: 0.05),
          ],
        ),
      ),
      child: SingleChildScrollView(
        padding: const EdgeInsets.all(20),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Type selector
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.white.withValues(alpha: 0.9),
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withValues(alpha: 0.05),
                    blurRadius: 10,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text(
                    'Karazana Bitro 🐇',
                    style: TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: AppColors.primaryDark,
                    ),
                  ),
                  const SizedBox(height: 12),
                  Wrap(
                    spacing: 10,
                    runSpacing: 10,
                    children: _housingData.keys.map((type) {
                      final isSelected = _selectedType == type;
                      final typeData = _housingData[type]!;
                      return GestureDetector(
                        onTap: () => setState(() => _selectedType = type),
                        child: Container(
                          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                          decoration: BoxDecoration(
                            color: isSelected ? AppColors.primary : Colors.grey[100],
                            borderRadius: BorderRadius.circular(20),
                            border: Border.all(
                              color: isSelected ? AppColors.primaryDark : Colors.grey[300]!,
                            ),
                          ),
                          child: Row(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Text(typeData['emoji'] as String, style: const TextStyle(fontSize: 20)),
                              const SizedBox(width: 8),
                              Text(
                                type,
                                style: TextStyle(
                                  color: isSelected ? Colors.white : Colors.black87,
                                  fontWeight: FontWeight.w600,
                                ),
                              ),
                            ],
                          ),
                        ),
                      );
                    }).toList(),
                  ),
                ],
              ),
            ),
            
            const SizedBox(height: 20),
            
            // Catégories de lapins (seulement pour Bitro)
            if (_selectedType == 'Bitro')
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.orange[50],
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: Colors.orange[200]!),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text(
                      '🐰 Karazana Bitro (Catégorie)',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                        color: Colors.deepOrange,
                      ),
                    ),
                    const SizedBox(height: 12),
                    Wrap(
                      spacing: 8,
                      runSpacing: 8,
                      children: _rabbitCategories.keys.map((cat) {
                        final isSelected = _selectedCategory == cat;
                        final catData = _rabbitCategories[cat]!;
                        return GestureDetector(
                          onTap: () => setState(() => _selectedCategory = cat),
                          child: Container(
                            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                            decoration: BoxDecoration(
                              color: isSelected ? Colors.deepOrange : Colors.white,
                              borderRadius: BorderRadius.circular(16),
                              border: Border.all(
                                color: isSelected ? Colors.deepOrange : Colors.orange[300]!,
                              ),
                            ),
                            child: Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Text(catData['emoji'] as String, style: const TextStyle(fontSize: 16)),
                                const SizedBox(width: 6),
                                Text(
                                  cat,
                                  style: TextStyle(
                                    color: isSelected ? Colors.white : Colors.deepOrange,
                                    fontWeight: FontWeight.w600,
                                    fontSize: 13,
                                  ),
                                ),
                              ],
                            ),
                          ),
                        );
                      }).toList(),
                    ),
                    const SizedBox(height: 12),
                    // Info sur la catégorie sélectionnée
                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            '${_rabbitCategories[_selectedCategory]!['emoji']} ${_rabbitCategories[_selectedCategory]!['name']}',
                            style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 15),
                          ),
                          const SizedBox(height: 4),
                          Text('⚖️ Lanja: ${_rabbitCategories[_selectedCategory]!['weight']}', style: const TextStyle(fontSize: 13)),
                          Text('📐 Cage: ${_rabbitCategories[_selectedCategory]!['cageSize']}', style: const TextStyle(fontSize: 13)),
                          const SizedBox(height: 4),
                          Text(
                            _rabbitCategories[_selectedCategory]!['description'] as String,
                            style: TextStyle(fontSize: 12, color: Colors.grey[600], fontStyle: FontStyle.italic),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            
            if (_selectedType == 'Bitro')
              const SizedBox(height: 20),
            
            // Warning: 1 lapin = 1 cage
            if (_selectedType == 'Bitro')
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.red[50],
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: Colors.red[300]!, width: 2),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        const Text('⚠️', style: TextStyle(fontSize: 32)),
                        const SizedBox(width: 12),
                        const Expanded(
                          child: Text(
                            '1 BITRO = 1 CAGE',
                            style: TextStyle(
                              fontWeight: FontWeight.bold,
                              color: Colors.red,
                              fontSize: 18,
                            ),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 12),
                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              const Text('♂️', style: TextStyle(fontSize: 20)),
                              const SizedBox(width: 8),
                              Expanded(
                                child: Text(
                                  'BITRO LAHY: Tsy tokony hiaraka raha tsy:',
                                  style: TextStyle(fontWeight: FontWeight.bold, color: Colors.red[700]),
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 8),
                          Padding(
                            padding: const EdgeInsets.only(left: 28),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text('✅ Vositra (castré)', style: TextStyle(color: Colors.green[700])),
                                Text('✅ Latsaky ny 3 volana (moins de 3 mois)', style: TextStyle(color: Colors.green[700])),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 8),
                    Container(
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              const Text('♀️', style: TextStyle(fontSize: 20)),
                              const SizedBox(width: 8),
                              Expanded(
                                child: Text(
                                  'BITRO VAVY:',
                                  style: TextStyle(fontWeight: FontWeight.bold, color: Colors.orange[700]),
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 8),
                          Padding(
                            padding: const EdgeInsets.only(left: 28),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text('✅ Afaka miaraka (raha tsy bevohoka)', style: TextStyle(color: Colors.green[700])),
                                Text('⚠️ Mila misaraka rehefa bevohoka', style: TextStyle(color: Colors.orange[700])),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            
            if (_selectedType == 'Bitro')
              const SizedBox(height: 20),
            
            // Count input
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.white.withValues(alpha: 0.9),
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withValues(alpha: 0.05),
                    blurRadius: 10,
                    offset: const Offset(0, 4),
                  ),
                ],
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    'Isan\'ny ${data['emoji']} $_selectedType',
                    style: const TextStyle(
                      fontSize: 16,
                      fontWeight: FontWeight.bold,
                      color: AppColors.primaryDark,
                    ),
                  ),
                  const SizedBox(height: 12),
                  TextField(
                    controller: _countController,
                    keyboardType: TextInputType.number,
                    decoration: InputDecoration(
                      hintText: 'Ampidiro ny isa',
                      prefixIcon: Icon(Icons.pets, color: AppColors.primary),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      focusedBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                        borderSide: const BorderSide(color: AppColors.primary, width: 2),
                      ),
                    ),
                    onChanged: (_) => setState(() {}),
                  ),
                ],
              ),
            ),
            
            const SizedBox(height: 20),
            
            // Result card
            Container(
              width: double.infinity,
              padding: const EdgeInsets.all(20),
              decoration: BoxDecoration(
                gradient: const LinearGradient(
                  colors: [AppColors.primary, AppColors.primaryDark],
                ),
                borderRadius: BorderRadius.circular(16),
                boxShadow: [
                  BoxShadow(
                    color: AppColors.primary.withValues(alpha: 0.3),
                    blurRadius: 15,
                    offset: const Offset(0, 6),
                  ),
                ],
              ),
              child: Column(
                children: [
                  Text(
                    '${data['emoji']} Trano ilaina',
                    style: const TextStyle(
                      color: Colors.white70,
                      fontSize: 16,
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    '${totalSpace.toStringAsFixed(1)} m²',
                    style: const TextStyle(
                      color: Colors.white,
                      fontSize: 42,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 8),
                  // Afficher le nombre de cages pour les lapins
                  if (_selectedType == 'Bitro') ...[
                    Container(
                      margin: const EdgeInsets.only(top: 8),
                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                      decoration: BoxDecoration(
                        color: Colors.white.withValues(alpha: 0.2),
                        borderRadius: BorderRadius.circular(20),
                      ),
                      child: Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          const Text('🗄️', style: TextStyle(fontSize: 20)),
                          const SizedBox(width: 8),
                          Text(
                            '${_calculateCages()} cage ilaina',
                            style: const TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                              fontSize: 16,
                            ),
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      'Cage: ${_rabbitCategories[_selectedCategory]!['cageSize']}',
                      style: const TextStyle(color: Colors.white70),
                    ),
                  ] else
                    Text(
                      'Tranovorona: ${data['cageSize']}',
                      style: const TextStyle(color: Colors.white70),
                    ),
                ],
              ),
            ),
            
            const SizedBox(height: 20),
            
            // Housing details
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.white.withValues(alpha: 0.9),
                borderRadius: BorderRadius.circular(16),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    '${data['emoji']} Momba ny Trano',
                    style: const TextStyle(
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                      color: AppColors.primaryDark,
                    ),
                  ),
                  const SizedBox(height: 16),
                  _buildInfoRow('📐 Habeny tranovorona', data['cageSize'] as String),
                  _buildInfoRow('👥 Vondrona', data['groupSize'] as String),
                  _buildInfoRow('🌡️ Hafanana', data['temperature'] as String),
                  _buildInfoRow('💧 Hamandoana', data['humidity'] as String),
                  const SizedBox(height: 16),
                  Text(
                    '📋 Zavatra ilaina:',
                    style: const TextStyle(fontWeight: FontWeight.bold),
                  ),
                  const SizedBox(height: 8),
                  ...((data['features'] as List<String>).map((f) => Padding(
                    padding: const EdgeInsets.only(left: 16, bottom: 4),
                    child: Row(
                      children: [
                        const Icon(Icons.check_circle, size: 16, color: AppColors.primary),
                        const SizedBox(width: 8),
                        Text(f),
                      ],
                    ),
                  ))),
                ],
              ),
            ),
            
            const SizedBox(height: 20),
            
            // Housing Types (Clapier, Cage, etc.)
            if (data['housingTypes'] != null)
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.blue[50],
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: Colors.blue[200]!),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text(
                      '🏠 Karazana Trano azo ampiasaina',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                        color: Colors.blueAccent,
                      ),
                    ),
                    const SizedBox(height: 12),
                    ...(data['housingTypes'] as List).map((type) => Container(
                      margin: const EdgeInsets.only(bottom: 10),
                      padding: const EdgeInsets.all(12),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Row(
                        children: [
                          Text(type['emoji'] as String, style: const TextStyle(fontSize: 28)),
                          const SizedBox(width: 12),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  type['name'] as String,
                                  style: const TextStyle(fontWeight: FontWeight.bold),
                                ),
                                Text(
                                  type['desc'] as String,
                                  style: TextStyle(fontSize: 12, color: Colors.grey[600]),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    )),
                    // Plan 2D Blueprint
                    const SizedBox(height: 16),
                    const Divider(),
                    const SizedBox(height: 8),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        Expanded(
                          child: Row(
                            children: [
                              const Icon(Icons.architecture, color: Colors.blueAccent, size: 20),
                              const SizedBox(width: 8),
                              Flexible(
                                child: Text('Plan 2D (Schematic)', style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14), overflow: TextOverflow.ellipsis),
                              ),
                            ],
                          ),
                        ),
                        Switch(
                          value: _showFloorPlan,
                          onChanged: (val) => setState(() => _showFloorPlan = val),
                          activeTrackColor: Colors.blueAccent.withValues(alpha: 0.5),
                          thumbColor: WidgetStateProperty.resolveWith((states) => states.contains(WidgetState.selected) ? Colors.blueAccent : Colors.grey),
                        ),
                      ],
                    ),
                    if (_showFloorPlan) ...[
                      const SizedBox(height: 10),
                      Container(
                        height: 300,
                        width: double.infinity,
                        decoration: BoxDecoration(
                          color: Colors.white,
                          border: Border.all(color: Colors.black, width: 2),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: CustomPaint(
                          painter: RabbitryFloorPlanPainter(
                            area: _calculateSpace(),
                            rabbitCount: int.tryParse(_countController.text) ?? 0,
                            category: _selectedCategory,
                          ),
                        ),
                      ),
                      const SizedBox(height: 8),
                      const Center(
                        child: Text(
                          '🗺️ Plan clapier - Rabbitry layout (AutoCAD style)',
                          style: TextStyle(color: Colors.grey, fontSize: 11),
                        ),
                      ),
                    ],
                  ],
                ),
              ),
            
            const SizedBox(height: 20),
            
            // Tips
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.amber[50],
                borderRadius: BorderRadius.circular(16),
                border: Border.all(color: Colors.amber[200]!),
              ),
              child: Row(
                children: [
                  const Text('💡', style: TextStyle(fontSize: 24)),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Text(
                      data['description'] as String,
                      style: const TextStyle(color: Colors.brown),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
  
  Widget _buildInfoRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Expanded(
            child: Text(
              label,
              style: const TextStyle(color: Colors.black54),
              overflow: TextOverflow.ellipsis,
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              value,
              style: const TextStyle(fontWeight: FontWeight.w600),
              textAlign: TextAlign.right,
              overflow: TextOverflow.ellipsis,
              maxLines: 2,
            ),
          ),
        ],
      ),
    );
  }
}

class _SliverAppBarDelegate extends SliverPersistentHeaderDelegate {
  final TabBar _tabBar;

  _SliverAppBarDelegate(this._tabBar);

  @override
  double get minExtent => _tabBar.preferredSize.height;
  @override
  double get maxExtent => _tabBar.preferredSize.height;

  @override
  Widget build(BuildContext context, double shrinkOffset, bool overlapsContent) {
    return Container(
      color: Colors.white,
      child: _tabBar,
    );
  }

  @override
  bool shouldRebuild(_SliverAppBarDelegate oldDelegate) {
    return false;
  }
}

// Bitro Feed Screen - Sakafo Bitro
class BitroFeedScreen extends StatefulWidget {
  const BitroFeedScreen({super.key});

  @override
  State<BitroFeedScreen> createState() => _BitroFeedScreenState();
}

class _BitroFeedScreenState extends State<BitroFeedScreen> {
  String _selectedType = 'Bitro';
  final _countController = TextEditingController(text: '10');
  
  // Calculator State
  double _rabbitWeight = 2.5;
  String _rabbitStatus = 'Maintenance';
  final List<String> _statusOptions = ['Maintenance', 'Fitomboana (Croissance)', 'Bevohoka (Gestante)', 'Mampinono (Allaitante)'];
  
  final Map<String, Map<String, dynamic>> _feedData = {
    'Bitro': {
      'emoji': '🐇',
      'dailyFeed': 150, // grammes par jour
      'hay': 70, // %
      'vegetables': 20, // %
      'pellets': 10, // %
      'water': 250, // ml par jour
      'foods': [
        {'name': 'Bozaka maina (Foin)', 'percent': '60-70%', 'emoji': '🌾'},
        {'name': 'Legioma (Karoty, Laisoa/Chou)', 'percent': '20-30%', 'emoji': '🥕'},
        {'name': 'Granulé/Pellets', 'percent': '10%', 'emoji': '🟤'},
        {'name': 'Voankazo (kely)', 'percent': 'Indraindray', 'emoji': '🍎'},
      ],
      'beneficialPlants': [
        {'name': 'Consoude', 'note': 'Manankarena proteina sy kalsioma, tsara ho an\'ny fahasalamana', 'emoji': '🌿'},
        {'name': 'Ananambo (Moringa)', 'note': 'Feno vitamina sy proteina, manamafy ny hery fiarovana', 'emoji': '🍃'},
        {'name': 'Tanamasoandro (Tournesol)', 'note': 'Ny voany sy ny felany dia manome angovo sy mampamiratra ny volo', 'emoji': '🌻'},
      ],
      'grains': [
        {'name': 'Avoine (Avoana)', 'note': 'Tsara indrindra ho an\'ny bitro', 'emoji': '🌾'},
        {'name': 'Blé (Varimbazaha/Ble)', 'note': 'Kely fotsiny, mampitombo lanja', 'emoji': '🌾'},
        {'name': 'Orge (Orza)', 'note': 'Tsara ho an\'ny bitro mpiteraka', 'emoji': '🌾'},
        {'name': 'Katsaka maina (Maïs sec)', 'note': 'Manome angovo, kely fotsiny', 'emoji': '🌽'},
      ],
      'cookedFoods': [
        {'name': 'Ovy masaka (Pomme de terre cuite)', 'note': 'Afangarony amin\'ny apombo', 'emoji': '🥔', 'ok': true},
        {'name': 'Saonjo masaka (Taro cuit)', 'note': 'Masaka tsara, tsy manta', 'emoji': '🍠', 'ok': true},
        {'name': 'Mangahazo masaka (Manioc cuit)', 'note': 'Masaka tsara, esory ny hodiny', 'emoji': '🥔', 'ok': true},
        {'name': 'Vomanga masaka (Patate douce)', 'note': 'Tsara be, manome angovo', 'emoji': '🍠', 'ok': true},
        {'name': 'Vary masaka (Riz cuit)', 'note': 'Kely fotsiny, tsy be loatra', 'emoji': '🍚', 'ok': true},
        {'name': 'Apombo (Son de riz)', 'note': 'Afangarony amin\'ny sakafo masaka', 'emoji': '🌾', 'ok': true},
        {'name': 'Katsaka masaka (Maïs cuit)', 'note': 'Masaka tsara', 'emoji': '🌽', 'ok': true},
      ],
      'pelletFormulas': {
        'demarrage': {
          'name': 'Démarrage (0-4 herinandro)',
          'emoji': '🐣',
          'protein': '18-20%',
          'fiber': '12-14%',
          'fat': '3-4%',
          'ingredients': [
            {'name': 'Luzerne (Foin maitso)', 'percent': '35%'},
            {'name': 'Orge', 'percent': '20%'},
            {'name': 'Blé', 'percent': '15%'},
            {'name': 'Tourteau de soja', 'percent': '15%'},
            {'name': 'Apombo (Son de riz)', 'percent': '10%'},
            {'name': 'Vitamines/Mineraly', 'percent': '5%'},
          ],
        },
        'croissance': {
          'name': 'Fitomboana (4-12 herinandro)',
          'emoji': '📈',
          'protein': '16-18%',
          'fiber': '14-16%',
          'fat': '2.5-3.5%',
          'ingredients': [
            {'name': 'Luzerne', 'percent': '30%'},
            {'name': 'Orge', 'percent': '25%'},
            {'name': 'Avoine', 'percent': '15%'},
            {'name': 'Tourteau de soja', 'percent': '12%'},
            {'name': 'Apombo', 'percent': '12%'},
            {'name': 'Vitamines/Mineraly', 'percent': '6%'},
          ],
        },
        'engraissement': {
          'name': 'Fanatavezana/Chair (8-12 herinandro)',
          'emoji': '🍖',
          'protein': '15-17%',
          'fiber': '13-15%',
          'fat': '3-4%',
          'ingredients': [
            {'name': 'Orge', 'percent': '30%'},
            {'name': 'Katsaka (Maïs)', 'percent': '25%'},
            {'name': 'Luzerne', 'percent': '20%'},
            {'name': 'Tourteau de soja', 'percent': '10%'},
            {'name': 'Apombo', 'percent': '10%'},
            {'name': 'Vitamines/Mineraly', 'percent': '5%'},
          ],
        },
        'entretien': {
          'name': 'Fikojakojana/Normal (Biby lehibe)',
          'emoji': '🐇',
          'protein': '12-14%',
          'fiber': '18-22%',
          'fat': '2-3%',
          'ingredients': [
            {'name': 'Foin (Bozaka maina)', 'percent': '40%'},
            {'name': 'Orge', 'percent': '20%'},
            {'name': 'Avoine', 'percent': '15%'},
            {'name': 'Apombo', 'percent': '15%'},
            {'name': 'Tourteau de soja', 'percent': '5%'},
            {'name': 'Vitamines/Mineraly', 'percent': '5%'},
          ],
        },
        'reproduction': {
          'name': 'Fiterahana (Vavy bevohoka/Mampinono)',
          'emoji': '🤱',
          'protein': '17-19%',
          'fiber': '14-16%',
          'fat': '3-4%',
          'ingredients': [
            {'name': 'Luzerne', 'percent': '35%'},
            {'name': 'Orge', 'percent': '20%'},
            {'name': 'Avoine', 'percent': '15%'},
            {'name': 'Tourteau de soja', 'percent': '15%'},
            {'name': 'Apombo', 'percent': '10%'},
            {'name': 'Vitamines/Mineraly/Calcium', 'percent': '5%'},
          ],
        },
      },
      'forbidden': ['Ovy MANTA (cru)', 'Saonjo MANTA (cru)', 'Tongolo', 'Avocat', 'Chocolat', 'Mofo mamy'],
      'tips': 'Foin dia zava-dehibe indrindra ho an\'ny Bitro - 70% ny sakafo',
    },
    'Bitro Voalavo': {
      'emoji': '🐹',
      'dailyFeed': 80, // grammes par jour
      'hay': 60, // %
      'vegetables': 30, // %
      'pellets': 10, // %
      'water': 100, // ml par jour
      'vitaminC': 30, // mg par jour - VERY IMPORTANT!
      'foods': [
        {'name': 'Bozaka maina (Foin Timothy)', 'percent': '60%', 'emoji': '🌾'},
        {'name': 'Legioma (Poivron, Laisoa)', 'percent': '30%', 'emoji': '🫑'},
        {'name': 'Granulé misy Vitamine C', 'percent': '10%', 'emoji': '🟤'},
        {'name': 'Voankazo (kely dia kely)', 'percent': 'Indraindray', 'emoji': '🍓'},
      ],
      'grains': [
        {'name': 'Avoine (Avoana)', 'note': 'Kely fotsiny', 'emoji': '🌾'},
        {'name': 'Blé (Ble)', 'note': 'Tena kely', 'emoji': '🌾'},
      ],
      'cookedFoods': [
        {'name': 'Ovy masaka', 'note': 'Kely fotsiny', 'emoji': '🥔', 'ok': true},
        {'name': 'Vary masaka', 'note': 'Tsy be loatra', 'emoji': '🍚', 'ok': true},
      ],
      'pelletFormulas': {
        'jeune': {
          'name': 'Fitomboana (Jeunes < 6 mois)',
          'emoji': '👶',
          'protein': '18-20%',
          'fiber': '10-12%',
          'fat': '3-4%',
          'ingredients': [
            {'name': 'Luzerne (Foin maitso)', 'percent': '40%'},
            {'name': 'Orge/Blé', 'percent': '20%'},
            {'name': 'Tourteau de soja', 'percent': '15%'},
            {'name': 'Apombo', 'percent': '15%'},
            {'name': 'Vitamines C + Mineraly', 'percent': '10%'},
          ],
        },
        'adulte': {
          'name': 'Biby lehibe (Adulte > 6 mois)',
          'emoji': '🐹',
          'protein': '14-16%',
          'fiber': '20-25%',
          'fat': '2-3%',
          'ingredients': [
            {'name': 'Foin Timothy (Bozaka)', 'percent': '45%'},
            {'name': 'Orge', 'percent': '20%'},
            {'name': 'Apombo', 'percent': '20%'},
            {'name': 'Tourteau de soja', 'percent': '10%'},
            {'name': 'Vitamines C (Tena ilaina)', 'percent': '5%'},
          ],
        },
        'reproduction': {
          'name': 'Fiterahana (Gestante/Allaitante)',
          'emoji': '🤰',
          'protein': '18-20%',
          'fiber': '12-15%',
          'fat': '3-5%',
          'ingredients': [
            {'name': 'Luzerne', 'percent': '35%'},
            {'name': 'Orge/Maïs', 'percent': '25%'},
            {'name': 'Tourteau de soja', 'percent': '20%'},
            {'name': 'Apombo', 'percent': '15%'},
            {'name': 'Calcium + Vitamine C', 'percent': '5%'},
          ],
        },
      },
      'forbidden': ['Saonjo', 'Ovy MANTA', 'Tongolo', 'Iceberg salady', 'Avocat'],
      'tips': '⚠️ ZAVA-DEHIBE: Mila Vitamine C isan\'andro (30-50mg) - tsy afaka mamokatra azy irery!',
      'vitaminCWarning': true,
    },
  };

  @override
  void dispose() {
    _countController.dispose();
    super.dispose();
  }

  Map<String, double> _calculateFeed() {
    final count = int.tryParse(_countController.text) ?? 0;
    final data = _feedData[_selectedType]!;
    final dailyFeed = (data['dailyFeed'] as int).toDouble();
    final water = (data['water'] as int).toDouble();
    
    return {
      'daily': count * dailyFeed,
      'weekly': count * dailyFeed * 7,
      'monthly': count * dailyFeed * 30,
      'water': count * water,
    };
  }

  @override
  Widget build(BuildContext context) {
    final data = _feedData[_selectedType]!;

    final feed = _calculateFeed();
    final hasVitaminCWarning = data['vitaminCWarning'] == true;
    
    return DefaultTabController(
      length: 3,
      child: Scaffold(
        body: Container(
          decoration: const BoxDecoration(
            gradient: LinearGradient(
              colors: [Color(0xFFF3E5F5), Color(0xFFFAFAFA)], // Light Purple tint
              begin: Alignment.topCenter,
              end: Alignment.bottomCenter,
            ),
          ),
          child: SafeArea(
            child: NestedScrollView(
              headerSliverBuilder: (BuildContext context, bool innerBoxIsScrolled) {
                return <Widget>[
                  SliverToBoxAdapter(
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Column(
                        children: [
                          _buildBitroHeader(),
                          const SizedBox(height: 16),
                          _buildCard(
                            title: 'Karazana Bitro',
                            icon: Icons.pets,
                            child: Column(
                              children: [
                                DropdownButtonFormField<String>(
                                  key: ValueKey(_selectedType),
                                  initialValue: _selectedType,
                                  items: _feedData.keys.map((type) {
                                    final typeData = _feedData[type]!;
                                    return DropdownMenuItem(
                                      value: type,
                                      child: Row(
                                        children: [
                                          Text(typeData['emoji'] as String),
                                          const SizedBox(width: 10),
                                          Text(type),
                                        ],
                                      ),
                                    );
                                  }).toList(),
                                  onChanged: (v) => setState(() => _selectedType = v!),
                                  decoration: const InputDecoration(
                                    labelText: 'Safidio ny karazana',
                                    border: OutlineInputBorder(),
                                  ),
                                ),
                                if (hasVitaminCWarning) ...[
                                  const SizedBox(height: 16),
                                  Container(
                                    padding: const EdgeInsets.all(12),
                                    decoration: BoxDecoration(
                                      color: Colors.orange.shade50,
                                      borderRadius: BorderRadius.circular(12),
                                      border: Border.all(color: Colors.orange.shade200),
                                    ),
                                    child: Row(
                                      children: [
                                        const Text('🍊', style: TextStyle(fontSize: 24)),
                                        const SizedBox(width: 12),
                                        Expanded(
                                          child: Column(
                                            crossAxisAlignment: CrossAxisAlignment.start,
                                            children: [
                                              Text(
                                                'VITAMINE C - ZAVA-DEHIBE!',
                                                style: TextStyle(fontWeight: FontWeight.bold, color: Colors.orange.shade900),
                                              ),
                                              Text(
                                                'Mila 30-50mg isan\'andro!',
                                                style: TextStyle(color: Colors.orange.shade800, fontSize: 12),
                                              ),
                                            ],
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                ],
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                  SliverPersistentHeader(
                    delegate: _SliverAppBarDelegate(
                      TabBar(
                        labelColor: AppColors.primary,
                        unselectedLabelColor: Colors.grey,
                        indicatorSize: TabBarIndicatorSize.label,
                        indicatorColor: AppColors.primary,
                        tabs: const [
                          Tab(text: 'Kajy & Fatra'),
                          Tab(text: 'Karazana'),
                          Tab(text: 'Formules'),
                        ],
                      ),
                    ),
                    pinned: true,
                  ),
                ];
              },
              body: TabBarView(
                children: [
                  // Tab 1: Kajy & Fatra
                  SingleChildScrollView(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      children: [
                        _buildCalculatorCard(),
                        _buildCard(
                          title: 'Isan\'ny Biby',
                          icon: Icons.numbers,
                          child: TextField(
                            controller: _countController,
                            keyboardType: TextInputType.number,
                            decoration: const InputDecoration(
                              labelText: 'Isany (Tête)',
                              prefixIcon: Icon(Icons.numbers),
                              border: OutlineInputBorder(),
                            ),
                            onChanged: (_) => setState(() {}),
                          ),
                        ),
                        _buildCard(
                          title: 'Sakafo Ilaina',
                          icon: Icons.calculate,
                          child: Column(
                            children: [
                              Container(
                                padding: const EdgeInsets.all(16),
                                decoration: BoxDecoration(
                                  color: Colors.purple.shade50,
                                  borderRadius: BorderRadius.circular(16),
                                  border: Border.all(color: Colors.purple.shade100),
                                ),
                                child: Row(
                                  mainAxisAlignment: MainAxisAlignment.spaceAround,
                                  children: [
                                    Expanded(child: _buildFeedStat('Isan\'andro', '${(feed['daily']! / 1000).toStringAsFixed(1)} kg', Colors.purple)),
                                    Expanded(child: _buildFeedStat('Herinandro', '${(feed['weekly']! / 1000).toStringAsFixed(1)} kg', Colors.purple)),
                                    Expanded(child: _buildFeedStat('Volana', '${(feed['monthly']! / 1000).toStringAsFixed(1)} kg', Colors.purple)),
                                  ],
                                ),
                              ),
                              const SizedBox(height: 16),
                              Container(
                                padding: const EdgeInsets.all(12),
                                decoration: BoxDecoration(
                                  color: Colors.blue.shade50,
                                  borderRadius: BorderRadius.circular(12),
                                  border: Border.all(color: Colors.blue.shade100),
                                ),
                                child: Row(
                                  children: [
                                    const Text('💧', style: TextStyle(fontSize: 24)),
                                    const SizedBox(width: 12),
                                    Expanded(
                                      child: Text(
                                        'Rano: ${(feed['water']! / 1000).toStringAsFixed(1)} L / andro',
                                        style: TextStyle(color: Colors.blue.shade900, fontWeight: FontWeight.bold, fontSize: 16),
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),

                  // Tab 2: Karazana Sakafo
                  SingleChildScrollView(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      children: [
                        _buildCard(
                          title: 'Karazana Sakafo',
                          icon: Icons.restaurant_menu,
                          child: Column(
                            children: (data['foods'] as List).map((food) => Padding(
                              padding: const EdgeInsets.only(bottom: 12),
                              child: Row(
                                children: [
                                  Text(food['emoji'] as String, style: const TextStyle(fontSize: 24)),
                                  const SizedBox(width: 12),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        Text(food['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold)),
                                        Text(food['percent'] as String, style: TextStyle(color: Colors.grey[600], fontSize: 12)),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                            )).toList(),
                          ),
                        ),
                        if (data['beneficialPlants'] != null)
                          _buildCard(
                            title: 'Zava-maniry Mahasoa',
                            icon: Icons.eco,
                            child: Column(
                              children: (data['beneficialPlants'] as List).map((plant) => Padding(
                                padding: const EdgeInsets.only(bottom: 12),
                                child: Row(
                                  children: [
                                    Text(plant['emoji'] as String, style: const TextStyle(fontSize: 24)),
                                    const SizedBox(width: 12),
                                    Expanded(
                                      child: Column(
                                        crossAxisAlignment: CrossAxisAlignment.start,
                                        children: [
                                          Text(plant['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold)),
                                          Text(plant['note'] as String, style: TextStyle(color: Colors.green[700], fontSize: 12)),
                                        ],
                                      ),
                                    ),
                                  ],
                                ),
                              )).toList(),
                            ),
                          ),
                        if (data['cookedFoods'] != null)
                          _buildCard(
                            title: 'Sakafo Masaka (Gasy)',
                            icon: Icons.soup_kitchen,
                            child: Column(
                              children: [
                                Container(
                                  padding: const EdgeInsets.all(10),
                                  margin: const EdgeInsets.only(bottom: 16),
                                  decoration: BoxDecoration(
                                    color: Colors.green.shade50,
                                    borderRadius: BorderRadius.circular(8),
                                  ),
                                  child: const Row(
                                    children: [
                                      Icon(Icons.check_circle, color: Colors.green, size: 20),
                                      SizedBox(width: 8),
                                      Expanded(child: Text('Azo omena sakafo masaka (Fika Malagasy)', style: TextStyle(color: Colors.green, fontWeight: FontWeight.bold))),
                                    ],
                                  ),
                                ),
                                ...(data['cookedFoods'] as List).map((food) => Padding(
                                  padding: const EdgeInsets.only(bottom: 10),
                                  child: Row(
                                    children: [
                                      Text(food['emoji'] as String, style: const TextStyle(fontSize: 20)),
                                      const SizedBox(width: 12),
                                      Expanded(
                                        child: Column(
                                          crossAxisAlignment: CrossAxisAlignment.start,
                                          children: [
                                            Text(food['name'] as String, style: const TextStyle(fontWeight: FontWeight.w600)),
                                            Text(food['note'] as String, style: TextStyle(color: Colors.grey[600], fontSize: 12)),
                                          ],
                                        ),
                                      ),
                                    ],
                                  ),
                                )),
                              ],
                            ),
                          ),
                        if (data['grains'] != null)
                          _buildCard(
                            title: 'Voan-javatra (Grains)',
                            icon: Icons.grass,
                            child: Column(
                              children: [
                                Container(
                                  padding: const EdgeInsets.all(10),
                                  margin: const EdgeInsets.only(bottom: 16),
                                  decoration: BoxDecoration(
                                    color: Colors.amber.shade50,
                                    borderRadius: BorderRadius.circular(8),
                                  ),
                                  child: Row(
                                    children: [
                                      Icon(Icons.lightbulb_outline, color: Colors.amber.shade800, size: 20),
                                      const SizedBox(width: 8),
                                      Expanded(child: Text('Fanampiny fotsiny (5-10%). Tsy atao be loatra.', style: TextStyle(color: Colors.amber.shade900, fontSize: 12))),
                                    ],
                                  ),
                                ),
                                ...(data['grains'] as List).map((grain) => Padding(
                                  padding: const EdgeInsets.only(bottom: 10),
                                  child: Row(
                                    children: [
                                      Text(grain['emoji'] as String, style: const TextStyle(fontSize: 20)),
                                      const SizedBox(width: 12),
                                      Expanded(
                                        child: Column(
                                          crossAxisAlignment: CrossAxisAlignment.start,
                                          children: [
                                            Text(grain['name'] as String, style: const TextStyle(fontWeight: FontWeight.w600)),
                                            Text(grain['note'] as String, style: TextStyle(color: Colors.grey[600], fontSize: 12, fontStyle: FontStyle.italic)),
                                          ],
                                        ),
                                      ),
                                    ],
                                  ),
                                )),
                              ],
                            ),
                          ),
                        _buildCard(
                          title: 'Tsy Azo Omena 🚫',
                          icon: Icons.warning,
                          child: Wrap(
                            spacing: 8,
                            runSpacing: 8,
                            children: (data['forbidden'] as List<String>).map((food) => Chip(
                              label: Text(food, style: const TextStyle(color: Colors.white)),
                              backgroundColor: Colors.red.shade400,
                              padding: const EdgeInsets.all(4),
                            )).toList(),
                          ),
                        ),
                      ],
                    ),
                  ),

                  // Tab 3: Formules & Torohevitra
                  SingleChildScrollView(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      children: [
                        if (data['pelletFormulas'] != null)
                          _buildCard(
                            title: 'Formules Granulés',
                            icon: Icons.science,
                            child: Column(
                              children: [
                                Padding(
                                  padding: const EdgeInsets.only(bottom: 16.0),
                                  child: Container(
                                    padding: const EdgeInsets.all(8),
                                    decoration: BoxDecoration(
                                      color: Colors.blue.shade50,
                                      borderRadius: BorderRadius.circular(8),
                                    ),
                                    child: Row(
                                      children: [
                                        Icon(Icons.info_outline, size: 16, color: Colors.blue.shade700),
                                        const SizedBox(width: 8),
                                        Expanded(
                                          child: Text(
                                            'Ampifanaraho amin’ny karazany sy ny toe-batany',
                                            style: TextStyle(color: Colors.blue.shade900, fontSize: 12, fontStyle: FontStyle.italic),
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                ),
                                ...(data['pelletFormulas'] as Map<String, dynamic>).entries.map((entry) {
                                  final formula = entry.value as Map<String, dynamic>;
                                  final ingredients = (formula['ingredients'] as List).cast<Map<String, String>>();
                                  return ExpansionTile(
                                    title: Text(formula['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                                    leading: Text(formula['emoji'] as String, style: const TextStyle(fontSize: 24)),
                                    subtitle: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        const SizedBox(height: 4),
                                        Text('Proteine: ${formula['protein']}', style: const TextStyle(fontSize: 12, color: Colors.grey)),
                                        Text('Fibres: ${formula['fiber']}', style: const TextStyle(fontSize: 12, color: Colors.grey)),
                                        Text('Graisse: ${formula['fat']}', style: const TextStyle(fontSize: 12, color: Colors.grey)),
                                      ],
                                    ),
                                    children: [
                                      Padding(
                                        padding: const EdgeInsets.all(12.0),
                                        child: Column(
                                          crossAxisAlignment: CrossAxisAlignment.start,
                                          children: [
                                            const Text('Akora ilaina (Ingrédients):', style: TextStyle(fontWeight: FontWeight.bold, color: Colors.purple)),
                                            const SizedBox(height: 8),
                                            ...ingredients.map((ing) => Padding(
                                              padding: const EdgeInsets.only(bottom: 4),
                                              child: Row(
                                                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                                children: [
                                                  Expanded(child: Text('• ${ing['name']}', style: const TextStyle(fontSize: 13))),
                                                  const SizedBox(width: 8),
                                                  Text(ing['percent']!, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                                                ],
                                              ),
                                            )),
                                          ],
                                        ),
                                      ),
                                    ],
                                  );
                                }),
                                const SizedBox(height: 16),
                                Container(
                                  padding: const EdgeInsets.all(12),
                                  decoration: BoxDecoration(
                                    color: Colors.green.shade50,
                                    borderRadius: BorderRadius.circular(12),
                                    border: Border.all(color: Colors.green.shade200),
                                  ),
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      Row(
                                        children: [
                                          Icon(Icons.help_outline, color: Colors.green.shade800, size: 20),
                                          const SizedBox(width: 8),
                                          Text('Raha tsy misy Luzerne?', style: TextStyle(fontWeight: FontWeight.bold, color: Colors.green.shade900)),
                                        ],
                                      ),
                                      const SizedBox(height: 8),
                                      Text(
                                        'Azo soloina: Ravim-batata maina, Ravim-mangahazo maina (kely), na Bozaka maitso (Stylosanthes) manankarena proteina.',
                                        style: TextStyle(color: Colors.green.shade800, fontSize: 13),
                                      ),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                          ),
                        if (data['tips'] != null)
                          _buildCard(
                            title: 'Torohevitra',
                            icon: Icons.lightbulb,
                            child: Row(
                              children: [
                                const Icon(Icons.info_outline, color: Colors.orange),
                                const SizedBox(width: 12),
                                Expanded(child: Text(data['tips'] as String, style: const TextStyle(fontStyle: FontStyle.italic))),
                              ],
                            ),
                          ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildBitroHeader() {
    final data = _feedData[_selectedType]!;
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: const LinearGradient(
          colors: [Color(0xFF8E24AA), Color(0xFFBA68C8)],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(24),
        boxShadow: [
          BoxShadow(
            color: Colors.purple.withValues(alpha: 0.3),
            blurRadius: 20,
            offset: const Offset(0, 10),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                padding: const EdgeInsets.all(14),
                decoration: BoxDecoration(
                  color: Colors.white.withValues(alpha: 0.2),
                  borderRadius: BorderRadius.circular(16),
                ),
                child: Text(data['emoji'] as String, style: const TextStyle(fontSize: 32)),
              ),
              const SizedBox(width: 16),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Sakafo $_selectedType',
                      style: const TextStyle(color: Colors.white, fontSize: 22, fontWeight: FontWeight.bold),
                    ),
                    const Text(
                      'Kajy sakafo & Torolalana',
                      style: TextStyle(color: Colors.white70, fontSize: 14),
                    ),
                  ],
                ),
              ),
            ],
          ),
          const SizedBox(height: 20),
          Wrap(
            spacing: 8,
            runSpacing: 8,
            children: [
              _buildHeaderChip('Karazana: $_selectedType', Icons.pets),
              _buildHeaderChip('Sakafo: ${data['dailyFeed']}g/andro', Icons.restaurant),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildHeaderChip(String label, IconData icon) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
      decoration: BoxDecoration(
        color: Colors.white.withValues(alpha: 0.15),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.white.withValues(alpha: 0.2)),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, color: Colors.white, size: 14),
          const SizedBox(width: 6),
          Text(label, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w600, fontSize: 13)),
        ],
      ),
    );
  }

  Widget _buildFeedStat(String label, String value, Color color) {
    return Column(
      children: [
        Text(value, style: TextStyle(color: color, fontSize: 18, fontWeight: FontWeight.bold)),
        Text(label, style: TextStyle(color: color.withValues(alpha: 0.7), fontSize: 12)),
      ],
    );
  }

  Widget _buildCalculatorCard() {
    return _buildCard(
      title: '🧮 Kajy Sakafo (Calculateur)',
      icon: Icons.calculate,
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text('Firy kg ny bitro?', style: TextStyle(fontWeight: FontWeight.bold)),
          Slider(
            value: _rabbitWeight,
            min: 0.5,
            max: 8.0,
            divisions: 15,
            label: '$_rabbitWeight kg',
            onChanged: (val) => setState(() => _rabbitWeight = val),
            activeColor: AppColors.primary,
          ),
          Center(child: Text('Lanja: $_rabbitWeight kg', style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: AppColors.primary))),
          
          const SizedBox(height: 16),
          const Text('Toe-batana:', style: TextStyle(fontWeight: FontWeight.bold)),
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 12),
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(8),
              border: Border.all(color: Colors.grey.shade300),
            ),
            child: DropdownButtonHideUnderline(
              child: DropdownButton<String>(
                value: _rabbitStatus,
                isExpanded: true,
                items: _statusOptions.map((String value) {
                  return DropdownMenuItem<String>(
                    value: value,
                    child: Text(
                      value,
                      overflow: TextOverflow.ellipsis,
                      maxLines: 1,
                      style: const TextStyle(fontSize: 14),
                    ),
                  );
                }).toList(),
                onChanged: (newValue) => setState(() => _rabbitStatus = newValue!),
              ),
            ),
          ),
          
          const Divider(height: 30),
          
          _buildResult(),
        ],
      ),
    );
  }

  Widget _buildResult() {
    String pellets = '';
    String hay = 'Bozaka maina (Foin): Tsy ferana (A volonté)';
    String greens = '';
    
    if (_rabbitStatus.contains('Maintenance')) {
      double amount = _rabbitWeight * 25;
      pellets = 'Granulés: ${amount.toStringAsFixed(0)} - ${(amount + 10).toStringAsFixed(0)} g / andro';
      greens = 'Legioma: ~${(_rabbitWeight * 0.5).toStringAsFixed(1)} kaopy / andro';
    } else if (_rabbitStatus.contains('Fitomboana')) {
      pellets = 'Granulés: Tsy ferana (A volonté) na 50g/kg';
      greens = 'Legioma: Kely dia kely (manomboka 3 volana)';
    } else if (_rabbitStatus.contains('Bevohoka')) {
      double amount = _rabbitWeight * 35;
      pellets = 'Granulés: ${amount.toStringAsFixed(0)} - ${(amount + 20).toStringAsFixed(0)} g / andro';
      greens = 'Legioma: Ara-dalàna';
    } else if (_rabbitStatus.contains('Mampinono')) {
      pellets = 'Granulés: Tsy ferana (A volonté)';
      greens = 'Legioma: Azo omena betsaka';
    }

    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.green.shade50,
        borderRadius: BorderRadius.circular(8),
        border: Border.all(color: Colors.green.shade200),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildResultRow(Icons.grain, pellets),
          const SizedBox(height: 8),
          _buildResultRow(Icons.grass, hay),
          const SizedBox(height: 8),
          _buildResultRow(Icons.eco, greens),
        ],
      ),
    );
  }

  Widget _buildResultRow(IconData icon, String text) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Icon(icon, size: 20, color: Colors.green.shade800),
        const SizedBox(width: 10),
        Expanded(child: Text(text, style: TextStyle(color: Colors.green.shade900, fontWeight: FontWeight.w500))),
      ],
    );
  }
}

// Bitro Health Screen - Fahasalamana Bitro
class BitroHealthScreen extends StatefulWidget {
  const BitroHealthScreen({super.key});

  @override
  State<BitroHealthScreen> createState() => _BitroHealthScreenState();
}

class _BitroHealthScreenState extends State<BitroHealthScreen> {
  String _selectedType = 'Bitro';
  
  final Map<String, Map<String, dynamic>> _healthData = {
    'Bitro': {
      'emoji': '🐇',
      'vaccines': [
        {'name': 'Myxomatose', 'when': '6 herinandro', 'repeat': 'Isan-taona', 'emoji': '💉'},
        {'name': 'VHD (Maladie Hémorragique)', 'when': '10 herinandro', 'repeat': 'Isan-taona', 'emoji': '💉'},
      ],
      'treatments': [
        {
          'name': 'Odikakana (Vermifuge)',
          'product': 'Ivermectine / Levamisole',
          'dosage': '0.2ml / kg (Tsindrona/Goutte)',
          'frequency': 'Isaky ny 3 volana',
          'note': 'Atao alohan\'ny fampanarahana (10 andro)',
          'emoji': '🪱'
        },
        {
          'name': 'Lagaly (Gale)',
          'product': 'Ivermectine / Menaka',
          'dosage': 'Hosorana na Tsindrona',
          'frequency': 'Raha vao miseho ny soritra',
          'note': 'Atokana ny marary, diovina ny trano',
          'emoji': '🦠'
        },
        {
          'name': 'Coccidiose (Fisorohana)',
          'product': 'Anticoccidien (Sulfa)',
          'dosage': 'Afangaro anaty rano',
          'frequency': 'Isam-bolana (3 andro)',
          'note': 'Indrindra ho an\'ny bitro kely',
          'emoji': '💊'
        },
      ],
      'diseases': [
        {
          'name': 'Coccidiose (Fivalanana)',
          'symptoms': 'Kibo mibontsina, Fivalanana maimbo/misy ra, Mahia',
          'treatment': 'Sulfamides (Sulfa) anaty rano',
          'prevention': 'Fahadiovana, Tsy omena sakafo lena, Tsy atao an-tany'
        },
        {
          'name': 'Coryza (Sery)',
          'symptoms': 'Mievina, Orona lena, Maso mandeha rano',
          'treatment': 'Antibiotique (Oxytetracycline) + Vitamine',
          'prevention': 'Tsy atao azon\'ny rivotra mivantana, Vovoka'
        },
        {
          'name': 'Gale (Lagaly)',
          'symptoms': 'Mangidihidy sofina/orona, Volo mihintsana, Misy "croute"',
          'treatment': 'Ivermectine (Tsindrona/Hosotra)',
          'prevention': 'Fahadiovana, Atokana ny vaovao'
        },
        {
          'name': 'VHD (Hémorragie)',
          'symptoms': 'Fahafatesana tampoka, Ra amin\'ny orona, Kiakiaka',
          'treatment': 'Tsy misy fanafody (Maty)',
          'prevention': 'Vakisiny (Isan-taona) - TENA ILAINA'
        },
        {
          'name': 'Mal de pattes (Tongotra)',
          'symptoms': 'Fery ambany tongotra, Tsy mazoto mihetsika',
          'treatment': 'Diovina (Bétadine), Ahosotra menaka, Soliana malefaka',
          'prevention': 'Tsy atao anaty dridra na vy maranitra ny fanambaniny'
        },
      ],
      'guides': [
        {
          'title': '🐰 ARETIMBITRO: Vohoka sy Fiterahana',
          'elements': [
            {'type': 'section', 'value': '📝 Famantarana fa efa ho teraka'},
            {'type': 'text', 'value': 'Alohan\'ny fotoana, dia ireto no fambara matetika mitranga:'},
            {'type': 'bullet', 'label': 'Fiomanana', 'value': 'Manamboatra ny toerana hipetrahan\'ny zanany (manalavaka, manapotika izay hitany).'},
            {'type': 'bullet', 'label': 'Vatana', 'value': 'Mivonto ny nonony, milatsaka be ny kibony, mivonto ary mety mandera ny fivaviany.'},
            {'type': 'bullet', 'label': 'Fielika', 'value': 'Tsy dia misakafo firy, midina ny maripana, mikizintina.'},
            {'type': 'note', 'value': 'Fanamarihana: Sakafo mahazatra ihany omena azy mandritra ny fitondrana vohoka.'},
            
            {'type': 'section', 'value': '⚠️ IREO OLANA METY HITRANGA'},
            
            {'type': 'subtitle', 'value': '1. Teraka tsy tonga volana (Avortement)'},
            {'type': 'bullet', 'label': 'Antony', 'value': 'Sakafo tsy zaka na miovaova, na taitra tampoka (stress).'},
            {'type': 'bullet', 'label': 'Vokany', 'value': 'Teraka alohan\'ny fotoana na tsy tomombana ny zaza.'},

            {'type': 'subtitle', 'value': '2. Manary zanaka'},
            {'type': 'text', 'value': 'Matetika amin\'ny bitro vao niteraka voalohany. Tsy mampinono, tsy miraharaha.'},
            {'type': 'bullet', 'label': 'Vahaolana', 'value': 'Afindra amin\'ny reniny hafa ny zaza, na atohoka amin\'ny nonon-dreniny (ila hafanana 32°C). Raha miverina in-3 izany dia tsara amidy ny reniny.'},

            {'type': 'subtitle', 'value': '3. Cannibalisme (Mihinana zanaka)'},
            {'type': 'bullet', 'label': 'Antony', 'value': 'Mangatsiaka ny zaza, misy fofona "biby" hafa, stress, na tsy fahampian-tsakafo (Rano, Protéine).'},
            {'type': 'bullet', 'label': 'Fisorohana', 'value': 'Omano tsara ny sakafony sy ny tontolo manodidina.'},

            {'type': 'subtitle', 'value': '4. Taraiky fiterahana'},
            {'type': 'text', 'value': 'Tokony ho 31 andro. Raha mihoatra ny 33 andro:'},
            {'type': 'bullet', 'label': 'Vahaolana', 'value': 'Tsapao raha mbola misy zaza. Manantona mpitsabo biby (fampiasana Oxytocine 0,01 - 0,3ml/kg).'},
            {'type': 'bullet', 'label': 'Fisorohana', 'value': 'Aza mampiaraka bitro tsy mitovy habe be loatra (oh: 1kg sy 9kg).'},

            {'type': 'subtitle', 'value': '5. Torsion sy Prolapsus'},
            {'type': 'text', 'value': 'Fiholanana sy fivoahan\'ny taova. Antony: Zaza be loatra, taitra ny bitro am-pandatsahana.'},
            {'type': 'bullet', 'label': 'Vahaolana', 'value': 'Mampitony ny biby, fandidiana (chirurgie).'},

            {'type': 'subtitle', 'value': '6. Toxémie (Tsy fahampian\'ny Calcium)'},
            {'type': 'text', 'value': 'Andro maromaro aorian\'ny fiterahana. Mangovitra, tsy mihetsika, tsy homana, mifanintona.'},
            {'type': 'bullet', 'label': 'Fitsaboana', 'value': 'Ento haingana any amin\'ny mpitsabo (Calcium Intra-veineuse).'},
            {'type': 'bullet', 'label': 'Fisorohana', 'value': 'Omeo Vitamine (ohatra: Amin Total) vao teraka.'},

            {'type': 'subtitle', 'value': '7. Métrite sy Pyomètre'},
            {'type': 'text', 'value': 'Infection ny tranon-jaza. Misy nana mivoaka, mafana ny hoditra, mandravily.'},
            {'type': 'bullet', 'label': 'Fitsaboana', 'value': 'Urgence vétérinaire. Mila antibiotique sy fanafody manohana ny vatany.'},

            {'type': 'subtitle', 'value': '8. Mammite (Nono mivaingana)'},
            {'type': 'text', 'value': 'Mamay, mivonto, marary, tsy mety mivoaka ny ronono.'},
            {'type': 'bullet', 'label': 'Vahaolana', 'value': 'Fanamarinana ny nono isaky ny 4 andro. Antibiothérapie.'},
          ]
        },
        {
          'title': '💊 FITARIHANA: Ody Kakana sy Ody Katsentsitra',
          'elements': [
            {'type': 'section', 'value': '📋 Tabilao Fintina'},
            {
              'type': 'table',
              'headers': ['Fanafody', 'Boribory', 'Fisaka', 'Lagaly', 'Parasy', 'Cocc.', 'Giardia'],
              'rows': [
                ['Sulfamethoxazole', '', '', '', '', '✅', ''],
                ['Toltrazuril', '', '', '', '', '✅', ''],
                ['Sulfadimethoxine', '', '', '', '', '✅', ''],
                ['Metronidazole', '', '', '', '', '', '✅'],
                ['Fenbendazole', '✅', '', '', '', '', ''],
                ['Pyrantel', '✅', '✅', '', '', '', ''],
                ['Emodepside', '✅', '✅', '', '', '', ''],
                ['Levamisole', '✅', '', '', '', '', ''],
                ['Ivermectine', '✅', '', '✅', '✅', '', ''],
              ]
            },
            {'type': 'section', 'value': '💡 Famakafakana sy Fampiasana azy'},
            
            {'type': 'subtitle', 'value': '1. Ho an\'ny Coccidiose (Aretin-kibo)'},
            {'type': 'text', 'value': 'Raha mivalana, na mety ho fisorohana ny coccidiose, dia ireto no ampiasaina:'},
            {'type': 'bullet', 'value': 'Sulfamethoxazole'},
            {'type': 'bullet', 'value': 'Toltrazuril (Anticox)'},
            {'type': 'bullet', 'value': 'Sulfadimethoxine'},

            {'type': 'subtitle', 'value': '2. Ho an\'ny Kakana (Kankana anaty kibo)'},
            {'type': 'bullet', 'label': 'Kakana Boribory fotsiny', 'value': 'Fenbendazole na Levamisole.'},
            {'type': 'bullet', 'label': 'Kakana Boribory sy Fisaka', 'value': 'Pyrantel sy Praziquantel na Emodepside.'},

            {'type': 'subtitle', 'value': '3. Ho an\'ny Katsentsitra Ivelany (Hoditra)'},
            {'type': 'text', 'value': 'Raha manana lagaly (gale) na parasy ny bitro:'},
            {'type': 'bullet', 'label': 'Ivermectine', 'value': 'Ity no tena "complet" satria sady mamono Parasy sy Lagaly no mamono Kakana boribory koa. (Tandremo anefa ny fatrany fa mahery).'},

            {'type': 'subtitle', 'value': '4. Ho an\'ny Giardia'},
            {'type': 'text', 'value': 'Metronidazole no vahaolana tokana voalaza eo.'},

            {'type': 'section', 'value': '⚠️ Fanamarihana Manokana'},
            {'type': 'note', 'value': 'Tandremo: Ity lisitra ity dia milaza ny karazana fanafody (molécule) miasa, fa tsy ny fatrany (dosage). Mila manontany mpitsabo biby na mijery ny torolalana amin\'ny tavoahangim-panafody ianao alohan\'ny hampiasana azy.'},
          ]
        }
      ],
      'signs': ['Fihinanana tsara', 'Volom-be tsara', 'Maso mazava', 'Mavitrika', 'Tsy mivalana'],
      'tips': 'Jereo isan\'andro: Fihinanana, Fivalanana, Fahazotoana. Ny bitro salama dia mavitrika sy mazoto homana.',
    },
    'Bitro Voalavo': {
      'emoji': '🐹',
      'vaccines': [
        {'name': 'Vermifuge', 'when': '2 volana', 'repeat': 'Isaky ny 3 volana', 'emoji': '💊'},
        {'name': 'Vitamine C', 'when': 'Isan\'andro', 'repeat': 'Isan\'andro', 'emoji': '🍊'},
      ],
      'diseases': [
        {'name': 'Scorbut (tsy ampy Vit C)', 'symptoms': 'Havizanana, Nify mivaloana', 'prevention': 'Vitamine C isan\'andro'},
        {'name': 'Aretina amin\'ny voamaso', 'symptoms': 'Maso mena, mibontsina', 'prevention': 'Fahadiovana'},
        {'name': 'Aretina amin\'ny hoditra', 'symptoms': 'Mangatsiaka, Mikaika', 'prevention': 'Fahadiovana'},
        {'name': 'Otite', 'symptoms': 'Mandona loha, Tsy mandre', 'prevention': 'Manadio sofina'},
      ],
      'signs': ['Fihinanana tsara', 'Volom-be malandy', 'Maso mazava', 'Mikiky foana'],
      'tips': '⚠️ Zava-dehibe: Vitamine C 30-50mg isan\'andro! Tsy afaka mamokatra irery izy.',
    },
  };

  @override
  Widget build(BuildContext context) {
    final data = _healthData[_selectedType]!;
    
    // Helper for 3D Card Decoration
    BoxDecoration build3DDecoration({Color color = Colors.white}) {
      return BoxDecoration(
        color: color,
        borderRadius: BorderRadius.circular(20),
        boxShadow: [
          BoxShadow(
            color: Colors.grey.withValues(alpha: 0.3),
            offset: const Offset(5, 5),
            blurRadius: 10,
          ),
          BoxShadow(
            color: Colors.white,
            offset: const Offset(-5, -5),
            blurRadius: 10,
          ),
        ],
      );
    }

    return DefaultTabController(
      length: 4,
      child: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              Colors.grey.shade200,
              Colors.grey.shade100,
            ],
          ),
        ),
        child: Column(
          children: [
            // Type selector (Fixed at top)
            Padding(
              padding: const EdgeInsets.all(16),
              child: Container(
                padding: const EdgeInsets.all(16),
                decoration: build3DDecoration(),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    const Text(
                      'Karazana Bitro 🐇',
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                        color: AppColors.primaryDark,
                      ),
                    ),
                    const SizedBox(height: 12),
                    SingleChildScrollView(
                      scrollDirection: Axis.horizontal,
                      child: Row(
                        children: _healthData.keys.map((type) {
                          final isSelected = _selectedType == type;
                          final typeData = _healthData[type]!;
                          return Padding(
                            padding: const EdgeInsets.only(right: 10),
                            child: GestureDetector(
                              onTap: () => setState(() => _selectedType = type),
                              child: Container(
                                padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                                decoration: BoxDecoration(
                                  color: isSelected ? AppColors.primary : Colors.grey[100],
                                  borderRadius: BorderRadius.circular(20),
                                  boxShadow: isSelected ? [
                                    BoxShadow(color: AppColors.primary.withValues(alpha: 0.4), blurRadius: 8, offset: const Offset(0, 4))
                                  ] : null,
                                  border: Border.all(
                                    color: isSelected ? AppColors.primaryDark : Colors.grey[300]!,
                                  ),
                                ),
                                child: Row(
                                  mainAxisSize: MainAxisSize.min,
                                  children: [
                                    Text(typeData['emoji'] as String, style: const TextStyle(fontSize: 20)),
                                    const SizedBox(width: 8),
                                    Text(
                                      type,
                                      style: TextStyle(
                                        color: isSelected ? Colors.white : Colors.black87,
                                        fontWeight: FontWeight.w600,
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ),
                          );
                        }).toList(),
                      ),
                    ),
                  ],
                ),
              ),
            ),

            // Tab Bar
            Container(
              margin: const EdgeInsets.symmetric(horizontal: 16),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.circular(25),
                boxShadow: [
                  BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 4, offset: const Offset(0, 2))
                ],
              ),
              child: TabBar(
                isScrollable: true,
                labelColor: AppColors.primary,
                unselectedLabelColor: Colors.grey,
                indicatorSize: TabBarIndicatorSize.label,
                indicatorColor: AppColors.primary,
                tabs: const [
                  Tab(text: 'Famantarana'),
                  Tab(text: 'Vakisiny'),
                  Tab(text: 'Aretina'),
                  Tab(text: 'Torolalana'),
                ],
              ),
            ),
            
            const SizedBox(height: 10),

            // Tab Views
            Expanded(
              child: TabBarView(
                children: [
                  // Tab 1: Famantarana (Signs)
                  SingleChildScrollView(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      children: [
                        Container(
                          padding: const EdgeInsets.all(16),
                          decoration: build3DDecoration(color: Colors.green.shade50),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              const Text(
                                '✅ Famantarana fahasalamana',
                                style: TextStyle(
                                  fontSize: 16,
                                  fontWeight: FontWeight.bold,
                                  color: Colors.green,
                                ),
                              ),
                              const SizedBox(height: 12),
                              Wrap(
                                spacing: 8,
                                runSpacing: 8,
                                children: (data['signs'] as List<String>).map((sign) => Container(
                                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                                  decoration: BoxDecoration(
                                    color: Colors.green[100],
                                    borderRadius: BorderRadius.circular(20),
                                    boxShadow: [BoxShadow(color: Colors.green.withValues(alpha: 0.2), blurRadius: 4, offset: const Offset(0, 2))],
                                  ),
                                  child: Text(sign, style: TextStyle(color: Colors.green[800])),
                                )).toList(),
                              ),
                            ],
                          ),
                        ),
                        if (data.containsKey('tips')) ...[
                          const SizedBox(height: 20),
                          Container(
                            padding: const EdgeInsets.all(16),
                            decoration: build3DDecoration(color: Colors.amber.shade50),
                            child: Row(
                              children: [
                                const Icon(Icons.lightbulb, color: Colors.amber),
                                const SizedBox(width: 12),
                                Expanded(
                                  child: Text(
                                    data['tips'] as String,
                                    style: TextStyle(color: Colors.amber.shade900, fontStyle: FontStyle.italic),
                                  ),
                                ),
                              ],
                            ),
                          ),
                        ],
                      ],
                    ),
                  ),

                  // Tab 2: Vakisiny (Vaccines)
                  SingleChildScrollView(
                    padding: const EdgeInsets.all(16),
                    child: Container(
                      padding: const EdgeInsets.all(16),
                      decoration: build3DDecoration(),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            '💉 Vakisiny sy Fitsaboana',
                            style: TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.bold,
                              color: AppColors.primaryDark,
                            ),
                          ),
                          const SizedBox(height: 16),
                          ...(data['vaccines'] as List).map((vac) => Container(
                            margin: const EdgeInsets.only(bottom: 12),
                            padding: const EdgeInsets.all(12),
                            decoration: BoxDecoration(
                              color: Colors.blue[50],
                              borderRadius: BorderRadius.circular(12),
                              boxShadow: [BoxShadow(color: Colors.blue.withValues(alpha: 0.1), blurRadius: 4, offset: const Offset(0, 2))],
                            ),
                            child: Row(
                              children: [
                                Text(vac['emoji'] as String, style: const TextStyle(fontSize: 24)),
                                const SizedBox(width: 12),
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      Text(vac['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold)),
                                      Text('Fotoana: ${vac['when']}', style: TextStyle(color: Colors.grey[600], fontSize: 12)),
                                      Text('Averina: ${vac['repeat']}', style: TextStyle(color: Colors.grey[600], fontSize: 12)),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                          )),

                          if (data['treatments'] != null) ...[
                            const SizedBox(height: 16),
                            const Text(
                              '💊 Fitsaboana (Calendrier)',
                              style: TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                                color: AppColors.primaryDark,
                              ),
                            ),
                            const SizedBox(height: 8),
                            ...(data['treatments'] as List).map((treatment) => Container(
                              margin: const EdgeInsets.only(bottom: 12),
                              padding: const EdgeInsets.all(12),
                              decoration: BoxDecoration(
                                color: Colors.orange.shade50,
                                borderRadius: BorderRadius.circular(12),
                                border: Border.all(color: Colors.orange.shade100),
                                boxShadow: [BoxShadow(color: Colors.orange.withValues(alpha: 0.1), blurRadius: 4, offset: const Offset(0, 2))],
                              ),
                              child: Row(
                                children: [
                                  Text(treatment['emoji'] as String, style: const TextStyle(fontSize: 24)),
                                  const SizedBox(width: 12),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        Text(treatment['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold)),
                                        Text('Fanafody: ${treatment['product']}', style: const TextStyle(fontSize: 12)),
                                        Text('Fatra: ${treatment['dosage']}', style: const TextStyle(fontSize: 12)),
                                        Text('Fotoana: ${treatment['frequency']}', style: TextStyle(color: Colors.orange.shade800, fontWeight: FontWeight.w500, fontSize: 12)),
                                        if (treatment['note'] != null)
                                          Text('Note: ${treatment['note']}', style: TextStyle(color: Colors.grey[600], fontStyle: FontStyle.italic, fontSize: 11)),
                                      ],
                                    ),
                                  ),
                                ],
                              ),
                            )),
                          ],
                        ],
                      ),
                    ),
                  ),

                  // Tab 3: Aretina (Diseases)
                  SingleChildScrollView(
                    padding: const EdgeInsets.all(16),
                    child: Container(
                      padding: const EdgeInsets.all(16),
                      decoration: build3DDecoration(),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            '🏥 Aretina mahazatra',
                            style: TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.bold,
                              color: AppColors.primaryDark,
                            ),
                          ),
                          const SizedBox(height: 16),
                          ...(data['diseases'] as List).map((disease) => Container(
                            margin: const EdgeInsets.only(bottom: 12),
                            padding: const EdgeInsets.all(12),
                            decoration: BoxDecoration(
                              color: Colors.red[50],
                              borderRadius: BorderRadius.circular(12),
                              border: Border.all(color: Colors.red[100]!),
                              boxShadow: [BoxShadow(color: Colors.red.withValues(alpha: 0.1), blurRadius: 4, offset: const Offset(0, 2))],
                            ),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  disease['name'] as String,
                                  style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.red),
                                ),
                                const SizedBox(height: 4),
                                Text('📌 Soritr\'aretina: ${disease['symptoms']}', style: const TextStyle(fontSize: 12)),
                                if (disease['treatment'] != null)
                                   Padding(
                                     padding: const EdgeInsets.symmetric(vertical: 2),
                                     child: Text('💊 Fitsaboana: ${disease['treatment']}', style: TextStyle(fontSize: 12, color: Colors.blue[800], fontWeight: FontWeight.w600)),
                                   ),
                                Text('✅ Fisorohana: ${disease['prevention']}', style: TextStyle(fontSize: 12, color: Colors.green[700])),
                              ],
                            ),
                          )),
                        ],
                      ),
                    ),
                  ),

                  // Tab 4: Torolalana (Guides)
                  SingleChildScrollView(
                    padding: const EdgeInsets.all(16),
                    child: data.containsKey('guides') ? Container(
                      padding: const EdgeInsets.all(16),
                      decoration: build3DDecoration(color: Colors.purple.shade50),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            '📚 Torolalana Manokana',
                            style: TextStyle(
                              fontSize: 18,
                              fontWeight: FontWeight.bold,
                              color: Colors.purple,
                            ),
                          ),
                          const SizedBox(height: 16),
                          ...(data['guides'] as List).map((guide) => Theme(
                            data: Theme.of(context).copyWith(dividerColor: Colors.transparent),
                            child: ExpansionTile(
                              tilePadding: EdgeInsets.zero,
                              title: Text(
                                guide['title'] as String,
                                style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.purple),
                              ),
                              children: [
                                Container(
                                  width: double.infinity,
                                  padding: const EdgeInsets.all(16),
                                  decoration: BoxDecoration(
                                    color: Colors.white,
                                    borderRadius: BorderRadius.circular(12),
                                    boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 4, offset: const Offset(0, 2))],
                                  ),
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: (guide['elements'] as List).map<Widget>((el) {
                                      final type = el['type'] as String;
                                      switch (type) {
                                        case 'section':
                                          return Padding(
                                            padding: const EdgeInsets.only(top: 16, bottom: 8),
                                            child: Text(
                                              el['value'] as String,
                                              style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.purple),
                                            ),
                                          );
                                        case 'subtitle':
                                          return Padding(
                                            padding: const EdgeInsets.only(top: 12, bottom: 4),
                                            child: Text(
                                              el['value'] as String,
                                              style: const TextStyle(fontSize: 14, fontWeight: FontWeight.bold, color: Colors.black87),
                                            ),
                                          );
                                        case 'text':
                                          return Padding(
                                            padding: const EdgeInsets.only(bottom: 8),
                                            child: Text(el['value'] as String, style: const TextStyle(height: 1.4)),
                                          );
                                        case 'bullet':
                                          return Padding(
                                            padding: const EdgeInsets.only(bottom: 6, left: 8),
                                            child: Row(
                                              crossAxisAlignment: CrossAxisAlignment.start,
                                              children: [
                                                const Text('• ', style: TextStyle(fontWeight: FontWeight.bold, color: Colors.purple)),
                                                Expanded(
                                                  child: RichText(
                                                    text: TextSpan(
                                                      style: const TextStyle(color: Colors.black87, height: 1.4),
                                                      children: [
                                                        if (el.containsKey('label'))
                                                          TextSpan(text: '${el['label']}: ', style: const TextStyle(fontWeight: FontWeight.bold)),
                                                        TextSpan(text: el['value'] as String),
                                                      ],
                                                    ),
                                                  ),
                                                ),
                                              ],
                                            ),
                                          );
                                        case 'note':
                                          return Container(
                                            margin: const EdgeInsets.only(top: 8, bottom: 8),
                                            padding: const EdgeInsets.all(12),
                                            decoration: BoxDecoration(
                                              color: Colors.amber.shade50,
                                              borderRadius: BorderRadius.circular(8),
                                              border: Border.all(color: Colors.amber.shade200),
                                            ),
                                            child: Row(
                                              children: [
                                                const Icon(Icons.info_outline, color: Colors.amber, size: 20),
                                                const SizedBox(width: 8),
                                                Expanded(child: Text(el['value'] as String, style: const TextStyle(fontStyle: FontStyle.italic))),
                                              ],
                                            ),
                                          );
                                        case 'table':
                                          final headers = el['headers'] as List;
                                          final rows = el['rows'] as List;
                                          return SingleChildScrollView(
                                            scrollDirection: Axis.horizontal,
                                            child: DataTable(
                                              columnSpacing: 10,
                                              headingRowColor: WidgetStateProperty.all(Colors.purple.shade50),
                                              columns: headers.map((h) => DataColumn(label: Text(h as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 11)))).toList(),
                                              rows: rows.map((row) {
                                                return DataRow(cells: (row as List).map((cell) => DataCell(Text(cell as String, style: const TextStyle(fontSize: 11)))).toList());
                                              }).toList(),
                                            ),
                                          );
                                        default:
                                          return const SizedBox();
                                      }
                                    }).toList(),
                                  ),
                                ),
                              ],
                            ),
                          )),
                        ],
                      ),
                    ) : const Center(child: Text("Tsy misy torolalana manokana")),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// Bitro Gestation Screen - Fiterahana Bitro
// --- MODULE 4: RACES BITRO (BREEDS & PEDIGREE) ---
class BitroBreedsScreen extends StatefulWidget {
  const BitroBreedsScreen({super.key});

  @override
  State<BitroBreedsScreen> createState() => _BitroBreedsScreenState();
}

class _BitroBreedsScreenState extends State<BitroBreedsScreen> with SingleTickerProviderStateMixin {
  List<Map<String, dynamic>> _breeds = [];
  List<Map<String, dynamic>> _rabbits = []; // Individual rabbits with pedigree
  late TabController _tabController;
  String _searchQuery = '';
  String _filterType = 'Rehetra';

  // Base de données des races de lapins
  static final List<Map<String, dynamic>> _predefinedBreeds = [
    // Races de chair (Hena)
    {'name': 'Néo-Zélandais Blanc', 'origin': 'États-Unis', 'type': 'Chair', 'weight': 4.5, 'color': 'Blanc (Yeux rouges)', 'littersPerYear': 6},
    {'name': 'Californien', 'origin': 'États-Unis', 'type': 'Chair', 'weight': 4.0, 'color': 'Blanc avec extrémités noires/brunes', 'littersPerYear': 6},
    {'name': 'Géant des Flandres', 'origin': 'Belgique', 'type': 'Chair', 'weight': 7.0, 'color': 'Gris garenne, Noir, Bleu, Fauve, Blanc', 'littersPerYear': 4},
    {'name': 'Fauve de Bourgogne', 'origin': 'France', 'type': 'Chair', 'weight': 4.0, 'color': 'Fauve (Roux)', 'littersPerYear': 6},
    {'name': 'Géant Papillon Français', 'origin': 'France', 'type': 'Chair', 'weight': 6.0, 'color': 'Blanc avec taches noires ou bleues', 'littersPerYear': 5},
    {'name': 'Bélier Français', 'origin': 'France', 'type': 'Chair', 'weight': 5.5, 'color': 'Gris, Noir, Blanc, Tacheté', 'littersPerYear': 5},
    {'name': 'Champagne d\'Argent', 'origin': 'France', 'type': 'Chair', 'weight': 4.5, 'color': 'Argenté (Vieil argent)', 'littersPerYear': 6},
    {'name': 'Blanc de Bouscat', 'origin': 'France', 'type': 'Chair', 'weight': 6.0, 'color': 'Blanc pur', 'littersPerYear': 5},
    {'name': 'Bleu de Vienne', 'origin': 'Autriche', 'type': 'Chair', 'weight': 4.5, 'color': 'Bleu ardoise foncé', 'littersPerYear': 5},
    {'name': 'Grand Chinchilla', 'origin': 'États-Unis', 'type': 'Chair', 'weight': 5.5, 'color': 'Gris chinchilla', 'littersPerYear': 5},
    {'name': 'Américain', 'origin': 'États-Unis', 'type': 'Chair', 'weight': 4.5, 'color': 'Bleu, Blanc', 'littersPerYear': 5},
    {'name': 'Cannelle (Cinnamon)', 'origin': 'États-Unis', 'type': 'Chair', 'weight': 4.5, 'color': 'Cannelle (Roux/Brun)', 'littersPerYear': 5},
    {'name': 'Palomino', 'origin': 'États-Unis', 'type': 'Chair', 'weight': 4.0, 'color': 'Doré ou Lynx', 'littersPerYear': 5},
    {'name': 'Blanc de Termonde', 'origin': 'Belgique', 'type': 'Chair', 'weight': 4.5, 'color': 'Blanc (Yeux rouges)', 'littersPerYear': 6},
    {'name': 'Géant Continental', 'origin': 'Europe', 'type': 'Chair', 'weight': 7.0, 'color': 'Varié', 'littersPerYear': 4},
    {'name': 'Gris de Vienne', 'origin': 'Autriche', 'type': 'Chair', 'weight': 4.5, 'color': 'Gris bleu', 'littersPerYear': 5},
    {'name': 'Géant Allemand', 'origin': 'Allemagne', 'type': 'Chair', 'weight': 8.5, 'color': 'Gris fer', 'littersPerYear': 4},
    
    // Races à fourrure (Volo)
    {'name': 'Rex Standard', 'origin': 'France', 'type': 'Fourrure', 'weight': 3.5, 'color': 'Toutes couleurs (Poil velours)', 'littersPerYear': 5},
    {'name': 'Angora Français', 'origin': 'France', 'type': 'Fourrure', 'weight': 4.0, 'color': 'Toutes couleurs (Poil long)', 'littersPerYear': 4},
    {'name': 'Angora Anglais', 'origin': 'Angleterre', 'type': 'Fourrure', 'weight': 3.0, 'color': 'Toutes couleurs (Poil très long)', 'littersPerYear': 4},
    {'name': 'Satin', 'origin': 'États-Unis', 'type': 'Fourrure', 'weight': 4.0, 'color': 'Toutes couleurs (Poil brillant)', 'littersPerYear': 5},
    {'name': 'Havane', 'origin': 'Pays-Bas', 'type': 'Fourrure', 'weight': 3.0, 'color': 'Chocolat, Bleu, Noir', 'littersPerYear': 5},
    {'name': 'Argenté de Saint-Hubert', 'origin': 'France', 'type': 'Fourrure', 'weight': 4.5, 'color': 'Gris garenne argenté', 'littersPerYear': 5},
    {'name': 'Alaska', 'origin': 'Allemagne', 'type': 'Fourrure', 'weight': 3.0, 'color': 'Noir brillant', 'littersPerYear': 5},
    {'name': 'Zibeline', 'origin': 'France', 'type': 'Fourrure', 'weight': 3.0, 'color': 'Brun sépia (Dégradé)', 'littersPerYear': 5},
    {'name': 'Chinchilla Standard', 'origin': 'France', 'type': 'Fourrure', 'weight': 2.5, 'color': 'Gris chinchilla', 'littersPerYear': 5},
    
    // Races naines/ornement (Haingo)
    {'name': 'Nain de Couleur', 'origin': 'Pays-Bas', 'type': 'Ornement', 'weight': 1.0, 'color': 'Toutes couleurs', 'littersPerYear': 3},
    {'name': 'Bélier Nain', 'origin': 'Pays-Bas', 'type': 'Ornement', 'weight': 1.5, 'color': 'Toutes couleurs (Oreilles tombantes)', 'littersPerYear': 4},
    {'name': 'Tête de Lion', 'origin': 'Belgique', 'type': 'Ornement', 'weight': 1.5, 'color': 'Toutes couleurs (Crinière)', 'littersPerYear': 4},
    {'name': 'Polonais (Hermine)', 'origin': 'Angleterre', 'type': 'Ornement', 'weight': 1.0, 'color': 'Blanc (Yeux bleus ou rouges)', 'littersPerYear': 3},
    {'name': 'Hollandais', 'origin': 'Pays-Bas', 'type': 'Ornement', 'weight': 2.0, 'color': 'Bicolore (Blanc et Noir/Bleu/Chocolat)', 'littersPerYear': 5},
    {'name': 'Tan (Noir et Feu)', 'origin': 'Angleterre', 'type': 'Ornement', 'weight': 2.5, 'color': 'Noir avec ventre roux', 'littersPerYear': 4},
    {'name': 'Arlequin', 'origin': 'France', 'type': 'Ornement', 'weight': 3.5, 'color': 'Tricolore ou Bicolore (Bandes)', 'littersPerYear': 5},
    {'name': 'Himalayen', 'origin': 'Asie', 'type': 'Ornement', 'weight': 1.5, 'color': 'Blanc avec extrémités colorées', 'littersPerYear': 4},
    {'name': 'Papillon Anglais', 'origin': 'Angleterre', 'type': 'Ornement', 'weight': 2.5, 'color': 'Blanc tacheté (Noir, Bleu, Chocolat)', 'littersPerYear': 5},
    {'name': 'Bélier Anglais', 'origin': 'Angleterre', 'type': 'Ornement', 'weight': 4.5, 'color': 'Toutes couleurs (Oreilles très longues)', 'littersPerYear': 4},
    {'name': 'Russe', 'origin': 'Royaume-Uni', 'type': 'Ornement', 'weight': 2.0, 'color': 'Blanc avec extrémités foncées', 'littersPerYear': 5},
    {'name': 'Petit Bélier', 'origin': 'Allemagne', 'type': 'Ornement', 'weight': 3.0, 'color': 'Toutes couleurs (Oreilles tombantes)', 'littersPerYear': 5},
    {'name': 'Jersey Wooly', 'origin': 'États-Unis', 'type': 'Ornement', 'weight': 1.5, 'color': 'Toutes couleurs (Poil laineux)', 'littersPerYear': 3},
    {'name': 'Mini Rex', 'origin': 'États-Unis', 'type': 'Ornement', 'weight': 1.8, 'color': 'Toutes couleurs (Poil velours)', 'littersPerYear': 4},
    
    // Races locales et mixtes (Gasy)
    {'name': 'Bitro Gasy', 'origin': 'Madagascar', 'type': 'Mixte', 'weight': 2.5, 'color': 'Variable', 'littersPerYear': 6},
    {'name': 'Bitro Mena', 'origin': 'Madagascar', 'type': 'Mixte', 'weight': 2.8, 'color': 'Roux', 'littersPerYear': 5},
    {'name': 'Bitro Mainty', 'origin': 'Madagascar', 'type': 'Mixte', 'weight': 2.6, 'color': 'Noir', 'littersPerYear': 5},
    {'name': 'Lapin Commun (Local)', 'origin': 'Madagascar/Monde', 'type': 'Mixte', 'weight': 3.0, 'color': 'Varié (Gris, Noir, Tacheté)', 'littersPerYear': 6},
    {'name': 'Blanc de Hotot', 'origin': 'France', 'type': 'Mixte', 'weight': 4.0, 'color': 'Blanc avec contour des yeux noir', 'littersPerYear': 5},
    {'name': 'Rouge de Nouvelle-Zélande', 'origin': 'États-Unis', 'type': 'Mixte', 'weight': 4.5, 'color': 'Roux intense', 'littersPerYear': 5},
    {'name': 'Lièvre Belge', 'origin': 'Belgique', 'type': 'Mixte', 'weight': 3.5, 'color': 'Roux (Allure de lièvre)', 'littersPerYear': 4},
    {'name': 'Thuringe', 'origin': 'Allemagne', 'type': 'Mixte', 'weight': 3.5, 'color': 'Chamois fumé', 'littersPerYear': 5},
    {'name': 'Feh de Marbourg', 'origin': 'Allemagne', 'type': 'Mixte', 'weight': 2.5, 'color': 'Bleu clair voilé', 'littersPerYear': 5},
    {'name': 'Lynx', 'origin': 'Allemagne', 'type': 'Mixte', 'weight': 2.5, 'color': 'Bleu et roux', 'littersPerYear': 5},
    {'name': 'Argenté Crème', 'origin': 'France', 'type': 'Mixte', 'weight': 4.0, 'color': 'Crème argenté', 'littersPerYear': 5},
    {'name': 'Gris du Bourbonnais', 'origin': 'France', 'type': 'Mixte', 'weight': 4.0, 'color': 'Gris fer', 'littersPerYear': 5},
    {'name': 'Normand', 'origin': 'France', 'type': 'Mixte', 'weight': 4.0, 'color': 'Gris garenne', 'littersPerYear': 5},
    {'name': 'Bleu de Beveren', 'origin': 'Belgique', 'type': 'Mixte', 'weight': 4.0, 'color': 'Bleu clair', 'littersPerYear': 5},
    {'name': 'Japonais', 'origin': 'France', 'type': 'Mixte', 'weight': 3.5, 'color': 'Bringé (Jaune et Noir)', 'littersPerYear': 5},
    
    // Bitro Voalavo (Cochons d'Inde)
    {'name': 'Bitro Voalavo (Cochon d\'Inde)', 'origin': 'Amérique du Sud', 'type': 'Ornement', 'weight': 1.0, 'color': 'Variable', 'littersPerYear': 3},
    {'name': 'Cochon d\'Inde Abyssinien', 'origin': 'Amérique du Sud', 'type': 'Ornement', 'weight': 1.0, 'color': 'Rosettes (Volo misavoritaka)', 'littersPerYear': 3},
    {'name': 'Cochon d\'Inde Péruvien', 'origin': 'Pérou', 'type': 'Ornement', 'weight': 1.2, 'color': 'Poil long (Volo lava)', 'littersPerYear': 3},
    {'name': 'Cochon d\'Inde Skinny', 'origin': 'Canada', 'type': 'Ornement', 'weight': 0.9, 'color': 'Sans poil (Tsy misy volo)', 'littersPerYear': 3},
  ];

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 3, vsync: this);
    _loadData();
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  Future<void> _loadData() async {
    final prefs = await SharedPreferences.getInstance();
    final breedsJson = prefs.getString('rabbit_breeds') ?? '[]';
    final rabbitsJson = prefs.getString('rabbits_pedigree') ?? '[]';
    setState(() {
      _breeds = List<Map<String, dynamic>>.from(jsonDecode(breedsJson));
      _rabbits = List<Map<String, dynamic>>.from(jsonDecode(rabbitsJson));
      
      // Check if we need to update the breeds list with new predefined ones
      bool needsUpdate = false;
      for (final predefined in _predefinedBreeds) {
        if (!_breeds.any((b) => b['name'] == predefined['name'])) {
          _breeds.add({...predefined, 'id': 'breed_${predefined['name'].hashCode}'});
          needsUpdate = true;
        }
      }
      
      if (needsUpdate || _breeds.isEmpty) {
        if (_breeds.isEmpty) {
           _breeds = _predefinedBreeds.map((b) => {...b, 'id': 'breed_${b['name'].hashCode}'}).toList();
        }
        _saveData();
      }
    });
  }

  Future<void> _saveData() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString('rabbit_breeds', jsonEncode(_breeds));
    await prefs.setString('rabbits_pedigree', jsonEncode(_rabbits));
  }

  Map<String, dynamic> _predictCrossbreeding(Map<String, dynamic> father, Map<String, dynamic> mother) {
    final avgLitters = ((father['littersPerYear'] ?? 0) + (mother['littersPerYear'] ?? 0)) ~/ 2;
    final avgWeight = ((father['weight'] ?? 0.0) + (mother['weight'] ?? 0.0)) / 2;
    
    String predictedType = 'Mixte';
    if (father['type'] == mother['type']) {
      predictedType = father['type'];
    }
    
    return {
      'predictedLitters': avgLitters,
      'predictedWeight': avgWeight.toStringAsFixed(1),
      'predictedType': predictedType,
      'heterosis': '5-15%',
    };
  }

  String _generateCrossName(String father, String mother) {
    final f = father.split(' ').first.substring(0, (father.length > 3 ? 3 : father.length));
    final m = mother.split(' ').first.substring(0, (mother.length > 3 ? 3 : mother.length));
    return '$f-$m F1';
  }

  void _addRabbit() {
    final idCtrl = TextEditingController();
    final nameCtrl = TextEditingController();
    String? selectedBreed;
    String? fatherId;
    String? motherId;
    String sex = 'Vavy';
    final birthDate = TextEditingController(text: DateFormat('yyyy-MM-dd').format(DateTime.now()));
    final notesCtrl = TextEditingController();

    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (ctx) => StatefulBuilder(
        builder: (context, setModalState) => Container(
          height: MediaQuery.of(ctx).size.height * 0.85,
          padding: EdgeInsets.only(bottom: MediaQuery.of(ctx).viewInsets.bottom),
          decoration: const BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
          ),
          child: Padding(
            padding: const EdgeInsets.all(24),
            child: SingleChildScrollView(
              child: Column(
                mainAxisSize: MainAxisSize.min,
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Container(
                        padding: const EdgeInsets.all(10),
                        decoration: BoxDecoration(
                          gradient: const LinearGradient(colors: [AppColors.gradientStart, AppColors.gradientEnd]),
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: const Text('🐇', style: TextStyle(fontSize: 24)),
                      ),
                      const SizedBox(width: 12),
                      const Expanded(child: Text('Hanampy Bitro + Pedigree', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold))),
                    ],
                  ),
                  const SizedBox(height: 20),
                  
                  Row(
                    children: [
                      Expanded(child: TextField(controller: idCtrl, decoration: const InputDecoration(labelText: 'ID / Tombokavatsa', prefixIcon: Icon(Icons.tag)))),
                      const SizedBox(width: 12),
                      Expanded(child: TextField(controller: nameCtrl, decoration: const InputDecoration(labelText: 'Anarana', prefixIcon: Icon(Icons.pets)))),
                    ],
                  ),
                  const SizedBox(height: 12),
                  
                  Row(
                    children: [
                      Expanded(
                        flex: 2,
                        child: DropdownButtonFormField<String>(
                          initialValue: selectedBreed,
                          decoration: const InputDecoration(labelText: 'Races', prefixIcon: Icon(Icons.category)),
                          items: _breeds.map((b) => DropdownMenuItem<String>(
                            value: b['id'] as String,
                            child: Text(b['name'] as String, overflow: TextOverflow.ellipsis),
                          )).toList(),
                          onChanged: (v) => setModalState(() => selectedBreed = v),
                          isExpanded: true,
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: DropdownButtonFormField<String>(
                          initialValue: sex,
                          decoration: const InputDecoration(labelText: 'Lahy/Vavy'),
                          items: ['Lahy', 'Vavy'].map((s) => DropdownMenuItem(value: s, child: Text(s))).toList(),
                          onChanged: (v) => setModalState(() => sex = v!),
                        ),
                      ),
                    ],
                  ),
                  const SizedBox(height: 16),
                  
                  Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: AppColors.info.withValues(alpha: 0.08),
                      borderRadius: BorderRadius.circular(16),
                      border: Border.all(color: AppColors.info.withValues(alpha: 0.3)),
                    ),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Row(
                          children: [
                            Icon(Icons.account_tree, color: AppColors.info),
                            SizedBox(width: 8),
                            Text('PEDIGREE (Ray aman-dreny)', style: TextStyle(fontWeight: FontWeight.bold, color: AppColors.info)),
                          ],
                        ),
                        const SizedBox(height: 12),
                        DropdownButtonFormField<String?>(
                          initialValue: fatherId,
                          decoration: const InputDecoration(
                            labelText: 'Ray (Lahy)',
                            prefixIcon: Icon(Icons.male, color: Colors.blue),
                            filled: true,
                            fillColor: Colors.white,
                          ),
                          items: [
                            const DropdownMenuItem<String?>(value: null, child: Text('Tsy fantatra')),
                            ..._rabbits.where((c) => c['sex'] == 'Lahy').map((c) => DropdownMenuItem<String>(
                              value: c['id'] as String,
                              child: Text('${c['name']} (${c['bandId']})'),
                            )),
                          ],
                          onChanged: (v) => setModalState(() => fatherId = v),
                          isExpanded: true,
                        ),
                        const SizedBox(height: 10),
                        DropdownButtonFormField<String?>(
                          initialValue: motherId,
                          decoration: const InputDecoration(
                            labelText: 'Reny (Vavy)',
                            prefixIcon: Icon(Icons.female, color: Colors.pink),
                            filled: true,
                            fillColor: Colors.white,
                          ),
                          items: [
                            const DropdownMenuItem<String?>(value: null, child: Text('Tsy fantatra')),
                            ..._rabbits.where((c) => c['sex'] == 'Vavy').map((c) => DropdownMenuItem<String>(
                              value: c['id'] as String,
                              child: Text('${c['name']} (${c['bandId']})'),
                            )),
                          ],
                          onChanged: (v) => setModalState(() => motherId = v),
                          isExpanded: true,
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 12),
                  
                  TextField(
                    controller: birthDate,
                    decoration: const InputDecoration(labelText: 'Daty nahaterahana', prefixIcon: Icon(Icons.calendar_today)),
                    readOnly: true,
                    onTap: () async {
                      final date = await showDatePicker(
                        context: context,
                        initialDate: DateTime.now(),
                        firstDate: DateTime(2020),
                        lastDate: DateTime.now(),
                      );
                      if (date != null) {
                        setModalState(() => birthDate.text = DateFormat('yyyy-MM-dd').format(date));
                      }
                    },
                  ),
                  const SizedBox(height: 12),
                  TextField(controller: notesCtrl, maxLines: 2, decoration: const InputDecoration(labelText: 'Fanamarihana', prefixIcon: Icon(Icons.notes))),
                  const SizedBox(height: 20),
                  
                  SizedBox(
                    width: double.infinity,
                    child: ElevatedButton.icon(
                      onPressed: () {
                        if (idCtrl.text.isNotEmpty && selectedBreed != null) {
                          final breed = _breeds.firstWhere((b) => b['id'] == selectedBreed);
                          setState(() {
                            _rabbits.add({
                              'id': DateTime.now().millisecondsSinceEpoch.toString(),
                              'bandId': idCtrl.text,
                              'name': nameCtrl.text.isNotEmpty ? nameCtrl.text : 'Bitro ${idCtrl.text}',
                              'breedId': selectedBreed,
                              'breedName': breed['name'],
                              'sex': sex,
                              'fatherId': fatherId,
                              'motherId': motherId,
                              'birthDate': birthDate.text,
                              'notes': notesCtrl.text,
                              'generation': _calculateGeneration(fatherId, motherId),
                            });
                            _saveData();
                          });
                          Navigator.pop(ctx);
                        }
                      },
                      icon: const Icon(Icons.add),
                      label: const Text('Hampiditra'),
                      style: ElevatedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 14)),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }

  int _calculateGeneration(String? fatherId, String? motherId) {
    if (fatherId == null && motherId == null) return 0;
    int fatherGen = 0, motherGen = 0;
    if (fatherId != null) {
      final father = _rabbits.firstWhere((c) => c['id'] == fatherId, orElse: () => {'generation': 0});
      fatherGen = father['generation'] ?? 0;
    }
    if (motherId != null) {
      final mother = _rabbits.firstWhere((c) => c['id'] == motherId, orElse: () => {'generation': 0});
      motherGen = mother['generation'] ?? 0;
    }
    return (fatherGen > motherGen ? fatherGen : motherGen) + 1;
  }

  void _showPedigreeTree(Map<String, dynamic> rabbit) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (ctx) => Container(
        height: MediaQuery.of(ctx).size.height * 0.7,
        decoration: const BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
        ),
        child: Padding(
          padding: const EdgeInsets.all(24),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(10),
                    decoration: BoxDecoration(
                      gradient: const LinearGradient(colors: [AppColors.gradientStart, AppColors.gradientEnd]),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: const Icon(Icons.account_tree, color: Colors.white),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text('Pedigree: ${rabbit['name']}', style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                        Text('Taranaka F${rabbit['generation']}', style: TextStyle(color: AppColors.textSecondary)),
                      ],
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 24),
              Expanded(
                child: SingleChildScrollView(
                  child: _buildPedigreeNode(rabbit, 0),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildPedigreeNode(Map<String, dynamic> rabbit, int level) {
    final father = rabbit['fatherId'] != null ? _rabbits.firstWhere((c) => c['id'] == rabbit['fatherId'], orElse: () => {}) : null;
    final mother = rabbit['motherId'] != null ? _rabbits.firstWhere((c) => c['id'] == rabbit['motherId'], orElse: () => {}) : null;

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        _buildParentCard(rabbit, rabbit['sex'] ?? 'Vavy', level),
        
        if (father != null || mother != null) ...[
          const SizedBox(height: 8),
          Row(
            children: [
              SizedBox(width: (level + 1) * 20.0),
              const Icon(Icons.subdirectory_arrow_right, color: AppColors.textSecondary),
              const Text(' Ray aman-dreny:', style: TextStyle(color: AppColors.textSecondary, fontSize: 12)),
            ],
          ),
          const SizedBox(height: 8),
          if (father != null && father.isNotEmpty)
            _buildPedigreeNode(father, level + 1),
          if (mother != null && mother.isNotEmpty)
            _buildPedigreeNode(mother, level + 1),
        ],
      ],
    );
  }

  Widget _buildParentCard(Map<String, dynamic> parent, String sex, int level) {
    return GestureDetector(
      onTap: () {
        // Already showing tree
      },
      child: Container(
        padding: const EdgeInsets.all(10),
        margin: EdgeInsets.only(left: level * 20.0, bottom: 8),
        decoration: BoxDecoration(
          color: sex == 'Lahy' ? Colors.blue.shade50 : Colors.pink.shade50,
          borderRadius: BorderRadius.circular(10),
          border: Border.all(color: (sex == 'Lahy' ? Colors.blue : Colors.pink).withValues(alpha: 0.3)),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(sex == 'Lahy' ? Icons.male : Icons.female, 
                color: sex == 'Lahy' ? Colors.blue : Colors.pink, size: 20),
            const SizedBox(width: 6),
            Text(parent['name'] ?? 'Tsy fantatra', style: const TextStyle(fontWeight: FontWeight.w500)),
            if (parent['breedName'] != null) Text(' (${parent['breedName']})', style: const TextStyle(fontSize: 11)),
          ],
        ),
      ),
    );
  }

  void _simulateCrossbreeding() {
    String? fatherId, motherId;
    
    showModalBottomSheet(
      context: context,
      backgroundColor: Colors.transparent,
      builder: (ctx) => StatefulBuilder(
        builder: (context, setModalState) => Container(
          padding: const EdgeInsets.all(24),
          decoration: const BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.vertical(top: Radius.circular(24)),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text('Simulateur de Croisement', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
              const SizedBox(height: 20),
              DropdownButtonFormField<String>(
                decoration: const InputDecoration(labelText: 'Ray (Lahy)', prefixIcon: Icon(Icons.male, color: Colors.blue)),
                items: _breeds.map((b) => DropdownMenuItem(value: b['id'] as String, child: Text(b['name']))).toList(),
                onChanged: (v) => setModalState(() => fatherId = v),
              ),
              const SizedBox(height: 12),
              DropdownButtonFormField<String>(
                decoration: const InputDecoration(labelText: 'Reny (Vavy)', prefixIcon: Icon(Icons.female, color: Colors.pink)),
                items: _breeds.map((b) => DropdownMenuItem(value: b['id'] as String, child: Text(b['name']))).toList(),
                onChanged: (v) => setModalState(() => motherId = v),
              ),
              const SizedBox(height: 20),
              SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: () {
                    if (fatherId != null && motherId != null) {
                      final father = _breeds.firstWhere((b) => b['id'] == fatherId);
                      final mother = _breeds.firstWhere((b) => b['id'] == motherId);
                      
                      // Check for interspecies breeding (Rabbit x Guinea Pig)
                      final isFatherGP = father['name'].toString().contains('Bitro Voalavo') || father['name'].toString().contains('Cochon d\'Inde');
                      final isMotherGP = mother['name'].toString().contains('Bitro Voalavo') || mother['name'].toString().contains('Cochon d\'Inde');
                      
                      if (isFatherGP != isMotherGP) {
                        // One is a rabbit, the other is a guinea pig
                        showDialog(
                          context: context,
                          builder: (ctx) => AlertDialog(
                            title: const Text('Tsy mety ny fampivadiana'),
                            content: const Text('Tsy afaka miteraka ny Bitro sy ny Bitro Voalavo (Cochon d\'Inde). Samy hafa karazana izy ireo.'),
                            actions: [
                              TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('OK')),
                            ],
                          ),
                        );
                        return;
                      }

                      Navigator.pop(ctx);
                      final prediction = _predictCrossbreeding(father, mother);
                      
                      showDialog(
                        context: context,
                        builder: (ctx) => AlertDialog(
                          title: const Text('Vokatra Vinavinaina'),
                          content: Column(
                            mainAxisSize: MainAxisSize.min,
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text('Ray: ${father['name']}'),
                              Text('Reny: ${mother['name']}'),
                              const Divider(),
                              Text('Taranaka: ${_generateCrossName(father['name'], mother['name'])}'),
                              const SizedBox(height: 10),
                              Text('Karazana: ${prediction['predictedType']}'),
                              Text('Fiterahana: ~${prediction['predictedLitters']}/taona'),
                              Text('Lanja: ~${prediction['predictedWeight']} kg'),
                              Text('Heterosis: ${prediction['heterosis']}'),
                            ],
                          ),
                          actions: [
                            TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('OK')),
                          ],
                        ),
                      );
                    }
                  },
                  child: const Text('Kajiana ny vokatra'),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    List<Map<String, dynamic>> filteredBreeds = _breeds.where((b) {
      final matchesSearch = b['name'].toString().toLowerCase().contains(_searchQuery.toLowerCase());
      final matchesType = _filterType == 'Rehetra' || b['type'] == _filterType;
      return matchesSearch && matchesType;
    }).toList();

    return Column(
      children: [
        // Header Stats
        Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: const BorderRadius.vertical(bottom: Radius.circular(24)),
            boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 10, offset: const Offset(0, 4))],
          ),
          child: Row(
            children: [
              Expanded(
                child: _buildStatCard(
                  label: 'Races',
                  value: '${_breeds.length}',
                  icon: Icons.category,
                  color: AppColors.primary,
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: _buildStatCard(
                  label: 'Bitro',
                  value: '${_rabbits.length}',
                  icon: Icons.pets,
                  color: AppColors.accent,
                ),
              ),
            ],
          ),
        ),
        
        // Tab Bar
        Container(
          margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
          decoration: BoxDecoration(
            color: AppColors.background,
            borderRadius: BorderRadius.circular(12),
          ),
          child: TabBar(
            controller: _tabController,
            labelColor: Colors.white,
            unselectedLabelColor: AppColors.textSecondary,
            indicator: BoxDecoration(
              gradient: const LinearGradient(colors: [AppColors.gradientStart, AppColors.gradientEnd]),
              borderRadius: BorderRadius.circular(10),
            ),
            indicatorSize: TabBarIndicatorSize.tab,
            tabs: const [
              Tab(text: '🧬 Races'),
              Tab(text: '🐇 Bitro'),
              Tab(text: '🧬 Pedigree'),
            ],
          ),
        ),
        
        // Tab Content
        Expanded(
          child: TabBarView(
            controller: _tabController,
            children: [
              // TAB 1: Races Database
              _buildRacesTab(filteredBreeds),
              
              // TAB 2: Individual Rabbits
              _buildRabbitsTab(),
              
              // TAB 3: Pedigree & Crossbreeding
              _buildPedigreeTab(),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildStatCard({required String label, required String value, required IconData icon, required Color color}) {
    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: color.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: color.withValues(alpha: 0.2)),
      ),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(8)),
            child: Icon(icon, color: color, size: 20),
          ),
          const SizedBox(width: 12),
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(value, style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: color)),
              Text(label, style: TextStyle(fontSize: 12, color: color.withValues(alpha: 0.8))),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildRacesTab(List<Map<String, dynamic>> filteredBreeds) {
    return Column(
      children: [
        // Search & Filter
        Padding(
          padding: const EdgeInsets.symmetric(horizontal: 16),
          child: Row(
            children: [
              Expanded(
                child: TextField(
                  decoration: InputDecoration(
                    hintText: 'Hikaroka races...',
                    prefixIcon: const Icon(Icons.search),
                    filled: true,
                    fillColor: Colors.white,
                    border: OutlineInputBorder(borderRadius: BorderRadius.circular(12), borderSide: BorderSide.none),
                  ),
                  onChanged: (v) => setState(() => _searchQuery = v),
                ),
              ),
              const SizedBox(width: 12),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 12),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                ),
                child: DropdownButton<String>(
                  value: _filterType,
                  underline: const SizedBox(),
                  items: ['Rehetra', 'Chair', 'Fourrure', 'Mixte', 'Ornement']
                      .map((t) => DropdownMenuItem(value: t, child: Text(t)))
                      .toList(),
                  onChanged: (v) => setState(() => _filterType = v!),
                ),
              ),
            ],
          ),
        ),
        
        // Breeds List
        Expanded(
          child: ListView.builder(
            padding: const EdgeInsets.all(16),
            itemCount: filteredBreeds.length,
            itemBuilder: (ctx, i) {
              final breed = filteredBreeds[i];
              final typeColor = breed['type'] == 'Chair' ? Colors.red
                  : breed['type'] == 'Fourrure' ? Colors.purple
                  : breed['type'] == 'Ornement' ? Colors.orange
                  : AppColors.primary;
              
              return Container(
                margin: const EdgeInsets.only(bottom: 10),
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(14),
                  boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.08), blurRadius: 10)],
                ),
                child: Row(
                  children: [
                    Container(
                      width: 50,
                      height: 50,
                      decoration: BoxDecoration(
                        color: typeColor.withValues(alpha: 0.15),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Center(child: Text(_getBreedEmoji(breed['type']), style: const TextStyle(fontSize: 24))),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(breed['name'], style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 15)),
                          Row(
                            children: [
                              Container(
                                padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                                decoration: BoxDecoration(
                                  color: typeColor.withValues(alpha: 0.15),
                                  borderRadius: BorderRadius.circular(4),
                                ),
                                child: Text(breed['type'], style: TextStyle(color: typeColor, fontSize: 10, fontWeight: FontWeight.bold)),
                              ),
                              const SizedBox(width: 6),
                              Text('📍 ${breed['origin']}', style: const TextStyle(fontSize: 11, color: AppColors.textSecondary)),
                            ],
                          ),
                          const SizedBox(height: 4),
                          Text(
                            '👶 ${breed['littersPerYear']}/taona  •  ⚖️ ${breed['weight']}kg  •  🎨 ${breed['color'] ?? '-'}',
                            style: const TextStyle(fontSize: 11),
                          ),
                        ],
                      ),
                    ),
                    IconButton(
                      icon: const Icon(Icons.delete_outline, color: Colors.grey, size: 20),
                      onPressed: () {
                        // Only allow deleting if not predefined? Or just allow it.
                        // For now, let's allow it.
                        setState(() {
                          _breeds.removeWhere((b) => b['id'] == breed['id']);
                          _saveData();
                        });
                      },
                    ),
                  ],
                ),
              );
            },
          ),
        ),
        
        // Add Breed Button
        Padding(
          padding: const EdgeInsets.all(16),
          child: SizedBox(
            width: double.infinity,
            child: ElevatedButton.icon(
              onPressed: () {
                // Add custom breed dialog
                _showAddBreedDialog();
              },
              icon: const Icon(Icons.add),
              label: const Text('Hanampy Race Vaovao'),
            ),
          ),
        ),
      ],
    );
  }

  void _showAddBreedDialog() {
    final nameCtrl = TextEditingController();
    final originCtrl = TextEditingController();
    String type = 'Chair';
    final weightCtrl = TextEditingController();
    final colorCtrl = TextEditingController();
    final littersCtrl = TextEditingController();

    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        title: const Text('Hanampy Race Vaovao'),
        content: SingleChildScrollView(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              TextField(controller: nameCtrl, decoration: const InputDecoration(labelText: 'Anarana')),
              TextField(controller: originCtrl, decoration: const InputDecoration(labelText: 'Fiaviana')),
              DropdownButtonFormField<String>(
                initialValue: type,
                items: ['Chair', 'Fourrure', 'Mixte', 'Ornement'].map((t) => DropdownMenuItem(value: t, child: Text(t))).toList(),
                onChanged: (v) => type = v!,
                decoration: const InputDecoration(labelText: 'Karazana'),
              ),
              TextField(controller: weightCtrl, decoration: const InputDecoration(labelText: 'Lanja (kg)'), keyboardType: TextInputType.number),
              TextField(controller: colorCtrl, decoration: const InputDecoration(labelText: 'Loko')),
              TextField(controller: littersCtrl, decoration: const InputDecoration(labelText: 'Fiterahana isan-taona'), keyboardType: TextInputType.number),
            ],
          ),
        ),
        actions: [
          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Hanafoana')),
          ElevatedButton(
            onPressed: () {
              if (nameCtrl.text.isNotEmpty) {
                setState(() {
                  _breeds.add({
                    'id': 'breed_${DateTime.now().millisecondsSinceEpoch}',
                    'name': nameCtrl.text,
                    'origin': originCtrl.text,
                    'type': type,
                    'weight': double.tryParse(weightCtrl.text) ?? 0.0,
                    'color': colorCtrl.text,
                    'littersPerYear': int.tryParse(littersCtrl.text) ?? 4,
                  });
                  _saveData();
                });
                Navigator.pop(ctx);
              }
            },
            child: const Text('Hampiditra'),
          ),
        ],
      ),
    );
  }

  String _getBreedEmoji(String type) {
    switch (type) {
      case 'Chair': return '🐇';
      case 'Fourrure': return '🐇';
      case 'Ornement': return '🐰';
      case 'Mixte': return '🐇';
      default: return '🐇';
    }
  }

  Widget _buildRabbitsTab() {
    return Column(
      children: [
        Expanded(
          child: _rabbits.isEmpty
              ? Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      const Text('🐇', style: TextStyle(fontSize: 60)),
                      const SizedBox(height: 12),
                      const Text('Tsy misy bitro voasoratra', style: TextStyle(color: AppColors.textSecondary)),
                      const SizedBox(height: 16),
                      ElevatedButton.icon(
                        onPressed: _addRabbit,
                        icon: const Icon(Icons.add),
                        label: const Text('Hanampy bitro voalohany'),
                      ),
                    ],
                  ),
                )
              : ListView.builder(
                  padding: const EdgeInsets.all(16),
                  itemCount: _rabbits.length,
                  itemBuilder: (ctx, i) {
                    final rabbit = _rabbits[i];
                    return Container(
                      margin: const EdgeInsets.only(bottom: 10),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(14),
                        boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.08), blurRadius: 10)],
                      ),
                      child: ListTile(
                        leading: Container(
                          width: 45,
                          height: 45,
                          decoration: BoxDecoration(
                            color: rabbit['sex'] == 'Lahy' ? Colors.blue.shade50 : Colors.pink.shade50,
                            borderRadius: BorderRadius.circular(10),
                          ),
                          child: Center(
                            child: Text(rabbit['sex'] == 'Lahy' ? '🐇' : '🐇', style: const TextStyle(fontSize: 22)),
                          ),
                        ),
                        title: Text(rabbit['name'], style: const TextStyle(fontWeight: FontWeight.bold)),
                        subtitle: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text('${rabbit['breedName']} • ID: ${rabbit['bandId']}'),
                            Text('Taranaka F${rabbit['generation']} • ${rabbit['birthDate']}', 
                                style: const TextStyle(fontSize: 11, color: AppColors.textSecondary)),
                          ],
                        ),
                        trailing: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            IconButton(
                              icon: const Icon(Icons.account_tree, color: AppColors.info),
                              onPressed: () => _showPedigreeTree(rabbit),
                              tooltip: 'Pedigree',
                            ),
                            IconButton(
                              icon: const Icon(Icons.delete_outline, color: AppColors.error),
                              onPressed: () {
                                setState(() {
                                  _rabbits.removeAt(i);
                                  _saveData();
                                });
                              },
                            ),
                          ],
                        ),
                      ),
                    );
                  },
                ),
        ),
        Padding(
          padding: const EdgeInsets.all(16),
          child: SizedBox(
            width: double.infinity,
            child: ElevatedButton.icon(
              onPressed: _addRabbit,
              icon: const Icon(Icons.add),
              label: const Text('Hanampy Bitro + Pedigree'),
              style: ElevatedButton.styleFrom(padding: const EdgeInsets.symmetric(vertical: 14)),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildPedigreeTab() {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Simulation Card
          Container(
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              gradient: const LinearGradient(colors: [AppColors.gradientStart, AppColors.gradientEnd]),
              borderRadius: BorderRadius.circular(20),
              boxShadow: [BoxShadow(color: AppColors.primary.withValues(alpha: 0.3), blurRadius: 12, offset: const Offset(0, 6))],
            ),
            child: Column(
              children: [
                const Row(
                  children: [
                    Icon(Icons.science, color: Colors.white, size: 28),
                    SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text('Simulateur de Croisement', style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                          Text('Vinavina ny taranaka ho avy', style: TextStyle(color: Colors.white70, fontSize: 12)),
                        ],
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 20),
                ElevatedButton(
                  onPressed: _simulateCrossbreeding,
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.white,
                    foregroundColor: AppColors.primary,
                    padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                  ),
                  child: const Text('Hanomboka Simulation'),
                ),
              ],
            ),
          ),
          const SizedBox(height: 24),
          
          const Text('Tantara & Firazanana', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
          const SizedBox(height: 12),
          
          // List of recent crosses or pedigree info could go here
          // For now, just a placeholder or list of rabbits with pedigree info
          ..._rabbits.where((r) => r['fatherId'] != null || r['motherId'] != null).map((rabbit) {
            return Card(
              margin: const EdgeInsets.only(bottom: 10),
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
              child: ListTile(
                leading: const Icon(Icons.account_tree, color: AppColors.primary),
                title: Text(rabbit['name']),
                subtitle: Text('Ray: ${_getRabbitName(rabbit['fatherId'])} • Reny: ${_getRabbitName(rabbit['motherId'])}'),
                onTap: () => _showPedigreeTree(rabbit),
              ),
            );
          }),
        ],
      ),
    );
  }

  String _getRabbitName(String? id) {
    if (id == null) return 'Tsy fantatra';
    final rabbit = _rabbits.firstWhere((r) => r['id'] == id, orElse: () => {'name': '?'});
    return rabbit['name'];
  }
}

class BitroGestationScreen extends StatefulWidget {
  const BitroGestationScreen({super.key});

  @override
  State<BitroGestationScreen> createState() => _BitroGestationScreenState();
}

class _BitroGestationScreenState extends State<BitroGestationScreen> {
  String _selectedType = 'Bitro';
  DateTime? _matingDate;
  
  final Map<String, Map<String, dynamic>> _gestationData = {
    'Bitro': {
      'emoji': '🐇',
      'gestationDays': 31,
      'babies': '4-12 zaza',
      'weaningDays': 28,
      'maturityMonths': 4,
      'breedingAge': '6 volana (vavy), 7 volana (lahy)',
      'littersPerYear': '4-6',
      'tips': [
        'Afaka miteraka 4-6 indray mandeha isan-taona ny vavy iray (32-72 zaza)',
        'Sarotra ny mahita vao bevohoka alohan\'ny 2 herinandro',
        'Aza manohina ny zaza 1 herinandro aorian\'ny fiterahana',
        'Mila toerana mangina ny reny',
      ],
      'signs': ['Misintona bozaka', 'Manao akany', 'Miova fomba', 'Mitombo lanja'],
    },
    'Bitro Voalavo': {
      'emoji': '🐹',
      'gestationDays': 68,
      'babies': '1-6 zaza',
      'weaningDays': 21,
      'maturityMonths': 2,
      'breedingAge': '3 volana (vavy), 3 volana (lahy)',
      'littersPerYear': '2-3',
      'tips': [
        'Manana fiterahana lava indrindra amin\'ny biby mampinono kely',
        'Ny zaza teraka dia efa misy volo sy maso misokatra',
        'Afaka mihinana sakafo mafy ao anatin\'ny andro vitsivitsy',
        'Aza mampisaraka ny reny sy zaza alohan\'ny 3 herinandro',
      ],
      'signs': ['Mitombo lanja haingana', 'Kibo lehibe miharihary', 'Mitaky sakafo bebe kokoa'],
    },
  };

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
          colors: [
            AppColors.primary.withValues(alpha: 0.1),
            AppColors.primaryLight.withValues(alpha: 0.05),
          ],
        ),
      ),
      child: _buildGestationTab(),
    );
  }

  Widget _buildGestationTab() {
    final data = _gestationData[_selectedType]!;
    final gestationDays = data['gestationDays'] as int;
    DateTime? dueDate;
    int? daysRemaining;
    
    if (_matingDate != null) {
      dueDate = _matingDate!.add(Duration(days: gestationDays));
      daysRemaining = dueDate.difference(DateTime.now()).inDays;
    }
    
    return SingleChildScrollView(
      padding: const EdgeInsets.all(20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Type selector
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white.withValues(alpha: 0.9),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text(
                  'Karazana Bitro 🐇',
                  style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: AppColors.primaryDark),
                ),
                const SizedBox(height: 12),
                Wrap(
                  spacing: 10,
                  runSpacing: 10,
                  children: _gestationData.keys.map((type) {
                    final isSelected = _selectedType == type;
                    final typeData = _gestationData[type]!;
                    return GestureDetector(
                      onTap: () => setState(() {
                        _selectedType = type;
                        _matingDate = null;
                      }),
                      child: Container(
                        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                        decoration: BoxDecoration(
                          color: isSelected ? AppColors.primary : Colors.grey[100],
                          borderRadius: BorderRadius.circular(20),
                          border: Border.all(color: isSelected ? AppColors.primaryDark : Colors.grey[300]!),
                        ),
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Text(typeData['emoji'] as String, style: const TextStyle(fontSize: 20)),
                            const SizedBox(width: 8),
                            Text(type, style: TextStyle(color: isSelected ? Colors.white : Colors.black87, fontWeight: FontWeight.w600)),
                          ],
                        ),
                      ),
                    );
                  }).toList(),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Gestation info
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(20),
            decoration: BoxDecoration(
              gradient: const LinearGradient(colors: [AppColors.primary, AppColors.primaryDark]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Column(
              children: [
                Text('${data['emoji']} Fotoana fiterahana', style: const TextStyle(color: Colors.white70, fontSize: 16)),
                const SizedBox(height: 8),
                Text('$gestationDays andro', style: const TextStyle(color: Colors.white, fontSize: 48, fontWeight: FontWeight.bold)),
                Text('👶 ${data['babies']}', style: const TextStyle(color: Colors.white70, fontSize: 18)),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Due date calculator
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white.withValues(alpha: 0.9),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('📅 Kajy fotoana hiterahana', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: AppColors.primaryDark)),
                const SizedBox(height: 16),
                InkWell(
                  onTap: () async {
                    final date = await showDatePicker(
                      context: context,
                      initialDate: DateTime.now(),
                      firstDate: DateTime.now().subtract(const Duration(days: 70)),
                      lastDate: DateTime.now(),
                      builder: (context, child) {
                        return Theme(data: Theme.of(context).copyWith(colorScheme: const ColorScheme.light(primary: AppColors.primary)), child: child!);
                      },
                    );
                    if (date != null) setState(() => _matingDate = date);
                  },
                  child: Container(
                    width: double.infinity,
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(border: Border.all(color: AppColors.primary), borderRadius: BorderRadius.circular(12)),
                    child: Row(
                      children: [
                        Icon(Icons.calendar_today, color: AppColors.primary),
                        const SizedBox(width: 12),
                        Text(
                          _matingDate != null ? 'Fampanarahana: ${DateFormat('dd/MM/yyyy').format(_matingDate!)}' : 'Safidio ny daty fampanarahana',
                          style: TextStyle(color: _matingDate != null ? Colors.black87 : Colors.grey),
                        ),
                      ],
                    ),
                  ),
                ),
                if (dueDate != null) ...[
                  const SizedBox(height: 20),
                  Container(
                    width: double.infinity,
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: daysRemaining! <= 7 ? Colors.red[50] : Colors.green[50],
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: daysRemaining <= 7 ? Colors.red[200]! : Colors.green[200]!),
                    ),
                    child: Column(
                      children: [
                        Text(daysRemaining <= 0 ? '🎉 Tokony ho teraka izao!' : '🐣 Hiteraka amin\'ny:', style: const TextStyle(fontSize: 16)),
                        const SizedBox(height: 8),
                        Text(DateFormat('dd MMMM yyyy').format(dueDate), style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: daysRemaining <= 7 ? Colors.red : AppColors.primaryDark)),
                        if (daysRemaining > 0) Text('($daysRemaining andro sisa)', style: TextStyle(color: Colors.grey[600])),
                      ],
                    ),
                  ),
                ],
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Breeding info
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(color: Colors.white.withValues(alpha: 0.9), borderRadius: BorderRadius.circular(16)),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('📊 Fampahalalana fiterahana', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: AppColors.primaryDark)),
                const SizedBox(height: 16),
                _buildInfoRow('🍼 Fanasarahana (sevrage)', '${data['weaningDays']} andro'),
                _buildInfoRow('📆 Taona azo ampakarina', data['breedingAge'] as String),
                _buildInfoRow('🔄 Zaza isan-taona', data['littersPerYear'] as String),
                _buildInfoRow('⏰ Fahamatorana', '${data['maturityMonths']} volana'),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Pregnancy signs
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(color: Colors.pink[50], borderRadius: BorderRadius.circular(16), border: Border.all(color: Colors.pink[200]!)),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('🤰 Famantarana bevohoka', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.pink)),
                const SizedBox(height: 12),
                Wrap(
                  spacing: 8,
                  runSpacing: 8,
                  children: (data['signs'] as List<String>).map((sign) => Container(
                    padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                    decoration: BoxDecoration(color: Colors.pink[100], borderRadius: BorderRadius.circular(20)),
                    child: Text(sign, style: TextStyle(color: Colors.pink[800])),
                  )).toList(),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Tips
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(color: Colors.amber[50], borderRadius: BorderRadius.circular(16), border: Border.all(color: Colors.amber[200]!)),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(children: [const Text('💡', style: TextStyle(fontSize: 20)), const SizedBox(width: 8), const Expanded(child: Text('Torohevitra', style: TextStyle(fontWeight: FontWeight.bold, color: Colors.brown)))]),
                const SizedBox(height: 12),
                ...(data['tips'] as List<String>).map((tip) => Padding(
                  padding: const EdgeInsets.only(bottom: 8),
                  child: Row(crossAxisAlignment: CrossAxisAlignment.start, children: [const Text('• ', style: TextStyle(color: Colors.brown)), Expanded(child: Text(tip, style: const TextStyle(color: Colors.brown)))]),
                )),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Expanded(child: Text(label, style: const TextStyle(color: Colors.black54), overflow: TextOverflow.ellipsis)),
          const SizedBox(width: 12),
          Expanded(child: Text(value, style: const TextStyle(fontWeight: FontWeight.w600), textAlign: TextAlign.right, overflow: TextOverflow.ellipsis, maxLines: 2)),
        ],
      ),
    );
  }
}


// --- KISOATECH SCREENS ---

class KisoaHousingScreen extends StatefulWidget {
  const KisoaHousingScreen({super.key});

  @override
  State<KisoaHousingScreen> createState() => _KisoaHousingScreenState();
}

class _KisoaHousingScreenState extends State<KisoaHousingScreen> {
  String _type = 'Kisoa Hena (Charcutier)';
  final TextEditingController _countController = TextEditingController(text: '10');
  String _result = '';
  double _suggestedArea = 0;
  bool _showFloorPlan = false;

  void _calculate() {
    int count = int.tryParse(_countController.text) ?? 0;
    double area = 0;
    String details = '';

    setState(() {
      if (_type == 'Kisoa Hena (Charcutier)') {
        // 1.2 m² par porc à l'engraissement
        area = count * 1.2;
        details = '• Hakitroka: 1.2 m²/kisoa\n• Ilaina: Fitoeran-tsakafo (Auge) 30cm/kisoa\n• Rano: Pipette na Bol';
      } else if (_type == 'Renin-kisoa (Truie)') {
        // 2.5 m² par truie en groupe, ou logette
        area = count * 2.5;
        details = '• Hakitroka: 2.5 m²/reniny\n• Box fiterahana: 2.2m x 1.8m isaky ny reniny\n• Ilaina: Fiarovana kisoa kely (Barre anti-écrasement)';
      } else if (_type == 'Kisoa Kely (Post-sevrage)') {
        // 0.4 m² par porcelet
        area = count * 0.4;
        details = '• Hakitroka: 0.4 m²/kisoa kely\n• Hafanana: 26-28°C (Tena ilaina)\n• Lafika: Mololo na Copeaux madio';
      } else {
        // Verrat (Lahy)
        area = count * 6.0;
        details = '• Hakitroka: 6 m²/lahy\n• Box mitokana sy mafy\n• Tokotany kely hivoahana';
      }

      _result = 'Velarana ilaina: ${area.toStringAsFixed(2)} m²\n\n'
          'Fitaovana:\n$details\n\n'
          '💡 Torohevitra: Ataovy misolampy 3% ny tany mba hivoahan\'ny maloto sy rano.';
      _suggestedArea = area;
    });
  }

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          _buildCard(
            title: 'Kajy Trano Kisoa',
            icon: Icons.calculate,
            child: Column(
              children: [
                DropdownButtonFormField<String>(
                  key: ValueKey(_type),
                  initialValue: _type,
                  items: ['Kisoa Hena (Charcutier)', 'Renin-kisoa (Truie)', 'Kisoa Kely (Post-sevrage)', 'Lahy (Verrat)']
                      .map((t) => DropdownMenuItem(value: t, child: Text(t))).toList(),
                  onChanged: (v) => setState(() => _type = v!),
                  decoration: const InputDecoration(labelText: 'Karazana Fiompiana'),
                ),
                const SizedBox(height: 12),
                TextField(
                  controller: _countController,
                  keyboardType: TextInputType.number,
                  decoration: const InputDecoration(labelText: 'Isan\'ny Kisoa', prefixIcon: Icon(Icons.numbers)),
                ),
                const SizedBox(height: 16),
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton.icon(
                    onPressed: _calculate,
                    icon: const Icon(Icons.build),
                    label: const Text('KAJY VELARANA'),
                    style: ElevatedButton.styleFrom(backgroundColor: Colors.pink, foregroundColor: Colors.white),
                  ),
                ),
              ],
            ),
          ),
          if (_result.isNotEmpty)
            _buildCard(
              title: 'Vokatra',
              icon: Icons.check_circle,
              child: Container(
                width: double.infinity,
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.pink.shade50,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(color: Colors.pink.shade200),
                ),
                child: Text(_result, style: const TextStyle(fontSize: 16, height: 1.5)),
              ),
            ),
          _buildCard(
            title: 'Modely Trano',
            icon: Icons.home,
            child: Column(
              children: [
                _buildHouseType('Trano Simenitra (Classique)', 'Mora diovina, mateza, fa mila lafika tsara mba tsy hangatsiaka.', Icons.foundation),
                _buildHouseType('Lafika Lalina (Litière Profonde)', 'Tsy maimbo, manome zezika, kely ny rano lany. Mila "Balle de riz" na "Copeaux" betsaka.', Icons.layers),
                _buildHouseType('Trano Hazo (Nentim-paharazana)', 'Moraamboarina, fa sarotra diovina. Tandremo ny kisoa tsy hihinana ny hazo.', Icons.cabin),
                const SizedBox(height: 16),
                const Divider(),
                const SizedBox(height: 8),
                // Plan 2D Blueprint
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Expanded(
                      child: Row(
                        children: [
                          const Icon(Icons.architecture, color: Colors.pink, size: 20),
                          const SizedBox(width: 8),
                          Flexible(
                            child: Text('Plan 2D (Blueprint)', style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14), overflow: TextOverflow.ellipsis),
                          ),
                        ],
                      ),
                    ),
                    Switch(
                      value: _showFloorPlan,
                      onChanged: (val) => setState(() => _showFloorPlan = val),
                      activeTrackColor: Colors.pink.withValues(alpha: 0.5),
                      thumbColor: WidgetStateProperty.resolveWith((states) => states.contains(WidgetState.selected) ? Colors.pink : Colors.grey),
                    ),
                  ],
                ),
                if (_showFloorPlan) ...[
                  const SizedBox(height: 10),
                  Container(
                    height: 320,
                    width: double.infinity,
                    decoration: BoxDecoration(
                      color: const Color(0xFF1565C0), // Blueprint blue
                      border: Border.all(color: Colors.white, width: 2),
                      borderRadius: BorderRadius.circular(8),
                      boxShadow: [
                        BoxShadow(
                          color: Colors.black26,
                          blurRadius: 8,
                          offset: const Offset(0, 4),
                        ),
                      ],
                    ),
                    child: CustomPaint(
                      painter: PiggeryFloorPlanPainter(
                        area: _suggestedArea,
                        pigType: _type,
                        pigCount: int.tryParse(_countController.text) ?? 0,
                      ),
                    ),
                  ),
                  const SizedBox(height: 8),
                  const Center(
                    child: Text(
                      '🗺️ Plan architectural - Porcherie moderne (CAD style)',
                      style: TextStyle(color: Colors.grey, fontSize: 11),
                    ),
                  ),
                ],
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildHouseType(String title, String desc, IconData icon) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(10),
            decoration: BoxDecoration(color: Colors.pink.shade50, borderRadius: BorderRadius.circular(10)),
            child: Icon(icon, color: Colors.pink),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title, style: const TextStyle(fontWeight: FontWeight.bold)),
                Text(desc, style: TextStyle(fontSize: 12, color: Colors.grey.shade700)),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCard({required String title, required Widget child, IconData? icon}) {
    return Card(
      margin: const EdgeInsets.only(bottom: 16),
      elevation: 2,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                if (icon != null) ...[
                  Icon(icon, color: Colors.pink),
                  const SizedBox(width: 8),
                ],
                Text(title, style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
              ],
            ),
            const SizedBox(height: 12),
            child,
          ],
        ),
      ),
    );
  }
}

class KisoaFeedScreen extends StatefulWidget {
  const KisoaFeedScreen({super.key});

  @override
  State<KisoaFeedScreen> createState() => _KisoaFeedScreenState();
}

class _KisoaFeedScreenState extends State<KisoaFeedScreen> {
  String _stage = 'Démarrage (10-25kg)';
  
  final Map<String, Map<String, dynamic>> _feedData = {
    'Démarrage (10-25kg)': {
      'ration': '0.5 - 1.0 kg/andro',
      'protein': '18-20%',
      'formula': '• Katsaka: 50%\n• Tourteau Soja: 25%\n• Son de Blé: 15%\n• Farine Poisson: 5%\n• CMV: 5%',
      'tips': 'Omena sakafo in-3 na in-4 isan\'andro. Rano madio tsy tapaka.',
    },
    'Croissance (25-50kg)': {
      'ration': '1.0 - 2.0 kg/andro',
      'protein': '16-18%',
      'formula': '• Katsaka: 55%\n• Tourteau Soja: 20%\n• Son de Blé: 20%\n• CMV: 5%',
      'tips': 'Azo ampiana mangahazo na vomanga masaka ho solon\'ny katsaka sasany.',
    },
    'Finition (50-100kg)': {
      'ration': '2.0 - 3.0 kg/andro',
      'protein': '14-16%',
      'formula': '• Katsaka: 60%\n• Tourteau Soja: 15%\n• Son de Blé: 20%\n• CMV: 5%',
      'tips': 'Tandremo tsy ho matavy loatra (Gras). Ahena ny katsaka raha be tavy.',
    },
    'Renin-kisoa (Gestante)': {
      'ration': '2.0 - 2.5 kg/andro',
      'protein': '14%',
      'formula': '• Katsaka: 50%\n• Son de Blé: 30%\n• Tourteau Soja: 15%\n• CMV: 5%',
      'tips': 'Aza omena be loatra sao sarotra miteraka. Omena anana sy legioma.',
    },
    'Renin-kisoa (Allaitante)': {
      'ration': 'Ad libitum (Araka izay laniny)',
      'protein': '16-18%',
      'formula': '• Katsaka: 55%\n• Tourteau Soja: 25%\n• Son de Blé: 15%\n• CMV: 5%',
      'tips': 'Mila rano be dia be hamokarana ronono (20-30 Litatra/andro).',
    },
  };

  @override
  Widget build(BuildContext context) {
    final data = _feedData[_stage]!;
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          _buildCard(
            title: 'Torolalana Sakafo',
            icon: Icons.restaurant_menu,
            child: Column(
              children: [
                DropdownButtonFormField<String>(
                  key: ValueKey(_stage),
                  initialValue: _stage,
                  isExpanded: true,
                  items: _feedData.keys.map((s) => DropdownMenuItem(value: s, child: Text(s))).toList(),
                  onChanged: (v) => setState(() => _stage = v!),
                  decoration: const InputDecoration(labelText: 'Dingana (Stade)'),
                ),
                const SizedBox(height: 20),
                _buildInfoRow('🍽️ Fatra isan\'andro', data['ration']),
                _buildInfoRow('💪 Proteina ilaina', data['protein']),
                const Divider(),
                const Text('Fangaro (Formule 100kg):', style: TextStyle(fontWeight: FontWeight.bold, color: Colors.pink)),
                const SizedBox(height: 8),
                Container(
                  width: double.infinity,
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.pink.shade50,
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Text(data['formula'], style: const TextStyle(height: 1.5)),
                ),
                const SizedBox(height: 12),
                Row(
                  children: [
                    const Icon(Icons.lightbulb, color: Colors.amber),
                    const SizedBox(width: 8),
                    Expanded(child: Text(data['tips'], style: const TextStyle(fontStyle: FontStyle.italic, fontSize: 12))),
                  ],
                ),
              ],
            ),
          ),
          _buildCard(
            title: 'Sakafo Voajanahary (Alternatif)',
            icon: Icons.eco,
            child: Column(
              children: [
                _buildAltFood('Mangahazo', 'Loharano angovo (Energie). Tetehina ary mainina na andrahoina mba hiala ny poizina (Cyanure).'),
                _buildAltFood('Vomanga', 'Tsara ho an\'ny kisoa, indrindra ny raviny (Proteina).'),
                _buildAltFood('Akondro/Taho', 'Omena ho fanampin-tsakafo, misy potasioma sy rano.'),
                _buildAltFood('Papay', 'Ny voany dia ody kankana voajanahary. Ny nofony dia vitamina.'),
                _buildAltFood('Drêche de Bière', 'Sisa amin\'ny labiera. Mora vidy ary be proteina. Omena 20-30% amin\'ny sakafo.'),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 10),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Expanded(child: Text(label, style: const TextStyle(color: Colors.grey))),
          const SizedBox(width: 8),
          Expanded(child: Text(value, style: const TextStyle(fontWeight: FontWeight.bold), textAlign: TextAlign.right)),
        ],
      ),
    );
  }

  Widget _buildAltFood(String name, String desc) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 10),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Icon(Icons.check, size: 16, color: Colors.green),
          const SizedBox(width: 8),
          Expanded(
            child: RichText(
              text: TextSpan(
                style: const TextStyle(color: Colors.black87),
                children: [
                  TextSpan(text: '$name: ', style: const TextStyle(fontWeight: FontWeight.bold)),
                  TextSpan(text: desc),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }
}

class KisoaHealthScreen extends StatefulWidget {
  const KisoaHealthScreen({super.key});

  @override
  State<KisoaHealthScreen> createState() => _KisoaHealthScreenState();
}

class _KisoaHealthScreenState extends State<KisoaHealthScreen> with SingleTickerProviderStateMixin {
  late TabController _tabController;
  DateTime? _startDate;
  List<Map<String, String>> _schedule = [];
  String _type = 'Kisoa Hena';

  // Liste des maladies porcines
  final List<Map<String, String>> _diseases = const [
    {
      'name': 'Peste Porcine Africaine (PPA)',
      'description': 'Aretina virus mahery vaika indrindra. Tsy misy fanafody na vaksiny. Mahafaty 100% ny kisoa.',
      'symptoms': '• Fanaviana mafy (41-42°C)\n• Mena ny hoditra (Oreilles, Ventre)\n• Mivalana rà\n• Mandeha sarotra, kivy be\n• Maty tampoka',
      'treatment': 'TSY MISY FANAFODY. Vonoy sy doroy ny kisoa marary rehetra.',
      'naturalRemedy': 'Tsy misy.',
      'actions': '• Ilazao avy hatrany ny Vétérinaire\n• Atokana ny trano\n• Dorana ny faty (tsy alevina)\n• Fanadiovana tanteraka',
      'prophylaxis': '• Biosecurity hentitra\n• Tsy omena sisan-tsakafo tsy nandrahoina\n• Fefy manodidina ny trano\n• Tsy ampidirina kisoa vaovao tsy quarantaine',
    },
    {
      'name': 'Peste Porcine Classique (PPC)',
      'description': 'Aretina virus mahery koa fa misy vaksiny. Miparitaka haingana.',
      'symptoms': '• Fanaviana 40-41°C\n• Mena ny hoditra\n• Mangovitra, tsy mahajoro\n• Mivalana, indraindray misy rà\n• Maso mivonto',
      'treatment': 'Tsy misy fanafody. Antibiotique hisorohana ny aretina hafa.',
      'naturalRemedy': 'Tsy misy.',
      'actions': '• Atokana ny marary\n• Ilazao ny Vétérinaire',
      'prophylaxis': '• Vaksiny PPC isaky ny 6 volana\n• Biosecurity',
    },
    {
      'name': 'Rouget (Erysipèle)',
      'description': 'Aretina bakteria (Erysipelothrix). Mety ho mafy na mitaiza. Azo sitranina.',
      'symptoms': '• Fanaviana mafy\n• Pentina diamant amin\'ny hoditra (Carrés rouges)\n• Tsy te-hitsangana\n• Vonton\'ny tonon-taolana (Arthrite)',
      'treatment': '• Pénicilline (Tena mahomby)\n• Amoxicilline\n• Tsindrona intelo isan\'andro, 3-5 andro',
      'naturalRemedy': '• Tongolo gasy (Fisorohana)\n• Fampangatsiahana ny vatana amin\'ny rano matimaty',
      'actions': '• Tsaboina avy hatrany\n• Atokana ny marary',
      'prophylaxis': '• Vaksiny Rouget isaky ny 6 volana\n• Fahadiovana',
    },
    {
      'name': 'Fivalanana (Diarrhée)',
      'description': 'Aretina mahazatra amin\'ny kisoa kely. Mety vokatry ny bakteria (E.coli, Salmonella) na virus.',
      'symptoms': '• Mivalana ranony na fotsy\n• Marary kibo\n• Reraka, tsy homana\n• Mihena haingana ny lanja',
      'treatment': '• Réhydratation (Rano + Sira + Siramamy)\n• Antibiotique (Colistine, Sulfamides)\n• Probiotique',
      'naturalRemedy': '• Rano nampangotrahina sy vary aron-tsira\n• Charbon de bois voatoto',
      'actions': '• Omena rano matetika\n• Diovina ny trano\n• Hafanaina ny kisoa kely',
      'prophylaxis': '• Fahadiovana\n• Hafanana (26-28°C ho an\'ny kely)\n• Tsindrona Fer J-3',
    },
    {
      'name': 'Pneumonie (Aretim-bavony)',
      'description': 'Fivontosana ny havokavoka, matetika vokatry ny hatsiaka na vovoka.',
      'symptoms': '• Mikohaka, mikorina\n• Miaina mafy (Sempo)\n• Fanaviana\n• Tsy te-homana\n• Mitombo miadana',
      'treatment': '• Antibiotique (Tylosine, Florfénicol, Tilmicosine)\n• Anti-inflammatoire',
      'naturalRemedy': '• Tantely sy tongolo gasy\n• Inhalation: fampanehana etona kininina',
      'actions': '• Hafanaina ny trano\n• Ahena ny vovoka',
      'prophylaxis': '• Ventilation tsara (tsy miditra rivotra mivantana)\n• Tsy atao mifanizina loatra',
    },
    {
      'name': 'Mange (Gale - Lagaly)',
      'description': 'Aretina hoditra vokatry ny Sarcoptes (katsentsitra). Tena manelingelina ny kisoa.',
      'symptoms': '• Mangidihidy mafy\n• Mihintsana ny volo\n• Hoditra matevina, misy kilema\n• Mikasokasoka hatrany\n• Mihena ny fitomboana',
      'treatment': '• Ivermectine (Tsindrona na Pour-on)\n• Averina afaka 14 andro',
      'naturalRemedy': '• Menaka coco sy soufre\n• Lavenona (Cendre) ahosotra',
      'actions': '• Tsaboina ny kisoa rehetra miaraka\n• Diovina ny trano',
      'prophylaxis': '• Ivermectine isan\'3 volana\n• Fahadiovana',
    },
    {
      'name': 'Kankana (Parasites internes)',
      'description': 'Katsentsitra anaty (Ascaris, Strongles) mihinana ny otrikaina. Tena mahazatra.',
      'symptoms': '• Mahia nefa homana\n• Kibo be (indrindra ny kely)\n• Volo tsy manganohano\n• Mivalana, indraindray misy kankana',
      'treatment': '• Vermifuge (Ivermectine, Lévamisole, Fenbendazole)\n• Averina isaky ny 2-3 volana',
      'naturalRemedy': '• Voan\'ny Papay (maina sy totoina)\n• Voatavo (voany)',
      'actions': '• Tsaboina ny rehetra\n• Diovina ny trano',
      'prophylaxis': '• Vermifuge ara-potoana\n• Fanadiovana tsy tapaka',
    },
    {
      'name': 'Anémie (Kisoa kely)',
      'description': 'Tsy fahampian-dry amin\'ny kisoa vao teraka. Mety hahafaty raha tsy tsaboina.',
      'symptoms': '• Hatsatra (Pâle) ny hoditra sy sofina\n• Reraka, tsy mazoto\n• Miaina mafy\n• Mitombo miadana',
      'treatment': '• Tsindrona Fer-Dextran 200mg (J-3)\n• Azo averina J-10 raha ilaina',
      'naturalRemedy': '• Tsy misy tena mahomby. Ny vy no ilaina.',
      'actions': '• Tsaboina avy hatrany',
      'prophylaxis': '• Tsindrona Fer isan-taranaka amin\'ny J-3',
    },
    {
      'name': 'Parvovirose (SMEDI)',
      'description': 'Aretina virus manimba ny vohoka. Tsy misy soritra amin\'ny reniny fa very ny zaza.',
      'symptoms': '• Tsy miteraka (Infertilité)\n• Misitrika ny zaza (Momification)\n• Teraka kisoa maty\n• Zaza kely marefo',
      'treatment': 'Tsy misy fanafody.',
      'naturalRemedy': 'Tsy misy.',
      'actions': '• Atokana ny marary\n• Andrasana 3 herinandro vao ampakarina indray',
      'prophylaxis': '• Vaksiny Parvovirose alohan\'ny fampakaram-bady voalohany\n• Rappel isan-taona',
    },
    {
      'name': 'Syndrome MMA',
      'description': 'Mastite-Métrite-Agalactie. Aretina mahazo ny reny vao niteraka. Tsy mamoaka ronono.',
      'symptoms': '• Tsy te-hampinono\n• Nonony mafana sy marary\n• Fanaviana\n• Mivalana',
      'treatment': '• Ocytocine (Hampidina ny ronono)\n• Antibiotique (Amoxicilline)\n• Anti-inflammatoire',
      'naturalRemedy': '• Fandriana ny nono amin\'ny rano mafana',
      'actions': '• Fahanana ny kisoa kely amin\'ny tanana na Allaitement artificiel',
      'prophylaxis': '• Sakafo tsy be tavy alohan\'ny fiterahana\n• Rano betsaka',
    },
  ];

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 3, vsync: this);
    _generateSchedule();
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  void _generateSchedule() {
    if (_startDate == null) return;
    List<Map<String, String>> list = [];
    
    if (_type == 'Kisoa Hena') {
      // Porcs à l'engraissement
      list.add({'day': 'J-0', 'act': '🐷 Fahatongavana - Anti-stress, Hafanana 28°C'});
      list.add({'day': 'J-3', 'act': '💉 Tsindrona Fer-Dextran 200mg'});
      list.add({'day': 'J-7', 'act': '💊 Vermifuge voalohany (Ivermectine)'});
      list.add({'day': 'J-21', 'act': '🍼 Fanasarahana (Sevrage) - Sakafo démarrage'});
      list.add({'day': 'J-28', 'act': '💉 Vaksiny PPC (Peste Classique)'});
      list.add({'day': 'J-35', 'act': '💉 Vaksiny Rouget'});
      list.add({'day': 'J-60', 'act': '💊 Vermifuge faharoa'});
      list.add({'day': 'J-90', 'act': '💊 Vermifuge fahatelo'});
      list.add({'day': 'J-120', 'act': '💊 Vermifuge + Fitsirihana lanja'});
      list.add({'day': 'J-150', 'act': '🥩 Vonjena (150-180 andro, >100kg)'});
    } else if (_type == 'Renin-kisoa') {
      // Truie reproductrice
      list.add({'day': 'J-0', 'act': '🐷 Fahatongavana - Quarantaine 30 andro'});
      list.add({'day': 'J-7', 'act': '💊 Vermifuge + Ivermectine (Lagaly)'});
      list.add({'day': 'J-14', 'act': '💉 Vaksiny Parvovirose + Rouget'});
      list.add({'day': 'J-30', 'act': '✅ Hiala quarantaine - Ampakarina'});
      list.add({'day': 'Alohan\'ny Fampakaram-bady', 'act': '💊 Vermifuge + Flushing (sakafo betsaka)'});
      list.add({'day': 'J-90 vohoka', 'act': '💉 Rappel Vaksiny + Ahena sakafo'});
      list.add({'day': 'J-110 vohoka', 'act': '💊 Vermifuge + Fanomanana box fiterahana'});
      list.add({'day': 'Andro fiterahana', 'act': '⚠️ Fitsirihana 24/24, Ocytocine raha ilaina'});
      list.add({'day': 'J-3 teraka', 'act': '💉 Fer ho an\'ny kisoa kely'});
      list.add({'day': 'Isak\'6 volana', 'act': '💉 Rappel Vaksiny (PPC, Rouget, Parvovirose)'});
    } else if (_type == 'Kisoa Kely') {
      // Porcelet - Soins jusqu'au sevrage
      list.add({'day': 'H-0', 'act': '🐽 Fiterahana - Famoahana ny ranon\'akanjo, Famahanana voalohany (Colostrum)'});
      list.add({'day': 'H-1', 'act': '🔥 Hafanana (Lampe 35°C) - Tena ilaina!'});
      list.add({'day': 'J-1', 'act': '✂️ Fanapahana tadim-poitra (1-2 sm) + Betadine'});
      list.add({'day': 'J-1', 'act': '🦷 Fanapahana nify (8 nify maranitra) - Tsy obligatoire'});
      list.add({'day': 'J-2', 'act': '✂️ Fanapahana rambo (3-4 sm) - Tsy obligatoire'});
      list.add({'day': 'J-3', 'act': '💉 Tsindrona Fer-Dextran 200mg (Tena zava-dehibe!)'});
      list.add({'day': 'J-3', 'act': '🔪 Castration (Lahy) - Raha tiana atao'});
      list.add({'day': 'J-7', 'act': '🍽️ Fanombohana pre-starter (Sakafo kely)'});
      list.add({'day': 'J-10', 'act': '💉 Fer faharoa (Raha ilaina, kisoa hatsatra)'});
      list.add({'day': 'J-14', 'act': '🍽️ Ampitomboina ny sakafo - Creep feeding'});
      list.add({'day': 'J-21', 'act': '🍼 SEVRAGE - Fisarahana amin\'ny reniny'});
      list.add({'day': 'J-21', 'act': '💊 Vermifuge voalohany'});
      list.add({'day': 'J-21', 'act': '🏠 Afindra amin\'ny trano post-sevrage (26-28°C)'});
    } else {
      // Verrat (Lahy)
      list.add({'day': 'J-0', 'act': '🐗 Fahatongavana - Quarantaine 30 andro'});
      list.add({'day': 'J-7', 'act': '💊 Vermifuge + Ivermectine'});
      list.add({'day': 'J-14', 'act': '💉 Vaksiny PPC + Rouget'});
      list.add({'day': 'J-30', 'act': '✅ Hiala quarantaine'});
      list.add({'day': 'Isak\'3 volana', 'act': '💊 Vermifuge ara-potoana'});
      list.add({'day': 'Isak\'6 volana', 'act': '💉 Rappel Vaksiny + Fitsirihana Tongotra'});
      list.add({'day': 'Isan\'andro', 'act': '🏃 Fanatanjahan-tena + Sakafo voafehy'});
    }

    setState(() {
      _schedule = list;
    });
  }

  Future<void> _selectDate(BuildContext context) async {
    final DateTime? picked = await showDatePicker(
      context: context, 
      initialDate: DateTime.now(), 
      firstDate: DateTime(2020), 
      lastDate: DateTime(2030),
    );
    if (picked != null) {
      setState(() {
        _startDate = picked;
      });
      _generateSchedule();
    }
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        TabBar(
          controller: _tabController,
          labelColor: Colors.pink,
          unselectedLabelColor: Colors.grey,
          tabs: const [
            Tab(text: 'Tetiandro'),
            Tab(text: 'Kisoa Kely'),
            Tab(text: 'Fahasalamana'),
          ],
        ),
        Expanded(
          child: TabBarView(
            controller: _tabController,
            children: [
              _buildScheduleTab(),
              _buildPigletCareTab(),
              _buildDiseaseTab(),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildScheduleTab() {
    return Column(
      children: [
        Padding(
          padding: const EdgeInsets.all(16.0),
          child: _buildCard(
            title: 'Tetiandro Fitsaboana Kisoa',
            icon: Icons.calendar_month,
            child: Column(
              children: [
                DropdownButtonFormField<String>(
                  key: ValueKey(_type),
                  initialValue: _type,
                  isExpanded: true,
                  items: ['Kisoa Hena', 'Kisoa Kely', 'Renin-kisoa', 'Lahy (Verrat)']
                      .map((v) => DropdownMenuItem(value: v, child: Text(v))).toList(),
                  onChanged: (v) => setState(() { _type = v!; _generateSchedule(); }),
                  decoration: const InputDecoration(labelText: 'Karazana Kisoa'),
                ),
                const SizedBox(height: 12),
                OutlinedButton.icon(
                  onPressed: () => _selectDate(context),
                  icon: const Icon(Icons.calendar_today, color: Colors.pink),
                  label: Text(
                    _startDate == null 
                        ? 'Safidio ny daty nahatongavana' 
                        : 'Daty: ${_startDate!.day}/${_startDate!.month}/${_startDate!.year}',
                    style: const TextStyle(color: Colors.pink),
                  ),
                ),
              ],
            ),
          ),
        ),
        Expanded(
          child: _schedule.isEmpty 
              ? const Center(child: Text('Safidio ny daty hahitana ny tetiandro', style: TextStyle(color: Colors.grey)))
              : ListView.builder(
                  itemCount: _schedule.length,
                  itemBuilder: (context, index) {
                    final item = _schedule[index];
                    // Calculate actual date if possible
                    String dateStr = '';
                    if (_startDate != null && item['day']!.startsWith('J-')) {
                      int daysToAdd = int.tryParse(item['day']!.replaceAll(RegExp(r'[^0-9]'), '')) ?? 0;
                      DateTime actDate = _startDate!.add(Duration(days: daysToAdd));
                      dateStr = '${actDate.day}/${actDate.month}/${actDate.year}';
                    }
                    
                    return Card(
                      margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
                      child: ListTile(
                        leading: CircleAvatar(
                          backgroundColor: Colors.pink,
                          child: Text(
                            item['day']!.length > 4 ? '📅' : item['day']!.substring(0, item['day']!.length > 3 ? 4 : item['day']!.length),
                            style: const TextStyle(color: Colors.white, fontSize: 10),
                          ),
                        ),
                        title: Text(item['act']!, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                        subtitle: Text(dateStr.isNotEmpty ? 'Daty: $dateStr' : item['day']!),
                      ),
                    );
                  },
                ),
        ),
      ],
    );
  }

  Widget _buildDiseaseTab() {
    return ListView.builder(
      padding: const EdgeInsets.all(16),
      itemCount: _diseases.length,
      itemBuilder: (context, index) {
        final d = _diseases[index];
        return Card(
          margin: const EdgeInsets.only(bottom: 10),
          child: ExpansionTile(
            leading: const Icon(Icons.medical_services, color: Colors.pink),
            title: Text(d['name']!, style: const TextStyle(fontWeight: FontWeight.bold)),
            children: [
              Padding(
                padding: const EdgeInsets.all(16.0),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _buildDetailRow('📖 Filazana:', d['description']!),
                    _buildDetailRow('🤒 Soritr\'aretina:', d['symptoms']!),
                    _buildDetailRow('💊 Fanafody (Veto):', d['treatment']!),
                    _buildDetailRow('🌿 Tambavy (Gasy):', d['naturalRemedy']!),
                    _buildDetailRow('⚡ Hetsika atao:', d['actions']!),
                    _buildDetailRow('🛡️ Fisorohana:', d['prophylaxis']!),
                  ],
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildPigletCareTab() {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          // Section: Soins à la naissance
          _buildCard(
            title: 'Fikarakarana Vao Teraka (H0 - J1)',
            icon: Icons.baby_changing_station,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                _buildCareStep('1', 'Famoahana ranon\'akanjo', 'Esory ny ranon\'akanjo amin\'ny vava sy orona. Famafazana amin\'ny lamba maina.', Colors.red),
                _buildCareStep('2', 'Fanapahana tadim-poitra', 'Tapaho 3-4 sm amin\'ny kibo. Ahosotra Betadine na Iodine.', Colors.orange),
                _buildCareStep('3', 'Famahanana Colostrum', 'Tena ilaina ao anatin\'ny 6 ora voalohany! Misy Anticorps fiarovana.', Colors.green),
                _buildCareStep('4', 'Hafanana', 'Lampe chauffante 35°C. Ahena 2°C isaky ny herinandro.', Colors.blue),
                const SizedBox(height: 12),
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.red.shade50,
                    borderRadius: BorderRadius.circular(12),
                    border: Border.all(color: Colors.red.shade200),
                  ),
                  child: const Row(
                    children: [
                      Icon(Icons.warning, color: Colors.red),
                      SizedBox(width: 12),
                      Expanded(
                        child: Text(
                          '⚠️ Raha tsy mahazo ronono ao anatin\'ny 24 ora, mety ho faty ny kisoa kely!',
                          style: TextStyle(color: Colors.red, fontWeight: FontWeight.bold),
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          
          // Section: Soins J1-J7
          _buildCard(
            title: 'Andro 1 - 7',
            icon: Icons.calendar_today,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                _buildDayTask('J-1', [
                  '✂️ Fanapahana nify (8 nify maranitra) - Optionnel',
                  '✂️ Fanapahana rambo (3-4 sm) - Optionnel',
                ]),
                _buildDayTask('J-3', [
                  '💉 Tsindrona Fer-Dextran 200mg (TENA ILAINA!)',
                  '🔪 Castration ho an\'ny lahy (Raha tiana)',
                ]),
                _buildDayTask('J-5 - J-7', [
                  '🍽️ Fanombohana pre-starter (Creep feeding)',
                  '🔍 Fitsirihana fivalanana sy fahasalamana',
                ]),
              ],
            ),
          ),

          // Section: Soins J7-J21
          _buildCard(
            title: 'Andro 7 - 21 (Alohan\'ny Sevrage)',
            icon: Icons.trending_up,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                _buildDayTask('J-7 - J-14', [
                  '🍽️ Ampitomboina ny sakafo starter',
                  '💧 Rano madio tsy tapaka',
                  '🌡️ Hafanana: 28-30°C',
                ]),
                _buildDayTask('J-10', [
                  '💉 Fer faharoa (Raha hatsatra ny kisoa)',
                ]),
                _buildDayTask('J-14 - J-21', [
                  '🍽️ Ampitomboina ny sakafo (80-100g/andro)',
                  '🏠 Fanomanana trano post-sevrage',
                ]),
              ],
            ),
          ),

          // Section: Sevrage
          _buildCard(
            title: 'Fanasarahana - SEVRAGE (J-21)',
            icon: Icons.home,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text(
                  'Ny fanasarahana dia fotoana sarotra. Mila fikarakarana manokana:',
                  style: TextStyle(fontStyle: FontStyle.italic, color: Colors.grey),
                ),
                const SizedBox(height: 16),
                _buildSevrageStep('🏠', 'Trano vaovao', 'Afindra amin\'ny trano post-sevrage. Hafanana 26-28°C.'),
                _buildSevrageStep('🍽️', 'Sakafo', 'Sakafo post-sevrage (18-20% Protéine). Omena in-4 isan\'andro.'),
                _buildSevrageStep('💧', 'Rano', 'Rano madio tsy tapaka. Ampio Vitamina sy Électrolytes.'),
                _buildSevrageStep('💊', 'Vermifuge', 'Vermifuge voalohany amin\'ny J-21.'),
                _buildSevrageStep('😰', 'Stress', 'Ahena ny stress: Tsy afindra + Tsy ampifangaroina kisoa hafa.'),
                const SizedBox(height: 16),
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.amber.shade50,
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Row(
                        children: [
                          Icon(Icons.lightbulb, color: Colors.amber),
                          SizedBox(width: 8),
                          Text('Lanja amin\'ny Sevrage', style: TextStyle(fontWeight: FontWeight.bold)),
                        ],
                      ),
                      const SizedBox(height: 8),
                      const Text('• Lanja tsara: 6-8 kg @ J-21'),
                      const Text('• Lanja marefo: < 5 kg (Mila fikarakarana manokana)'),
                    ],
                  ),
                ),
              ],
            ),
          ),

          // Section: Température
          _buildCard(
            title: 'Hafanana Ilaina (°C)',
            icon: Icons.thermostat,
            child: Column(
              children: [
                _buildTempRow('Vao teraka (H0)', '35°C', Colors.red),
                _buildTempRow('J-1 - J-7', '32-35°C', Colors.orange),
                _buildTempRow('J-7 - J-14', '28-32°C', Colors.amber),
                _buildTempRow('J-14 - J-21', '26-28°C', Colors.green),
                _buildTempRow('Post-sevrage', '24-26°C', Colors.blue),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCareStep(String num, String title, String desc, Color color) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          CircleAvatar(
            radius: 14,
            backgroundColor: color,
            child: Text(num, style: const TextStyle(color: Colors.white, fontSize: 12, fontWeight: FontWeight.bold)),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title, style: const TextStyle(fontWeight: FontWeight.bold)),
                Text(desc, style: TextStyle(fontSize: 12, color: Colors.grey.shade700)),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildDayTask(String day, List<String> tasks) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.pink.shade50,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(day, style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.pink)),
          const SizedBox(height: 8),
          ...tasks.map((task) => Padding(
            padding: const EdgeInsets.only(bottom: 4),
            child: Text(task, style: const TextStyle(fontSize: 13)),
          )),
        ],
      ),
    );
  }

  Widget _buildSevrageStep(String emoji, String title, String desc) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 10),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(emoji, style: const TextStyle(fontSize: 20)),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title, style: const TextStyle(fontWeight: FontWeight.bold)),
                Text(desc, style: TextStyle(fontSize: 12, color: Colors.grey.shade700)),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildTempRow(String period, String temp, Color color) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Row(
        children: [
          Container(
            width: 12,
            height: 12,
            decoration: BoxDecoration(color: color, shape: BoxShape.circle),
          ),
          const SizedBox(width: 12),
          Expanded(child: Text(period)),
          Text(temp, style: TextStyle(fontWeight: FontWeight.bold, color: color)),
        ],
      ),
    );
  }

  Widget _buildDetailRow(String label, String content) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12.0),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(label, style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.pink)),
          const SizedBox(height: 4),
          Text(content),
        ],
      ),
    );
  }
}

class KisoaGestationScreen extends StatefulWidget {
  const KisoaGestationScreen({super.key});

  @override
  State<KisoaGestationScreen> createState() => _KisoaGestationScreenState();
}

class _KisoaGestationScreenState extends State<KisoaGestationScreen> {
  DateTime? _matingDate;

  @override
  Widget build(BuildContext context) {
    DateTime? dueDate;
    int? daysRemaining;
    
    if (_matingDate != null) {
      // Gestation truie: 3 mois, 3 semaines, 3 jours = ~114 jours
      dueDate = _matingDate!.add(const Duration(days: 114));
      daysRemaining = dueDate.difference(DateTime.now()).inDays;
    }

    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          _buildCard(
            title: 'Kajy Fiterahana (3-3-3)',
            icon: Icons.calendar_month,
            child: Column(
              children: [
                const Text(
                  'Ny fotoana fitondrana vohoka ny kisoa dia 3 volana, 3 herinandro, 3 andro (114 andro).',
                  style: TextStyle(fontStyle: FontStyle.italic, color: Colors.grey),
                  textAlign: TextAlign.center,
                ),
                const SizedBox(height: 20),
                InkWell(
                  onTap: () async {
                    final date = await showDatePicker(
                      context: context,
                      initialDate: DateTime.now(),
                      firstDate: DateTime.now().subtract(const Duration(days: 120)),
                      lastDate: DateTime.now(),
                    );
                    if (date != null) setState(() => _matingDate = date);
                  },
                  child: Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      border: Border.all(color: Colors.pink),
                      borderRadius: BorderRadius.circular(12),
                      color: Colors.pink.shade50,
                    ),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(Icons.favorite, color: Colors.pink),
                        const SizedBox(width: 12),
                        Flexible(
                          child: Text(
                            _matingDate == null 
                                ? 'Safidio ny daty nampanarahana' 
                                : 'Daty: ${DateFormat('dd/MM/yyyy').format(_matingDate!)}',
                            style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.pink),
                            overflow: TextOverflow.ellipsis,
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
                if (dueDate != null) ...[
                  const SizedBox(height: 20),
                  Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: Colors.green.shade50,
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: Colors.green),
                    ),
                    child: Column(
                      children: [
                        const Text('Daty Hiterahana:', style: TextStyle(fontSize: 16)),
                        Text(
                          DateFormat('dd MMMM yyyy').format(dueDate),
                          style: const TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: Colors.green),
                        ),
                        Text(
                          daysRemaining! > 0 ? 'Mbola misy $daysRemaining andro' : 'Tokony ho teraka izao!',
                          style: TextStyle(color: daysRemaining > 0 ? Colors.grey : Colors.red, fontWeight: FontWeight.bold),
                        ),
                      ],
                    ),
                  ),
                ],
              ],
            ),
          ),
          _buildCard(
            title: 'Tsingerina (Cycle)',
            icon: Icons.loop,
            child: Column(
              children: [
                _buildCycleItem('Fahamatorana (Puberté)', '6-7 volana (Lanja > 100kg)'),
                _buildCycleItem('Hafanana (Chaleur)', 'Isaky ny 21 andro (Maharitra 2-3 andro)'),
                _buildCycleItem('Fampanarahana', 'Atao indroa: Maraina sy Hariva rehefa mijoro tsara (Reflexe d\'immobilité)'),
                _buildCycleItem('Fiterahana', 'Maharitra 2-4 ora. Elanelana 15-20 minitra isaky ny kisoa kely.'),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCycleItem(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 10),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Expanded(flex: 2, child: Text(label, style: const TextStyle(fontWeight: FontWeight.bold))),
          const SizedBox(width: 8),
          Expanded(flex: 3, child: Text(value, textAlign: TextAlign.right, style: const TextStyle(fontSize: 12))),
        ],
      ),
    );
  }
}

// ===========================================
// ========== MODULE FAMBOLENATECH ==========
// ===========================================

// --- FAMBOLENA CROPS SCREEN (Voly) ---
class FambolenaCropsScreen extends StatefulWidget {
  const FambolenaCropsScreen({super.key});

  @override
  State<FambolenaCropsScreen> createState() => _FambolenaCropsScreenState();
}

class _FambolenaCropsScreenState extends State<FambolenaCropsScreen> {
  String _selectedCrop = 'Vary';

  final Map<String, Map<String, dynamic>> _cropsData = {
    'Vary': {
      'emoji': '🌾',
      'name': 'Vary (Riz)',
      'season': 'Oktobra - Febroary',
      'duration': '120-180 andro',
      'climate': 'Tropical mafana sy mando',
      'spacing': '20x20 cm',
      'yield': '3-6 T/ha',
      'waterNeeds': 'Be loatra (Riziculture)',
      'plantingGuide': '1. Manomana tanimbary: asio rano ary aotory tsara.\n2. Mamafy voa amin\'ny pépinière (tanin-ketsa).\n3. Rehefa afaka 3-4 herinandro, afindra ny ketsa.\n4. Asio elanelana 20cm isaky ny ketsa.\n5. Ataovy anaty rano 5-10cm ny tany.',
      'steps': [
        {'week': 'H1-2', 'action': 'Fanamboarana tanimbary - Famafazana voa'},
        {'week': 'H3-4', 'action': 'Fanetsana - Fampidirana rano'},
        {'week': 'H5-8', 'action': 'Fandroahana - Fanaraha-maso bibikely'},
        {'week': 'H9-12', 'action': 'Famafazana zezika - Fitandremana aretina'},
        {'week': 'H13-16', 'action': 'Fisakafoanana - Fiandrasana fahamasahana'},
        {'week': 'H17-20', 'action': 'Fijinjana - Fanaingoana - Famolavolana'},
      ],
      'tips': [
        'Ilaina ny rano maharitra 5-10 cm hatramin\'ny fahamasahana',
        'Ny zezika azota dia ampiana 3 androany: fanetsana, 30 andro, 60 andro',
        'Fisorohana ny bibikely toy ny akoho sy vorona',
      ],
    },
    'Katsaka': {
      'emoji': '🌽',
      'name': 'Katsaka (Maïs)',
      'season': 'Oktobra - Desambra',
      'duration': '90-120 andro',
      'climate': 'Tropical - Mafana sy mando antonony',
      'spacing': '75x25 cm',
      'yield': '2-8 T/ha',
      'waterNeeds': 'Antonony',
      'plantingGuide': '1. Manaova lavaka kely 5cm ny halaliny.\n2. Asio elanelana 75cm isaky ny laharana ary 25cm isaky ny lavaka.\n3. Asio voa 2 na 3 isaky ny lavaka.\n4. Sarony tany kely ary tsindrio moramora.\n5. Tondrahy rano avy hatrany.',
      'steps': [
        {'week': 'H1', 'action': 'Fanamboarana tany - Famafazana 2-3 voa isaky ny lavaka'},
        {'week': 'H2-3', 'action': 'Fiposahana - Fikarakarana voalohany'},
        {'week': 'H4-6', 'action': 'Fandroahana - Zezika voalohany (NPK)'},
        {'week': 'H7-10', 'action': 'Fivoaran\'ny felana - Zezika azota faharoa'},
        {'week': 'H11-14', 'action': 'Famokarana - Fisakafoanana'},
        {'week': 'H15-17', 'action': 'Fijinjana rehefa maina ny tavom-boankazo'},
      ],
      'tips': [
        'Famafazana 2-3 voa isaky ny lavaka, 5 cm lalina',
        'Zezika NPK 15-15-15: 200 kg/ha rehefa mamafa',
        'Mila rano be rehefa mamoaka felana',
      ],
    },
    'Mangahazo': {
      'emoji': '🥔',
      'name': 'Mangahazo (Manioc)',
      'season': 'Oktobra - Novambra',
      'duration': '9-24 volana',
      'climate': 'Tropical - Mahatanty ny maintany',
      'spacing': '1x1 m',
      'yield': '10-25 T/ha',
      'waterNeeds': 'Kely',
      'plantingGuide': '1. Omano ny tany, ataovy malalaka tsara.\n2. Makà tahon-kazo 20-30cm, misy maso 5-7.\n3. Atsatohy 45° na mitsivalana ny taho.\n4. Asio elanelana 1m isaky ny taho.\n5. Avelao hisy maso 2-3 ambonin\'ny tany.',
      'steps': [
        {'week': 'V1', 'action': 'Fanamboarana tany - Fametrahana tahon-kazo (20-30 cm)'},
        {'week': 'V2-3', 'action': 'Fiposahana - Fikarakarana voalohany'},
        {'week': 'V4-6', 'action': 'Fandroahana - Zezika organika'},
        {'week': 'V7-12', 'action': 'Fivoarana - Fanaraha-maso aretina'},
        {'week': 'V13-24', 'action': 'Fiandrasana fahamasahana - Fijinjana'},
      ],
      'tips': [
        'Ny tahon-kazo dia tokony ho 20-30 cm lava, misy maso 5-7',
        'Ataovy 45° ny fipetrahany, maso 2-3 ambonin\'ny tany',
        'Afaka jinjaina aorian\'ny 9 volana fa tsara kokoa raha 12-18 volana',
      ],
    },
    'Voanjo': {
      'emoji': '🥜',
      'name': 'Voanjo (Arachide)',
      'season': 'Novambra - Janoary',
      'duration': '90-120 andro',
      'climate': 'Tropical - Mafana, tsy mila rano be',
      'spacing': '30x15 cm',
      'yield': '1-2 T/ha',
      'waterNeeds': 'Antonony',
      'plantingGuide': '1. Omano ny tany, tsara raha tany fasika.\n2. Manaova lavaka kely 3-5cm.\n3. Asio voa 1 isaky ny lavaka.\n4. Asio elanelana 30cm isaky ny laharana, 15cm isaky ny lavaka.\n5. Sarony tany maivana.',
      'steps': [
        {'week': 'H1', 'action': 'Fanamboarana tany - Famafazana voa 1 isaky ny lavaka'},
        {'week': 'H2-4', 'action': 'Fiposahana - Fandroahana voalohany'},
        {'week': 'H5-8', 'action': 'Famokarana voninkazo - Fandroahana faharoa'},
        {'week': 'H9-12', 'action': 'Fiforonana voanjo ao anaty tany'},
        {'week': 'H13-17', 'action': 'Fijinjana rehefa mavo ny ravina'},
      ],
      'tips': [
        'Ny tany fasika dia tsara indrindra ho an\'ny voanjo',
        'Aza avela ho lena be ny tany rehefa mamoaka voninkazo',
        'Atao maivana ny fandroahana mba tsy hamaky ny gynophore',
      ],
    },
    'Tsaramaso': {
      'emoji': '🫘',
      'name': 'Tsaramaso (Haricot)',
      'season': 'Aprily - Jona / Oktobra',
      'duration': '60-90 andro',
      'climate': 'Tropical sy Tempéré',
      'spacing': '40x10 cm',
      'yield': '1-3 T/ha',
      'waterNeeds': 'Antonony',
      'plantingGuide': '1. Manaova lavaka 3-5cm ny halaliny.\n2. Asio voa 2 isaky ny lavaka.\n3. Asio elanelana 40cm isaky ny laharana, 10cm isaky ny lavaka.\n4. Sarony tany ary tondrahy.',
      'steps': [
        {'week': 'H1', 'action': 'Famafazana 2 voa isaky ny lavaka, 3-5 cm lalina'},
        {'week': 'H2-3', 'action': 'Fiposahana - Fikarakarana'},
        {'week': 'H4-6', 'action': 'Fandroahana - Zezika raha ilaina'},
        {'week': 'H7-10', 'action': 'Famokarana voninkazo - Fiforonana voankazo'},
        {'week': 'H11-13', 'action': 'Fijinjana rehefa maina ny vahatra'},
      ],
      'tips': [
        'Aza atao lelafina loatra ny famafazana',
        'Ny zezika azota dia mampitombo ravina fa mampihena voankazo',
        'Jinjao matetika mba hampitomboana ny vokatra',
      ],
    },
    'Sakay': {
      'emoji': '🌶️',
      'name': 'Sakay (Piment)',
      'season': 'Taona iray manontolo',
      'duration': '90-120 andro',
      'climate': 'Mafana sy mando',
      'spacing': '50x50 cm',
      'yield': '10-20 T/ha',
      'waterNeeds': 'Antonony',
      'plantingGuide': '1. Mamafy voa amin\'ny pépinière.\n2. Rehefa misy ravina 4-6 (afaka 4-6 herinandro), afindra.\n3. Omano ny tany, asio zezika organika.\n4. Asio elanelana 50cm isaky ny ketsa.\n5. Tondrahy matetika fa aza atao be loatra.',
      'steps': [
        {'week': 'H1-6', 'action': 'Famafazana amin\'ny pépinière - Fikarakarana ketsa'},
        {'week': 'H7-8', 'action': 'Famindrana ketsa - Fampidirana zezika fototra'},
        {'week': 'H9-12', 'action': 'Fandroahana - Fanaraha-maso bibikely'},
        {'week': 'H13-16', 'action': 'Famokarana voninkazo - Fiforonana voankazo'},
        {'week': 'H17+', 'action': 'Fijinjana mitohy (isaky ny herinandro)'},
      ],
      'tips': [
        'Tia masoandro sy tany lonaka tsara',
        'Tondrahy matetika fa aza avela hiandrona ny rano',
        'Esory ny ahi-dratsy mba tsy hifaninana amin\'ny sakafo',
      ],
    },
    'Anana': {
      'emoji': '🥬',
      'name': 'Anana (Brèdes)',
      'season': 'Taona manontolo',
      'duration': '30-60 andro',
      'climate': 'Tropical - Mafana sy mando',
      'spacing': '20x15 cm',
      'yield': '10-20 T/ha',
      'waterNeeds': 'Be',
      'plantingGuide': '1. Omano ny tany, asio zezika organika tsara.\n2. Afafazo ny voa na afindra ny zanak\'anana.\n3. Asio elanelana 20cm isaky ny laharana.\n4. Tondrahy rano isan\'andro, indrindra ny maraina.',
      'steps': [
        {'week': 'H1', 'action': 'Fanamboarana tany - Famafazana na fanetsana'},
        {'week': 'H2', 'action': 'Fiposahana - Fanondrahan-drano isan\'andro'},
        {'week': 'H3-4', 'action': 'Fivoarana haingana - Zezika organika'},
        {'week': 'H5-8', 'action': 'Fijinjana - Afaka manomboka jinjaina'},
      ],
      'tips': [
        'Mila rano isan\'andro, indrindra ny maraina',
        'Ny zezika organika (zezika omby, kompositra) dia tsara indrindra',
        'Afaka jinjaina matetika ny ravina vaovao',
      ],
    },
    'Angivy': {
      'emoji': '🟢',
      'name': 'Angivy (Aubergine Amère)',
      'season': 'Oktobra - Martsa',
      'duration': '90-120 andro',
      'climate': 'Mafana',
      'spacing': '60x60 cm',
      'yield': '15-25 T/ha',
      'waterNeeds': 'Antonony',
      'plantingGuide': '1. Mamafy voa amin\'ny pépinière.\n2. Rehefa afaka 1 volana, afindra ny ketsa.\n3. Omano ny tany, asio zezika organika.\n4. Asio elanelana 60cm isaky ny ketsa.\n5. Tondrahy matetika.',
      'steps': [
        {'week': 'H1-4', 'action': 'Famafazana amin\'ny pépinière'},
        {'week': 'H5-6', 'action': 'Famindrana ketsa - Fampidirana zezika'},
        {'week': 'H7-10', 'action': 'Fandroahana - Fanaraha-maso bibikely'},
        {'week': 'H11-14', 'action': 'Famokarana voninkazo sy voa'},
        {'week': 'H15+', 'action': 'Fijinjana (mbola maitso na mena)'},
      ],
      'tips': [
        'Tsara kokoa raha jinjaina mbola maitso raha tiana mangidy',
        'Tia masoandro sy hafanana',
        'Azo atao ny manapaka ny tendrony mba hihabetsaka ny sampana',
      ],
    },
    'Voatabia': {
      'emoji': '🍅',
      'name': 'Voatabia (Tomate)',
      'season': 'Aprily - Septambra',
      'duration': '90-120 andro',
      'climate': 'Tropical - Mafana antonony, tsy mila rano be',
      'spacing': '60x40 cm',
      'yield': '20-50 T/ha',
      'waterNeeds': 'Antonony',
      'plantingGuide': '1. Mamafy voa amin\'ny pépinière aloha.\n2. Rehefa misy ravina 4-5, afindra amin\'ny saha.\n3. Manaova lavaka ary asio zezika.\n4. Asio elanelana 60cm isaky ny laharana, 40cm isaky ny tongotra.\n5. Asio tuteur (kazo) hanohanana azy.',
      'steps': [
        {'week': 'H1-3', 'action': 'Fanetsana amin\'ny pépinière'},
        {'week': 'H4-5', 'action': 'Fametrahana amin\'ny saha - Fametrahana tuteur'},
        {'week': 'H6-10', 'action': 'Fivoarana - Zezika - Fandroahana'},
        {'week': 'H11-16', 'action': 'Famokarana voankazo - Fijinjana'},
      ],
      'tips': [
        'Mila tuteur ny voatabia mba hitondra ny voankazo',
        'Esory ny sampan-kazo kely (gourmands) eo amin\'ny het-kazo',
        'Aza mandena ny ravina rehefa manondraka',
      ],
    },
    'Tongolo': {
      'emoji': '🧅',
      'name': 'Tongolo (Oignon)',
      'season': 'Aprily - Aogositra',
      'duration': '90-150 andro',
      'climate': 'Mafana antonony - Mainty',
      'spacing': '15x10 cm',
      'yield': '15-30 T/ha',
      'waterNeeds': 'Antonony',
      'plantingGuide': '1. Mamafy voa amin\'ny pépinière.\n2. Rehefa lehibe ny zanak\'ala (toy ny pensilihazo), afindra.\n3. Hetezo kely ny faka sy ny ravina alohan\'ny hambolena.\n4. Asio elanelana 15cm isaky ny tongotra.\n5. Aza atao lalina loatra ny fambolena.',
      'steps': [
        {'week': 'H1-4', 'action': 'Fanetsana amin\'ny pépinière - Fikarakarana zanak\'ala'},
        {'week': 'H5-6', 'action': 'Fametrahana amin\'ny saha - Elanelana 15x10 cm'},
        {'week': 'H7-12', 'action': 'Fivoarana - Fanondrahan-drano matetika - Zezika'},
        {'week': 'H13-18', 'action': 'Fiforonana ny bulbe - Fampihenana rano'},
        {'week': 'H19-22', 'action': 'Fijinjana rehefa milofika ny ravina'},
      ],
      'tips': [
        'Ny tany fasika sy tsara drainage dia mety amin\'ny tongolo',
        'Aza mandena loatra ny ravina fa ny faka ihany',
        'Jinjao rehefa milofika ny 80% ny ravina',
        'Aveao hamaina 2-3 andro alohan\'ny fitahirizana',
      ],
    },
    'Tongolo Maitso': {
      'emoji': '🧅',
      'name': 'Tongolo Maitso (Ciboule)',
      'season': 'Taona manontolo',
      'duration': '45-60 andro',
      'climate': 'Tropical - Mafana sy mando',
      'spacing': '15x5 cm',
      'yield': '10-20 T/ha',
      'waterNeeds': 'Antonony',
      'plantingGuide': '1. Afaka mamafy voa na mampiasa ny vodiny.\n2. Raha vodiny: tapaho ny ravina, avelao 3cm.\n3. Hambolena amin\'ny tany lonaka.\n4. Asio elanelana 15cm isaky ny tongotra.',
      'steps': [
        {'week': 'H1', 'action': 'Famafazana mivantana na fanetsana'},
        {'week': 'H2-3', 'action': 'Fiposahana - Fikarakarana'},
        {'week': 'H4-6', 'action': 'Fivoarana - Fanondrahan-drano isan\'andro'},
        {'week': 'H7-9', 'action': 'Fijinjana - Afaka jinjaina matetika'},
      ],
      'tips': [
        'Mora ompiana sy haingana vokatra',
        'Afaka jinjaina matetika ny ravina fa hitombo indray',
        'Tsara ampiarahina amin\'ny voly hafa (tomate, anana)',
      ],
    },
    'Tongolo Gasy': {
      'emoji': '🧄',
      'name': 'Tongolo Gasy (Échalote)',
      'season': 'Martsa - Jiona',
      'duration': '90-120 andro',
      'climate': 'Mafana antonony - Maina',
      'spacing': '20x10 cm',
      'yield': '8-15 T/ha',
      'waterNeeds': 'Kely - Antonony',
      'plantingGuide': '1. Misafidiana bulbe (nify) salama.\n2. Atsatohy amin\'ny tany ny nify, ny lohany miakatra.\n3. Asio elanelana 20cm isaky ny laharana, 10cm isaky ny nify.\n4. Aza atao lalina loatra (2-3cm).',
      'steps': [
        {'week': 'H1', 'action': 'Fametrahana bulbe kely - 2-3 cm lalina'},
        {'week': 'H2-4', 'action': 'Fiposahana - Fikarakarana voalohany'},
        {'week': 'H5-10', 'action': 'Fivoarana - Zezika organika - Fanondrahan-drano'},
        {'week': 'H11-16', 'action': 'Fijinjana rehefa maina ny ravina'},
      ],
      'tips': [
        'Safidio bulbe salama sy tsy simba',
        'Ny tany fasika tsara drainage no mety',
        'Aza mandena loatra fa mora lo',
        'Azo tehirizina ela rehefa maina tsara',
      ],
    },
    'Karoty': {
      'emoji': '🥕',
      'name': 'Karoty (Carotte)',
      'season': 'Aprily - Aogositra',
      'duration': '70-120 andro',
      'climate': 'Mafana antonony - Mangatsiaka',
      'spacing': '20x5 cm',
      'yield': '20-40 T/ha',
      'waterNeeds': 'Antonony',
      'plantingGuide': '1. Omano ny tany, ataovy malalaka tsara (tsy misy vato).\n2. Manaova hady kely 1cm ny halaliny.\n3. Afafazo manify ny voa.\n4. Sarony tany tena manify.\n5. Tondrahy moramora mba tsy hiala ny voa.',
      'steps': [
        {'week': 'H1', 'action': 'Famafazana mivantana - Voa kely 1 cm lalina'},
        {'week': 'H2-3', 'action': 'Fiposahana miadana - Fikarakarana'},
        {'week': 'H4-6', 'action': 'Fanitsiana (éclaircissage) - 5 cm elanelana'},
        {'week': 'H7-12', 'action': 'Fivoarana - Fanondrahan-drano - Zezika'},
        {'week': 'H13-17', 'action': 'Fijinjana rehefa vokatra ny loha'},
      ],
      'tips': [
        'Ny tany lalina sy fasika no tsara - aza misy vato',
        'Aza manao zezika omby vaovao fa mampisampona',
        'Fanondrahan-drano marin-toerana mba tsy hitriatriaka',
        'Saromana ny loha mba tsy hivadika mavo',
      ],
    },
    'Baranjely': {
      'emoji': '🍆',
      'name': 'Baranjely (Aubergine)',
      'season': 'Septambra - Desambra',
      'duration': '90-150 andro',
      'climate': 'Tropical - Mafana',
      'spacing': '60x50 cm',
      'yield': '20-40 T/ha',
      'waterNeeds': 'Antonony',
      'plantingGuide': '1. Manaova pépinière.\n2. Afindra rehefa misy ravina 4-5.\n3. Asio elanelana 60cm isaky ny laharana, 50cm isaky ny tongotra.\n4. Asio zezika tsara ny lavaka.',
      'steps': [
        {'week': 'H1-4', 'action': 'Fanetsana amin\'ny pépinière'},
        {'week': 'H5-6', 'action': 'Fametrahana amin\'ny saha rehefa 15 cm'},
        {'week': 'H7-10', 'action': 'Fivoarana - Zezika - Fandroahana'},
        {'week': 'H11-20', 'action': 'Famokarana - Fijinjana matetika'},
      ],
      'tips': [
        'Mila masoandro be sy hafanana',
        'Jinjao rehefa manopy sy mamirapiratra ny hoditra',
        'Afaka mamokatra 3-4 volana',
        'Mila tuteur raha be vokatra',
      ],
    },
    'Poireau': {
      'emoji': '🥬',
      'name': 'Poireau (Poireau)',
      'season': 'Martsa - Jolay',
      'duration': '120-150 andro',
      'climate': 'Mangatsiaka - Mafana antonony',
      'spacing': '30x15 cm',
      'yield': '15-25 T/ha',
      'waterNeeds': 'Antonony - Be',
      'plantingGuide': '1. Manaova pépinière.\n2. Rehefa lehibe (toy ny pensilihazo), afindra.\n3. Manaova lavaka lalina (15cm) mba ho fotsy ny tahony.\n4. Asio elanelana 30cm isaky ny laharana.',
      'steps': [
        {'week': 'H1-6', 'action': 'Fanetsana amin\'ny pépinière'},
        {'week': 'H7-8', 'action': 'Fametrahana amin\'ny saha - Lavaka 15 cm lalina'},
        {'week': 'H9-16', 'action': 'Fivoarana - Fanondrahan-drano - Buttage'},
        {'week': 'H17-22', 'action': 'Fijinjana rehefa lehibe ny fût'},
      ],
      'tips': [
        'Ataovy lalina ny fambolena mba hampahotsy ny fût',
        'Ny buttage (fanorenana tany) dia manampy hampahotsy',
        'Mila rano matetika sy zezika azota',
        'Afaka tehirizina ela ao amin\'ny frigo',
      ],
    },
    'Voasary': {
      'emoji': '🍊',
      'name': 'Voasary (Orange)',
      'season': 'Taona manontolo (Hazo)',
      'duration': '3-5 taona (voalohany mamokatra)',
      'climate': 'Tropical - Mafana',
      'spacing': '6x6 m',
      'yield': '20-40 T/ha (rehefa lehibe)',
      'waterNeeds': 'Antonony',
      'plantingGuide': '1. Manaova lavaka lehibe 50x50x50cm.\n2. Afangaro ny tany sy zezika organika.\n3. Esory ny plastika amin\'ny zanak\'hazo.\n4. Ataovy ao anaty lavaka, aza atao lalina loatra ny fotony.\n5. Tondrahy be dia be.',
      'steps': [
        {'week': 'T1', 'action': 'Fametrahana zanak\'hazo - Lavaka 50x50x50 cm'},
        {'week': 'T1-2', 'action': 'Fikarakarana - Fanondrahan-drano - Zezika'},
        {'week': 'T3-4', 'action': 'Fivoarana - Fandidiana sampana'},
        {'week': 'T5+', 'action': 'Famokarana - Fijinjana voninkazo sy voankazo'},
      ],
      'tips': [
        'Mila tany lalina sy tsara drainage',
        'Zezika organika sy NPK isan-taona',
        'Fandidiana manampy ny famokarana',
        'Mila 3-5 taona vao mamokatra tsara',
      ],
    },
  };

  @override
  Widget build(BuildContext context) {
    final crop = _cropsData[_selectedCrop]!;
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [Colors.green.shade700, Colors.green.shade500],
              ),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Column(
              children: [
                const Text('🌱 Safidio ny Voly', style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                const SizedBox(height: 12),
                Wrap(
                  spacing: 8,
                  runSpacing: 8,
                  children: _cropsData.keys.map((cropName) {
                    final isSelected = _selectedCrop == cropName;
                    return GestureDetector(
                      onTap: () => setState(() => _selectedCrop = cropName),
                      child: Container(
                        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                        decoration: BoxDecoration(
                          color: isSelected ? Colors.white : Colors.white.withValues(alpha: 0.2),
                          borderRadius: BorderRadius.circular(20),
                        ),
                        child: Text(
                          '${_cropsData[cropName]!['emoji']} $cropName',
                          style: TextStyle(
                            color: isSelected ? Colors.green.shade700 : Colors.white,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                    );
                  }).toList(),
                ),
              ],
            ),
          ),
          const SizedBox(height: 16),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(16),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 10)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text(crop['emoji'] as String, style: const TextStyle(fontSize: 40)),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(crop['name'] as String, style: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold)),
                          Text('📅 ${crop['season']}', style: TextStyle(color: Colors.grey.shade600)),
                        ],
                      ),
                    ),
                  ],
                ),
                const Divider(height: 24),
                _buildInfoRow('⏱️ Faharetana', crop['duration'] as String),
                _buildInfoRow('🌡️ Toetr\'andro', crop['climate'] as String),
                _buildInfoRow('📏 Elanelana', crop['spacing'] as String),
                _buildInfoRow('📊 Vokatra', crop['yield'] as String),
                _buildInfoRow('💧 Rano ilaina', crop['waterNeeds'] as String),
              ],
            ),
          ),
          if (crop.containsKey('plantingGuide')) ...[
            const SizedBox(height: 16),
            Container(
              width: double.infinity,
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: Colors.blue.shade50,
                borderRadius: BorderRadius.circular(16),
              ),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text('🌱 Fomba Fambolena (Ho an\'ny vao manomboka)', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                  const SizedBox(height: 12),
                  Text(crop['plantingGuide'] as String, style: const TextStyle(height: 1.5)),
                ],
              ),
            ),
          ],
          const SizedBox(height: 16),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.green.shade50,
              borderRadius: BorderRadius.circular(16),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('📋 Dingana amin\'ny fambolena', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                const SizedBox(height: 12),
                ...(crop['steps'] as List).map((step) => Padding(
                  padding: const EdgeInsets.only(bottom: 8),
                  child: Row(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                        decoration: BoxDecoration(
                          color: Colors.green.shade200,
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Text(step['week'] as String, style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12, color: Colors.green.shade800)),
                      ),
                      const SizedBox(width: 12),
                      Expanded(child: Text(step['action'] as String)),
                    ],
                  ),
                )),
              ],
            ),
          ),
          const SizedBox(height: 16),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.amber.shade50,
              borderRadius: BorderRadius.circular(16),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('💡 Toro-hevitra', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                const SizedBox(height: 12),
                ...(crop['tips'] as List).map((tip) => Padding(
                  padding: const EdgeInsets.only(bottom: 8),
                  child: Row(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('• ', style: TextStyle(fontSize: 16, color: Colors.amber)),
                      Expanded(child: Text(tip as String)),
                    ],
                  ),
                )),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label, style: const TextStyle(fontWeight: FontWeight.w500)),
          Flexible(child: Text(value, textAlign: TextAlign.right)),
        ],
      ),
    );
  }
}

// --- FAMBOLENA CALENDAR SCREEN (Tetiandro) ---
class FambolenaCalendarScreen extends StatefulWidget {
  const FambolenaCalendarScreen({super.key});

  @override
  State<FambolenaCalendarScreen> createState() => _FambolenaCalendarScreenState();
}

class _FambolenaCalendarScreenState extends State<FambolenaCalendarScreen> with SingleTickerProviderStateMixin {
  String _selectedRegion = 'analamanga';
  String _selectedCrop = 'vary_fohy';
  DateTime _selectedDate = DateTime.now();
  double _surfaceArea = 1000;
  late TabController _tabController;
  DateTime _currentCalendarView = DateTime.now();
  DateTime? _selectedCalendarDay;

  final Map<String, String> regionTypes = {
    'analamanga': 'highland', 'vakinankaratra': 'highland', 'itasy': 'highland', 
    'bongolava': 'highland', 'amoron_mania': 'highland', 'matsiatra_ambony': 'highland',
    'atsinanana': 'east', 'analanjirofo': 'east', 'vatovavy': 'east', 
    'fitovinany': 'east', 'atsimo_atsinanana': 'east', 'sava': 'east',
    'diana': 'north', 'sofia': 'north', 'boeny': 'north', 'betsiboka': 'north', 'melaky': 'north',
    'atsimo_andrefana': 'south', 'androy': 'south', 'anosy': 'south', 
    'menabe': 'south', 'ihorombe': 'south'
  };

  final Map<String, dynamic> db = {
    'vary_fohy': {
      'name': "Vary (Tsingerina Fohy)",
      'tech': {
        'tany': "Tany ditra (Argileux) ho an'ny vary an-drano. Tany marin-drano ho an'ny an-tanety.",
        'zezika': "NPK 11-22-16 (200kg/ha) + Urée (50kg/ha) + Zezi-pahitra (5t/ha).",
        'fomba_fambolena': "Raha vary an-drano: Ketsa 20 andro no afindra. Elanelana 20cm x 20cm.",
        'fomba_fiavana': "Fiavàna 1 (J+20): Tatrahana ny rano, esorina ny ahitra, atao ny Urée.",
        'fomba_fijinjana': "Jinjaina rehefa mavo ny 85% ny salohy ary miondrika.",
        'fady': "Tsy azo idirana ny tanimbary rehefa mikibo.",
        'saison': "Indroa isan-taona (Asara + Jeby)."
      },
      'calc': {'seed_ha': 40.0, 'yield_ha': 4.5, 'manure_ha': 5000.0, 'npk_ha': 200.0, 'urea_ha': 50.0},
      'tasks': [
        {'d': 0, 't': "Famafazana", 'c': Colors.green},
        {'d': 20, 't': "Fiavàna 1", 'c': Colors.blue},
        {'d': 45, 't': "Fiavàna 2", 'c': Colors.blue},
        {'d': 70, 't': "Famoizana", 'c': Colors.red},
        {'d': 110, 't': "Fijinjana", 'c': Colors.orange}
      ],
      'windows': {'highland': [10, 11, 12], 'east': [10, 11, 12, 4, 5, 6, 7, 8], 'default': [11, 12, 1]}
    },
    'katsaka': {
      'name': "Katsaka",
      'tech': {
        'tany': "Baiboho, tany lonaka.",
        'zezika': "NPK 15-15-15 (150kg/ha) + Urée.",
        'fomba_fambolena': "Elanelana 80cm x 40cm. 2 voa isaky ny lavaka.",
        'fomba_fiavana': "Asiana buttage amin'ny andro faha-40.",
        'fomba_fijinjana': "Rehefa maina tanteraka ny ravina.",
        'fady': "Tsy azo iavana rehefa mamony.",
        'saison': "Asara."
      },
      'calc': {'seed_ha': 20.0, 'yield_ha': 3.0, 'manure_ha': 5000.0, 'npk_ha': 150.0, 'urea_ha': 100.0},
      'tasks': [
        {'d': 0, 't': "Famafazana", 'c': Colors.green},
        {'d': 20, 't': "Fiavàna 1", 'c': Colors.blue},
        {'d': 40, 't': "Fanotofana", 'c': Colors.blue},
        {'d': 55, 't': "Famoniana", 'c': Colors.red},
        {'d': 100, 't': "Fiotazana", 'c': Colors.orange}
      ],
      'windows': {'highland': [10, 11], 'east': [4, 5, 6], 'default': [11, 12, 1]}
    },
    'voanjo': {
      'name': "Voanjo",
      'tech': {
        'tany': "Tany malemy, maivana (Sableux).",
        'zezika': "Tia Dolomita (Calcium) sy Phosphore.",
        'fomba_fambolena': "40cm x 15cm. Voa iray isaky ny lavaka.",
        'fomba_fiavana': "Fiavàna madio alohan'ny hamoniany.",
        'fomba_fijinjana': "Hadiana rehefa malazo ny ravina.",
        'fady': "Aza tapahina ny Gynophores.",
        'saison': "Asara."
      },
      'calc': {'seed_ha': 100.0, 'yield_ha': 1.5, 'manure_ha': 0.0, 'npk_ha': 100.0, 'dolomite': 500.0},
      'tasks': [
        {'d': 0, 't': "Famafazana", 'c': Colors.green},
        {'d': 25, 't': "Fiavàna", 'c': Colors.blue},
        {'d': 40, 't': "Famoniana", 'c': Colors.red},
        {'d': 110, 't': "Fihadiana", 'c': Colors.orange}
      ],
      'windows': {'highland': [10, 11], 'south': [12, 1], 'default': [11, 12, 3, 4]}
    },
    'tsaramaso': {
      'name': "Tsaramaso",
      'tech': {
        'tany': "Mandray rano.",
        'zezika': "Zezi-pahitra efa lo tsara.",
        'fomba_fambolena': "Ligne: 40cm, Poquet: 20cm. Voa 2-3.",
        'fomba_fiavana': "Fanotofana mba tsy hianjera.",
        'fomba_fijinjana': "Rehefa maina ny 90% ny voa.",
        'fady': "Tsy totofana rehefa mamony.",
        'saison': "Jeby."
      },
      'calc': {'seed_ha': 60.0, 'yield_ha': 1.2, 'manure_ha': 5000.0, 'npk_ha': 100.0, 'urea_ha': 0.0},
      'tasks': [
        {'d': 0, 't': "Famafazana", 'c': Colors.green},
        {'d': 20, 't': "Fanotofana 1", 'c': Colors.blue},
        {'d': 40, 't': "Famoniana", 'c': Colors.red},
        {'d': 90, 't': "Fiotazana", 'c': Colors.orange}
      ],
      'windows': {'default': [3, 4, 5, 6]}
    },
    'ovy': {
      'name': "Ovy",
      'tech': {
        'tany': "Maivana, misy Potasse.",
        'zezika': "Zezika fototra betsaka.",
        'fomba_fambolena': "60cm x 30cm. Atao ao anaty Sillons.",
        'fomba_fiavana': "Ny FANOTOFANA no tena zava-dehibe.",
        'fomba_fijinjana': "Rehefa malazo tanteraka ny ravina.",
        'saison': "Ririnina."
      },
      'calc': {'seed_ha': 1500.0, 'yield_ha': 15.0, 'manure_ha': 20000.0, 'npk_ha': 300.0, 'urea_ha': 0.0},
      'tasks': [
        {'d': 0, 't': "Fambolena", 'c': Colors.green},
        {'d': 35, 't': "FANOTOFANA", 'c': Colors.red},
        {'d': 90, 't': "Fihadiana", 'c': Colors.orange}
      ],
      'windows': {'highland': [4, 5, 6, 7], 'default': [4, 5]}
    },
    'mangahazo': {
      'name': "Mangahazo",
      'tech': {
        'tany': "Mahatanty hain-tany.",
        'zezika': "Tsy mifidy.",
        'fomba_fambolena': "Trakatra 20-30cm. Milevina mitsivalana na mitsangana.",
        'fomba_fiavana': "Mila madio ny fotony amin'ny 3 volana voalohany.",
        'fomba_fijinjana': "Fihadiana faobe.",
        'fady': "Aza hadiana raha mbola tanora.",
        'saison': "Taona manontolo."
      },
      'calc': {'seed_ha': 10000.0, 'is_tige': true, 'yield_ha': 20.0, 'manure_ha': 0.0, 'npk_ha': 0.0, 'urea_ha': 0.0},
      'tasks': [
        {'d': 0, 't': "Fambolena", 'c': Colors.green},
        {'d': 45, 't': "Fiavàna", 'c': Colors.blue},
        {'d': 300, 't': "Fihadiana", 'c': Colors.orange}
      ],
      'windows': {'default': [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]}
    },
    'angivy': {
      'name': "Angivy (Aubergine Amère)",
      'tech': {
        'tany': "Tany lonaka, misy zezika organika.",
        'zezika': "Zezika organika + NPK.",
        'fomba_fambolena': "Pépinière 30 andro. Famindrana: 60cm x 60cm.",
        'fomba_fiavana': "Fiavàna sy fanondrahana matetika.",
        'fomba_fijinjana': "Jinjaina rehefa lehibe fa mbola maitso (na mena).",
        'fady': "Tsy tia hatsiaka be.",
        'saison': "Oktobra - Martsa."
      },
      'calc': {'seed_ha': 0.4, 'yield_ha': 20.0, 'manure_ha': 10000.0, 'npk_ha': 150.0, 'urea_ha': 50.0},
      'tasks': [
        {'d': 0, 't': "Famafazana", 'c': Colors.green},
        {'d': 30, 't': "Famindrana", 'c': Colors.blue},
        {'d': 60, 't': "Famoniana", 'c': Colors.red},
        {'d': 90, 't': "Fijinjana", 'c': Colors.orange}
      ],
      'windows': {'default': [10, 11, 12, 1, 2, 3]}
    },
    'sakay': {
      'name': "Sakay (Piment)",
      'tech': {
        'tany': "Tany lonaka, maivana, tsy miandrona rano.",
        'zezika': "Zezika organika (10-20t/ha) + NPK 12-24-12.",
        'fomba_fambolena': "Pépinière 45 andro. Famindrana: 50cm x 50cm.",
        'fomba_fiavana': "Fiavàna matetika, mulching (paillage) tsara.",
        'fomba_fijinjana': "Isaky ny herinandro rehefa mena na maitso (arakaraka ny karazany).",
        'fady': "Tsy tia rano miandrona.",
        'saison': "Taona manontolo."
      },
      'calc': {'seed_ha': 0.5, 'yield_ha': 15.0, 'manure_ha': 15000.0, 'npk_ha': 200.0, 'urea_ha': 100.0},
      'tasks': [
        {'d': 0, 't': "Famafazana (Pépinière)", 'c': Colors.green},
        {'d': 45, 't': "Famindrana", 'c': Colors.blue},
        {'d': 75, 't': "Famoniana", 'c': Colors.red},
        {'d': 90, 't': "Fijinjana voalohany", 'c': Colors.orange},
        {'d': 180, 't': "Faran'ny fijinjana", 'c': Colors.grey}
      ],
      'windows': {'default': [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]}
    },
    'vary_lava': {
      'name': "Vary (Lava)",
      'tech': {
        'tany': "Tany lonaka.",
        'zezika': "Zezika fototra + NPK amin'ny ketsa.",
        'fomba_fambolena': "Fanetsana milahatra 25cm x 25cm. Ketsa 30-40 andro.",
        'fomba_fiavana': "Fiavàna intelo raha azo atao. Ny rano no mifehy ny ahitra (5-10cm).",
        'fomba_fijinjana': "Tapatapahina amin'ny antsy kely na antsy be.",
        'saison': "Vary Asara (Oktobra)."
      },
      'calc': {'seed_ha': 40.0, 'yield_ha': 5.0, 'manure_ha': 5000.0, 'npk_ha': 300.0, 'urea_ha': 100.0},
      'tasks': [
        {'d': 0, 't': "Famafazana", 'c': Colors.green},
        {'d': 30, 't': "Fanetsana", 'c': Colors.blue},
        {'d': 60, 't': "Fiavàna 1", 'c': Colors.blue},
        {'d': 150, 't': "Fijinjana", 'c': Colors.orange}
      ],
      'windows': {'highland': [9, 10, 11], 'default': [10, 11]}
    },
    'vary_tanety': {
      'name': "Vary an-tanety",
      'tech': {
        'tany': "Tany niasana lalina.",
        'zezika': "NPK + Zezi-pahitra.",
        'fomba_fambolena': "Fafy mivantana anaty lavaka (Poquet). 3-4 voa isaky ny lavaka. Elanelana 30cm x 15cm.",
        'fomba_fiavana': "Saropady ny ahitra satria tsy misy rano hamono azy. Miava isaky ny misy ahitra.",
        'fomba_fijinjana': "Mitovy amin'ny vary an-drano.",
        'fady': "Tsy mahatanty rano mihitsana (asiana lalan-drano)."
      },
      'calc': {'seed_ha': 50.0, 'yield_ha': 2.5, 'manure_ha': 5000.0, 'npk_ha': 150.0, 'urea_ha': 50.0},
      'tasks': [
        {'d': 0, 't': "Famafazana", 'c': Colors.green},
        {'d': 20, 't': "Fiavàna 1", 'c': Colors.blue},
        {'d': 45, 't': "Fiavàna 2", 'c': Colors.blue},
        {'d': 120, 't': "Fijinjana", 'c': Colors.orange}
      ],
      'windows': {'default': [11, 12, 1]}
    },
    'soja': {
      'name': "Soja",
      'tech': {
        'tany': "Maivana.",
        'zezika': "Tsy mila Urée be. Mila Inoculum (Bakteria).",
        'fomba_fambolena': "40cm x 10cm. Halalin'ny 2-3 cm.",
        'fomba_fiavana': "Fiavàna in-2. Ny voalohany 15 andro aorian'ny fiposahany.",
        'fomba_fijinjana': "Rehefa mihintsana ny ravina ary maina ny gousses.",
        'saison': "Asara sy Avotra."
      },
      'calc': {'seed_ha': 60.0, 'yield_ha': 2.0, 'manure_ha': 3000.0, 'npk_ha': 150.0, 'urea_ha': 0.0},
      'tasks': [
        {'d': 0, 't': "Famafazana", 'c': Colors.green},
        {'d': 20, 't': "Fiavàna 1", 'c': Colors.blue},
        {'d': 40, 't': "Fiavàna 2", 'c': Colors.blue},
        {'d': 100, 't': "Fijinjana", 'c': Colors.orange}
      ],
      'windows': {'default': [11, 12, 1, 4, 5]}
    },
    'vomanga': {
      'name': "Vomanga",
      'tech': {
        'tany': "Maivana.",
        'zezika': "Tia lavenona (Potasse).",
        'fomba_fambolena': "Bouture (Taho) 30cm. Milevina ny 2/3.",
        'fomba_fiavana': "Fanotofana (Buttage) mba tsy hidiran'ny Charançon.",
        'fomba_fijinjana': "Rehefa vaky ny tany eo ampotony."
      },
      'calc': {'seed_ha': 20000.0, 'is_tige': true, 'yield_ha': 15.0, 'manure_ha': 5000.0, 'npk_ha': 0.0, 'urea_ha': 0.0},
      'tasks': [
        {'d': 0, 't': "Fambolena Taho", 'c': Colors.green},
        {'d': 45, 't': "Fanotofana", 'c': Colors.blue},
        {'d': 130, 't': "Fihadiana", 'c': Colors.orange}
      ],
      'windows': {'default': [11, 12, 1, 2, 9, 10]}
    },
    'saonjo': {
      'name': "Saonjo",
      'tech': {
        'tany': "Tia rano.",
        'zezika': "Zezi-pahitra betsaka.",
        'fomba_fambolena': "Lohany na Zanany no ambolena.",
        'fomba_fiavana': "Fanotofana matetika mba hihangeza ny vodiny.",
        'fomba_fijinjana': "Rehefa malazo ny ravina."
      },
      'calc': {'seed_ha': 10000.0, 'is_tige': true, 'yield_ha': 10.0, 'manure_ha': 10000.0, 'npk_ha': 0.0, 'urea_ha': 0.0},
      'tasks': [
        {'d': 0, 't': "Fambolena", 'c': Colors.green},
        {'d': 60, 't': "Fanotofana", 'c': Colors.blue},
        {'d': 240, 't': "Fihadiana", 'c': Colors.orange}
      ],
      'windows': {'default': [9, 10, 11, 12]}
    },
    'voatavo': {
      'name': "Voatavo",
      'tech': {
        'tany': "Tia zezika komposta.",
        'zezika': "Zezika organika be dia be.",
        'fomba_fambolena': "Lavaka lehibe 50x50cm. Asiana zezika organika be dia be.",
        'fomba_fiavana': "Fiavàna alohan'ny handrakofany ny tany.",
        'fomba_fijinjana': "Rehefa mafy ny hodiny ary maina ny tahony."
      },
      'calc': {'seed_ha': 5.0, 'yield_ha': 20.0, 'manure_ha': 20000.0, 'npk_ha': 0.0, 'urea_ha': 0.0},
      'tasks': [
        {'d': 0, 't': "Famafazana", 'c': Colors.green},
        {'d': 30, 't': "Fiavàna", 'c': Colors.blue},
        {'d': 150, 't': "Fiotazana", 'c': Colors.orange}
      ],
      'windows': {'default': [10, 11, 12]}
    },
    'tongolo': {
      'name': "Tongolo (Oignon)",
      'tech': {
        'tany': "Tany maivana sy mora miboaka rano. Tsy tia tany lemaka.",
        'zezika': "Zezi-pahitra sy NPK (10-20-20). Tsy asiana zezika maina.",
        'fomba_fambolena': "Famafazana ao anaty pépinière 45-60 andro, avy eo afindra. Elanelana 15x10cm.",
        'fomba_fiavana': "Fanadiovana ahitra matetika. Tsy tokony ho kotrika ny fotony.",
        'fomba_fijinjana': "Rehefa mianjera ny ravina ary maina ny tendany.",
        'saison': "Ririnina (Aprily - Jolay)."
      },
      'calc': {'seed_ha': 5.0, 'yield_ha': 25.0, 'manure_ha': 15000.0, 'npk_ha': 400.0, 'urea_ha': 0.0},
      'tasks': [
        {'d': 0, 't': "Famafazana pépinière", 'c': Colors.green},
        {'d': 50, 't': "Fanetsana", 'c': Colors.blue},
        {'d': 80, 't': "Fiavàna", 'c': Colors.blue},
        {'d': 120, 't': "Fijinjana", 'c': Colors.orange}
      ],
      'windows': {'highland': [3, 4, 5, 6], 'default': [4, 5, 6]}
    },
    'tongolo_maitso': {
      'name': "Tongolo Maitso (Ciboule)",
      'tech': {
        'tany': "Tany lonaka sy mora miboaka rano.",
        'zezika': "Zezi-pahitra sy kely NPK.",
        'fomba_fambolena': "Fafy mivantana na afindra avy amin'ny pépinière. Elanelana 10x10cm.",
        'fomba_fiavana': "Fanadiovana ahitra. Azonao tapahina ny ravina ary mitsiry indray.",
        'fomba_fijinjana': "Tapahina ny ravina rehefa 20-30cm. Mitsiry imbetsaka.",
        'saison': "Taona manontolo fa indrindra ririnina."
      },
      'calc': {'seed_ha': 8.0, 'yield_ha': 15.0, 'manure_ha': 10000.0, 'npk_ha': 200.0, 'urea_ha': 50.0},
      'tasks': [
        {'d': 0, 't': "Famafazana", 'c': Colors.green},
        {'d': 20, 't': "Fiavàna", 'c': Colors.blue},
        {'d': 45, 't': "Fiotazana 1", 'c': Colors.orange},
        {'d': 60, 't': "Fiotazana 2", 'c': Colors.orange}
      ],
      'windows': {'default': [3, 4, 5, 6, 7, 8]}
    },
    'tongolo_gasy': {
      'name': "Tongolo Gasy (Échalote)",
      'tech': {
        'tany': "Tany maivana, mora miboaka rano.",
        'zezika': "Zezi-pahitra sy lavenona (Potasse).",
        'fomba_fambolena': "Ambolena ny zanany na ny lohany. Elanelana 15x10cm. Halalina 2-3cm.",
        'fomba_fiavana': "Fanadiovana ahitra sy fanotofana kely.",
        'fomba_fijinjana': "Rehefa maina ny ravina (90-120 andro).",
        'saison': "Ririnina."
      },
      'calc': {'seed_ha': 800.0, 'is_tige': true, 'yield_ha': 12.0, 'manure_ha': 12000.0, 'npk_ha': 300.0, 'urea_ha': 0.0},
      'tasks': [
        {'d': 0, 't': "Fambolena zanaka", 'c': Colors.green},
        {'d': 30, 't': "Fiavàna", 'c': Colors.blue},
        {'d': 60, 't': "Fanotofana", 'c': Colors.blue},
        {'d': 100, 't': "Fihadiana", 'c': Colors.orange}
      ],
      'windows': {'highland': [4, 5, 6], 'default': [4, 5, 6, 7]}
    },
    'karoty': {
      'name': "Karoty (Carotte)",
      'tech': {
        'tany': "Tany maivana lalina (40cm+). Tsy misy vato na fakany.",
        'zezika': "Zezi-pahitra ela niolana. Tsy asiana zezika maina (mahatonga fizarazarana).",
        'fomba_fambolena': "Fafy mivantana anaty andalana. Voafangaro fasika ny masomboly.",
        'fomba_fiavana': "Fanapahana (éclaircissage) rehefa 5cm. Elanelana 5cm isaky ny voly.",
        'fomba_fijinjana': "Rehefa 2-3cm ny savaivony ary mivoaka kely amin'ny tany.",
        'saison': "Ririnina."
      },
      'calc': {'seed_ha': 4.0, 'yield_ha': 30.0, 'manure_ha': 20000.0, 'npk_ha': 300.0, 'urea_ha': 0.0},
      'tasks': [
        {'d': 0, 't': "Famafazana", 'c': Colors.green},
        {'d': 25, 't': "Éclaircissage", 'c': Colors.blue},
        {'d': 50, 't': "Fiavàna", 'c': Colors.blue},
        {'d': 100, 't': "Fihadiana", 'c': Colors.orange}
      ],
      'windows': {'highland': [3, 4, 5, 6, 7], 'default': [4, 5, 6]}
    },
    'baranjely': {
      'name': "Baranjely (Aubergine)",
      'tech': {
        'tany': "Tany lonaka sy mora miboaka rano.",
        'zezika': "Zezi-pahitra betsaka sy NPK.",
        'fomba_fambolena': "Pépinière 40-50 andro. Afindra amin'ny elanelana 60x50cm.",
        'fomba_fiavana': "Fanadiovana ahitra. Fanotofana amin'ny fotony.",
        'fomba_fijinjana': "Rehefa mamirapiratra ny voany ary tsy mbola mafy ny voany.",
        'saison': "Lohataona sy fahavaratra."
      },
      'calc': {'seed_ha': 0.5, 'yield_ha': 25.0, 'manure_ha': 25000.0, 'npk_ha': 400.0, 'urea_ha': 100.0},
      'tasks': [
        {'d': 0, 't': "Famafazana pépinière", 'c': Colors.green},
        {'d': 45, 't': "Fanetsana", 'c': Colors.blue},
        {'d': 70, 't': "Voaloham-bokatra", 'c': Colors.orange},
        {'d': 90, 't': "Fiotazana matetika", 'c': Colors.orange}
      ],
      'windows': {'default': [8, 9, 10, 11]}
    },
    'poireau': {
      'name': "Poireau",
      'tech': {
        'tany': "Tany lonaka sy mora miboaka rano.",
        'zezika': "Zezi-pahitra betsaka. Tia Azote.",
        'fomba_fambolena': "Pépinière 60-80 andro. Afindra anaty lavaka lalina. Buttage matetika.",
        'fomba_fiavana': "Fanotofana (buttage) mba hihabeny ny fotsy.",
        'fomba_fijinjana': "Rehefa lehibe ny fotony (3cm+ savaivo).",
        'saison': "Ririnina."
      },
      'calc': {'seed_ha': 3.0, 'yield_ha': 25.0, 'manure_ha': 30000.0, 'npk_ha': 400.0, 'urea_ha': 150.0},
      'tasks': [
        {'d': 0, 't': "Famafazana pépinière", 'c': Colors.green},
        {'d': 70, 't': "Fanetsana", 'c': Colors.blue},
        {'d': 100, 't': "Buttage 1", 'c': Colors.blue},
        {'d': 130, 't': "Buttage 2", 'c': Colors.blue},
        {'d': 150, 't': "Fijinjana", 'c': Colors.orange}
      ],
      'windows': {'highland': [3, 4, 5], 'default': [4, 5, 6]}
    },
    'voasary': {
      'name': "Voasary (Orange)",
      'tech': {
        'tany': "Tany lalina sy mora miboaka rano. pH 6-7.",
        'zezika': "Zezi-pahitra betsaka sy NPK isaky ny taona.",
        'fomba_fambolena': "Lavaka 60x60x60cm. Elanelana 6-8m. Asiana zezika organika betsaka.",
        'fomba_fiavana': "Fanadiovana ny fotony. Tondrahana raha maina.",
        'fomba_fijinjana': "Rehefa mavo tsara ny voany (3-5 taona).",
        'saison': "Volana Jolay - Oktobra (fambolena)."
      },
      'calc': {'seed_ha': 200.0, 'is_tige': true, 'yield_ha': 20.0, 'manure_ha': 40000.0, 'npk_ha': 600.0, 'urea_ha': 200.0},
      'tasks': [
        {'d': 0, 't': "Fambolena zana-kazo", 'c': Colors.green},
        {'d': 30, 't': "Fanotofana", 'c': Colors.blue},
        {'d': 365, 't': "Zezika taona 1", 'c': Colors.blue},
        {'d': 1095, 't': "Voaloham-bokatra", 'c': Colors.orange}
      ],
      'windows': {'default': [7, 8, 9, 10]}
    },
  };

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 2, vsync: this);
    _selectedCalendarDay = _selectedDate;
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  bool _isGoodMonth(int monthIndex) {
    String type = regionTypes[_selectedRegion] ?? 'default';
    var crop = db[_selectedCrop];
    List<int> wins = crop['windows'][type] ?? crop['windows']['default'];
    return wins.contains(monthIndex + 1);
  }

  List<Map<String, dynamic>> _getTasksForDate(DateTime date) {
    List<Map<String, dynamic>> result = [];
    var tasks = db[_selectedCrop]['tasks'] as List;
    for (var t in tasks) {
      DateTime taskDate = _selectedDate.add(Duration(days: t['d'] as int));
      if (taskDate.year == date.year && taskDate.month == date.month && taskDate.day == date.day) {
        result.add(t as Map<String, dynamic>);
      }
    }
    return result;
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Container(
          color: Colors.green.shade800,
          child: TabBar(
            controller: _tabController,
            labelColor: Colors.white,
            unselectedLabelColor: Colors.white70,
            indicatorColor: Colors.orange,
            tabs: const [
              Tab(icon: Icon(Icons.calendar_month), text: "Tetiandro"),
              Tab(icon: Icon(Icons.calculate), text: "Kajy"),
            ],
          ),
        ),
        Expanded(
          child: TabBarView(
            controller: _tabController,
            children: [
              _buildCalendarTab(),
              _buildCalculatorTab(),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildCalendarTab() {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildControls(),
          const SizedBox(height: 16),
          _buildCalendarBox(),
          const SizedBox(height: 16),
          _buildTechBox(),
        ],
      ),
    );
  }

  Widget _buildControls() {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
      ),
      child: Column(
        children: [
          DropdownButtonFormField<String>(
            decoration: const InputDecoration(labelText: "1. Faritra (Region)", border: OutlineInputBorder(), isDense: true),
            key: ValueKey(_selectedRegion),
            initialValue: _selectedRegion,
            items: regionTypes.keys.map((String value) {
              return DropdownMenuItem<String>(value: value, child: Text(value.toUpperCase(), style: const TextStyle(fontSize: 13)));
            }).toList(),
            onChanged: (v) => setState(() { _selectedRegion = v!; _selectedCalendarDay = null; }),
          ),
          const SizedBox(height: 12),
          DropdownButtonFormField<String>(
            decoration: const InputDecoration(labelText: "2. Voly (Culture)", border: OutlineInputBorder(), isDense: true),
            key: ValueKey(_selectedCrop),
            initialValue: _selectedCrop,
            items: db.keys.map((String value) {
              return DropdownMenuItem<String>(value: value, child: Text(db[value]['name'], style: const TextStyle(fontSize: 13)));
            }).toList(),
            onChanged: (v) => setState(() { _selectedCrop = v!; _selectedCalendarDay = null; }),
          ),
          const SizedBox(height: 12),
          InkWell(
            onTap: () async {
              final DateTime? picked = await showDatePicker(
                context: context, initialDate: _selectedDate, firstDate: DateTime(2020), lastDate: DateTime(2030),
              );
              if (picked != null) setState(() { _selectedDate = picked; _currentCalendarView = picked; _selectedCalendarDay = picked; });
            },
            child: InputDecorator(
              decoration: const InputDecoration(labelText: "3. Daty Famafazana", border: OutlineInputBorder(), isDense: true, suffixIcon: Icon(Icons.calendar_today)),
              child: Text(DateFormat('dd/MM/yyyy').format(_selectedDate)),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCalendarBox() {
    final daysInMonth = DateUtils.getDaysInMonth(_currentCalendarView.year, _currentCalendarView.month);
    final firstDayOfMonth = DateTime(_currentCalendarView.year, _currentCalendarView.month, 1);
    final firstDayOffset = (firstDayOfMonth.weekday % 7);

    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
      ),
      child: Column(
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              IconButton(icon: const Icon(Icons.chevron_left), onPressed: () => setState(() => _currentCalendarView = DateTime(_currentCalendarView.year, _currentCalendarView.month - 1))),
              Flexible(child: Text(DateFormat('MMMM yyyy').format(_currentCalendarView).toUpperCase(), style: const TextStyle(fontWeight: FontWeight.bold), overflow: TextOverflow.ellipsis)),
              IconButton(icon: const Icon(Icons.chevron_right), onPressed: () => setState(() => _currentCalendarView = DateTime(_currentCalendarView.year, _currentCalendarView.month + 1))),
            ],
          ),
          Row(mainAxisAlignment: MainAxisAlignment.center, children: [
            _legendDot(Colors.green.shade100, "Mety"),
            const SizedBox(width: 15),
            _legendDot(Colors.red.shade100, "Tsy mety"),
          ]),
          const SizedBox(height: 8),
          Row(
            children: ['D', 'L', 'M', 'M', 'J', 'V', 'S'].map((d) => Expanded(
              child: Center(child: Text(d, style: TextStyle(fontWeight: FontWeight.bold, color: Colors.grey.shade600, fontSize: 12))),
            )).toList(),
          ),
          const SizedBox(height: 4),
          GridView.builder(
            shrinkWrap: true,
            physics: const NeverScrollableScrollPhysics(),
            gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(crossAxisCount: 7, childAspectRatio: 1),
            itemCount: daysInMonth + firstDayOffset,
            itemBuilder: (context, index) {
              if (index < firstDayOffset) return Container();
              final day = index - firstDayOffset + 1;
              final date = DateTime(_currentCalendarView.year, _currentCalendarView.month, day);
              
              bool isGood = _isGoodMonth(date.month - 1);
              bool isSelected = _selectedCalendarDay != null && 
                _selectedCalendarDay!.year == date.year && 
                _selectedCalendarDay!.month == date.month && 
                _selectedCalendarDay!.day == date.day;
              var tasksOnDay = _getTasksForDate(date);

              return GestureDetector(
                onTap: () => setState(() => _selectedCalendarDay = date),
                child: Container(
                  margin: const EdgeInsets.all(2),
                  decoration: BoxDecoration(
                    color: isSelected ? Colors.orange.shade100 : (isGood ? Colors.green.shade50 : Colors.red.shade50),
                    border: Border.all(color: isSelected ? Colors.orange : (isGood ? Colors.green.shade200 : Colors.red.shade100)),
                    borderRadius: BorderRadius.circular(6),
                  ),
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Text("$day", style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12, color: isSelected ? Colors.orange.shade800 : Colors.black87)),
                      if (tasksOnDay.isNotEmpty)
                        Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: tasksOnDay.take(2).map((t) => Container(
                            margin: const EdgeInsets.only(top: 2, right: 2),
                            width: 6, height: 6,
                            decoration: BoxDecoration(color: t['c'] as Color, shape: BoxShape.circle),
                          )).toList(),
                        )
                    ],
                  ),
                ),
              );
            },
          ),
          if (_selectedCalendarDay != null) ...[
            const Divider(),
            Container(
              width: double.infinity,
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(color: Colors.grey.shade100, borderRadius: BorderRadius.circular(8)),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text("📅 ${DateFormat('dd/MM/yyyy').format(_selectedCalendarDay!)}", style: TextStyle(fontWeight: FontWeight.bold, color: Colors.green.shade700)),
                  const SizedBox(height: 4),
                  ..._buildTaskDetailsForSelectedDay()
                ],
              ),
            )
          ]
        ],
      ),
    );
  }

  List<Widget> _buildTaskDetailsForSelectedDay() {
    var tasks = _getTasksForDate(_selectedCalendarDay!);
    if (tasks.isEmpty) return [const Text("Tsy misy asa voatondro.", style: TextStyle(color: Colors.grey, fontSize: 13))];
    return tasks.map((t) => Padding(
      padding: const EdgeInsets.only(top: 4),
      child: Row(
        children: [
          Container(width: 8, height: 8, decoration: BoxDecoration(color: t['c'] as Color, shape: BoxShape.circle)),
          const SizedBox(width: 8),
          Text("${t['t']}", style: const TextStyle(fontSize: 13)),
        ],
      ),
    )).toList();
  }

  Widget _legendDot(Color color, String text) {
    return Row(mainAxisSize: MainAxisSize.min, children: [Container(width: 12, height: 12, decoration: BoxDecoration(color: color, borderRadius: BorderRadius.circular(3))), const SizedBox(width: 4), Flexible(child: Text(text, style: const TextStyle(fontSize: 11), overflow: TextOverflow.ellipsis))]);
  }

  Widget _buildTechBox() {
    final cropData = db[_selectedCrop];
    final tech = cropData['tech'] as Map<String, dynamic>;

    return Container(
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
      ),
      child: Column(
        children: [
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(color: Colors.orange.shade700, borderRadius: const BorderRadius.only(topLeft: Radius.circular(12), topRight: Radius.circular(12))),
            child: Text("📘 Torolalana Teknika - ${cropData['name']}", style: const TextStyle(color: Colors.white, fontSize: 15, fontWeight: FontWeight.bold)),
          ),
          Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                _techSection("🌍 Tany", tech['tany'] ?? ''),
                _techSection("🌱 Fomba Fambolena", tech['fomba_fambolena'] ?? ''),
                _techSection("🧪 Zezika", tech['zezika'] ?? ''),
                _techSection("🛠️ Fikarakarana", tech['fomba_fiavana'] ?? ''),
                _techSection("🌾 Fijinjana", tech['fomba_fijinjana'] ?? ''),
                _techSection("📅 Saison", tech['saison'] ?? ''),
                if (tech.containsKey('fady') && tech['fady'] != null)
                  Container(
                    margin: const EdgeInsets.only(top: 8),
                    padding: const EdgeInsets.all(10),
                    decoration: BoxDecoration(color: Colors.red.shade50, border: Border.all(color: Colors.red.shade200), borderRadius: BorderRadius.circular(8)),
                    child: Row(
                      children: [
                        const Text("⚠️ ", style: TextStyle(fontSize: 16)),
                        Expanded(child: Text("FADY: ${tech['fady']}", style: TextStyle(color: Colors.red.shade800, fontWeight: FontWeight.w500, fontSize: 13))),
                      ],
                    ),
                  )
              ],
            ),
          )
        ],
      ),
    );
  }

  Widget _techSection(String title, String content) {
    if (content.isEmpty) return const SizedBox.shrink();
    return Padding(
      padding: const EdgeInsets.only(bottom: 10),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(title, style: TextStyle(color: Colors.green.shade800, fontWeight: FontWeight.bold, fontSize: 13)),
          const SizedBox(height: 2),
          Text(content, style: const TextStyle(color: Colors.black87, fontSize: 13, height: 1.3)),
        ],
      ),
    );
  }

  Widget _buildCalculatorTab() {
    final cropData = db[_selectedCrop];
    final calc = cropData['calc'] as Map<String, dynamic>;
    
    double ratio = _surfaceArea / 10000;
    
    String seedVal = "";
    String seedUnit = "Kg";
    if (calc.containsKey('is_tige') && calc['is_tige'] == true) {
      seedVal = (calc['seed_ha'] * ratio).round().toString();
      seedUnit = "Taho";
    } else {
      seedVal = (calc['seed_ha'] * ratio).toStringAsFixed(1);
    }
    
    String yieldVal = (calc['yield_ha'] * ratio).toStringAsFixed(2);

    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.green.shade700, Colors.green.shade500]),
              borderRadius: BorderRadius.circular(12),
            ),
            child: Column(
              children: [
                const Text("🧮 Kajy Fambolena", style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                Text(cropData['name'], style: const TextStyle(color: Colors.white70)),
              ],
            ),
          ),
          const SizedBox(height: 16),
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Column(
              children: [
                const Text("Velaran-tany (m²)", style: TextStyle(fontWeight: FontWeight.bold, color: Colors.green)),
                const SizedBox(height: 8),
                TextFormField(
                  initialValue: _surfaceArea.toStringAsFixed(0),
                  keyboardType: TextInputType.number,
                  decoration: const InputDecoration(border: OutlineInputBorder(), suffixText: "m²", isDense: true),
                  onChanged: (v) => setState(() => _surfaceArea = double.tryParse(v) ?? 0),
                ),
                const SizedBox(height: 4),
                const Text("1 Hectare = 10 000 m²", style: TextStyle(fontSize: 11, color: Colors.grey)),
              ],
            ),
          ),
          const SizedBox(height: 16),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.green.shade50,
              borderRadius: BorderRadius.circular(12),
            ),
            child: Column(
              children: [
                const Text("🌾 Masomboly & Vokatra", style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                const Divider(),
                _rowCalc("Mila Masomboly:", "$seedVal $seedUnit"),
                _rowCalc("Vokatra Vinavinaina:", "$yieldVal Tonnes"),
              ],
            ),
          ),
          const SizedBox(height: 16),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.amber.shade50,
              borderRadius: BorderRadius.circular(12),
            ),
            child: Column(
              children: [
                const Text("🧪 Zezika Ilaina", style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                const Divider(),
                if (calc.containsKey('manure_ha') && (calc['manure_ha'] as double) > 0)
                  _rowCalc("Zezi-pahitra:", "${((calc['manure_ha'] as double) * ratio).toStringAsFixed(0)} Kg"),
                if (calc.containsKey('npk_ha') && (calc['npk_ha'] as double) > 0)
                  _rowCalc("NPK:", "${((calc['npk_ha'] as double) * ratio).toStringAsFixed(1)} Kg"),
                if (calc.containsKey('urea_ha') && (calc['urea_ha'] as double) > 0)
                  _rowCalc("Urée:", "${((calc['urea_ha'] as double) * ratio).toStringAsFixed(1)} Kg"),
                if (calc.containsKey('dolomite') && (calc['dolomite'] as double) > 0)
                  _rowCalc("Dolomita:", "${((calc['dolomite'] as double) * ratio).toStringAsFixed(1)} Kg"),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _rowCalc(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 6),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label, style: TextStyle(color: Colors.grey.shade700)),
          Text(value, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
        ],
      ),
    );
  }
}

// --- FAMBOLENA SOIL SCREEN (Tany) ---
class FambolenaSoilScreen extends StatelessWidget {
  const FambolenaSoilScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final soilTypes = [
      {
        'name': 'Tany fasika',
        'emoji': '🏜️',
        'color': Colors.amber,
        'characteristics': ['Malefaka, mora andehanan\'ny rano', 'Tsy mitana rano sy zezika', 'Mora iasana'],
        'suitable': ['Voanjo', 'Mangahazo', 'Patate douce'],
        'improve': 'Ampio zezika organika sy compost mba hitana ny rano sy ny otrikaina',
      },
      {
        'name': 'Tany tanimanga',
        'emoji': '🧱',
        'color': Colors.brown,
        'characteristics': ['Mavesatra, mafy rehefa maina', 'Mitana rano be loatra', 'Sarotra iasana'],
        'suitable': ['Vary', 'Anana'],
        'improve': 'Ampio fasika sy zezika organika mba hampiditra rivotra',
      },
      {
        'name': 'Tany mena',
        'emoji': '🔴',
        'color': Colors.red,
        'characteristics': ['Misy siramamy vy', 'Antonony ny fitanana rano', 'Tena mahazatra eto Madagasikara'],
        'suitable': ['Katsaka', 'Mangahazo', 'Voanjo', 'Tsaramaso'],
        'improve': 'Ampio zezika organika sy kalsioma raha ilaina',
      },
      {
        'name': 'Tany mainty (Humus)',
        'emoji': '🌑',
        'color': Colors.grey.shade800,
        'characteristics': ['Manankarena otrikaina', 'Tsara fitana rano', 'Malefaka sy mora iasana'],
        'suitable': ['Voly rehetra', 'Anana', 'Voatabia', 'Tsaramaso'],
        'improve': 'Efa tsara! Tantano amin\'ny fampiasana zezika organika foana',
      },
    ];

    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.brown.shade700, Colors.brown.shade500]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: const Column(
              children: [
                Text('🪨', style: TextStyle(fontSize: 40)),
                Text('Karazana Tany', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.bold)),
                Text('Fahafantarana ny tany sy ny fampiasana azy', style: TextStyle(color: Colors.white70)),
              ],
            ),
          ),
          const SizedBox(height: 16),
          ...soilTypes.map((soil) => Container(
            width: double.infinity,
            margin: const EdgeInsets.only(bottom: 16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(16),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 10)],
            ),
            child: Column(
              children: [
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: (soil['color'] as Color).withValues(alpha: 0.2),
                    borderRadius: const BorderRadius.vertical(top: Radius.circular(16)),
                  ),
                  child: Row(
                    children: [
                      Text(soil['emoji'] as String, style: const TextStyle(fontSize: 30)),
                      const SizedBox(width: 12),
                      Text(soil['name'] as String, style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                    ],
                  ),
                ),
                Padding(
                  padding: const EdgeInsets.all(16),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('📋 Toetrany:', style: TextStyle(fontWeight: FontWeight.bold)),
                      const SizedBox(height: 4),
                      ...(soil['characteristics'] as List).map((c) => Padding(
                        padding: const EdgeInsets.only(left: 8, bottom: 4),
                        child: Row(
                          children: [const Text('• '), Expanded(child: Text(c as String))],
                        ),
                      )),
                      const SizedBox(height: 12),
                      const Text('🌱 Voly mety:', style: TextStyle(fontWeight: FontWeight.bold)),
                      const SizedBox(height: 4),
                      Wrap(
                        spacing: 6,
                        runSpacing: 6,
                        children: (soil['suitable'] as List).map((s) => Container(
                          padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                          decoration: BoxDecoration(
                            color: Colors.green.shade100,
                            borderRadius: BorderRadius.circular(12),
                          ),
                          child: Text(s as String, style: TextStyle(color: Colors.green.shade800, fontSize: 12)),
                        )).toList(),
                      ),
                      const SizedBox(height: 12),
                      Container(
                        padding: const EdgeInsets.all(10),
                        decoration: BoxDecoration(
                          color: Colors.blue.shade50,
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Row(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text('💡 '),
                            Expanded(child: Text(soil['improve'] as String, style: const TextStyle(fontSize: 13))),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          )),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.green.shade50,
              borderRadius: BorderRadius.circular(16),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('🌿 Zezika sy Otrikaina', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                const SizedBox(height: 12),
                _buildFertilizerItem('NPK 15-15-15', 'Zezika simika mitambatra - Azota, Fosifora, Potasioma'),
                _buildFertilizerItem('Urée (46-0-0)', 'Zezika azota - Mampitombo ravina'),
                _buildFertilizerItem('Zezika omby', 'Zezika organika - Mampitombo ny humus'),
                _buildFertilizerItem('Kompositra', 'Zezika organika avy amin\'ny fako voahodina'),
                _buildFertilizerItem('Dolomie', 'Mampiditra kalsioma sy magnésioma'),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildFertilizerItem(String name, String desc) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 10),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            padding: const EdgeInsets.all(6),
            decoration: BoxDecoration(
              color: Colors.green.shade200,
              borderRadius: BorderRadius.circular(8),
            ),
            child: const Text('🧪', style: TextStyle(fontSize: 16)),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(name, style: const TextStyle(fontWeight: FontWeight.bold)),
                Text(desc, style: TextStyle(fontSize: 13, color: Colors.grey.shade600)),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

// --- FAMBOLENA PESTS SCREEN (Bibikely) ---
class FambolenaPestsScreen extends StatelessWidget {
  const FambolenaPestsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    // Bibikely mahasoa - Tsy tokony hovonoina!
    final beneficialInsects = [
      {
        'name': 'Tantely (Abeilles)',
        'emoji': '🐝',
        'role': 'Pollinisateur',
        'benefit': 'Manampy amin\'ny fampakaram-boan\'ny voly (voatabia, voatango, mangahazo...)',
        'protect': 'Aza mampiasa insecticide amin\'ny ora fivoahan\'izy ireo (maraina sy tolakandro)',
      },
      {
        'name': 'Lolo (Papillons)',
        'emoji': '🦋',
        'role': 'Pollinisateur',
        'benefit': 'Manampy amin\'ny fampakaram-boa, ary ny kankana sasany dia mihinana bibikely ratsy',
        'protect': 'Avelao hisy voninkazo eo amin\'ny saha mba hihinanany',
      },
      {
        'name': 'Coccinelle (Ladybug)',
        'emoji': '🐞',
        'role': 'Mpamono bibikely ratsy',
        'benefit': 'Iray coccinelle dia afaka mihinana 50-60 pucerons isan\'andro!',
        'protect': 'Aza mampiasa insecticide chimique, fa mety ho faty koa izy ireo',
      },
      {
        'name': 'Sahona (Grenouilles)',
        'emoji': '🐸',
        'role': 'Mpamono bibikely ratsy',
        'benefit': 'Mihinana moka, lalitra, ary bibikely hafa mpanimba voly',
        'protect': 'Avelao hisy toerana mando sy ahi-maitso eo akaikin\'ny saha',
      },
      {
        'name': 'Vitsika (Fourmis)',
        'emoji': '🐜',
        'role': 'Manadio sy mpanapotika',
        'benefit': 'Manadio ny saha amin\'ny fako, manampy amin\'ny fanariam-pako organika',
        'protect': 'Aza vonoina daholo, fa jereo aloha raha tena manimba na tsia',
      },
      {
        'name': 'Ver de terre (Olikazo)',
        'emoji': '🪱',
        'role': 'Mpanatsara tany',
        'benefit': 'Manadio sy mampiditra rivotra ao anaty tany, mamokatra zezika (humus)',
        'protect': 'Aza mampiasa produit chimique be loatra, ary avelao hisy ravina maina eo ambonin\'ny tany',
      },
      {
        'name': 'Araigne (Hala)',
        'emoji': '🕷️',
        'role': 'Mpamono bibikely ratsy',
        'benefit': 'Misambotra moka, lalitra, ary bibikely hafa amin\'ny tranom-balany',
        'protect': 'Avelao hisy eo amin\'ny saha, satria mpiaro voly izy ireo',
      },
    ];

    final pests = [
      {
        'name': 'Valala',
        'emoji': '🦗',
        'affected': ['Vary', 'Katsaka', 'Anana'],
        'symptoms': ['Ravina voatapaka', 'Voa simba', 'Tahony fotsy'],
        'prevention': 'Fanaraha-maso tsy tapaka, fampiasana harona fitazona',
        'treatment': 'Insecticide (Deltamethrine) na fanenjehana ara-biolojika',
        'natural': 'Mamela vorona hihinana azy (akanga, gisa...)',
      },
      {
        'name': 'Bibikely fotsy (Pucerons)',
        'emoji': '🐛',
        'affected': ['Voatabia', 'Anana', 'Tsaramaso'],
        'symptoms': ['Ravina mihodina', 'Miely ranon-javatra mamy', 'Misy vitsika manaraka azy'],
        'prevention': 'Fambolena zava-maniry manery azy (basilic, ail)',
        'treatment': 'Rano savony na insecticide naturel (huile de neem)',
        'natural': 'Coccinelle: 1 coccinelle = 50 pucerons/andro!',
      },
      {
        'name': 'Haintso (Chenilles)',
        'emoji': '🐛',
        'affected': ['Anana', 'Katsaka', 'Voatabia'],
        'symptoms': ['Ravina misy lavaka', 'Tàhony voahidy'],
        'prevention': 'Esory amin\'ny tanana, fampiasana harona fiarovana',
        'treatment': 'Bacillus thuringiensis (Bt) - ara-biolojika',
        'natural': 'Vorona sy sahona dia mihinana haintso betsaka',
      },
      {
        'name': 'Holatra (Champignons)',
        'emoji': '🍄‍🟫',
        'affected': ['Vary', 'Voatabia', 'Mangahazo'],
        'symptoms': ['Peta mainty na fotsy', 'Ravina mavo', 'Fahoriana'],
        'prevention': 'Elanelana tsara, aza mandena ravina',
        'treatment': 'Bouillie bordelaise (naturel) na Fongicide',
        'natural': 'Fanafody ail: 100g ail + 1L rano, avelao 24h, araraho',
      },
      {
        'name': 'Voalavo',
        'emoji': '🐀',
        'affected': ['Vary', 'Katsaka', 'Mangahazo'],
        'symptoms': ['Voa lanin\'ny voalavo', 'Tàhony voakaikitra'],
        'prevention': 'Fanadiovana saha, fametrahana fandrika',
        'treatment': 'Fandrika na saka',
        'natural': 'Vorondolo (hibou) sy bibilava: mpiaro saha mahomby!',
      },
    ];

    final diseases = [
      {
        'name': 'Pyriculariose (Vary)',
        'emoji': '🌾',
        'symptoms': 'Peta mainty amin\'ny ravina, tàhony fotsy, voa tsy feno',
        'treatment': 'Fongicide (Tricyclazole), masomboly mahatanty',
      },
      {
        'name': 'Mildiou (Voatabia)',
        'emoji': '🍅',
        'symptoms': 'Peta mainty, ravina maina, voankazo misy peta',
        'treatment': 'Bouillie bordelaise, Mancozèbe',
      },
      {
        'name': 'Mosaïque (Mangahazo)',
        'emoji': '🥔',
        'symptoms': 'Ravina misy sary mosaic, fivoarana tsy ara-dalàna',
        'treatment': 'Tsy azo sitranina - Esory ny zava-maniry marary, masomboly madio',
      },
    ];

    // Permaculture techniques
    final permaculture = [
      {
        'name': 'Fambolena Mifanaraka (Compagnonnage)',
        'emoji': '🌻',
        'description': 'Mamboly zava-maniry mifanampy eo akaikin\'ny',
        'examples': [
          'Katsaka + Tsaramaso + Voatango (Three Sisters)',
          'Voatabia + Basilic (manala pucerons)',
          'Karoty + Tongolo (manala bibikely)',
          'Vary + Azolla (zezika naturel)',
        ],
      },
      {
        'name': 'Fanaronana Tany (Paillage/Mulching)',
        'emoji': '🍂',
        'description': 'Mandrakotra ny tany amin\'ny ravina maina, bozaka...',
        'examples': [
          'Mitahiry ny hamandoana',
          'Miaro amin\'ny masoandro mahamay',
          'Misakana ahitra tsy ilaina',
          'Lasa zezika rehefa lo',
        ],
      },
      {
        'name': 'Fiodinana Voly (Rotation)',
        'emoji': '🔄',
        'description': 'Manova voly isaky ny taom-pamokarana',
        'examples': [
          'Taona 1: Tsaramaso (manampy azote)',
          'Taona 2: Katsaka (mila azote)',
          'Taona 3: Mangahazo (manadio tany)',
          'Taona 4: Vary na Anana',
        ],
      },
      {
        'name': 'Zezika Organika (Compost)',
        'emoji': '♻️',
        'description': 'Manamboatra zezika avy amin\'ny fako organika',
        'examples': [
          'Ravina maina + Tain\'omby + Rano',
          'Avelao 2-3 volana ho lo',
          'Hafaro isan-kerinandro',
          'Fofona ratsy = milaina azote (ampiana ravina maitso)',
        ],
      },
      {
        'name': 'Fambolena Avo (Buttes/Raised beds)',
        'emoji': '⛰️',
        'description': 'Mamboly eo ambony vohitra kely',
        'examples': [
          'Tsy mila miasa tany lalina',
          'Rano mikoriana tsara',
          'Tany mafana kokoa',
          'Mora jerena sy karakaraina',
        ],
      },
      {
        'name': 'Rano tsy very (Récupération d\'eau)',
        'emoji': '💧',
        'description': 'Mitahiry sy mampiasa rano avy amin\'ny orana',
        'examples': [
          'Fako lehibe hitehirizan-drano orana',
          'Fantsona-drano mankany amin\'ny saha',
          'Swales: dobo lalina mitahiry rano',
          'Fampiasana rano entim-pisakafoanana',
        ],
      },
    ];

    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.green.shade700, Colors.teal.shade600]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: const Column(
              children: [
                Text('🌿', style: TextStyle(fontSize: 40)),
                Text('Bibikely, Permaculture & Aretina', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.bold)),
                Text('Fambolena ara-boajanahary sy maharitra', style: TextStyle(color: Colors.white70)),
              ],
            ),
          ),
          
          // FAMPITANDREMANA LEHIBE
          const SizedBox(height: 16),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.amber.shade100,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: Colors.amber.shade700, width: 2),
            ),
            child: Column(
              children: [
                Row(
                  children: [
                    const Text('⚠️', style: TextStyle(fontSize: 28)),
                    const SizedBox(width: 10),
                    Expanded(
                      child: Text(
                        'FAMPITANDREMANA: Aza mamono bibikely rehetra!',
                        style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold, color: Colors.amber.shade900),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 10),
                Text(
                  '🔍 JEREO ALOHA ny bibikely alohan\'ny hampiasa insecticide:\n'
                  '• Mety ho bibikely MAHASOA izy (tantely, coccinelle, sahona...)\n'
                  '• Mety ho tsy MANIMBA ny volinao izy\n'
                  '• Ny insecticide dia mamono ny RATSY sy ny TSARA daholo!',
                  style: TextStyle(fontSize: 13, color: Colors.amber.shade900),
                ),
                const SizedBox(height: 10),
                Container(
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(10),
                  ),
                  child: const Text(
                    '💡 Raha tsy fantatra: Alao sary ny bibikely, anontanio olona mahay na mandeha amin\'ny internety mba hamantarana azy.',
                    style: TextStyle(fontSize: 12, fontStyle: FontStyle.italic),
                  ),
                ),
              ],
            ),
          ),

          // BIBIKELY MAHASOA
          const SizedBox(height: 20),
          const Align(
            alignment: Alignment.centerLeft,
            child: Text('🐝 Bibikely MAHASOA - Aza vonoina!', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.green)),
          ),
          const SizedBox(height: 8),
          const Text(
            'Ireto bibikely ireto dia mpiara-miasa aminao! Manampy amin\'ny fambolena izy ireo.',
            style: TextStyle(fontSize: 13, color: Colors.grey),
          ),
          const SizedBox(height: 12),
          ...beneficialInsects.map((insect) => Container(
            width: double.infinity,
            margin: const EdgeInsets.only(bottom: 12),
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.green.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.green.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text(insect['emoji'] as String, style: const TextStyle(fontSize: 28)),
                    const SizedBox(width: 10),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(insect['name'] as String, style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                            decoration: BoxDecoration(color: Colors.green.shade100, borderRadius: BorderRadius.circular(8)),
                            child: Text(insect['role'] as String, style: TextStyle(fontSize: 11, color: Colors.green.shade700)),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                Text('✨ ${insect['benefit']}', style: const TextStyle(fontSize: 13)),
                const SizedBox(height: 4),
                Text('🛡️ ${insect['protect']}', style: TextStyle(fontSize: 12, color: Colors.green.shade700, fontStyle: FontStyle.italic)),
              ],
            ),
          )),

          // PERMACULTURE
          const SizedBox(height: 20),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.teal.shade600, Colors.green.shade600]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: const Column(
              children: [
                Text('🌱', style: TextStyle(fontSize: 36)),
                Text('PERMACULTURE', style: TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.bold)),
                Text('Fambolena ara-boajanahary sy maharitra', style: TextStyle(color: Colors.white70, fontSize: 13)),
                SizedBox(height: 8),
                Text(
                  'Tsy mila insecticide na zezika chimique!\nMifanohana ny zava-maniry sy ny biby.',
                  style: TextStyle(color: Colors.white, fontSize: 12),
                  textAlign: TextAlign.center,
                ),
              ],
            ),
          ),
          const SizedBox(height: 12),
          ...permaculture.map((tech) => Container(
            width: double.infinity,
            margin: const EdgeInsets.only(bottom: 12),
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text(tech['emoji'] as String, style: const TextStyle(fontSize: 28)),
                    const SizedBox(width: 10),
                    Expanded(child: Text(tech['name'] as String, style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold))),
                  ],
                ),
                const SizedBox(height: 6),
                Text(tech['description'] as String, style: TextStyle(fontSize: 13, color: Colors.grey.shade600)),
                const SizedBox(height: 8),
                ...(tech['examples'] as List).map((ex) => Padding(
                  padding: const EdgeInsets.only(left: 8, bottom: 4),
                  child: Row(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text('• ', style: TextStyle(color: Colors.teal.shade700)),
                      Expanded(child: Text(ex as String, style: const TextStyle(fontSize: 13))),
                    ],
                  ),
                )),
              ],
            ),
          )),

          // BIBIKELY MPANIMBA
          const SizedBox(height: 20),
          const Align(
            alignment: Alignment.centerLeft,
            child: Text('🦗 Bibikely MPANIMBA', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.red)),
          ),
          const SizedBox(height: 8),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.blue.shade50,
              borderRadius: BorderRadius.circular(10),
            ),
            child: const Text(
              '💡 Toro-hevitra: Andrao aloha ny fomba NATUREL alohan\'ny hampiasa insecticide chimique!',
              style: TextStyle(fontSize: 12, fontWeight: FontWeight.w500),
            ),
          ),
          const SizedBox(height: 12),
          ...pests.map((pest) => Container(
            width: double.infinity,
            margin: const EdgeInsets.only(bottom: 12),
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text(pest['emoji'] as String, style: const TextStyle(fontSize: 24)),
                    const SizedBox(width: 10),
                    Text(pest['name'] as String, style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                  ],
                ),
                const SizedBox(height: 8),
                Wrap(
                  spacing: 6,
                  children: (pest['affected'] as List).map((a) => Container(
                    padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                    decoration: BoxDecoration(color: Colors.red.shade100, borderRadius: BorderRadius.circular(8)),
                    child: Text(a as String, style: TextStyle(fontSize: 11, color: Colors.red.shade700)),
                  )).toList(),
                ),
                const SizedBox(height: 8),
                Text('🔍 Soritr\'aretina:', style: TextStyle(fontWeight: FontWeight.w600, color: Colors.grey.shade700, fontSize: 13)),
                ...(pest['symptoms'] as List).map((s) => Padding(
                  padding: const EdgeInsets.only(left: 12),
                  child: Text('• $s', style: const TextStyle(fontSize: 13)),
                )),
                const SizedBox(height: 6),
                Text('🛡️ Fisorohana: ${pest['prevention']}', style: const TextStyle(fontSize: 13)),
                Container(
                  margin: const EdgeInsets.only(top: 6),
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: Colors.green.shade50,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('🌿 ', style: TextStyle(fontSize: 14)),
                      Expanded(child: Text('Naturel: ${pest['natural']}', style: TextStyle(fontSize: 12, color: Colors.green.shade700))),
                    ],
                  ),
                ),
                const SizedBox(height: 4),
                Text('💊 Fitsaboana: ${pest['treatment']}', style: TextStyle(fontSize: 12, color: Colors.grey.shade600)),
              ],
            ),
          )),

          // ARETINA VOLY
          const SizedBox(height: 16),
          const Align(
            alignment: Alignment.centerLeft,
            child: Text('🦠 Aretina Voly', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
          ),
          const SizedBox(height: 12),
          ...diseases.map((disease) => Container(
            width: double.infinity,
            margin: const EdgeInsets.only(bottom: 12),
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.orange.shade50,
              borderRadius: BorderRadius.circular(12),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text(disease['emoji'] as String, style: const TextStyle(fontSize: 24)),
                    const SizedBox(width: 10),
                    Expanded(child: Text(disease['name'] as String, style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold))),
                  ],
                ),
                const SizedBox(height: 8),
                Text('🔍 ${disease['symptoms']}', style: const TextStyle(fontSize: 13)),
                const SizedBox(height: 4),
                Text('💊 ${disease['treatment']}', style: TextStyle(fontSize: 13, color: Colors.green.shade700)),
              ],
            ),
          )),

          // TORO-HEVITRA ANKAPOBENY
          const SizedBox(height: 16),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.blue.shade50,
              borderRadius: BorderRadius.circular(16),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('🛡️ Toro-hevitra Fisorohana Ankapobeny', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                const SizedBox(height: 12),
                _buildTip('Jereo aloha', 'Fantaro ny bibikely alohan\'ny hamono azy - mety mahasoa izy!'),
                _buildTip('Naturel aloha', 'Andrao aloha ny fomba naturel alohan\'ny chimique'),
                _buildTip('Fiodinana voly', 'Aza mamerina voly iray mitovy eo amin\'ny tany iray'),
                _buildTip('Elanelana tsara', 'Mamela rivotra tsara hiditra eo amin\'ny zava-maniry'),
                _buildTip('Fambolena mifanaraka', 'Ataovy mifanila ny voly mifanampy'),
                _buildTip('Fanadiovana saha', 'Esory ny zava-maniry marary sy ny fako'),
                _buildTip('Fanaraha-maso tsy tapaka', 'Jereo isan\'andro ny voly mba hahitana olana haingana'),
              ],
            ),
          ),

          // FANAFODY NATUREL
          const SizedBox(height: 16),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.green.shade50,
              borderRadius: BorderRadius.circular(16),
              border: Border.all(color: Colors.green.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('🧪 Fanafody Naturel', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                const SizedBox(height: 12),
                _buildRecipe('Rano Savony', '1L rano + 1 sotro savony (tsy misy parfum) → Araraho amin\'ny pucerons'),
                _buildRecipe('Ail Spray', '100g ail voatoto + 1L rano → Avelao 24h → Tsorohy → Araraho'),
                _buildRecipe('Neem Oil', '10ml huile de neem + 1L rano + kely savony → Araraho hariva'),
                _buildRecipe('Piment Spray', '50g piment + 1L rano → Avelao 24h → Araraho (insecticide naturel)'),
                _buildRecipe('Cendre', 'Aelezo lavenona manodidina ny voly (miaro amin\'ny olitra sy holatra)'),
              ],
            ),
          ),
          const SizedBox(height: 20),
        ],
      ),
    );
  }

  Widget _buildTip(String title, String desc) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 10),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text('✅ '),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title, style: const TextStyle(fontWeight: FontWeight.bold)),
                Text(desc, style: TextStyle(fontSize: 13, color: Colors.grey.shade600)),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildRecipe(String name, String recipe) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 10),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text('🌿 '),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(name, style: const TextStyle(fontWeight: FontWeight.bold)),
                Text(recipe, style: TextStyle(fontSize: 12, color: Colors.grey.shade700)),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

// ==================== FIKAJIANA & TOMBONY DIALOG (COMBINED) ====================
class FikajianaTombonyDialog extends StatefulWidget {
  const FikajianaTombonyDialog({super.key});

  @override
  State<FikajianaTombonyDialog> createState() => _FikajianaTombonyDialogState();
}

class _FikajianaTombonyDialogState extends State<FikajianaTombonyDialog> with SingleTickerProviderStateMixin {
  late TabController _tabController;

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 2, vsync: this);
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      backgroundColor: Colors.transparent,
      insetPadding: const EdgeInsets.all(16),
      child: Container(
        width: double.infinity,
        height: MediaQuery.of(context).size.height * 0.85,
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(20),
        ),
        child: Column(
          children: [
            // Header
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [Colors.blue.shade700, Colors.indigo.shade700],
                ),
                borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
              ),
              child: Column(
                children: [
                  Row(
                    children: [
                      const Text('📊', style: TextStyle(fontSize: 28)),
                      const SizedBox(width: 12),
                      const Expanded(
                        child: Text(
                          'FIKAJIANA & TOMBONY',
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ),
                      IconButton(
                        icon: const Icon(Icons.close, color: Colors.white),
                        onPressed: () => Navigator.pop(context),
                      ),
                    ],
                  ),
                  const SizedBox(height: 12),
                  // Tabs
                  Container(
                    decoration: BoxDecoration(
                      color: Colors.white.withValues(alpha: 0.2),
                      borderRadius: BorderRadius.circular(25),
                    ),
                    child: TabBar(
                      controller: _tabController,
                      indicator: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(25),
                      ),
                      labelColor: Colors.indigo.shade700,
                      unselectedLabelColor: Colors.white,
                      labelStyle: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12),
                      tabs: const [
                        Tab(text: '🧮 FIKAJIANA'),
                        Tab(text: '💰 TOMBONY'),
                      ],
                    ),
                  ),
                ],
              ),
            ),
            
            // Tab content
            Expanded(
              child: TabBarView(
                controller: _tabController,
                children: [
                  // Tab 1: FIKAJIANA (Calculateurs)
                  _buildFikajanaTab(),
                  
                  // Tab 2: TOMBONY (Profitability)
                  _buildTombonyTab(),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildFikajanaTab() {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Pricing Calculator
          const Text('💵 FIKAJIANA VIDINY', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
          const SizedBox(height: 8),
          Card(
            child: ListTile(
              leading: Container(
                padding: const EdgeInsets.all(8),
                decoration: BoxDecoration(
                  color: Colors.green.shade100,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: const Text('💰', style: TextStyle(fontSize: 20)),
              ),
              title: const Text('Kajy Vidiny Fivarotana', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
              subtitle: const Text('Hitady ny vidiny mety araka ny margin', style: TextStyle(fontSize: 11)),
              trailing: const Icon(Icons.arrow_forward_ios, size: 16),
              onTap: () {
                Navigator.pop(context);
                showDialog(context: context, builder: (context) => const PricingDialog());
              },
            ),
          ),
          
          const SizedBox(height: 16),
          
          // Animal calculators
          const Text('🐄 FIKAJIANA FIOMPIANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
          const SizedBox(height: 8),
          
          _buildCalcCard('🐔', 'Akoho', 'Vola lany, vokatra, tombony', Colors.orange, () {
            Navigator.pop(context);
            _showAkohoCalculator(context);
          }),
          _buildCalcCard('🐇', 'Bitro', 'Reniny, zanaka, tombony isan-taona', Colors.brown, () {
            Navigator.pop(context);
            _showBitroCalculator(context);
          }),
          _buildCalcCard('🐷', 'Kisoa', 'Zana-kisoa, sakafo, hena', Colors.pink, () {
            Navigator.pop(context);
            _showKisoaCalculator(context);
          }),
          _buildCalcCard('🐟', 'Trondro', 'Zana-trondro, FCR, tombony', Colors.blue, () {
            Navigator.pop(context);
            _showTrondroCalculator(context);
          }),
          _buildCalcCard('🐝', 'Tantely', 'Toho, essaim, vokatra', Colors.amber, () {
            Navigator.pop(context);
            _showTantelyCalculator(context);
          }),
          _buildCalcCard('🦆', 'Olitra', 'Ganagana, vorona, tombony', Colors.teal, () {
            Navigator.pop(context);
            _showOlitraCalculator(context);
          }),
          
          const SizedBox(height: 16),
          
          // Fambolena calculators
          const Text('🌱 FIKAJIANA FAMBOLENA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
          const SizedBox(height: 8),
          
          _buildCalcCard('🧪', 'Zezika', 'Fatra zezika ilaina, vidiny', Colors.grey, () {
            Navigator.pop(context);
            _showZezikaCalculator(context);
          }),
          _buildCalcCard('🌱', 'Fambolena', 'Vary, katsaka, tombony', Colors.lightGreen, () {
            Navigator.pop(context);
            _showFambolenaCalculator(context);
          }),
          _buildCalcCard('🍄‍🟫', 'Holatra', 'Champignons, kitapo, tombony', Colors.brown, () {
            Navigator.pop(context);
            _showHolatraCalculator(context);
          }),
          
          const SizedBox(height: 16),
          
          // Other calculators
          const Text('📐 FIKAJIANA HAFA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
          const SizedBox(height: 8),
          
          _buildCalcCard('🥚', 'Atody', 'Atody/andro, tombony', Colors.yellow.shade700, () {
            Navigator.pop(context);
            _showAtodyCalculator(context);
          }),
          _buildCalcCard('🌾', 'Sakafo', 'Fatra ilaina, kitapo, vidiny', Colors.green, () {
            Navigator.pop(context);
            _showSakafoCalculator(context);
          }),
        ],
      ),
    );
  }

  Widget _buildTombonyTab() {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Main analyzer
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [Colors.amber.shade100, Colors.orange.shade100],
              ),
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.amber.shade300),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('💰', style: TextStyle(fontSize: 28)),
                    SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text('TOMBONY ANALYZER', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                          Text('Inona no fiompiana tsara indrindra?', style: TextStyle(fontSize: 12, color: Colors.grey)),
                        ],
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 16),
                const Text(
                  'Ampidiro ny budget-nao dia hahita izay fiompiana mampidi-bola kokoa araka ny vola anananao.',
                  style: TextStyle(fontSize: 12),
                ),
                const SizedBox(height: 16),
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton.icon(
                    onPressed: () {
                      Navigator.pop(context);
                      showDialog(context: context, builder: (context) => const ProfitabilityAnalyzerDialog());
                    },
                    icon: const Icon(Icons.trending_up),
                    label: const Text('MANOMBOKA ANALYSE'),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.amber.shade700,
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(vertical: 12),
                    ),
                  ),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Quick comparison
          const Text('⚖️ FAMPITAHANA HAINGANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
          const SizedBox(height: 8),
          
          Container(
            decoration: BoxDecoration(
              border: Border.all(color: Colors.grey.shade300),
              borderRadius: BorderRadius.circular(12),
            ),
            child: Column(
              children: [
                _buildComparisonRow('🐔 Akoho (100)', '500,000 Ar', '1,150,000 Ar', '+130%', Colors.orange),
                _buildComparisonRow('🐇 Bitro (10 reniny)', '400,000 Ar', '900,000 Ar', '+125%', Colors.brown),
                _buildComparisonRow('🐷 Kisoa (5)', '1,200,000 Ar', '3,000,000 Ar', '+150%', Colors.pink),
                _buildComparisonRow('🐟 Trondro (500)', '300,000 Ar', '600,000 Ar', '+100%', Colors.blue),
                _buildComparisonRow('🐝 Tantely (5 toho)', '1,000,000 Ar', '2,500,000 Ar', '+150%', Colors.amber),
                _buildComparisonRow('🦆 Olitra (50)', '600,000 Ar', '1,400,000 Ar', '+133%', Colors.teal),
                _buildComparisonRow('🍄‍🟫 Holatra (100 kitapo)', '250,000 Ar', '600,000 Ar', '+140%', Colors.brown),
                _buildComparisonRow('🌱 Fambolena (1ha)', '800,000 Ar', '2,000,000 Ar', '+150%', Colors.lightGreen, isLast: true),
              ],
            ),
          ),
          
          const SizedBox(height: 16),
          
          // Tips
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.blue.shade50,
              borderRadius: BorderRadius.circular(12),
            ),
            child: const Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text('💡', style: TextStyle(fontSize: 18)),
                    SizedBox(width: 8),
                    Text('TOROHEVITRA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                  ],
                ),
                SizedBox(height: 8),
                Text(
                  '• Ny akoho dia tsara ho an\'ny budget kely\n'
                  '• Ny kisoa sy tantely dia mampidi-bola be kokoa\n'
                  '• Ny olitra (ganagana) dia mora ompiana sy manome tombony tsara\n'
                  '• Ampifangaroy ny fiompiana sy fambolena mba hampitombo ny tombony',
                  style: TextStyle(fontSize: 11, height: 1.5),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCalcCard(String emoji, String title, String subtitle, Color color, VoidCallback onTap) {
    return Card(
      margin: const EdgeInsets.only(bottom: 6),
      child: ListTile(
        dense: true,
        leading: Container(
          padding: const EdgeInsets.all(6),
          decoration: BoxDecoration(
            color: color.withValues(alpha: 0.15),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Text(emoji, style: const TextStyle(fontSize: 18)),
        ),
        title: Text(title, style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12, color: color)),
        subtitle: Text(subtitle, style: const TextStyle(fontSize: 10)),
        trailing: Icon(Icons.calculate, color: color, size: 18),
        onTap: onTap,
      ),
    );
  }

  Widget _buildComparisonRow(String animal, String invest, String revenue, String roi, Color color, {bool isLast = false}) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
      decoration: BoxDecoration(
        border: isLast ? null : Border(bottom: BorderSide(color: Colors.grey.shade200)),
      ),
      child: Row(
        children: [
          Expanded(
            flex: 3,
            child: Text(animal, style: const TextStyle(fontSize: 11, fontWeight: FontWeight.bold)),
          ),
          Expanded(
            flex: 2,
            child: Text(invest, style: const TextStyle(fontSize: 10, color: Colors.red)),
          ),
          Expanded(
            flex: 2,
            child: Text(revenue, style: const TextStyle(fontSize: 10, color: Colors.green)),
          ),
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
            decoration: BoxDecoration(
              color: color.withValues(alpha: 0.15),
              borderRadius: BorderRadius.circular(4),
            ),
            child: Text(roi, style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: color)),
          ),
        ],
      ),
    );
  }

  // Calculator methods (reused from CalculatorsAndProfitScreen)
  void _showAkohoCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Akoho',
        emoji: '🐔',
        color: Colors.orange,
        fields: const [
          {'label': 'Isan\'ny akoho', 'key': 'count', 'hint': '100'},
          {'label': 'Vidin\'ny zanakaoho (Ar)', 'key': 'chick_price', 'hint': '2500'},
          {'label': 'Vidin\'ny sakafo/kg (Ar)', 'key': 'feed_price', 'hint': '2000'},
          {'label': 'Sakafo/akoho/andro (g)', 'key': 'feed_per_day', 'hint': '120'},
          {'label': 'Faharetan\'ny fiompiana (andro)', 'key': 'duration', 'hint': '45'},
          {'label': 'Vidin\'ny akoho iray amidin (Ar)', 'key': 'sell_price', 'hint': '25000'},
        ],
        calculateResult: (values) {
          final count = values['count'] ?? 0;
          final chickPrice = values['chick_price'] ?? 0;
          final feedPrice = values['feed_price'] ?? 0;
          final feedPerDay = values['feed_per_day'] ?? 0;
          final duration = values['duration'] ?? 0;
          final sellPrice = values['sell_price'] ?? 0;
          
          final totalChicks = count * chickPrice;
          final totalFeed = (count * feedPerDay * duration / 1000) * feedPrice;
          final otherCosts = count * 500;
          final totalCost = totalChicks + totalFeed + otherCosts;
          
          final survivors = (count * 0.92).floor();
          final revenue = survivors * sellPrice;
          final profit = revenue - totalCost;
          final profitPerChicken = survivors > 0 ? profit / survivors : 0;
          final roi = totalCost > 0 ? (profit / totalCost * 100) : 0;
          
          return {
            'Zanakaoho': '${NumberFormat("#,##0").format(totalChicks)} Ar',
            'Sakafo': '${NumberFormat("#,##0").format(totalFeed)} Ar',
            'Hafa': '${NumberFormat("#,##0").format(otherCosts)} Ar',
            'VOLA LANY': '${NumberFormat("#,##0").format(totalCost)} Ar',
            '---': '---',
            'Velona (92%)': '$survivors',
            'VOLA NIDITRA': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY': '${NumberFormat("#,##0").format(profit)} Ar',
            'Tombony/akoho': '${NumberFormat("#,##0").format(profitPerChicken)} Ar',
            'ROI': '${roi.toStringAsFixed(1)}%',
          };
        },
      ),
    );
  }

  void _showBitroCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Bitro',
        emoji: '🐇',
        color: Colors.brown,
        fields: const [
          {'label': 'Isan\'ny reniny', 'key': 'mothers', 'hint': '10'},
          {'label': 'Vidin\'ny reniny (Ar)', 'key': 'mother_price', 'hint': '25000'},
          {'label': 'Zanaka isaky ny fiterahana', 'key': 'babies', 'hint': '6'},
          {'label': 'Fiterahana isan-taona', 'key': 'litters', 'hint': '6'},
          {'label': 'Sakafo/volana/reniny (Ar)', 'key': 'feed_cost', 'hint': '15000'},
          {'label': 'Vidin\'ny bitro amidin (Ar)', 'key': 'sell_price', 'hint': '15000'},
        ],
        calculateResult: (values) {
          final mothers = values['mothers'] ?? 0;
          final motherPrice = values['mother_price'] ?? 0;
          final babies = values['babies'] ?? 0;
          final litters = values['litters'] ?? 0;
          final feedCost = values['feed_cost'] ?? 0;
          final sellPrice = values['sell_price'] ?? 0;
          
          final initialCost = mothers * motherPrice;
          final annualFeed = mothers * feedCost * 12;
          final totalCost = initialCost + annualFeed;
          
          final totalBabies = (mothers * babies * litters * 0.85).floor();
          final revenue = totalBabies * sellPrice;
          final profit = revenue - totalCost;
          
          return {
            'Reniny': '${NumberFormat("#,##0").format(initialCost)} Ar',
            'Sakafo/taona': '${NumberFormat("#,##0").format(annualFeed)} Ar',
            'VOLA LANY': '${NumberFormat("#,##0").format(totalCost)} Ar',
            '---': '---',
            'Zanaka (85%)': '$totalBabies',
            'VOLA NIDITRA': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY': '${NumberFormat("#,##0").format(profit)} Ar',
          };
        },
      ),
    );
  }

  void _showKisoaCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Kisoa',
        emoji: '🐷',
        color: Colors.pink,
        fields: const [
          {'label': 'Isan\'ny kisoa', 'key': 'count', 'hint': '10'},
          {'label': 'Vidin\'ny zana-kisoa (Ar)', 'key': 'piglet_price', 'hint': '80000'},
          {'label': 'Vidin\'ny sakafo/kg (Ar)', 'key': 'feed_price', 'hint': '1500'},
          {'label': 'Sakafo/kisoa/andro (kg)', 'key': 'feed_per_day', 'hint': '2.5'},
          {'label': 'Faharetan\'ny fiompiana (volana)', 'key': 'duration', 'hint': '6'},
          {'label': 'Lanja farany (kg)', 'key': 'final_weight', 'hint': '100'},
          {'label': 'Vidin\'ny hena/kg (Ar)', 'key': 'meat_price', 'hint': '12000'},
        ],
        calculateResult: (values) {
          final count = values['count'] ?? 0;
          final pigletPrice = values['piglet_price'] ?? 0;
          final feedPrice = values['feed_price'] ?? 0;
          final feedPerDay = values['feed_per_day'] ?? 0;
          final duration = values['duration'] ?? 0;
          final finalWeight = values['final_weight'] ?? 0;
          final meatPrice = values['meat_price'] ?? 0;
          
          final totalPiglets = count * pigletPrice;
          final totalFeed = (count * feedPerDay * duration * 30) * feedPrice;
          final totalCost = totalPiglets + totalFeed + (count * 20000);
          
          final survivors = (count * 0.95).floor();
          final revenue = survivors * finalWeight * meatPrice;
          final profit = revenue - totalCost;
          
          return {
            'Zana-kisoa': '${NumberFormat("#,##0").format(totalPiglets)} Ar',
            'Sakafo': '${NumberFormat("#,##0").format(totalFeed)} Ar',
            'VOLA LANY': '${NumberFormat("#,##0").format(totalCost)} Ar',
            '---': '---',
            'Velona (95%)': '$survivors',
            'VOLA NIDITRA': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY': '${NumberFormat("#,##0").format(profit)} Ar',
          };
        },
      ),
    );
  }

  void _showTrondroCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Trondro',
        emoji: '🐟',
        color: Colors.blue,
        fields: const [
          {'label': 'Isan\'ny zana-trondro', 'key': 'count', 'hint': '500'},
          {'label': 'Vidin\'ny zana-trondro (Ar)', 'key': 'fry_price', 'hint': '300'},
          {'label': 'Vidin\'ny sakafo/kg (Ar)', 'key': 'feed_price', 'hint': '3000'},
          {'label': 'FCR', 'key': 'fcr', 'hint': '1.5'},
          {'label': 'Lanja farany (g)', 'key': 'final_weight', 'hint': '500'},
          {'label': 'Vidin\'ny trondro/kg (Ar)', 'key': 'sell_price', 'hint': '10000'},
        ],
        calculateResult: (values) {
          final count = values['count'] ?? 0;
          final fryPrice = values['fry_price'] ?? 0;
          final feedPrice = values['feed_price'] ?? 0;
          final fcr = values['fcr'] ?? 1;
          final finalWeight = values['final_weight'] ?? 0;
          final sellPrice = values['sell_price'] ?? 0;
          
          final totalFry = count * fryPrice;
          final totalWeight = count * 0.85 * finalWeight / 1000;
          final totalFeed = totalWeight * fcr * feedPrice;
          final totalCost = totalFry + totalFeed + (count * 50);
          
          final revenue = totalWeight * sellPrice;
          final profit = revenue - totalCost;
          
          return {
            'Zana-trondro': '${NumberFormat("#,##0").format(totalFry)} Ar',
            'Sakafo': '${NumberFormat("#,##0").format(totalFeed)} Ar',
            'VOLA LANY': '${NumberFormat("#,##0").format(totalCost)} Ar',
            '---': '---',
            'Lanja (85%)': '${totalWeight.toStringAsFixed(1)} kg',
            'VOLA NIDITRA': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY': '${NumberFormat("#,##0").format(profit)} Ar',
          };
        },
      ),
    );
  }

  void _showTantelyCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Tantely',
        emoji: '🐝',
        color: Colors.amber,
        fields: const [
          {'label': 'Isan\'ny toho', 'key': 'hives', 'hint': '10'},
          {'label': 'Vidin\'ny toho (Ar)', 'key': 'hive_price', 'hint': '150000'},
          {'label': 'Vidin\'ny essaim (Ar)', 'key': 'swarm_price', 'hint': '50000'},
          {'label': 'Tantely/toho/taona (kg)', 'key': 'honey', 'hint': '20'},
          {'label': 'Vidin\'ny tantely/kg (Ar)', 'key': 'honey_price', 'hint': '25000'},
        ],
        calculateResult: (values) {
          final hives = values['hives'] ?? 0;
          final hivePrice = values['hive_price'] ?? 0;
          final swarmPrice = values['swarm_price'] ?? 0;
          final honey = values['honey'] ?? 0;
          final honeyPrice = values['honey_price'] ?? 0;
          
          final initialCost = hives * (hivePrice + swarmPrice);
          final annualCost = hives * 20000;
          
          final totalHoney = hives * honey;
          final revenue = totalHoney * honeyPrice;
          final profit = revenue - annualCost;
          
          return {
            'Toho + Essaim': '${NumberFormat("#,##0").format(initialCost)} Ar',
            'Fikojakojana': '${NumberFormat("#,##0").format(annualCost)} Ar',
            '---': '---',
            'Tantely': '${totalHoney.toStringAsFixed(0)} kg',
            'VOLA NIDITRA': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY (Y2+)': '${NumberFormat("#,##0").format(profit)} Ar',
          };
        },
      ),
    );
  }

  void _showAtodyCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Atody',
        emoji: '🥚',
        color: Colors.yellow.shade700,
        fields: const [
          {'label': 'Akoho mpitatsy', 'key': 'layers', 'hint': '50'},
          {'label': 'Tahan\'ny fiterahana (%)', 'key': 'rate', 'hint': '80'},
          {'label': 'Vidin\'ny atody (Ar)', 'key': 'egg_price', 'hint': '600'},
          {'label': 'Sakafo/akoho/andro (Ar)', 'key': 'feed_cost', 'hint': '250'},
        ],
        calculateResult: (values) {
          final layers = values['layers'] ?? 0;
          final rate = (values['rate'] ?? 0) / 100;
          final eggPrice = values['egg_price'] ?? 0;
          final feedCost = values['feed_cost'] ?? 0;
          
          final eggsPerDay = layers * rate;
          final dailyRevenue = eggsPerDay * eggPrice;
          final dailyCost = layers * feedCost;
          final dailyProfit = dailyRevenue - dailyCost;
          
          return {
            'Atody/andro': eggsPerDay.toStringAsFixed(0),
            'Atody/volana': (eggsPerDay * 30).toStringAsFixed(0),
            '---': '---',
            'Vola niditra/andro': '${NumberFormat("#,##0").format(dailyRevenue)} Ar',
            'Vola lany/andro': '${NumberFormat("#,##0").format(dailyCost)} Ar',
            'TOMBONY/andro': '${NumberFormat("#,##0").format(dailyProfit)} Ar',
            'TOMBONY/volana': '${NumberFormat("#,##0").format(dailyProfit * 30)} Ar',
          };
        },
      ),
    );
  }

  void _showSakafoCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Sakafo',
        emoji: '🌾',
        color: Colors.green,
        fields: const [
          {'label': 'Isan\'ny biby', 'key': 'count', 'hint': '100'},
          {'label': 'Sakafo/biby/andro (g)', 'key': 'feed', 'hint': '120'},
          {'label': 'Faharetan\'ny fiompiana (andro)', 'key': 'duration', 'hint': '45'},
          {'label': 'Vidin\'ny sakafo/kg (Ar)', 'key': 'price', 'hint': '2000'},
        ],
        calculateResult: (values) {
          final count = values['count'] ?? 0;
          final feed = values['feed'] ?? 0;
          final duration = values['duration'] ?? 0;
          final price = values['price'] ?? 0;
          
          final dailyFeed = count * feed / 1000;
          final totalFeed = dailyFeed * duration;
          final totalCost = totalFeed * price;
          
          return {
            'Sakafo/andro': '${dailyFeed.toStringAsFixed(1)} kg',
            'Sakafo rehetra': '${totalFeed.toStringAsFixed(1)} kg',
            '---': '---',
            'Kitapo 25kg': '${(totalFeed / 25).ceil()}',
            'Kitapo 50kg': '${(totalFeed / 50).ceil()}',
            'VOLA ILAINA': '${NumberFormat("#,##0").format(totalCost)} Ar',
          };
        },
      ),
    );
  }

  void _showOlitraCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Olitra',
        emoji: '🦆',
        color: Colors.teal,
        fields: const [
          {'label': 'Isan\'ny ganagana/vorona', 'key': 'count', 'hint': '50'},
          {'label': 'Vidin\'ny zanak\'olitra (Ar)', 'key': 'chick_price', 'hint': '8000'},
          {'label': 'Sakafo/olitra/andro (g)', 'key': 'feed_per_day', 'hint': '150'},
          {'label': 'Faharetan\'ny fiompiana (andro)', 'key': 'duration', 'hint': '60'},
          {'label': 'Vidin\'ny sakafo/kg (Ar)', 'key': 'feed_price', 'hint': '2200'},
          {'label': 'Vidin\'ny olitra iray rehefa lehibe (Ar)', 'key': 'sell_price', 'hint': '35000'},
        ],
        calculateResult: (values) {
          final count = values['count'] ?? 0;
          final chickPrice = values['chick_price'] ?? 0;
          final feedPerDay = values['feed_per_day'] ?? 0;
          final duration = values['duration'] ?? 0;
          final feedPrice = values['feed_price'] ?? 0;
          final sellPrice = values['sell_price'] ?? 0;
          
          final chickCost = count * chickPrice;
          final totalFeedKg = count * feedPerDay * duration / 1000;
          final feedCost = totalFeedKg * feedPrice;
          final otherCost = (chickCost + feedCost) * 0.1;
          final totalCost = chickCost + feedCost + otherCost;
          
          final revenue = count * sellPrice * 0.90;
          final profit = revenue - totalCost;
          final roi = totalCost > 0 ? (profit / totalCost * 100) : 0;
          
          return {
            'Vidin\'ny zanak\'olitra': '${NumberFormat("#,##0").format(chickCost)} Ar',
            'Vidin\'ny sakafo': '${NumberFormat("#,##0").format(feedCost)} Ar',
            'Hafa (10%)': '${NumberFormat("#,##0").format(otherCost)} Ar',
            '---': '---',
            'VOLA LANY REHETRA': '${NumberFormat("#,##0").format(totalCost)} Ar',
            'VOLA MIDITRA': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY': '${NumberFormat("#,##0").format(profit)} Ar',
            'ROI': '${roi.toStringAsFixed(1)}%',
          };
        },
      ),
    );
  }

  void _showZezikaCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Zezika',
        emoji: '🧪',
        color: Colors.grey,
        fields: const [
          {'label': 'Haben\'ny tany (m²)', 'key': 'area', 'hint': '1000'},
          {'label': 'Karazan\'ny voly (1=Vary, 2=Katsaka, 3=Legioma)', 'key': 'crop_type', 'hint': '1'},
          {'label': 'Zezika organika/m² (g)', 'key': 'organic', 'hint': '200'},
          {'label': 'NPK/m² (g)', 'key': 'npk', 'hint': '30'},
          {'label': 'Vidin\'ny zezika organika/kg (Ar)', 'key': 'organic_price', 'hint': '500'},
          {'label': 'Vidin\'ny NPK/kg (Ar)', 'key': 'npk_price', 'hint': '3000'},
        ],
        calculateResult: (values) {
          final area = values['area'] ?? 0;
          final cropType = (values['crop_type'] ?? 1).toInt();
          var organic = values['organic'] ?? 0;
          var npk = values['npk'] ?? 0;
          final organicPrice = values['organic_price'] ?? 0;
          final npkPrice = values['npk_price'] ?? 0;
          
          String cropName = 'Vary';
          if (cropType == 2) { cropName = 'Katsaka'; organic *= 0.8; npk *= 1.2; }
          if (cropType == 3) { cropName = 'Legioma'; organic *= 1.5; npk *= 0.8; }
          
          final totalOrganicKg = area * organic / 1000;
          final totalNpkKg = area * npk / 1000;
          final organicCost = totalOrganicKg * organicPrice;
          final npkCost = totalNpkKg * npkPrice;
          final totalCost = organicCost + npkCost;
          
          return {
            'Voly': cropName,
            'Haben\'ny tany': '${NumberFormat("#,##0").format(area)} m²',
            '---': '---',
            'Zezika organika ilaina': '${totalOrganicKg.toStringAsFixed(1)} kg',
            'NPK ilaina': '${totalNpkKg.toStringAsFixed(1)} kg',
            '---2': '---',
            'Vidin\'ny zezika organika': '${NumberFormat("#,##0").format(organicCost)} Ar',
            'Vidin\'ny NPK': '${NumberFormat("#,##0").format(npkCost)} Ar',
            'VOLA ILAINA REHETRA': '${NumberFormat("#,##0").format(totalCost)} Ar',
          };
        },
      ),
    );
  }

  void _showFambolenaCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Fambolena',
        emoji: '🌱',
        color: Colors.lightGreen,
        fields: const [
          {'label': 'Haben\'ny tany (m²)', 'key': 'area', 'hint': '2000'},
          {'label': 'Vidin\'ny masomboly (Ar)', 'key': 'seed_cost', 'hint': '50000'},
          {'label': 'Vidin\'ny zezika (Ar)', 'key': 'fertilizer_cost', 'hint': '80000'},
          {'label': 'Karama asa (Ar)', 'key': 'labor_cost', 'hint': '100000'},
          {'label': 'Voka-bary/m² (kg)', 'key': 'yield_per_m2', 'hint': '0.5'},
          {'label': 'Vidin\'ny vokatra/kg (Ar)', 'key': 'sell_price', 'hint': '2000'},
        ],
        calculateResult: (values) {
          final area = values['area'] ?? 0;
          final seedCost = values['seed_cost'] ?? 0;
          final fertilizerCost = values['fertilizer_cost'] ?? 0;
          final laborCost = values['labor_cost'] ?? 0;
          final yieldPerM2 = values['yield_per_m2'] ?? 0;
          final sellPrice = values['sell_price'] ?? 0;
          
          final totalCost = seedCost + fertilizerCost + laborCost;
          final totalYield = area * yieldPerM2;
          final revenue = totalYield * sellPrice;
          final profit = revenue - totalCost;
          final roi = totalCost > 0 ? (profit / totalCost * 100) : 0;
          final costPerKg = totalYield > 0 ? (totalCost / totalYield) : 0;
          
          return {
            'Haben\'ny tany': '${NumberFormat("#,##0").format(area)} m²',
            'Vola lany masomboly': '${NumberFormat("#,##0").format(seedCost)} Ar',
            'Vola lany zezika': '${NumberFormat("#,##0").format(fertilizerCost)} Ar',
            'Karama asa': '${NumberFormat("#,##0").format(laborCost)} Ar',
            '---': '---',
            'VOLA LANY REHETRA': '${NumberFormat("#,##0").format(totalCost)} Ar',
            'Vokatra andrasana': '${totalYield.toStringAsFixed(1)} kg',
            'Vidiny/kg': '${NumberFormat("#,##0").format(costPerKg)} Ar',
            '---2': '---',
            'VOLA MIDITRA': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY': '${NumberFormat("#,##0").format(profit)} Ar',
            'ROI': '${roi.toStringAsFixed(1)}%',
          };
        },
      ),
    );
  }

  void _showHolatraCalculator(BuildContext context) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => _CalculatorSheet(
        title: 'Fikajiana Holatra',
        emoji: '🍄‍🟫',
        color: Colors.brown,
        fields: const [
          {'label': 'Isan\'ny kitapo', 'key': 'bags', 'hint': '100'},
          {'label': 'Vidin\'ny substrat/kitapo (Ar)', 'key': 'substrate_cost', 'hint': '500'},
          {'label': 'Vidin\'ny spawn/kitapo (Ar)', 'key': 'spawn_cost', 'hint': '1000'},
          {'label': 'Kitapo plastika/pièce (Ar)', 'key': 'bag_cost', 'hint': '200'},
          {'label': 'Fandaniana hafa/volana (Ar)', 'key': 'other_cost', 'hint': '50000'},
          {'label': 'Vokatra/kitapo (g)', 'key': 'yield_per_bag', 'hint': '300'},
          {'label': 'Vidin\'ny holatra/kg (Ar)', 'key': 'sell_price', 'hint': '20000'},
        ],
        calculateResult: (values) {
          final bags = values['bags'] ?? 0;
          final substrateCost = values['substrate_cost'] ?? 0;
          final spawnCost = values['spawn_cost'] ?? 0;
          final bagCost = values['bag_cost'] ?? 0;
          final otherCost = values['other_cost'] ?? 0;
          final yieldPerBag = values['yield_per_bag'] ?? 0;
          final sellPrice = values['sell_price'] ?? 0;
          
          final totalSubstrate = bags * substrateCost;
          final totalSpawn = bags * spawnCost;
          final totalBags = bags * bagCost;
          final totalCost = totalSubstrate + totalSpawn + totalBags + otherCost;
          
          final totalYieldG = bags * yieldPerBag;
          final totalYieldKg = totalYieldG / 1000;
          final revenue = totalYieldKg * sellPrice;
          final profit = revenue - totalCost;
          final roi = totalCost > 0 ? (profit / totalCost * 100) : 0;
          final costPerKg = totalYieldKg > 0 ? (totalCost / totalYieldKg) : 0;
          
          return {
            'Isan\'ny kitapo': '${NumberFormat("#,##0").format(bags)} kitapo',
            'Vola substrat': '${NumberFormat("#,##0").format(totalSubstrate)} Ar',
            'Vola spawn': '${NumberFormat("#,##0").format(totalSpawn)} Ar',
            'Vola kitapo': '${NumberFormat("#,##0").format(totalBags)} Ar',
            'Fandaniana hafa': '${NumberFormat("#,##0").format(otherCost)} Ar',
            '---': '---',
            'VOLA LANY REHETRA': '${NumberFormat("#,##0").format(totalCost)} Ar',
            'Vokatra andrasana': '${totalYieldKg.toStringAsFixed(1)} kg',
            'Vidiny/kg': '${NumberFormat("#,##0").format(costPerKg)} Ar',
            '---2': '---',
            'VOLA MIDITRA': '${NumberFormat("#,##0").format(revenue)} Ar',
            'TOMBONY': '${NumberFormat("#,##0").format(profit)} Ar',
            'ROI': '${roi.toStringAsFixed(1)}%',
          };
        },
      ),
    );
  }
}

// ==================== PRICING DIALOG (FIKAJIANA) ====================
class PricingDialog extends StatefulWidget {
  const PricingDialog({super.key});

  @override
  State<PricingDialog> createState() => _PricingDialogState();
}

class _PricingDialogState extends State<PricingDialog> {
  final TextEditingController _achatCtrl = TextEditingController();
  final TextEditingController _chargesCtrl = TextEditingController();
  final TextEditingController _qtyCtrl = TextEditingController();
  final TextEditingController _marginCtrl = TextEditingController(text: '30');

  double _totalExpenses = 0;
  double _unitCost = 0;
  double _sellingPrice = 0;
  double _unitProfit = 0;
  bool _showResults = false;

  void _calculatePrice() {
    double achat = double.tryParse(_achatCtrl.text) ?? 0;
    double charges = double.tryParse(_chargesCtrl.text) ?? 0;
    double qty = double.tryParse(_qtyCtrl.text) ?? 1;
    double marginPercent = double.tryParse(_marginCtrl.text) ?? 0;

    if (qty <= 0) qty = 1;

    setState(() {
      _totalExpenses = achat + charges;
      _unitCost = _totalExpenses / qty;
      _sellingPrice = _unitCost * (1 + (marginPercent / 100));
      _unitProfit = _sellingPrice - _unitCost;
      _showResults = true;
    });

    FocusScope.of(context).unfocus();
  }

  void _reset() {
    setState(() {
      _achatCtrl.clear();
      _chargesCtrl.clear();
      _qtyCtrl.clear();
      _marginCtrl.text = '30';
      _showResults = false;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      child: Container(
        constraints: const BoxConstraints(maxWidth: 400, maxHeight: 700),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            // Header
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: const Color(0xFF1565C0),
                borderRadius: const BorderRadius.only(
                  topLeft: Radius.circular(20),
                  topRight: Radius.circular(20),
                ),
              ),
              child: Row(
                children: [
                  const Text('💰', style: TextStyle(fontSize: 28)),
                  const SizedBox(width: 10),
                  const Expanded(
                    child: Text(
                      'Mpanoro Vidin\'entana',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                  IconButton(
                    icon: const Icon(Icons.refresh, color: Colors.white),
                    onPressed: _reset,
                    tooltip: 'Fafao daholo',
                  ),
                  IconButton(
                    icon: const Icon(Icons.close, color: Colors.white),
                    onPressed: () => Navigator.pop(context),
                  ),
                ],
              ),
            ),
            // Body
            Flexible(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    _buildInputCard(
                      title: '1. Vola Lany (Dépenses)',
                      children: [
                        _buildTextField(_achatCtrl, 'Vidin\'ny Entana (Achat)', Icons.shopping_cart),
                        const SizedBox(height: 10),
                        _buildTextField(_chargesCtrl, 'Karama sy Fitaterana', Icons.local_shipping),
                      ],
                    ),
                    const SizedBox(height: 12),
                    _buildInputCard(
                      title: '2. Vokatra (Production)',
                      children: [
                        _buildTextField(_qtyCtrl, 'Isan\'ny entana azo amidy', Icons.numbers),
                      ],
                    ),
                    const SizedBox(height: 12),
                    _buildInputCard(
                      title: '3. Tanjona (Objectif)',
                      children: [
                        _buildTextField(_marginCtrl, 'Tombony tadiavinao (%)', Icons.percent, isLast: true),
                      ],
                    ),
                    const SizedBox(height: 16),
                    ElevatedButton(
                      onPressed: _calculatePrice,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF2E7D32),
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 14),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                      ),
                      child: const Text('KAJY NY VIDINY', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                    ),
                    if (_showResults) ...[
                      const SizedBox(height: 20),
                      const Divider(),
                      const Center(
                        child: Text(
                          'VOKATRY NY KAJY',
                          style: TextStyle(color: Colors.grey, fontWeight: FontWeight.bold),
                        ),
                      ),
                      const SizedBox(height: 10),
                      _buildResultCard(
                        color: Colors.red.shade50,
                        borderColor: Colors.red.shade200,
                        title: 'Vidiny Famokarana',
                        amount: _unitCost,
                        subtitle: 'Isaky ny entana iray',
                        textColor: Colors.red.shade900,
                      ),
                      const SizedBox(height: 12),
                      Container(
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          color: const Color(0xFFE8F5E9),
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(color: Colors.green, width: 2),
                        ),
                        child: Column(
                          children: [
                            const Text(
                              '✅ VIDINY TOKONY HAMAROTANA AZY',
                              style: TextStyle(fontSize: 12, fontWeight: FontWeight.bold, color: Colors.green),
                            ),
                            const SizedBox(height: 5),
                            Text(
                              '${_sellingPrice.toStringAsFixed(0)} Ar',
                              style: const TextStyle(fontSize: 28, fontWeight: FontWeight.bold, color: Color(0xFF1B5E20)),
                            ),
                            Text(
                              'Mba hahazoana tombony ${_marginCtrl.text}%',
                              style: const TextStyle(color: Colors.green, fontSize: 12),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(height: 12),
                      _buildResultCard(
                        color: Colors.blue.shade50,
                        borderColor: Colors.blue.shade200,
                        title: 'Tombony Madio',
                        amount: _unitProfit,
                        subtitle: 'Vola miditra isaky ny iray',
                        textColor: Colors.blue.shade900,
                      ),
                    ],
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildInputCard({required String title, required List<Widget> children}) {
    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(10),
        boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 3)],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(title, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14, color: Color(0xFF37474F))),
          const Divider(),
          ...children,
        ],
      ),
    );
  }

  Widget _buildTextField(TextEditingController controller, String label, IconData icon, {bool isLast = false}) {
    return TextField(
      controller: controller,
      keyboardType: const TextInputType.numberWithOptions(decimal: true),
      textInputAction: isLast ? TextInputAction.done : TextInputAction.next,
      decoration: InputDecoration(
        labelText: label,
        labelStyle: const TextStyle(fontSize: 13),
        prefixIcon: Icon(icon, color: Colors.grey, size: 20),
        border: const OutlineInputBorder(),
        contentPadding: const EdgeInsets.symmetric(horizontal: 10, vertical: 12),
        isDense: true,
      ),
    );
  }

  Widget _buildResultCard({
    required Color color,
    required Color borderColor,
    required String title,
    required double amount,
    required String subtitle,
    required Color textColor,
  }) {
    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: color,
        borderRadius: BorderRadius.circular(10),
        border: Border.all(color: borderColor),
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title, style: TextStyle(fontWeight: FontWeight.bold, color: textColor, fontSize: 13)),
                Text(subtitle, style: TextStyle(fontSize: 11, color: textColor.withValues(alpha: 0.7))),
              ],
            ),
          ),
          Text(
            '${amount.toStringAsFixed(0)} Ar',
            style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: textColor),
          ),
        ],
      ),
    );
  }
}

// ==================== TRONDROTECH - PISCICULTURE ====================

// ========== Trondro Systems Screen ==========
class TrondroSystemsScreen extends StatelessWidget {
  const TrondroSystemsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final systems = [
      {
        'name': 'Hors Sol (Basin plastika/Beton/Bâche)',
        'emoji': '🏊',
        'type': 'intensive',
        'description': 'Fiompiana anaty basin plastika, beton na bâche. Teknika maoderina mety amin\'ny toerana kely.',
        'capacity': '50-100 trondro/m³ (sans aération) / 100-500 (avec aération)',
        'species': ['Tilapia', 'Carpe', 'Clarias (Trondro gasy)'],
        'investment': 'Antonony - Ambony',
        'difficulty': 'Antonony',
        'advantages': [
          'Tsy mila toerana lehibe (tokotany kely dia ampy)',
          'Azo atao na aiza na aiza (an-tanana)',
          'Mora jerena sy arahi-maso ny trondro',
          'Fahadiovan\'ny rano azo fehezina tanteraka',
          'Tsy misy mpangalatra na biby mpihinana',
          'Vokatra haingana (4-6 volana)',
        ],
        'disadvantages': [
          'Mila pompe aérateur (raha te hampitombo isa)',
          'Mila famatsiana rano madio matetika',
          'Vidiny basin lafo (investissement départ)',
          'Mila fanaraha-maso isan\'andro',
        ],
        'conditions': [
          'Rano: Madio, tsy misy chlore (avelao hiala 24h raha rano Jirama)',
          'pH: 6.5 - 8.5 (Tsara indrindra 7.0-7.5)',
          'Oxygène: > 5mg/L (Mila aérateur raha > 50 trondro/m³)',
          'Température: 25°C - 30°C (Tilapia)',
          'Ammoniac: < 0.02 mg/L (Tena poizina!)',
          'Nitrite: < 0.1 mg/L',
        ],
        'actions': [
          'Isan\'andro: Omeo sakafo in-3 na in-4 (maraina, atoandro, hariva)',
          'Isan\'andro: Jereo raha mihinana tsara ny trondro',
          'Isan\'andro: Esory ny sakafo tsy lany (mba tsy ho lo)',
          'Isan-kerinandro: Soloy ny 20-30% n\'ny rano (siphonage fond)',
          'Isan-kerinandro: Diovy ny filtre (raha misy)',
          'Isam-bolana: Lanjao ny trondro vitsivitsy (échantillon) hanitsiana ny sakafo',
        ],
        'setup': [
          '1. Omano ny toerana: Fisaka, mafy, akaiky rano',
          '2. Apetraho ny basin (Plastika, Beton na Bâche)',
          '3. Asio tatatra fivoahan-drano (Vidange) any ambany',
          '4. Fenoy rano ary avelao 2-3 andro (hiala ny fofona/chlore)',
          '5. Asio "Cycle Azote" (zezika kely) mandritra ny 1-2 herinandro',
          '6. Arotsaka ny zana-trondro (maraina na hariva, aza atao tampoka)',
        ],
        'materials': [
          {'name': 'Basin plastika 1000L (IBC)', 'price': '150,000-250,000 Ar'},
          {'name': 'Bâche (raha manao dobo bâche)', 'price': '10,000-15,000 Ar/m²'},
          {'name': 'Pompe aérateur (Bulle)', 'price': '45,000-80,000 Ar'},
          {'name': 'Pompe à eau (Fidiran-drano)', 'price': '150,000-300,000 Ar'},
          {'name': 'Kit Test Rano (pH, Ammo)', 'price': '80,000-150,000 Ar'},
          {'name': 'Harato', 'price': '15,000-25,000 Ar'},
        ],
      },
      {
        'name': 'Dobo (Lavadrano vita)',
        'emoji': '🕳️',
        'type': 'semi-intensive',
        'description': 'Fiompiana anaty dobo lavadrano vita tany. Fomba mahazatra eto Madagasikara.',
        'capacity': '2-5 trondro/m²',
        'species': ['Tilapia', 'Carpe', 'Heterotis'],
        'investment': 'Ambany - Antonony',
        'difficulty': 'Mora',
        'advantages': [
          'Vidiny fiandohana ambany',
          'Tsy mila fitaovana be',
          'Sakafo voajanahary misy ao',
          'Mora fikarakarana',
        ],
        'disadvantages': [
          'Mila tany malalaka',
          'Sarotra fehezina ny rano',
          'Misy mpangalatra (vorona, bibilava)',
        ],
        'materials': [
          {'name': 'Fanadiovana dobo', 'price': '50,000-150,000 Ar'},
          {'name': 'Harato fiarovana', 'price': '30,000-80,000 Ar'},
          {'name': 'Zezika organika (fiandohana)', 'price': '20,000-40,000 Ar'},
          {'name': 'Harato fijinjana', 'price': '25,000-50,000 Ar'},
        ],
      },
      {
        'name': 'Farihy kely (Petit lac)',
        'emoji': '🏞️',
        'type': 'semi-intensive',
        'description': 'Fiompiana anaty farihy kely efa misy. Mila harato fiarovana.',
        'capacity': '1-3 trondro/m²',
        'species': ['Tilapia', 'Carpe', 'Heterotis', 'Black bass'],
        'investment': 'Ambany',
        'difficulty': 'Mora',
        'advantages': [
          'Tsy mila vola be',
          'Sakafo voajanahary betsaka',
          'Fari-piainana voajanahary',
          'Azo ampiana voly vary',
        ],
        'disadvantages': [
          'Sarotra fehezina',
          'Misy mpangalatra',
          'Tsy azo ajanona ny rano',
        ],
        'materials': [
          {'name': 'Harato fiarovana lehibe', 'price': '80,000-200,000 Ar'},
          {'name': 'Bao marika', 'price': '5,000-10,000 Ar'},
          {'name': 'Harato fijinjana', 'price': '30,000-60,000 Ar'},
        ],
      },
      {
        'name': 'Farihy lehibe miaraka amin\'ny harato',
        'emoji': '🌊',
        'type': 'extensive',
        'description': 'Fiompiana anaty farihy lehibe miaraka amin\'ny harato (cage/enclos).',
        'capacity': '20-50 trondro/m³ (anaty cage)',
        'species': ['Tilapia', 'Carpe'],
        'investment': 'Antonony - Ambony',
        'difficulty': 'Antonony',
        'advantages': [
          'Kapasita be',
          'Rano madio foana',
          'Azo atao lehibe ny orinasa',
        ],
        'disadvantages': [
          'Mila harato matanjaka',
          'Mety ho fangalaran\'olona',
          'Mila fiambenana',
        ],
        'materials': [
          {'name': 'Cage harato 3x3x2m', 'price': '150,000-300,000 Ar'},
          {'name': 'Bao flotaison', 'price': '50,000-100,000 Ar'},
          {'name': 'Tady matanjaka', 'price': '20,000-40,000 Ar'},
          {'name': 'Harato fijinjana', 'price': '30,000-60,000 Ar'},
        ],
      },
      {
        'name': 'Rano velona (Rivière) miaraka amin\'ny harato',
        'emoji': '🏞️',
        'type': 'extensive',
        'description': 'Fiompiana anaty renirano miaraka amin\'ny harato na enclos.',
        'capacity': '10-30 trondro/m³',
        'species': ['Tilapia', 'Carpe', 'Heterotis'],
        'investment': 'Antonony',
        'difficulty': 'Sarotra',
        'advantages': [
          'Rano madio foana (mikoriana)',
          'Oxygène betsaka',
          'Sakafo voajanahary betsaka',
        ],
        'disadvantages': [
          'Mety ho simba ny harato (riaka)',
          'Sarotra jerena',
          'Mila fahazoan-dalana',
        ],
        'materials': [
          {'name': 'Enclos harato matanjaka', 'price': '200,000-400,000 Ar'},
          {'name': 'Pieu bois/vy', 'price': '50,000-100,000 Ar'},
          {'name': 'Tady sy fitaovana famatotra', 'price': '30,000-50,000 Ar'},
        ],
      },
    ];

    final fishSpecies = [
      {
        'name': 'Tilapia (Tilapia nilotica)',
        'emoji': '🐟',
        'localName': 'Tilapia, Fiha',
        'growthTime': '6-8 volana',
        'harvestWeight': '300-500g',
        'temperature': '25-30°C',
        'priceKg': '12,000-18,000 Ar/kg',
        'advantages': ['Mora tezaina', 'Mahatanty aretina', 'Mitombo haingana'],
        'feed': 'Sakafo vita an-trano, kankana, son de riz, katsaka',
        'alevins': [
          {'size': '1-2 cm (0.5-2g)', 'price': '200-300 Ar/iray'},
          {'size': '3-5 cm (5-10g)', 'price': '400-500 Ar/iray'},
          {'size': '6-8 cm (15-30g)', 'price': '600-800 Ar/iray'},
          {'size': 'Géniteur (250-500g)', 'price': '8,000-15,000 Ar/iray'},
        ],
      },
      {
        'name': 'Carpe commune',
        'emoji': '🐠',
        'localName': 'Karpa, Besisika',
        'growthTime': '8-12 volana',
        'harvestWeight': '500-1500g',
        'temperature': '20-28°C',
        'priceKg': '15,000-22,000 Ar/kg',
        'advantages': ['Lanja mavesatra', 'Tsy sarotra sakafo', 'Vidiny lafo'],
        'feed': 'Kankana, son de riz, ravina, zava-maniry',
        'alevins': [
          {'size': '2-3 cm (1-3g)', 'price': '250-350 Ar/iray'},
          {'size': '4-6 cm (8-15g)', 'price': '450-550 Ar/iray'},
          {'size': '7-10 cm (25-50g)', 'price': '650-800 Ar/iray'},
          {'size': 'Géniteur (1-2kg)', 'price': '20,000-35,000 Ar/iray'},
        ],
      },
      {
        'name': 'Carpe chinoise (Amour blanc)',
        'emoji': '🐟',
        'localName': 'Karpa fotsy',
        'growthTime': '10-14 volana',
        'harvestWeight': '1-3 kg',
        'temperature': '22-28°C',
        'priceKg': '18,000-25,000 Ar/kg',
        'advantages': ['Lanja mavesatra be', 'Mihinana ahitra/ravina'],
        'feed': 'Ahitra, ravina, zava-maniry anaty rano',
        'alevins': [
          {'size': '3-5 cm (3-8g)', 'price': '350-450 Ar/iray'},
          {'size': '6-10 cm (15-40g)', 'price': '550-700 Ar/iray'},
          {'size': 'Géniteur (2-4kg)', 'price': '40,000-60,000 Ar/iray'},
        ],
      },
      {
        'name': 'Heterotis',
        'emoji': '🐡',
        'localName': 'Marakely',
        'growthTime': '12-18 volana',
        'harvestWeight': '1-5 kg',
        'temperature': '24-30°C',
        'priceKg': '15,000-20,000 Ar/kg',
        'advantages': ['Lanja mavesatra be', 'Mahazaka toerana ratsy'],
        'feed': 'Zava-maniry, plancton, kankana',
        'alevins': [
          {'size': '5-8 cm (10-20g)', 'price': '500-700 Ar/iray'},
          {'size': '10-15 cm (40-80g)', 'price': '800-1,200 Ar/iray'},
          {'size': 'Géniteur (3-5kg)', 'price': '50,000-80,000 Ar/iray'},
        ],
      },
    ];

    return Scaffold(
      backgroundColor: const Color(0xFFF5F5F5),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.cyan.shade700, Colors.teal.shade600]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              children: [
                const Text('🐟', style: TextStyle(fontSize: 40)),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('SYSTÈME FIOMPIANA TRONDRO',
                          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('Tilapia, Carpe - Hors sol, Dobo, Farihy, Rano velona',
                          style: TextStyle(color: Colors.white.withValues(alpha: 0.9), fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Fish Species Section
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('🐠', style: TextStyle(fontSize: 24)),
                    SizedBox(width: 8),
                    Text('KARAZANA TRONDRO', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                  ],
                ),
                const Divider(),
                ...fishSpecies.map((fish) => Container(
                  margin: const EdgeInsets.only(bottom: 12),
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.cyan.shade50,
                    borderRadius: BorderRadius.circular(10),
                    border: Border.all(color: Colors.cyan.shade100),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Text(fish['emoji'] as String, style: const TextStyle(fontSize: 28)),
                          const SizedBox(width: 12),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(fish['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                                Text('🏷️ ${fish['localName']}', style: TextStyle(fontSize: 12, color: Colors.grey.shade600)),
                              ],
                            ),
                          ),
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                            decoration: BoxDecoration(
                              color: Colors.green.shade100,
                              borderRadius: BorderRadius.circular(8),
                            ),
                            child: Text(fish['priceKg'] as String, style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: Colors.green.shade800)),
                          ),
                        ],
                      ),
                      const SizedBox(height: 8),
                      Wrap(
                        spacing: 8,
                        runSpacing: 4,
                        children: [
                          _buildFishChip('⏱️ ${fish['growthTime']}'),
                          _buildFishChip('⚖️ ${fish['harvestWeight']}'),
                          _buildFishChip('🌡️ ${fish['temperature']}'),
                        ],
                      ),
                      const SizedBox(height: 8),
                      Text('🍽️ Sakafo: ${fish['feed']}', style: TextStyle(fontSize: 11, color: Colors.grey.shade700)),
                      
                      // Alevins prices section
                      if (fish['alevins'] != null) ...[
                        const SizedBox(height: 10),
                        Container(
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: Colors.blue.shade50,
                            borderRadius: BorderRadius.circular(8),
                            border: Border.all(color: Colors.blue.shade200),
                          ),
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Row(
                                children: [
                                  const Text('🐣 ', style: TextStyle(fontSize: 14)),
                                  Text('VIDIN\'NY ZANA-TRONDRO:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 11, color: Colors.blue.shade800)),
                                ],
                              ),
                              const SizedBox(height: 6),
                              ...(fish['alevins'] as List).map((alevin) => Padding(
                                padding: const EdgeInsets.only(bottom: 3),
                                child: Row(
                                  children: [
                                    const Text('  • ', style: TextStyle(fontSize: 10)),
                                    Expanded(child: Text(alevin['size'] as String, style: const TextStyle(fontSize: 10))),
                                    Container(
                                      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                                      decoration: BoxDecoration(
                                        color: Colors.green.shade100,
                                        borderRadius: BorderRadius.circular(4),
                                      ),
                                      child: Text(alevin['price'] as String, style: TextStyle(fontSize: 9, fontWeight: FontWeight.bold, color: Colors.green.shade700)),
                                    ),
                                  ],
                                ),
                              )),
                            ],
                          ),
                        ),
                      ],
                    ],
                  ),
                )),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Systems Section
          const Text('SYSTÈME FIOMPIANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
          const SizedBox(height: 12),

          ...systems.map((system) => Container(
            margin: const EdgeInsets.only(bottom: 16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Theme(
              data: Theme.of(context).copyWith(dividerColor: Colors.transparent),
              child: ExpansionTile(
                leading: Text(system['emoji'] as String, style: const TextStyle(fontSize: 32)),
                title: Text(system['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                subtitle: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(system['description'] as String, style: TextStyle(fontSize: 11, color: Colors.grey.shade600)),
                    const SizedBox(height: 4),
                    Wrap(
                      spacing: 6,
                      runSpacing: 4,
                      children: [
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                          decoration: BoxDecoration(
                            color: Colors.cyan.shade100,
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Text('📊 ${system['capacity']}', style: TextStyle(fontSize: 10, color: Colors.cyan.shade800)),
                        ),
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                          decoration: BoxDecoration(
                            color: Colors.orange.shade100,
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Text('💰 ${system['investment']}', style: TextStyle(fontSize: 10, color: Colors.orange.shade800)),
                        ),
                      ],
                    ),
                  ],
                ),
                children: [
                  Padding(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        // Trondro azo atao
                        Row(
                          children: [
                            const Text('🐟 Trondro: ', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                            Text((system['species'] as List).join(', '), style: TextStyle(fontSize: 12, color: Colors.grey.shade700)),
                          ],
                        ),
                        const SizedBox(height: 12),

                        // Avantages
                        const Text('✅ Tombontsoa:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12, color: Colors.green)),
                        ...(system['advantages'] as List).map((adv) => Padding(
                          padding: const EdgeInsets.only(left: 16, top: 2),
                          child: Text('• $adv', style: TextStyle(fontSize: 11, color: Colors.grey.shade700)),
                        )),

                        const SizedBox(height: 8),

                        // Inconvénients
                        const Text('⚠️ Fatiantoka:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12, color: Colors.orange)),
                        ...(system['disadvantages'] as List).map((dis) => Padding(
                          padding: const EdgeInsets.only(left: 16, top: 2),
                          child: Text('• $dis', style: TextStyle(fontSize: 11, color: Colors.grey.shade700)),
                        )),

                        // Conditions (New)
                        if (system.containsKey('conditions')) ...[
                          const SizedBox(height: 16),
                          Card(
                            elevation: 0,
                            color: Colors.blue.shade50,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(12),
                              side: BorderSide(color: Colors.blue.shade100),
                            ),
                            child: InkWell(
                              onTap: () {
                                showModalBottomSheet(
                                  context: context,
                                  isScrollControlled: true,
                                  backgroundColor: Colors.transparent,
                                  builder: (context) => Container(
                                    height: MediaQuery.of(context).size.height * 0.7,
                                    decoration: const BoxDecoration(
                                      color: Colors.white,
                                      borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
                                    ),
                                    child: Column(
                                      children: [
                                        Container(
                                          padding: const EdgeInsets.all(16),
                                          decoration: BoxDecoration(
                                            color: Colors.blue.shade50,
                                            borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
                                          ),
                                          child: Row(
                                            children: [
                                              Icon(Icons.thermostat, color: Colors.blue.shade700),
                                              const SizedBox(width: 12),
                                              Text('Fepetra ilaina (Conditions)', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.blue.shade900)),
                                              const Spacer(),
                                              IconButton(icon: const Icon(Icons.close), onPressed: () => Navigator.pop(context)),
                                            ],
                                          ),
                                        ),
                                        Expanded(
                                          child: ListView(
                                            padding: const EdgeInsets.all(20),
                                            children: (system['conditions'] as List).map((cond) => Padding(
                                              padding: const EdgeInsets.only(bottom: 12),
                                              child: Row(
                                                crossAxisAlignment: CrossAxisAlignment.start,
                                                children: [
                                                  Text('• ', style: TextStyle(color: Colors.blue.shade700, fontWeight: FontWeight.bold, fontSize: 16)),
                                                  Expanded(child: Text(cond, style: const TextStyle(fontSize: 15, height: 1.5))),
                                                ],
                                              ),
                                            )).toList(),
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                );
                              },
                              borderRadius: BorderRadius.circular(12),
                              child: Padding(
                                padding: const EdgeInsets.all(16),
                                child: Row(
                                  children: [
                                    Icon(Icons.thermostat, color: Colors.blue.shade700),
                                    const SizedBox(width: 12),
                                    Text('Fepetra ilaina (Conditions)', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14, color: Colors.blue.shade900)),
                                    const Spacer(),
                                    Icon(Icons.arrow_forward_ios, size: 16, color: Colors.blue.shade300),
                                  ],
                                ),
                              ),
                            ),
                          ),
                        ],

                        // Setup (New)
                        if (system.containsKey('setup')) ...[
                          const SizedBox(height: 12),
                          Card(
                            elevation: 0,
                            color: Colors.purple.shade50,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(12),
                              side: BorderSide(color: Colors.purple.shade100),
                            ),
                            child: InkWell(
                              onTap: () {
                                showModalBottomSheet(
                                  context: context,
                                  isScrollControlled: true,
                                  backgroundColor: Colors.transparent,
                                  builder: (context) => Container(
                                    height: MediaQuery.of(context).size.height * 0.7,
                                    decoration: const BoxDecoration(
                                      color: Colors.white,
                                      borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
                                    ),
                                    child: Column(
                                      children: [
                                        Container(
                                          padding: const EdgeInsets.all(16),
                                          decoration: BoxDecoration(
                                            color: Colors.purple.shade50,
                                            borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
                                          ),
                                          child: Row(
                                            children: [
                                              Icon(Icons.build, color: Colors.purple.shade700),
                                              const SizedBox(width: 12),
                                              Text('Fanombohana (Mise en place)', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.purple.shade900)),
                                              const Spacer(),
                                              IconButton(icon: const Icon(Icons.close), onPressed: () => Navigator.pop(context)),
                                            ],
                                          ),
                                        ),
                                        Expanded(
                                          child: ListView(
                                            padding: const EdgeInsets.all(20),
                                            children: (system['setup'] as List).map((step) => Padding(
                                              padding: const EdgeInsets.only(bottom: 12),
                                              child: Row(
                                                crossAxisAlignment: CrossAxisAlignment.start,
                                                children: [
                                                  Text('• ', style: TextStyle(color: Colors.purple.shade700, fontWeight: FontWeight.bold, fontSize: 16)),
                                                  Expanded(child: Text(step, style: const TextStyle(fontSize: 15, height: 1.5))),
                                                ],
                                              ),
                                            )).toList(),
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                );
                              },
                              borderRadius: BorderRadius.circular(12),
                              child: Padding(
                                padding: const EdgeInsets.all(16),
                                child: Row(
                                  children: [
                                    Icon(Icons.build, color: Colors.purple.shade700),
                                    const SizedBox(width: 12),
                                    Text('Fanombohana (Mise en place)', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14, color: Colors.purple.shade900)),
                                    const Spacer(),
                                    Icon(Icons.arrow_forward_ios, size: 16, color: Colors.purple.shade300),
                                  ],
                                ),
                              ),
                            ),
                          ),
                        ],

                        // Actions (New)
                        if (system.containsKey('actions')) ...[
                          const SizedBox(height: 12),
                          Card(
                            elevation: 0,
                            color: Colors.brown.shade50,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(12),
                              side: BorderSide(color: Colors.brown.shade100),
                            ),
                            child: InkWell(
                              onTap: () {
                                showModalBottomSheet(
                                  context: context,
                                  isScrollControlled: true,
                                  backgroundColor: Colors.transparent,
                                  builder: (context) => Container(
                                    height: MediaQuery.of(context).size.height * 0.7,
                                    decoration: const BoxDecoration(
                                      color: Colors.white,
                                      borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
                                    ),
                                    child: Column(
                                      children: [
                                        Container(
                                          padding: const EdgeInsets.all(16),
                                          decoration: BoxDecoration(
                                            color: Colors.brown.shade50,
                                            borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
                                          ),
                                          child: Row(
                                            children: [
                                              Icon(Icons.calendar_today, color: Colors.brown.shade700),
                                              const SizedBox(width: 12),
                                              Text('Asa atao (Actions)', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.brown.shade900)),
                                              const Spacer(),
                                              IconButton(icon: const Icon(Icons.close), onPressed: () => Navigator.pop(context)),
                                            ],
                                          ),
                                        ),
                                        Expanded(
                                          child: ListView(
                                            padding: const EdgeInsets.all(20),
                                            children: (system['actions'] as List).map((action) => Padding(
                                              padding: const EdgeInsets.only(bottom: 12),
                                              child: Row(
                                                crossAxisAlignment: CrossAxisAlignment.start,
                                                children: [
                                                  Text('• ', style: TextStyle(color: Colors.brown.shade700, fontWeight: FontWeight.bold, fontSize: 16)),
                                                  Expanded(child: Text(action, style: const TextStyle(fontSize: 15, height: 1.5))),
                                                ],
                                              ),
                                            )).toList(),
                                          ),
                                        ),
                                      ],
                                    ),
                                  ),
                                );
                              },
                              borderRadius: BorderRadius.circular(12),
                              child: Padding(
                                padding: const EdgeInsets.all(16),
                                child: Row(
                                  children: [
                                    Icon(Icons.calendar_today, color: Colors.brown.shade700),
                                    const SizedBox(width: 12),
                                    Text('Asa atao (Actions)', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14, color: Colors.brown.shade900)),
                                    const Spacer(),
                                    Icon(Icons.arrow_forward_ios, size: 16, color: Colors.brown.shade300),
                                  ],
                                ),
                              ),
                            ),
                          ),
                        ],

                        const SizedBox(height: 12),

                        // Matériaux
                        const Text('🛒 Fitaovana ilaina:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                        const SizedBox(height: 8),
                        ...(system['materials'] as List).map((mat) => Container(
                          margin: const EdgeInsets.only(bottom: 4),
                          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 6),
                          decoration: BoxDecoration(
                            color: Colors.grey.shade100,
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              Text(mat['name'] as String, style: const TextStyle(fontSize: 11)),
                              Text(mat['price'] as String, style: TextStyle(fontSize: 11, fontWeight: FontWeight.bold, color: Colors.green.shade700)),
                            ],
                          ),
                        )),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          )),
        ],
      ),
    );
  }

  Widget _buildFishChip(String text) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: Colors.cyan.shade200),
      ),
      child: Text(text, style: TextStyle(fontSize: 10, color: Colors.cyan.shade800)),
    );
  }
}

// ========== Trondro Feed Screen ==========
class TrondroFeedScreen extends StatelessWidget {
  const TrondroFeedScreen({super.key});

  @override
  Widget build(BuildContext context) {
    // Formules de provende par stade
    final provendeFormulas = [
      {
        'stage': 'DÉMARRAGE (0-1 volana)',
        'emoji': '🐣',
        'description': 'Ho an\'ny zana-trondro 1-30g. Protéine be ilaina.',
        'proteine': '35-40%',
        'dailyRate': '8-10% lanja vatana',
        'frequency': '4-6 x isan\'andro',
        'ingredients': [
          {'name': 'Lafarinina trondro', 'percentage': '25%', 'role': 'Protéine be'},
          {'name': 'Tourteau soja', 'percentage': '30%', 'role': 'Protéine sy energia'},
          {'name': 'Katsaka voatoto', 'percentage': '25%', 'role': 'Energia (glucides)'},
          {'name': 'Son de riz (Paombary)', 'percentage': '15%', 'role': 'Fibre sy vitamina B'},
          {'name': 'Menaka soja', 'percentage': '3%', 'role': 'Energia sy acide gras'},
          {'name': 'Prémix vitamina-mineraly', 'percentage': '2%', 'role': 'Vitamina sy mineraly'},
        ],
        'tips': 'Atao lafarinina madinika be (poudre fine). Famahana matetika fa kely.',
      },
      {
        'stage': 'CROISSANCE (1-4 volana)',
        'emoji': '📈',
        'description': 'Ho an\'ny trondro 30-150g. Mitombo haingana.',
        'proteine': '28-32%',
        'dailyRate': '4-6% lanja vatana',
        'frequency': '3-4 x isan\'andro',
        'ingredients': [
          {'name': 'Lafarinina trondro', 'percentage': '15%', 'role': 'Protéine'},
          {'name': 'Tourteau soja', 'percentage': '25%', 'role': 'Protéine sy energia'},
          {'name': 'Katsaka voatoto', 'percentage': '30%', 'role': 'Energia'},
          {'name': 'Son de riz (Paombary)', 'percentage': '22%', 'role': 'Fibre sy vitamina'},
          {'name': 'Son de blé', 'percentage': '5%', 'role': 'Fibre'},
          {'name': 'Prémix vitamina-mineraly', 'percentage': '2%', 'role': 'Vitamina'},
          {'name': 'Sira (NaCl)', 'percentage': '1%', 'role': 'Mineraly'},
        ],
        'tips': 'Atao granulés madinika (2-3mm). Azo ampiana ravina madinika.',
      },
      {
        'stage': 'FINITION / LEHIBE (4-6+ volana)',
        'emoji': '🏆',
        'description': 'Ho an\'ny trondro 150g+. Mampitombo lanja sy nofo.',
        'proteine': '25-28%',
        'dailyRate': '2-3% lanja vatana',
        'frequency': '2-3 x isan\'andro',
        'ingredients': [
          {'name': 'Lafarinina trondro', 'percentage': '10%', 'role': 'Protéine'},
          {'name': 'Tourteau soja', 'percentage': '20%', 'role': 'Protéine'},
          {'name': 'Katsaka voatoto', 'percentage': '35%', 'role': 'Energia'},
          {'name': 'Son de riz (Paombary)', 'percentage': '28%', 'role': 'Fibre'},
          {'name': 'Menaka soja', 'percentage': '3%', 'role': 'Energia'},
          {'name': 'Prémix vitamina-mineraly', 'percentage': '2%', 'role': 'Vitamina'},
          {'name': 'Calcium (coquille)', 'percentage': '2%', 'role': 'Mineraly'},
        ],
        'tips': 'Atao granulés lehibe (4-6mm). Azo ampiana ravina, legioma.',
      },
    ];
    
    final feedTypes = [
      {
        'name': 'Sakafo voajanahary',
        'emoji': '🌿',
        'description': 'Sakafo azo ao amin\'ny dobo na farihy',
        'types': [
          {'name': 'Plancton (algues microscopiques)', 'info': 'Sakafo voalohany ho an\'ny zana-trondro'},
          {'name': 'Zooplancton', 'info': 'Biby madinika ao anaty rano'},
          {'name': 'Ravina anaty rano (nénuphar)', 'info': 'Ho an\'ny Carpe chinoise'},
          {'name': 'Kankana (vers de terre)', 'info': 'Protéine betsaka 60-70%'},
          {'name': 'Bibikely anaty rano', 'info': 'Sakafo famenony'},
        ],
        'tips': 'Ampio zezika organika ao anaty dobo mba hampitombo ny plancton',
      },
      {
        'name': 'Olitra sy bibikely (Insectes)',
        'emoji': '🪲',
        'description': 'Loharanon-protéine tsara ho an\'ny trondro',
        'types': [
          {'name': 'Olitra BSF (Black Soldier Fly)', 'info': 'Protéine 40-45%, mora tezaina'},
          {'name': 'Vers de farine (Tenebrio)', 'info': 'Protéine 50-55%, sakafo tsara'},
          {'name': 'Kankana (vers de terre)', 'info': 'Protéine 60-70%, voajanahary'},
          {'name': 'Asticots (olitra lalitra)', 'info': 'Protéine 45-50%, azo atao maivamaivana'},
        ],
        'tips': 'Azo tezaina ao an-trano, mora sy tsy lafo. Sakafo famenony tsara indrindra.',
      },
      {
        'name': 'Fako sy sisan-tsakafo',
        'emoji': '♻️',
        'description': 'Fako azo ampiasaina ho sakafo trondro',
        'items': [
          {'name': 'Sisa-mofo', 'benefit': 'Glucides - energia'},
          {'name': 'Sisan-tsakafo (vary, legioma)', 'benefit': 'Mineraly sy vitamina'},
          {'name': 'Tavim-borona', 'benefit': 'Protéine - azo atao lafarinina'},
          {'name': 'Voa-tanimbary sisa', 'benefit': 'Energia sy fibre'},
        ],
      },
    ];

    return Scaffold(
      backgroundColor: const Color(0xFFF5F5F5),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.teal.shade600, Colors.green.shade600]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              children: [
                const Text('🦐', style: TextStyle(fontSize: 40)),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('SAKAFO TRONDRO',
                          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('Fomba famahanana Tilapia sy Carpe',
                          style: TextStyle(color: Colors.white.withValues(alpha: 0.9), fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // FORMULES DE PROVENDE Section
          const Text('🧪 FORMULE PROVENDE VITA AN-TRANO', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
          const SizedBox(height: 8),
          const Text('Fomba fanamboarana sakafo trondro araka ny taona', style: TextStyle(fontSize: 12, color: Colors.grey)),
          const SizedBox(height: 12),
          
          ...provendeFormulas.map((formula) => Container(
            margin: const EdgeInsets.only(bottom: 16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Theme(
              data: Theme.of(context).copyWith(dividerColor: Colors.transparent),
              child: ExpansionTile(
                leading: Text(formula['emoji'] as String, style: const TextStyle(fontSize: 32)),
                title: Text(formula['stage'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                subtitle: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(formula['description'] as String, style: TextStyle(fontSize: 10, color: Colors.grey.shade600)),
                    const SizedBox(height: 4),
                    Wrap(
                      spacing: 8,
                      children: [
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                          decoration: BoxDecoration(
                            color: Colors.red.shade100,
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Text('🥩 ${formula['proteine']}', style: TextStyle(fontSize: 9, color: Colors.red.shade800, fontWeight: FontWeight.bold)),
                        ),
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                          decoration: BoxDecoration(
                            color: Colors.blue.shade100,
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Text('📊 ${formula['dailyRate']}', style: TextStyle(fontSize: 9, color: Colors.blue.shade800)),
                        ),
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                          decoration: BoxDecoration(
                            color: Colors.orange.shade100,
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Text('⏰ ${formula['frequency']}', style: TextStyle(fontSize: 9, color: Colors.orange.shade800)),
                        ),
                      ],
                    ),
                  ],
                ),
                children: [
                  Padding(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text('📋 AKORA SY TAHA-NY:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                        const SizedBox(height: 8),
                        ...(formula['ingredients'] as List).map((ing) => Container(
                          margin: const EdgeInsets.only(bottom: 6),
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: Colors.teal.shade50,
                            borderRadius: BorderRadius.circular(8),
                            border: Border.all(color: Colors.teal.shade100),
                          ),
                          child: Row(
                            children: [
                              Container(
                                width: 45,
                                padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 4),
                                decoration: BoxDecoration(
                                  color: Colors.teal.shade600,
                                  borderRadius: BorderRadius.circular(6),
                                ),
                                child: Text(ing['percentage'] as String, style: const TextStyle(fontSize: 10, color: Colors.white, fontWeight: FontWeight.bold), textAlign: TextAlign.center),
                              ),
                              const SizedBox(width: 10),
                              Expanded(
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text(ing['name'] as String, style: const TextStyle(fontSize: 11, fontWeight: FontWeight.w600)),
                                    Text(ing['role'] as String, style: TextStyle(fontSize: 9, color: Colors.grey.shade600)),
                                  ],
                                ),
                              ),
                            ],
                          ),
                        )),
                        const SizedBox(height: 12),
                        Container(
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: Colors.amber.shade50,
                            borderRadius: BorderRadius.circular(8),
                            border: Border.all(color: Colors.amber.shade200),
                          ),
                          child: Row(
                            children: [
                              const Text('💡 ', style: TextStyle(fontSize: 16)),
                              Expanded(child: Text(formula['tips'] as String, style: TextStyle(fontSize: 11, color: Colors.amber.shade900))),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          )),

          const SizedBox(height: 20),

          // Sakafo voajanahary sy sisa
          const Text('🌿 SAKAFO HAFA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
          const SizedBox(height: 12),

          // Feed Types
          ...feedTypes.map((feed) => Container(
            margin: const EdgeInsets.only(bottom: 12),
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text(feed['emoji'] as String, style: const TextStyle(fontSize: 24)),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(feed['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                          Text(feed['description'] as String, style: TextStyle(fontSize: 10, color: Colors.grey.shade600)),
                        ],
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 12),
                if (feed['types'] != null) ...(feed['types'] as List).map((type) => Container(
                  margin: const EdgeInsets.only(bottom: 4),
                  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                  decoration: BoxDecoration(
                    color: Colors.teal.shade50,
                    borderRadius: BorderRadius.circular(6),
                  ),
                  child: Row(
                    children: [
                      const Text('🌱 ', style: TextStyle(fontSize: 12)),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(type['name'] as String, style: const TextStyle(fontSize: 11, fontWeight: FontWeight.w500)),
                            Text(type['info'] as String, style: TextStyle(fontSize: 9, color: Colors.grey.shade600)),
                          ],
                        ),
                      ),
                    ],
                  ),
                )),
                if (feed['items'] != null) ...(feed['items'] as List).map((item) => Container(
                  margin: const EdgeInsets.only(bottom: 4),
                  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                  decoration: BoxDecoration(
                    color: Colors.orange.shade50,
                    borderRadius: BorderRadius.circular(6),
                  ),
                  child: Row(
                    children: [
                      const Text('♻️ ', style: TextStyle(fontSize: 12)),
                      Expanded(child: Text(item['name'] as String, style: const TextStyle(fontSize: 11, fontWeight: FontWeight.w500))),
                      Text(item['benefit'] as String, style: TextStyle(fontSize: 9, color: Colors.grey.shade600)),
                    ],
                  ),
                )),
              ],
            ),
          )),
        ],
      ),
    );
  }
}

// ========== Trondro Health Screen ==========
class TrondroHealthScreen extends StatelessWidget {
  const TrondroHealthScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final diseases = [
      {
        'name': 'Aretina hoditra (Ich / White Spot)',
        'emoji': '⚪',
        'symptoms': ['Pentina fotsy eo amin\'ny hoditra', 'Miparitaka mafy', 'Tsy te-hisakafo', 'Mikitroka amin\'ny rindrina'],
        'causes': 'Parasita (Ichthyophthirius), rano maloto, stress',
        'treatment': [
          'Asondrotra ny hafanan\'ny rano 28-30°C',
          'Ampio sira (3-5g/L) mandritra 3-5 andro',
          'Ovao ny rano 30-50%',
          'Fongicide (Malachite Green) raha mafy',
        ],
        'prevention': 'Rano madio, tsy misy stress, atokana ny trondro vaovao',
      },
      {
        'name': 'Aretina bakteria (Aeromonas)',
        'emoji': '🦠',
        'symptoms': ['Fery eo amin\'ny vatana', 'Menaka mivoaka', 'Kibo mivonto', 'Maso mibontsina'],
        'causes': 'Bakteria (Aeromonas hydrophila), rano maloto, fery',
        'treatment': [
          'Ampio sira (5g/L)',
          'Antibiotika ao anaty sakafo (Oxytetracycline)',
          'Esory ny trondro marary',
          'Diovy ny rano',
        ],
        'prevention': 'Rano madio, sakafo tsara, tsy misy fery',
      },
      {
        'name': 'Fongoza (Saprolegnia)',
        'emoji': '🍄‍🟫',
        'symptoms': ['Fotaka fotsy eo amin\'ny hoditra', 'Toy ny coton', 'Rameva simba'],
        'causes': 'Champignon, rano ratsy, fery efa misy',
        'treatment': [
          'Esory ny fongoza amin\'ny tanana',
          'Ampio sira (10g/L) mandritra 15-30 minitra',
          'Potassium permanganate (2mg/L)',
        ],
        'prevention': 'Rano madio, tsy misy fery, atokana',
      },
      {
        'name': 'Tsy fahampian\'oxygène',
        'emoji': '💨',
        'symptoms': ['Misokatra eo ambonin\'ny rano', 'Miaina mafy', 'Tsy mihetsika', 'Maty tampoka'],
        'causes': 'Rano be loatra, mafana loatra, plancton be loatra',
        'treatment': [
          'Ampio aérateur na pompe',
          'Ovao ny rano 50%',
          'Ahena ny isan\'ny trondro',
          'Aza mamahana be loatra',
        ],
        'prevention': 'Aérateur tsara, tsy be loatra trondro, rano misolo',
      },
    ];

    final healthTips = [
      {'tip': 'Jereo ny rano isan\'andro (loko, fofona, temperature)', 'icon': '👀'},
      {'tip': 'Ovao ny rano 20-30% isan-kerinandro', 'icon': '💧'},
      {'tip': 'Aza mamahana be loatra', 'icon': '🍽️'},
      {'tip': 'Esory haingana ny trondro maty', 'icon': '🗑️'},
      {'tip': 'Atokana ny trondro vaovao 2 herinandro', 'icon': '🏥'},
      {'tip': 'Diovy ny fitaovana tsindraindray', 'icon': '🧹'},
    ];

    return Scaffold(
      backgroundColor: const Color(0xFFF5F5F5),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.red.shade600, Colors.pink.shade600]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              children: [
                const Text('🩺', style: TextStyle(fontSize: 40)),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('FAHASALAMANA TRONDRO',
                          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('Aretina sy fitsaboana',
                          style: TextStyle(color: Colors.white.withValues(alpha: 0.9), fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Health Tips
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.green.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.green.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('💡', style: TextStyle(fontSize: 24)),
                    SizedBox(width: 8),
                    Text('TOROHEVITRA FAHASALAMANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 12),
                Wrap(
                  spacing: 8,
                  runSpacing: 8,
                  children: healthTips.map((tip) => Container(
                    padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(20),
                      border: Border.all(color: Colors.green.shade300),
                    ),
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        Text(tip['icon'] as String, style: const TextStyle(fontSize: 14)),
                        const SizedBox(width: 6),
                        Flexible(child: Text(tip['tip'] as String, style: const TextStyle(fontSize: 11))),
                      ],
                    ),
                  )).toList(),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          const Text('ARETINA MAHAZATRA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
          const SizedBox(height: 12),

          // Diseases
          ...diseases.map((disease) => Container(
            margin: const EdgeInsets.only(bottom: 16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Theme(
              data: Theme.of(context).copyWith(dividerColor: Colors.transparent),
              child: ExpansionTile(
                leading: Text(disease['emoji'] as String, style: const TextStyle(fontSize: 28)),
                title: Text(disease['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                subtitle: Text('Antony: ${disease['causes']}', style: TextStyle(fontSize: 10, color: Colors.grey.shade600)),
                children: [
                  Padding(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text('🔍 Famantarana:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                        ...(disease['symptoms'] as List).map((sym) => Padding(
                          padding: const EdgeInsets.only(left: 16, top: 2),
                          child: Text('• $sym', style: TextStyle(fontSize: 11, color: Colors.grey.shade700)),
                        )),
                        const SizedBox(height: 12),
                        const Text('💊 Fitsaboana:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12, color: Colors.green)),
                        ...(disease['treatment'] as List).map((treat) => Padding(
                          padding: const EdgeInsets.only(left: 16, top: 2),
                          child: Text('• $treat', style: TextStyle(fontSize: 11, color: Colors.grey.shade700)),
                        )),
                        const SizedBox(height: 8),
                        Container(
                          padding: const EdgeInsets.all(8),
                          decoration: BoxDecoration(
                            color: Colors.blue.shade50,
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Row(
                            children: [
                              const Text('🛡️ ', style: TextStyle(fontSize: 14)),
                              Expanded(child: Text('Fisorohana: ${disease['prevention']}', style: TextStyle(fontSize: 11, color: Colors.blue.shade800))),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          )),
        ],
      ),
    );
  }
}

// ========== Trondro Water Screen ==========
class TrondroWaterScreen extends StatelessWidget {
  const TrondroWaterScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final waterParams = [
      {
        'name': 'Temperature',
        'emoji': '🌡️',
        'optimal': '25-30°C (Tilapia), 20-28°C (Carpe)',
        'danger': '<18°C na >35°C',
        'tips': 'Alokaloka amin\'ny masoandro mafana, ampio rano mangatsiaka rehefa mafana loatra',
      },
      {
        'name': 'pH',
        'emoji': '⚗️',
        'optimal': '6.5-8.5',
        'danger': '<6 na >9',
        'tips': 'Ampio calcium (coquille) raha ambany loatra, ovao ny rano raha ambony loatra',
      },
      {
        'name': 'Oxygène dissous',
        'emoji': '💨',
        'optimal': '>5 mg/L',
        'danger': '<3 mg/L',
        'tips': 'Ampio aérateur, aza mamahana be loatra, ahena ny trondro raha be loatra',
      },
      {
        'name': 'Ammoniaque (NH3)',
        'emoji': '⚠️',
        'optimal': '<0.02 mg/L',
        'danger': '>0.1 mg/L (poizina!)',
        'tips': 'Ovao ny rano matetika, aza mamahana be, esory ny fako sy trondro maty',
      },
      {
        'name': 'Transparence (Fahazavan\'ny rano)',
        'emoji': '👁️',
        'optimal': '30-40 cm (mahita ny ambany)',
        'danger': '<15 cm (mainty loatra)',
        'tips': 'Raha mainty loatra = plancton be, ovao ny rano 20-30%. Raha mazava loatra = tsy ampy sakafo.',
      },
    ];

    final waterSources = [
      {
        'source': 'Rano avy amin\'ny fantsakana',
        'emoji': '🚰',
        'quality': 'Tsara',
        'notes': 'Avelao 24 ora mba hanesorana chlore alohan\'ny fampiasana',
      },
      {
        'source': 'Rano orana',
        'emoji': '🌧️',
        'quality': 'Tsara be',
        'notes': 'Tsara indrindra, tsy misy produit chimique',
      },
      {
        'source': 'Rano avy amin\'ny dobo/farihy',
        'emoji': '🏞️',
        'quality': 'Antonony',
        'notes': 'Mety misy parasite, jereo tsara aloha',
      },
      {
        'source': 'Rano renirano',
        'emoji': '🌊',
        'quality': 'Antonony',
        'notes': 'Mety misy loto, diovy aloha raha azo atao',
      },
    ];

    return Scaffold(
      backgroundColor: const Color(0xFFF5F5F5),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.blue.shade600, Colors.cyan.shade600]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              children: [
                const Text('💧', style: TextStyle(fontSize: 40)),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('FITANTANANA RANO',
                          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('Kalitao sy fikojakojana rano',
                          style: TextStyle(color: Colors.white.withValues(alpha: 0.9), fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Water Parameters
          const Text('PARAMÈTRE RANO', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
          const SizedBox(height: 12),

          ...waterParams.map((param) => Container(
            margin: const EdgeInsets.only(bottom: 12),
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text(param['emoji'] as String, style: const TextStyle(fontSize: 24)),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Text(param['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                Row(
                  children: [
                    Expanded(
                      child: Container(
                        padding: const EdgeInsets.all(8),
                        decoration: BoxDecoration(
                          color: Colors.green.shade50,
                          borderRadius: BorderRadius.circular(6),
                        ),
                        child: Column(
                          children: [
                            Text('✅ Tsara', style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: Colors.green.shade700)),
                            Text(param['optimal'] as String, style: const TextStyle(fontSize: 10)),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(width: 8),
                    Expanded(
                      child: Container(
                        padding: const EdgeInsets.all(8),
                        decoration: BoxDecoration(
                          color: Colors.red.shade50,
                          borderRadius: BorderRadius.circular(6),
                        ),
                        child: Column(
                          children: [
                            Text('⚠️ Loza', style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: Colors.red.shade700)),
                            Text(param['danger'] as String, style: const TextStyle(fontSize: 10)),
                          ],
                        ),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                Container(
                  padding: const EdgeInsets.all(8),
                  decoration: BoxDecoration(
                    color: Colors.blue.shade50,
                    borderRadius: BorderRadius.circular(6),
                  ),
                  child: Row(
                    children: [
                      const Text('💡 ', style: TextStyle(fontSize: 12)),
                      Expanded(child: Text(param['tips'] as String, style: TextStyle(fontSize: 10, color: Colors.blue.shade800))),
                    ],
                  ),
                ),
              ],
            ),
          )),

          const SizedBox(height: 20),

          // Water Sources
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('🚿', style: TextStyle(fontSize: 24)),
                    SizedBox(width: 8),
                    Text('LOHARANO RANO', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                  ],
                ),
                const Divider(),
                ...waterSources.map((source) => Container(
                  margin: const EdgeInsets.only(bottom: 8),
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: Colors.cyan.shade50,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    children: [
                      Text(source['emoji'] as String, style: const TextStyle(fontSize: 24)),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                Text(source['source'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                                const SizedBox(width: 8),
                                Container(
                                  padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                                  decoration: BoxDecoration(
                                    color: source['quality'] == 'Tsara be' ? Colors.green.shade100 : 
                                           source['quality'] == 'Tsara' ? Colors.blue.shade100 : Colors.orange.shade100,
                                    borderRadius: BorderRadius.circular(10),
                                  ),
                                  child: Text(source['quality'] as String, style: const TextStyle(fontSize: 9)),
                                ),
                              ],
                            ),
                            Text(source['notes'] as String, style: TextStyle(fontSize: 10, color: Colors.grey.shade600)),
                          ],
                        ),
                      ),
                    ],
                  ),
                )),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Water Change Schedule
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.amber.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.amber.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('🔄', style: TextStyle(fontSize: 24)),
                    SizedBox(width: 8),
                    Text('FANOVANA RANO', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 12),
                _buildWaterTip('Hors sol (basin)', 'Ovao 20-30% isan-kerinandro'),
                _buildWaterTip('Dobo kely', 'Ovao 10-20% isan-kerinandro'),
                _buildWaterTip('Farihy lehibe', 'Avelao mikoriana, jereo ny kalitao'),
                _buildWaterTip('Rano velona', 'Tsy mila ovaina, efa mikoriana'),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildWaterTip(String system, String tip) {
    return Container(
      margin: const EdgeInsets.only(bottom: 8),
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(8),
      ),
      child: Row(
        children: [
          const Text('💧 ', style: TextStyle(fontSize: 14)),
          Text('$system: ', style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 11)),
          Expanded(child: Text(tip, style: TextStyle(fontSize: 11, color: Colors.grey.shade700))),
        ],
      ),
    );
  }
}

// ==================== TANTELYTECH - APICULTURE ====================

// ========== Tantely Hives Screen ==========
class TantelyHivesScreen extends StatelessWidget {
  const TantelyHivesScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final hiveTypes = [
      {
        'name': 'Toho-tantely Langstroth',
        'emoji': '📦',
        'type': 'moderne',
        'description': 'Toho-tantely mahazatra maneran-tany. Misy cadre amovible.',
        'capacity': '10 cadres',
        'price': '150,000-250,000 Ar',
        'advantages': [
          'Mora jerena ny tantely',
          'Cadre amovible - mora vokarina',
          'Azo ampiana hausse',
          'Standard maneran-tany',
        ],
        'disadvantages': [
          'Lafo noho ny voajanahary',
          'Mila fitaovana manokana',
        ],
        'materials': [
          {'name': 'Toho-tantely Langstroth feno', 'price': '180,000-250,000 Ar'},
          {'name': 'Hausse (fanampin-trano)', 'price': '60,000-80,000 Ar'},
          {'name': 'Cadre miaraka cire gaufrée', 'price': '8,000-12,000 Ar/iray'},
          {'name': 'Nourrisseur', 'price': '15,000-25,000 Ar'},
        ],
      },
      {
        'name': 'Toho-tantely Dadant',
        'emoji': '🏠',
        'type': 'moderne',
        'description': 'Toho-tantely lehibe kokoa, tsara ho an\'ny tantely maro.',
        'capacity': '10-12 cadres',
        'price': '180,000-280,000 Ar',
        'advantages': [
          'Lehibe - tantely maro',
          'Tsara amin\'ny ririnina',
          'Mora miasa',
        ],
        'disadvantages': [
          'Mavesatra kokoa',
          'Tsy dia misy eto Madagasikara',
        ],
        'materials': [
          {'name': 'Toho-tantely Dadant feno', 'price': '200,000-280,000 Ar'},
          {'name': 'Hausse Dadant', 'price': '70,000-90,000 Ar'},
          {'name': 'Cadre Dadant', 'price': '10,000-15,000 Ar/iray'},
        ],
      },
      {
        'name': 'Toho-tantely Keniana (Top Bar)',
        'emoji': '📐',
        'type': 'voajanahary',
        'description': 'Toho-tantely tsotra, mora vita an-trano. Bar ambony fotsiny.',
        'capacity': '20-30 bars',
        'price': '50,000-100,000 Ar',
        'advantages': [
          'Mora vita an-trano',
          'Tsy lafo',
          'Tsara ho an\'ny mpianatra',
          'Voajanahary kokoa',
        ],
        'disadvantages': [
          'Sarotra kokoa ny fijinjana',
          'Tsy azo ampiana hausse',
        ],
        'materials': [
          {'name': 'Hazo (planches)', 'price': '30,000-50,000 Ar'},
          {'name': 'Top bars (24 pièces)', 'price': '15,000-25,000 Ar'},
          {'name': 'Vy fiarovana', 'price': '10,000-15,000 Ar'},
        ],
      },
      {
        'name': 'Toho-tantely nentin-drazana',
        'emoji': '🪵',
        'type': 'voajanahary',
        'description': 'Toho-tantely vita amin\'ny hazo na tany. Fomba nentin-drazana.',
        'capacity': 'Miovaova',
        'price': '10,000-50,000 Ar',
        'advantages': [
          'Tsy lafo mihitsy',
          'Fitaovana voajanahary',
          'Mora hita eny an-toerana',
        ],
        'disadvantages': [
          'Sarotra jerena ny tantely',
          'Manimba ny tantely rehefa mijinja',
          'Tsy mahomby loatra',
        ],
        'materials': [
          {'name': 'Vata hazo', 'price': '10,000-30,000 Ar'},
          {'name': 'Tany (poterie)', 'price': '5,000-15,000 Ar'},
          {'name': 'Kitay fiarovana', 'price': '5,000 Ar'},
        ],
      },
    ];

    final beeSpecies = [
      {
        'name': 'Apis mellifera (Tantely Eoropeana)',
        'emoji': '🐝',
        'origin': 'Nampidirina',
        'productivity': 'Ambony (15-30 kg/taona)',
        'temperament': 'Malemy - antonony',
        'advantages': ['Vokatra betsaka', 'Malemy', 'Mora fehezina'],
        'price': '80,000-150,000 Ar/colonie',
      },
      {
        'name': 'Apis mellifera unicolor',
        'emoji': '🐝',
        'origin': 'Malagasy',
        'productivity': 'Antonony (8-15 kg/taona)',
        'temperament': 'Masiaka kokoa',
        'advantages': ['Mahazaka ny toetr\'andro', 'Tsy mila fikarakarana be', 'Mahery amin\'ny aretina'],
        'price': '50,000-100,000 Ar/colonie',
      },
    ];

    final equipment = [
      {'name': 'Akanjo fiarovana feno', 'price': '80,000-150,000 Ar', 'essential': true},
      {'name': 'Gant (gants)', 'price': '15,000-30,000 Ar', 'essential': true},
      {'name': 'Enfumoir (setroka)', 'price': '25,000-50,000 Ar', 'essential': true},
      {'name': 'Lève-cadre', 'price': '10,000-20,000 Ar', 'essential': true},
      {'name': 'Brosse à abeilles', 'price': '8,000-15,000 Ar', 'essential': true},
      {'name': 'Extracteur tantely (manuel)', 'price': '200,000-400,000 Ar', 'essential': false},
      {'name': 'Bac à désoperculer', 'price': '50,000-100,000 Ar', 'essential': false},
      {'name': 'Couteau à désoperculer', 'price': '15,000-30,000 Ar', 'essential': false},
      {'name': 'Maturateur (cuve)', 'price': '80,000-200,000 Ar', 'essential': false},
    ];

    return Scaffold(
      backgroundColor: const Color(0xFFF5F5F5),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.amber.shade600, Colors.orange.shade600]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              children: [
                const Text('🐝', style: TextStyle(fontSize: 40)),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('TOHO-TANTELY & FITAOVANA',
                          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('Karazana toho-tantely sy fitaovana ilaina',
                          style: TextStyle(color: Colors.white.withValues(alpha: 0.9), fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Bee Species
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('🐝', style: TextStyle(fontSize: 24)),
                    SizedBox(width: 8),
                    Text('KARAZANA TANTELY', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                  ],
                ),
                const Divider(),
                ...beeSpecies.map((bee) => Container(
                  margin: const EdgeInsets.only(bottom: 12),
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.amber.shade50,
                    borderRadius: BorderRadius.circular(10),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Text(bee['emoji'] as String, style: const TextStyle(fontSize: 28)),
                          const SizedBox(width: 12),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(bee['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                                Text('🌍 ${bee['origin']}', style: TextStyle(fontSize: 11, color: Colors.grey.shade600)),
                              ],
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 8),
                      Wrap(
                        spacing: 6,
                        runSpacing: 4,
                        children: [
                          _buildBeeChip('📊 ${bee['productivity']}'),
                          _buildBeeChip('🎭 ${bee['temperament']}'),
                        ],
                      ),
                      const SizedBox(height: 8),
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                        decoration: BoxDecoration(
                          color: Colors.green.shade100,
                          borderRadius: BorderRadius.circular(6),
                        ),
                        child: Text('💰 ${bee['price']}', style: TextStyle(fontSize: 11, fontWeight: FontWeight.bold, color: Colors.green.shade800)),
                      ),
                    ],
                  ),
                )),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Hive Types
          const Text('KARAZANA TOHO-TANTELY', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
          const SizedBox(height: 12),

          ...hiveTypes.map((hive) => Container(
            margin: const EdgeInsets.only(bottom: 16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Theme(
              data: Theme.of(context).copyWith(dividerColor: Colors.transparent),
              child: ExpansionTile(
                leading: Text(hive['emoji'] as String, style: const TextStyle(fontSize: 32)),
                title: Text(hive['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                subtitle: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(hive['description'] as String, style: TextStyle(fontSize: 11, color: Colors.grey.shade600)),
                    const SizedBox(height: 4),
                    Wrap(
                      spacing: 6,
                      runSpacing: 4,
                      children: [
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                          decoration: BoxDecoration(
                            color: Colors.amber.shade100,
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Text('📊 ${hive['capacity']}', style: TextStyle(fontSize: 10, color: Colors.amber.shade800)),
                        ),
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                          decoration: BoxDecoration(
                            color: Colors.green.shade100,
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Text('💰 ${hive['price']}', style: TextStyle(fontSize: 10, color: Colors.green.shade800)),
                        ),
                      ],
                    ),
                  ],
                ),
                children: [
                  Padding(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text('✅ Tombony:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12, color: Colors.green)),
                        ...(hive['advantages'] as List).map((adv) => Padding(
                          padding: const EdgeInsets.only(left: 8, top: 4),
                          child: Text('• $adv', style: TextStyle(fontSize: 11, color: Colors.grey.shade700)),
                        )),
                        const SizedBox(height: 12),
                        const Text('❌ Tsy tombony:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12, color: Colors.red)),
                        ...(hive['disadvantages'] as List).map((dis) => Padding(
                          padding: const EdgeInsets.only(left: 8, top: 4),
                          child: Text('• $dis', style: TextStyle(fontSize: 11, color: Colors.grey.shade700)),
                        )),
                        const SizedBox(height: 12),
                        const Text('🛠️ Fitaovana sy vidiny:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                        ...(hive['materials'] as List).map((mat) => Container(
                          margin: const EdgeInsets.only(top: 4),
                          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                          decoration: BoxDecoration(
                            color: Colors.grey.shade100,
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              Expanded(child: Text(mat['name'] as String, style: const TextStyle(fontSize: 11))),
                              Text(mat['price'] as String, style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: Colors.green.shade700)),
                            ],
                          ),
                        )),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          )),

          const SizedBox(height: 20),

          // Equipment
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('🛠️', style: TextStyle(fontSize: 24)),
                    SizedBox(width: 8),
                    Text('FITAOVANA ILAINA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
                  ],
                ),
                const Divider(),
                ...equipment.map((eq) => Container(
                  margin: const EdgeInsets.only(bottom: 6),
                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                  decoration: BoxDecoration(
                    color: (eq['essential'] as bool) ? Colors.amber.shade50 : Colors.grey.shade50,
                    borderRadius: BorderRadius.circular(8),
                    border: Border.all(color: (eq['essential'] as bool) ? Colors.amber.shade200 : Colors.grey.shade200),
                  ),
                  child: Row(
                    children: [
                      Text((eq['essential'] as bool) ? '⭐' : '➕', style: const TextStyle(fontSize: 14)),
                      const SizedBox(width: 8),
                      Expanded(child: Text(eq['name'] as String, style: const TextStyle(fontSize: 12))),
                      Text(eq['price'] as String, style: TextStyle(fontSize: 11, fontWeight: FontWeight.bold, color: Colors.green.shade700)),
                    ],
                  ),
                )),
                const SizedBox(height: 8),
                Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                      decoration: BoxDecoration(color: Colors.amber.shade100, borderRadius: BorderRadius.circular(4)),
                      child: const Text('⭐ Tena ilaina', style: TextStyle(fontSize: 10)),
                    ),
                    const SizedBox(width: 8),
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                      decoration: BoxDecoration(color: Colors.grey.shade100, borderRadius: BorderRadius.circular(4)),
                      child: const Text('➕ Azo atao tsy misy', style: TextStyle(fontSize: 10)),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildBeeChip(String text) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
      decoration: BoxDecoration(
        color: Colors.orange.shade100,
        borderRadius: BorderRadius.circular(12),
      ),
      child: Text(text, style: TextStyle(fontSize: 10, color: Colors.orange.shade800)),
    );
  }
}

// ========== Tantely Products Screen ==========
class TantelyProductsScreen extends StatelessWidget {
  const TantelyProductsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final products = [
      {
        'name': 'Tantely (Miel)',
        'emoji': '🍯',
        'description': 'Vokatra voalohany sy lafo indrindra.',
        'production': '10-30 kg/toho-tantely/taona',
        'price': '25,000-50,000 Ar/kg',
        'uses': ['Sakafo', 'Fanafody', 'Cosmétique'],
        'storage': 'Tsy misy fe-potoana raha tsara fitehirizana',
        'tips': 'Aza hafanaina mihoatra 40°C. Tehirizo amin\'ny toerana maina.',
      },
      {
        'name': 'Savoka (Cire d\'abeille)',
        'emoji': '🕯️',
        'description': 'Savoka vita amin\'ny tantely. Misy vidiny.',
        'production': '0.5-1 kg/toho-tantely/taona',
        'price': '80,000-150,000 Ar/kg',
        'uses': ['Labozia', 'Cosmétique', 'Fanafody', 'Fanaovana cadre'],
        'storage': 'Tsy misy fe-potoana',
        'tips': 'Diovin tsara amin\'ny rano mafana. Azo amidy na ampiasaina.',
      },
      {
        'name': 'Propolis',
        'emoji': '🟤',
        'description': 'Résine nangonin\'ny tantely. Fanafody mahery.',
        'production': '50-300 g/toho-tantely/taona',
        'price': '200,000-400,000 Ar/kg',
        'uses': ['Fanafody', 'Antibiotika voajanahary', 'Cosmétique'],
        'storage': 'Tehirizo amin\'ny toerana mangatsika',
        'tips': 'Azo atao teinture amin\'ny alcool. Lafo be!',
      },
      {
        'name': 'Gelée royale',
        'emoji': '👑',
        'description': 'Sakafo ho an\'ny mpanjaka-tantely. Sarobidy.',
        'production': '200-500 g/toho-tantely/taona',
        'price': '500,000-1,000,000 Ar/kg',
        'uses': ['Complément alimentaire', 'Anti-vieillissement', 'Fanafody'],
        'storage': 'Tehirizo amin\'ny frigidaire (-18°C)',
        'tips': 'Mila technique manokana. Lafo indrindra!',
      },
      {
        'name': 'Pollen',
        'emoji': '🌼',
        'description': 'Vovony nangonin\'ny tantely. Protéine betsaka.',
        'production': '1-5 kg/toho-tantely/taona',
        'price': '100,000-200,000 Ar/kg',
        'uses': ['Complément alimentaire', 'Protéine voajanahary'],
        'storage': 'Tehirizo maina na congelé',
        'tips': 'Mila trappe pollen manokana.',
      },
      {
        'name': 'Essaim (Colonie)',
        'emoji': '🐝',
        'description': 'Fivarotana tantely feno. Orinasa vaovao.',
        'production': '1-3 essaims/toho-tantely/taona',
        'price': '80,000-150,000 Ar/colonie',
        'uses': ['Fampitomboana toho-tantely', 'Fivarotana'],
        'storage': 'Tsy tehirizina - amidy haingana',
        'tips': 'Tsara indrindra amin\'ny lohataona.',
      },
    ];

    final harvestCalendar = [
      {'month': 'Oktobra-Novambra', 'activity': 'Fotoana voalohany mijinja', 'emoji': '🍯'},
      {'month': 'Febroary-Martsa', 'activity': 'Fotoana faharoa mijinja', 'emoji': '🍯'},
      {'month': 'Jolay-Aogositra', 'activity': 'Fikarakarana - tsy mijinja', 'emoji': '❄️'},
    ];

    return Scaffold(
      backgroundColor: const Color(0xFFF5F5F5),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.amber.shade700, Colors.orange.shade600]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              children: [
                const Text('🍯', style: TextStyle(fontSize: 40)),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('VOKATRA TANTELY',
                          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('Tantely, Savoka, Propolis, Gelée royale...',
                          style: TextStyle(color: Colors.white.withValues(alpha: 0.9), fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Harvest Calendar
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.amber.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.amber.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('📅', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('FOTOANA FIJINJANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 12),
                ...harvestCalendar.map((cal) => Container(
                  margin: const EdgeInsets.only(bottom: 6),
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    children: [
                      Text(cal['emoji'] as String, style: const TextStyle(fontSize: 20)),
                      const SizedBox(width: 10),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(cal['month'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                            Text(cal['activity'] as String, style: TextStyle(fontSize: 11, color: Colors.grey.shade600)),
                          ],
                        ),
                      ),
                    ],
                  ),
                )),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Products
          const Text('VOKATRA REHETRA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
          const SizedBox(height: 12),

          ...products.map((product) => Container(
            margin: const EdgeInsets.only(bottom: 16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Theme(
              data: Theme.of(context).copyWith(dividerColor: Colors.transparent),
              child: ExpansionTile(
                leading: Text(product['emoji'] as String, style: const TextStyle(fontSize: 32)),
                title: Text(product['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                subtitle: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(product['description'] as String, style: TextStyle(fontSize: 11, color: Colors.grey.shade600)),
                    const SizedBox(height: 4),
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                      decoration: BoxDecoration(
                        color: Colors.green.shade100,
                        borderRadius: BorderRadius.circular(6),
                      ),
                      child: Text('💰 ${product['price']}', style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: Colors.green.shade800)),
                    ),
                  ],
                ),
                children: [
                  Padding(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          children: [
                            const Text('📊 Vokatra: ', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 11)),
                            Expanded(child: Text(product['production'] as String, style: TextStyle(fontSize: 11, color: Colors.grey.shade700))),
                          ],
                        ),
                        const SizedBox(height: 8),
                        const Text('🎯 Fampiasana:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 11)),
                        Wrap(
                          spacing: 6,
                          runSpacing: 4,
                          children: (product['uses'] as List).map((use) => Container(
                            margin: const EdgeInsets.only(top: 4),
                            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                            decoration: BoxDecoration(
                              color: Colors.amber.shade100,
                              borderRadius: BorderRadius.circular(12),
                            ),
                            child: Text(use as String, style: TextStyle(fontSize: 10, color: Colors.amber.shade800)),
                          )).toList(),
                        ),
                        const SizedBox(height: 8),
                        Row(
                          children: [
                            const Text('📦 Fitehirizana: ', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 11)),
                            Expanded(child: Text(product['storage'] as String, style: TextStyle(fontSize: 11, color: Colors.grey.shade700))),
                          ],
                        ),
                        const SizedBox(height: 8),
                        Container(
                          padding: const EdgeInsets.all(8),
                          decoration: BoxDecoration(
                            color: Colors.blue.shade50,
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Row(
                            children: [
                              const Text('💡 ', style: TextStyle(fontSize: 14)),
                              Expanded(child: Text(product['tips'] as String, style: TextStyle(fontSize: 11, color: Colors.blue.shade800))),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          )),
        ],
      ),
    );
  }
}

// ========== Tantely Health Screen ==========
class TantelyHealthScreen extends StatelessWidget {
  const TantelyHealthScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final diseases = [
      {
        'name': 'Varroa destructor',
        'emoji': '🦟',
        'type': 'Parasita',
        'symptoms': ['Tantely malemy', 'Elatra tsy milamina', 'Colonie mihena haingana'],
        'causes': 'Mite parasita mikiky ny tantely',
        'treatment': [
          'Acide oxalique (vapotraka na goutte)',
          'Acide formique',
          'Thymol (voajanahary)',
          'Traitement chimique (Apivar, Apistan)',
        ],
        'prevention': 'Jereo matetika, traitement isan-taona',
      },
      {
        'name': 'Loque américaine',
        'emoji': '🦠',
        'type': 'Bakteria',
        'symptoms': ['Couvain maty', 'Fofona ratsy', 'Opercule voatrobaka'],
        'causes': 'Bakteria (Paenibacillus larvae)',
        'treatment': [
          'TSY AHOANA - Doroy ny toho-tantely',
          'Aoka tsy hifindra amin\'ny hafa',
          'Ampahafantaro ny manam-pahaizana',
        ],
        'prevention': 'Aza mividy tantely tsy fantatra niaviana. Diovy fitaovana.',
      },
      {
        'name': 'Nosema',
        'emoji': '🔬',
        'type': 'Champignon',
        'symptoms': ['Tantely tsy afaka manidina tsara', 'Diky eo amin\'ny fidirana', 'Colonie malemy'],
        'causes': 'Microsporidies (Nosema apis/ceranae)',
        'treatment': [
          'Fumagillin (antibiotika)',
          'Sirop sucré mafana',
          'Diovy ny toho-tantely',
        ],
        'prevention': 'Toho-tantely maina, tsy misy hamandoana.',
      },
      {
        'name': 'Fausse teigne',
        'emoji': '🦋',
        'type': 'Bibikely',
        'symptoms': ['Harato (toile) ao anaty cadre', 'Savoka simba', 'Olitra fotsy'],
        'causes': 'Papillon (Galleria mellonella)',
        'treatment': [
          'Esory ny cadre simba',
          'Diovin\'ny toho-tantely',
          'Tehirizo ny cadre amin\'ny toerana mangatsika',
        ],
        'prevention': 'Colonie matanjaka. Toho-tantely tsy misy banga.',
      },
    ];

    final healthTips = [
      {'tip': 'Jereo ny toho-tantely isaky ny 15 andro', 'icon': '👀'},
      {'tip': 'Aza manokatra amin\'ny andro ririnina na orana', 'icon': '🌧️'},
      {'tip': 'Diovy ny fitaovana isaky ny ampiasana', 'icon': '🧹'},
      {'tip': 'Omeo sakafo raha tsy ampy ny voninkazo', 'icon': '🍬'},
      {'tip': 'Aza mampiasa pesticide eo akaikin\'ny toho-tantely', 'icon': '🚫'},
      {'tip': 'Ampidiro mpanjaka vaovao raha antitra', 'icon': '👑'},
    ];

    return Scaffold(
      backgroundColor: const Color(0xFFF5F5F5),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.red.shade400, Colors.orange.shade400]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              children: [
                const Text('🩺', style: TextStyle(fontSize: 40)),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('FAHASALAMAN\'NY TANTELY',
                          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('Aretina sy fitsaboana - Fisorohana',
                          style: TextStyle(color: Colors.white.withValues(alpha: 0.9), fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Health Tips
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.green.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.green.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('💚', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('TOROHEVITRA FAHASALAMANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 12),
                ...healthTips.map((tip) => Container(
                  margin: const EdgeInsets.only(bottom: 6),
                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                  decoration: BoxDecoration(
                    color: Colors.white,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    children: [
                      Text(tip['icon'] as String, style: const TextStyle(fontSize: 16)),
                      const SizedBox(width: 10),
                      Expanded(child: Text(tip['tip'] as String, style: const TextStyle(fontSize: 12))),
                    ],
                  ),
                )),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Diseases
          const Text('ARETINA MAHAZATRA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
          const SizedBox(height: 12),

          ...diseases.map((disease) => Container(
            margin: const EdgeInsets.only(bottom: 16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Theme(
              data: Theme.of(context).copyWith(dividerColor: Colors.transparent),
              child: ExpansionTile(
                leading: Text(disease['emoji'] as String, style: const TextStyle(fontSize: 28)),
                title: Text(disease['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                subtitle: Container(
                  margin: const EdgeInsets.only(top: 4),
                  padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                  decoration: BoxDecoration(
                    color: Colors.red.shade100,
                    borderRadius: BorderRadius.circular(6),
                  ),
                  child: Text(disease['type'] as String, style: TextStyle(fontSize: 10, color: Colors.red.shade800)),
                ),
                children: [
                  Padding(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text('🔍 Famantarana:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                        ...(disease['symptoms'] as List).map((sym) => Padding(
                          padding: const EdgeInsets.only(left: 8, top: 4),
                          child: Text('• $sym', style: TextStyle(fontSize: 11, color: Colors.grey.shade700)),
                        )),
                        const SizedBox(height: 12),
                        Row(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text('⚠️ Antony: ', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 11)),
                            Expanded(child: Text(disease['causes'] as String, style: TextStyle(fontSize: 11, color: Colors.grey.shade700))),
                          ],
                        ),
                        const SizedBox(height: 12),
                        const Text('💊 Fitsaboana:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                        ...(disease['treatment'] as List).map((treat) => Container(
                          margin: const EdgeInsets.only(top: 4),
                          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                          decoration: BoxDecoration(
                            color: Colors.blue.shade50,
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Text('✓ $treat', style: TextStyle(fontSize: 11, color: Colors.blue.shade800)),
                        )),
                        const SizedBox(height: 12),
                        Container(
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: Colors.green.shade50,
                            borderRadius: BorderRadius.circular(8),
                            border: Border.all(color: Colors.green.shade200),
                          ),
                          child: Row(
                            children: [
                              const Text('🛡️ ', style: TextStyle(fontSize: 14)),
                              const Text('Fisorohana: ', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 11)),
                              Expanded(child: Text(disease['prevention'] as String, style: TextStyle(fontSize: 11, color: Colors.green.shade800))),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          )),
        ],
      ),
    );
  }
}

// ========== Tantely Calendar Screen ==========
class TantelyCalendarScreen extends StatelessWidget {
  const TantelyCalendarScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final calendar = [
      {
        'month': 'Janoary',
        'emoji': '☀️',
        'season': 'Fahavaratra (Lohataona)',
        'activities': [
          'Fotoana fijinjana tantely',
          'Jereo raha misy mpanjaka vaovao',
          'Ampio hausse raha feno',
        ],
        'flowers': 'Litchi, Mango, Voninkazo maro',
      },
      {
        'month': 'Febroary',
        'emoji': '🌸',
        'season': 'Fahavaratra',
        'activities': [
          'Fijinjana faharoa',
          'Jereo ny varroa',
          'Aza manokatra be loatra',
        ],
        'flowers': 'Mango, Voninkazo hazo',
      },
      {
        'month': 'Martsa',
        'emoji': '🌿',
        'season': 'Fararano',
        'activities': [
          'Fijinjana farany alohan\'ny ririnina',
          'Jereo ny habetsahan\'ny tantely',
          'Aza alaina daholo ny tantely',
        ],
        'flowers': 'Eucalyptus, voninkazo ratsy',
      },
      {
        'month': 'Aprily',
        'emoji': '🍂',
        'season': 'Fararano',
        'activities': [
          'Omeo sirop raha tsy ampy sakafo',
          'Diovy ny toho-tantely',
          'Esory ny hausse tsy ilaina',
        ],
        'flowers': 'Tsy misy be - mangina ny tantely',
      },
      {
        'month': 'May',
        'emoji': '❄️',
        'season': 'Ririnina',
        'activities': [
          'Aza manokatra ny toho-tantely',
          'Jereo fotsiny raha mbola velona',
          'Ampio isolation raha mangatsiaka',
        ],
        'flowers': 'Vitsy - tantely misakafo tantely nangoniny',
      },
      {
        'month': 'Jona',
        'emoji': '❄️',
        'season': 'Ririnina',
        'activities': [
          'Tsy misy asa - avelao milamina',
          'Jereo raha misy varroa',
          'Diovy fitaovana',
        ],
        'flowers': 'Tsy misy',
      },
      {
        'month': 'Jolay',
        'emoji': '❄️',
        'season': 'Ririnina',
        'activities': [
          'Traitement varroa (acide oxalique)',
          'Vonona ny cadre vaovao',
          'Diovy ny toho-tantely tsy ampiasaina',
        ],
        'flowers': 'Tsy misy - tantely ao an-trano',
      },
      {
        'month': 'Aogositra',
        'emoji': '🌱',
        'season': 'Faran\'ny ririnina',
        'activities': [
          'Jereo raha mbola velona ny colonie',
          'Omeo sirop stimulant',
          'Vonona ny lohataona',
        ],
        'flowers': 'Manomboka misy voninkazo',
      },
      {
        'month': 'Septambra',
        'emoji': '🌼',
        'season': 'Lohataona',
        'activities': [
          'Tantely manomboka miasa',
          'Jereo ny mpanjaka - miteraka ve?',
          'Ampio cadre vaovao',
        ],
        'flowers': 'Voninkazo maro manomboka',
      },
      {
        'month': 'Oktobra',
        'emoji': '🌺',
        'season': 'Lohataona',
        'activities': [
          'Essaimage - jereo raha misy cellules royales',
          'Ampio hausse',
          'Fotoana tsara hananganana colonie vaovao',
        ],
        'flowers': 'Litchi manomboka, voninkazo maro',
      },
      {
        'month': 'Novambra',
        'emoji': '☀️',
        'season': 'Fahavaratra',
        'activities': [
          'Fotoana tsara indrindra - tantely betsaka',
          'Ampio hausse faharoa',
          'Jereo matetika',
        ],
        'flowers': 'Litchi feno, Mango, voninkazo maro',
      },
      {
        'month': 'Desambra',
        'emoji': '☀️',
        'season': 'Fahavaratra',
        'activities': [
          'Fotoana fijinjana voalohany',
          'Tantely be indrindra',
          'Aza alaina daholo - avelao ho sakafo ririnina',
        ],
        'flowers': 'Mango, Litchi, voninkazo maro',
      },
    ];

    return Scaffold(
      backgroundColor: const Color(0xFFF5F5F5),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.amber.shade600, Colors.yellow.shade600]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              children: [
                const Text('📅', style: TextStyle(fontSize: 40)),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('TETIANDRO APICULTURE',
                          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('Asa tokony atao isam-bolana',
                          style: TextStyle(color: Colors.white.withValues(alpha: 0.9), fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Calendar
          ...calendar.map((month) => Container(
            margin: const EdgeInsets.only(bottom: 12),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Theme(
              data: Theme.of(context).copyWith(dividerColor: Colors.transparent),
              child: ExpansionTile(
                leading: Container(
                  width: 50,
                  height: 50,
                  decoration: BoxDecoration(
                    color: Colors.amber.shade100,
                    borderRadius: BorderRadius.circular(10),
                  ),
                  child: Center(child: Text(month['emoji'] as String, style: const TextStyle(fontSize: 24))),
                ),
                title: Text(month['month'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                subtitle: Text(month['season'] as String, style: TextStyle(fontSize: 11, color: Colors.grey.shade600)),
                children: [
                  Padding(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text('📋 Asa atao:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                        ...(month['activities'] as List).map((act) => Container(
                          margin: const EdgeInsets.only(top: 4),
                          padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                          decoration: BoxDecoration(
                            color: Colors.amber.shade50,
                            borderRadius: BorderRadius.circular(6),
                          ),
                          child: Row(
                            children: [
                              const Text('✓ ', style: TextStyle(color: Colors.green, fontWeight: FontWeight.bold)),
                              Expanded(child: Text(act as String, style: const TextStyle(fontSize: 11))),
                            ],
                          ),
                        )),
                        const SizedBox(height: 12),
                        Container(
                          padding: const EdgeInsets.all(10),
                          decoration: BoxDecoration(
                            color: Colors.pink.shade50,
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: Row(
                            children: [
                              const Text('🌸 Voninkazo: ', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 11)),
                              Expanded(child: Text(month['flowers'] as String, style: TextStyle(fontSize: 11, color: Colors.pink.shade800))),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          )),
        ],
      ),
    );
  }
}

// ==================== OLITRATECH - INSECT FARMING ====================

// ========== Olitra Species Screen ==========
class OlitraSpeciesScreen extends StatelessWidget {
  const OlitraSpeciesScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final species = [
      {
        'name': 'BSF - Black Soldier Fly (Hermetia illucens)',
        'emoji': '🪰',
        'localName': 'Lalitra mainty miaramila',
        'description': 'Olitra tsara indrindra ho an\'ny fiompiana. Mihinana fako organika.',
        'lifecycle': '45-60 andro (atody → olitra → lalitra)',
        'temperature': '25-35°C (optimal 28-30°C)',
        'humidity': '60-80%',
        'proteine': '40-45% (olitra maina)',
        'lipides': '30-35%',
        'advantages': [
          'Mihinana fako organika rehetra',
          'Tsy misy aretina (tsy toy ny lalitra mahazatra)',
          'Mitombo haingana (2 herinandro)',
          'Protéine sy lipides betsaka',
          'Mora tezaina - tsy mila fitaovana lafo',
        ],
        'uses': ['Sakafo akoho', 'Sakafo trondro', 'Sakafo kisoa', 'Zezika (frass)'],
        'production': '5-10 kg olitra/m²/volana',
        'price': {
          'larvae': '15,000-25,000 Ar/kg (olitra velona)',
          'dried': '40,000-60,000 Ar/kg (olitra maina)',
          'eggs': '50,000-100,000 Ar/g (atody)',
          'frass': '5,000-10,000 Ar/kg (zezika)',
        },
      },
      {
        'name': 'Vers de farine (Tenebrio molitor)',
        'emoji': '🪱',
        'localName': 'Olitra lafarinina',
        'description': 'Olitra kely mihinana lafarinina sy cerealy. Protéine ambony.',
        'lifecycle': '90-120 andro (atody → olitra → nymphe → scarabée)',
        'temperature': '25-30°C (optimal 27°C)',
        'humidity': '50-70%',
        'proteine': '50-55% (olitra maina)',
        'lipides': '25-30%',
        'advantages': [
          'Protéine ambony indrindra',
          'Tsy misy fofona',
          'Azo atao sakafo olona koa',
          'Mora tehirizina (maina)',
        ],
        'uses': ['Sakafo akoho', 'Sakafo trondro', 'Sakafo vorona', 'Sakafo olona', 'Pet food'],
        'production': '2-4 kg olitra/m²/volana',
        'price': {
          'larvae': '25,000-40,000 Ar/kg (olitra velona)',
          'dried': '60,000-100,000 Ar/kg (olitra maina)',
          'adults': '30,000-50,000 Ar/100 (scarabée mpanampy)',
        },
      },
      {
        'name': 'Grillons (Acheta domesticus)',
        'emoji': '🦗',
        'localName': 'Valala trano',
        'description': 'Bibikely misy protéine betsaka. Azo atao sakafo olona.',
        'lifecycle': '60-90 andro',
        'temperature': '28-32°C',
        'humidity': '40-60%',
        'proteine': '60-70% (maina)',
        'lipides': '15-20%',
        'advantages': [
          'Protéine ambony indrindra',
          'Tsara ho sakafo olona',
          'Mora tezaina',
        ],
        'uses': ['Sakafo olona (lafarinina)', 'Sakafo biby fiompy', 'Sakafo reptile'],
        'production': '1-2 kg/m²/volana',
        'price': {
          'live': '30,000-50,000 Ar/kg (velona)',
          'dried': '80,000-120,000 Ar/kg (maina)',
        },
      },
    ];

    final startupCosts = [
      {'item': 'Vata plastika fiompiana (10 pièces)', 'price': '50,000-100,000 Ar', 'essential': true},
      {'item': 'Harato madinika (tamis)', 'price': '15,000-30,000 Ar', 'essential': true},
      {'item': 'Olitra mpanampy (starter colony)', 'price': '30,000-80,000 Ar', 'essential': true},
      {'item': 'Thermomètre/Hygromètre', 'price': '10,000-25,000 Ar', 'essential': true},
      {'item': 'Sakafo voalohany (1 volana)', 'price': '20,000-50,000 Ar', 'essential': true},
      {'item': 'Cage lalitra (BSF)', 'price': '50,000-150,000 Ar', 'essential': false},
      {'item': 'Séchoir (manaina)', 'price': '100,000-300,000 Ar', 'essential': false},
      {'item': 'Moulin (lafarinina)', 'price': '150,000-400,000 Ar', 'essential': false},
    ];

    return Scaffold(
      backgroundColor: const Color(0xFFF5F5F5),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.brown.shade600, Colors.brown.shade800]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              children: [
                const Text('🪲', style: TextStyle(fontSize: 40)),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('KARAZANA OLITRA',
                          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('BSF, Vers de farine, Grillons...',
                          style: TextStyle(color: Colors.white.withValues(alpha: 0.9), fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Why Insects
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.green.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.green.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('🌍', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('NAHOANA FIOMPIANA OLITRA?', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 12),
                _buildWhyItem('🌱 Eco-friendly', 'Tsy mila tany be, rano kely, tsy misy gaz'),
                _buildWhyItem('💰 Tsy lafo', 'Fitaovana tsotra, sakafo fako organika'),
                _buildWhyItem('🥩 Protéine be', '40-70% protéine - ambony noho ny hena'),
                _buildWhyItem('♻️ Recycling', 'Mamadika fako ho sakafo sy zezika'),
                _buildWhyItem('📈 Mitombo haingana', '2-4 herinandro dia vonona'),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Species
          const Text('KARAZANA OLITRA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
          const SizedBox(height: 12),

          ...species.map((sp) => Container(
            margin: const EdgeInsets.only(bottom: 16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Theme(
              data: Theme.of(context).copyWith(dividerColor: Colors.transparent),
              child: ExpansionTile(
                leading: Text(sp['emoji'] as String, style: const TextStyle(fontSize: 32)),
                title: Text(sp['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                subtitle: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(sp['localName'] as String, style: TextStyle(fontSize: 11, color: Colors.grey.shade600)),
                    const SizedBox(height: 4),
                    Wrap(
                      spacing: 6,
                      runSpacing: 4,
                      children: [
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                          decoration: BoxDecoration(color: Colors.red.shade100, borderRadius: BorderRadius.circular(6)),
                          child: Text('🥩 ${sp['proteine']}', style: TextStyle(fontSize: 9, color: Colors.red.shade800)),
                        ),
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                          decoration: BoxDecoration(color: Colors.orange.shade100, borderRadius: BorderRadius.circular(6)),
                          child: Text('🌡️ ${sp['temperature']}', style: TextStyle(fontSize: 9, color: Colors.orange.shade800)),
                        ),
                      ],
                    ),
                  ],
                ),
                children: [
                  Padding(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(sp['description'] as String, style: TextStyle(fontSize: 11, color: Colors.grey.shade700)),
                        const SizedBox(height: 12),
                        Row(
                          children: [
                            Expanded(child: _buildInfoCard('⏱️ Cycle', sp['lifecycle'] as String)),
                          ],
                        ),
                        const SizedBox(height: 8),
                        Row(
                          children: [
                            Expanded(child: _buildInfoCard('💧 Hamandoana', sp['humidity'] as String)),
                            const SizedBox(width: 8),
                            Expanded(child: _buildInfoCard('📊 Vokatra', sp['production'] as String)),
                          ],
                        ),
                        const SizedBox(height: 12),
                        const Text('✅ Tombony:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 11, color: Colors.green)),
                        ...(sp['advantages'] as List).map((adv) => Padding(
                          padding: const EdgeInsets.only(left: 8, top: 3),
                          child: Text('• $adv', style: TextStyle(fontSize: 10, color: Colors.grey.shade700)),
                        )),
                        const SizedBox(height: 12),
                        const Text('💰 Vidiny:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 11)),
                        ...(sp['price'] as Map).entries.map((entry) => Container(
                          margin: const EdgeInsets.only(top: 4),
                          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                          decoration: BoxDecoration(color: Colors.green.shade50, borderRadius: BorderRadius.circular(6)),
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: [
                              Text(entry.key, style: const TextStyle(fontSize: 10)),
                              Text(entry.value, style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: Colors.green.shade700)),
                            ],
                          ),
                        )),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          )),

          const SizedBox(height: 20),

          // Startup Costs
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('🛠️', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('FITAOVANA ILAINA HANOMBOKA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const Divider(),
                ...startupCosts.map((cost) => Container(
                  margin: const EdgeInsets.only(bottom: 6),
                  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
                  decoration: BoxDecoration(
                    color: (cost['essential'] as bool) ? Colors.brown.shade50 : Colors.grey.shade50,
                    borderRadius: BorderRadius.circular(6),
                  ),
                  child: Row(
                    children: [
                      Text((cost['essential'] as bool) ? '⭐' : '➕', style: const TextStyle(fontSize: 12)),
                      const SizedBox(width: 8),
                      Expanded(child: Text(cost['item'] as String, style: const TextStyle(fontSize: 11))),
                      Text(cost['price'] as String, style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: Colors.green.shade700)),
                    ],
                  ),
                )),
                const SizedBox(height: 8),
                Container(
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: Colors.amber.shade50,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: const Row(
                    children: [
                      Text('💡 ', style: TextStyle(fontSize: 14)),
                      Expanded(child: Text('Total fiandohana: 125,000 - 285,000 Ar (tsy misy séchoir/moulin)', style: TextStyle(fontSize: 11, fontWeight: FontWeight.bold))),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildWhyItem(String title, String desc) {
    return Container(
      margin: const EdgeInsets.only(bottom: 6),
      padding: const EdgeInsets.all(8),
      decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(6)),
      child: Row(
        children: [
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(title, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 11)),
                Text(desc, style: TextStyle(fontSize: 10, color: Colors.grey.shade600)),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildInfoCard(String title, String value) {
    return Container(
      padding: const EdgeInsets.all(8),
      decoration: BoxDecoration(color: Colors.brown.shade50, borderRadius: BorderRadius.circular(6)),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(title, style: TextStyle(fontSize: 9, color: Colors.brown.shade600)),
          Text(value, style: const TextStyle(fontSize: 10, fontWeight: FontWeight.w500)),
        ],
      ),
    );
  }
}

// ========== Olitra Feed Screen ==========
class OlitraFeedScreen extends StatelessWidget {
  const OlitraFeedScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final bsfFeeds = [
      {'name': 'Fako sakafo (sisan-tsakafo)', 'quality': 'Tsara indrindra', 'emoji': '🍌', 'details': 'Ravina legioma, hoditry voankazo, sisa-mofo'},
      {'name': 'Fako voankazo', 'quality': 'Tsara', 'emoji': '🍎', 'details': 'Mango, papay, voasary lo - mitombo haingana'},
      {'name': 'Tain-biby (zezika)', 'quality': 'Tsara', 'emoji': '💩', 'details': 'Tain-kisoa, tain-omby - protéine betsaka'},
      {'name': 'Paraky (son de riz)', 'quality': 'Antonony', 'emoji': '🌾', 'details': 'Azo ampiana amin\'ny fako hafa'},
      {'name': 'Fako legioma', 'quality': 'Tsara', 'emoji': '🥬', 'details': 'Ravina, fotony - mora lo'},
    ];

    final mealwormFeeds = [
      {'name': 'Paraky (son de riz/blé)', 'quality': 'Tsara indrindra', 'emoji': '🌾', 'details': 'Sakafo fototra - tsy maintsy misy'},
      {'name': 'Lafarinina katsaka', 'quality': 'Tsara', 'emoji': '🌽', 'details': 'Azo ampifangaroina amin\'ny paraky'},
      {'name': 'Karoty/Patsa', 'quality': 'Tsara', 'emoji': '🥕', 'details': 'Loharano hamandoana - tsy mila rano'},
      {'name': 'Ovy mamy', 'quality': 'Tsara', 'emoji': '🍠', 'details': 'Hamandoana sy glucides'},
      {'name': 'Sisa-mofo', 'quality': 'Antonony', 'emoji': '🍞', 'details': 'Glucides - aza be loatra'},
    ];

    final feedingTips = [
      {'tip': 'BSF: Omeo sakafo isan\'andro, 50-100g/1000 olitra', 'icon': '🪰'},
      {'tip': 'Vers de farine: Paraky foana + legioma hamandoana', 'icon': '🪱'},
      {'tip': 'Aza mamahana hena na sakafo misy sira', 'icon': '🚫'},
      {'tip': 'Esory ny sakafo sisa tsy lany alohan\'ny 3 andro', 'icon': '🗑️'},
      {'tip': 'BSF: Ny mafana kokoa = mitombo haingana kokoa', 'icon': '🌡️'},
    ];

    return Scaffold(
      backgroundColor: const Color(0xFFF5F5F5),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.green.shade600, Colors.teal.shade600]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              children: [
                const Text('🥬', style: TextStyle(fontSize: 40)),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('SAKAFO OLITRA',
                          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('Fako organika sy cerealy',
                          style: TextStyle(color: Colors.white.withValues(alpha: 0.9), fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // BSF Feeds
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('🪰', style: TextStyle(fontSize: 24)),
                    SizedBox(width: 8),
                    Text('SAKAFO BSF (Black Soldier Fly)', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const Divider(),
                ...bsfFeeds.map((feed) => Container(
                  margin: const EdgeInsets.only(bottom: 8),
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: Colors.green.shade50,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    children: [
                      Text(feed['emoji'] as String, style: const TextStyle(fontSize: 24)),
                      const SizedBox(width: 10),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(feed['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                            Text(feed['details'] as String, style: TextStyle(fontSize: 10, color: Colors.grey.shade600)),
                          ],
                        ),
                      ),
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                        decoration: BoxDecoration(
                          color: (feed['quality'] == 'Tsara indrindra') ? Colors.green.shade200 : Colors.amber.shade200,
                          borderRadius: BorderRadius.circular(6),
                        ),
                        child: Text(feed['quality'] as String, style: const TextStyle(fontSize: 9, fontWeight: FontWeight.bold)),
                      ),
                    ],
                  ),
                )),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Mealworm Feeds
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('🪱', style: TextStyle(fontSize: 24)),
                    SizedBox(width: 8),
                    Text('SAKAFO VERS DE FARINE', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const Divider(),
                ...mealwormFeeds.map((feed) => Container(
                  margin: const EdgeInsets.only(bottom: 8),
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: Colors.orange.shade50,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    children: [
                      Text(feed['emoji'] as String, style: const TextStyle(fontSize: 24)),
                      const SizedBox(width: 10),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(feed['name'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                            Text(feed['details'] as String, style: TextStyle(fontSize: 10, color: Colors.grey.shade600)),
                          ],
                        ),
                      ),
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                        decoration: BoxDecoration(
                          color: (feed['quality'] == 'Tsara indrindra') ? Colors.green.shade200 : Colors.amber.shade200,
                          borderRadius: BorderRadius.circular(6),
                        ),
                        child: Text(feed['quality'] as String, style: const TextStyle(fontSize: 9, fontWeight: FontWeight.bold)),
                      ),
                    ],
                  ),
                )),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Feeding Tips
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.amber.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.amber.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('💡', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('TOROHEVITRA FAMAHANANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 12),
                ...feedingTips.map((tip) => Container(
                  margin: const EdgeInsets.only(bottom: 6),
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(8)),
                  child: Row(
                    children: [
                      Text(tip['icon'] as String, style: const TextStyle(fontSize: 18)),
                      const SizedBox(width: 10),
                      Expanded(child: Text(tip['tip'] as String, style: const TextStyle(fontSize: 11))),
                    ],
                  ),
                )),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

// ========== Olitra Production Screen ==========
class OlitraProductionScreen extends StatelessWidget {
  const OlitraProductionScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final bsfCycle = [
      {'stage': 'Atody', 'duration': '3-4 andro', 'emoji': '🥚', 'action': 'Tehirizo amin\'ny toerana mafana (28-30°C)'},
      {'stage': 'Olitra kely', 'duration': '5-7 andro', 'emoji': '🐛', 'action': 'Omeo sakafo madinika, tsy be loatra'},
      {'stage': 'Olitra antonony', 'duration': '7-10 andro', 'emoji': '🪱', 'action': 'Ampitomboy ny sakafo isan\'andro'},
      {'stage': 'Prepupa', 'duration': '5-7 andro', 'emoji': '🟤', 'action': 'VONONA HIJINJA - loko mainty, tsy misakafo'},
      {'stage': 'Pupa → Lalitra', 'duration': '14-21 andro', 'emoji': '🪰', 'action': 'Ampidiro cage, miteraka atody'},
    ];

    final harvestTips = [
      {'title': 'Fotoana tsara', 'desc': 'Rehefa prepupa (mainty, tsy mihinana) - protéine ambony indrindra', 'emoji': '⏰'},
      {'title': 'Fomba fijinjana', 'desc': 'Ampiasao tamis (harato) hanavahana amin\'ny sakafo sisa', 'emoji': '🕸️'},
      {'title': 'Fanadiovana', 'desc': 'Sasao amin\'ny rano, avelao hihamaina 24h', 'emoji': '💧'},
      {'title': 'Fanaovana maina', 'desc': 'Hafanao 60-80°C mandritra 4-6 ora na atao masoandro', 'emoji': '☀️'},
      {'title': 'Fitahirizana', 'desc': 'Tehirizo maina ao anaty vata mihiboka, maharitra 6-12 volana', 'emoji': '📦'},
    ];

    final productionCalc = {
      'input': '10 kg fako/andro',
      'output': '2-3 kg olitra velona/andro',
      'conversion': '20-30% conversion rate',
      'monthly': '60-90 kg olitra/volana',
      'revenue': '900,000 - 2,250,000 Ar/volana',
    };

    return Scaffold(
      backgroundColor: const Color(0xFFF5F5F5),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.brown.shade700, Colors.brown.shade500]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              children: [
                const Text('📦', style: TextStyle(fontSize: 40)),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('VOKATRA & FIJINJANA',
                          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('Cycle fiainana sy fomba fijinjana',
                          style: TextStyle(color: Colors.white.withValues(alpha: 0.9), fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // BSF Lifecycle
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('🔄', style: TextStyle(fontSize: 24)),
                    SizedBox(width: 8),
                    Text('CYCLE FIAINAN\'NY BSF', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const Divider(),
                ...bsfCycle.asMap().entries.map((entry) {
                  final i = entry.key;
                  final stage = entry.value;
                  return Container(
                    margin: const EdgeInsets.only(bottom: 8),
                    child: Row(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Column(
                          children: [
                            Container(
                              width: 40,
                              height: 40,
                              decoration: BoxDecoration(
                                color: Colors.brown.shade100,
                                borderRadius: BorderRadius.circular(20),
                              ),
                              child: Center(child: Text(stage['emoji'] as String, style: const TextStyle(fontSize: 20))),
                            ),
                            if (i < bsfCycle.length - 1)
                              Container(width: 2, height: 20, color: Colors.brown.shade200),
                          ],
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: Container(
                            padding: const EdgeInsets.all(10),
                            decoration: BoxDecoration(
                              color: (stage['stage'] == 'Prepupa') ? Colors.green.shade50 : Colors.grey.shade50,
                              borderRadius: BorderRadius.circular(8),
                              border: (stage['stage'] == 'Prepupa') ? Border.all(color: Colors.green.shade300) : null,
                            ),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Row(
                                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                  children: [
                                    Text(stage['stage'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                                    Container(
                                      padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                                      decoration: BoxDecoration(color: Colors.brown.shade100, borderRadius: BorderRadius.circular(4)),
                                      child: Text(stage['duration'] as String, style: const TextStyle(fontSize: 9)),
                                    ),
                                  ],
                                ),
                                const SizedBox(height: 4),
                                Text(stage['action'] as String, style: TextStyle(fontSize: 10, color: Colors.grey.shade700)),
                              ],
                            ),
                          ),
                        ),
                      ],
                    ),
                  );
                }),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Production Calculator
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.green.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.green.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('📊', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('KAJY VOKATRA (BSF)', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 12),
                _buildCalcRow('📥 Fako miditra', productionCalc['input']!),
                _buildCalcRow('📤 Olitra mivoaka', productionCalc['output']!),
                _buildCalcRow('🔄 Taha conversion', productionCalc['conversion']!),
                _buildCalcRow('📅 Isam-bolana', productionCalc['monthly']!),
                Container(
                  margin: const EdgeInsets.only(top: 8),
                  padding: const EdgeInsets.all(10),
                  decoration: BoxDecoration(
                    color: Colors.green.shade100,
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Row(
                    children: [
                      const Text('💰 ', style: TextStyle(fontSize: 16)),
                      Expanded(child: Text('Vola miditra: ${productionCalc['revenue']}', style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12))),
                    ],
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Harvest Tips
          const Text('TOROHEVITRA FIJINJANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
          const SizedBox(height: 12),

          ...harvestTips.map((tip) => Container(
            margin: const EdgeInsets.only(bottom: 10),
            padding: const EdgeInsets.all(14),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Row(
              children: [
                Text(tip['emoji'] as String, style: const TextStyle(fontSize: 28)),
                const SizedBox(width: 14),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(tip['title'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                      Text(tip['desc'] as String, style: TextStyle(fontSize: 11, color: Colors.grey.shade600)),
                    ],
                  ),
                ),
              ],
            ),
          )),
        ],
      ),
    );
  }

  Widget _buildCalcRow(String label, String value) {
    return Container(
      margin: const EdgeInsets.only(bottom: 6),
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
      decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(6)),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label, style: const TextStyle(fontSize: 11)),
          Text(value, style: const TextStyle(fontSize: 11, fontWeight: FontWeight.bold)),
        ],
      ),
    );
  }
}

// ========== Olitra Uses Screen ==========
class OlitraUsesScreen extends StatelessWidget {
  const OlitraUsesScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final uses = [
      {
        'category': 'Sakafo Akoho',
        'emoji': '🐔',
        'description': 'Olitra = protéine tsara indrindra ho an\'ny akoho',
        'benefits': [
          'Mampitombo ny vokatra atody',
          'Mampahery ny akoho',
          'Natural - tsy misy chimique',
          'Tsy lafo noho ny provandy',
        ],
        'dosage': '10-20% ao amin\'ny sakafo (50-100g/akoho/andro)',
        'form': 'Velona, maina, na lafarinina',
      },
      {
        'category': 'Sakafo Trondro',
        'emoji': '🐟',
        'description': 'Olitra BSF = sakafo tsara indrindra ho an\'ny Tilapia sy Carpe',
        'benefits': [
          'Protéine 40-45% - ambony noho ny provandy',
          'Lipides betsaka - energia',
          'Azo atao velona na maina',
          'Mampitombo haingana',
        ],
        'dosage': '20-40% ao amin\'ny ration',
        'form': 'Velona (manidina eo ambony rano) na lafarinina',
      },
      {
        'category': 'Sakafo Kisoa',
        'emoji': '🐷',
        'description': 'Olitra = famenon-tsakafo tsara ho an\'ny kisoa',
        'benefits': [
          'Protéine betsaka',
          'Manamafy ny nofo',
          'Vitamina sy mineraly',
        ],
        'dosage': '5-15% ao amin\'ny sakafo',
        'form': 'Velona, maina, na lafarinina',
      },
      {
        'category': 'Zezika (Frass)',
        'emoji': '🌱',
        'description': 'Tain\'olitra BSF = zezika organika tsara indrindra',
        'benefits': [
          'NPK voajanahary',
          'Mampitombo ny tany',
          'Tsy misy fofona ratsy',
          'Azo ampiasaina mivantana',
        ],
        'dosage': '100-200g/m² tany',
        'form': 'Maina - tehirizo maharitra',
      },
      {
        'category': 'Sakafo Olona (futur)',
        'emoji': '👤',
        'description': 'Vers de farine = protéine azo hanin\'ny olona',
        'benefits': [
          'Protéine 50%+ - ambony noho ny hena',
          'Durable - tsy manimba ny tontolo iainana',
          'Vitamina B12 sy fer betsaka',
          'Azo atao lafarinina, biscuit, sns',
        ],
        'dosage': 'Miovaova',
        'form': 'Lafarinina, grillé, entier',
      },
    ];

    final marketOpportunities = [
      {'market': 'Mpamokatra akoho', 'demand': 'Ambony', 'price': '15,000-25,000 Ar/kg'},
      {'market': 'Mpamokatra trondro', 'demand': 'Ambony', 'price': '20,000-30,000 Ar/kg'},
      {'market': 'Pet shops (vorona, reptile)', 'demand': 'Antonony', 'price': '30,000-50,000 Ar/kg'},
      {'market': 'Mpamboly (zezika)', 'demand': 'Ambony', 'price': '5,000-10,000 Ar/kg'},
    ];

    return Scaffold(
      backgroundColor: const Color(0xFFF5F5F5),
      body: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.teal.shade600, Colors.green.shade600]),
              borderRadius: BorderRadius.circular(16),
            ),
            child: Row(
              children: [
                const Text('🎯', style: TextStyle(fontSize: 40)),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      const Text('FAMPIASANA OLITRA',
                          style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('Sakafo biby, zezika, orinasa...',
                          style: TextStyle(color: Colors.white.withValues(alpha: 0.9), fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Uses
          ...uses.map((use) => Container(
            margin: const EdgeInsets.only(bottom: 16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Theme(
              data: Theme.of(context).copyWith(dividerColor: Colors.transparent),
              child: ExpansionTile(
                leading: Text(use['emoji'] as String, style: const TextStyle(fontSize: 32)),
                title: Text(use['category'] as String, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                subtitle: Text(use['description'] as String, style: TextStyle(fontSize: 11, color: Colors.grey.shade600)),
                children: [
                  Padding(
                    padding: const EdgeInsets.all(16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Text('✅ Tombony:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12, color: Colors.green)),
                        ...(use['benefits'] as List).map((b) => Padding(
                          padding: const EdgeInsets.only(left: 8, top: 4),
                          child: Text('• $b', style: TextStyle(fontSize: 11, color: Colors.grey.shade700)),
                        )),
                        const SizedBox(height: 12),
                        Row(
                          children: [
                            Expanded(
                              child: Container(
                                padding: const EdgeInsets.all(10),
                                decoration: BoxDecoration(color: Colors.blue.shade50, borderRadius: BorderRadius.circular(8)),
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    const Text('📊 Dosage:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 10)),
                                    Text(use['dosage'] as String, style: const TextStyle(fontSize: 10)),
                                  ],
                                ),
                              ),
                            ),
                            const SizedBox(width: 8),
                            Expanded(
                              child: Container(
                                padding: const EdgeInsets.all(10),
                                decoration: BoxDecoration(color: Colors.orange.shade50, borderRadius: BorderRadius.circular(8)),
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    const Text('📦 Endrika:', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 10)),
                                    Text(use['form'] as String, style: const TextStyle(fontSize: 10)),
                                  ],
                                ),
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          )),

          const SizedBox(height: 20),

          // Market Opportunities
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.green.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.green.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('💼', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('TSENA SY MPANJIFA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 12),
                ...marketOpportunities.map((market) => Container(
                  margin: const EdgeInsets.only(bottom: 8),
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(8)),
                  child: Row(
                    children: [
                      Expanded(
                        flex: 2,
                        child: Text(market['market'] as String, style: const TextStyle(fontSize: 11, fontWeight: FontWeight.w500)),
                      ),
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                        decoration: BoxDecoration(
                          color: (market['demand'] == 'Ambony') ? Colors.green.shade100 : Colors.amber.shade100,
                          borderRadius: BorderRadius.circular(6),
                        ),
                        child: Text(market['demand'] as String, style: TextStyle(fontSize: 9, color: (market['demand'] == 'Ambony') ? Colors.green.shade800 : Colors.amber.shade800)),
                      ),
                      const SizedBox(width: 8),
                      Text(market['price'] as String, style: TextStyle(fontSize: 10, fontWeight: FontWeight.bold, color: Colors.green.shade700)),
                    ],
                  ),
                )),
              ],
            ),
          ),

          const SizedBox(height: 20),

          // Business Tip
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.amber.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.amber.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('💡', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('HEVITRA ORINASA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 12),
                const Text(
                  'Ny fiompiana olitra dia orinasa vaovao sy tsara eto Madagasikara:\n\n'
                  '• Tsy misy concurrence be\n'
                  '• Fako organika betsaka (sakafo maimaim-poana)\n'
                  '• Demand betsaka (mpamokatra akoho, trondro)\n'
                  '• Fitaovana tsotra - tsy mila vola be\n'
                  '• Azo atao ao an-trano na tany kely\n\n'
                  'Manomboka amin\'ny BSF dia tsara indrindra!',
                  style: TextStyle(fontSize: 11, height: 1.5),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

// ==================== ZEZIKATECH SCREENS ====================

// Screen 1: Karazana Zezika (Types)
class ZezikaTypesScreen extends StatelessWidget {
  const ZezikaTypesScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final zezikaTypes = [
      {
        'name': 'ZEZIMAITSO (Engrais Vert)',
        'emoji': '🌿',
        'description': 'Teknika tsotra indrindra - tsy mila fermentation',
        'duration': 'Avy hatrany',
        'difficulty': 'Mora indrindra',
        'color': Colors.green,
        'method': 'Tapahana ny ravina dia atototra avy hatrany any anaty tany miaraka amin\'ny masomboly na alohan\'ny hambolena.',
        'plants': [
          {'name': 'Bemangidy (Tithonia)', 'benefit': 'Potassium betsaka'},
          {'name': 'Tephrosia', 'benefit': 'Azote betsaka'},
          {'name': 'Voandelaka', 'benefit': 'Nutriments isan-karazany'},
          {'name': 'Tsikafona', 'benefit': 'Azote sy mineraly'},
          {'name': 'Zozoro', 'benefit': 'Avy amin\'ny rano'},
        ],
      },
      {
        'name': 'COMPOSTE MAHARITRA',
        'emoji': '🔄',
        'description': 'Zezika mateza - 45 andro na mihoatra',
        'duration': '45+ andro',
        'difficulty': 'Antonony',
        'color': Colors.brown,
        'method': 'Fangaro sosona isankarazany atao antontany dia avela ho lo.',
        'ingredients': [
          {'item': 'Zezipahitra', 'qty': '1 sarety'},
          {'item': 'Ravina maitso', 'qty': '1.5 sarety'},
          {'item': 'Ravina maina', 'qty': '1.5 sarety'},
          {'item': 'Rano', 'qty': '30 litatra'},
        ],
      },
      {
        'name': 'COMPOSTE HAINGANA',
        'emoji': '⚡',
        'description': 'Composte miaraka amin\'ny Activateur - 7 andro',
        'duration': '7 andro',
        'difficulty': 'Sarotra kokoa',
        'color': Colors.orange,
        'method': 'Mampiasa Activateur manokana mba hanafainganana ny fahalovana.',
        'ingredients': [
          {'item': 'Zezipahitra', 'qty': '1 sarety'},
          {'item': 'Ravina maitso', 'qty': '1.5 sarety'},
          {'item': 'Ravina maina', 'qty': '1.5 sarety'},
          {'item': 'Akofa', 'qty': '1 sobika'},
          {'item': 'Akofa may (carbonisé)', 'qty': '1 sobika'},
          {'item': 'Apombo malemy', 'qty': '0.5 sobika'},
          {'item': 'Rano', 'qty': '150 litatra'},
          {'item': 'Activateur', 'qty': '2 litatra'},
        ],
      },
      {
        'name': 'RANONJEZIKA (Purin)',
        'emoji': '💧',
        'description': 'Zezika ranony mahery vaika',
        'duration': '15 andro',
        'difficulty': 'Mora',
        'color': Colors.teal,
        'method': 'Fahalovan\'ny ravina anaty rano mandritra ny 15 andro.',
        'plants': [
          {'name': 'Bemangidy (Tithonia)', 'benefit': 'Potassium'},
          {'name': 'Tephrosia', 'benefit': 'Azote'},
          {'name': 'Voandelaka', 'benefit': 'Mineraly'},
          {'name': 'Consoude', 'benefit': 'Potassium sy phosphore'},
        ],
      },
    ];

    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [Colors.green.shade700, Colors.green.shade500],
              ),
              borderRadius: BorderRadius.circular(16),
            ),
            child: const Row(
              children: [
                Text('🌿', style: TextStyle(fontSize: 40)),
                SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'KARAZANA ZEZIKA ORGANIKA',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      Text(
                        'Torolalana feno - Aldini Ralamboseheno',
                        style: TextStyle(color: Colors.white70, fontSize: 12),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Important rules
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.amber.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.amber.shade300),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('⚠️', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text(
                      'FEPETRA ILAINA AMIN\'NY COMPOSTE REHETRA',
                      style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13),
                    ),
                  ],
                ),
                const SizedBox(height: 12),
                _buildRule('1', 'Tetehina madinika', 'Tetehina 5-10cm ny bozaka sy ravina mba ho mora lo'),
                const SizedBox(height: 8),
                _buildRule('2', 'Hamandoana (Test Sponjy)', 'Rehefa pizirina amin\'ny tanana: mando fa tsy mitete be, tsy maina be'),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Zezika types cards
          ...zezikaTypes.map((type) => Padding(
            padding: const EdgeInsets.only(bottom: 16),
            child: _buildZezikaTypeCard(context, type),
          )),
        ],
      ),
    );
  }

  Widget _buildRule(String num, String title, String desc) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Container(
          width: 24,
          height: 24,
          decoration: BoxDecoration(
            color: Colors.amber.shade700,
            shape: BoxShape.circle,
          ),
          child: Center(
            child: Text(num, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 12)),
          ),
        ),
        const SizedBox(width: 8),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(title, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
              Text(desc, style: TextStyle(fontSize: 11, color: Colors.grey.shade700)),
            ],
          ),
        ),
      ],
    );
  }

  Widget _buildZezikaTypeCard(BuildContext context, Map<String, dynamic> type) {
    return Card(
      elevation: 3,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: InkWell(
        onTap: () => _showZezikaDetails(context, type),
        borderRadius: BorderRadius.circular(12),
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: (type['color'] as Color).withValues(alpha: 0.15),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Text(type['emoji'], style: const TextStyle(fontSize: 28)),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          type['name'],
                          style: TextStyle(
                            fontWeight: FontWeight.bold,
                            fontSize: 14,
                            color: type['color'],
                          ),
                        ),
                        const SizedBox(height: 4),
                        Text(
                          type['description'],
                          style: TextStyle(fontSize: 11, color: Colors.grey.shade600),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 12),
              Row(
                children: [
                  Expanded(
                    child: Container(
                      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                      decoration: BoxDecoration(
                        color: Colors.blue.shade50,
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          const Icon(Icons.timer, size: 14, color: Colors.blue),
                          const SizedBox(width: 4),
                          Text(type['duration'], style: const TextStyle(fontSize: 11, color: Colors.blue)),
                        ],
                      ),
                    ),
                  ),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Container(
                      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                      decoration: BoxDecoration(
                        color: Colors.purple.shade50,
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          const Icon(Icons.star, size: 14, color: Colors.purple),
                          const SizedBox(width: 4),
                          Flexible(child: Text(type['difficulty'], style: const TextStyle(fontSize: 11, color: Colors.purple), overflow: TextOverflow.ellipsis)),
                        ],
                      ),
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 8),
              Center(
                child: Text(
                  'Tsindrio hahitana ny antsipiriany ➤',
                  style: TextStyle(fontSize: 10, color: type['color'], fontWeight: FontWeight.w500),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _showZezikaDetails(BuildContext context, Map<String, dynamic> type) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => Container(
        height: MediaQuery.of(context).size.height * 0.8,
        decoration: const BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
        ),
        child: Column(
          children: [
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                color: type['color'],
                borderRadius: const BorderRadius.vertical(top: Radius.circular(20)),
              ),
              child: Row(
                children: [
                  Text(type['emoji'], style: const TextStyle(fontSize: 36)),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Text(
                      type['name'],
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                  IconButton(
                    icon: const Icon(Icons.close, color: Colors.white),
                    onPressed: () => Navigator.pop(context),
                  ),
                ],
              ),
            ),
            Expanded(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    // Method
                    const Text('📋 FOMBA FIASA:', style: TextStyle(fontWeight: FontWeight.bold)),
                    const SizedBox(height: 8),
                    Text(type['method'], style: const TextStyle(fontSize: 13)),
                    const SizedBox(height: 16),
                    
                    // Plants or Ingredients
                    if (type['plants'] != null) ...[
                      const Text('🌱 ZAVAMANIRY AMPIASAINA:', style: TextStyle(fontWeight: FontWeight.bold)),
                      const SizedBox(height: 8),
                      ...(type['plants'] as List).map((plant) => Padding(
                        padding: const EdgeInsets.only(bottom: 8),
                        child: Row(
                          children: [
                            const Text('• ', style: TextStyle(fontSize: 16)),
                            Expanded(
                              child: RichText(
                                text: TextSpan(
                                  style: const TextStyle(color: Colors.black87, fontSize: 13),
                                  children: [
                                    TextSpan(text: plant['name'], style: const TextStyle(fontWeight: FontWeight.bold)),
                                    TextSpan(text: ' - ${plant['benefit']}'),
                                  ],
                                ),
                              ),
                            ),
                          ],
                        ),
                      )),
                    ],
                    
                    if (type['ingredients'] != null) ...[
                      const Text('🛒 FANGARO ILAINA:', style: TextStyle(fontWeight: FontWeight.bold)),
                      const SizedBox(height: 8),
                      Container(
                        decoration: BoxDecoration(
                          border: Border.all(color: Colors.grey.shade300),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Column(
                          children: (type['ingredients'] as List).asMap().entries.map((entry) {
                            final ing = entry.value;
                            final isLast = entry.key == (type['ingredients'] as List).length - 1;
                            return Container(
                              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
                              decoration: BoxDecoration(
                                border: isLast ? null : Border(bottom: BorderSide(color: Colors.grey.shade200)),
                              ),
                              child: Row(
                                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                children: [
                                  Text(ing['item'], style: const TextStyle(fontSize: 13)),
                                  Text(ing['qty'], style: TextStyle(fontWeight: FontWeight.bold, color: type['color'], fontSize: 13)),
                                ],
                              ),
                            );
                          }).toList(),
                        ),
                      ),
                    ],
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// Screen 2: Fanamboarana (Production)
class ZezikaProductionScreen extends StatelessWidget {
  const ZezikaProductionScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [Colors.brown.shade700, Colors.brown.shade500],
              ),
              borderRadius: BorderRadius.circular(16),
            ),
            child: const Row(
              children: [
                Text('🔧', style: TextStyle(fontSize: 40)),
                SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'TOROLALANA FANAMBOARANA',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      Text(
                        'Dingana tsirairay amin\'ny famokarana',
                        style: TextStyle(color: Colors.white70, fontSize: 12),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // COMPOSTE MAHARITRA
          _buildProductionSection(
            title: 'COMPOSTE MAHARITRA (45+ Andro)',
            emoji: '🔄',
            color: Colors.brown,
            steps: [
              {
                'title': 'SOSONA 1: Fako maina',
                'desc': 'Alaharo 10cm ny fako maina (ravina maina, mololo, bozaka maina)',
                'icon': '🍂',
              },
              {
                'title': 'SOSONA 2: Fako maitso',
                'desc': 'Ampio 10cm ny fako maitso (ravina maitso, fako sakafo)',
                'icon': '🥬',
              },
              {
                'title': 'SOSONA 3: Zezipahitra',
                'desc': 'Ampio 5cm ny zezipahitra (omby, akoho, bitro...)',
                'icon': '💩',
              },
              {
                'title': 'SOSONA 4: Tondrahana',
                'desc': 'Tondrahana rano ary saromana tsara (bache na bozaka)',
                'icon': '💧',
              },
              {
                'title': 'FIKARAKARANA',
                'desc': 'Avadibadiho isaky ny 15 andro mba hiditra ny rivotra',
                'icon': '🔄',
              },
            ],
          ),
          
          const SizedBox(height: 20),
          
          // ACTIVATEUR
          _buildProductionSection(
            title: 'FANAMBOARANA ACTIVATEUR (15 andro mialoha)',
            emoji: '⚡',
            color: Colors.orange,
            steps: [
              {
                'title': 'FANGARO ILAINA',
                'desc': '• Ranona tsinain\'omby/taimboraka: 5 Litres\n• Siramamy mena: 1 Kg\n• Apombo malemy: 2 Kg\n• Rano madio: 15 Litres',
                'icon': '🛒',
              },
              {
                'title': 'DINGANA 1: Andrahoina',
                'desc': 'Andrahoina ny apombo malemy miaraka amin\'ny rano 15L sy siramamy 1kg',
                'icon': '🔥',
              },
              {
                'title': 'DINGANA 2: Ahotraka',
                'desc': 'Aroina matetika ary avela hangotraka 5 minitra',
                'icon': '♨️',
              },
              {
                'title': 'DINGANA 3: Hatsiaka',
                'desc': 'Bataina ary avela hangatsiaka tanteraka',
                'icon': '❄️',
              },
              {
                'title': 'DINGANA 4: Afangaro',
                'desc': 'Afangaro amin\'ny ranona tsinain\'omby/taimboraka 5L',
                'icon': '🥄',
              },
              {
                'title': 'DINGANA 5: Fermentation',
                'desc': 'Atao anaty bidon 20L, saromana, avela 15 andro hifotreka',
                'icon': '🫙',
              },
            ],
          ),
          
          const SizedBox(height: 20),
          
          // COMPOSTE HAINGANA
          _buildProductionSection(
            title: 'COMPOSTE HAINGANA (7 Andro)',
            emoji: '⚡',
            color: Colors.deepOrange,
            steps: [
              {
                'title': 'FANGARO ILAINA',
                'desc': '• Zezipahitra: 1 sarety\n• Ravina maitso: 1.5 sarety\n• Ravina maina: 1.5 sarety\n• Akofa: 1 sobika\n• Akofa may: 1 sobika\n• Apombo malemy: 0.5 sobika\n• Rano: 150 Litres\n• Activateur vita: 2 Litres',
                'icon': '🛒',
              },
              {
                'title': 'DINGANA 1: Rano + Activateur',
                'desc': 'Afangaro ao amin\'ny rano 150L ny activateur 2L',
                'icon': '💧',
              },
              {
                'title': 'DINGANA 2: Sosona',
                'desc': '• Fako maina (10cm)\n• Fako maitso (10cm)\n• Zezipahitra (5cm)\n• Akofa + Akofa may + Apombo kely\n• Tondrahana amin\'ny rano misy activateur',
                'icon': '📚',
              },
              {
                'title': 'DINGANA 3: Averina',
                'desc': 'Averina ny sosona mandrapaha-lany ny fangaro',
                'icon': '🔁',
              },
              {
                'title': 'FIKARAKARANA MANOKANA',
                'desc': 'Avadiho isaky ny 2-3 andro (mafana be izy)',
                'icon': '⚠️',
              },
            ],
          ),
          
          const SizedBox(height: 20),
          
          // RANONJEZIKA
          _buildProductionSection(
            title: 'RANONJEZIKA (15 Andro)',
            emoji: '💧',
            color: Colors.teal,
            steps: [
              {
                'title': 'DINGANA 1: Tetehina',
                'desc': 'Totoina na tetehina ny ravina (Bemangidy, Tephrosia, Voandelaka, Consoude)',
                'icon': '✂️',
              },
              {
                'title': 'DINGANA 2: Bidon',
                'desc': 'Atao anaty bidon 20L - fenoina 1/3 ny bidon',
                'icon': '🫙',
              },
              {
                'title': 'DINGANA 3: Rano',
                'desc': 'Fenoy rano ny bidon ary saromana',
                'icon': '💧',
              },
              {
                'title': 'DINGANA 4: Alona',
                'desc': 'Alona 15 andro - aroina isan\'andro amin\'ny hazo mba haingana',
                'icon': '⏳',
              },
              {
                'title': 'DINGANA 5: Sivanina',
                'desc': 'Rehefa 15 andro dia sivanina ny ravina',
                'icon': '🔍',
              },
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildProductionSection({
    required String title,
    required String emoji,
    required Color color,
    required List<Map<String, String>> steps,
  }) {
    return Card(
      elevation: 3,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
      child: Column(
        children: [
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: color.withValues(alpha: 0.1),
              borderRadius: const BorderRadius.vertical(top: Radius.circular(12)),
            ),
            child: Row(
              children: [
                Text(emoji, style: const TextStyle(fontSize: 24)),
                const SizedBox(width: 8),
                Expanded(
                  child: Text(
                    title,
                    style: TextStyle(fontWeight: FontWeight.bold, color: color, fontSize: 13),
                  ),
                ),
              ],
            ),
          ),
          ...steps.asMap().entries.map((entry) {
            final step = entry.value;
            final index = entry.key;
            return Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                border: index < steps.length - 1 
                    ? Border(bottom: BorderSide(color: Colors.grey.shade200))
                    : null,
              ),
              child: Row(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(step['icon']!, style: const TextStyle(fontSize: 20)),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(step['title']!, style: TextStyle(fontWeight: FontWeight.bold, fontSize: 12, color: color)),
                        const SizedBox(height: 4),
                        Text(step['desc']!, style: const TextStyle(fontSize: 11, height: 1.4)),
                      ],
                    ),
                  ),
                ],
              ),
            );
          }),
        ],
      ),
    );
  }
}

// Screen 3: Fampiasana (Usage)
class ZezikaUsageScreen extends StatelessWidget {
  const ZezikaUsageScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [Colors.green.shade700, Colors.green.shade500],
              ),
              borderRadius: BorderRadius.circular(16),
            ),
            child: const Row(
              children: [
                Text('🌱', style: TextStyle(fontSize: 40)),
                SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'FAMPIASANA NY ZEZIKA',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      Text(
                        'Fomba sy fatra ampiasaina',
                        style: TextStyle(color: Colors.white70, fontSize: 12),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Dosage Table
          Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.grey.shade300),
            ),
            child: Column(
              children: [
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.green.shade100,
                    borderRadius: const BorderRadius.vertical(top: Radius.circular(12)),
                  ),
                  child: const Row(
                    children: [
                      Text('📝', style: TextStyle(fontSize: 20)),
                      SizedBox(width: 8),
                      Text('FAMINTINANA NY FATRA AMPIASAINA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                    ],
                  ),
                ),
                _buildDosageRow('Zezimaitso', 'Tsy voafetra', 'Atototra anaty tany avy hatrany', Colors.green, true),
                _buildDosageRow('Composte', '1 kapaoka/lavaka', 'Afangaro amin\'ny tany hambolena', Colors.brown, false),
                _buildDosageRow('Ranonjezika', '1L + Rano 5L', 'Tondrahana eo amin\'ny vodiny isan-kerinandro', Colors.teal, true),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Usage by crop type
          const Row(
            children: [
              Text('🌾', style: TextStyle(fontSize: 24)),
              SizedBox(width: 8),
              Text('FATRA ARAKA NY KARAZAN-JAVAMANIRY', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
            ],
          ),
          const SizedBox(height: 12),
          
          _buildCropUsageCard('Legioma ravina (Anamalao, Petsay...)', [
            {'type': 'Composte', 'qty': '2-3 kapaoka/lavaka', 'when': 'Alohan\'ny hambolena'},
            {'type': 'Ranonjezika', 'qty': '1L/5L rano', 'when': 'Isaky ny 7 andro'},
            {'type': 'Zezimaitso', 'qty': 'Bemangidy na Tephrosia', 'when': 'Miaraka amin\'ny voly'},
          ], '🥬'),
          
          _buildCropUsageCard('Legioma voa (Voatabia, Poivron...)', [
            {'type': 'Composte', 'qty': '3-4 kapaoka/lavaka', 'when': 'Alohan\'ny hambolena'},
            {'type': 'Ranonjezika', 'qty': '1L/5L rano', 'when': 'Isaky ny 10-14 andro'},
            {'type': 'Zezimaitso', 'qty': 'Voandelaka', 'when': 'Rehefa mitombo'},
          ], '🍅'),
          
          _buildCropUsageCard('Vary sy Katsaka', [
            {'type': 'Composte', 'qty': '5 kapaoka/m²', 'when': 'Alohan\'ny famafazana'},
            {'type': 'Ranonjezika', 'qty': '1L/5L rano', 'when': 'Isaky ny 15 andro'},
            {'type': 'Zezimaitso', 'qty': 'Tephrosia', 'when': 'Araka izay azo atao'},
          ], '🌾'),
          
          _buildCropUsageCard('Hazo fihinam-boa', [
            {'type': 'Composte', 'qty': '5-10 kg/hazo', 'when': 'Fahavaratra sy ririnina'},
            {'type': 'Ranonjezika', 'qty': '2L/10L rano', 'when': 'Isaky ny volana'},
            {'type': 'Zezimaitso', 'qty': 'Atao manodidina ny faka', 'when': 'Isan-taona'},
          ], '🍊'),
          
          const SizedBox(height: 20),
          
          // Tips
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.blue.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.blue.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('💡', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('TOROHEVITRA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 12),
                _buildTip('1', 'Aza mampiasa zezika mafana', 'Andrasana ho lo tsara aloha ny zezika (tsy mafana intsony)'),
                const SizedBox(height: 8),
                _buildTip('2', 'Tondrahana maraina na hariva', 'Rehefa mafana ny andro dia very ny otrikaina'),
                const SizedBox(height: 8),
                _buildTip('3', 'Aza be loatra', 'Ny be loatra dia mety hanimba ny voly (may ny faka)'),
                const SizedBox(height: 8),
                _buildTip('4', 'Afangaro amin\'ny tany', 'Ny composte dia tsy apetraka amboniny fa afangaro tsara'),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildDosageRow(String type, String dosage, String usage, Color color, bool hasBorder) {
    return Container(
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        border: hasBorder ? Border(bottom: BorderSide(color: Colors.grey.shade200)) : null,
      ),
      child: Row(
        children: [
          Container(
            width: 80,
            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
            decoration: BoxDecoration(
              color: color.withValues(alpha: 0.15),
              borderRadius: BorderRadius.circular(6),
            ),
            child: Text(type, style: TextStyle(fontSize: 11, fontWeight: FontWeight.bold, color: color), textAlign: TextAlign.center),
          ),
          const SizedBox(width: 8),
          Expanded(
            flex: 2,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(dosage, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
                Text(usage, style: TextStyle(fontSize: 10, color: Colors.grey.shade600)),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildCropUsageCard(String crop, List<Map<String, String>> usages, String emoji) {
    return Card(
      margin: const EdgeInsets.only(bottom: 12),
      child: Padding(
        padding: const EdgeInsets.all(12),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Text(emoji, style: const TextStyle(fontSize: 20)),
                const SizedBox(width: 8),
                Expanded(child: Text(crop, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 13))),
              ],
            ),
            const SizedBox(height: 12),
            ...usages.map((usage) => Padding(
              padding: const EdgeInsets.only(bottom: 8),
              child: Row(
                children: [
                  Container(
                    width: 70,
                    padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 3),
                    decoration: BoxDecoration(
                      color: Colors.grey.shade100,
                      borderRadius: BorderRadius.circular(4),
                    ),
                    child: Text(usage['type']!, style: const TextStyle(fontSize: 10), textAlign: TextAlign.center),
                  ),
                  const SizedBox(width: 8),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(usage['qty']!, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 11)),
                        Text(usage['when']!, style: TextStyle(fontSize: 10, color: Colors.grey.shade600)),
                      ],
                    ),
                  ),
                ],
              ),
            )),
          ],
        ),
      ),
    );
  }

  Widget _buildTip(String num, String title, String desc) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Container(
          width: 20,
          height: 20,
          decoration: BoxDecoration(
            color: Colors.blue.shade700,
            shape: BoxShape.circle,
          ),
          child: Center(
            child: Text(num, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 10)),
          ),
        ),
        const SizedBox(width: 8),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(title, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 11)),
              Text(desc, style: TextStyle(fontSize: 10, color: Colors.grey.shade700)),
            ],
          ),
        ),
      ],
    );
  }
}

// Screen 4: Vokatra (Results)
class ZezikaResultsScreen extends StatelessWidget {
  const ZezikaResultsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [Colors.teal.shade700, Colors.teal.shade500],
              ),
              borderRadius: BorderRadius.circular(16),
            ),
            child: const Row(
              children: [
                Text('📊', style: TextStyle(fontSize: 40)),
                SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'VOKATRA SY TOMBONY',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      Text(
                        'Ny soa azo amin\'ny zezika organika',
                        style: TextStyle(color: Colors.white70, fontSize: 12),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Benefits
          const Row(
            children: [
              Text('✨', style: TextStyle(fontSize: 24)),
              SizedBox(width: 8),
              Text('TOMBONY AZON\'NY TANY', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
            ],
          ),
          const SizedBox(height: 12),
          
          _buildBenefitCard('Otrikaina betsaka', 'Azote, Phosphore, Potassium, sy mineraly hafa', Icons.science, Colors.green),
          _buildBenefitCard('Tany lonaka', 'Ny tany dia mianaka sy mangatsiatsiaka kokoa', Icons.landscape, Colors.brown),
          _buildBenefitCard('Rano voatahiry', 'Mitana rano tsara kokoa ny tany', Icons.water_drop, Colors.blue),
          _buildBenefitCard('Biby madinika', 'Mampitombo ny kankana sy biby mahasoa', Icons.bug_report, Colors.orange),
          _buildBenefitCard('Tsy misy poizina', 'Sakafo madio sy salama ho an\'ny fianakaviana', Icons.eco, Colors.teal),
          
          const SizedBox(height: 20),
          
          // Comparison with chemical fertilizers
          Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.grey.shade300),
            ),
            child: Column(
              children: [
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.purple.shade50,
                    borderRadius: const BorderRadius.vertical(top: Radius.circular(12)),
                  ),
                  child: const Row(
                    children: [
                      Text('⚖️', style: TextStyle(fontSize: 20)),
                      SizedBox(width: 8),
                      Text('ZEZIKA ORGANIKA vs SIMIKA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                    ],
                  ),
                ),
                Padding(
                  padding: const EdgeInsets.all(12),
                  child: Table(
                    border: TableBorder.all(color: Colors.grey.shade200),
                    columnWidths: const {
                      0: FlexColumnWidth(2),
                      1: FlexColumnWidth(2),
                      2: FlexColumnWidth(2),
                    },
                    children: [
                      TableRow(
                        decoration: BoxDecoration(color: Colors.grey.shade100),
                        children: const [
                          Padding(
                            padding: EdgeInsets.all(8),
                            child: Text('', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 11)),
                          ),
                          Padding(
                            padding: EdgeInsets.all(8),
                            child: Text('🌿 Organika', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 11), textAlign: TextAlign.center),
                          ),
                          Padding(
                            padding: EdgeInsets.all(8),
                            child: Text('⚗️ Simika', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 11), textAlign: TextAlign.center),
                          ),
                        ],
                      ),
                      _buildComparisonRow('Vidiny', 'Mora/Maimaim-poana', 'Lafo'),
                      _buildComparisonRow('Fahasalamana', 'Tsy misy poizina', 'Mety manimba'),
                      _buildComparisonRow('Tany', 'Manatsara ny tany', 'Manimba ny tany'),
                      _buildComparisonRow('Maharitra', 'Maharitra ela', 'Malaky lany'),
                      _buildComparisonRow('Rano', 'Tsy mandoto', 'Mandoto rano'),
                    ],
                  ),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Expected yields
          const Row(
            children: [
              Text('📈', style: TextStyle(fontSize: 24)),
              SizedBox(width: 8),
              Text('FITOMBOANA ANAMBARANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
            ],
          ),
          const SizedBox(height: 12),
          
          _buildYieldCard('Voatabia', '+30-50%', 'Raha mampiasa composte + ranonjezika', Colors.red),
          _buildYieldCard('Legioma ravina', '+40-60%', 'Raha mampiasa zezimaitso Bemangidy', Colors.green),
          _buildYieldCard('Vary', '+20-30%', 'Raha mampiasa composte tsara', Colors.amber),
          _buildYieldCard('Hazo fihinam-boa', '+25-40%', 'Raha tondrahana ranonjezika isan-bolana', Colors.orange),
          
          const SizedBox(height: 20),
          
          // Cost analysis
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.green.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.green.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('💰', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('TOMBONY ARA-BOLA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 12),
                const Text(
                  'Ny zezika organika dia ahafahana:\n\n'
                  '• Mitsitsy 80-100% ny vidin\'ny zezika\n'
                  '• Mampitombo ny vokatra 30-60%\n'
                  '• Mahazo vokatra madio sy lafo kokoa\n'
                  '• Miaro ny tany ho an\'ny taranaka\n\n'
                  'Ohatra: Ny composte iray dia azo atao 5,000-10,000 Ar nefa manome tombony 50,000+ Ar isan-taona!',
                  style: TextStyle(fontSize: 12, height: 1.5),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Quality signs
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.amber.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.amber.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('✅', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('FAMANTARANA NY KALITAO TSARA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 12),
                _buildQualitySign('Loko', 'Mainty na mavo totohondry'),
                _buildQualitySign('Fofona', 'Tsy maimbo ratsy (fofom-tany tsara)'),
                _buildQualitySign('Hafanana', 'Tsy mafana intsony'),
                _buildQualitySign('Endrika', 'Tsy hita intsony ny ravina na fako'),
                _buildQualitySign('Texture', 'Malemy sy mora voatotofaka'),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildBenefitCard(String title, String desc, IconData icon, Color color) {
    return Card(
      margin: const EdgeInsets.only(bottom: 8),
      child: ListTile(
        leading: Container(
          padding: const EdgeInsets.all(8),
          decoration: BoxDecoration(
            color: color.withValues(alpha: 0.15),
            borderRadius: BorderRadius.circular(8),
          ),
          child: Icon(icon, color: color, size: 24),
        ),
        title: Text(title, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
        subtitle: Text(desc, style: const TextStyle(fontSize: 11)),
      ),
    );
  }

  static TableRow _buildComparisonRow(String label, String organic, String chemical) {
    return TableRow(
      children: [
        Padding(
          padding: const EdgeInsets.all(8),
          child: Text(label, style: const TextStyle(fontSize: 10)),
        ),
        Padding(
          padding: const EdgeInsets.all(8),
          child: Text(organic, style: const TextStyle(fontSize: 10, color: Colors.green), textAlign: TextAlign.center),
        ),
        Padding(
          padding: const EdgeInsets.all(8),
          child: Text(chemical, style: const TextStyle(fontSize: 10, color: Colors.red), textAlign: TextAlign.center),
        ),
      ],
    );
  }

  Widget _buildYieldCard(String crop, String increase, String condition, Color color) {
    return Card(
      margin: const EdgeInsets.only(bottom: 8),
      child: Padding(
        padding: const EdgeInsets.all(12),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              decoration: BoxDecoration(
                color: color.withValues(alpha: 0.15),
                borderRadius: BorderRadius.circular(8),
              ),
              child: Text(increase, style: TextStyle(fontWeight: FontWeight.bold, color: color, fontSize: 14)),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(crop, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                  Text(condition, style: TextStyle(fontSize: 10, color: Colors.grey.shade600)),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildQualitySign(String label, String desc) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 6),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text('• ', style: TextStyle(fontWeight: FontWeight.bold)),
          Text('$label: ', style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
          Expanded(child: Text(desc, style: const TextStyle(fontSize: 12))),
        ],
      ),
    );
  }
}

// ==================== MODULE HOLATRATECH (CHAMPIGNONS) ====================

class HolatraSpeciesScreen extends StatefulWidget {
  const HolatraSpeciesScreen({super.key});

  @override
  State<HolatraSpeciesScreen> createState() => _HolatraSpeciesScreenState();
}

class _HolatraSpeciesScreenState extends State<HolatraSpeciesScreen> {
  String _selectedSpecies = 'Pleurote';

  final Map<String, Map<String, dynamic>> _speciesData = {
    'Pleurote': {
      'emoji': '🍄‍🟫',
      'nom_sci': 'Pleurotus ostreatus',
      'nom_mg': 'Holatra ravina (Pleurote)',
      'description': 'Holatra mora ambolena indrindra. Tsara ho an\'ny mpanomboka.',
      'hafanana': '20-28°C',
      'hamandoana': '80-90%',
      'fotoana': '3-4 herinandro',
      'vokatra': '25-35% ny lanjan\'ny substrat',
      'sakafo': 'Mololo, bozaka maina, taim-bary',
      'tombony': ['Mora ambolena', 'Tsy lafo ny substrat', 'Mafy tsara', 'Vokatra haingana'],
      'fady': ['Tsy tia hafanana ambony 30°C', 'Tsy tia rivotra maina'],
    },
    'Shiitake': {
      'emoji': '🍄‍🟫',
      'nom_sci': 'Lentinula edodes',
      'nom_mg': 'Holatra Japoney (Shiitake)',
      'description': 'Holatra malaza indrindra eran-tany. Tsiro sy fofona manokana.',
      'hafanana': '15-25°C',
      'hamandoana': '75-85%',
      'fotoana': '6-12 volana (hazo)',
      'vokatra': '20-30% ny lanjan\'ny substrat',
      'sakafo': 'Hazo oak, hazo mafy hafa, sciure',
      'tombony': ['Vidiny lafo tsena', 'Maharitra ela', 'Tsiro tsara indrindra'],
      'fady': ['Mila fotoana lava', 'Mila substrat manokana'],
    },
    'Champignon de Paris': {
      'emoji': '🍄‍🟫',
      'nom_sci': 'Agaricus bisporus',
      'nom_mg': 'Holatra Parisiana',
      'description': 'Holatra be mpividy indrindra eran-tany. Fotsy na mavo.',
      'hafanana': '14-18°C',
      'hamandoana': '85-90%',
      'fotoana': '6-8 herinandro',
      'vokatra': '20-25% ny lanjan\'ny substrat',
      'sakafo': 'Taim-biby (soavaly), mololo voapoizina',
      'tombony': ['Tsena lehibe', 'Mpividy betsaka', 'Maharitra ela'],
      'fady': ['Mila hafanana ambany', 'Mila substrat manokana'],
    },
    'Holatra Lovia (Volvariella)': {
      'emoji': '🍄‍🟫',
      'nom_sci': 'Volvariella volvacea',
      'nom_mg': 'Holatra Lovia',
      'description': 'Holatra tropikaly mora ambolena eto Madagasikara.',
      'hafanana': '28-35°C',
      'hamandoana': '80-90%',
      'fotoana': '2-3 herinandro',
      'vokatra': '10-15% ny lanjan\'ny substrat',
      'sakafo': 'Mololo vary, bozaka, ravim-boankazo',
      'tombony': ['Tia hafanana (tsara ho an\'i Madagasikara)', 'Vokatra haingana indrindra', 'Substrat mora hita'],
      'fady': ['Tsy maharitra ela', 'Mila hamandoana avo'],
    },
    'Holatra Fanahy (Reishi)': {
      'emoji': '🍄‍🟫',
      'nom_sci': 'Ganoderma lucidum',
      'nom_mg': 'Holatra Fanahy (Reishi)',
      'description': 'Holatra fanafody malaza. Ampiasaina ho fanafody hatry ny ela.',
      'hafanana': '24-28°C',
      'hamandoana': '80-95%',
      'fotoana': '3-6 volana',
      'vokatra': '5-10% ny lanjan\'ny substrat',
      'sakafo': 'Hazo mafy, sciure',
      'tombony': ['Vidiny ambony dia ambony', 'Fanafody malaza', 'Maharitra ela rehefa maina'],
      'fady': ['Tsy fihinana mivantana', 'Mila fotoana lava'],
    },
    'Holatra Volamena (Golden Oyster)': {
      'emoji': '🍄‍🟫',
      'nom_sci': 'Pleurotus citrinopileatus',
      'nom_mg': 'Holatra Volamena',
      'description': 'Pleurote mavo tsara tarehy. Tsiro manokana.',
      'hafanana': '22-30°C',
      'hamandoana': '80-90%',
      'fotoana': '3-4 herinandro',
      'vokatra': '20-30% ny lanjan\'ny substrat',
      'sakafo': 'Mololo, bozaka maina, taim-bary',
      'tombony': ['Tsara tarehy (mavo)', 'Tia hafanana', 'Tsiro manokana'],
      'fady': ['Tsy maharitra ela', 'Mora simba'],
    },
  };

  @override
  Widget build(BuildContext context) {
    final species = _speciesData[_selectedSpecies]!;
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [Colors.brown.shade700, Colors.brown.shade500],
              ),
              borderRadius: BorderRadius.circular(16),
            ),
            child: const Row(
              children: [
                Text('🍄‍🟫', style: TextStyle(fontSize: 40)),
                SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text('KARAZAN\'NY HOLATRA', style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('Champignons comestibles', style: TextStyle(color: Colors.white70, fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 16),
          
          // Species selector
          SizedBox(
            height: 45,
            child: ListView(
              scrollDirection: Axis.horizontal,
              children: _speciesData.keys.map((name) {
                final isSelected = _selectedSpecies == name;
                return Padding(
                  padding: const EdgeInsets.only(right: 8),
                  child: ChoiceChip(
                    label: Text(name, style: TextStyle(fontSize: 11, color: isSelected ? Colors.white : Colors.brown)),
                    selected: isSelected,
                    selectedColor: Colors.brown.shade600,
                    onSelected: (_) => setState(() => _selectedSpecies = name),
                  ),
                );
              }).toList(),
            ),
          ),
          
          const SizedBox(height: 16),
          
          // Species details card
          Card(
            child: Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Row(
                    children: [
                      Text(species['emoji'], style: const TextStyle(fontSize: 50)),
                      const SizedBox(width: 16),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(_selectedSpecies, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 18)),
                            Text(species['nom_sci'], style: TextStyle(fontStyle: FontStyle.italic, color: Colors.grey.shade600, fontSize: 12)),
                          ],
                        ),
                      ),
                    ],
                  ),
                  const Divider(height: 24),
                  Text(species['description'], style: const TextStyle(fontSize: 13)),
                  const SizedBox(height: 16),
                  
                  // Conditions
                  _buildConditionRow('🌡️', 'Hafanana', species['hafanana']),
                  _buildConditionRow('💧', 'Hamandoana', species['hamandoana']),
                  _buildConditionRow('⏱️', 'Fotoana fitomboana', species['fotoana']),
                  _buildConditionRow('📦', 'Vokatra azo', species['vokatra']),
                  _buildConditionRow('🌾', 'Sakafo (Substrat)', species['sakafo']),
                ],
              ),
            ),
          ),
          
          const SizedBox(height: 16),
          
          // Advantages
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.green.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.green.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('✅', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('TOMBONY', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 8),
                ...((species['tombony'] as List).map((t) => Padding(
                  padding: const EdgeInsets.only(bottom: 4),
                  child: Row(
                    children: [
                      const Text('• ', style: TextStyle(color: Colors.green)),
                      Expanded(child: Text(t, style: const TextStyle(fontSize: 12))),
                    ],
                  ),
                ))),
              ],
            ),
          ),
          
          const SizedBox(height: 12),
          
          // Disadvantages
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.orange.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.orange.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('⚠️', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('FADY / OLANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 8),
                ...((species['fady'] as List).map((t) => Padding(
                  padding: const EdgeInsets.only(bottom: 4),
                  child: Row(
                    children: [
                      const Text('• ', style: TextStyle(color: Colors.orange)),
                      Expanded(child: Text(t, style: const TextStyle(fontSize: 12))),
                    ],
                  ),
                ))),
              ],
            ),
          ),
          
          const SizedBox(height: 16),
          
          // Recommended for Madagascar
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              gradient: LinearGradient(colors: [Colors.teal.shade100, Colors.teal.shade50]),
              borderRadius: BorderRadius.circular(12),
            ),
            child: const Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text('🇲🇬', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('TSARA HO AN\'I MADAGASIKARA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                  ],
                ),
                SizedBox(height: 8),
                Text(
                  '• Pleurote - Mora indrindra, tia hafanana\n'
                  '• Holatra Lovia - Tia mafana (28-35°C)\n'
                  '• Holatra Volamena - Tsara tarehy, tsena tsara',
                  style: TextStyle(fontSize: 12),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildConditionRow(String emoji, String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(emoji, style: const TextStyle(fontSize: 18)),
          const SizedBox(width: 8),
          Text('$label: ', style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
          Expanded(child: Text(value, style: const TextStyle(fontSize: 12))),
        ],
      ),
    );
  }
}

class HolatraGrowingScreen extends StatelessWidget {
  const HolatraGrowingScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [Colors.teal.shade700, Colors.teal.shade500],
              ),
              borderRadius: BorderRadius.circular(16),
            ),
            child: const Row(
              children: [
                Text('🌡️', style: TextStyle(fontSize: 40)),
                SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text('FAMBOLENA HOLATRA', style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('Dingana rehetra amin\'ny fambolena', style: TextStyle(color: Colors.white70, fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Step by step guide
          const Text('📋 DINGANA FAMBOLENA PLEUROTE', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
          const SizedBox(height: 12),
          
          _buildStep(1, 'Fanomanana Substrat', 
            '• Mololo vary na bozaka maina\n'
            '• Alefaso ao anaty rano 24 ora\n'
            '• Faohina tsara mba tsy hisy rano be\n'
            '• Pasteurisez @ 60-80°C mandritra 1 ora',
            Colors.blue),
          
          _buildStep(2, 'Inoculation (Fanasitrihana)', 
            '• Arahaba ny substrat ho 25-30°C\n'
            '• Asio ny spawn (masomboly holatra) 5-10%\n'
            '• Afangaro tsara\n'
            '• Asio ao anaty kitapo plastika',
            Colors.green),
          
          _buildStep(3, 'Incubation (Fitomboana masomboly)', 
            '• Apetraho ao amin\'ny toerana maizina\n'
            '• Hafanana: 24-28°C\n'
            '• Andraso 2-3 herinandro\n'
            '• Ny substrat dia ho fotsy tanteraka (mycelium)',
            Colors.purple),
          
          _buildStep(4, 'Fructification (Famokarana)', 
            '• Asio lavaka kely ny kitapo\n'
            '• Apetraho ao amin\'ny toerana mazava (tsy masoandro mivantana)\n'
            '• Hamandoana: 80-90%\n'
            '• Rivotra madio (famoahana CO2)\n'
            '• Hafanana: 18-25°C',
            Colors.orange),
          
          _buildStep(5, 'Fijinjana', 
            '• Rehefa lehibe ny satroka (5-10cm)\n'
            '• Alohan\'ny hisokafan\'ny satroka tanteraka\n'
            '• Tapaho amin\'ny antsipika maranitra\n'
            '• Misy vokatra 2-3 isaky ny kitapo',
            Colors.red),
          
          const SizedBox(height: 20),
          
          // Environment requirements
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.blue.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.blue.shade200),
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Row(
                  children: [
                    Text('🏠', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('TRANO FAMBOLENA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                const SizedBox(height: 12),
                _buildEnvRow('📐', 'Habe', '3x4m dia ampy ho an\'ny 100 kitapo'),
                _buildEnvRow('💡', 'Hazavana', 'Mazava fa tsy masoandro mivantana'),
                _buildEnvRow('💨', 'Rivotra', 'Misy varavarankely ho famoahana CO2'),
                _buildEnvRow('💧', 'Rano', 'Misy robine na fitondrana rano'),
                _buildEnvRow('🧱', 'Rindrina', 'Mety ho vy, hazo, na biriky'),
              ],
            ),
          ),
          
          const SizedBox(height: 16),
          
          // Humidity control
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.cyan.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.cyan.shade200),
            ),
            child: const Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text('💧', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('FITANTANANA HAMANDOANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                SizedBox(height: 12),
                Text(
                  '• Tondrahy rano 2-3 isan\'andro (sprayer)\n'
                  '• Asio barika rano ao anaty trano\n'
                  '• Humidificateur raha azo atao\n'
                  '• Jereo ny kitapo mba tsy ho maina\n'
                  '• 80-90% hamandoana no tsara indrindra',
                  style: TextStyle(fontSize: 12, height: 1.5),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 16),
          
          // Common problems
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.red.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.red.shade200),
            ),
            child: const Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text('⚠️', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('OLANA MAHAZATRA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                SizedBox(height: 12),
                Text(
                  '• Holatra maitso/mainty = Contamination (ario ny kitapo)\n'
                  '• Tsy mitsiry = Tsy ampy hamandoana na mafana loatra\n'
                  '• Holatra kely = Tsy ampy hazavana na rivotra\n'
                  '• Holatra malazo = Mafana loatra na maina\n'
                  '• Biby kely (mouches) = Tsy madio ny trano',
                  style: TextStyle(fontSize: 12, height: 1.5),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStep(int number, String title, String content, Color color) {
    return Container(
      margin: const EdgeInsets.only(bottom: 12),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            width: 32,
            height: 32,
            decoration: BoxDecoration(
              color: color,
              shape: BoxShape.circle,
            ),
            child: Center(
              child: Text('$number', style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Card(
              child: Padding(
                padding: const EdgeInsets.all(12),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(title, style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14, color: color)),
                    const SizedBox(height: 8),
                    Text(content, style: const TextStyle(fontSize: 12, height: 1.4)),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildEnvRow(String emoji, String label, String value) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 6),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(emoji, style: const TextStyle(fontSize: 16)),
          const SizedBox(width: 8),
          Text('$label: ', style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 12)),
          Expanded(child: Text(value, style: const TextStyle(fontSize: 12))),
        ],
      ),
    );
  }
}

class HolatraHarvestScreen extends StatelessWidget {
  const HolatraHarvestScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [Colors.orange.shade700, Colors.orange.shade500],
              ),
              borderRadius: BorderRadius.circular(16),
            ),
            child: const Row(
              children: [
                Text('📦', style: TextStyle(fontSize: 40)),
                SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text('FIOTAZANA SY FITEHIRIZANA', style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('Fomba fiotazana sy fitahirizana holatra', style: TextStyle(color: Colors.white70, fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // When to harvest
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.green.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.green.shade200),
            ),
            child: const Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text('⏰', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('FOTOANA FIOTAZANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                SizedBox(height: 12),
                Text(
                  '✅ TSARA OTAZANA:\n'
                  '• Rehefa lehibe ny satroka (5-15cm araka ny karazana)\n'
                  '• Alohan\'ny hisokafan\'ny satroka tanteraka\n'
                  '• Mbola miondrika ny sisiny\n'
                  '• Loko mazava sy madio\n\n'
                  '❌ DISO FOTOANA:\n'
                  '• Efa nisokatra tanteraka ny satroka = efa antitra\n'
                  '• Efa mipoitra ny spores (vovoka) = lasa ny tsiro\n'
                  '• Efa maina ny sisiny = tsy maharitra',
                  style: TextStyle(fontSize: 12, height: 1.5),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 16),
          
          // How to harvest
          const Text('✂️ FOMBA FIOTAZANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
          const SizedBox(height: 12),
          
          _buildHarvestCard('Pleurote', 
            '• Tazonina ny fototra\n'
            '• Tsoahina miaraka amin\'ny cluster\n'
            '• Tsy tapahina (tsoahina)',
            Colors.brown),
          
          _buildHarvestCard('Champignon de Paris', 
            '• Hodidina kely ny holatra\n'
            '• Tsoahina miaraka amin\'ny faka\n'
            '• Azo tapahina ihany koa',
            Colors.grey),
          
          _buildHarvestCard('Shiitake', 
            '• Tapahina amin\'ny antsipika maranitra\n'
            '• Avela kely ny fototra\n'
            '• Tsy tsoahina (manimba ny hazo)',
            Colors.amber),
          
          const SizedBox(height: 20),
          
          // Storage methods
          const Text('🧊 FITAHIRIZANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
          const SizedBox(height: 12),
          
          Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.grey.shade300),
            ),
            child: Column(
              children: [
                _buildStorageRow('Vaovao (frais)', '3-5 andro', 'Réfrigérateur 4°C, kitapo taratasy', Icons.ac_unit, Colors.blue),
                const Divider(height: 1),
                _buildStorageRow('Maina (séché)', '6-12 volana', 'Hafanana 40-50°C, 2-3 andro', Icons.wb_sunny, Colors.orange),
                const Divider(height: 1),
                _buildStorageRow('Voapoizina (congelé)', '6 volana', 'Andrahoy aloha, avy eo congelé', Icons.severe_cold, Colors.cyan),
                const Divider(height: 1),
                _buildStorageRow('Marinade', '3-6 volana', 'Ao anaty vinaigre na menaka', Icons.local_drink, Colors.green),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Drying instructions
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.amber.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.amber.shade200),
            ),
            child: const Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text('☀️', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('FAMAINANA (SÉCHAGE)', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                SizedBox(height: 12),
                Text(
                  '1. Tapaho kely ny holatra (3-5mm)\n'
                  '2. Avelao ao amin\'ny masoandro na séchoir\n'
                  '3. Hafanana: 40-50°C (tsy ambony 60°C)\n'
                  '4. Fotoana: 24-48 ora\n'
                  '5. Rehefa mafy toy ny taolana = vita\n'
                  '6. Tehirizo ao anaty kaopy hermetika\n\n'
                  '💡 Ny holatra maina dia 10x maivana kokoa!',
                  style: TextStyle(fontSize: 12, height: 1.5),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 16),
          
          // Yield expectations
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.purple.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.purple.shade200),
            ),
            child: const Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text('📊', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('VOKATRA ANAMBARANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                SizedBox(height: 12),
                Text(
                  '📦 Kitapo 1kg substrat:\n'
                  '• Pleurote: 250-350g holatra\n'
                  '• Vokatra 2-3 isaky ny kitapo\n'
                  '• Elanelana 7-14 andro isaky ny vokatra\n\n'
                  '🏭 Orinasa kely (100 kitapo/herinandro):\n'
                  '• Vokatra: 25-35kg holatra/herinandro\n'
                  '• Isan-bolana: 100-140kg holatra',
                  style: TextStyle(fontSize: 12, height: 1.5),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildHarvestCard(String type, String instructions, Color color) {
    return Card(
      margin: const EdgeInsets.only(bottom: 8),
      child: Padding(
        padding: const EdgeInsets.all(12),
        child: Row(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Container(
              padding: const EdgeInsets.all(8),
              decoration: BoxDecoration(
                color: color.withValues(alpha: 0.15),
                borderRadius: BorderRadius.circular(8),
              ),
              child: const Text('🍄‍🟫', style: TextStyle(fontSize: 24)),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(type, style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14, color: color)),
                  const SizedBox(height: 4),
                  Text(instructions, style: const TextStyle(fontSize: 11, height: 1.4)),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildStorageRow(String method, String duration, String details, IconData icon, Color color) {
    return Padding(
      padding: const EdgeInsets.all(12),
      child: Row(
        children: [
          Container(
            padding: const EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: color.withValues(alpha: 0.15),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(icon, color: color, size: 24),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Expanded(
                      child: Text(method, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                    ),
                    const SizedBox(width: 8),
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                      decoration: BoxDecoration(
                        color: color.withValues(alpha: 0.15),
                        borderRadius: BorderRadius.circular(10),
                      ),
                      child: Text(duration, style: TextStyle(fontSize: 10, color: color, fontWeight: FontWeight.bold)),
                    ),
                  ],
                ),
                const SizedBox(height: 2),
                Text(details, style: TextStyle(fontSize: 11, color: Colors.grey.shade600)),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

class HolatraMarketScreen extends StatelessWidget {
  const HolatraMarketScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              gradient: LinearGradient(
                colors: [Colors.green.shade700, Colors.green.shade500],
              ),
              borderRadius: BorderRadius.circular(16),
            ),
            child: const Row(
              children: [
                Text('🛒', style: TextStyle(fontSize: 40)),
                SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text('TSENA SY TOMBONY', style: TextStyle(color: Colors.white, fontSize: 18, fontWeight: FontWeight.bold)),
                      Text('Fivarotana sy kajy tombony', style: TextStyle(color: Colors.white70, fontSize: 12)),
                    ],
                  ),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Market prices
          const Text('💰 VIDINY ETO MADAGASIKARA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
          const SizedBox(height: 12),
          
          _buildPriceCard('Pleurote vaovao', '15,000 - 25,000 Ar/kg', 'Tsena be mpividy indrindra', Colors.brown),
          _buildPriceCard('Shiitake vaovao', '30,000 - 50,000 Ar/kg', 'Restorant sy hotel', Colors.amber),
          _buildPriceCard('Champignon Paris', '20,000 - 35,000 Ar/kg', 'Supermarché', Colors.grey),
          _buildPriceCard('Holatra maina', '80,000 - 150,000 Ar/kg', 'Export sy pharmaceutique', Colors.orange),
          
          const SizedBox(height: 20),
          
          // Where to sell
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.blue.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.blue.shade200),
            ),
            child: const Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text('🏪', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('TOERANA FIVAROTANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                SizedBox(height: 12),
                Text(
                  '🍽️ Restorant sy Hotel\n'
                  '   • Mividy betsaka, vidiny tsara\n'
                  '   • Mila kalitao sy fahazarana\n\n'
                  '🛒 Supermarché (Jumbo, Leader Price...)\n'
                  '   • Mila emballage tsara\n'
                  '   • Mila faharetan\'ny vokatra\n\n'
                  '🏠 Tsena tsotra sy mpivarotra\n'
                  '   • Mora manomboka\n'
                  '   • Mila mpividy mahatoky\n\n'
                  '📱 Facebook / WhatsApp\n'
                  '   • Livraison mivantana\n'
                  '   • Tsy misy intermédiaire',
                  style: TextStyle(fontSize: 12, height: 1.5),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 20),
          
          // Profitability calculator
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.green.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.green.shade200),
            ),
            child: const Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text('📊', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('KAJY TOMBONY (100 kitapo/volana)', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                SizedBox(height: 12),
                Text(
                  '📥 FANDANIANA:\n'
                  '   • Substrat (mololo): 50,000 Ar\n'
                  '   • Spawn (masomboly): 100,000 Ar\n'
                  '   • Kitapo plastika: 20,000 Ar\n'
                  '   • Rano sy jiro: 30,000 Ar\n'
                  '   • Hafa: 50,000 Ar\n'
                  '   ➡️ TOTAL: 250,000 Ar\n\n'
                  '📤 VOLA MIDITRA:\n'
                  '   • Vokatra: 30kg x 20,000 Ar = 600,000 Ar\n\n'
                  '💵 TOMBONY MADIO:\n'
                  '   600,000 - 250,000 = 350,000 Ar/volana\n\n'
                  '📈 Marge: ~58%',
                  style: TextStyle(fontSize: 12, height: 1.5, fontFamily: 'monospace'),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 16),
          
          // Investment needed
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.purple.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.purple.shade200),
            ),
            child: const Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text('🏗️', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('VOLA ILAINA HANOMBOHANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                SizedBox(height: 12),
                Text(
                  '🏠 Trano fambolena kely (3x4m):\n'
                  '   • 500,000 - 1,500,000 Ar\n\n'
                  '🧰 Fitaovana:\n'
                  '   • Sprayer: 30,000 Ar\n'
                  '   • Thermomètre/Hygromètre: 20,000 Ar\n'
                  '   • Fatra sy amboara: 50,000 Ar\n\n'
                  '🌱 Fampandehanana voalohany:\n'
                  '   • Spawn sy substrat: 250,000 Ar\n\n'
                  '➡️ TOTAL: 800,000 - 1,800,000 Ar',
                  style: TextStyle(fontSize: 12, height: 1.5),
                ),
              ],
            ),
          ),
          
          const SizedBox(height: 16),
          
          // Tips for success
          Container(
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(
              color: Colors.teal.shade50,
              borderRadius: BorderRadius.circular(12),
              border: Border.all(color: Colors.teal.shade200),
            ),
            child: const Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Text('💡', style: TextStyle(fontSize: 20)),
                    SizedBox(width: 8),
                    Text('TOROHEVITRA FAHOMBIAZANA', style: TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
                  ],
                ),
                SizedBox(height: 12),
                Text(
                  '✅ Manomboha kely (20-50 kitapo)\n'
                  '✅ Mianara tsara alohan\'ny hanalehibe\n'
                  '✅ Mitazona kalitao tsara lalandava\n'
                  '✅ Mampiasa spawn tsara kalitao\n'
                  '✅ Manaraka ny fahadiovana (hygiène)\n'
                  '✅ Mitady mpividy alohan\'ny hamokatra be\n'
                  '✅ Manao sary sy video ho an\'ny Facebook\n'
                  '✅ Manome holatra sample ho an\'ny mpividy',
                  style: TextStyle(fontSize: 12, height: 1.5),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildPriceCard(String name, String price, String market, Color color) {
    return Card(
      margin: const EdgeInsets.only(bottom: 8),
      child: Padding(
        padding: const EdgeInsets.all(12),
        child: Row(
          children: [
            Container(
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: color.withValues(alpha: 0.15),
                borderRadius: BorderRadius.circular(8),
              ),
              child: const Text('🍄‍🟫', style: TextStyle(fontSize: 24)),
            ),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(name, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 13)),
                  const SizedBox(height: 2),
                  Text(market, style: TextStyle(fontSize: 11, color: Colors.grey.shade600)),
                ],
              ),
            ),
            ConstrainedBox(
              constraints: const BoxConstraints(maxWidth: 120),
              child: Container(
                padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                decoration: BoxDecoration(
                  color: Colors.green.shade100,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(price, style: TextStyle(fontWeight: FontWeight.bold, fontSize: 11, color: Colors.green.shade700), overflow: TextOverflow.ellipsis),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// ==================== PROFITABILITY ANALYZER (TOMBONY) ====================
class ProfitabilityAnalyzerDialog extends StatefulWidget {
  const ProfitabilityAnalyzerDialog({super.key});

  @override
  State<ProfitabilityAnalyzerDialog> createState() => _ProfitabilityAnalyzerDialogState();
}

class _ProfitabilityAnalyzerDialogState extends State<ProfitabilityAnalyzerDialog> {
  final TextEditingController _budgetCtrl = TextEditingController();
  double _budget = 0;
  bool _showResults = false;
  String _sortOption = 'score'; // score, short_term, long_term
  List<Map<String, dynamic>> _recommendations = [];

  // Base de données réaliste des activités avec leurs coûts et rendements
  // Données basées sur les réalités malgaches - Prix mis à jour JANVIER 2025
  // Note: Inflation 7,9% - Période de soudure - Hausse provende +15%
  // minBudget = coût minimum réel pour démarrer (matériels essentiels uniquement)
  final List<Map<String, dynamic>> _activities = [
    // FIOMPIANA (Élevage) - Prix Janvier 2025
    {
      'category': 'fiompiana',
      'type': 'Akoho gasy (10 isa)',
      'emoji': '🐔',
      'minBudget': 85000, // Version kely: 10 akoho gasy, tsy mila poulailler lafo
      'unitCost': 50000, // Vidin'ny akoho gasy 10 (5000 Ar/isa)
      'feedCostPerMonth': 15000, // Sakafo 10 akoho isam-bolana
      'cycleMonths': 4,
      'unitProfit': 80000, // Tombony 10 akoho
      'riskLevel': 'ambany',
      'difficulty': 'mora',
      'description': 'Version kely: 10 akoho gasy. Mora ampidirina, tsy mila toerana lehibe.',
      'tips': 'Mila vakisiny, tranom-borona tsotra, ary sakafo tsara.',
      'returnRate': 0.60,
      'materials': [
        {'name': 'Akoho gasy 10 isa', 'quantity': '10', 'price': 50000, 'unit': 'iray', 'essential': true},
        {'name': 'Tranom-borona tsotra (hazo/bozaka)', 'quantity': '1', 'price': 25000, 'unit': 'iray', 'essential': true},
        {'name': 'Fanovana rano (bidon vaky)', 'quantity': '1', 'price': 2000, 'unit': 'iray', 'essential': true},
        {'name': 'Vilia fihinanana (basin plastika)', 'quantity': '1', 'price': 3000, 'unit': 'iray', 'essential': true},
        {'name': 'Vakisiny Newcastle', 'quantity': '1 boaty', 'price': 5000, 'unit': 'boaty', 'essential': true},
        {'name': 'Tranom-borona beton (optionnel)', 'quantity': '1', 'price': 150000, 'unit': 'iray', 'essential': false},
        {'name': 'Provende industriel 25kg (optionnel)', 'quantity': '1', 'price': 95000, 'unit': 'sac', 'essential': false},
      ],
    },
    {
      'category': 'fiompiana',
      'type': 'Akoho chair (50 isa)',
      'emoji': '🍗',
      'minBudget': 450000, // Budget réaliste pour 50 poulets de chair
      'unitCost': 225000, // Poussin chair 50 (4500 Ar/isa)
      'feedCostPerMonth': 120000, // Provende 50 akoho
      'cycleMonths': 2, // 6-7 herinandro
      'unitProfit': 200000, // Tombony 50 akoho
      'riskLevel': 'antonony',
      'difficulty': 'antonony',
      'description': 'Akoho chair 50 isa. Mila provende industriel. Tombony haingana (6-7 herinandro).',
      'tips': 'Mila jiro mafana, ventilation tsara, vakisiny feno.',
      'returnRate': 0.40,
      'materials': [
        {'name': 'Poussin chair 1 jour', 'quantity': '50', 'price': 225000, 'unit': 'iray', 'essential': true},
        {'name': 'Provende démarrage 50kg', 'quantity': '1 sac', 'price': 200000, 'unit': 'sac', 'essential': true},
        {'name': 'Provende croissance 50kg', 'quantity': '2 sac', 'price': 370000, 'unit': 'sac', 'essential': true},
        {'name': 'Vakisiny complet', 'quantity': '1 kit', 'price': 25000, 'unit': 'kit', 'essential': true},
        {'name': 'Vitamina + Antibiotika', 'quantity': '1 kit', 'price': 22000, 'unit': 'kit', 'essential': true},
        {'name': 'Tranom-borona tsotra', 'quantity': '1', 'price': 80000, 'unit': 'iray', 'essential': true},
        {'name': 'Jiro mafana', 'quantity': '2', 'price': 30000, 'unit': 'iray', 'essential': true},
        {'name': 'Fanovana rano', 'quantity': '3', 'price': 15000, 'unit': 'iray', 'essential': true},
        {'name': 'Vilia fihinanana', 'quantity': '3', 'price': 15000, 'unit': 'iray', 'essential': true},
      ],
    },
    {
      'category': 'fiompiana',
      'type': 'Akoho mpaneno (5 isa)',
      'emoji': '🥚',
      'minBudget': 120000, // Version kely: 5 pondeuse
      'unitCost': 90000, // Pondeuse 5 (18000 Ar/isa)
      'feedCostPerMonth': 25000, // Sakafo 5 pondeuse
      'cycleMonths': 12,
      'unitProfit': 150000, // Tombony atody isan-taona
      'riskLevel': 'antonony',
      'difficulty': 'antonony',
      'description': 'Version kely: 5 pondeuse. Atody 250-300 isan-taona isaky ny iray.',
      'tips': 'Mila jiro 14-16 ora isan\'andro, rano madio, calcium.',
      'returnRate': 0.65,
      'materials': [
        {'name': 'Pondeuse 18 herinandro', 'quantity': '5', 'price': 90000, 'unit': 'iray', 'essential': true},
        {'name': 'Pondoir tsotra (boaty hazo)', 'quantity': '3', 'price': 15000, 'unit': 'iray', 'essential': true},
        {'name': 'Sakafo pondeuse (vary + katsaka)', 'quantity': '25 kg', 'price': 25000, 'unit': 'kg', 'essential': true},
        {'name': 'Calcium (coquille)', 'quantity': '2 kg', 'price': 5000, 'unit': 'kg', 'essential': true},
        {'name': 'Fanovana rano', 'quantity': '1', 'price': 3000, 'unit': 'iray', 'essential': true},
        {'name': 'Tranom-borona lehibe (optionnel)', 'quantity': '1', 'price': 170000, 'unit': 'iray', 'essential': false},
        {'name': 'Provende pondeuse 50kg (optionnel)', 'quantity': '1 sac', 'price': 195000, 'unit': 'sac', 'essential': false},
      ],
    },
    {
      'category': 'fiompiana',
      'type': 'Gana (10 isa)',
      'emoji': '🦆',
      'minBudget': 65000, // Version kely: 10 gana
      'unitCost': 40000, // Ganakely 10 (4000 Ar/isa)
      'feedCostPerMonth': 18000,
      'cycleMonths': 4,
      'unitProfit': 70000,
      'riskLevel': 'ambany',
      'difficulty': 'mora',
      'description': 'Version kely: 10 gana. Mahatanty aretina kokoa noho ny akoho.',
      'tips': 'Mila rano fisasana, afaka mihinana kankana sy ravina.',
      'returnRate': 0.55,
      'materials': [
        {'name': 'Ganakely 10 isa', 'quantity': '10', 'price': 40000, 'unit': 'iray', 'essential': true},
        {'name': 'Tranom-borona tsotra', 'quantity': '1', 'price': 20000, 'unit': 'iray', 'essential': true},
        {'name': 'Basin rano fisasana', 'quantity': '1', 'price': 8000, 'unit': 'iray', 'essential': true},
        {'name': 'Vakisiny gana', 'quantity': '1 boaty', 'price': 8000, 'unit': 'boaty', 'essential': true},
        {'name': 'Sakafo (vary + ravina)', 'quantity': '1 volana', 'price': 18000, 'unit': 'volana', 'essential': true},
      ],
    },
    {
      'category': 'fiompiana',
      'type': 'Bitro (2 reny)',
      'emoji': '🐰',
      'minBudget': 75000, // Version kely: 2 reny bitro
      'unitCost': 50000, // Bitro reny 2 (25000 Ar/isa)
      'feedCostPerMonth': 8000,
      'cycleMonths': 3,
      'unitProfit': 80000, // 6-8 zaza x 2 reny = 12-16 zaza
      'riskLevel': 'antonony',
      'difficulty': 'antonony',
      'description': 'Version kely: 2 reny bitro. Miteraka 6-8 zaza isaky ny 2 volana.',
      'tips': 'Mila tranobe madio, aza avela ho lena. Sakafo: ahitra, legioma.',
      'returnRate': 0.70,
      'materials': [
        {'name': 'Bitro reny 2 isa', 'quantity': '2', 'price': 50000, 'unit': 'iray', 'essential': true},
        {'name': 'Cage hazo tsotra', 'quantity': '2', 'price': 30000, 'unit': 'iray', 'essential': true},
        {'name': 'Fanovana rano', 'quantity': '2', 'price': 4000, 'unit': 'iray', 'essential': true},
        {'name': 'Ahitra/Foin (1 volana)', 'quantity': '5 kg', 'price': 5000, 'unit': 'kg', 'essential': true},
        {'name': 'Legioma (1 volana)', 'quantity': '10 kg', 'price': 10000, 'unit': 'kg', 'essential': true},
        {'name': 'Cage vy (optionnel)', 'quantity': '2', 'price': 55000, 'unit': 'iray', 'essential': false},
        {'name': 'Provende bitro 50kg (optionnel)', 'quantity': '1 sac', 'price': 175000, 'unit': 'sac', 'essential': false},
      ],
    },
    {
      'category': 'fiompiana',
      'type': 'Kisoakely (1 isa)',
      'emoji': '🐷',
      'minBudget': 180000, // Version kely: 1 porcelet hatavezina
      'unitCost': 80000, // Porcelet iray
      'feedCostPerMonth': 45000, // Sakafo manokana
      'cycleMonths': 5,
      'unitProfit': 150000,
      'riskLevel': 'antonony',
      'difficulty': 'antonony',
      'description': 'Version kely: 1 kisoakely hatavezina. 5 volana dia azo amidy.',
      'tips': 'Mila tranobe madio, sakafo betsaka (son de riz, mangahazo).',
      'returnRate': 0.55,
      'materials': [
        {'name': 'Kisoakely (Porcelet 2 volana)', 'quantity': '1', 'price': 80000, 'unit': 'iray', 'essential': true},
        {'name': 'Trano kisoa tsotra (hazo)', 'quantity': '1', 'price': 50000, 'unit': 'iray', 'essential': true},
        {'name': 'Son de riz (1 volana)', 'quantity': '50 kg', 'price': 40000, 'unit': 'kg', 'essential': true},
        {'name': 'Mangahazo (1 volana)', 'quantity': '50 kg', 'price': 15000, 'unit': 'kg', 'essential': true},
        {'name': 'Vakisiny PPC', 'quantity': '1', 'price': 15000, 'unit': 'iray', 'essential': true},
        {'name': 'Provende kisoa 50kg (optionnel)', 'quantity': '1 sac', 'price': 180000, 'unit': 'sac', 'essential': false},
      ],
    },
    {
      'category': 'fiompiana',
      'type': 'Trondro kely (Basin plastika)',
      'emoji': '🐟',
      'minBudget': 95000, // Version kely: basin plastika + 100 fingerlings
      'unitCost': 60000,
      'feedCostPerMonth': 15000,
      'cycleMonths': 6,
      'unitProfit': 80000,
      'riskLevel': 'antonony',
      'difficulty': 'antonony',
      'description': 'Version kely: 100 trondro ao anaty basin plastika 500L.',
      'tips': 'Mila rano madio, masoandro, sakafo vary masaka.',
      'returnRate': 0.55,
      'materials': [
        {'name': 'Basin plastika 500L', 'quantity': '1', 'price': 45000, 'unit': 'iray', 'essential': true},
        {'name': 'Fingerlings Tilapia 100 isa', 'quantity': '100', 'price': 25000, 'unit': 'iray', 'essential': true},
        {'name': 'Sakafo trondro (vary masaka)', 'quantity': '1 volana', 'price': 15000, 'unit': 'volana', 'essential': true},
        {'name': 'Harato kely', 'quantity': '1', 'price': 8000, 'unit': 'iray', 'essential': true},
        {'name': 'Pompe aérateur (optionnel)', 'quantity': '1', 'price': 45000, 'unit': 'iray', 'essential': false},
        {'name': 'Provende trondro 25kg (optionnel)', 'quantity': '1 sac', 'price': 90000, 'unit': 'sac', 'essential': false},
      ],
    },
    {
      'category': 'fiompiana',
      'type': 'Trondro (Kamory 1 are)',
      'emoji': '🌊',
      'minBudget': 100000, // Alevins + sakafo (raha efa misy tany)
      'unitCost': 80000, // Alevins 300 + fanomanana
      'feedCostPerMonth': 20000, // Compost + son
      'cycleMonths': 6,
      'unitProfit': 250000, // 300 trondro x 250g = 75kg x 10000 Ar = 750000 - depenses
      'riskLevel': 'antonony',
      'difficulty': 'antonony',
      'description': 'Fiompiana anaty kamory (Etang). Tombony be raha manana tany.',
      'tips': 'Mila rano mikoriana kely na ovaina matetika. Zezika organika.',
      'returnRate': 1.25,
      'materials': [
        {'name': 'Alevins Tilapia 300 isa', 'quantity': '300', 'price': 75000, 'unit': 'iray', 'essential': true},
        {'name': 'Sakafo (Son de riz + Compost)', 'quantity': '1 volana', 'price': 20000, 'unit': 'volana', 'essential': true},
        {'name': 'Fitaovana fandavahana (Angady)', 'quantity': '1', 'price': 0, 'unit': 'iray', 'essential': true, 'borrowable': true},
        {'name': 'Tuyau PVC (famoahana rano)', 'quantity': '1', 'price': 15000, 'unit': 'iray', 'essential': true},
        {'name': 'Chaux (fanadiovana)', 'quantity': '5 kg', 'price': 5000, 'unit': 'kg', 'essential': true},
      ],
    },
    {
      'category': 'fiompiana',
      'type': 'Tantely (1 ruche)',
      'emoji': '🐝',
      'minBudget': 85000, // Version kely: ruche tsotra + essaim
      'unitCost': 60000,
      'feedCostPerMonth': 2000,
      'cycleMonths': 12,
      'unitProfit': 120000, // 10-15 kg tantely
      'riskLevel': 'antonony',
      'difficulty': 'sarotra',
      'description': 'Version kely: 1 ruche tsotra. 10-15 kg tantely isan-taona.',
      'tips': 'Mila voninkazo betsaka, toerana mangina.',
      'returnRate': 0.90,
      'materials': [
        {'name': 'Ruche tsotra (hazo)', 'quantity': '1', 'price': 40000, 'unit': 'iray', 'essential': true},
        {'name': 'Essaim (dia misambotra)', 'quantity': '1', 'price': 0, 'unit': 'iray', 'essential': true},
        {'name': 'Gants (plastika mafy)', 'quantity': '1 paire', 'price': 5000, 'unit': 'paire', 'essential': true},
        {'name': 'Setroka tsotra', 'quantity': '1', 'price': 8000, 'unit': 'iray', 'essential': true},
        {'name': 'Bocaux plastika', 'quantity': '20', 'price': 10000, 'unit': 'iray', 'essential': true},
        {'name': 'Combinaison (optionnel)', 'quantity': '1', 'price': 75000, 'unit': 'iray', 'essential': false},
        {'name': 'Extracteur (optionnel)', 'quantity': '1', 'price': 210000, 'unit': 'iray', 'essential': false},
      ],
    },
    // FAMBOLENA (Agriculture) - Prix mis à jour JANVIER 2025
    // Note: Version kely ho an'ny budget 50,000-100,000 Ar
    {
      'category': 'fambolena',
      'type': 'Anana (1 are)',
      'emoji': '🥬',
      'minBudget': 8000, // Masomboly + zezika ihany (fitaovana indramina)
      'unitCost': 15000,
      'feedCostPerMonth': 5000,
      'cycleMonths': 1,
      'unitProfit': 35000,
      'riskLevel': 'ambany',
      'difficulty': 'mora',
      'description': 'Version kely: 1 are anana. Vokatra 3-4 herinandro.',
      'tips': 'Mila rano isan\'andro, zezika organika.',
      'returnRate': 0.90,
      'materials': [
        {'name': 'Masomboly anana', 'quantity': '1 sachet', 'price': 3000, 'unit': 'sachet', 'essential': true},
        {'name': 'Zezika organika (zezin-omby)', 'quantity': '20 kg', 'price': 5000, 'unit': 'kg', 'essential': true},
        {'name': 'Angady (azo indramina)', 'quantity': '1', 'price': 0, 'unit': 'iray', 'essential': true, 'borrowable': true},
        {'name': 'Arrosoir (azo indramina)', 'quantity': '1', 'price': 0, 'unit': 'iray', 'essential': true, 'borrowable': true},
        {'name': 'Zezika NPK (optionnel)', 'quantity': '5 kg', 'price': 17500, 'unit': 'kg', 'essential': false},
      ],
    },
    {
      'category': 'fambolena',
      'type': 'Voatabia (50 hazo)',
      'emoji': '🍅',
      'minBudget': 27000, // Masomboly + zezika + tuteur + ficelle (fitaovana indramina)
      'unitCost': 30000,
      'feedCostPerMonth': 8000,
      'cycleMonths': 3,
      'unitProfit': 60000,
      'riskLevel': 'antonony',
      'difficulty': 'antonony',
      'description': 'Version kely: 50 hazo voatabia. Tombony 2-3 volana.',
      'tips': 'Mila tuteur, rano tsy be loatra, fiarovana aretina.',
      'returnRate': 0.75,
      'materials': [
        {'name': 'Masomboly voatabia', 'quantity': '1 sachet', 'price': 3500, 'unit': 'sachet', 'essential': true},
        {'name': 'Zezika organika', 'quantity': '25 kg', 'price': 8000, 'unit': 'kg', 'essential': true},
        {'name': 'Tuteur hazo', 'quantity': '50', 'price': 10000, 'unit': 'iray', 'essential': true},
        {'name': 'Ficelle', 'quantity': '1 rouleau', 'price': 5000, 'unit': 'iray', 'essential': true},
        {'name': 'Angady (azo indramina)', 'quantity': '1', 'price': 0, 'unit': 'iray', 'essential': true, 'borrowable': true},
        {'name': 'Arrosoir (azo indramina)', 'quantity': '1', 'price': 0, 'unit': 'iray', 'essential': true, 'borrowable': true},
        {'name': 'Fongicide (optionnel)', 'quantity': '100g', 'price': 8000, 'unit': 'g', 'essential': false},
        {'name': 'Zezika NPK (optionnel)', 'quantity': '10 kg', 'price': 35000, 'unit': 'kg', 'essential': false},
      ],
    },
    {
      'category': 'fambolena',
      'type': 'Katsaka (1 are)',
      'emoji': '🌽',
      'minBudget': 23000, // Masomboly + zezika + sac (fitaovana indramina)
      'unitCost': 20000,
      'feedCostPerMonth': 5000,
      'cycleMonths': 3,
      'unitProfit': 50000, // Vidiny varotra: 2,100-2,300 Ar/kg
      'riskLevel': 'ambany',
      'difficulty': 'mora',
      'description': 'Version kely: 1 are katsaka. Vidiny varotra: 2,100-2,300 Ar/kg.',
      'tips': 'Mila tany tsara, masoandro be.',
      'returnRate': 0.85,
      'materials': [
        {'name': 'Masomboly katsaka', 'quantity': '2 kg', 'price': 7000, 'unit': 'kg', 'essential': true},
        {'name': 'Zezika organika', 'quantity': '30 kg', 'price': 8000, 'unit': 'kg', 'essential': true},
        {'name': 'Sac stockage', 'quantity': '5', 'price': 7500, 'unit': 'iray', 'essential': true},
        {'name': 'Angady (azo indramina)', 'quantity': '1', 'price': 0, 'unit': 'iray', 'essential': true, 'borrowable': true},
        {'name': 'Zezika NPK (optionnel)', 'quantity': '10 kg', 'price': 35000, 'unit': 'kg', 'essential': false},
        {'name': 'Urée (optionnel)', 'quantity': '10 kg', 'price': 32000, 'unit': 'kg', 'essential': false},
      ],
    },
    {
      'category': 'fambolena',
      'type': 'Voanjo (1 are)',
      'emoji': '🥜',
      'minBudget': 33000, // Masomboly + zezika + sac (fitaovana indramina)
      'unitCost': 25000,
      'feedCostPerMonth': 3000,
      'cycleMonths': 4,
      'unitProfit': 55000,
      'riskLevel': 'ambany',
      'difficulty': 'mora',
      'description': 'Version kely: 1 are voanjo. Tsy mila zezika be.',
      'tips': 'Tsy mila rano be, fikojakojana kely.',
      'returnRate': 0.80,
      'materials': [
        {'name': 'Masomboly voanjo', 'quantity': '5 kg', 'price': 20000, 'unit': 'kg', 'essential': true},
        {'name': 'Zezika organika', 'quantity': '20 kg', 'price': 5000, 'unit': 'kg', 'essential': true},
        {'name': 'Sac jute', 'quantity': '5', 'price': 7500, 'unit': 'iray', 'essential': true},
        {'name': 'Angady (azo indramina)', 'quantity': '1', 'price': 0, 'unit': 'iray', 'essential': true, 'borrowable': true},
      ],
    },
    {
      'category': 'fambolena',
      'type': 'Mangahazo (1 are)',
      'emoji': '🥔',
      'minBudget': 18000, // Boutures + zezika (fitaovana indramina)
      'unitCost': 18000,
      'feedCostPerMonth': 2000,
      'cycleMonths': 10,
      'unitProfit': 80000,
      'riskLevel': 'ambany',
      'difficulty': 'mora',
      'description': 'Version kely: 1 are mangahazo. Tombony be aorian\'ny 10 volana.',
      'tips': 'Tsy mila fikarakarana be, mahatanty maintany.',
      'returnRate': 1.50,
      'materials': [
        {'name': 'Boutures mangahazo', 'quantity': '100', 'price': 10000, 'unit': 'iray', 'essential': true},
        {'name': 'Zezika organika', 'quantity': '30 kg', 'price': 8000, 'unit': 'kg', 'essential': true},
        {'name': 'Angady (azo indramina)', 'quantity': '1', 'price': 0, 'unit': 'iray', 'essential': true, 'borrowable': true},
        {'name': 'Antsy be (azo indramina)', 'quantity': '1', 'price': 0, 'unit': 'iray', 'essential': true, 'borrowable': true},
      ],
    },
    {
      'category': 'fambolena',
      'type': 'Saonjo (1 are)',
      'emoji': '🥔',
      'minBudget': 33000, // Rejets + zezika (fitaovana indramina)
      'unitCost': 22000,
      'feedCostPerMonth': 5000,
      'cycleMonths': 8,
      'unitProfit': 65000,
      'riskLevel': 'ambany',
      'difficulty': 'mora',
      'description': 'Version kely: 1 are saonjo. Ravina sy fakany azo amidy.',
      'tips': 'Mila tany mando, alokaloka.',
      'returnRate': 0.95,
      'materials': [
        {'name': 'Rejets saonjo', 'quantity': '50', 'price': 25000, 'unit': 'iray', 'essential': true},
        {'name': 'Zezika organika', 'quantity': '30 kg', 'price': 8000, 'unit': 'kg', 'essential': true},
        {'name': 'Angady (azo indramina)', 'quantity': '1', 'price': 0, 'unit': 'iray', 'essential': true, 'borrowable': true},
        {'name': 'Arrosoir (azo indramina)', 'quantity': '1', 'price': 0, 'unit': 'iray', 'essential': true, 'borrowable': true},
      ],
    },
  ];

  void _analyze() {
    double budget = double.tryParse(_budgetCtrl.text.replaceAll(' ', '').replaceAll(',', '')) ?? 0;
    if (budget <= 0) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Ampidiro ny vola anananao')),
      );
      return;
    }

    setState(() {
      _budget = budget;
      _recommendations = [];

      // Filtrer les activités selon le budget
      for (var activity in _activities) {
        double minBudget = (activity['minBudget'] as int).toDouble();
        if (budget >= minBudget) {
          // Calculer combien d'unités on peut acheter
          double unitCost = (activity['unitCost'] as int).toDouble();
          double feedCost = (activity['feedCostPerMonth'] as int).toDouble();
          int cycleMonths = activity['cycleMonths'] as int;
          double unitProfit = (activity['unitProfit'] as int).toDouble();
          double returnRate = activity['returnRate'] as double;

          // Coût total pour un cycle
          double totalCostPerUnit = unitCost + (feedCost * cycleMonths);
          
          // Nombre d'unités possibles
          int possibleUnits = (budget / totalCostPerUnit).floor();
          if (possibleUnits < 1) possibleUnits = 1;

          // Ajuster selon le budget restant
          double totalInvestment = possibleUnits * totalCostPerUnit;
          if (totalInvestment > budget) {
            possibleUnits = (budget / totalCostPerUnit).floor();
            if (possibleUnits < 1) continue;
            totalInvestment = possibleUnits * totalCostPerUnit;
          }

          // Profit potentiel
          double potentialProfit = possibleUnits * unitProfit;
          double roi = (potentialProfit / totalInvestment) * 100;

          // Score de recommandation (basé sur ROI, risque, difficulté)
          double riskMultiplier = activity['riskLevel'] == 'ambany' ? 1.2 : 
                                  activity['riskLevel'] == 'antonony' ? 1.0 : 0.8;
          double difficultyMultiplier = activity['difficulty'] == 'mora' ? 1.2 : 
                                         activity['difficulty'] == 'antonony' ? 1.0 : 0.8;
          double score = roi * riskMultiplier * difficultyMultiplier * returnRate;

          _recommendations.add({
            ...activity,
            'possibleUnits': possibleUnits,
            'totalInvestment': totalInvestment,
            'potentialProfit': potentialProfit,
            'roi': roi,
            'score': score,
            'cycleMonths': cycleMonths,
          });
        }
      }

      // Trier selon l'option choisie
      if (_sortOption == 'short_term') {
        _recommendations.sort((a, b) {
          int compare = (a['cycleMonths'] as int).compareTo(b['cycleMonths'] as int);
          if (compare == 0) {
            return (b['score'] as double).compareTo(a['score'] as double);
          }
          return compare;
        });
      } else if (_sortOption == 'long_term') {
        _recommendations.sort((a, b) {
          int compare = (b['cycleMonths'] as int).compareTo(a['cycleMonths'] as int);
          if (compare == 0) {
            return (b['score'] as double).compareTo(a['score'] as double);
          }
          return compare;
        });
      } else {
        // Par défaut: Score (Rentabilité + Risque)
        _recommendations.sort((a, b) => (b['score'] as double).compareTo(a['score'] as double));
      }
      
      _showResults = true;
    });

    FocusScope.of(context).unfocus();
  }

  Color _getRiskColor(String risk) {
    switch (risk) {
      case 'ambany':
        return Colors.green;
      case 'antonony':
        return Colors.orange;
      case 'avo':
        return Colors.red;
      default:
        return Colors.grey;
    }
  }

  String _getRiskText(String risk) {
    switch (risk) {
      case 'ambany':
        return 'Ambany ✅';
      case 'antonony':
        return 'Antonony ⚠️';
      case 'avo':
        return 'Avo ⚠️';
      default:
        return risk;
    }
  }

  // Afficher la liste détaillée des matériaux et matériels
  void _showMaterialsDialog(Map<String, dynamic> activity) {
    final materials = activity['materials'] as List<dynamic>? ?? [];
    
    // Séparer essential et optional
    List<dynamic> essentialMaterials = [];
    List<dynamic> optionalMaterials = [];
    double essentialCost = 0;
    double optionalCost = 0;
    
    for (var mat in materials) {
      bool isEssential = mat['essential'] as bool? ?? true;
      if (isEssential) {
        essentialMaterials.add(mat);
        essentialCost += (mat['price'] as int).toDouble();
      } else {
        optionalMaterials.add(mat);
        optionalCost += (mat['price'] as int).toDouble();
      }
    }
    
    double totalCost = essentialCost + optionalCost;

    showDialog(
      context: context,
      builder: (ctx) => Dialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        child: Container(
          constraints: const BoxConstraints(maxWidth: 400, maxHeight: 650),
          child: Column(
            children: [
              // Header
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    colors: [Colors.orange.shade700, Colors.deepOrange.shade600],
                  ),
                  borderRadius: const BorderRadius.only(
                    topLeft: Radius.circular(20),
                    topRight: Radius.circular(20),
                  ),
                ),
                child: Row(
                  children: [
                    Text(activity['emoji'] as String, style: const TextStyle(fontSize: 32)),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            activity['type'] as String,
                            style: const TextStyle(
                              color: Colors.white,
                              fontSize: 18,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          const Text(
                            '🛒 Fitaovana sy entana ilaina',
                            style: TextStyle(color: Colors.white70, fontSize: 12),
                          ),
                        ],
                      ),
                    ),
                    IconButton(
                      icon: const Icon(Icons.close, color: Colors.white),
                      onPressed: () => Navigator.pop(ctx),
                    ),
                  ],
                ),
              ),

              // Liste des matériaux
              Expanded(
                child: ListView(
                  padding: const EdgeInsets.all(12),
                  children: [
                    // ESSENTIAL MATERIALS
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                      decoration: BoxDecoration(
                        color: Colors.green.shade100,
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: Row(
                        children: [
                          Icon(Icons.check_circle, color: Colors.green.shade700, size: 18),
                          const SizedBox(width: 8),
                          Text(
                            'FOTOTRA (tsy maintsy misy)',
                            style: TextStyle(
                              fontWeight: FontWeight.bold,
                              color: Colors.green.shade800,
                              fontSize: 13,
                            ),
                          ),
                          const Spacer(),
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                            decoration: BoxDecoration(
                              color: Colors.green.shade600,
                              borderRadius: BorderRadius.circular(10),
                            ),
                            child: Text(
                              '${essentialCost.toStringAsFixed(0)} Ar',
                              style: const TextStyle(color: Colors.white, fontSize: 11, fontWeight: FontWeight.bold),
                            ),
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 8),
                    ...essentialMaterials.asMap().entries.map((entry) {
                      final index = entry.key;
                      final mat = entry.value;
                      return _buildMaterialItem(mat, index, true);
                    }),
                    
                    // OPTIONAL MATERIALS
                    if (optionalMaterials.isNotEmpty) ...[
                      const SizedBox(height: 16),
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                        decoration: BoxDecoration(
                          color: Colors.blue.shade100,
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Row(
                          children: [
                            Icon(Icons.add_circle_outline, color: Colors.blue.shade700, size: 18),
                            const SizedBox(width: 8),
                            Text(
                              'FANAMPINY (azo atao rehefa afaka)',
                              style: TextStyle(
                                fontWeight: FontWeight.bold,
                                color: Colors.blue.shade800,
                                fontSize: 13,
                              ),
                            ),
                            const Spacer(),
                            Container(
                              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                              decoration: BoxDecoration(
                                color: Colors.blue.shade600,
                                borderRadius: BorderRadius.circular(10),
                              ),
                              child: Text(
                                '${optionalCost.toStringAsFixed(0)} Ar',
                                style: const TextStyle(color: Colors.white, fontSize: 11, fontWeight: FontWeight.bold),
                              ),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(height: 8),
                      ...optionalMaterials.asMap().entries.map((entry) {
                        final index = entry.key;
                        final mat = entry.value;
                        return _buildMaterialItem(mat, index, false);
                      }),
                    ],
                  ],
                ),
              ),

              // Total
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.green.shade50,
                  border: Border(top: BorderSide(color: Colors.green.shade200)),
                ),
                child: Column(
                  children: [
                    // Essential total
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        const Text(
                          '✅ FOTOTRA ILAINA:',
                          style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13),
                        ),
                        Text(
                          '${essentialCost.toStringAsFixed(0)} Ar',
                          style: TextStyle(
                            fontWeight: FontWeight.bold,
                            fontSize: 14,
                            color: Colors.green.shade700,
                          ),
                        ),
                      ],
                    ),
                    if (optionalMaterials.isNotEmpty) ...[
                      const SizedBox(height: 4),
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          const Text(
                            '➕ FANAMPINY:',
                            style: TextStyle(fontSize: 12),
                          ),
                          Text(
                            '${optionalCost.toStringAsFixed(0)} Ar',
                            style: TextStyle(
                              fontSize: 12,
                              color: Colors.blue.shade700,
                            ),
                          ),
                        ],
                      ),
                    ],
                    const Divider(),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        const Text(
                          '💰 TOTALY REHETRA:',
                          style: TextStyle(
                            fontWeight: FontWeight.bold,
                            fontSize: 14,
                          ),
                        ),
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                          decoration: BoxDecoration(
                            gradient: LinearGradient(
                              colors: [Colors.green.shade600, Colors.green.shade800],
                            ),
                            borderRadius: BorderRadius.circular(10),
                          ),
                          child: Text(
                            '${totalCost.toStringAsFixed(0)} Ar',
                            style: const TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                              fontSize: 16,
                            ),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 12),
                    Container(
                      padding: const EdgeInsets.all(10),
                      decoration: BoxDecoration(
                        color: Colors.amber.shade50,
                        borderRadius: BorderRadius.circular(8),
                        border: Border.all(color: Colors.amber.shade200),
                      ),
                      child: Row(
                        children: [
                          Icon(Icons.lightbulb, color: Colors.amber.shade700, size: 20),
                          const SizedBox(width: 8),
                          Expanded(
                            child: Text(
                              'Ny vidiny mety miova arakaraka ny toerana sy ny fotoana. Anontanio ny mpivarotra eo an-toerana.',
                              style: TextStyle(
                                fontSize: 10,
                                color: Colors.amber.shade900,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 12),
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton(
                        onPressed: () => Navigator.pop(ctx),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.orange.shade600,
                          padding: const EdgeInsets.symmetric(vertical: 12),
                        ),
                        child: const Text('Akatona', style: TextStyle(color: Colors.white)),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
  
  Widget _buildMaterialItem(dynamic mat, int index, bool isEssential) {
    bool isBorrowable = mat['borrowable'] as bool? ?? false;
    int price = mat['price'] as int;
    
    // Couleurs selon le type
    Color bgColor;
    Color borderColor;
    Color textColor;
    
    if (isBorrowable) {
      bgColor = index % 2 == 0 ? Colors.orange.shade50 : Colors.white;
      borderColor = Colors.orange.shade200;
      textColor = Colors.orange.shade800;
    } else if (isEssential) {
      bgColor = index % 2 == 0 ? Colors.green.shade50 : Colors.white;
      borderColor = Colors.green.shade100;
      textColor = Colors.green.shade800;
    } else {
      bgColor = index % 2 == 0 ? Colors.blue.shade50 : Colors.white;
      borderColor = Colors.blue.shade100;
      textColor = Colors.blue.shade800;
    }
    
    return Container(
      margin: const EdgeInsets.only(bottom: 8),
      padding: const EdgeInsets.all(12),
      decoration: BoxDecoration(
        color: bgColor,
        borderRadius: BorderRadius.circular(10),
        border: Border.all(color: borderColor),
      ),
      child: Row(
        children: [
          Container(
            width: 36,
            height: 36,
            decoration: BoxDecoration(
              color: isBorrowable ? Colors.orange.shade100 : (isEssential ? Colors.green.shade100 : Colors.blue.shade100),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Center(
              child: isBorrowable 
                ? Icon(Icons.handshake, color: Colors.orange.shade700, size: 18)
                : Text(
                    '${index + 1}',
                    style: TextStyle(
                      fontWeight: FontWeight.bold,
                      color: textColor,
                    ),
                  ),
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  mat['name'] as String,
                  style: TextStyle(
                    fontWeight: FontWeight.w600,
                    fontSize: 13,
                    color: isBorrowable ? Colors.orange.shade800 : null,
                  ),
                ),
                const SizedBox(height: 2),
                Text(
                  isBorrowable ? '🤝 Azo indramina' : 'Habetsaka: ${mat['quantity']}',
                  style: TextStyle(
                    fontSize: 11,
                    color: isBorrowable ? Colors.orange.shade600 : Colors.grey.shade600,
                    fontStyle: isBorrowable ? FontStyle.italic : FontStyle.normal,
                  ),
                ),
              ],
            ),
          ),
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
            decoration: BoxDecoration(
              color: isBorrowable ? Colors.orange.shade100 : (isEssential ? Colors.green.shade100 : Colors.blue.shade100),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Text(
              isBorrowable ? 'MAIMAIM-POANA' : '$price Ar',
              style: TextStyle(
                fontWeight: FontWeight.bold,
                fontSize: isBorrowable ? 10 : 12,
                color: textColor,
              ),
            ),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      child: Container(
        constraints: const BoxConstraints(maxWidth: 450, maxHeight: 750),
        child: Column(
          children: [
            // Header
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [Colors.amber.shade700, Colors.orange.shade600],
                ),
                borderRadius: const BorderRadius.only(
                  topLeft: Radius.circular(20),
                  topRight: Radius.circular(20),
                ),
              ),
              child: Row(
                children: [
                  const Text('💰', style: TextStyle(fontSize: 28)),
                  const SizedBox(width: 10),
                  const Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          'Inona no Mampidi-bola?',
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        Text(
                          'Jereo izay mety amin\'ny volanao',
                          style: TextStyle(color: Colors.white70, fontSize: 12),
                        ),
                      ],
                    ),
                  ),
                  IconButton(
                    icon: const Icon(Icons.close, color: Colors.white),
                    onPressed: () => Navigator.pop(context),
                  ),
                ],
              ),
            ),
            // Body
            Expanded(
              child: SingleChildScrollView(
                padding: const EdgeInsets.all(16),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.stretch,
                  children: [
                    // Budget Input
                    Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: Colors.amber.shade50,
                        borderRadius: BorderRadius.circular(12),
                        border: Border.all(color: Colors.amber.shade200),
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            '💵 Vola anananao (Budget)',
                            style: TextStyle(fontWeight: FontWeight.bold, fontSize: 15),
                          ),
                          const SizedBox(height: 10),
                          TextField(
                            controller: _budgetCtrl,
                            keyboardType: TextInputType.number,
                            decoration: InputDecoration(
                              hintText: 'Ohatra: 100000',
                              suffixText: 'Ar',
                              border: OutlineInputBorder(borderRadius: BorderRadius.circular(10)),
                              filled: true,
                              fillColor: Colors.white,
                            ),
                          ),
                          const SizedBox(height: 12),
                          
                          // Sort Options
                          const Text(
                            '🎯 Safidio ny laharam-pahamehana:',
                            style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13),
                          ),
                          const SizedBox(height: 8),
                          SingleChildScrollView(
                            scrollDirection: Axis.horizontal,
                            child: Row(
                              children: [
                                ChoiceChip(
                                  label: const Text('Tombony be'),
                                  selected: _sortOption == 'score',
                                  onSelected: (selected) {
                                    if (selected) setState(() => _sortOption = 'score');
                                  },
                                  selectedColor: Colors.amber.shade200,
                                ),
                                const SizedBox(width: 8),
                                ChoiceChip(
                                  label: const Text('Fotoana fohy'),
                                  selected: _sortOption == 'short_term',
                                  onSelected: (selected) {
                                    if (selected) setState(() => _sortOption = 'short_term');
                                  },
                                  selectedColor: Colors.amber.shade200,
                                ),
                                const SizedBox(width: 8),
                                ChoiceChip(
                                  label: const Text('Fotoana lava'),
                                  selected: _sortOption == 'long_term',
                                  onSelected: (selected) {
                                    if (selected) setState(() => _sortOption = 'long_term');
                                  },
                                  selectedColor: Colors.amber.shade200,
                                ),
                              ],
                            ),
                          ),
                          
                          const SizedBox(height: 12),
                          SizedBox(
                            width: double.infinity,
                            child: ElevatedButton.icon(
                              onPressed: _analyze,
                              icon: const Icon(Icons.search),
                              label: const Text('JEREO NY METY', style: TextStyle(fontWeight: FontWeight.bold)),
                              style: ElevatedButton.styleFrom(
                                backgroundColor: Colors.amber.shade700,
                                foregroundColor: Colors.white,
                                padding: const EdgeInsets.symmetric(vertical: 14),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),

                    if (_showResults) ...[
                      const SizedBox(height: 16),
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.green.shade50,
                          borderRadius: BorderRadius.circular(10),
                        ),
                        child: Text(
                          '📊 Vokatry ny fanadihadiana ho an\'ny ${_budget.toStringAsFixed(0)} Ar',
                          style: TextStyle(fontWeight: FontWeight.bold, color: Colors.green.shade800),
                          textAlign: TextAlign.center,
                        ),
                      ),
                      const SizedBox(height: 12),

                      if (_recommendations.isEmpty)
                        Container(
                          padding: const EdgeInsets.all(20),
                          child: const Text(
                            '😔 Tsy ampy ny vola ho an\'ny asa voalaza. Ampitomboy kely ny budget.',
                            textAlign: TextAlign.center,
                          ),
                        )
                      else
                        // Top 3 Recommendations
                        ..._recommendations.take(8).toList().asMap().entries.map((entry) {
                          int index = entry.key;
                          var rec = entry.value;
                          bool isTop3 = index < 3;
                          
                          return Container(
                            margin: const EdgeInsets.only(bottom: 12),
                            padding: const EdgeInsets.all(14),
                            decoration: BoxDecoration(
                              color: isTop3 ? Colors.amber.shade50 : Colors.white,
                              borderRadius: BorderRadius.circular(12),
                              border: Border.all(
                                color: isTop3 ? Colors.amber.shade400 : Colors.grey.shade200,
                                width: isTop3 ? 2 : 1,
                              ),
                              boxShadow: isTop3 ? [
                                BoxShadow(color: Colors.amber.withValues(alpha: 0.2), blurRadius: 5),
                              ] : null,
                            ),
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Row(
                                  children: [
                                    if (isTop3)
                                      Container(
                                        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                                        decoration: BoxDecoration(
                                          color: index == 0 ? Colors.amber : 
                                                 index == 1 ? Colors.grey.shade400 : Colors.brown.shade300,
                                          borderRadius: BorderRadius.circular(10),
                                        ),
                                        child: Text(
                                          index == 0 ? '🥇 #1' : index == 1 ? '🥈 #2' : '🥉 #3',
                                          style: const TextStyle(color: Colors.white, fontSize: 11, fontWeight: FontWeight.bold),
                                        ),
                                      ),
                                    if (isTop3) const SizedBox(width: 8),
                                    Text(rec['emoji'] as String, style: const TextStyle(fontSize: 24)),
                                    const SizedBox(width: 8),
                                    Expanded(
                                      child: Column(
                                        crossAxisAlignment: CrossAxisAlignment.start,
                                        children: [
                                          Text(
                                            rec['type'] as String,
                                            style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 15),
                                          ),
                                          Row(
                                            children: [
                                              Flexible(
                                                child: Container(
                                                  padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                                                  decoration: BoxDecoration(
                                                    color: rec['category'] == 'fiompiana' ? 
                                                           Colors.orange.shade100 : Colors.green.shade100,
                                                    borderRadius: BorderRadius.circular(6),
                                                  ),
                                                  child: Text(
                                                    rec['category'] == 'fiompiana' ? '🐔 Fiompiana' : '🌱 Fambolena',
                                                    style: TextStyle(
                                                      fontSize: 10,
                                                      color: rec['category'] == 'fiompiana' ? 
                                                             Colors.orange.shade800 : Colors.green.shade800,
                                                    ),
                                                    overflow: TextOverflow.ellipsis,
                                                  ),
                                                ),
                                              ),
                                              const SizedBox(width: 6),
                                              Flexible(
                                                child: Container(
                                                  padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                                                  decoration: BoxDecoration(
                                                    color: _getRiskColor(rec['riskLevel']).withValues(alpha: 0.1),
                                                    borderRadius: BorderRadius.circular(6),
                                                  ),
                                                  child: Text(
                                                    'Risika: ${_getRiskText(rec['riskLevel'])}',
                                                    style: TextStyle(fontSize: 10, color: _getRiskColor(rec['riskLevel'])),
                                                    overflow: TextOverflow.ellipsis,
                                                  ),
                                                ),
                                              ),
                                            ],
                                          ),
                                        ],
                                      ),
                                    ),
                                  ],
                                ),
                                const SizedBox(height: 10),
                                Text(
                                  rec['description'] as String,
                                  style: TextStyle(fontSize: 12, color: Colors.grey.shade700),
                                ),
                                const SizedBox(height: 10),
                                Container(
                                  padding: const EdgeInsets.all(10),
                                  decoration: BoxDecoration(
                                    color: Colors.grey.shade100,
                                    borderRadius: BorderRadius.circular(8),
                                  ),
                                  child: Column(
                                    children: [
                                      Row(
                                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                        children: [
                                          const Flexible(
                                            child: Text('💸 Fampiasam-bola:', style: TextStyle(fontSize: 12)),
                                          ),
                                          Flexible(
                                            child: Text(
                                              '${(rec['totalInvestment'] as double).toStringAsFixed(0)} Ar',
                                              style: const TextStyle(fontSize: 12, fontWeight: FontWeight.bold),
                                              textAlign: TextAlign.end,
                                              overflow: TextOverflow.ellipsis,
                                            ),
                                          ),
                                        ],
                                      ),
                                      const SizedBox(height: 4),
                                      Row(
                                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                        children: [
                                          const Text('⏱️ Fotoana:', style: TextStyle(fontSize: 12)),
                                          Text(
                                            '${rec['cycleMonths']} volana',
                                            style: const TextStyle(fontSize: 12),
                                          ),
                                        ],
                                      ),
                                      const SizedBox(height: 4),
                                      Row(
                                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                        children: [
                                          Flexible(
                                            child: Text(
                                              '💰 Tombony azo antenaina:',
                                              style: TextStyle(fontSize: 12, color: Colors.green.shade700),
                                              overflow: TextOverflow.ellipsis,
                                            ),
                                          ),
                                          Flexible(
                                            child: Text(
                                              '${(rec['potentialProfit'] as double).toStringAsFixed(0)} Ar',
                                              style: TextStyle(
                                                fontSize: 13,
                                                fontWeight: FontWeight.bold,
                                                color: Colors.green.shade700,
                                              ),
                                              textAlign: TextAlign.end,
                                              overflow: TextOverflow.ellipsis,
                                            ),
                                          ),
                                        ],
                                      ),
                                      const SizedBox(height: 4),
                                      Row(
                                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                        children: [
                                          const Text('📈 ROI:', style: TextStyle(fontSize: 12)),
                                          Container(
                                            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                                            decoration: BoxDecoration(
                                              color: (rec['roi'] as double) > 50 ? Colors.green : Colors.orange,
                                              borderRadius: BorderRadius.circular(8),
                                            ),
                                            child: Text(
                                              '${(rec['roi'] as double).toStringAsFixed(0)}%',
                                              style: const TextStyle(color: Colors.white, fontSize: 11, fontWeight: FontWeight.bold),
                                            ),
                                          ),
                                        ],
                                      ),
                                    ],
                                  ),
                                ),
                                const SizedBox(height: 8),
                                Container(
                                  padding: const EdgeInsets.all(8),
                                  decoration: BoxDecoration(
                                    color: Colors.blue.shade50,
                                    borderRadius: BorderRadius.circular(8),
                                  ),
                                  child: Row(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      const Text('💡 ', style: TextStyle(fontSize: 12)),
                                      Expanded(
                                        child: Text(
                                          rec['tips'] as String,
                                          style: TextStyle(fontSize: 11, color: Colors.blue.shade800),
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                                // Bouton pour voir les matériaux
                                if (rec['materials'] != null) ...[
                                  const SizedBox(height: 10),
                                  SizedBox(
                                    width: double.infinity,
                                    child: ElevatedButton.icon(
                                      onPressed: () => _showMaterialsDialog(rec),
                                      style: ElevatedButton.styleFrom(
                                        backgroundColor: Colors.orange.shade600,
                                        foregroundColor: Colors.white,
                                        padding: const EdgeInsets.symmetric(vertical: 10),
                                        shape: RoundedRectangleBorder(
                                          borderRadius: BorderRadius.circular(8),
                                        ),
                                      ),
                                      icon: const Icon(Icons.shopping_cart, size: 18),
                                      label: const Text(
                                        '🛒 Jereo ny FITAOVANA ilaina',
                                        style: TextStyle(fontSize: 12, fontWeight: FontWeight.bold),
                                      ),
                                    ),
                                  ),
                                ],
                              ],
                            ),
                          );
                        }),

                      const SizedBox(height: 16),
                      Container(
                        padding: const EdgeInsets.all(12),
                        decoration: BoxDecoration(
                          color: Colors.red.shade50,
                          borderRadius: BorderRadius.circular(10),
                          border: Border.all(color: Colors.red.shade200),
                        ),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            const Text(
                              '⚠️ Fampitandremana:',
                              style: TextStyle(fontWeight: FontWeight.bold, fontSize: 13),
                            ),
                            const SizedBox(height: 6),
                            Text(
                              '• Ireo isa ireo dia vinavina fotsiny, mety miova arakaraka ny toe-tsena\n'
                              '• Jereo tsara ny toe-javatra eo an-toerana (toetr\'andro, tsena...)\n'
                              '• Manomboha amin\'ny kely aloha raha vao manomboka\n'
                              '• Manàna paik\'ady B raha tsy mahomby',
                              style: TextStyle(fontSize: 11, color: Colors.red.shade800),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// ==================== PROJECT MANAGEMENT DIALOG (FITANTANANA TETIKASA) ====================
class ProjectManagementDialog extends StatefulWidget {
  const ProjectManagementDialog({super.key});

  @override
  State<ProjectManagementDialog> createState() => _ProjectManagementDialogState();
}

class _ProjectManagementDialogState extends State<ProjectManagementDialog> with SingleTickerProviderStateMixin {
  late TabController _tabController;
  final List<Map<String, dynamic>> _projects = [];
  final List<Map<String, dynamic>> _tasks = [];
  
  final TextEditingController _projectNameCtrl = TextEditingController();
  final TextEditingController _projectBudgetCtrl = TextEditingController();
  final TextEditingController _projectDescCtrl = TextEditingController();
  final TextEditingController _taskNameCtrl = TextEditingController();
  final TextEditingController _taskNoteCtrl = TextEditingController();
  
  String _selectedProject = '';
  String _selectedPriority = 'Antonony';
  DateTime _selectedDeadline = DateTime.now().add(const Duration(days: 7));

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 3, vsync: this);
    _loadSampleData();
  }

  void _loadSampleData() {
    _projects.addAll([
      {
        'id': '1',
        'name': 'Fiompiana Akoho',
        'budget': 500000.0,
        'spent': 320000.0,
        'description': 'Fametrahana tranom-borona sy fividianana akoho',
        'status': 'active',
        'progress': 0.65,
        'createdAt': DateTime.now().subtract(const Duration(days: 30)),
      },
      {
        'id': '2',
        'name': 'Fambolena Vary',
        'budget': 800000.0,
        'spent': 150000.0,
        'description': 'Vary amin\'ny tanimbary 2 hektara',
        'status': 'active',
        'progress': 0.25,
        'createdAt': DateTime.now().subtract(const Duration(days: 15)),
      },
      {
        'id': '3',
        'name': 'Fambolena Sakay',
        'budget': 200000.0,
        'spent': 50000.0,
        'description': 'Sakay (Piment) amin\'ny tany 500m²',
        'status': 'active',
        'progress': 0.15,
        'createdAt': DateTime.now().subtract(const Duration(days: 5)),
      },
      {
        'id': '4',
        'name': 'Fambolena Angivy',
        'budget': 150000.0,
        'spent': 20000.0,
        'description': 'Angivy (Aubergine Amère) amin\'ny tany 300m²',
        'status': 'active',
        'progress': 0.10,
        'createdAt': DateTime.now().subtract(const Duration(days: 2)),
      },
    ]);
    _tasks.addAll([
      {
        'id': '1',
        'projectId': '1',
        'name': 'Mividy akoho 50',
        'priority': 'Maika',
        'status': 'done',
        'deadline': DateTime.now().subtract(const Duration(days: 5)),
        'note': 'Vita - akoho gasy 50',
      },
      {
        'id': '2',
        'projectId': '1',
        'name': 'Manamboatra tranom-borona',
        'priority': 'Maika',
        'status': 'in_progress',
        'deadline': DateTime.now().add(const Duration(days: 3)),
        'note': 'Efa mandeha ny asa',
      },
      {
        'id': '4',
        'projectId': '3',
        'name': 'Famafazana voa (Pépinière)',
        'priority': 'Maika',
        'status': 'done',
        'deadline': DateTime.now().subtract(const Duration(days: 2)),
        'note': 'Voa Sakay Pilipily',
      },
      {
        'id': '5',
        'projectId': '3',
        'name': 'Fanomanana tany',
        'priority': 'Antonony',
        'status': 'in_progress',
        'deadline': DateTime.now().add(const Duration(days: 5)),
        'note': 'Mila zezika organika',
      },
      {
        'id': '3',
        'projectId': '1',
        'name': 'Mividy sakafom-borona',
        'priority': 'Antonony',
        'status': 'pending',
        'deadline': DateTime.now().add(const Duration(days: 7)),
        'note': '',
      },
      {
        'id': '4',
        'projectId': '2',
        'name': 'Miasa tany',
        'priority': 'Maika',
        'status': 'done',
        'deadline': DateTime.now().subtract(const Duration(days: 10)),
        'note': 'Vita ny fiasana tany',
      },
      {
        'id': '5',
        'projectId': '2',
        'name': 'Mamboly vary',
        'priority': 'Maika',
        'status': 'in_progress',
        'deadline': DateTime.now().add(const Duration(days: 5)),
        'note': 'Efa nanomboka',
      },
    ]);
    if (_projects.isNotEmpty) {
      _selectedProject = _projects.first['id'];
    }
  }

  @override
  void dispose() {
    _tabController.dispose();
    _projectNameCtrl.dispose();
    _projectBudgetCtrl.dispose();
    _projectDescCtrl.dispose();
    _taskNameCtrl.dispose();
    _taskNoteCtrl.dispose();
    super.dispose();
  }

  void _addProject() {
    if (_projectNameCtrl.text.isEmpty) return;
    setState(() {
      _projects.add({
        'id': DateTime.now().millisecondsSinceEpoch.toString(),
        'name': _projectNameCtrl.text,
        'budget': double.tryParse(_projectBudgetCtrl.text) ?? 0,
        'spent': 0.0,
        'description': _projectDescCtrl.text,
        'status': 'active',
        'progress': 0.0,
        'createdAt': DateTime.now(),
      });
      _projectNameCtrl.clear();
      _projectBudgetCtrl.clear();
      _projectDescCtrl.clear();
    });
    Navigator.pop(context);
  }

  void _addTask() {
    if (_taskNameCtrl.text.isEmpty || _selectedProject.isEmpty) return;
    setState(() {
      _tasks.add({
        'id': DateTime.now().millisecondsSinceEpoch.toString(),
        'projectId': _selectedProject,
        'name': _taskNameCtrl.text,
        'priority': _selectedPriority,
        'status': 'pending',
        'deadline': _selectedDeadline,
        'note': _taskNoteCtrl.text,
      });
      _taskNameCtrl.clear();
      _taskNoteCtrl.clear();
    });
    Navigator.pop(context);
  }

  void _toggleTaskStatus(String taskId) {
    setState(() {
      final task = _tasks.firstWhere((t) => t['id'] == taskId);
      if (task['status'] == 'pending') {
        task['status'] = 'in_progress';
      } else if (task['status'] == 'in_progress') {
        task['status'] = 'done';
      } else {
        task['status'] = 'pending';
      }
      _updateProjectProgress(task['projectId']);
    });
  }

  void _updateProjectProgress(String projectId) {
    final projectTasks = _tasks.where((t) => t['projectId'] == projectId).toList();
    if (projectTasks.isEmpty) return;
    final doneTasks = projectTasks.where((t) => t['status'] == 'done').length;
    final progress = doneTasks / projectTasks.length;
    final project = _projects.firstWhere((p) => p['id'] == projectId);
    project['progress'] = progress;
  }

  Color _getPriorityColor(String priority) {
    switch (priority) {
      case 'Maika':
        return Colors.red;
      case 'Antonony':
        return Colors.orange;
      case 'Tsy maika':
        return Colors.green;
      default:
        return Colors.grey;
    }
  }

  Color _getStatusColor(String status) {
    switch (status) {
      case 'done':
        return Colors.green;
      case 'in_progress':
        return Colors.blue;
      case 'pending':
        return Colors.grey;
      default:
        return Colors.grey;
    }
  }

  String _getStatusText(String status) {
    switch (status) {
      case 'done':
        return 'Vita ✅';
      case 'in_progress':
        return 'Mandeha 🔄';
      case 'pending':
        return 'Miandry ⏳';
      default:
        return status;
    }
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      child: Container(
        constraints: const BoxConstraints(maxWidth: 500, maxHeight: 700),
        child: Column(
          children: [
            Container(
              padding: const EdgeInsets.all(16),
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  colors: [Colors.purple.shade700, Colors.purple.shade500],
                ),
                borderRadius: const BorderRadius.only(
                  topLeft: Radius.circular(20),
                  topRight: Radius.circular(20),
                ),
              ),
              child: Row(
                children: [
                  const Text('📁', style: TextStyle(fontSize: 28)),
                  const SizedBox(width: 10),
                  const Expanded(
                    child: Text(
                      'Fitantanana Tetikasa',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                  IconButton(
                    icon: const Icon(Icons.close, color: Colors.white),
                    onPressed: () => Navigator.pop(context),
                  ),
                ],
              ),
            ),
            Container(
              color: Colors.purple.shade100,
              child: TabBar(
                controller: _tabController,
                labelColor: Colors.purple.shade800,
                unselectedLabelColor: Colors.purple.shade400,
                indicatorColor: Colors.purple.shade800,
                tabs: const [
                  Tab(icon: Icon(Icons.dashboard), text: 'Tetikasa'),
                  Tab(icon: Icon(Icons.task_alt), text: 'Asa'),
                  Tab(icon: Icon(Icons.analytics), text: 'Tatitra'),
                ],
              ),
            ),
            Expanded(
              child: TabBarView(
                controller: _tabController,
                children: [
                  _buildProjectsTab(),
                  _buildTasksTab(),
                  _buildReportsTab(),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildProjectsTab() {
    return Column(
      children: [
        Padding(
          padding: const EdgeInsets.all(12),
          child: ElevatedButton.icon(
            onPressed: () => _showAddProjectDialog(),
            icon: const Icon(Icons.add),
            label: const Text('Hanampy Tetikasa Vaovao'),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.purple.shade600,
              foregroundColor: Colors.white,
            ),
          ),
        ),
        Expanded(
          child: ListView.builder(
            padding: const EdgeInsets.symmetric(horizontal: 12),
            itemCount: _projects.length,
            itemBuilder: (context, index) {
              final project = _projects[index];
              final progress = (project['progress'] as double) * 100;
              final budget = project['budget'] as double;
              final spent = project['spent'] as double;
              return Card(
                margin: const EdgeInsets.only(bottom: 12),
                child: Padding(
                  padding: const EdgeInsets.all(12),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          const Text('📂', style: TextStyle(fontSize: 24)),
                          const SizedBox(width: 10),
                          Expanded(
                            child: Text(
                              project['name'],
                              style: const TextStyle(fontSize: 16, fontWeight: FontWeight.bold),
                            ),
                          ),
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                            decoration: BoxDecoration(
                              color: Colors.green.shade100,
                              borderRadius: BorderRadius.circular(10),
                            ),
                            child: Text(
                              '${progress.toStringAsFixed(0)}%',
                              style: TextStyle(color: Colors.green.shade700, fontWeight: FontWeight.bold),
                            ),
                          ),
                        ],
                      ),
                      if ((project['description'] as String).isNotEmpty) ...[
                        const SizedBox(height: 6),
                        Text(project['description'], style: TextStyle(color: Colors.grey.shade600, fontSize: 13)),
                      ],
                      const SizedBox(height: 10),
                      LinearProgressIndicator(
                        value: project['progress'],
                        backgroundColor: Colors.grey.shade200,
                        valueColor: AlwaysStoppedAnimation<Color>(
                          progress >= 100 ? Colors.green : Colors.purple,
                        ),
                      ),
                      const SizedBox(height: 10),
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text('💰 Budget: ${budget.toStringAsFixed(0)} Ar', style: const TextStyle(fontSize: 12)),
                          Text('💸 Lany: ${spent.toStringAsFixed(0)} Ar', style: TextStyle(fontSize: 12, color: Colors.red.shade600)),
                        ],
                      ),
                    ],
                  ),
                ),
              );
            },
          ),
        ),
      ],
    );
  }

  Widget _buildTasksTab() {
    return Column(
      children: [
        Padding(
          padding: const EdgeInsets.all(12),
          child: Row(
            children: [
              Expanded(
                child: DropdownButtonFormField<String>(
                  key: ValueKey(_selectedProject.isEmpty ? null : _selectedProject),
                  initialValue: _selectedProject.isEmpty ? null : _selectedProject,
                  decoration: const InputDecoration(
                    labelText: 'Safidio Tetikasa',
                    border: OutlineInputBorder(),
                    isDense: true,
                    contentPadding: EdgeInsets.symmetric(horizontal: 10, vertical: 10),
                  ),
                  items: _projects.map((p) {
                    return DropdownMenuItem<String>(
                      value: p['id'],
                      child: Text(p['name'], style: const TextStyle(fontSize: 13)),
                    );
                  }).toList(),
                  onChanged: (value) {
                    setState(() => _selectedProject = value ?? '');
                  },
                ),
              ),
              const SizedBox(width: 10),
              ElevatedButton.icon(
                onPressed: () => _showAddTaskDialog(),
                icon: const Icon(Icons.add, size: 18),
                label: const Text('Asa', style: TextStyle(fontSize: 13)),
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.purple.shade600,
                  foregroundColor: Colors.white,
                  padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
                ),
              ),
            ],
          ),
        ),
        Expanded(
          child: ListView.builder(
            padding: const EdgeInsets.symmetric(horizontal: 12),
            itemCount: _tasks.where((t) => _selectedProject.isEmpty || t['projectId'] == _selectedProject).length,
            itemBuilder: (context, index) {
              final filteredTasks = _tasks.where((t) => _selectedProject.isEmpty || t['projectId'] == _selectedProject).toList();
              final task = filteredTasks[index];
              final deadline = task['deadline'] as DateTime;
              final isOverdue = deadline.isBefore(DateTime.now()) && task['status'] != 'done';
              return Card(
                margin: const EdgeInsets.only(bottom: 8),
                color: isOverdue ? Colors.red.shade50 : null,
                child: ListTile(
                  leading: GestureDetector(
                    onTap: () => _toggleTaskStatus(task['id']),
                    child: Container(
                      width: 36,
                      height: 36,
                      decoration: BoxDecoration(
                        color: _getStatusColor(task['status']).withValues(alpha: 0.2),
                        shape: BoxShape.circle,
                      ),
                      child: Icon(
                        task['status'] == 'done' ? Icons.check_circle : 
                        task['status'] == 'in_progress' ? Icons.timelapse : Icons.circle_outlined,
                        color: _getStatusColor(task['status']),
                      ),
                    ),
                  ),
                  title: Text(
                    task['name'],
                    style: TextStyle(
                      fontWeight: FontWeight.w600,
                      decoration: task['status'] == 'done' ? TextDecoration.lineThrough : null,
                    ),
                  ),
                  subtitle: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Container(
                            padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                            decoration: BoxDecoration(
                              color: _getPriorityColor(task['priority']).withValues(alpha: 0.2),
                              borderRadius: BorderRadius.circular(8),
                            ),
                            child: Text(
                              task['priority'],
                              style: TextStyle(fontSize: 10, color: _getPriorityColor(task['priority'])),
                            ),
                          ),
                          const SizedBox(width: 8),
                          Text(
                            '📅 ${deadline.day}/${deadline.month}/${deadline.year}',
                            style: TextStyle(
                              fontSize: 11,
                              color: isOverdue ? Colors.red : Colors.grey,
                            ),
                          ),
                        ],
                      ),
                      if ((task['note'] as String).isNotEmpty)
                        Text(task['note'], style: TextStyle(fontSize: 11, color: Colors.grey.shade600)),
                    ],
                  ),
                  trailing: Text(
                    _getStatusText(task['status']),
                    style: TextStyle(fontSize: 11, color: _getStatusColor(task['status'])),
                  ),
                ),
              );
            },
          ),
        ),
      ],
    );
  }

  Widget _buildReportsTab() {
    int totalTasks = _tasks.length;
    int doneTasks = _tasks.where((t) => t['status'] == 'done').length;
    int inProgressTasks = _tasks.where((t) => t['status'] == 'in_progress').length;
    int pendingTasks = _tasks.where((t) => t['status'] == 'pending').length;
    int overdueTasks = _tasks.where((t) => 
      (t['deadline'] as DateTime).isBefore(DateTime.now()) && t['status'] != 'done'
    ).length;
    double totalBudget = _projects.fold(0.0, (sum, p) => sum + (p['budget'] as double));
    double totalSpent = _projects.fold(0.0, (sum, p) => sum + (p['spent'] as double));

    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        children: [
          Row(
            children: [
              Expanded(
                child: _buildStatCard('📂', 'Tetikasa', _projects.length.toString(), Colors.purple),
              ),
              const SizedBox(width: 10),
              Expanded(
                child: _buildStatCard('✅', 'Vita', doneTasks.toString(), Colors.green),
              ),
            ],
          ),
          const SizedBox(height: 10),
          Row(
            children: [
              Expanded(
                child: _buildStatCard('🔄', 'Mandeha', inProgressTasks.toString(), Colors.blue),
              ),
              const SizedBox(width: 10),
              Expanded(
                child: _buildStatCard('⏳', 'Miandry', pendingTasks.toString(), Colors.orange),
              ),
            ],
          ),
          const SizedBox(height: 10),
          if (overdueTasks > 0)
            Container(
              width: double.infinity,
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.red.shade100,
                borderRadius: BorderRadius.circular(12),
                border: Border.all(color: Colors.red.shade300),
              ),
              child: Row(
                children: [
                  const Text('⚠️', style: TextStyle(fontSize: 24)),
                  const SizedBox(width: 10),
                  Text(
                    '$overdueTasks asa efa dila ny fe-potoana!',
                    style: TextStyle(color: Colors.red.shade800, fontWeight: FontWeight.bold),
                  ),
                ],
              ),
            ),
          const SizedBox(height: 20),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('💰 Vola Rehetra', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                const SizedBox(height: 12),
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Text('Budget Rehetra:'),
                    Text('${totalBudget.toStringAsFixed(0)} Ar', style: const TextStyle(fontWeight: FontWeight.bold)),
                  ],
                ),
                const SizedBox(height: 6),
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Text('Efa Lany:'),
                    Text('${totalSpent.toStringAsFixed(0)} Ar', style: TextStyle(color: Colors.red.shade600)),
                  ],
                ),
                const SizedBox(height: 6),
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    const Text('Sisa Tavela:'),
                    Text('${(totalBudget - totalSpent).toStringAsFixed(0)} Ar', style: TextStyle(color: Colors.green.shade600, fontWeight: FontWeight.bold)),
                  ],
                ),
                const SizedBox(height: 10),
                LinearProgressIndicator(
                  value: totalBudget > 0 ? totalSpent / totalBudget : 0,
                  backgroundColor: Colors.grey.shade200,
                  valueColor: AlwaysStoppedAnimation<Color>(
                    totalBudget > 0 && totalSpent / totalBudget > 0.8 ? Colors.red : Colors.green,
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: 16),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(16),
            decoration: BoxDecoration(
              color: Colors.white,
              borderRadius: BorderRadius.circular(12),
              boxShadow: [BoxShadow(color: Colors.black.withValues(alpha: 0.05), blurRadius: 5)],
            ),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('📊 Fandrosoan\'ny Asa', style: TextStyle(fontSize: 16, fontWeight: FontWeight.bold)),
                const SizedBox(height: 12),
                _buildProgressBar('Vita', doneTasks, totalTasks, Colors.green),
                const SizedBox(height: 8),
                _buildProgressBar('Mandeha', inProgressTasks, totalTasks, Colors.blue),
                const SizedBox(height: 8),
                _buildProgressBar('Miandry', pendingTasks, totalTasks, Colors.orange),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildStatCard(String emoji, String label, String value, Color color) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: color.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: color.withValues(alpha: 0.3)),
      ),
      child: Column(
        children: [
          Text(emoji, style: const TextStyle(fontSize: 24)),
          const SizedBox(height: 6),
          Text(value, style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: color)),
          Text(label, style: TextStyle(fontSize: 12, color: color)),
        ],
      ),
    );
  }

  Widget _buildProgressBar(String label, int count, int total, Color color) {
    double percentage = total > 0 ? count / total : 0;
    return Row(
      children: [
        SizedBox(width: 60, child: Text(label, style: const TextStyle(fontSize: 12))),
        Expanded(
          child: LinearProgressIndicator(
            value: percentage,
            backgroundColor: Colors.grey.shade200,
            valueColor: AlwaysStoppedAnimation<Color>(color),
          ),
        ),
        const SizedBox(width: 10),
        Text('$count', style: TextStyle(fontWeight: FontWeight.bold, color: color)),
      ],
    );
  }

  void _showAddProjectDialog() {
    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        title: const Text('📂 Tetikasa Vaovao'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(
              controller: _projectNameCtrl,
              decoration: const InputDecoration(labelText: 'Anaran\'ny Tetikasa', border: OutlineInputBorder()),
            ),
            const SizedBox(height: 10),
            TextField(
              controller: _projectBudgetCtrl,
              keyboardType: TextInputType.number,
              decoration: const InputDecoration(labelText: 'Budget (Ar)', border: OutlineInputBorder()),
            ),
            const SizedBox(height: 10),
            TextField(
              controller: _projectDescCtrl,
              maxLines: 2,
              decoration: const InputDecoration(labelText: 'Famaritana', border: OutlineInputBorder()),
            ),
          ],
        ),
        actions: [
          TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Aoka')),
          ElevatedButton(onPressed: () { _addProject(); }, child: const Text('Hampidirina')),
        ],
      ),
    );
  }

  void _showAddTaskDialog() {
    showDialog(
      context: context,
      builder: (ctx) => StatefulBuilder(
        builder: (context, setStateDialog) => AlertDialog(
          title: const Text('✅ Asa Vaovao'),
          content: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                TextField(
                  controller: _taskNameCtrl,
                  decoration: const InputDecoration(labelText: 'Anaran\'ny Asa', border: OutlineInputBorder()),
                ),
                const SizedBox(height: 10),
                DropdownButtonFormField<String>(
                  key: ValueKey(_selectedPriority),
                  initialValue: _selectedPriority,
                  decoration: const InputDecoration(labelText: 'Laharam-pahamehana', border: OutlineInputBorder()),
                  items: ['Maika', 'Antonony', 'Tsy maika'].map((p) {
                    return DropdownMenuItem(value: p, child: Text(p));
                  }).toList(),
                  onChanged: (value) => setStateDialog(() => _selectedPriority = value ?? 'Antonony'),
                ),
                const SizedBox(height: 10),
                ListTile(
                  title: const Text('Fe-potoana'),
                  subtitle: Text('${_selectedDeadline.day}/${_selectedDeadline.month}/${_selectedDeadline.year}'),
                  trailing: const Icon(Icons.calendar_today),
                  onTap: () async {
                    final date = await showDatePicker(
                      context: context,
                      initialDate: _selectedDeadline,
                      firstDate: DateTime.now(),
                      lastDate: DateTime.now().add(const Duration(days: 365)),
                    );
                    if (date != null) setStateDialog(() => _selectedDeadline = date);
                  },
                ),
                const SizedBox(height: 10),
                TextField(
                  controller: _taskNoteCtrl,
                  maxLines: 2,
                  decoration: const InputDecoration(labelText: 'Fanamarihana', border: OutlineInputBorder()),
                ),
              ],
            ),
          ),
          actions: [
            TextButton(onPressed: () => Navigator.pop(ctx), child: const Text('Aoka')),
            ElevatedButton(onPressed: () { _addTask(); }, child: const Text('Hampidirina')),
          ],
        ),
      ),
    );
  }
}

// ===== DIALOG À PROPOS / PROFIL =====
class AboutProfileDialog extends StatefulWidget {
  const AboutProfileDialog({super.key});

  @override
  State<AboutProfileDialog> createState() => _AboutProfileDialogState();
}

class _AboutProfileDialogState extends State<AboutProfileDialog> {
  
  // Afficher le panneau admin pour générer des codes
  void _showAdminCodePanel() {
    final adminCodeController = TextEditingController();
    
    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        title: Row(
          children: [
            Icon(Icons.admin_panel_settings, color: AppColors.primary),
            const SizedBox(width: 12),
            const Expanded(child: Text('Panneau Admin', style: TextStyle(fontSize: 18))),
          ],
        ),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(
              controller: adminCodeController,
              obscureText: true,
              decoration: InputDecoration(
                labelText: 'Code Admin',
                prefixIcon: const Icon(Icons.lock),
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
              ),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx),
            child: const Text('Annuler'),
          ),
          ElevatedButton(
            onPressed: () {
              if (adminCodeController.text.toUpperCase() == adminCode) {
                Navigator.pop(ctx);
                _showCodeGeneratorPanel();
              } else {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text('Code admin incorrect'), backgroundColor: Colors.red),
                );
              }
            },
            child: const Text('Valider'),
          ),
        ],
      ),
    );
  }
  
  void _showCodeGeneratorPanel() {
    final countController = TextEditingController(text: '5');
    final daysController = TextEditingController(text: '30');
    List<String> generatedCodes = [];
    
    showDialog(
      context: context,
      builder: (ctx) => StatefulBuilder(
        builder: (context, setDialogState) => AlertDialog(
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
          title: Row(
            children: [
              Icon(Icons.generating_tokens, color: AppColors.primary),
              const SizedBox(width: 12),
              const Expanded(child: Text('Générateur de Codes', style: TextStyle(fontSize: 16))),
            ],
          ),
          content: SingleChildScrollView(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    Expanded(
                      child: TextField(
                        controller: countController,
                        keyboardType: TextInputType.number,
                        decoration: InputDecoration(
                          labelText: 'Nombre',
                          border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
                        ),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: TextField(
                        controller: daysController,
                        keyboardType: TextInputType.number,
                        decoration: InputDecoration(
                          labelText: 'Jours',
                          border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
                        ),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 16),
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton.icon(
                    onPressed: () async {
                      final count = int.tryParse(countController.text) ?? 5;
                      final days = int.tryParse(daysController.text) ?? 30;
                      final codes = await CodeManager.generateMultipleCodes(count, expirationDays: days);
                      setDialogState(() {
                        generatedCodes = codes;
                      });
                    },
                    icon: const Icon(Icons.add_circle),
                    label: const Text('Générer'),
                  ),
                ),
                if (generatedCodes.isNotEmpty) ...[
                  const SizedBox(height: 16),
                  const Divider(),
                  const SizedBox(height: 8),
                  const Text('Codes générés:', style: TextStyle(fontWeight: FontWeight.bold)),
                  const SizedBox(height: 8),
                  Container(
                    padding: const EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: Colors.grey[100],
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Column(
                      children: generatedCodes.map((code) => Padding(
                        padding: const EdgeInsets.symmetric(vertical: 4),
                        child: Row(
                          children: [
                            Expanded(
                              child: Text(
                                code,
                                style: const TextStyle(fontFamily: 'monospace', fontWeight: FontWeight.bold, fontSize: 16),
                              ),
                            ),
                            IconButton(
                              icon: const Icon(Icons.copy, size: 20),
                              onPressed: () {
                                Clipboard.setData(ClipboardData(text: code));
                                ScaffoldMessenger.of(context).showSnackBar(
                                  SnackBar(content: Text('Code $code copié!'), backgroundColor: Colors.green),
                                );
                              },
                            ),
                          ],
                        ),
                      )).toList(),
                    ),
                  ),
                  const SizedBox(height: 12),
                  SizedBox(
                    width: double.infinity,
                    child: OutlinedButton.icon(
                      onPressed: () {
                        final allCodes = generatedCodes.join('\n');
                        Clipboard.setData(ClipboardData(text: allCodes));
                        ScaffoldMessenger.of(context).showSnackBar(
                          const SnackBar(content: Text('Tous les codes copiés!'), backgroundColor: Colors.green),
                        );
                      },
                      icon: const Icon(Icons.copy_all),
                      label: const Text('Copier tous'),
                    ),
                  ),
                ],
                const SizedBox(height: 16),
                SizedBox(
                  width: double.infinity,
                  child: OutlinedButton.icon(
                    onPressed: () async {
                      final allCodes = await CodeManager.getAllValidCodes();
                      if (context.mounted) {
                        Navigator.pop(ctx);
                        _showAllCodesDialog(allCodes);
                      }
                    },
                    icon: const Icon(Icons.list),
                    label: const Text('Voir tous les codes'),
                  ),
                ),
              ],
            ),
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(ctx),
              child: const Text('Fermer'),
            ),
          ],
        ),
      ),
    );
  }
  
  void _showAllCodesDialog(List<Map<String, dynamic>> codes) {
    showDialog(
      context: context,
      builder: (ctx) => AlertDialog(
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        title: const Text('Tous les codes'),
        content: SizedBox(
          width: double.maxFinite,
          height: 400,
          child: codes.isEmpty
              ? const Center(child: Text('Aucun code généré'))
              : ListView.builder(
                  itemCount: codes.length,
                  itemBuilder: (context, index) {
                    final code = codes[index];
                    final isUsed = code['isUsed'] as bool;
                    final isExpired = code['isExpired'] as bool;
                    final expiration = code['expiration'] as DateTime?;
                    
                    Color statusColor;
                    String status;
                    if (isUsed) {
                      statusColor = Colors.red;
                      status = 'Utilisé';
                    } else if (isExpired) {
                      statusColor = Colors.orange;
                      status = 'Expiré';
                    } else {
                      statusColor = Colors.green;
                      status = 'Valide';
                    }
                    
                    return ListTile(
                      leading: CircleAvatar(
                        backgroundColor: statusColor.withValues(alpha: 0.2),
                        child: Icon(
                          isUsed ? Icons.check : (isExpired ? Icons.timer_off : Icons.key),
                          color: statusColor,
                          size: 20,
                        ),
                      ),
                      title: Text(
                        code['code'],
                        style: TextStyle(
                          fontFamily: 'monospace',
                          fontWeight: FontWeight.bold,
                          decoration: isUsed ? TextDecoration.lineThrough : null,
                        ),
                      ),
                      subtitle: Text(
                        expiration != null
                            ? 'Expire: ${DateFormat('dd/MM/yyyy').format(expiration)}'
                            : 'Pas de date',
                      ),
                      trailing: Container(
                        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                        decoration: BoxDecoration(
                          color: statusColor.withValues(alpha: 0.2),
                          borderRadius: BorderRadius.circular(12),
                        ),
                        child: Text(
                          status,
                          style: TextStyle(color: statusColor, fontSize: 12),
                        ),
                      ),
                    );
                  },
                ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(ctx),
            child: const Text('Fermer'),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      backgroundColor: const Color(0xFF1B5E20),
      content: SingleChildScrollView(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Container(
              width: 150,
              height: 150,
              decoration: BoxDecoration(
                shape: BoxShape.circle,
                border: Border.all(color: Colors.white, width: 4),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withValues(alpha: 0.4),
                    blurRadius: 20,
                    offset: const Offset(0, 6),
                  ),
                ],
              ),
              child: ClipOval(
                child: Image.asset(
                  'assets/images/arie.JPG',
                  fit: BoxFit.cover,
                  errorBuilder: (context, error, stackTrace) {
                    return const Icon(Icons.person, color: Colors.white, size: 75);
                  },
                ),
              ),
            ),
            const SizedBox(height: 16),
            const Text(
              'Ari Havana',
              style: TextStyle(
                color: Colors.white,
                fontSize: 22,
                fontWeight: FontWeight.bold,
              ),
            ),
            const SizedBox(height: 8),
            const Text(
              'Développeur',
              style: TextStyle(
                color: Colors.white70,
                fontSize: 14,
              ),
            ),
            const SizedBox(height: 16),
            const Text(
              'Tantsaha - Application ho an\'ny tantsaha malagasy mba hanampy azy ireo amin\'ny fiompiana sy fambolena.',
              style: TextStyle(
                color: Colors.white70,
                fontSize: 12,
              ),
              textAlign: TextAlign.center,
            ),
            const SizedBox(height: 20),
            
            // === BOUTON GESTION CODES (ADMIN) ===
            GestureDetector(
              onTap: _showAdminCodePanel,
              child: Container(
                width: double.infinity,
                padding: const EdgeInsets.symmetric(vertical: 12),
                decoration: BoxDecoration(
                  gradient: const LinearGradient(
                    colors: [Color(0xFF673AB7), Color(0xFF512DA8)],
                  ),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: const Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(Icons.admin_panel_settings, color: Colors.white, size: 20),
                    SizedBox(width: 8),
                    Text(
                      'Gestion des codes (Admin)',
                      style: TextStyle(color: Colors.white, fontSize: 13, fontWeight: FontWeight.bold),
                    ),
                  ],
                ),
              ),
            ),
            
            const SizedBox(height: 16),
            
            // === CONTACT / SUPPORT ===
            Container(
              padding: const EdgeInsets.all(12),
              decoration: BoxDecoration(
                color: Colors.white.withValues(alpha: 0.1),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Column(
                children: [
                  const Text(
                    '💝 Tohano anay',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 14,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                  const SizedBox(height: 12),
                  
                  // PayPal - Bouton direct
                  Builder(
                    builder: (ctx) => GestureDetector(
                      onTap: () {
                        const paypalLink = 'https://paypal.me/LahatraAriel/10EUR';
                        Clipboard.setData(const ClipboardData(text: paypalLink));
                        ScaffoldMessenger.of(ctx).showSnackBar(
                          const SnackBar(
                            content: Text('✅ Lien PayPal copié! Coller dans le navigateur'),
                            backgroundColor: Colors.green,
                            duration: Duration(seconds: 3),
                          ),
                        );
                      },
                      child: Container(
                        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                        decoration: BoxDecoration(
                          gradient: const LinearGradient(
                            colors: [Color(0xFF0070BA), Color(0xFF003087)],
                          ),
                          borderRadius: BorderRadius.circular(20),
                        ),
                        child: const Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Text('💳', style: TextStyle(fontSize: 20)),
                            SizedBox(width: 10),
                            Column(
                              children: [
                                Text(
                                  'PayPal - 10€ pour aider',
                                  style: TextStyle(color: Colors.white, fontSize: 13, fontWeight: FontWeight.bold),
                                ),
                                Text(
                                  'Tap pour copier le lien',
                                  style: TextStyle(color: Colors.white70, fontSize: 9),
                                ),
                              ],
                            ),
                          ],
                        ),
                      ),
                    ),
                  ),
                  
                  const SizedBox(height: 10),
                  
                  // MVola
                  const Row(
                    children: [
                      Text('📱', style: TextStyle(fontSize: 18)),
                      SizedBox(width: 10),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'MVola',
                              style: TextStyle(color: Colors.yellow, fontSize: 12, fontWeight: FontWeight.bold),
                            ),
                            Text(
                              '034 12 181 31',
                              style: TextStyle(color: Colors.white70, fontSize: 11),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                  
                  const SizedBox(height: 10),
                  
                  // Airtel Money
                  const Row(
                    children: [
                      Text('📱', style: TextStyle(fontSize: 18)),
                      SizedBox(width: 10),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'Airtel Money',
                              style: TextStyle(color: Colors.red, fontSize: 12, fontWeight: FontWeight.bold),
                            ),
                            Text(
                              '033 83 680 95',
                              style: TextStyle(color: Colors.white70, fontSize: 11),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),
            
            const SizedBox(height: 16),
            const Text(
              '© 2025 - Akoho Tech',
              style: TextStyle(
                color: Colors.white54,
                fontSize: 11,
              ),
            ),
          ],
        ),
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: const Text('Hidio', style: TextStyle(color: Colors.white)),
        ),
      ],
    );
  }
}

// ===== ÉCRAN DE PAIEMENT - AIRTEL MONEY & MVOLA =====
class PaymentDialog extends StatefulWidget {
  const PaymentDialog({super.key});

  @override
  State<PaymentDialog> createState() => _PaymentDialogState();
}

class _PaymentDialogState extends State<PaymentDialog> {
  String _selectedMethod = 'airtel';
  final TextEditingController _amountController = TextEditingController(text: '10000');
  final TextEditingController _phoneController = TextEditingController();
  bool _isProcessing = false;

  final List<Map<String, dynamic>> _paymentMethods = [
    {
      'id': 'paypal',
      'name': 'PayPal',
      'color': Color(0xFF0070BA),
      'icon': Icons.credit_card,
      'number': 'paypal.me/LahatraAriel',
      'description': '10€ pour aider - International',
      'isPaypal': true,
    },
    {
      'id': 'airtel',
      'name': 'Airtel Money',
      'color': Color(0xFFED1C24),
      'icon': Icons.phone_android,
      'number': '033 83 680 95',
      'description': 'Paiement via Airtel Money Madagascar',
    },
    {
      'id': 'mvola',
      'name': 'MVola',
      'color': Color(0xFFFFCC00),
      'textColor': Color(0xFF000000),
      'icon': Icons.account_balance_wallet,
      'number': '034 12 181 31',
      'description': 'Paiement via Telma MVola',
    },
  ];

  final List<int> _suggestedAmounts = [10000, 20000, 50000, 100000];

  void _processPayment() async {
    // PayPal - copier le lien
    if (_selectedMethod == 'paypal') {
      const paypalLink = 'https://paypal.me/LahatraAriel/10EUR';
      Clipboard.setData(const ClipboardData(text: paypalLink));
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('✅ Lien PayPal copié! Coller dans le navigateur'),
          backgroundColor: Colors.green,
          duration: Duration(seconds: 3),
        ),
      );
      return;
    }
    
    if (_phoneController.text.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Ampidiro ny laharana finday'),
          backgroundColor: Colors.red,
        ),
      );
      return;
    }

    setState(() => _isProcessing = true);

    // Simuler le traitement
    await Future.delayed(const Duration(seconds: 2));

    if (mounted) {
      setState(() => _isProcessing = false);
      
      final method = _paymentMethods.firstWhere((m) => m['id'] == _selectedMethod);
      
      showDialog(
        context: context,
        builder: (ctx) => AlertDialog(
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
          title: Row(
            children: [
              Icon(Icons.check_circle, color: Colors.green, size: 32),
              const SizedBox(width: 12),
              const Text('Vita soa aman-tsara!'),
            ],
          ),
          content: Column(
            mainAxisSize: MainAxisSize.min,
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              const Text(
                'Fangatahana nalefa!',
                style: TextStyle(fontWeight: FontWeight.bold, fontSize: 16),
              ),
              const SizedBox(height: 12),
              _buildInfoRow('Fomba:', method['name']),
              _buildInfoRow('Vola:', '${_amountController.text} Ar'),
              _buildInfoRow('Finday:', _phoneController.text),
              const SizedBox(height: 16),
              Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.blue.shade50,
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Row(
                  children: [
                    Icon(Icons.info_outline, color: Colors.blue.shade700),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Text(
                        'Hamarino ny finday anao hanamarinana ny vola aloa.',
                        style: TextStyle(
                          color: Colors.blue.shade700,
                          fontSize: 13,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
          actions: [
            ElevatedButton(
              onPressed: () {
                Navigator.pop(ctx);
                Navigator.pop(context);
              },
              child: const Text('Azo'),
            ),
          ],
        ),
      );
    }
  }

  Widget _buildInfoRow(String label, String value) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 4),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(label, style: TextStyle(color: Colors.grey.shade600)),
          Flexible(child: Text(value, style: const TextStyle(fontWeight: FontWeight.w600), textAlign: TextAlign.right)),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(24)),
      child: Container(
        constraints: const BoxConstraints(maxWidth: 400),
        child: SingleChildScrollView(
          child: Padding(
            padding: const EdgeInsets.all(24),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // En-tête
                Row(
                  children: [
                    Container(
                      width: 50,
                      height: 50,
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          colors: [AppColors.primary, AppColors.primaryLight],
                        ),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: const Icon(Icons.favorite, color: Colors.white, size: 28),
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: const [
                          Text(
                            'Tohano anay',
                            style: TextStyle(
                              fontSize: 22,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          Text(
                            'Fanampiana ny mpanoratra',
                            style: TextStyle(
                              color: Colors.grey,
                              fontSize: 14,
                            ),
                          ),
                        ],
                      ),
                    ),
                    IconButton(
                      onPressed: () => Navigator.pop(context),
                      icon: const Icon(Icons.close),
                    ),
                  ],
                ),

                const SizedBox(height: 24),

                // Méthodes de paiement
                const Text(
                  'Safidio ny fomba fandoavana',
                  style: TextStyle(fontWeight: FontWeight.w600, fontSize: 16),
                ),
                const SizedBox(height: 12),

                ...List.generate(_paymentMethods.length, (index) {
                  final method = _paymentMethods[index];
                  final isSelected = _selectedMethod == method['id'];
                  return Padding(
                    padding: const EdgeInsets.only(bottom: 10),
                    child: GestureDetector(
                      onTap: () => setState(() => _selectedMethod = method['id']),
                      child: Container(
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          color: isSelected 
                              ? (method['color'] as Color).withValues(alpha: 0.1)
                              : Colors.grey.shade50,
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(
                            color: isSelected ? method['color'] : Colors.grey.shade200,
                            width: isSelected ? 2 : 1,
                          ),
                        ),
                        child: Row(
                          children: [
                            Container(
                              width: 48,
                              height: 48,
                              decoration: BoxDecoration(
                                color: method['color'],
                                borderRadius: BorderRadius.circular(12),
                              ),
                              child: Icon(
                                method['icon'],
                                color: method['textColor'] ?? Colors.white,
                                size: 26,
                              ),
                            ),
                            const SizedBox(width: 16),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    method['name'],
                                    style: const TextStyle(
                                      fontWeight: FontWeight.bold,
                                      fontSize: 16,
                                    ),
                                  ),
                                  Text(
                                    method['description'],
                                    style: TextStyle(
                                      color: Colors.grey.shade600,
                                      fontSize: 12,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                            if (isSelected)
                              Icon(Icons.check_circle, color: method['color']),
                          ],
                        ),
                      ),
                    ),
                  );
                }),

                const SizedBox(height: 20),

                // Montant suggéré
                const Text(
                  'Vola aloa (Ariary)',
                  style: TextStyle(fontWeight: FontWeight.w600, fontSize: 16),
                ),
                const SizedBox(height: 12),

                Wrap(
                  spacing: 8,
                  runSpacing: 8,
                  children: _suggestedAmounts.map((amount) {
                    final isSelected = _amountController.text == amount.toString();
                    return GestureDetector(
                      onTap: () => setState(() => _amountController.text = amount.toString()),
                      child: Container(
                        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                        decoration: BoxDecoration(
                          color: isSelected ? AppColors.primary : Colors.grey.shade100,
                          borderRadius: BorderRadius.circular(20),
                        ),
                        child: Text(
                          '${NumberFormat('#,###').format(amount)} Ar',
                          style: TextStyle(
                            color: isSelected ? Colors.white : Colors.black87,
                            fontWeight: FontWeight.w600,
                          ),
                        ),
                      ),
                    );
                  }).toList(),
                ),

                const SizedBox(height: 16),

                // Champ montant personnalisé
                TextField(
                  controller: _amountController,
                  keyboardType: TextInputType.number,
                  decoration: InputDecoration(
                    labelText: 'Vola hafa',
                    suffixText: 'Ar',
                    border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
                  ),
                ),

                const SizedBox(height: 16),

                // Numéro de téléphone
                TextField(
                  controller: _phoneController,
                  keyboardType: TextInputType.phone,
                  decoration: InputDecoration(
                    labelText: 'Laharana finday',
                    hintText: '034 12 181 31',
                    prefixIcon: const Icon(Icons.phone),
                    border: OutlineInputBorder(borderRadius: BorderRadius.circular(12)),
                  ),
                ),

                const SizedBox(height: 24),

                // Bouton de paiement
                SizedBox(
                  width: double.infinity,
                  height: 54,
                  child: ElevatedButton(
                    onPressed: _isProcessing ? null : _processPayment,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: _paymentMethods.firstWhere(
                        (m) => m['id'] == _selectedMethod,
                      )['color'],
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(16),
                      ),
                    ),
                    child: _isProcessing
                        ? const SizedBox(
                            width: 24,
                            height: 24,
                            child: CircularProgressIndicator(
                              strokeWidth: 2,
                              color: Colors.white,
                            ),
                          )
                        : Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              const Icon(Icons.payment, color: Colors.white),
                              const SizedBox(width: 12),
                              Text(
                                'Handoa ${_amountController.text} Ar',
                                style: const TextStyle(
                                  fontSize: 16,
                                  fontWeight: FontWeight.bold,
                                  color: Colors.white,
                                ),
                              ),
                            ],
                          ),
                  ),
                ),

                const SizedBox(height: 16),

                // Note de sécurité
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.green.shade50,
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Row(
                    children: [
                      Icon(Icons.lock, color: Colors.green.shade700, size: 20),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Text(
                          'Azo antoka ny vola aloa. Misaotra tompoko!',
                          style: TextStyle(
                            color: Colors.green.shade700,
                            fontSize: 13,
                          ),
                        ),
                      ),
                    ],
                  ),
                ),

                const SizedBox(height: 16),

                // Développeur
                Center(
                  child: Column(
                    children: [
                      Container(
                        width: 40,
                        height: 40,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          border: Border.all(color: AppColors.primary, width: 2),
                        ),
                        child: ClipOval(
                          child: Image.asset(
                            'assets/images/arie.JPG',
                            fit: BoxFit.cover,
                            errorBuilder: (context, error, stackTrace) {
                              return Container(
                                color: AppColors.primary.withValues(alpha: 0.1),
                                child: const Icon(Icons.person, color: AppColors.primary),
                              );
                            },
                          ),
                        ),
                      ),
                      const SizedBox(height: 8),
                      const Text(
                        'Ari Havana - Mpanoratra',
                        style: TextStyle(fontSize: 12, color: Colors.grey),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  @override
  void dispose() {
    _amountController.dispose();
    _phoneController.dispose();
    super.dispose();
  }
}